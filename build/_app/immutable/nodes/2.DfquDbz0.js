import"../chunks/NZTpNUN0.js";import{i as G1}from"../chunks/CuuTpGFx.js";import{o as K1,a as J1}from"../chunks/D8qTbpzm.js";import{p as Q1,l as Ov,a as Cy,m as eT}from"../chunks/BEImHcP6.js";import{b as tT}from"../chunks/CuJzN3Tj.js";const rT=!0,cO=Object.freeze(Object.defineProperty({__proto__:null,prerender:rT},Symbol.toStringTag,{value:"Module"}));function Fv(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Md={exports:{}};/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v5.6.1/LICENSE.txt
 */var iT=Md.exports,Py;function nT(){return Py||(Py=1,function(r,e){(function(t,s){r.exports=s()})(iT,function(){var t={},s={};function a(p,o,T){if(s[p]=T,p==="index"){var E="var sharedModule = {}; ("+s.shared+")(sharedModule); ("+s.worker+")(sharedModule);",C={};return s.shared(C),s.index(t,C),typeof window<"u"&&t.setWorkerUrl(window.URL.createObjectURL(new Blob([E],{type:"text/javascript"}))),t}}a("shared",["exports"],function(p){function o(h,n,c,d){return new(c||(c=Promise))(function(m,b){function v(P){try{A(d.next(P))}catch(R){b(R)}}function w(P){try{A(d.throw(P))}catch(R){b(R)}}function A(P){var R;P.done?m(P.value):(R=P.value,R instanceof c?R:new c(function(D){D(R)})).then(v,w)}A((d=d.apply(h,n||[])).next())})}function T(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var E,C;function O(){if(C)return E;function h(n,c){this.x=n,this.y=c}return C=1,E=h,h.prototype={clone:function(){return new h(this.x,this.y)},add:function(n){return this.clone()._add(n)},sub:function(n){return this.clone()._sub(n)},multByPoint:function(n){return this.clone()._multByPoint(n)},divByPoint:function(n){return this.clone()._divByPoint(n)},mult:function(n){return this.clone()._mult(n)},div:function(n){return this.clone()._div(n)},rotate:function(n){return this.clone()._rotate(n)},rotateAround:function(n,c){return this.clone()._rotateAround(n,c)},matMult:function(n){return this.clone()._matMult(n)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(n){return this.x===n.x&&this.y===n.y},dist:function(n){return Math.sqrt(this.distSqr(n))},distSqr:function(n){var c=n.x-this.x,d=n.y-this.y;return c*c+d*d},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(n){return Math.atan2(this.y-n.y,this.x-n.x)},angleWith:function(n){return this.angleWithSep(n.x,n.y)},angleWithSep:function(n,c){return Math.atan2(this.x*c-this.y*n,this.x*n+this.y*c)},_matMult:function(n){var c=n[2]*this.x+n[3]*this.y;return this.x=n[0]*this.x+n[1]*this.y,this.y=c,this},_add:function(n){return this.x+=n.x,this.y+=n.y,this},_sub:function(n){return this.x-=n.x,this.y-=n.y,this},_mult:function(n){return this.x*=n,this.y*=n,this},_div:function(n){return this.x/=n,this.y/=n,this},_multByPoint:function(n){return this.x*=n.x,this.y*=n.y,this},_divByPoint:function(n){return this.x/=n.x,this.y/=n.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var n=this.y;return this.y=this.x,this.x=-n,this},_rotate:function(n){var c=Math.cos(n),d=Math.sin(n),m=d*this.x+c*this.y;return this.x=c*this.x-d*this.y,this.y=m,this},_rotateAround:function(n,c){var d=Math.cos(n),m=Math.sin(n),b=c.y+m*(this.x-c.x)+d*(this.y-c.y);return this.x=c.x+d*(this.x-c.x)-m*(this.y-c.y),this.y=b,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},h.convert=function(n){return n instanceof h?n:Array.isArray(n)?new h(n[0],n[1]):n},E}typeof SuppressedError=="function"&&SuppressedError;var $,V,ie=T(O()),we=function(){if(V)return $;function h(n,c,d,m){this.cx=3*n,this.bx=3*(d-n)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*c,this.by=3*(m-c)-this.cy,this.ay=1-this.cy-this.by,this.p1x=n,this.p1y=c,this.p2x=d,this.p2y=m}return V=1,$=h,h.prototype={sampleCurveX:function(n){return((this.ax*n+this.bx)*n+this.cx)*n},sampleCurveY:function(n){return((this.ay*n+this.by)*n+this.cy)*n},sampleCurveDerivativeX:function(n){return(3*this.ax*n+2*this.bx)*n+this.cx},solveCurveX:function(n,c){if(c===void 0&&(c=1e-6),n<0)return 0;if(n>1)return 1;for(var d=n,m=0;m<8;m++){var b=this.sampleCurveX(d)-n;if(Math.abs(b)<c)return d;var v=this.sampleCurveDerivativeX(d);if(Math.abs(v)<1e-6)break;d-=b/v}var w=0,A=1;for(d=n,m=0;m<20&&(b=this.sampleCurveX(d),!(Math.abs(b-n)<c));m++)n>b?w=d:A=d,d=.5*(A-w)+w;return d},solve:function(n,c){return this.sampleCurveY(this.solveCurveX(n,c))}},$}(),Pe=T(we);let je,Ze;function Le(){return je==null&&(je=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),je}function Ue(){if(Ze==null&&(Ze=!1,Le())){const n=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(n){for(let d=0;d<5*5;d++){const m=4*d;n.fillStyle=`rgb(${m},${m+1},${m+2})`,n.fillRect(d%5,Math.floor(d/5),1,1)}const c=n.getImageData(0,0,5,5).data;for(let d=0;d<5*5*4;d++)if(d%4!=3&&c[d]!==d){Ze=!0;break}}}return Ze||!1}var et=1e-6,Ke=typeof Float32Array<"u"?Float32Array:Array;function ct(){var h=new Ke(9);return Ke!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[5]=0,h[6]=0,h[7]=0),h[0]=1,h[4]=1,h[8]=1,h}function me(h){return h[0]=1,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=1,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=1,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h}function _e(){var h=new Ke(3);return Ke!=Float32Array&&(h[0]=0,h[1]=0,h[2]=0),h}function ze(h){return Math.hypot(h[0],h[1],h[2])}function Qe(h,n,c){var d=new Ke(3);return d[0]=h,d[1]=n,d[2]=c,d}function at(h,n,c){return h[0]=n[0]+c[0],h[1]=n[1]+c[1],h[2]=n[2]+c[2],h}function mt(h,n,c){return h[0]=n[0]*c,h[1]=n[1]*c,h[2]=n[2]*c,h}function At(h,n,c){var d=n[0],m=n[1],b=n[2],v=c[0],w=c[1],A=c[2];return h[0]=m*A-b*w,h[1]=b*v-d*A,h[2]=d*w-m*v,h}Math.hypot||(Math.hypot=function(){for(var h=0,n=arguments.length;n--;)h+=arguments[n]*arguments[n];return Math.sqrt(h)});var or,ti=ze;function Bt(h,n,c){var d=n[0],m=n[1],b=n[2],v=n[3];return h[0]=c[0]*d+c[4]*m+c[8]*b+c[12]*v,h[1]=c[1]*d+c[5]*m+c[9]*b+c[13]*v,h[2]=c[2]*d+c[6]*m+c[10]*b+c[14]*v,h[3]=c[3]*d+c[7]*m+c[11]*b+c[15]*v,h}function wr(){var h=new Ke(4);return Ke!=Float32Array&&(h[0]=0,h[1]=0,h[2]=0),h[3]=1,h}function Rt(h,n,c,d){var m=.5*Math.PI/180;n*=m,c*=m,d*=m;var b=Math.sin(n),v=Math.cos(n),w=Math.sin(c),A=Math.cos(c),P=Math.sin(d),R=Math.cos(d);return h[0]=b*A*R-v*w*P,h[1]=v*w*R+b*A*P,h[2]=v*A*P-b*w*R,h[3]=v*A*R+b*w*P,h}function Vr(){var h=new Ke(2);return Ke!=Float32Array&&(h[0]=0,h[1]=0),h}function It(h,n){var c=new Ke(2);return c[0]=h,c[1]=n,c}_e(),or=new Ke(4),Ke!=Float32Array&&(or[0]=0,or[1]=0,or[2]=0,or[3]=0),_e(),Qe(1,0,0),Qe(0,1,0),wr(),wr(),ct(),Vr();const yt=8192;function bt(h,n,c){return n*(yt/(h.tileSize*Math.pow(2,c-h.tileID.overscaledZ)))}function ar(h,n){return(h%n+n)%n}function cr(h,n,c){return h*(1-c)+n*c}function Mr(h){if(h<=0)return 0;if(h>=1)return 1;const n=h*h,c=n*h;return 4*(h<.5?c:3*(h-n)+c-.75)}function ri(h,n,c,d){const m=new Pe(h,n,c,d);return b=>m.solve(b)}const Ht=ri(.25,.1,.25,1);function kt(h,n,c){return Math.min(c,Math.max(n,h))}function gr(h,n,c){const d=c-n,m=((h-n)%d+d)%d+n;return m===n?c:m}function Tt(h,...n){for(const c of n)for(const d in c)h[d]=c[d];return h}let mr=1;function zt(h,n,c){const d={};for(const m in h)d[m]=n.call(this,h[m],m,h);return d}function Jt(h,n,c){const d={};for(const m in h)n.call(this,h[m],m,h)&&(d[m]=h[m]);return d}function Gt(h){return Array.isArray(h)?h.map(Gt):typeof h=="object"&&h?zt(h,Gt):h}const $t={};function hr(h){$t[h]||(typeof console<"u"&&console.warn(h),$t[h]=!0)}function Ct(h,n,c){return(c.y-h.y)*(n.x-h.x)>(n.y-h.y)*(c.x-h.x)}function Qt(h){return typeof WorkerGlobalScope<"u"&&h!==void 0&&h instanceof WorkerGlobalScope}let Mi=null;function Ni(h){return typeof ImageBitmap<"u"&&h instanceof ImageBitmap}const Ri="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function en(h,n,c,d,m){return o(this,void 0,void 0,function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const b=new VideoFrame(h,{timestamp:0});try{const v=b?.format;if(!v||!v.startsWith("BGR")&&!v.startsWith("RGB"))throw new Error(`Unrecognized format ${v}`);const w=v.startsWith("BGR"),A=new Uint8ClampedArray(d*m*4);if(yield b.copyTo(A,function(P,R,D,L,U){const j=4*Math.max(-R,0),H=(Math.max(0,D)-D)*L*4+j,Y=4*L,te=Math.max(0,R),ge=Math.max(0,D);return{rect:{x:te,y:ge,width:Math.min(P.width,R+L)-te,height:Math.min(P.height,D+U)-ge},layout:[{offset:H,stride:Y}]}}(h,n,c,d,m)),w)for(let P=0;P<A.length;P+=4){const R=A[P];A[P]=A[P+2],A[P+2]=R}return A}finally{b.close()}})}let Sr,oi;function _r(h,n,c,d){return h.addEventListener(n,c,d),{unsubscribe:()=>{h.removeEventListener(n,c,d)}}}function yr(h){return h*Math.PI/180}function Yr(h){return h/Math.PI*180}const zn={touchstart:!0,touchmove:!0,touchmoveWindow:!0,touchend:!0,touchcancel:!0},As={dblclick:!0,click:!0,mouseover:!0,mouseout:!0,mousedown:!0,mousemove:!0,mousemoveWindow:!0,mouseup:!0,mouseupWindow:!0,contextmenu:!0,wheel:!0},ki="AbortError";function be(){return new Error(ki)}const Z={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function X(h){return Z.REGISTERED_PROTOCOLS[h.substring(0,h.indexOf("://"))]}const K="global-dispatcher";class ce extends Error{constructor(n,c,d,m){super(`AJAXError: ${c} (${n}): ${d}`),this.status=n,this.statusText=c,this.url=d,this.body=m}}const pe=()=>Qt(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,xe=function(h,n){if(/:\/\//.test(h.url)&&!/^https?:|^file:/.test(h.url)){const d=X(h.url);if(d)return d(h,n);if(Qt(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:h,targetMapId:K},n)}if(!(/^file:/.test(c=h.url)||/^file:/.test(pe())&&!/^\w+:/.test(c))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(d,m){return o(this,void 0,void 0,function*(){const b=new Request(d.url,{method:d.method||"GET",body:d.body,credentials:d.credentials,headers:d.headers,cache:d.cache,referrer:pe(),signal:m.signal});let v,w;d.type!=="json"||b.headers.has("Accept")||b.headers.set("Accept","application/json");try{v=yield fetch(b)}catch(P){throw new ce(0,P.message,d.url,new Blob)}if(!v.ok){const P=yield v.blob();throw new ce(v.status,v.statusText,d.url,P)}w=d.type==="arrayBuffer"||d.type==="image"?v.arrayBuffer():d.type==="json"?v.json():v.text();const A=yield w;if(m.signal.aborted)throw be();return{data:A,cacheControl:v.headers.get("Cache-Control"),expires:v.headers.get("Expires")}})}(h,n);if(Qt(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:h,mustQueue:!0,targetMapId:K},n)}var c;return function(d,m){return new Promise((b,v)=>{var w;const A=new XMLHttpRequest;A.open(d.method||"GET",d.url,!0),d.type!=="arrayBuffer"&&d.type!=="image"||(A.responseType="arraybuffer");for(const P in d.headers)A.setRequestHeader(P,d.headers[P]);d.type==="json"&&(A.responseType="text",!((w=d.headers)===null||w===void 0)&&w.Accept||A.setRequestHeader("Accept","application/json")),A.withCredentials=d.credentials==="include",A.onerror=()=>{v(new Error(A.statusText))},A.onload=()=>{if(!m.signal.aborted)if((A.status>=200&&A.status<300||A.status===0)&&A.response!==null){let P=A.response;if(d.type==="json")try{P=JSON.parse(A.response)}catch(R){return void v(R)}b({data:P,cacheControl:A.getResponseHeader("Cache-Control"),expires:A.getResponseHeader("Expires")})}else{const P=new Blob([A.response],{type:A.getResponseHeader("Content-Type")});v(new ce(A.status,A.statusText,d.url,P))}},m.signal.addEventListener("abort",()=>{A.abort(),v(be())}),A.send(d.body)})}(h,n)};function De(h){if(!h||h.indexOf("://")<=0||h.indexOf("data:image/")===0||h.indexOf("blob:")===0)return!0;const n=new URL(h),c=window.location;return n.protocol===c.protocol&&n.host===c.host}function ve(h,n,c){c[h]&&c[h].indexOf(n)!==-1||(c[h]=c[h]||[],c[h].push(n))}function $e(h,n,c){if(c&&c[h]){const d=c[h].indexOf(n);d!==-1&&c[h].splice(d,1)}}class Ne{constructor(n,c={}){Tt(this,c),this.type=n}}class Ee extends Ne{constructor(n,c={}){super("error",Tt({error:n},c))}}class He{on(n,c){return this._listeners=this._listeners||{},ve(n,c,this._listeners),{unsubscribe:()=>{this.off(n,c)}}}off(n,c){return $e(n,c,this._listeners),$e(n,c,this._oneTimeListeners),this}once(n,c){return c?(this._oneTimeListeners=this._oneTimeListeners||{},ve(n,c,this._oneTimeListeners),this):new Promise(d=>this.once(n,d))}fire(n,c){typeof n=="string"&&(n=new Ne(n,c||{}));const d=n.type;if(this.listens(d)){n.target=this;const m=this._listeners&&this._listeners[d]?this._listeners[d].slice():[];for(const w of m)w.call(this,n);const b=this._oneTimeListeners&&this._oneTimeListeners[d]?this._oneTimeListeners[d].slice():[];for(const w of b)$e(d,w,this._oneTimeListeners),w.call(this,n);const v=this._eventedParent;v&&(Tt(n,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),v.fire(n))}else n instanceof Ee&&console.error(n.error);return this}listens(n){return this._listeners&&this._listeners[n]&&this._listeners[n].length>0||this._oneTimeListeners&&this._oneTimeListeners[n]&&this._oneTimeListeners[n].length>0||this._eventedParent&&this._eventedParent.listens(n)}setEventedParent(n,c){return this._eventedParent=n,this._eventedParentData=c,this}}var fe={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},state:{type:"state",default:{}},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},"color-relief":{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_color-relief","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_color-relief":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_color-relief","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"numberArray",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-altitude":{type:"numberArray",default:45,minimum:0,maximum:90,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"colorArray",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"colorArray",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-method":{type:"enum",values:{standard:{},basic:{},combined:{},igor:{},multidirectional:{}},default:"standard",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},"paint_color-relief":{"color-relief-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"color-relief-color":{type:"color",transition:!1,expression:{interpolated:!0,parameters:["elevation"]},"property-type":"color-ramp"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const lt=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function Et(h,n){const c={};for(const d in h)d!=="ref"&&(c[d]=h[d]);return lt.forEach(d=>{d in n&&(c[d]=n[d])}),c}function ut(h,n){if(Array.isArray(h)){if(!Array.isArray(n)||h.length!==n.length)return!1;for(let c=0;c<h.length;c++)if(!ut(h[c],n[c]))return!1;return!0}if(typeof h=="object"&&h!==null&&n!==null){if(typeof n!="object"||Object.keys(h).length!==Object.keys(n).length)return!1;for(const c in h)if(!ut(h[c],n[c]))return!1;return!0}return h===n}function vt(h,n){h.push(n)}function Dt(h,n,c){vt(c,{command:"addSource",args:[h,n[h]]})}function Tr(h,n,c){vt(n,{command:"removeSource",args:[h]}),c[h]=!0}function lr(h,n,c,d){Tr(h,c,d),Dt(h,n,c)}function ir(h,n,c){let d;for(d in h[c])if(Object.prototype.hasOwnProperty.call(h[c],d)&&d!=="data"&&!ut(h[c][d],n[c][d]))return!1;for(d in n[c])if(Object.prototype.hasOwnProperty.call(n[c],d)&&d!=="data"&&!ut(h[c][d],n[c][d]))return!1;return!0}function Mt(h,n,c,d,m,b){h=h||{},n=n||{};for(const v in h)Object.prototype.hasOwnProperty.call(h,v)&&(ut(h[v],n[v])||c.push({command:b,args:[d,v,n[v],m]}));for(const v in n)Object.prototype.hasOwnProperty.call(n,v)&&!Object.prototype.hasOwnProperty.call(h,v)&&(ut(h[v],n[v])||c.push({command:b,args:[d,v,n[v],m]}))}function er(h){return h.id}function ai(h,n){return h[n.id]=n,h}class rt{constructor(n,c,d,m){this.message=(n?`${n}: `:"")+d,m&&(this.identifier=m),c!=null&&c.__line__&&(this.line=c.__line__)}}function bi(h,...n){for(const c of n)for(const d in c)h[d]=c[d];return h}class Dr extends Error{constructor(n,c){super(c),this.message=c,this.key=n}}class ns{constructor(n,c=[]){this.parent=n,this.bindings={};for(const[d,m]of c)this.bindings[d]=m}concat(n){return new ns(this,n)}get(n){if(this.bindings[n])return this.bindings[n];if(this.parent)return this.parent.get(n);throw new Error(`${n} not found in scope.`)}has(n){return!!this.bindings[n]||!!this.parent&&this.parent.has(n)}}const Es={kind:"null"},st={kind:"number"},Ut={kind:"string"},Vt={kind:"boolean"},tn={kind:"color"},Wa={kind:"projectionDefinition"},In={kind:"object"},jt={kind:"value"},Un={kind:"collator"},Is={kind:"formatted"},Xr={kind:"padding"},Lo={kind:"colorArray"},No={kind:"numberArray"},Vn={kind:"resolvedImage"},zo={kind:"variableAnchorOffsetCollection"};function rn(h,n){return{kind:"array",itemType:h,N:n}}function Or(h){if(h.kind==="array"){const n=Or(h.itemType);return typeof h.N=="number"?`array<${n}, ${h.N}>`:h.itemType.kind==="value"?"array":`array<${n}>`}return h.kind}const iu=[Es,st,Ut,Vt,tn,Wa,Is,In,rn(jt),Xr,No,Lo,Vn,zo];function Uo(h,n){if(n.kind==="error")return null;if(h.kind==="array"){if(n.kind==="array"&&(n.N===0&&n.itemType.kind==="value"||!Uo(h.itemType,n.itemType))&&(typeof h.N!="number"||h.N===n.N))return null}else{if(h.kind===n.kind)return null;if(h.kind==="value"){for(const c of iu)if(!Uo(c,n))return null}}return`Expected ${Or(h)} but found ${Or(n)} instead.`}function Ha(h,n){return n.some(c=>c.kind===h.kind)}function Cs(h,n){return n.some(c=>c==="null"?h===null:c==="array"?Array.isArray(h):c==="object"?h&&!Array.isArray(h)&&typeof h=="object":c===typeof h)}function ss(h,n){return h.kind==="array"&&n.kind==="array"?h.itemType.kind===n.itemType.kind&&typeof h.N=="number":h.kind===n.kind}const nu=.96422,su=.82521,ou=4/29,Zs=6/29,au=3*Zs*Zs,lu=Zs*Zs*Zs,Vo=Math.PI/180,bf=180/Math.PI;function cu(h){return(h%=360)<0&&(h+=360),h}function Xs([h,n,c,d]){let m,b;const v=gc((.2225045*(h=pc(h))+.7168786*(n=pc(n))+.0606169*(c=pc(c)))/1);h===n&&n===c?m=b=v:(m=gc((.4360747*h+.3850649*n+.1430804*c)/nu),b=gc((.0139322*h+.0971045*n+.7141733*c)/su));const w=116*v-16;return[w<0?0:w,500*(m-v),200*(v-b),d]}function pc(h){return h<=.04045?h/12.92:Math.pow((h+.055)/1.055,2.4)}function gc(h){return h>lu?Math.pow(h,1/3):h/au+ou}function hu([h,n,c,d]){let m=(h+16)/116,b=isNaN(n)?m:m+n/500,v=isNaN(c)?m:m-c/200;return m=1*Xa(m),b=nu*Xa(b),v=su*Xa(v),[Za(3.1338561*b-1.6168667*m-.4906146*v),Za(-.9787684*b+1.9161415*m+.033454*v),Za(.0719453*b-.2289914*m+1.4052427*v),d]}function Za(h){return(h=h<=.00304?12.92*h:1.055*Math.pow(h,1/2.4)-.055)<0?0:h>1?1:h}function Xa(h){return h>Zs?h*h*h:au*(h-ou)}const Cn=Object.hasOwn||function(h,n){return Object.prototype.hasOwnProperty.call(h,n)};function Zt(h,n){return Cn(h,n)?h[n]:void 0}function jn(h){return parseInt(h.padEnd(2,h),16)/255}function $n(h,n){return Ps(n?h/100:h,0,1)}function Ps(h,n,c){return Math.min(Math.max(n,h),c)}function mc(h){return!h.some(Number.isNaN)}const _c={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function hn(h,n,c){return h+c*(n-h)}function Wn(h,n,c){return h.map((d,m)=>hn(d,n[m],c))}class Xt{constructor(n,c,d,m=1,b=!0){this.r=n,this.g=c,this.b=d,this.a=m,b||(this.r*=m,this.g*=m,this.b*=m,m||this.overwriteGetter("rgb",[n,c,d,m]))}static parse(n){if(n instanceof Xt)return n;if(typeof n!="string")return;const c=function(d){if((d=d.toLowerCase().trim())==="transparent")return[0,0,0,0];const m=Zt(_c,d);if(m){const[v,w,A]=m;return[v/255,w/255,A/255,1]}if(d.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(d)){const v=d.length<6?1:2;let w=1;return[jn(d.slice(w,w+=v)),jn(d.slice(w,w+=v)),jn(d.slice(w,w+=v)),jn(d.slice(w,w+v)||"ff")]}if(d.startsWith("rgb")){const v=d.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(v){const[w,A,P,R,D,L,U,j,H,Y,te,ge]=v,le=[R||" ",U||" ",Y].join("");if(le==="  "||le==="  /"||le===",,"||le===",,,"){const z=[P,L,H].join(""),q=z==="%%%"?100:z===""?255:0;if(q){const he=[Ps(+A/q,0,1),Ps(+D/q,0,1),Ps(+j/q,0,1),te?$n(+te,ge):1];if(mc(he))return he}}return}}const b=d.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(b){const[v,w,A,P,R,D,L,U,j]=b,H=[A||" ",R||" ",L].join("");if(H==="  "||H==="  /"||H===",,"||H===",,,"){const Y=[+w,Ps(+P,0,100),Ps(+D,0,100),U?$n(+U,j):1];if(mc(Y))return function([te,ge,le,z]){function q(he){const Re=(he+te/30)%12,Xe=ge*Math.min(le,1-le);return le-Xe*Math.max(-1,Math.min(Re-3,9-Re,1))}return te=cu(te),ge/=100,le/=100,[q(0),q(8),q(4),z]}(Y)}}}(n);return c?new Xt(...c,!1):void 0}get rgb(){const{r:n,g:c,b:d,a:m}=this,b=m||1/0;return this.overwriteGetter("rgb",[n/b,c/b,d/b,m])}get hcl(){return this.overwriteGetter("hcl",function(n){const[c,d,m,b]=Xs(n),v=Math.sqrt(d*d+m*m);return[Math.round(1e4*v)?cu(Math.atan2(m,d)*bf):NaN,v,c,b]}(this.rgb))}get lab(){return this.overwriteGetter("lab",Xs(this.rgb))}overwriteGetter(n,c){return Object.defineProperty(this,n,{value:c}),c}toString(){const[n,c,d,m]=this.rgb;return`rgba(${[n,c,d].map(b=>Math.round(255*b)).join(",")},${m})`}static interpolate(n,c,d,m="rgb"){switch(m){case"rgb":{const[b,v,w,A]=Wn(n.rgb,c.rgb,d);return new Xt(b,v,w,A,!1)}case"hcl":{const[b,v,w,A]=n.hcl,[P,R,D,L]=c.hcl;let U,j;if(isNaN(b)||isNaN(P))isNaN(b)?isNaN(P)?U=NaN:(U=P,w!==1&&w!==0||(j=R)):(U=b,D!==1&&D!==0||(j=v));else{let le=P-b;P>b&&le>180?le-=360:P<b&&b-P>180&&(le+=360),U=b+d*le}const[H,Y,te,ge]=function([le,z,q,he]){return le=isNaN(le)?0:le*Vo,hu([q,Math.cos(le)*z,Math.sin(le)*z,he])}([U,j??hn(v,R,d),hn(w,D,d),hn(A,L,d)]);return new Xt(H,Y,te,ge,!1)}case"lab":{const[b,v,w,A]=hu(Wn(n.lab,c.lab,d));return new Xt(b,v,w,A,!1)}}}}Xt.black=new Xt(0,0,0,1),Xt.white=new Xt(1,1,1,1),Xt.transparent=new Xt(0,0,0,0),Xt.red=new Xt(1,0,0,1);class jo{constructor(n,c,d){this.sensitivity=n?c?"variant":"case":c?"accent":"base",this.locale=d,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(n,c){return this.collator.compare(n,c)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}const qa=["bottom","center","top"];class yc{constructor(n,c,d,m,b,v){this.text=n,this.image=c,this.scale=d,this.fontStack=m,this.textColor=b,this.verticalAlign=v}}class Di{constructor(n){this.sections=n}static fromString(n){return new Di([new yc(n,null,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(n=>n.text.length!==0||n.image&&n.image.name.length!==0)}static factory(n){return n instanceof Di?n:Di.fromString(n)}toString(){return this.sections.length===0?"":this.sections.map(n=>n.text).join("")}}class Gr{constructor(n){this.values=n.slice()}static parse(n){if(n instanceof Gr)return n;if(typeof n=="number")return new Gr([n,n,n,n]);if(Array.isArray(n)&&!(n.length<1||n.length>4)){for(const c of n)if(typeof c!="number")return;switch(n.length){case 1:n=[n[0],n[0],n[0],n[0]];break;case 2:n=[n[0],n[1],n[0],n[1]];break;case 3:n=[n[0],n[1],n[2],n[1]]}return new Gr(n)}}toString(){return JSON.stringify(this.values)}static interpolate(n,c,d){return new Gr(Wn(n.values,c.values,d))}}class Oi{constructor(n){this.values=n.slice()}static parse(n){if(n instanceof Oi)return n;if(typeof n=="number")return new Oi([n]);if(Array.isArray(n)){for(const c of n)if(typeof c!="number")return;return new Oi(n)}}toString(){return JSON.stringify(this.values)}static interpolate(n,c,d){return new Oi(Wn(n.values,c.values,d))}}class li{constructor(n){this.values=n.slice()}static parse(n){if(n instanceof li)return n;if(typeof n=="string"){const d=Xt.parse(n);return d?new li([d]):void 0}if(!Array.isArray(n))return;const c=[];for(const d of n){if(typeof d!="string")return;const m=Xt.parse(d);if(!m)return;c.push(m)}return new li(c)}toString(){return JSON.stringify(this.values)}static interpolate(n,c,d,m="rgb"){const b=[];if(n.values.length!=c.values.length)throw new Error(`colorArray: Arrays have mismatched length (${n.values.length} vs. ${c.values.length}), cannot interpolate.`);for(let v=0;v<n.values.length;v++)b.push(Xt.interpolate(n.values[v],c.values[v],d,m));return new li(b)}}class Fr extends Error{constructor(n){super(n),this.name="RuntimeError"}toJSON(){return this.message}}const Ya=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class tr{constructor(n){this.values=n.slice()}static parse(n){if(n instanceof tr)return n;if(Array.isArray(n)&&!(n.length<1)&&n.length%2==0){for(let c=0;c<n.length;c+=2){const d=n[c],m=n[c+1];if(typeof d!="string"||!Ya.has(d)||!Array.isArray(m)||m.length!==2||typeof m[0]!="number"||typeof m[1]!="number")return}return new tr(n)}}toString(){return JSON.stringify(this.values)}static interpolate(n,c,d){const m=n.values,b=c.values;if(m.length!==b.length)throw new Fr(`Cannot interpolate values of different length. from: ${n.toString()}, to: ${c.toString()}`);const v=[];for(let w=0;w<m.length;w+=2){if(m[w]!==b[w])throw new Fr(`Cannot interpolate values containing mismatched anchors. from[${w}]: ${m[w]}, to[${w}]: ${b[w]}`);v.push(m[w]);const[A,P]=m[w+1],[R,D]=b[w+1];v.push([hn(A,R,d),hn(P,D,d)])}return new tr(v)}}class Hi{constructor(n){this.name=n.name,this.available=n.available}toString(){return this.name}static fromString(n){return n?new Hi({name:n,available:!1}):null}}class Ft{constructor(n,c,d){this.from=n,this.to=c,this.transition=d}static interpolate(n,c,d){return new Ft(n,c,d)}static parse(n){return n instanceof Ft?n:Array.isArray(n)&&n.length===3&&typeof n[0]=="string"&&typeof n[1]=="string"&&typeof n[2]=="number"?new Ft(n[0],n[1],n[2]):typeof n=="object"&&typeof n.from=="string"&&typeof n.to=="string"&&typeof n.transition=="number"?new Ft(n.from,n.to,n.transition):typeof n=="string"?new Ft(n,n,1):void 0}}function Lt(h,n,c,d){return typeof h=="number"&&h>=0&&h<=255&&typeof n=="number"&&n>=0&&n<=255&&typeof c=="number"&&c>=0&&c<=255?d===void 0||typeof d=="number"&&d>=0&&d<=1?null:`Invalid rgba value [${[h,n,c,d].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof d=="number"?[h,n,c,d]:[h,n,c]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Ms(h){if(h===null||typeof h=="string"||typeof h=="boolean"||typeof h=="number"||h instanceof Ft||h instanceof Xt||h instanceof jo||h instanceof Di||h instanceof Gr||h instanceof Oi||h instanceof li||h instanceof tr||h instanceof Hi)return!0;if(Array.isArray(h)){for(const n of h)if(!Ms(n))return!1;return!0}if(typeof h=="object"){for(const n in h)if(!Ms(h[n]))return!1;return!0}return!1}function Pt(h){if(h===null)return Es;if(typeof h=="string")return Ut;if(typeof h=="boolean")return Vt;if(typeof h=="number")return st;if(h instanceof Xt)return tn;if(h instanceof Ft)return Wa;if(h instanceof jo)return Un;if(h instanceof Di)return Is;if(h instanceof Gr)return Xr;if(h instanceof Oi)return No;if(h instanceof li)return Lo;if(h instanceof tr)return zo;if(h instanceof Hi)return Vn;if(Array.isArray(h)){const n=h.length;let c;for(const d of h){const m=Pt(d);if(c){if(c===m)continue;c=jt;break}c=m}return rn(c||jt,n)}return In}function Rs(h){const n=typeof h;return h===null?"":n==="string"||n==="number"||n==="boolean"?String(h):h instanceof Xt||h instanceof Ft||h instanceof Di||h instanceof Gr||h instanceof Oi||h instanceof li||h instanceof tr||h instanceof Hi?h.toString():JSON.stringify(h)}class zi{constructor(n,c){this.type=n,this.value=c}static parse(n,c){if(n.length!==2)return c.error(`'literal' expression requires exactly one argument, but found ${n.length-1} instead.`);if(!Ms(n[1]))return c.error("invalid value");const d=n[1];let m=Pt(d);const b=c.expectedType;return m.kind!=="array"||m.N!==0||!b||b.kind!=="array"||typeof b.N=="number"&&b.N!==0||(m=b),new zi(m,d)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}const qs={string:Ut,number:st,boolean:Vt,object:In};class Zi{constructor(n,c){this.type=n,this.args=c}static parse(n,c){if(n.length<2)return c.error("Expected at least one argument.");let d,m=1;const b=n[0];if(b==="array"){let w,A;if(n.length>2){const P=n[1];if(typeof P!="string"||!(P in qs)||P==="object")return c.error('The item type argument of "array" must be one of string, number, boolean',1);w=qs[P],m++}else w=jt;if(n.length>3){if(n[2]!==null&&(typeof n[2]!="number"||n[2]<0||n[2]!==Math.floor(n[2])))return c.error('The length argument to "array" must be a positive integer literal',2);A=n[2],m++}d=rn(w,A)}else{if(!qs[b])throw new Error(`Types doesn't contain name = ${b}`);d=qs[b]}const v=[];for(;m<n.length;m++){const w=c.parse(n[m],m,jt);if(!w)return null;v.push(w)}return new Zi(d,v)}evaluate(n){for(let c=0;c<this.args.length;c++){const d=this.args[c].evaluate(n);if(!Uo(this.type,Pt(d)))return d;if(c===this.args.length-1)throw new Fr(`Expected value to be of type ${Or(this.type)}, but found ${Or(Pt(d))} instead.`)}throw new Error}eachChild(n){this.args.forEach(n)}outputDefined(){return this.args.every(n=>n.outputDefined())}}const bc={"to-boolean":Vt,"to-color":tn,"to-number":st,"to-string":Ut};class Pn{constructor(n,c){this.type=n,this.args=c}static parse(n,c){if(n.length<2)return c.error("Expected at least one argument.");const d=n[0];if(!bc[d])throw new Error(`Can't parse ${d} as it is not part of the known types`);if((d==="to-boolean"||d==="to-string")&&n.length!==2)return c.error("Expected one argument.");const m=bc[d],b=[];for(let v=1;v<n.length;v++){const w=c.parse(n[v],v,jt);if(!w)return null;b.push(w)}return new Pn(m,b)}evaluate(n){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(n);case"color":{let c,d;for(const m of this.args){if(c=m.evaluate(n),d=null,c instanceof Xt)return c;if(typeof c=="string"){const b=n.parseColor(c);if(b)return b}else if(Array.isArray(c)&&(d=c.length<3||c.length>4?`Invalid rgba value ${JSON.stringify(c)}: expected an array containing either three or four numeric values.`:Lt(c[0],c[1],c[2],c[3]),!d))return new Xt(c[0]/255,c[1]/255,c[2]/255,c[3])}throw new Fr(d||`Could not parse color from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"padding":{let c;for(const d of this.args){c=d.evaluate(n);const m=Gr.parse(c);if(m)return m}throw new Fr(`Could not parse padding from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"numberArray":{let c;for(const d of this.args){c=d.evaluate(n);const m=Oi.parse(c);if(m)return m}throw new Fr(`Could not parse numberArray from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"colorArray":{let c;for(const d of this.args){c=d.evaluate(n);const m=li.parse(c);if(m)return m}throw new Fr(`Could not parse colorArray from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"variableAnchorOffsetCollection":{let c;for(const d of this.args){c=d.evaluate(n);const m=tr.parse(c);if(m)return m}throw new Fr(`Could not parse variableAnchorOffsetCollection from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"number":{let c=null;for(const d of this.args){if(c=d.evaluate(n),c===null)return 0;const m=Number(c);if(!isNaN(m))return m}throw new Fr(`Could not convert ${JSON.stringify(c)} to number.`)}case"formatted":return Di.fromString(Rs(this.args[0].evaluate(n)));case"resolvedImage":return Hi.fromString(Rs(this.args[0].evaluate(n)));case"projectionDefinition":return this.args[0].evaluate(n);default:return Rs(this.args[0].evaluate(n))}}eachChild(n){this.args.forEach(n)}outputDefined(){return this.args.every(n=>n.outputDefined())}}const uu=["Unknown","Point","LineString","Polygon"];class du{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache=new Map,this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?uu[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(n){let c=this._parseColorCache.get(n);return c||(c=Xt.parse(n),this._parseColorCache.set(n,c)),c}}class $o{constructor(n,c,d=[],m,b=new ns,v=[]){this.registry=n,this.path=d,this.key=d.map(w=>`[${w}]`).join(""),this.scope=b,this.errors=v,this.expectedType=m,this._isConstant=c}parse(n,c,d,m,b={}){return c?this.concat(c,d,m)._parse(n,b):this._parse(n,b)}_parse(n,c){function d(m,b,v){return v==="assert"?new Zi(b,[m]):v==="coerce"?new Pn(b,[m]):m}if(n!==null&&typeof n!="string"&&typeof n!="boolean"&&typeof n!="number"||(n=["literal",n]),Array.isArray(n)){if(n.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const m=n[0];if(typeof m!="string")return this.error(`Expression name must be a string, but found ${typeof m} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const b=this.registry[m];if(b){let v=b.parse(n,this);if(!v)return null;if(this.expectedType){const w=this.expectedType,A=v.type;if(w.kind!=="string"&&w.kind!=="number"&&w.kind!=="boolean"&&w.kind!=="object"&&w.kind!=="array"||A.kind!=="value"){if(w.kind==="projectionDefinition"&&["string","array"].includes(A.kind)||["color","formatted","resolvedImage"].includes(w.kind)&&["value","string"].includes(A.kind)||["padding","numberArray"].includes(w.kind)&&["value","number","array"].includes(A.kind)||w.kind==="colorArray"&&["value","string","array"].includes(A.kind)||w.kind==="variableAnchorOffsetCollection"&&["value","array"].includes(A.kind))v=d(v,w,c.typeAnnotation||"coerce");else if(this.checkSubtype(w,A))return null}else v=d(v,w,c.typeAnnotation||"assert")}if(!(v instanceof zi)&&v.type.kind!=="resolvedImage"&&this._isConstant(v)){const w=new du;try{v=new zi(v.type,v.evaluate(w))}catch(A){return this.error(A.message),null}}return v}return this.error(`Unknown expression "${m}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(n===void 0?"'undefined' value invalid. Use null instead.":typeof n=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof n} instead.`)}concat(n,c,d){const m=typeof n=="number"?this.path.concat(n):this.path,b=d?this.scope.concat(d):this.scope;return new $o(this.registry,this._isConstant,m,c||null,b,this.errors)}error(n,...c){const d=`${this.key}${c.map(m=>`[${m}]`).join("")}`;this.errors.push(new Dr(d,n))}checkSubtype(n,c){const d=Uo(n,c);return d&&this.error(d),d}}class Wo{constructor(n,c){this.type=c.type,this.bindings=[].concat(n),this.result=c}evaluate(n){return this.result.evaluate(n)}eachChild(n){for(const c of this.bindings)n(c[1]);n(this.result)}static parse(n,c){if(n.length<4)return c.error(`Expected at least 3 arguments, but found ${n.length-1} instead.`);const d=[];for(let b=1;b<n.length-1;b+=2){const v=n[b];if(typeof v!="string")return c.error(`Expected string, but found ${typeof v} instead.`,b);if(/[^a-zA-Z0-9_]/.test(v))return c.error("Variable names must contain only alphanumeric characters or '_'.",b);const w=c.parse(n[b+1],b+1);if(!w)return null;d.push([v,w])}const m=c.parse(n[n.length-1],n.length-1,c.expectedType,d);return m?new Wo(d,m):null}outputDefined(){return this.result.outputDefined()}}class pn{constructor(n,c){this.type=c.type,this.name=n,this.boundExpression=c}static parse(n,c){if(n.length!==2||typeof n[1]!="string")return c.error("'var' expression requires exactly one string literal argument.");const d=n[1];return c.scope.has(d)?new pn(d,c.scope.get(d)):c.error(`Unknown variable "${d}". Make sure "${d}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(n){return this.boundExpression.evaluate(n)}eachChild(){}outputDefined(){return!1}}class ci{constructor(n,c,d){this.type=n,this.index=c,this.input=d}static parse(n,c){if(n.length!==3)return c.error(`Expected 2 arguments, but found ${n.length-1} instead.`);const d=c.parse(n[1],1,st),m=c.parse(n[2],2,rn(c.expectedType||jt));return d&&m?new ci(m.type.itemType,d,m):null}evaluate(n){const c=this.index.evaluate(n),d=this.input.evaluate(n);if(c<0)throw new Fr(`Array index out of bounds: ${c} < 0.`);if(c>=d.length)throw new Fr(`Array index out of bounds: ${c} > ${d.length-1}.`);if(c!==Math.floor(c))throw new Fr(`Array index must be an integer, but found ${c} instead.`);return d[c]}eachChild(n){n(this.index),n(this.input)}outputDefined(){return!1}}class Ys{constructor(n,c){this.type=Vt,this.needle=n,this.haystack=c}static parse(n,c){if(n.length!==3)return c.error(`Expected 2 arguments, but found ${n.length-1} instead.`);const d=c.parse(n[1],1,jt),m=c.parse(n[2],2,jt);return d&&m?Ha(d.type,[Vt,Ut,st,Es,jt])?new Ys(d,m):c.error(`Expected first argument to be of type boolean, string, number or null, but found ${Or(d.type)} instead`):null}evaluate(n){const c=this.needle.evaluate(n),d=this.haystack.evaluate(n);if(!d)return!1;if(!Cs(c,["boolean","string","number","null"]))throw new Fr(`Expected first argument to be of type boolean, string, number or null, but found ${Or(Pt(c))} instead.`);if(!Cs(d,["string","array"]))throw new Fr(`Expected second argument to be of type array or string, but found ${Or(Pt(d))} instead.`);return d.indexOf(c)>=0}eachChild(n){n(this.needle),n(this.haystack)}outputDefined(){return!0}}class Ho{constructor(n,c,d){this.type=st,this.needle=n,this.haystack=c,this.fromIndex=d}static parse(n,c){if(n.length<=2||n.length>=5)return c.error(`Expected 3 or 4 arguments, but found ${n.length-1} instead.`);const d=c.parse(n[1],1,jt),m=c.parse(n[2],2,jt);if(!d||!m)return null;if(!Ha(d.type,[Vt,Ut,st,Es,jt]))return c.error(`Expected first argument to be of type boolean, string, number or null, but found ${Or(d.type)} instead`);if(n.length===4){const b=c.parse(n[3],3,st);return b?new Ho(d,m,b):null}return new Ho(d,m)}evaluate(n){const c=this.needle.evaluate(n),d=this.haystack.evaluate(n);if(!Cs(c,["boolean","string","number","null"]))throw new Fr(`Expected first argument to be of type boolean, string, number or null, but found ${Or(Pt(c))} instead.`);let m;if(this.fromIndex&&(m=this.fromIndex.evaluate(n)),Cs(d,["string"])){const b=d.indexOf(c,m);return b===-1?-1:[...d.slice(0,b)].length}if(Cs(d,["array"]))return d.indexOf(c,m);throw new Fr(`Expected second argument to be of type array or string, but found ${Or(Pt(d))} instead.`)}eachChild(n){n(this.needle),n(this.haystack),this.fromIndex&&n(this.fromIndex)}outputDefined(){return!1}}class Gs{constructor(n,c,d,m,b,v){this.inputType=n,this.type=c,this.input=d,this.cases=m,this.outputs=b,this.otherwise=v}static parse(n,c){if(n.length<5)return c.error(`Expected at least 4 arguments, but found only ${n.length-1}.`);if(n.length%2!=1)return c.error("Expected an even number of arguments.");let d,m;c.expectedType&&c.expectedType.kind!=="value"&&(m=c.expectedType);const b={},v=[];for(let P=2;P<n.length-1;P+=2){let R=n[P];const D=n[P+1];Array.isArray(R)||(R=[R]);const L=c.concat(P);if(R.length===0)return L.error("Expected at least one branch label.");for(const j of R){if(typeof j!="number"&&typeof j!="string")return L.error("Branch labels must be numbers or strings.");if(typeof j=="number"&&Math.abs(j)>Number.MAX_SAFE_INTEGER)return L.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof j=="number"&&Math.floor(j)!==j)return L.error("Numeric branch labels must be integer values.");if(d){if(L.checkSubtype(d,Pt(j)))return null}else d=Pt(j);if(b[String(j)]!==void 0)return L.error("Branch labels must be unique.");b[String(j)]=v.length}const U=c.parse(D,P,m);if(!U)return null;m=m||U.type,v.push(U)}const w=c.parse(n[1],1,jt);if(!w)return null;const A=c.parse(n[n.length-1],n.length-1,m);return A?w.type.kind!=="value"&&c.concat(1).checkSubtype(d,w.type)?null:new Gs(d,m,w,b,v,A):null}evaluate(n){const c=this.input.evaluate(n);return(Pt(c)===this.inputType&&this.outputs[this.cases[c]]||this.otherwise).evaluate(n)}eachChild(n){n(this.input),this.outputs.forEach(n),n(this.otherwise)}outputDefined(){return this.outputs.every(n=>n.outputDefined())&&this.otherwise.outputDefined()}}class Kr{constructor(n,c,d){this.type=n,this.branches=c,this.otherwise=d}static parse(n,c){if(n.length<4)return c.error(`Expected at least 3 arguments, but found only ${n.length-1}.`);if(n.length%2!=0)return c.error("Expected an odd number of arguments.");let d;c.expectedType&&c.expectedType.kind!=="value"&&(d=c.expectedType);const m=[];for(let v=1;v<n.length-1;v+=2){const w=c.parse(n[v],v,Vt);if(!w)return null;const A=c.parse(n[v+1],v+1,d);if(!A)return null;m.push([w,A]),d=d||A.type}const b=c.parse(n[n.length-1],n.length-1,d);if(!b)return null;if(!d)throw new Error("Can't infer output type");return new Kr(d,m,b)}evaluate(n){for(const[c,d]of this.branches)if(c.evaluate(n))return d.evaluate(n);return this.otherwise.evaluate(n)}eachChild(n){for(const[c,d]of this.branches)n(c),n(d);n(this.otherwise)}outputDefined(){return this.branches.every(([n,c])=>c.outputDefined())&&this.otherwise.outputDefined()}}class Zo{constructor(n,c,d,m){this.type=n,this.input=c,this.beginIndex=d,this.endIndex=m}static parse(n,c){if(n.length<=2||n.length>=5)return c.error(`Expected 3 or 4 arguments, but found ${n.length-1} instead.`);const d=c.parse(n[1],1,jt),m=c.parse(n[2],2,st);if(!d||!m)return null;if(!Ha(d.type,[rn(jt),Ut,jt]))return c.error(`Expected first argument to be of type array or string, but found ${Or(d.type)} instead`);if(n.length===4){const b=c.parse(n[3],3,st);return b?new Zo(d.type,d,m,b):null}return new Zo(d.type,d,m)}evaluate(n){const c=this.input.evaluate(n),d=this.beginIndex.evaluate(n);let m;if(this.endIndex&&(m=this.endIndex.evaluate(n)),Cs(c,["string"]))return[...c].slice(d,m).join("");if(Cs(c,["array"]))return c.slice(d,m);throw new Fr(`Expected first argument to be of type array or string, but found ${Or(Pt(c))} instead.`)}eachChild(n){n(this.input),n(this.beginIndex),this.endIndex&&n(this.endIndex)}outputDefined(){return!1}}function Ks(h,n){const c=h.length-1;let d,m,b=0,v=c,w=0;for(;b<=v;)if(w=Math.floor((b+v)/2),d=h[w],m=h[w+1],d<=n){if(w===c||n<m)return w;b=w+1}else{if(!(d>n))throw new Fr("Input is not a number.");v=w-1}return 0}class Js{constructor(n,c,d){this.type=n,this.input=c,this.labels=[],this.outputs=[];for(const[m,b]of d)this.labels.push(m),this.outputs.push(b)}static parse(n,c){if(n.length-1<4)return c.error(`Expected at least 4 arguments, but found only ${n.length-1}.`);if((n.length-1)%2!=0)return c.error("Expected an even number of arguments.");const d=c.parse(n[1],1,st);if(!d)return null;const m=[];let b=null;c.expectedType&&c.expectedType.kind!=="value"&&(b=c.expectedType);for(let v=1;v<n.length;v+=2){const w=v===1?-1/0:n[v],A=n[v+1],P=v,R=v+1;if(typeof w!="number")return c.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',P);if(m.length&&m[m.length-1][0]>=w)return c.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',P);const D=c.parse(A,R,b);if(!D)return null;b=b||D.type,m.push([w,D])}return new Js(b,d,m)}evaluate(n){const c=this.labels,d=this.outputs;if(c.length===1)return d[0].evaluate(n);const m=this.input.evaluate(n);if(m<=c[0])return d[0].evaluate(n);const b=c.length;return m>=c[b-1]?d[b-1].evaluate(n):d[Ks(c,m)].evaluate(n)}eachChild(n){n(this.input);for(const c of this.outputs)n(c)}outputDefined(){return this.outputs.every(n=>n.outputDefined())}}function vf(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var os,Xo,vc=function(){if(Xo)return os;function h(n,c,d,m){this.cx=3*n,this.bx=3*(d-n)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*c,this.by=3*(m-c)-this.cy,this.ay=1-this.cy-this.by,this.p1x=n,this.p1y=c,this.p2x=d,this.p2y=m}return Xo=1,os=h,h.prototype={sampleCurveX:function(n){return((this.ax*n+this.bx)*n+this.cx)*n},sampleCurveY:function(n){return((this.ay*n+this.by)*n+this.cy)*n},sampleCurveDerivativeX:function(n){return(3*this.ax*n+2*this.bx)*n+this.cx},solveCurveX:function(n,c){if(c===void 0&&(c=1e-6),n<0)return 0;if(n>1)return 1;for(var d=n,m=0;m<8;m++){var b=this.sampleCurveX(d)-n;if(Math.abs(b)<c)return d;var v=this.sampleCurveDerivativeX(d);if(Math.abs(v)<1e-6)break;d-=b/v}var w=0,A=1;for(d=n,m=0;m<20&&(b=this.sampleCurveX(d),!(Math.abs(b-n)<c));m++)n>b?w=d:A=d,d=.5*(A-w)+w;return d},solve:function(n,c){return this.sampleCurveY(this.solveCurveX(n,c))}},os}(),xf=vf(vc);class Ui{constructor(n,c,d,m,b){this.type=n,this.operator=c,this.interpolation=d,this.input=m,this.labels=[],this.outputs=[];for(const[v,w]of b)this.labels.push(v),this.outputs.push(w)}static interpolationFactor(n,c,d,m){let b=0;if(n.name==="exponential")b=Qs(c,n.base,d,m);else if(n.name==="linear")b=Qs(c,1,d,m);else if(n.name==="cubic-bezier"){const v=n.controlPoints;b=new xf(v[0],v[1],v[2],v[3]).solve(Qs(c,1,d,m))}return b}static parse(n,c){let[d,m,b,...v]=n;if(!Array.isArray(m)||m.length===0)return c.error("Expected an interpolation type expression.",1);if(m[0]==="linear")m={name:"linear"};else if(m[0]==="exponential"){const P=m[1];if(typeof P!="number")return c.error("Exponential interpolation requires a numeric base.",1,1);m={name:"exponential",base:P}}else{if(m[0]!=="cubic-bezier")return c.error(`Unknown interpolation type ${String(m[0])}`,1,0);{const P=m.slice(1);if(P.length!==4||P.some(R=>typeof R!="number"||R<0||R>1))return c.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);m={name:"cubic-bezier",controlPoints:P}}}if(n.length-1<4)return c.error(`Expected at least 4 arguments, but found only ${n.length-1}.`);if((n.length-1)%2!=0)return c.error("Expected an even number of arguments.");if(b=c.parse(b,2,st),!b)return null;const w=[];let A=null;d!=="interpolate-hcl"&&d!=="interpolate-lab"||c.expectedType==Lo?c.expectedType&&c.expectedType.kind!=="value"&&(A=c.expectedType):A=tn;for(let P=0;P<v.length;P+=2){const R=v[P],D=v[P+1],L=P+3,U=P+4;if(typeof R!="number")return c.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',L);if(w.length&&w[w.length-1][0]>=R)return c.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',L);const j=c.parse(D,U,A);if(!j)return null;A=A||j.type,w.push([R,j])}return ss(A,st)||ss(A,Wa)||ss(A,tn)||ss(A,Xr)||ss(A,No)||ss(A,Lo)||ss(A,zo)||ss(A,rn(st))?new Ui(A,d,m,b,w):c.error(`Type ${Or(A)} is not interpolatable.`)}evaluate(n){const c=this.labels,d=this.outputs;if(c.length===1)return d[0].evaluate(n);const m=this.input.evaluate(n);if(m<=c[0])return d[0].evaluate(n);const b=c.length;if(m>=c[b-1])return d[b-1].evaluate(n);const v=Ks(c,m),w=Ui.interpolationFactor(this.interpolation,m,c[v],c[v+1]),A=d[v].evaluate(n),P=d[v+1].evaluate(n);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return hn(A,P,w);case"color":return Xt.interpolate(A,P,w);case"padding":return Gr.interpolate(A,P,w);case"colorArray":return li.interpolate(A,P,w);case"numberArray":return Oi.interpolate(A,P,w);case"variableAnchorOffsetCollection":return tr.interpolate(A,P,w);case"array":return Wn(A,P,w);case"projectionDefinition":return Ft.interpolate(A,P,w)}case"interpolate-hcl":switch(this.type.kind){case"color":return Xt.interpolate(A,P,w,"hcl");case"colorArray":return li.interpolate(A,P,w,"hcl")}case"interpolate-lab":switch(this.type.kind){case"color":return Xt.interpolate(A,P,w,"lab");case"colorArray":return li.interpolate(A,P,w,"lab")}}}eachChild(n){n(this.input);for(const c of this.outputs)n(c)}outputDefined(){return this.outputs.every(n=>n.outputDefined())}}function Qs(h,n,c,d){const m=d-c,b=h-c;return m===0?0:n===1?b/m:(Math.pow(n,b)-1)/(Math.pow(n,m)-1)}const nn={color:Xt.interpolate,number:hn,padding:Gr.interpolate,numberArray:Oi.interpolate,colorArray:li.interpolate,variableAnchorOffsetCollection:tr.interpolate,array:Wn};class Xi{constructor(n,c){this.type=n,this.args=c}static parse(n,c){if(n.length<2)return c.error("Expected at least one argument.");let d=null;const m=c.expectedType;m&&m.kind!=="value"&&(d=m);const b=[];for(const w of n.slice(1)){const A=c.parse(w,1+b.length,d,void 0,{typeAnnotation:"omit"});if(!A)return null;d=d||A.type,b.push(A)}if(!d)throw new Error("No output type");const v=m&&b.some(w=>Uo(m,w.type));return new Xi(v?jt:d,b)}evaluate(n){let c,d=null,m=0;for(const b of this.args)if(m++,d=b.evaluate(n),d&&d instanceof Hi&&!d.available&&(c||(c=d.name),d=null,m===this.args.length&&(d=c)),d!==null)break;return d}eachChild(n){this.args.forEach(n)}outputDefined(){return this.args.every(n=>n.outputDefined())}}function xc(h,n){return h==="=="||h==="!="?n.kind==="boolean"||n.kind==="string"||n.kind==="number"||n.kind==="null"||n.kind==="value":n.kind==="string"||n.kind==="number"||n.kind==="value"}function qo(h,n,c,d){return d.compare(n,c)===0}function eo(h,n,c){const d=h!=="=="&&h!=="!=";return class Bv{constructor(b,v,w){this.type=Vt,this.lhs=b,this.rhs=v,this.collator=w,this.hasUntypedArgument=b.type.kind==="value"||v.type.kind==="value"}static parse(b,v){if(b.length!==3&&b.length!==4)return v.error("Expected two or three arguments.");const w=b[0];let A=v.parse(b[1],1,jt);if(!A)return null;if(!xc(w,A.type))return v.concat(1).error(`"${w}" comparisons are not supported for type '${Or(A.type)}'.`);let P=v.parse(b[2],2,jt);if(!P)return null;if(!xc(w,P.type))return v.concat(2).error(`"${w}" comparisons are not supported for type '${Or(P.type)}'.`);if(A.type.kind!==P.type.kind&&A.type.kind!=="value"&&P.type.kind!=="value")return v.error(`Cannot compare types '${Or(A.type)}' and '${Or(P.type)}'.`);d&&(A.type.kind==="value"&&P.type.kind!=="value"?A=new Zi(P.type,[A]):A.type.kind!=="value"&&P.type.kind==="value"&&(P=new Zi(A.type,[P])));let R=null;if(b.length===4){if(A.type.kind!=="string"&&P.type.kind!=="string"&&A.type.kind!=="value"&&P.type.kind!=="value")return v.error("Cannot use collator to compare non-string types.");if(R=v.parse(b[3],3,Un),!R)return null}return new Bv(A,P,R)}evaluate(b){const v=this.lhs.evaluate(b),w=this.rhs.evaluate(b);if(d&&this.hasUntypedArgument){const A=Pt(v),P=Pt(w);if(A.kind!==P.kind||A.kind!=="string"&&A.kind!=="number")throw new Fr(`Expected arguments for "${h}" to be (string, string) or (number, number), but found (${A.kind}, ${P.kind}) instead.`)}if(this.collator&&!d&&this.hasUntypedArgument){const A=Pt(v),P=Pt(w);if(A.kind!=="string"||P.kind!=="string")return n(b,v,w)}return this.collator?c(b,v,w,this.collator.evaluate(b)):n(b,v,w)}eachChild(b){b(this.lhs),b(this.rhs),this.collator&&b(this.collator)}outputDefined(){return!0}}}const wc=eo("==",function(h,n,c){return n===c},qo),wf=eo("!=",function(h,n,c){return n!==c},function(h,n,c,d){return!qo(0,n,c,d)}),Tf=eo("<",function(h,n,c){return n<c},function(h,n,c,d){return d.compare(n,c)<0}),Sf=eo(">",function(h,n,c){return n>c},function(h,n,c,d){return d.compare(n,c)>0}),Af=eo("<=",function(h,n,c){return n<=c},function(h,n,c,d){return d.compare(n,c)<=0}),Ga=eo(">=",function(h,n,c){return n>=c},function(h,n,c,d){return d.compare(n,c)>=0});class Ka{constructor(n,c,d){this.type=Un,this.locale=d,this.caseSensitive=n,this.diacriticSensitive=c}static parse(n,c){if(n.length!==2)return c.error("Expected one argument.");const d=n[1];if(typeof d!="object"||Array.isArray(d))return c.error("Collator options argument must be an object.");const m=c.parse(d["case-sensitive"]!==void 0&&d["case-sensitive"],1,Vt);if(!m)return null;const b=c.parse(d["diacritic-sensitive"]!==void 0&&d["diacritic-sensitive"],1,Vt);if(!b)return null;let v=null;return d.locale&&(v=c.parse(d.locale,1,Ut),!v)?null:new Ka(m,b,v)}evaluate(n){return new jo(this.caseSensitive.evaluate(n),this.diacriticSensitive.evaluate(n),this.locale?this.locale.evaluate(n):null)}eachChild(n){n(this.caseSensitive),n(this.diacriticSensitive),this.locale&&n(this.locale)}outputDefined(){return!1}}class Ja{constructor(n,c,d,m,b){this.type=Ut,this.number=n,this.locale=c,this.currency=d,this.minFractionDigits=m,this.maxFractionDigits=b}static parse(n,c){if(n.length!==3)return c.error("Expected two arguments.");const d=c.parse(n[1],1,st);if(!d)return null;const m=n[2];if(typeof m!="object"||Array.isArray(m))return c.error("NumberFormat options argument must be an object.");let b=null;if(m.locale&&(b=c.parse(m.locale,1,Ut),!b))return null;let v=null;if(m.currency&&(v=c.parse(m.currency,1,Ut),!v))return null;let w=null;if(m["min-fraction-digits"]&&(w=c.parse(m["min-fraction-digits"],1,st),!w))return null;let A=null;return m["max-fraction-digits"]&&(A=c.parse(m["max-fraction-digits"],1,st),!A)?null:new Ja(d,b,v,w,A)}evaluate(n){return new Intl.NumberFormat(this.locale?this.locale.evaluate(n):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(n):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(n):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(n):void 0}).format(this.number.evaluate(n))}eachChild(n){n(this.number),this.locale&&n(this.locale),this.currency&&n(this.currency),this.minFractionDigits&&n(this.minFractionDigits),this.maxFractionDigits&&n(this.maxFractionDigits)}outputDefined(){return!1}}class Yo{constructor(n){this.type=Is,this.sections=n}static parse(n,c){if(n.length<2)return c.error("Expected at least one argument.");const d=n[1];if(!Array.isArray(d)&&typeof d=="object")return c.error("First argument must be an image or text section.");const m=[];let b=!1;for(let v=1;v<=n.length-1;++v){const w=n[v];if(b&&typeof w=="object"&&!Array.isArray(w)){b=!1;let A=null;if(w["font-scale"]&&(A=c.parse(w["font-scale"],1,st),!A))return null;let P=null;if(w["text-font"]&&(P=c.parse(w["text-font"],1,rn(Ut)),!P))return null;let R=null;if(w["text-color"]&&(R=c.parse(w["text-color"],1,tn),!R))return null;let D=null;if(w["vertical-align"]){if(typeof w["vertical-align"]=="string"&&!qa.includes(w["vertical-align"]))return c.error(`'vertical-align' must be one of: 'bottom', 'center', 'top' but found '${w["vertical-align"]}' instead.`);if(D=c.parse(w["vertical-align"],1,Ut),!D)return null}const L=m[m.length-1];L.scale=A,L.font=P,L.textColor=R,L.verticalAlign=D}else{const A=c.parse(n[v],1,jt);if(!A)return null;const P=A.type.kind;if(P!=="string"&&P!=="value"&&P!=="null"&&P!=="resolvedImage")return c.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");b=!0,m.push({content:A,scale:null,font:null,textColor:null,verticalAlign:null})}}return new Yo(m)}evaluate(n){return new Di(this.sections.map(c=>{const d=c.content.evaluate(n);return Pt(d)===Vn?new yc("",d,null,null,null,c.verticalAlign?c.verticalAlign.evaluate(n):null):new yc(Rs(d),null,c.scale?c.scale.evaluate(n):null,c.font?c.font.evaluate(n).join(","):null,c.textColor?c.textColor.evaluate(n):null,c.verticalAlign?c.verticalAlign.evaluate(n):null)}))}eachChild(n){for(const c of this.sections)n(c.content),c.scale&&n(c.scale),c.font&&n(c.font),c.textColor&&n(c.textColor),c.verticalAlign&&n(c.verticalAlign)}outputDefined(){return!1}}class Tc{constructor(n){this.type=Vn,this.input=n}static parse(n,c){if(n.length!==2)return c.error("Expected two arguments.");const d=c.parse(n[1],1,Ut);return d?new Tc(d):c.error("No image name provided.")}evaluate(n){const c=this.input.evaluate(n),d=Hi.fromString(c);return d&&n.availableImages&&(d.available=n.availableImages.indexOf(c)>-1),d}eachChild(n){n(this.input)}outputDefined(){return!1}}class Qa{constructor(n){this.type=st,this.input=n}static parse(n,c){if(n.length!==2)return c.error(`Expected 1 argument, but found ${n.length-1} instead.`);const d=c.parse(n[1],1);return d?d.type.kind!=="array"&&d.type.kind!=="string"&&d.type.kind!=="value"?c.error(`Expected argument of type string or array, but found ${Or(d.type)} instead.`):new Qa(d):null}evaluate(n){const c=this.input.evaluate(n);if(typeof c=="string")return[...c].length;if(Array.isArray(c))return c.length;throw new Fr(`Expected value to be of type string or array, but found ${Or(Pt(c))} instead.`)}eachChild(n){n(this.input)}outputDefined(){return!1}}const Mn=8192;function Ef(h,n){const c=(180+h[0])/360,d=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+h[1]*Math.PI/360)))/360,m=Math.pow(2,n.z);return[Math.round(c*m*Mn),Math.round(d*m*Mn)]}function Sc(h,n){const c=Math.pow(2,n.z);return[(m=(h[0]/Mn+n.x)/c,360*m-180),(d=(h[1]/Mn+n.y)/c,360/Math.PI*Math.atan(Math.exp((180-360*d)*Math.PI/180))-90)];var d,m}function Go(h,n){h[0]=Math.min(h[0],n[0]),h[1]=Math.min(h[1],n[1]),h[2]=Math.max(h[2],n[0]),h[3]=Math.max(h[3],n[1])}function Ko(h,n){return!(h[0]<=n[0]||h[2]>=n[2]||h[1]<=n[1]||h[3]>=n[3])}function fu(h,n,c){const d=h[0]-n[0],m=h[1]-n[1],b=h[0]-c[0],v=h[1]-c[1];return d*v-b*m==0&&d*b<=0&&m*v<=0}function Jo(h,n,c,d){return(m=[d[0]-c[0],d[1]-c[1]])[0]*(b=[n[0]-h[0],n[1]-h[1]])[1]-m[1]*b[0]!=0&&!(!el(h,n,c,d)||!el(c,d,h,n));var m,b}function pu(h,n,c){for(const d of c)for(let m=0;m<d.length-1;++m)if(Jo(h,n,d[m],d[m+1]))return!0;return!1}function to(h,n,c=!1){let d=!1;for(const w of n)for(let A=0;A<w.length-1;A++){if(fu(h,w[A],w[A+1]))return c;(b=w[A])[1]>(m=h)[1]!=(v=w[A+1])[1]>m[1]&&m[0]<(v[0]-b[0])*(m[1]-b[1])/(v[1]-b[1])+b[0]&&(d=!d)}var m,b,v;return d}function If(h,n){for(const c of n)if(to(h,c))return!0;return!1}function gu(h,n){for(const c of h)if(!to(c,n))return!1;for(let c=0;c<h.length-1;++c)if(pu(h[c],h[c+1],n))return!1;return!0}function Cf(h,n){for(const c of n)if(gu(h,c))return!0;return!1}function el(h,n,c,d){const m=d[0]-c[0],b=d[1]-c[1],v=(h[0]-c[0])*b-m*(h[1]-c[1]),w=(n[0]-c[0])*b-m*(n[1]-c[1]);return v>0&&w<0||v<0&&w>0}function Ac(h,n,c){const d=[];for(let m=0;m<h.length;m++){const b=[];for(let v=0;v<h[m].length;v++){const w=Ef(h[m][v],c);Go(n,w),b.push(w)}d.push(b)}return d}function mu(h,n,c){const d=[];for(let m=0;m<h.length;m++){const b=Ac(h[m],n,c);d.push(b)}return d}function _u(h,n,c,d){if(h[0]<c[0]||h[0]>c[2]){const m=.5*d;let b=h[0]-c[0]>m?-d:c[0]-h[0]>m?d:0;b===0&&(b=h[0]-c[2]>m?-d:c[2]-h[0]>m?d:0),h[0]+=b}Go(n,h)}function Ec(h,n,c,d){const m=Math.pow(2,d.z)*Mn,b=[d.x*Mn,d.y*Mn],v=[];for(const w of h)for(const A of w){const P=[A.x+b[0],A.y+b[1]];_u(P,n,c,m),v.push(P)}return v}function Ic(h,n,c,d){const m=Math.pow(2,d.z)*Mn,b=[d.x*Mn,d.y*Mn],v=[];for(const A of h){const P=[];for(const R of A){const D=[R.x+b[0],R.y+b[1]];Go(n,D),P.push(D)}v.push(P)}if(n[2]-n[0]<=m/2){(w=n)[0]=w[1]=1/0,w[2]=w[3]=-1/0;for(const A of v)for(const P of A)_u(P,n,c,m)}var w;return v}class ks{constructor(n,c){this.type=Vt,this.geojson=n,this.geometries=c}static parse(n,c){if(n.length!==2)return c.error(`'within' expression requires exactly one argument, but found ${n.length-1} instead.`);if(Ms(n[1])){const d=n[1];if(d.type==="FeatureCollection"){const m=[];for(const b of d.features){const{type:v,coordinates:w}=b.geometry;v==="Polygon"&&m.push(w),v==="MultiPolygon"&&m.push(...w)}if(m.length)return new ks(d,{type:"MultiPolygon",coordinates:m})}else if(d.type==="Feature"){const m=d.geometry.type;if(m==="Polygon"||m==="MultiPolygon")return new ks(d,d.geometry)}else if(d.type==="Polygon"||d.type==="MultiPolygon")return new ks(d,d)}return c.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(n){if(n.geometry()!=null&&n.canonicalID()!=null){if(n.geometryType()==="Point")return function(c,d){const m=[1/0,1/0,-1/0,-1/0],b=[1/0,1/0,-1/0,-1/0],v=c.canonicalID();if(d.type==="Polygon"){const w=Ac(d.coordinates,b,v),A=Ec(c.geometry(),m,b,v);if(!Ko(m,b))return!1;for(const P of A)if(!to(P,w))return!1}if(d.type==="MultiPolygon"){const w=mu(d.coordinates,b,v),A=Ec(c.geometry(),m,b,v);if(!Ko(m,b))return!1;for(const P of A)if(!If(P,w))return!1}return!0}(n,this.geometries);if(n.geometryType()==="LineString")return function(c,d){const m=[1/0,1/0,-1/0,-1/0],b=[1/0,1/0,-1/0,-1/0],v=c.canonicalID();if(d.type==="Polygon"){const w=Ac(d.coordinates,b,v),A=Ic(c.geometry(),m,b,v);if(!Ko(m,b))return!1;for(const P of A)if(!gu(P,w))return!1}if(d.type==="MultiPolygon"){const w=mu(d.coordinates,b,v),A=Ic(c.geometry(),m,b,v);if(!Ko(m,b))return!1;for(const P of A)if(!Cf(P,w))return!1}return!0}(n,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let yu=class{constructor(h=[],n=(c,d)=>c<d?-1:c>d?1:0){if(this.data=h,this.length=this.data.length,this.compare=n,this.length>0)for(let c=(this.length>>1)-1;c>=0;c--)this._down(c)}push(h){this.data.push(h),this._up(this.length++)}pop(){if(this.length===0)return;const h=this.data[0],n=this.data.pop();return--this.length>0&&(this.data[0]=n,this._down(0)),h}peek(){return this.data[0]}_up(h){const{data:n,compare:c}=this,d=n[h];for(;h>0;){const m=h-1>>1,b=n[m];if(c(d,b)>=0)break;n[h]=b,h=m}n[h]=d}_down(h){const{data:n,compare:c}=this,d=this.length>>1,m=n[h];for(;h<d;){let b=1+(h<<1);const v=b+1;if(v<this.length&&c(n[v],n[b])<0&&(b=v),c(n[b],m)>=0)break;n[h]=n[b],h=b}n[h]=m}};function Cc(h,n,c=0,d=h.length-1,m=Pf){for(;d>c;){if(d-c>600){const A=d-c+1,P=n-c+1,R=Math.log(A),D=.5*Math.exp(2*R/3),L=.5*Math.sqrt(R*D*(A-D)/A)*(P-A/2<0?-1:1);Cc(h,n,Math.max(c,Math.floor(n-P*D/A+L)),Math.min(d,Math.floor(n+(A-P)*D/A+L)),m)}const b=h[n];let v=c,w=d;for(ro(h,c,n),m(h[d],b)>0&&ro(h,c,d);v<w;){for(ro(h,v,w),v++,w--;m(h[v],b)<0;)v++;for(;m(h[w],b)>0;)w--}m(h[c],b)===0?ro(h,c,w):(w++,ro(h,w,d)),w<=n&&(c=w+1),n<=w&&(d=w-1)}}function ro(h,n,c){const d=h[n];h[n]=h[c],h[c]=d}function Pf(h,n){return h<n?-1:h>n?1:0}function tl(h,n){if(h.length<=1)return[h];const c=[];let d,m;for(const b of h){const v=bu(b);v!==0&&(b.area=Math.abs(v),m===void 0&&(m=v<0),m===v<0?(d&&c.push(d),d=[b]):d.push(b))}if(d&&c.push(d),n>1)for(let b=0;b<c.length;b++)c[b].length<=n||(Cc(c[b],n,1,c[b].length-1,Mf),c[b]=c[b].slice(0,n));return c}function Mf(h,n){return n.area-h.area}function bu(h){let n=0;for(let c,d,m=0,b=h.length,v=b-1;m<b;v=m++)c=h[m],d=h[v],n+=(d.x-c.x)*(c.y+d.y);return n}const vu=1/298.257223563,xu=vu*(2-vu),wu=Math.PI/180;class Pc{constructor(n){const c=6378.137*wu*1e3,d=Math.cos(n*wu),m=1/(1-xu*(1-d*d)),b=Math.sqrt(m);this.kx=c*b*d,this.ky=c*b*m*(1-xu)}distance(n,c){const d=this.wrap(n[0]-c[0])*this.kx,m=(n[1]-c[1])*this.ky;return Math.sqrt(d*d+m*m)}pointOnLine(n,c){let d,m,b,v,w=1/0;for(let A=0;A<n.length-1;A++){let P=n[A][0],R=n[A][1],D=this.wrap(n[A+1][0]-P)*this.kx,L=(n[A+1][1]-R)*this.ky,U=0;D===0&&L===0||(U=(this.wrap(c[0]-P)*this.kx*D+(c[1]-R)*this.ky*L)/(D*D+L*L),U>1?(P=n[A+1][0],R=n[A+1][1]):U>0&&(P+=D/this.kx*U,R+=L/this.ky*U)),D=this.wrap(c[0]-P)*this.kx,L=(c[1]-R)*this.ky;const j=D*D+L*L;j<w&&(w=j,d=P,m=R,b=A,v=U)}return{point:[d,m],index:b,t:Math.max(0,Math.min(1,v))}}wrap(n){for(;n<-180;)n+=360;for(;n>180;)n-=360;return n}}function nr(h,n){return n[0]-h[0]}function rl(h){return h[1]-h[0]+1}function Hn(h,n){return h[1]>=h[0]&&h[1]<n}function Mc(h,n){if(h[0]>h[1])return[null,null];const c=rl(h);if(n){if(c===2)return[h,null];const m=Math.floor(c/2);return[[h[0],h[0]+m],[h[0]+m,h[1]]]}if(c===1)return[h,null];const d=Math.floor(c/2)-1;return[[h[0],h[0]+d],[h[0]+d+1,h[1]]]}function Rc(h,n){if(!Hn(n,h.length))return[1/0,1/0,-1/0,-1/0];const c=[1/0,1/0,-1/0,-1/0];for(let d=n[0];d<=n[1];++d)Go(c,h[d]);return c}function kc(h){const n=[1/0,1/0,-1/0,-1/0];for(const c of h)for(const d of c)Go(n,d);return n}function Tu(h){return h[0]!==-1/0&&h[1]!==-1/0&&h[2]!==1/0&&h[3]!==1/0}function Dc(h,n,c){if(!Tu(h)||!Tu(n))return NaN;let d=0,m=0;return h[2]<n[0]&&(d=n[0]-h[2]),h[0]>n[2]&&(d=h[0]-n[2]),h[1]>n[3]&&(m=h[1]-n[3]),h[3]<n[1]&&(m=n[1]-h[3]),c.distance([0,0],[d,m])}function Ds(h,n,c){const d=c.pointOnLine(n,h);return c.distance(h,d.point)}function Oc(h,n,c,d,m){const b=Math.min(Ds(h,[c,d],m),Ds(n,[c,d],m)),v=Math.min(Ds(c,[h,n],m),Ds(d,[h,n],m));return Math.min(b,v)}function Rf(h,n,c,d,m){if(!Hn(n,h.length)||!Hn(d,c.length))return 1/0;let b=1/0;for(let v=n[0];v<n[1];++v){const w=h[v],A=h[v+1];for(let P=d[0];P<d[1];++P){const R=c[P],D=c[P+1];if(Jo(w,A,R,D))return 0;b=Math.min(b,Oc(w,A,R,D,m))}}return b}function kf(h,n,c,d,m){if(!Hn(n,h.length)||!Hn(d,c.length))return NaN;let b=1/0;for(let v=n[0];v<=n[1];++v)for(let w=d[0];w<=d[1];++w)if(b=Math.min(b,m.distance(h[v],c[w])),b===0)return b;return b}function Df(h,n,c){if(to(h,n,!0))return 0;let d=1/0;for(const m of n){const b=m[0],v=m[m.length-1];if(b!==v&&(d=Math.min(d,Ds(h,[v,b],c)),d===0))return d;const w=c.pointOnLine(m,h);if(d=Math.min(d,c.distance(h,w.point)),d===0)return d}return d}function Of(h,n,c,d){if(!Hn(n,h.length))return NaN;for(let b=n[0];b<=n[1];++b)if(to(h[b],c,!0))return 0;let m=1/0;for(let b=n[0];b<n[1];++b){const v=h[b],w=h[b+1];for(const A of c)for(let P=0,R=A.length,D=R-1;P<R;D=P++){const L=A[D],U=A[P];if(Jo(v,w,L,U))return 0;m=Math.min(m,Oc(v,w,L,U,d))}}return m}function Su(h,n){for(const c of h)for(const d of c)if(to(d,n,!0))return!0;return!1}function Ff(h,n,c,d=1/0){const m=kc(h),b=kc(n);if(d!==1/0&&Dc(m,b,c)>=d)return d;if(Ko(m,b)){if(Su(h,n))return 0}else if(Su(n,h))return 0;let v=1/0;for(const w of h)for(let A=0,P=w.length,R=P-1;A<P;R=A++){const D=w[R],L=w[A];for(const U of n)for(let j=0,H=U.length,Y=H-1;j<H;Y=j++){const te=U[Y],ge=U[j];if(Jo(D,L,te,ge))return 0;v=Math.min(v,Oc(D,L,te,ge,c))}}return v}function Au(h,n,c,d,m,b){if(!b)return;const v=Dc(Rc(d,b),m,c);v<n&&h.push([v,b,[0,0]])}function il(h,n,c,d,m,b,v){if(!b||!v)return;const w=Dc(Rc(d,b),Rc(m,v),c);w<n&&h.push([w,b,v])}function nl(h,n,c,d,m=1/0){let b=Math.min(d.distance(h[0],c[0][0]),m);if(b===0)return b;const v=new yu([[0,[0,h.length-1],[0,0]]],nr),w=kc(c);for(;v.length>0;){const A=v.pop();if(A[0]>=b)continue;const P=A[1],R=n?50:100;if(rl(P)<=R){if(!Hn(P,h.length))return NaN;if(n){const D=Of(h,P,c,d);if(isNaN(D)||D===0)return D;b=Math.min(b,D)}else for(let D=P[0];D<=P[1];++D){const L=Df(h[D],c,d);if(b=Math.min(b,L),b===0)return 0}}else{const D=Mc(P,n);Au(v,b,d,h,w,D[0]),Au(v,b,d,h,w,D[1])}}return b}function sl(h,n,c,d,m,b=1/0){let v=Math.min(b,m.distance(h[0],c[0]));if(v===0)return v;const w=new yu([[0,[0,h.length-1],[0,c.length-1]]],nr);for(;w.length>0;){const A=w.pop();if(A[0]>=v)continue;const P=A[1],R=A[2],D=n?50:100,L=d?50:100;if(rl(P)<=D&&rl(R)<=L){if(!Hn(P,h.length)&&Hn(R,c.length))return NaN;let U;if(n&&d)U=Rf(h,P,c,R,m),v=Math.min(v,U);else if(n&&!d){const j=h.slice(P[0],P[1]+1);for(let H=R[0];H<=R[1];++H)if(U=Ds(c[H],j,m),v=Math.min(v,U),v===0)return v}else if(!n&&d){const j=c.slice(R[0],R[1]+1);for(let H=P[0];H<=P[1];++H)if(U=Ds(h[H],j,m),v=Math.min(v,U),v===0)return v}else U=kf(h,P,c,R,m),v=Math.min(v,U)}else{const U=Mc(P,n),j=Mc(R,d);il(w,v,m,h,c,U[0],j[0]),il(w,v,m,h,c,U[0],j[1]),il(w,v,m,h,c,U[1],j[0]),il(w,v,m,h,c,U[1],j[1])}}return v}function Fc(h){return h.type==="MultiPolygon"?h.coordinates.map(n=>({type:"Polygon",coordinates:n})):h.type==="MultiLineString"?h.coordinates.map(n=>({type:"LineString",coordinates:n})):h.type==="MultiPoint"?h.coordinates.map(n=>({type:"Point",coordinates:n})):[h]}class Os{constructor(n,c){this.type=st,this.geojson=n,this.geometries=c}static parse(n,c){if(n.length!==2)return c.error(`'distance' expression requires exactly one argument, but found ${n.length-1} instead.`);if(Ms(n[1])){const d=n[1];if(d.type==="FeatureCollection")return new Os(d,d.features.map(m=>Fc(m.geometry)).flat());if(d.type==="Feature")return new Os(d,Fc(d.geometry));if("type"in d&&"coordinates"in d)return new Os(d,Fc(d))}return c.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(n){if(n.geometry()!=null&&n.canonicalID()!=null){if(n.geometryType()==="Point")return function(c,d){const m=c.geometry(),b=m.flat().map(A=>Sc([A.x,A.y],c.canonical));if(m.length===0)return NaN;const v=new Pc(b[0][1]);let w=1/0;for(const A of d){switch(A.type){case"Point":w=Math.min(w,sl(b,!1,[A.coordinates],!1,v,w));break;case"LineString":w=Math.min(w,sl(b,!1,A.coordinates,!0,v,w));break;case"Polygon":w=Math.min(w,nl(b,!1,A.coordinates,v,w))}if(w===0)return w}return w}(n,this.geometries);if(n.geometryType()==="LineString")return function(c,d){const m=c.geometry(),b=m.flat().map(A=>Sc([A.x,A.y],c.canonical));if(m.length===0)return NaN;const v=new Pc(b[0][1]);let w=1/0;for(const A of d){switch(A.type){case"Point":w=Math.min(w,sl(b,!0,[A.coordinates],!1,v,w));break;case"LineString":w=Math.min(w,sl(b,!0,A.coordinates,!0,v,w));break;case"Polygon":w=Math.min(w,nl(b,!0,A.coordinates,v,w))}if(w===0)return w}return w}(n,this.geometries);if(n.geometryType()==="Polygon")return function(c,d){const m=c.geometry();if(m.length===0||m[0].length===0)return NaN;const b=tl(m,0).map(A=>A.map(P=>P.map(R=>Sc([R.x,R.y],c.canonical)))),v=new Pc(b[0][0][0][1]);let w=1/0;for(const A of d)for(const P of b){switch(A.type){case"Point":w=Math.min(w,nl([A.coordinates],!1,P,v,w));break;case"LineString":w=Math.min(w,nl(A.coordinates,!0,P,v,w));break;case"Polygon":w=Math.min(w,Ff(P,A.coordinates,v,w))}if(w===0)return w}return w}(n,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}class Qo{constructor(n){this.type=jt,this.key=n}static parse(n,c){if(n.length!==2)return c.error(`Expected 1 argument, but found ${n.length-1} instead.`);const d=n[1];return d==null?c.error("Global state property must be defined."):typeof d!="string"?c.error(`Global state property must be string, but found ${typeof n[1]} instead.`):new Qo(d)}evaluate(n){var c;const d=(c=n.globals)===null||c===void 0?void 0:c.globalState;return d&&Object.keys(d).length!==0?Zt(d,this.key):null}eachChild(){}outputDefined(){return!1}}const io={"==":wc,"!=":wf,">":Sf,"<":Tf,">=":Ga,"<=":Af,array:Zi,at:ci,boolean:Zi,case:Kr,coalesce:Xi,collator:Ka,format:Yo,image:Tc,in:Ys,"index-of":Ho,interpolate:Ui,"interpolate-hcl":Ui,"interpolate-lab":Ui,length:Qa,let:Wo,literal:zi,match:Gs,number:Zi,"number-format":Ja,object:Zi,slice:Zo,step:Js,string:Zi,"to-boolean":Pn,"to-color":Pn,"to-number":Pn,"to-string":Pn,var:pn,within:ks,distance:Os,"global-state":Qo};class un{constructor(n,c,d,m){this.name=n,this.type=c,this._evaluate=d,this.args=m}evaluate(n){return this._evaluate(n,this.args)}eachChild(n){this.args.forEach(n)}outputDefined(){return!1}static parse(n,c){const d=n[0],m=un.definitions[d];if(!m)return c.error(`Unknown expression "${d}". If you wanted a literal array, use ["literal", [...]].`,0);const b=Array.isArray(m)?m[0]:m.type,v=Array.isArray(m)?[[m[1],m[2]]]:m.overloads,w=v.filter(([P])=>!Array.isArray(P)||P.length===n.length-1);let A=null;for(const[P,R]of w){A=new $o(c.registry,ol,c.path,null,c.scope);const D=[];let L=!1;for(let U=1;U<n.length;U++){const j=n[U],H=Array.isArray(P)?P[U-1]:P.type,Y=A.parse(j,1+D.length,H);if(!Y){L=!0;break}D.push(Y)}if(!L)if(Array.isArray(P)&&P.length!==D.length)A.error(`Expected ${P.length} arguments, but found ${D.length} instead.`);else{for(let U=0;U<D.length;U++){const j=Array.isArray(P)?P[U]:P.type,H=D[U];A.concat(U+1).checkSubtype(j,H.type)}if(A.errors.length===0)return new un(d,b,R,D)}}if(w.length===1)c.errors.push(...A.errors);else{const P=(w.length?w:v).map(([D])=>{return L=D,Array.isArray(L)?`(${L.map(Or).join(", ")})`:`(${Or(L.type)}...)`;var L}).join(" | "),R=[];for(let D=1;D<n.length;D++){const L=c.parse(n[D],1+R.length);if(!L)return null;R.push(Or(L.type))}c.error(`Expected arguments of type ${P}, but found (${R.join(", ")}) instead.`)}return null}static register(n,c){un.definitions=c;for(const d in c)n[d]=un}}function Eu(h,[n,c,d,m]){n=n.evaluate(h),c=c.evaluate(h),d=d.evaluate(h);const b=m?m.evaluate(h):1,v=Lt(n,c,d,b);if(v)throw new Fr(v);return new Xt(n/255,c/255,d/255,b,!1)}function Iu(h,n){return h in n}function Bc(h,n){const c=n[h];return c===void 0?null:c}function Fs(h){return{type:h}}function ol(h){if(h instanceof pn)return ol(h.boundExpression);if(h instanceof un&&h.name==="error"||h instanceof Ka||h instanceof ks||h instanceof Os||h instanceof Qo)return!1;const n=h instanceof Pn||h instanceof Zi;let c=!0;return h.eachChild(d=>{c=n?c&&ol(d):c&&d instanceof zi}),!!c&&al(h)&&no(h,["zoom","heatmap-density","elevation","line-progress","accumulated","is-supported-script"])}function al(h){if(h instanceof un&&(h.name==="get"&&h.args.length===1||h.name==="feature-state"||h.name==="has"&&h.args.length===1||h.name==="properties"||h.name==="geometry-type"||h.name==="id"||/^filter-/.test(h.name))||h instanceof ks||h instanceof Os)return!1;let n=!0;return h.eachChild(c=>{n&&!al(c)&&(n=!1)}),n}function ea(h){if(h instanceof un&&h.name==="feature-state")return!1;let n=!0;return h.eachChild(c=>{n&&!ea(c)&&(n=!1)}),n}function no(h,n){if(h instanceof un&&n.indexOf(h.name)>=0)return!1;let c=!0;return h.eachChild(d=>{c&&!no(d,n)&&(c=!1)}),c}function Cu(h){return{result:"success",value:h}}function so(h){return{result:"error",value:h}}function oo(h){return h["property-type"]==="data-driven"||h["property-type"]==="cross-faded-data-driven"}function Lc(h){return!!h.expression&&h.expression.parameters.indexOf("zoom")>-1}function Nc(h){return!!h.expression&&h.expression.interpolated}function qt(h){return h instanceof Number?"number":h instanceof String?"string":h instanceof Boolean?"boolean":Array.isArray(h)?"array":h===null?"null":typeof h}function Bs(h){return typeof h=="object"&&h!==null&&!Array.isArray(h)&&Pt(h)===In}function Pu(h){return h}function Mu(h,n){const c=h.stops&&typeof h.stops[0][0]=="object",d=c||!(c||h.property!==void 0),m=h.type||(Nc(n)?"exponential":"interval"),b=function(R){switch(R.type){case"color":return Xt.parse;case"padding":return Gr.parse;case"numberArray":return Oi.parse;case"colorArray":return li.parse;default:return null}}(n);if(b&&((h=bi({},h)).stops&&(h.stops=h.stops.map(R=>[R[0],b(R[1])])),h.default=b(h.default?h.default:n.default)),h.colorSpace&&(v=h.colorSpace)!=="rgb"&&v!=="hcl"&&v!=="lab")throw new Error(`Unknown color space: "${h.colorSpace}"`);var v;const w=function(R){switch(R){case"exponential":return Ru;case"interval":return Lf;case"categorical":return Bf;case"identity":return ku;default:throw new Error(`Unknown function type "${R}"`)}}(m);let A,P;if(m==="categorical"){A=Object.create(null);for(const R of h.stops)A[R[0]]=R[1];P=typeof h.stops[0][0]}if(c){const R={},D=[];for(let j=0;j<h.stops.length;j++){const H=h.stops[j],Y=H[0].zoom;R[Y]===void 0&&(R[Y]={zoom:Y,type:h.type,property:h.property,default:h.default,stops:[]},D.push(Y)),R[Y].stops.push([H[0].value,H[1]])}const L=[];for(const j of D)L.push([R[j].zoom,Mu(R[j],n)]);const U={name:"linear"};return{kind:"composite",interpolationType:U,interpolationFactor:Ui.interpolationFactor.bind(void 0,U),zoomStops:L.map(j=>j[0]),evaluate:({zoom:j},H)=>Ru({stops:L,base:h.base},n,j).evaluate(j,H)}}if(d){const R=m==="exponential"?{name:"exponential",base:h.base!==void 0?h.base:1}:null;return{kind:"camera",interpolationType:R,interpolationFactor:Ui.interpolationFactor.bind(void 0,R),zoomStops:h.stops.map(D=>D[0]),evaluate:({zoom:D})=>w(h,n,D,A,P)}}return{kind:"source",evaluate(R,D){const L=D&&D.properties?D.properties[h.property]:void 0;return L===void 0?ta(h.default,n.default):w(h,n,L,A,P)}}}function ta(h,n,c){return h!==void 0?h:n!==void 0?n:c!==void 0?c:void 0}function Bf(h,n,c,d,m){return ta(typeof c===m?d[c]:void 0,h.default,n.default)}function Lf(h,n,c){if(qt(c)!=="number")return ta(h.default,n.default);const d=h.stops.length;if(d===1||c<=h.stops[0][0])return h.stops[0][1];if(c>=h.stops[d-1][0])return h.stops[d-1][1];const m=Ks(h.stops.map(b=>b[0]),c);return h.stops[m][1]}function Ru(h,n,c){const d=h.base!==void 0?h.base:1;if(qt(c)!=="number")return ta(h.default,n.default);const m=h.stops.length;if(m===1||c<=h.stops[0][0])return h.stops[0][1];if(c>=h.stops[m-1][0])return h.stops[m-1][1];const b=Ks(h.stops.map(R=>R[0]),c),v=function(R,D,L,U){const j=U-L,H=R-L;return j===0?0:D===1?H/j:(Math.pow(D,H)-1)/(Math.pow(D,j)-1)}(c,d,h.stops[b][0],h.stops[b+1][0]),w=h.stops[b][1],A=h.stops[b+1][1],P=nn[n.type]||Pu;return typeof w.evaluate=="function"?{evaluate(...R){const D=w.evaluate.apply(void 0,R),L=A.evaluate.apply(void 0,R);if(D!==void 0&&L!==void 0)return P(D,L,v,h.colorSpace)}}:P(w,A,v,h.colorSpace)}function ku(h,n,c){switch(n.type){case"color":c=Xt.parse(c);break;case"formatted":c=Di.fromString(c.toString());break;case"resolvedImage":c=Hi.fromString(c.toString());break;case"padding":c=Gr.parse(c);break;case"colorArray":c=li.parse(c);break;case"numberArray":c=Oi.parse(c);break;default:qt(c)===n.type||n.type==="enum"&&n.values[c]||(c=void 0)}return ta(c,h.default,n.default)}un.register(io,{error:[{kind:"error"},[Ut],(h,[n])=>{throw new Fr(n.evaluate(h))}],typeof:[Ut,[jt],(h,[n])=>Or(Pt(n.evaluate(h)))],"to-rgba":[rn(st,4),[tn],(h,[n])=>{const[c,d,m,b]=n.evaluate(h).rgb;return[255*c,255*d,255*m,b]}],rgb:[tn,[st,st,st],Eu],rgba:[tn,[st,st,st,st],Eu],has:{type:Vt,overloads:[[[Ut],(h,[n])=>Iu(n.evaluate(h),h.properties())],[[Ut,In],(h,[n,c])=>Iu(n.evaluate(h),c.evaluate(h))]]},get:{type:jt,overloads:[[[Ut],(h,[n])=>Bc(n.evaluate(h),h.properties())],[[Ut,In],(h,[n,c])=>Bc(n.evaluate(h),c.evaluate(h))]]},"feature-state":[jt,[Ut],(h,[n])=>Bc(n.evaluate(h),h.featureState||{})],properties:[In,[],h=>h.properties()],"geometry-type":[Ut,[],h=>h.geometryType()],id:[jt,[],h=>h.id()],zoom:[st,[],h=>h.globals.zoom],"heatmap-density":[st,[],h=>h.globals.heatmapDensity||0],elevation:[st,[],h=>h.globals.elevation||0],"line-progress":[st,[],h=>h.globals.lineProgress||0],accumulated:[jt,[],h=>h.globals.accumulated===void 0?null:h.globals.accumulated],"+":[st,Fs(st),(h,n)=>{let c=0;for(const d of n)c+=d.evaluate(h);return c}],"*":[st,Fs(st),(h,n)=>{let c=1;for(const d of n)c*=d.evaluate(h);return c}],"-":{type:st,overloads:[[[st,st],(h,[n,c])=>n.evaluate(h)-c.evaluate(h)],[[st],(h,[n])=>-n.evaluate(h)]]},"/":[st,[st,st],(h,[n,c])=>n.evaluate(h)/c.evaluate(h)],"%":[st,[st,st],(h,[n,c])=>n.evaluate(h)%c.evaluate(h)],ln2:[st,[],()=>Math.LN2],pi:[st,[],()=>Math.PI],e:[st,[],()=>Math.E],"^":[st,[st,st],(h,[n,c])=>Math.pow(n.evaluate(h),c.evaluate(h))],sqrt:[st,[st],(h,[n])=>Math.sqrt(n.evaluate(h))],log10:[st,[st],(h,[n])=>Math.log(n.evaluate(h))/Math.LN10],ln:[st,[st],(h,[n])=>Math.log(n.evaluate(h))],log2:[st,[st],(h,[n])=>Math.log(n.evaluate(h))/Math.LN2],sin:[st,[st],(h,[n])=>Math.sin(n.evaluate(h))],cos:[st,[st],(h,[n])=>Math.cos(n.evaluate(h))],tan:[st,[st],(h,[n])=>Math.tan(n.evaluate(h))],asin:[st,[st],(h,[n])=>Math.asin(n.evaluate(h))],acos:[st,[st],(h,[n])=>Math.acos(n.evaluate(h))],atan:[st,[st],(h,[n])=>Math.atan(n.evaluate(h))],min:[st,Fs(st),(h,n)=>Math.min(...n.map(c=>c.evaluate(h)))],max:[st,Fs(st),(h,n)=>Math.max(...n.map(c=>c.evaluate(h)))],abs:[st,[st],(h,[n])=>Math.abs(n.evaluate(h))],round:[st,[st],(h,[n])=>{const c=n.evaluate(h);return c<0?-Math.round(-c):Math.round(c)}],floor:[st,[st],(h,[n])=>Math.floor(n.evaluate(h))],ceil:[st,[st],(h,[n])=>Math.ceil(n.evaluate(h))],"filter-==":[Vt,[Ut,jt],(h,[n,c])=>h.properties()[n.value]===c.value],"filter-id-==":[Vt,[jt],(h,[n])=>h.id()===n.value],"filter-type-==":[Vt,[Ut],(h,[n])=>h.geometryType()===n.value],"filter-<":[Vt,[Ut,jt],(h,[n,c])=>{const d=h.properties()[n.value],m=c.value;return typeof d==typeof m&&d<m}],"filter-id-<":[Vt,[jt],(h,[n])=>{const c=h.id(),d=n.value;return typeof c==typeof d&&c<d}],"filter->":[Vt,[Ut,jt],(h,[n,c])=>{const d=h.properties()[n.value],m=c.value;return typeof d==typeof m&&d>m}],"filter-id->":[Vt,[jt],(h,[n])=>{const c=h.id(),d=n.value;return typeof c==typeof d&&c>d}],"filter-<=":[Vt,[Ut,jt],(h,[n,c])=>{const d=h.properties()[n.value],m=c.value;return typeof d==typeof m&&d<=m}],"filter-id-<=":[Vt,[jt],(h,[n])=>{const c=h.id(),d=n.value;return typeof c==typeof d&&c<=d}],"filter->=":[Vt,[Ut,jt],(h,[n,c])=>{const d=h.properties()[n.value],m=c.value;return typeof d==typeof m&&d>=m}],"filter-id->=":[Vt,[jt],(h,[n])=>{const c=h.id(),d=n.value;return typeof c==typeof d&&c>=d}],"filter-has":[Vt,[jt],(h,[n])=>n.value in h.properties()],"filter-has-id":[Vt,[],h=>h.id()!==null&&h.id()!==void 0],"filter-type-in":[Vt,[rn(Ut)],(h,[n])=>n.value.indexOf(h.geometryType())>=0],"filter-id-in":[Vt,[rn(jt)],(h,[n])=>n.value.indexOf(h.id())>=0],"filter-in-small":[Vt,[Ut,rn(jt)],(h,[n,c])=>c.value.indexOf(h.properties()[n.value])>=0],"filter-in-large":[Vt,[Ut,rn(jt)],(h,[n,c])=>function(d,m,b,v){for(;b<=v;){const w=b+v>>1;if(m[w]===d)return!0;m[w]>d?v=w-1:b=w+1}return!1}(h.properties()[n.value],c.value,0,c.value.length-1)],all:{type:Vt,overloads:[[[Vt,Vt],(h,[n,c])=>n.evaluate(h)&&c.evaluate(h)],[Fs(Vt),(h,n)=>{for(const c of n)if(!c.evaluate(h))return!1;return!0}]]},any:{type:Vt,overloads:[[[Vt,Vt],(h,[n,c])=>n.evaluate(h)||c.evaluate(h)],[Fs(Vt),(h,n)=>{for(const c of n)if(c.evaluate(h))return!0;return!1}]]},"!":[Vt,[Vt],(h,[n])=>!n.evaluate(h)],"is-supported-script":[Vt,[Ut],(h,[n])=>{const c=h.globals&&h.globals.isSupportedScript;return!c||c(n.evaluate(h))}],upcase:[Ut,[Ut],(h,[n])=>n.evaluate(h).toUpperCase()],downcase:[Ut,[Ut],(h,[n])=>n.evaluate(h).toLowerCase()],concat:[Ut,Fs(jt),(h,n)=>n.map(c=>Rs(c.evaluate(h))).join("")],"resolved-locale":[Ut,[Un],(h,[n])=>n.evaluate(h).resolvedLocale()]});class ll{constructor(n,c){this.expression=n,this._warningHistory={},this._evaluator=new du,this._defaultValue=c?function(d){if(d.type==="color"&&Bs(d.default))return new Xt(0,0,0,0);switch(d.type){case"color":return Xt.parse(d.default)||null;case"padding":return Gr.parse(d.default)||null;case"numberArray":return Oi.parse(d.default)||null;case"colorArray":return li.parse(d.default)||null;case"variableAnchorOffsetCollection":return tr.parse(d.default)||null;case"projectionDefinition":return Ft.parse(d.default)||null;default:return d.default===void 0?null:d.default}}(c):null,this._enumValues=c&&c.type==="enum"?c.values:null}evaluateWithoutErrorHandling(n,c,d,m,b,v){return this._evaluator.globals=n,this._evaluator.feature=c,this._evaluator.featureState=d,this._evaluator.canonical=m,this._evaluator.availableImages=b||null,this._evaluator.formattedSection=v,this.expression.evaluate(this._evaluator)}evaluate(n,c,d,m,b,v){this._evaluator.globals=n,this._evaluator.feature=c||null,this._evaluator.featureState=d||null,this._evaluator.canonical=m,this._evaluator.availableImages=b||null,this._evaluator.formattedSection=v||null;try{const w=this.expression.evaluate(this._evaluator);if(w==null||typeof w=="number"&&w!=w)return this._defaultValue;if(this._enumValues&&!(w in this._enumValues))throw new Fr(`Expected value to be one of ${Object.keys(this._enumValues).map(A=>JSON.stringify(A)).join(", ")}, but found ${JSON.stringify(w)} instead.`);return w}catch(w){return this._warningHistory[w.message]||(this._warningHistory[w.message]=!0,typeof console<"u"&&console.warn(w.message)),this._defaultValue}}}function cl(h){return Array.isArray(h)&&h.length>0&&typeof h[0]=="string"&&h[0]in io}function hl(h,n){const c=new $o(io,ol,[],n?function(m){const b={color:tn,string:Ut,number:st,enum:Ut,boolean:Vt,formatted:Is,padding:Xr,numberArray:No,colorArray:Lo,projectionDefinition:Wa,resolvedImage:Vn,variableAnchorOffsetCollection:zo};return m.type==="array"?rn(b[m.value]||jt,m.length):b[m.type]}(n):void 0),d=c.parse(h,void 0,void 0,void 0,n&&n.type==="string"?{typeAnnotation:"coerce"}:void 0);return d?Cu(new ll(d,n)):so(c.errors)}class ra{constructor(n,c){this.kind=n,this._styleExpression=c,this.isStateDependent=n!=="constant"&&!ea(c.expression),this.globalStateRefs=lo(c.expression)}evaluateWithoutErrorHandling(n,c,d,m,b,v){return this._styleExpression.evaluateWithoutErrorHandling(n,c,d,m,b,v)}evaluate(n,c,d,m,b,v){return this._styleExpression.evaluate(n,c,d,m,b,v)}}class ul{constructor(n,c,d,m){this.kind=n,this.zoomStops=d,this._styleExpression=c,this.isStateDependent=n!=="camera"&&!ea(c.expression),this.globalStateRefs=lo(c.expression),this.interpolationType=m}evaluateWithoutErrorHandling(n,c,d,m,b,v){return this._styleExpression.evaluateWithoutErrorHandling(n,c,d,m,b,v)}evaluate(n,c,d,m,b,v){return this._styleExpression.evaluate(n,c,d,m,b,v)}interpolationFactor(n,c,d){return this.interpolationType?Ui.interpolationFactor(this.interpolationType,n,c,d):0}}function zc(h,n){const c=hl(h,n);if(c.result==="error")return c;const d=c.value.expression,m=al(d);if(!m&&!oo(n))return so([new Dr("","data expressions not supported")]);const b=no(d,["zoom"]);if(!b&&!Lc(n))return so([new Dr("","zoom expressions not supported")]);const v=ao(d);return v||b?v instanceof Dr?so([v]):v instanceof Ui&&!Nc(n)?so([new Dr("",'"interpolate" expressions cannot be used with this property')]):Cu(v?new ul(m?"camera":"composite",c.value,v.labels,v instanceof Ui?v.interpolation:void 0):new ra(m?"constant":"source",c.value)):so([new Dr("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class ia{constructor(n,c){this._parameters=n,this._specification=c,bi(this,Mu(this._parameters,this._specification))}static deserialize(n){return new ia(n._parameters,n._specification)}static serialize(n){return{_parameters:n._parameters,_specification:n._specification}}}function ao(h){let n=null;if(h instanceof Wo)n=ao(h.result);else if(h instanceof Xi){for(const c of h.args)if(n=ao(c),n)break}else(h instanceof Js||h instanceof Ui)&&h.input instanceof un&&h.input.name==="zoom"&&(n=h);return n instanceof Dr||h.eachChild(c=>{const d=ao(c);d instanceof Dr?n=d:!n&&d?n=new Dr("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):n&&d&&n!==d&&(n=new Dr("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),n}function lo(h,n=new Set){return h instanceof Qo&&n.add(h.key),h.eachChild(c=>{lo(c,n)}),n}function na(h){if(h===!0||h===!1)return!0;if(!Array.isArray(h)||h.length===0)return!1;switch(h[0]){case"has":return h.length>=2&&h[1]!=="$id"&&h[1]!=="$type";case"in":return h.length>=3&&(typeof h[1]!="string"||Array.isArray(h[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return h.length!==3||Array.isArray(h[1])||Array.isArray(h[2]);case"any":case"all":for(const n of h.slice(1))if(!na(n)&&typeof n!="boolean")return!1;return!0;default:return!0}}const Uc={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function as(h){if(h==null)return{filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set};na(h)||(h=dl(h));const n=hl(h,Uc);if(n.result==="error")throw new Error(n.value.map(c=>`${c.key}: ${c.message}`).join(", "));return{filter:(c,d,m)=>n.value.evaluate(c,d,{},m),needGeometry:Du(h),getGlobalStateRefs:()=>lo(n.value.expression)}}function Nf(h,n){return h<n?-1:h>n?1:0}function Du(h){if(!Array.isArray(h))return!1;if(h[0]==="within"||h[0]==="distance")return!0;for(let n=1;n<h.length;n++)if(Du(h[n]))return!0;return!1}function dl(h){if(!h)return!0;const n=h[0];return h.length<=1?n!=="any":n==="=="?Vc(h[1],h[2],"=="):n==="!="?sa(Vc(h[1],h[2],"==")):n==="<"||n===">"||n==="<="||n===">="?Vc(h[1],h[2],n):n==="any"?(c=h.slice(1),["any"].concat(c.map(dl))):n==="all"?["all"].concat(h.slice(1).map(dl)):n==="none"?["all"].concat(h.slice(1).map(dl).map(sa)):n==="in"?Ou(h[1],h.slice(2)):n==="!in"?sa(Ou(h[1],h.slice(2))):n==="has"?Fu(h[1]):n!=="!has"||sa(Fu(h[1]));var c}function Vc(h,n,c){switch(h){case"$type":return[`filter-type-${c}`,n];case"$id":return[`filter-id-${c}`,n];default:return[`filter-${c}`,h,n]}}function Ou(h,n){if(n.length===0)return!1;switch(h){case"$type":return["filter-type-in",["literal",n]];case"$id":return["filter-id-in",["literal",n]];default:return n.length>200&&!n.some(c=>typeof c!=typeof n[0])?["filter-in-large",h,["literal",n.sort(Nf)]]:["filter-in-small",h,["literal",n]]}}function Fu(h){switch(h){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",h]}}function sa(h){return["!",h]}function fl(h){const n=typeof h;if(n==="number"||n==="boolean"||n==="string"||h==null)return JSON.stringify(h);if(Array.isArray(h)){let m="[";for(const b of h)m+=`${fl(b)},`;return`${m}]`}const c=Object.keys(h).sort();let d="{";for(let m=0;m<c.length;m++)d+=`${JSON.stringify(c[m])}:${fl(h[c[m]])},`;return`${d}}`}function pl(h){let n="";for(const c of lt)n+=`/${fl(h[c])}`;return n}function Bu(h){const n=h.value;return n?[new rt(h.key,n,"constants have been deprecated as of v8")]:[]}function jr(h){return h instanceof Number||h instanceof String||h instanceof Boolean?h.valueOf():h}function ls(h){if(Array.isArray(h))return h.map(ls);if(h instanceof Object&&!(h instanceof Number||h instanceof String||h instanceof Boolean)){const n={};for(const c in h)n[c]=ls(h[c]);return n}return jr(h)}function dn(h){const n=h.key,c=h.value,d=h.valueSpec||{},m=h.objectElementValidators||{},b=h.style,v=h.styleSpec,w=h.validateSpec;let A=[];const P=qt(c);if(P!=="object")return[new rt(n,c,`object expected, ${P} found`)];for(const R in c){const D=R.split(".")[0],L=Zt(d,D)||d["*"];let U;if(Zt(m,D))U=m[D];else if(Zt(d,D))U=w;else if(m["*"])U=m["*"];else{if(!d["*"]){A.push(new rt(n,c[R],`unknown property "${R}"`));continue}U=w}A=A.concat(U({key:(n&&`${n}.`)+R,value:c[R],valueSpec:L,style:b,styleSpec:v,object:c,objectKey:R,validateSpec:w},c))}for(const R in d)m[R]||d[R].required&&d[R].default===void 0&&c[R]===void 0&&A.push(new rt(n,c,`missing required property "${R}"`));return A}function gl(h){const n=h.value,c=h.valueSpec,d=h.style,m=h.styleSpec,b=h.key,v=h.arrayElementValidator||h.validateSpec;if(qt(n)!=="array")return[new rt(b,n,`array expected, ${qt(n)} found`)];if(c.length&&n.length!==c.length)return[new rt(b,n,`array length ${c.length} expected, length ${n.length} found`)];if(c["min-length"]&&n.length<c["min-length"])return[new rt(b,n,`array length at least ${c["min-length"]} expected, length ${n.length} found`)];let w={type:c.value,values:c.values};m.$version<7&&(w.function=c.function),qt(c.value)==="object"&&(w=c.value);let A=[];for(let P=0;P<n.length;P++)A=A.concat(v({array:n,arrayIndex:P,value:n[P],valueSpec:w,validateSpec:h.validateSpec,style:d,styleSpec:m,key:`${b}[${P}]`}));return A}function oa(h){const n=h.key,c=h.value,d=h.valueSpec;let m=qt(c);return m==="number"&&c!=c&&(m="NaN"),m!=="number"?[new rt(n,c,`number expected, ${m} found`)]:"minimum"in d&&c<d.minimum?[new rt(n,c,`${c} is less than the minimum value ${d.minimum}`)]:"maximum"in d&&c>d.maximum?[new rt(n,c,`${c} is greater than the maximum value ${d.maximum}`)]:[]}function co(h){const n=h.valueSpec,c=jr(h.value.type);let d,m,b,v={};const w=c!=="categorical"&&h.value.property===void 0,A=!w,P=qt(h.value.stops)==="array"&&qt(h.value.stops[0])==="array"&&qt(h.value.stops[0][0])==="object",R=dn({key:h.key,value:h.value,valueSpec:h.styleSpec.function,validateSpec:h.validateSpec,style:h.style,styleSpec:h.styleSpec,objectElementValidators:{stops:function(U){if(c==="identity")return[new rt(U.key,U.value,'identity function may not have a "stops" property')];let j=[];const H=U.value;return j=j.concat(gl({key:U.key,value:H,valueSpec:U.valueSpec,validateSpec:U.validateSpec,style:U.style,styleSpec:U.styleSpec,arrayElementValidator:D})),qt(H)==="array"&&H.length===0&&j.push(new rt(U.key,H,"array must have at least one stop")),j},default:function(U){return U.validateSpec({key:U.key,value:U.value,valueSpec:n,validateSpec:U.validateSpec,style:U.style,styleSpec:U.styleSpec})}}});return c==="identity"&&w&&R.push(new rt(h.key,h.value,'missing required property "property"')),c==="identity"||h.value.stops||R.push(new rt(h.key,h.value,'missing required property "stops"')),c==="exponential"&&h.valueSpec.expression&&!Nc(h.valueSpec)&&R.push(new rt(h.key,h.value,"exponential functions not supported")),h.styleSpec.$version>=8&&(A&&!oo(h.valueSpec)?R.push(new rt(h.key,h.value,"property functions not supported")):w&&!Lc(h.valueSpec)&&R.push(new rt(h.key,h.value,"zoom functions not supported"))),c!=="categorical"&&!P||h.value.property!==void 0||R.push(new rt(h.key,h.value,'"property" property is required')),R;function D(U){let j=[];const H=U.value,Y=U.key;if(qt(H)!=="array")return[new rt(Y,H,`array expected, ${qt(H)} found`)];if(H.length!==2)return[new rt(Y,H,`array length 2 expected, length ${H.length} found`)];if(P){if(qt(H[0])!=="object")return[new rt(Y,H,`object expected, ${qt(H[0])} found`)];if(H[0].zoom===void 0)return[new rt(Y,H,"object stop key must have zoom")];if(H[0].value===void 0)return[new rt(Y,H,"object stop key must have value")];if(b&&b>jr(H[0].zoom))return[new rt(Y,H[0].zoom,"stop zoom values must appear in ascending order")];jr(H[0].zoom)!==b&&(b=jr(H[0].zoom),m=void 0,v={}),j=j.concat(dn({key:`${Y}[0]`,value:H[0],valueSpec:{zoom:{}},validateSpec:U.validateSpec,style:U.style,styleSpec:U.styleSpec,objectElementValidators:{zoom:oa,value:L}}))}else j=j.concat(L({key:`${Y}[0]`,value:H[0],validateSpec:U.validateSpec,style:U.style,styleSpec:U.styleSpec},H));return cl(ls(H[1]))?j.concat([new rt(`${Y}[1]`,H[1],"expressions are not allowed in function stops.")]):j.concat(U.validateSpec({key:`${Y}[1]`,value:H[1],valueSpec:n,validateSpec:U.validateSpec,style:U.style,styleSpec:U.styleSpec}))}function L(U,j){const H=qt(U.value),Y=jr(U.value),te=U.value!==null?U.value:j;if(d){if(H!==d)return[new rt(U.key,te,`${H} stop domain type must match previous stop domain type ${d}`)]}else d=H;if(H!=="number"&&H!=="string"&&H!=="boolean")return[new rt(U.key,te,"stop domain value must be a number, string, or boolean")];if(H!=="number"&&c!=="categorical"){let ge=`number expected, ${H} found`;return oo(n)&&c===void 0&&(ge+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new rt(U.key,te,ge)]}return c!=="categorical"||H!=="number"||isFinite(Y)&&Math.floor(Y)===Y?c!=="categorical"&&H==="number"&&m!==void 0&&Y<m?[new rt(U.key,te,"stop domain values must appear in ascending order")]:(m=Y,c==="categorical"&&Y in v?[new rt(U.key,te,"stop domain values must be unique")]:(v[Y]=!0,[])):[new rt(U.key,te,`integer expected, found ${Y}`)]}}function ho(h){const n=(h.expressionContext==="property"?zc:hl)(ls(h.value),h.valueSpec);if(n.result==="error")return n.value.map(d=>new rt(`${h.key}${d.key}`,h.value,d.message));const c=n.value.expression||n.value._styleExpression.expression;if(h.expressionContext==="property"&&h.propertyKey==="text-font"&&!c.outputDefined())return[new rt(h.key,h.value,`Invalid data expression for "${h.propertyKey}". Output values must be contained as literals within the expression.`)];if(h.expressionContext==="property"&&h.propertyType==="layout"&&!ea(c))return[new rt(h.key,h.value,'"feature-state" data expressions are not supported with layout properties.')];if(h.expressionContext==="filter"&&!ea(c))return[new rt(h.key,h.value,'"feature-state" data expressions are not supported with filters.')];if(h.expressionContext&&h.expressionContext.indexOf("cluster")===0){if(!no(c,["zoom","feature-state"]))return[new rt(h.key,h.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(h.expressionContext==="cluster-initial"&&!al(c))return[new rt(h.key,h.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function jc(h){const n=h.key,c=h.value,d=qt(c);return d!=="string"?[new rt(n,c,`color expected, ${d} found`)]:Xt.parse(String(c))?[]:[new rt(n,c,`color expected, "${c}" found`)]}function aa(h){const n=h.key,c=h.value,d=h.valueSpec,m=[];return Array.isArray(d.values)?d.values.indexOf(jr(c))===-1&&m.push(new rt(n,c,`expected one of [${d.values.join(", ")}], ${JSON.stringify(c)} found`)):Object.keys(d.values).indexOf(jr(c))===-1&&m.push(new rt(n,c,`expected one of [${Object.keys(d.values).join(", ")}], ${JSON.stringify(c)} found`)),m}function $c(h){return na(ls(h.value))?ho(bi({},h,{expressionContext:"filter",valueSpec:{value:"boolean"}})):Lu(h)}function Lu(h){const n=h.value,c=h.key;if(qt(n)!=="array")return[new rt(c,n,`array expected, ${qt(n)} found`)];const d=h.styleSpec;let m,b=[];if(n.length<1)return[new rt(c,n,"filter array must have at least 1 element")];switch(b=b.concat(aa({key:`${c}[0]`,value:n[0],valueSpec:d.filter_operator,style:h.style,styleSpec:h.styleSpec})),jr(n[0])){case"<":case"<=":case">":case">=":n.length>=2&&jr(n[1])==="$type"&&b.push(new rt(c,n,`"$type" cannot be use with operator "${n[0]}"`));case"==":case"!=":n.length!==3&&b.push(new rt(c,n,`filter array for operator "${n[0]}" must have 3 elements`));case"in":case"!in":n.length>=2&&(m=qt(n[1]),m!=="string"&&b.push(new rt(`${c}[1]`,n[1],`string expected, ${m} found`)));for(let v=2;v<n.length;v++)m=qt(n[v]),jr(n[1])==="$type"?b=b.concat(aa({key:`${c}[${v}]`,value:n[v],valueSpec:d.geometry_type,style:h.style,styleSpec:h.styleSpec})):m!=="string"&&m!=="number"&&m!=="boolean"&&b.push(new rt(`${c}[${v}]`,n[v],`string, number, or boolean expected, ${m} found`));break;case"any":case"all":case"none":for(let v=1;v<n.length;v++)b=b.concat(Lu({key:`${c}[${v}]`,value:n[v],style:h.style,styleSpec:h.styleSpec}));break;case"has":case"!has":m=qt(n[1]),n.length!==2?b.push(new rt(c,n,`filter array for "${n[0]}" operator must have 2 elements`)):m!=="string"&&b.push(new rt(`${c}[1]`,n[1],`string expected, ${m} found`))}return b}function Nu(h,n){const c=h.key,d=h.validateSpec,m=h.style,b=h.styleSpec,v=h.value,w=h.objectKey,A=b[`${n}_${h.layerType}`];if(!A)return[];const P=w.match(/^(.*)-transition$/);if(n==="paint"&&P&&A[P[1]]&&A[P[1]].transition)return d({key:c,value:v,valueSpec:b.transition,style:m,styleSpec:b});const R=h.valueSpec||A[w];if(!R)return[new rt(c,v,`unknown property "${w}"`)];let D;if(qt(v)==="string"&&oo(R)&&!R.tokens&&(D=/^{([^}]+)}$/.exec(v)))return[new rt(c,v,`"${w}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(D[1])} }\`.`)];const L=[];return h.layerType==="symbol"&&(w==="text-field"&&m&&!m.glyphs&&L.push(new rt(c,v,'use of "text-field" requires a style "glyphs" property')),w==="text-font"&&Bs(ls(v))&&jr(v.type)==="identity"&&L.push(new rt(c,v,'"text-font" does not support identity functions'))),L.concat(d({key:h.key,value:v,valueSpec:R,style:m,styleSpec:b,expressionContext:"property",propertyType:n,propertyKey:w}))}function uo(h){return Nu(h,"paint")}function fo(h){return Nu(h,"layout")}function qi(h){let n=[];const c=h.value,d=h.key,m=h.style,b=h.styleSpec;if(qt(c)!=="object")return[new rt(d,c,`object expected, ${qt(c)} found`)];c.type||c.ref||n.push(new rt(d,c,'either "type" or "ref" is required'));let v=jr(c.type);const w=jr(c.ref);if(c.id){const A=jr(c.id);for(let P=0;P<h.arrayIndex;P++){const R=m.layers[P];jr(R.id)===A&&n.push(new rt(d,c.id,`duplicate layer id "${c.id}", previously used at line ${R.id.__line__}`))}}if("ref"in c){let A;["type","source","source-layer","filter","layout"].forEach(P=>{P in c&&n.push(new rt(d,c[P],`"${P}" is prohibited for ref layers`))}),m.layers.forEach(P=>{jr(P.id)===w&&(A=P)}),A?A.ref?n.push(new rt(d,c.ref,"ref cannot reference another ref layer")):v=jr(A.type):n.push(new rt(d,c.ref,`ref layer "${w}" not found`))}else if(v!=="background")if(c.source){const A=m.sources&&m.sources[c.source],P=A&&jr(A.type);A?P==="vector"&&v==="raster"?n.push(new rt(d,c.source,`layer "${c.id}" requires a raster source`)):P!=="raster-dem"&&v==="hillshade"||P!=="raster-dem"&&v==="color-relief"?n.push(new rt(d,c.source,`layer "${c.id}" requires a raster-dem source`)):P==="raster"&&v!=="raster"?n.push(new rt(d,c.source,`layer "${c.id}" requires a vector source`)):P!=="vector"||c["source-layer"]?P==="raster-dem"&&v!=="hillshade"&&v!=="color-relief"?n.push(new rt(d,c.source,"raster-dem source can only be used with layer type 'hillshade' or 'color-relief'.")):v!=="line"||!c.paint||!c.paint["line-gradient"]||P==="geojson"&&A.lineMetrics||n.push(new rt(d,c,`layer "${c.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):n.push(new rt(d,c,`layer "${c.id}" must specify a "source-layer"`)):n.push(new rt(d,c.source,`source "${c.source}" not found`))}else n.push(new rt(d,c,'missing required property "source"'));return n=n.concat(dn({key:d,value:c,valueSpec:b.layer,style:h.style,styleSpec:h.styleSpec,validateSpec:h.validateSpec,objectElementValidators:{"*":()=>[],type:()=>h.validateSpec({key:`${d}.type`,value:c.type,valueSpec:b.layer.type,style:h.style,styleSpec:h.styleSpec,validateSpec:h.validateSpec,object:c,objectKey:"type"}),filter:$c,layout:A=>dn({layer:c,key:A.key,value:A.value,style:A.style,styleSpec:A.styleSpec,validateSpec:A.validateSpec,objectElementValidators:{"*":P=>fo(bi({layerType:v},P))}}),paint:A=>dn({layer:c,key:A.key,value:A.value,style:A.style,styleSpec:A.styleSpec,validateSpec:A.validateSpec,objectElementValidators:{"*":P=>uo(bi({layerType:v},P))}})}})),n}function gn(h){const n=h.value,c=h.key,d=qt(n);return d!=="string"?[new rt(c,n,`string expected, ${d} found`)]:[]}const Wc={promoteId:function({key:h,value:n}){if(qt(n)==="string")return gn({key:h,value:n});{const c=[];for(const d in n)c.push(...gn({key:`${h}.${d}`,value:n[d]}));return c}}};function zu(h){const n=h.value,c=h.key,d=h.styleSpec,m=h.style,b=h.validateSpec;if(!n.type)return[new rt(c,n,'"type" is required')];const v=jr(n.type);let w;switch(v){case"vector":case"raster":return w=dn({key:c,value:n,valueSpec:d[`source_${v.replace("-","_")}`],style:h.style,styleSpec:d,objectElementValidators:Wc,validateSpec:b}),w;case"raster-dem":return w=function(A){var P;const R=(P=A.sourceName)!==null&&P!==void 0?P:"",D=A.value,L=A.styleSpec,U=L.source_raster_dem,j=A.style;let H=[];const Y=qt(D);if(D===void 0)return H;if(Y!=="object")return H.push(new rt("source_raster_dem",D,`object expected, ${Y} found`)),H;const te=jr(D.encoding)==="custom",ge=["redFactor","greenFactor","blueFactor","baseShift"],le=A.value.encoding?`"${A.value.encoding}"`:"Default";for(const z in D)!te&&ge.includes(z)?H.push(new rt(z,D[z],`In "${R}": "${z}" is only valid when "encoding" is set to "custom". ${le} encoding found`)):U[z]?H=H.concat(A.validateSpec({key:z,value:D[z],valueSpec:U[z],validateSpec:A.validateSpec,style:j,styleSpec:L})):H.push(new rt(z,D[z],`unknown property "${z}"`));return H}({sourceName:c,value:n,style:h.style,styleSpec:d,validateSpec:b}),w;case"geojson":if(w=dn({key:c,value:n,valueSpec:d.source_geojson,style:m,styleSpec:d,validateSpec:b,objectElementValidators:Wc}),n.cluster)for(const A in n.clusterProperties){const[P,R]=n.clusterProperties[A],D=typeof P=="string"?[P,["accumulated"],["get",A]]:P;w.push(...ho({key:`${c}.${A}.map`,value:R,expressionContext:"cluster-map"})),w.push(...ho({key:`${c}.${A}.reduce`,value:D,expressionContext:"cluster-reduce"}))}return w;case"video":return dn({key:c,value:n,valueSpec:d.source_video,style:m,validateSpec:b,styleSpec:d});case"image":return dn({key:c,value:n,valueSpec:d.source_image,style:m,validateSpec:b,styleSpec:d});case"canvas":return[new rt(c,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return aa({key:`${c}.type`,value:n.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]}})}}function Uu(h){const n=h.value,c=h.styleSpec,d=c.light,m=h.style;let b=[];const v=qt(n);if(n===void 0)return b;if(v!=="object")return b=b.concat([new rt("light",n,`object expected, ${v} found`)]),b;for(const w in n){const A=w.match(/^(.*)-transition$/);b=b.concat(A&&d[A[1]]&&d[A[1]].transition?h.validateSpec({key:w,value:n[w],valueSpec:c.transition,validateSpec:h.validateSpec,style:m,styleSpec:c}):d[w]?h.validateSpec({key:w,value:n[w],valueSpec:d[w],validateSpec:h.validateSpec,style:m,styleSpec:c}):[new rt(w,n[w],`unknown property "${w}"`)])}return b}function po(h){const n=h.value,c=h.styleSpec,d=c.sky,m=h.style,b=qt(n);if(n===void 0)return[];if(b!=="object")return[new rt("sky",n,`object expected, ${b} found`)];let v=[];for(const w in n)v=v.concat(d[w]?h.validateSpec({key:w,value:n[w],valueSpec:d[w],style:m,styleSpec:c}):[new rt(w,n[w],`unknown property "${w}"`)]);return v}function Hc(h){const n=h.value,c=h.styleSpec,d=c.terrain,m=h.style;let b=[];const v=qt(n);if(n===void 0)return b;if(v!=="object")return b=b.concat([new rt("terrain",n,`object expected, ${v} found`)]),b;for(const w in n)b=b.concat(d[w]?h.validateSpec({key:w,value:n[w],valueSpec:d[w],validateSpec:h.validateSpec,style:m,styleSpec:c}):[new rt(w,n[w],`unknown property "${w}"`)]);return b}function ml(h){let n=[];const c=h.value,d=h.key;if(Array.isArray(c)){const m=[],b=[];for(const v in c)c[v].id&&m.includes(c[v].id)&&n.push(new rt(d,c,`all the sprites' ids must be unique, but ${c[v].id} is duplicated`)),m.push(c[v].id),c[v].url&&b.includes(c[v].url)&&n.push(new rt(d,c,`all the sprites' URLs must be unique, but ${c[v].url} is duplicated`)),b.push(c[v].url),n=n.concat(dn({key:`${d}[${v}]`,value:c[v],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:h.validateSpec}));return n}return gn({key:d,value:c})}function Vu(h){return n=h.value,n&&n.constructor===Object?[]:[new rt(h.key,h.value,`object expected, ${qt(h.value)} found`)];var n}const _l={"*":()=>[],array:gl,boolean:function(h){const n=h.value,c=h.key,d=qt(n);return d!=="boolean"?[new rt(c,n,`boolean expected, ${d} found`)]:[]},number:oa,color:jc,constants:Bu,enum:aa,filter:$c,function:co,layer:qi,object:dn,source:zu,light:Uu,sky:po,terrain:Hc,projection:function(h){const n=h.value,c=h.styleSpec,d=c.projection,m=h.style,b=qt(n);if(n===void 0)return[];if(b!=="object")return[new rt("projection",n,`object expected, ${b} found`)];let v=[];for(const w in n)v=v.concat(d[w]?h.validateSpec({key:w,value:n[w],valueSpec:d[w],style:m,styleSpec:c}):[new rt(w,n[w],`unknown property "${w}"`)]);return v},projectionDefinition:function(h){const n=h.key;let c=h.value;c=c instanceof String?c.valueOf():c;const d=qt(c);return d!=="array"||function(m){return Array.isArray(m)&&m.length===3&&typeof m[0]=="string"&&typeof m[1]=="string"&&typeof m[2]=="number"}(c)||function(m){return!!["interpolate","step","literal"].includes(m[0])}(c)?["array","string"].includes(d)?[]:[new rt(n,c,`projection expected, invalid type "${d}" found`)]:[new rt(n,c,`projection expected, invalid array ${JSON.stringify(c)} found`)]},string:gn,formatted:function(h){return gn(h).length===0?[]:ho(h)},resolvedImage:function(h){return gn(h).length===0?[]:ho(h)},padding:function(h){const n=h.key,c=h.value;if(qt(c)==="array"){if(c.length<1||c.length>4)return[new rt(n,c,`padding requires 1 to 4 values; ${c.length} values found`)];const d={type:"number"};let m=[];for(let b=0;b<c.length;b++)m=m.concat(h.validateSpec({key:`${n}[${b}]`,value:c[b],validateSpec:h.validateSpec,valueSpec:d}));return m}return oa({key:n,value:c,valueSpec:{}})},numberArray:function(h){const n=h.key,c=h.value;if(qt(c)==="array"){const d={type:"number"};if(c.length<1)return[new rt(n,c,"array length at least 1 expected, length 0 found")];let m=[];for(let b=0;b<c.length;b++)m=m.concat(h.validateSpec({key:`${n}[${b}]`,value:c[b],validateSpec:h.validateSpec,valueSpec:d}));return m}return oa({key:n,value:c,valueSpec:{}})},colorArray:function(h){const n=h.key,c=h.value;if(qt(c)==="array"){if(c.length<1)return[new rt(n,c,"array length at least 1 expected, length 0 found")];let d=[];for(let m=0;m<c.length;m++)d=d.concat(jc({key:`${n}[${m}]`,value:c[m]}));return d}return jc({key:n,value:c})},variableAnchorOffsetCollection:function(h){const n=h.key,c=h.value,d=qt(c),m=h.styleSpec;if(d!=="array"||c.length<1||c.length%2!=0)return[new rt(n,c,"variableAnchorOffsetCollection requires a non-empty array of even length")];let b=[];for(let v=0;v<c.length;v+=2)b=b.concat(aa({key:`${n}[${v}]`,value:c[v],valueSpec:m.layout_symbol["text-anchor"]})),b=b.concat(gl({key:`${n}[${v+1}]`,value:c[v+1],valueSpec:{length:2,value:"number"},validateSpec:h.validateSpec,style:h.style,styleSpec:m}));return b},sprite:ml,state:Vu};function yl(h){const n=h.value,c=h.valueSpec,d=h.styleSpec;return h.validateSpec=yl,c.expression&&Bs(jr(n))?co(h):c.expression&&cl(ls(n))?ho(h):c.type&&_l[c.type]?_l[c.type](h):dn(bi({},h,{valueSpec:c.type?d[c.type]:c}))}function go(h){const n=h.value,c=h.key,d=gn(h);return d.length||(n.indexOf("{fontstack}")===-1&&d.push(new rt(c,n,'"glyphs" url must include a "{fontstack}" token')),n.indexOf("{range}")===-1&&d.push(new rt(c,n,'"glyphs" url must include a "{range}" token'))),d}function fn(h,n=fe){let c=[];return c=c.concat(yl({key:"",value:h,valueSpec:n.$root,styleSpec:n,style:h,validateSpec:yl,objectElementValidators:{glyphs:go,"*":()=>[]}})),h.constants&&(c=c.concat(Bu({key:"constants",value:h.constants}))),ju(c)}function mn(h){return function(n){return h({...n,validateSpec:yl})}}function ju(h){return[].concat(h).sort((n,c)=>n.line-c.line)}function Vi(h){return function(...n){return ju(h.apply(this,n))}}fn.source=Vi(mn(zu)),fn.sprite=Vi(mn(ml)),fn.glyphs=Vi(mn(go)),fn.light=Vi(mn(Uu)),fn.sky=Vi(mn(po)),fn.terrain=Vi(mn(Hc)),fn.state=Vi(mn(Vu)),fn.layer=Vi(mn(qi)),fn.filter=Vi(mn($c)),fn.paintProperty=Vi(mn(uo)),fn.layoutProperty=Vi(mn(fo));const mo=fn,zf=mo.light,bl=mo.sky,Uf=mo.paintProperty,Zc=mo.layoutProperty;function la(h,n){let c=!1;if(n&&n.length)for(const d of n)h.fire(new Ee(new Error(d.message))),c=!0;return c}class _o{constructor(n,c,d){const m=this.cells=[];if(n instanceof ArrayBuffer){this.arrayBuffer=n;const v=new Int32Array(this.arrayBuffer);n=v[0],this.d=(c=v[1])+2*(d=v[2]);for(let A=0;A<this.d*this.d;A++){const P=v[3+A],R=v[3+A+1];m.push(P===R?null:v.subarray(P,R))}const w=v[3+m.length+1];this.keys=v.subarray(v[3+m.length],w),this.bboxes=v.subarray(w),this.insert=this._insertReadonly}else{this.d=c+2*d;for(let v=0;v<this.d*this.d;v++)m.push([]);this.keys=[],this.bboxes=[]}this.n=c,this.extent=n,this.padding=d,this.scale=c/n,this.uid=0;const b=d/c*n;this.min=-b,this.max=n+b}insert(n,c,d,m,b){this._forEachCell(c,d,m,b,this._insertCell,this.uid++,void 0,void 0),this.keys.push(n),this.bboxes.push(c),this.bboxes.push(d),this.bboxes.push(m),this.bboxes.push(b)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(n,c,d,m,b,v){this.cells[b].push(v)}query(n,c,d,m,b){const v=this.min,w=this.max;if(n<=v&&c<=v&&w<=d&&w<=m&&!b)return Array.prototype.slice.call(this.keys);{const A=[];return this._forEachCell(n,c,d,m,this._queryCell,A,{},b),A}}_queryCell(n,c,d,m,b,v,w,A){const P=this.cells[b];if(P!==null){const R=this.keys,D=this.bboxes;for(let L=0;L<P.length;L++){const U=P[L];if(w[U]===void 0){const j=4*U;(A?A(D[j+0],D[j+1],D[j+2],D[j+3]):n<=D[j+2]&&c<=D[j+3]&&d>=D[j+0]&&m>=D[j+1])?(w[U]=!0,v.push(R[U])):w[U]=!1}}}}_forEachCell(n,c,d,m,b,v,w,A){const P=this._convertToCellCoord(n),R=this._convertToCellCoord(c),D=this._convertToCellCoord(d),L=this._convertToCellCoord(m);for(let U=P;U<=D;U++)for(let j=R;j<=L;j++){const H=this.d*j+U;if((!A||A(this._convertFromCellCoord(U),this._convertFromCellCoord(j),this._convertFromCellCoord(U+1),this._convertFromCellCoord(j+1)))&&b.call(this,n,c,d,m,H,v,w,A))return}}_convertFromCellCoord(n){return(n-this.padding)/this.scale}_convertToCellCoord(n){return Math.max(0,Math.min(this.d-1,Math.floor(n*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const n=this.cells,c=3+this.cells.length+1+1;let d=0;for(let v=0;v<this.cells.length;v++)d+=this.cells[v].length;const m=new Int32Array(c+d+this.keys.length+this.bboxes.length);m[0]=this.extent,m[1]=this.n,m[2]=this.padding;let b=c;for(let v=0;v<n.length;v++){const w=n[v];m[3+v]=b,m.set(w,b),b+=w.length}return m[3+n.length]=b,m.set(this.keys,b),b+=this.keys.length,m[3+n.length+1]=b,m.set(this.bboxes,b),b+=this.bboxes.length,m.buffer}static serialize(n,c){const d=n.toArrayBuffer();return c&&c.push(d),{buffer:d}}static deserialize(n){return new _o(n.buffer)}}const Rn={};function ht(h,n,c={}){if(Rn[h])throw new Error(`${h} is already registered.`);Object.defineProperty(n,"_classRegistryKey",{value:h,writeable:!1}),Rn[h]={klass:n,omit:c.omit||[],shallow:c.shallow||[]}}ht("Object",Object),ht("Set",Set),ht("TransferableGridIndex",_o),ht("Color",Xt),ht("Error",Error),ht("AJAXError",ce),ht("ResolvedImage",Hi),ht("StylePropertyFunction",ia),ht("StyleExpression",ll,{omit:["_evaluator"]}),ht("ZoomDependentExpression",ul),ht("ZoomConstantExpression",ra),ht("CompoundExpression",un,{omit:["_evaluate"]});for(const h in io)io[h]._classRegistryKey||ht(`Expression_${h}`,io[h]);function Xc(h){return h&&typeof ArrayBuffer<"u"&&(h instanceof ArrayBuffer||h.constructor&&h.constructor.name==="ArrayBuffer")}function ca(h){return h.$name||h.constructor._classRegistryKey}function qc(h){return!function(n){if(n===null||typeof n!="object")return!1;const c=ca(n);return!(!c||c==="Object")}(h)&&(h==null||typeof h=="boolean"||typeof h=="number"||typeof h=="string"||h instanceof Boolean||h instanceof Number||h instanceof String||h instanceof Date||h instanceof RegExp||h instanceof Blob||h instanceof Error||Xc(h)||Ni(h)||ArrayBuffer.isView(h)||h instanceof ImageData)}function ha(h,n){if(qc(h))return(Xc(h)||Ni(h))&&n&&n.push(h),ArrayBuffer.isView(h)&&n&&n.push(h.buffer),h instanceof ImageData&&n&&n.push(h.data.buffer),h;if(Array.isArray(h)){const b=[];for(const v of h)b.push(ha(v,n));return b}if(typeof h!="object")throw new Error("can't serialize object of type "+typeof h);const c=ca(h);if(!c)throw new Error(`can't serialize object of unregistered class ${h.constructor.name}`);if(!Rn[c])throw new Error(`${c} is not registered.`);const{klass:d}=Rn[c],m=d.serialize?d.serialize(h,n):{};if(d.serialize){if(n&&m===n[n.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const b in h){if(!h.hasOwnProperty(b)||Rn[c].omit.indexOf(b)>=0)continue;const v=h[b];m[b]=Rn[c].shallow.indexOf(b)>=0?v:ha(v,n)}h instanceof Error&&(m.message=h.message)}if(m.$name)throw new Error("$name property is reserved for worker serialization logic.");return c!=="Object"&&(m.$name=c),m}function yo(h){if(qc(h))return h;if(Array.isArray(h))return h.map(yo);if(typeof h!="object")throw new Error("can't deserialize object of type "+typeof h);const n=ca(h)||"Object";if(!Rn[n])throw new Error(`can't deserialize unregistered class ${n}`);const{klass:c}=Rn[n];if(!c)throw new Error(`can't deserialize unregistered class ${n}`);if(c.deserialize)return c.deserialize(h);const d=Object.create(c.prototype);for(const m of Object.keys(h)){if(m==="$name")continue;const b=h[m];d[m]=Rn[n].shallow.indexOf(m)>=0?b:yo(b)}return d}class Yc{constructor(){this.first=!0}update(n,c){const d=Math.floor(n);return this.first?(this.first=!1,this.lastIntegerZoom=d,this.lastIntegerZoomTime=0,this.lastZoom=n,this.lastFloorZoom=d,!0):(this.lastFloorZoom>d?(this.lastIntegerZoom=d+1,this.lastIntegerZoomTime=c):this.lastFloorZoom<d&&(this.lastIntegerZoom=d,this.lastIntegerZoomTime=c),n!==this.lastZoom&&(this.lastZoom=n,this.lastFloorZoom=d,!0))}}const Yt={"Latin-1 Supplement":h=>h>=128&&h<=255,"Hangul Jamo":h=>h>=4352&&h<=4607,Khmer:h=>h>=6016&&h<=6143,"General Punctuation":h=>h>=8192&&h<=8303,"Letterlike Symbols":h=>h>=8448&&h<=8527,"Number Forms":h=>h>=8528&&h<=8591,"Miscellaneous Technical":h=>h>=8960&&h<=9215,"Control Pictures":h=>h>=9216&&h<=9279,"Optical Character Recognition":h=>h>=9280&&h<=9311,"Enclosed Alphanumerics":h=>h>=9312&&h<=9471,"Geometric Shapes":h=>h>=9632&&h<=9727,"Miscellaneous Symbols":h=>h>=9728&&h<=9983,"Miscellaneous Symbols and Arrows":h=>h>=11008&&h<=11263,"Ideographic Description Characters":h=>h>=12272&&h<=12287,"CJK Symbols and Punctuation":h=>h>=12288&&h<=12351,Hiragana:h=>h>=12352&&h<=12447,Katakana:h=>h>=12448&&h<=12543,Kanbun:h=>h>=12688&&h<=12703,"CJK Strokes":h=>h>=12736&&h<=12783,"Enclosed CJK Letters and Months":h=>h>=12800&&h<=13055,"CJK Compatibility":h=>h>=13056&&h<=13311,"Yijing Hexagram Symbols":h=>h>=19904&&h<=19967,"CJK Unified Ideographs":h=>h>=19968&&h<=40959,"Hangul Syllables":h=>h>=44032&&h<=55215,"Private Use Area":h=>h>=57344&&h<=63743,"Vertical Forms":h=>h>=65040&&h<=65055,"CJK Compatibility Forms":h=>h>=65072&&h<=65103,"Small Form Variants":h=>h>=65104&&h<=65135,"Halfwidth and Fullwidth Forms":h=>h>=65280&&h<=65519};function Gc(h){for(const n of h)if(xl(n.charCodeAt(0)))return!0;return!1}function $u(h){for(const n of h)if(!jf(n.charCodeAt(0)))return!1;return!0}function vl(h){const n=h.map(c=>{try{return new RegExp(`\\p{sc=${c}}`,"u").source}catch{return null}}).filter(c=>c);return new RegExp(n.join("|"),"u")}const Vf=vl(["Arab","Dupl","Mong","Ougr","Syrc"]);function jf(h){return!Vf.test(String.fromCodePoint(h))}const Kc=vl(["Bopo","Hani","Hira","Kana","Kits","Nshu","Tang","Yiii"]);function xl(h){return!(h!==746&&h!==747&&(h<4352||!(Yt["CJK Compatibility Forms"](h)&&!(h>=65097&&h<=65103)||Yt["CJK Compatibility"](h)||Yt["CJK Strokes"](h)||!(!Yt["CJK Symbols and Punctuation"](h)||h>=12296&&h<=12305||h>=12308&&h<=12319||h===12336)||Yt["Enclosed CJK Letters and Months"](h)||Yt["Ideographic Description Characters"](h)||Yt.Kanbun(h)||Yt.Katakana(h)&&h!==12540||!(!Yt["Halfwidth and Fullwidth Forms"](h)||h===65288||h===65289||h===65293||h>=65306&&h<=65310||h===65339||h===65341||h===65343||h>=65371&&h<=65503||h===65507||h>=65512&&h<=65519)||!(!Yt["Small Form Variants"](h)||h>=65112&&h<=65118||h>=65123&&h<=65126)||Yt["Vertical Forms"](h)||Yt["Yijing Hexagram Symbols"](h)||new RegExp("\\p{sc=Cans}","u").test(String.fromCodePoint(h))||new RegExp("\\p{sc=Hang}","u").test(String.fromCodePoint(h))||Kc.test(String.fromCodePoint(h)))))}function Jc(h){return!(xl(h)||function(n){return!!(Yt["Latin-1 Supplement"](n)&&(n===167||n===169||n===174||n===177||n===188||n===189||n===190||n===215||n===247)||Yt["General Punctuation"](n)&&(n===8214||n===8224||n===8225||n===8240||n===8241||n===8251||n===8252||n===8258||n===8263||n===8264||n===8265||n===8273)||Yt["Letterlike Symbols"](n)||Yt["Number Forms"](n)||Yt["Miscellaneous Technical"](n)&&(n>=8960&&n<=8967||n>=8972&&n<=8991||n>=8996&&n<=9e3||n===9003||n>=9085&&n<=9114||n>=9150&&n<=9165||n===9167||n>=9169&&n<=9179||n>=9186&&n<=9215)||Yt["Control Pictures"](n)&&n!==9251||Yt["Optical Character Recognition"](n)||Yt["Enclosed Alphanumerics"](n)||Yt["Geometric Shapes"](n)||Yt["Miscellaneous Symbols"](n)&&!(n>=9754&&n<=9759)||Yt["Miscellaneous Symbols and Arrows"](n)&&(n>=11026&&n<=11055||n>=11088&&n<=11097||n>=11192&&n<=11243)||Yt["CJK Symbols and Punctuation"](n)||Yt.Katakana(n)||Yt["Private Use Area"](n)||Yt["CJK Compatibility Forms"](n)||Yt["Small Form Variants"](n)||Yt["Halfwidth and Fullwidth Forms"](n)||n===8734||n===8756||n===8757||n>=9984&&n<=10087||n>=10102&&n<=10131||n===65532||n===65533)}(h))}const Wu=vl(["Adlm","Arab","Armi","Avst","Chrs","Cprt","Egyp","Elym","Gara","Hatr","Hebr","Hung","Khar","Lydi","Mand","Mani","Mend","Merc","Mero","Narb","Nbat","Nkoo","Orkh","Palm","Phli","Phlp","Phnx","Prti","Rohg","Samr","Sarb","Sogo","Syrc","Thaa","Todr","Yezi"]);function ua(h){return Wu.test(String.fromCodePoint(h))}function $f(h,n){return!(!n&&ua(h)||h>=2304&&h<=3583||h>=3840&&h<=4255||Yt.Khmer(h))}function Qc(h){for(const n of h)if(ua(n.charCodeAt(0)))return!0;return!1}const cs=new class{constructor(){this.TIMEOUT=5e3,this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null,this.loadScriptResolve=()=>{}}setState(h){this.pluginStatus=h.pluginStatus,this.pluginURL=h.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(h){if(cs.isParsed())throw new Error("RTL text plugin already registered.");this.applyArabicShaping=h.applyArabicShaping,this.processBidirectionalText=h.processBidirectionalText,this.processStyledBidirectionalText=h.processStyledBidirectionalText,this.loadScriptResolve()}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getRTLTextPluginStatus(){return this.pluginStatus}syncState(h,n){return o(this,void 0,void 0,function*(){if(this.isParsed())return this.getState();if(h.pluginStatus!=="loading")return this.setState(h),h;const c=h.pluginURL,d=new Promise(b=>{this.loadScriptResolve=b});n(c);const m=new Promise(b=>setTimeout(()=>b(),this.TIMEOUT));if(yield Promise.race([d,m]),this.isParsed()){const b={pluginStatus:"loaded",pluginURL:c};return this.setState(b),b}throw this.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${c}`)})}};class Rr{constructor(n,c){this.zoom=n,c?(this.now=c.now||0,this.fadeDuration=c.fadeDuration||0,this.zoomHistory=c.zoomHistory||new Yc,this.transition=c.transition||{},this.globalState=c.globalState||{}):(this.now=0,this.fadeDuration=0,this.zoomHistory=new Yc,this.transition={},this.globalState={})}isSupportedScript(n){return function(c,d){for(const m of c)if(!$f(m.charCodeAt(0),d))return!1;return!0}(n,cs.getRTLTextPluginStatus()==="loaded")}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const n=this.zoom,c=n-Math.floor(n),d=this.crossFadingFactor();return n>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:c+(1-c)*d}:{fromScale:.5,toScale:1,t:1-(1-d)*c}}}class da{constructor(n,c){this.property=n,this.value=c,this.expression=function(d,m){if(Bs(d))return new ia(d,m);if(cl(d)){const b=zc(d,m);if(b.result==="error")throw new Error(b.value.map(v=>`${v.key}: ${v.message}`).join(", "));return b.value}{let b=d;return m.type==="color"&&typeof d=="string"?b=Xt.parse(d):m.type!=="padding"||typeof d!="number"&&!Array.isArray(d)?m.type!=="numberArray"||typeof d!="number"&&!Array.isArray(d)?m.type!=="colorArray"||typeof d!="string"&&!Array.isArray(d)?m.type==="variableAnchorOffsetCollection"&&Array.isArray(d)?b=tr.parse(d):m.type==="projectionDefinition"&&typeof d=="string"&&(b=Ft.parse(d)):b=li.parse(d):b=Oi.parse(d):b=Gr.parse(d),{globalStateRefs:new Set,kind:"constant",evaluate:()=>b}}}(c===void 0?n.specification.default:c,n.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}getGlobalStateRefs(){return this.expression.globalStateRefs||new Set}possiblyEvaluate(n,c,d){return this.property.possiblyEvaluate(this,n,c,d)}}class wl{constructor(n){this.property=n,this.value=new da(n,void 0)}transitioned(n,c){return new Hu(this.property,this.value,c,Tt({},n.transition,this.transition),n.now)}untransitioned(){return new Hu(this.property,this.value,null,{},0)}}class eh{constructor(n){this._properties=n,this._values=Object.create(n.defaultTransitionablePropertyValues)}getValue(n){return Gt(this._values[n].value.value)}setValue(n,c){Object.prototype.hasOwnProperty.call(this._values,n)||(this._values[n]=new wl(this._values[n].property)),this._values[n].value=new da(this._values[n].property,c===null?void 0:Gt(c))}getTransition(n){return Gt(this._values[n].transition)}setTransition(n,c){Object.prototype.hasOwnProperty.call(this._values,n)||(this._values[n]=new wl(this._values[n].property)),this._values[n].transition=Gt(c)||void 0}serialize(){const n={};for(const c of Object.keys(this._values)){const d=this.getValue(c);d!==void 0&&(n[c]=d);const m=this.getTransition(c);m!==void 0&&(n[`${c}-transition`]=m)}return n}transitioned(n,c){const d=new Zu(this._properties);for(const m of Object.keys(this._values))d._values[m]=this._values[m].transitioned(n,c._values[m]);return d}untransitioned(){const n=new Zu(this._properties);for(const c of Object.keys(this._values))n._values[c]=this._values[c].untransitioned();return n}}class Hu{constructor(n,c,d,m,b){this.property=n,this.value=c,this.begin=b+m.delay||0,this.end=this.begin+m.duration||0,n.specification.transition&&(m.delay||m.duration)&&(this.prior=d)}possiblyEvaluate(n,c,d){const m=n.now||0,b=this.value.possiblyEvaluate(n,c,d),v=this.prior;if(v){if(m>this.end)return this.prior=null,b;if(this.value.isDataDriven())return this.prior=null,b;if(m<this.begin)return v.possiblyEvaluate(n,c,d);{const w=(m-this.begin)/(this.end-this.begin);return this.property.interpolate(v.possiblyEvaluate(n,c,d),b,Mr(w))}}return b}}class Zu{constructor(n){this._properties=n,this._values=Object.create(n.defaultTransitioningPropertyValues)}possiblyEvaluate(n,c,d){const m=new Tl(this._properties);for(const b of Object.keys(this._values))m._values[b]=this._values[b].possiblyEvaluate(n,c,d);return m}hasTransition(){for(const n of Object.keys(this._values))if(this._values[n].prior)return!0;return!1}}class Wf{constructor(n){this._properties=n,this._values=Object.create(n.defaultPropertyValues)}hasValue(n){return this._values[n].value!==void 0}getValue(n){return Gt(this._values[n].value)}setValue(n,c){this._values[n]=new da(this._values[n].property,c===null?void 0:Gt(c))}serialize(){const n={};for(const c of Object.keys(this._values)){const d=this.getValue(c);d!==void 0&&(n[c]=d)}return n}possiblyEvaluate(n,c,d){const m=new Tl(this._properties);for(const b of Object.keys(this._values))m._values[b]=this._values[b].possiblyEvaluate(n,c,d);return m}}class kn{constructor(n,c,d){this.property=n,this.value=c,this.parameters=d}isConstant(){return this.value.kind==="constant"}constantOr(n){return this.value.kind==="constant"?this.value.value:n}evaluate(n,c,d,m){return this.property.evaluate(this.value,this.parameters,n,c,d,m)}}class Tl{constructor(n){this._properties=n,this._values=Object.create(n.defaultPossiblyEvaluatedValues)}get(n){return this._values[n]}}class gt{constructor(n){this.specification=n}possiblyEvaluate(n,c){if(n.isDataDriven())throw new Error("Value should not be data driven");return n.expression.evaluate(c)}interpolate(n,c,d){const m=nn[this.specification.type];return m?m(n,c,d):n}}class St{constructor(n,c){this.specification=n,this.overrides=c}possiblyEvaluate(n,c,d,m){return new kn(this,n.expression.kind==="constant"||n.expression.kind==="camera"?{kind:"constant",value:n.expression.evaluate(c,null,{},d,m)}:n.expression,c)}interpolate(n,c,d){if(n.value.kind!=="constant"||c.value.kind!=="constant")return n;if(n.value.value===void 0||c.value.value===void 0)return new kn(this,{kind:"constant",value:void 0},n.parameters);const m=nn[this.specification.type];if(m){const b=m(n.value.value,c.value.value,d);return new kn(this,{kind:"constant",value:b},n.parameters)}return n}evaluate(n,c,d,m,b,v){return n.kind==="constant"?n.value:n.evaluate(c,d,m,b,v)}}class Sl extends St{possiblyEvaluate(n,c,d,m){if(n.value===void 0)return new kn(this,{kind:"constant",value:void 0},c);if(n.expression.kind==="constant"){const b=n.expression.evaluate(c,null,{},d,m),v=n.property.specification.type==="resolvedImage"&&typeof b!="string"?b.name:b,w=this._calculate(v,v,v,c);return new kn(this,{kind:"constant",value:w},c)}if(n.expression.kind==="camera"){const b=this._calculate(n.expression.evaluate({zoom:c.zoom-1}),n.expression.evaluate({zoom:c.zoom}),n.expression.evaluate({zoom:c.zoom+1}),c);return new kn(this,{kind:"constant",value:b},c)}return new kn(this,n.expression,c)}evaluate(n,c,d,m,b,v){if(n.kind==="source"){const w=n.evaluate(c,d,m,b,v);return this._calculate(w,w,w,c)}return n.kind==="composite"?this._calculate(n.evaluate({zoom:Math.floor(c.zoom)-1},d,m),n.evaluate({zoom:Math.floor(c.zoom)},d,m),n.evaluate({zoom:Math.floor(c.zoom)+1},d,m),c):n.value}_calculate(n,c,d,m){return m.zoom>m.zoomHistory.lastIntegerZoom?{from:n,to:c}:{from:d,to:c}}interpolate(n){return n}}class th{constructor(n){this.specification=n}possiblyEvaluate(n,c,d,m){if(n.value!==void 0){if(n.expression.kind==="constant"){const b=n.expression.evaluate(c,null,{},d,m);return this._calculate(b,b,b,c)}return this._calculate(n.expression.evaluate(new Rr(Math.floor(c.zoom-1),c)),n.expression.evaluate(new Rr(Math.floor(c.zoom),c)),n.expression.evaluate(new Rr(Math.floor(c.zoom+1),c)),c)}}_calculate(n,c,d,m){return m.zoom>m.zoomHistory.lastIntegerZoom?{from:n,to:c}:{from:d,to:c}}interpolate(n){return n}}class fa{constructor(n){this.specification=n}possiblyEvaluate(n,c,d,m){return!!n.expression.evaluate(c,null,{},d,m)}interpolate(){return!1}}class ji{constructor(n){this.properties=n,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const c in n){const d=n[c];d.specification.overridable&&this.overridableProperties.push(c);const m=this.defaultPropertyValues[c]=new da(d,void 0),b=this.defaultTransitionablePropertyValues[c]=new wl(d);this.defaultTransitioningPropertyValues[c]=b.untransitioned(),this.defaultPossiblyEvaluatedValues[c]=m.possiblyEvaluate({})}}}ht("DataDrivenProperty",St),ht("DataConstantProperty",gt),ht("CrossFadedDataDrivenProperty",Sl),ht("CrossFadedProperty",th),ht("ColorRampProperty",fa);const Xu="-transition";class vi extends He{constructor(n,c){if(super(),this.id=n.id,this.type=n.type,this._featureFilter={filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set},n.type!=="custom"&&(this.metadata=n.metadata,this.minzoom=n.minzoom,this.maxzoom=n.maxzoom,n.type!=="background"&&(this.source=n.source,this.sourceLayer=n["source-layer"],this.filter=n.filter,this._featureFilter=as(n.filter)),c.layout&&(this._unevaluatedLayout=new Wf(c.layout)),c.paint)){this._transitionablePaint=new eh(c.paint);for(const d in n.paint)this.setPaintProperty(d,n.paint[d],{validate:!1});for(const d in n.layout)this.setLayoutProperty(d,n.layout[d],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Tl(c.paint)}}setFilter(n){this.filter=n,this._featureFilter=as(n)}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(n){return n==="visibility"?this.visibility:this._unevaluatedLayout.getValue(n)}getLayoutAffectingGlobalStateRefs(){const n=new Set;if(this._unevaluatedLayout)for(const c in this._unevaluatedLayout._values){const d=this._unevaluatedLayout._values[c];for(const m of d.getGlobalStateRefs())n.add(m)}for(const c of this._featureFilter.getGlobalStateRefs())n.add(c);return n}setLayoutProperty(n,c,d={}){c!=null&&this._validate(Zc,`layers.${this.id}.layout.${n}`,n,c,d)||(n!=="visibility"?this._unevaluatedLayout.setValue(n,c):this.visibility=c)}getPaintProperty(n){return n.endsWith(Xu)?this._transitionablePaint.getTransition(n.slice(0,-11)):this._transitionablePaint.getValue(n)}setPaintProperty(n,c,d={}){if(c!=null&&this._validate(Uf,`layers.${this.id}.paint.${n}`,n,c,d))return!1;if(n.endsWith(Xu))return this._transitionablePaint.setTransition(n.slice(0,-11),c||void 0),!1;{const m=this._transitionablePaint._values[n],b=m.property.specification["property-type"]==="cross-faded-data-driven",v=m.value.isDataDriven(),w=m.value;this._transitionablePaint.setValue(n,c),this._handleSpecialPaintPropertyUpdate(n);const A=this._transitionablePaint._values[n].value;return A.isDataDriven()||v||b||this._handleOverridablePaintPropertyUpdate(n,w,A)}}_handleSpecialPaintPropertyUpdate(n){}_handleOverridablePaintPropertyUpdate(n,c,d){return!1}isHidden(n){return!!(this.minzoom&&n<this.minzoom)||!!(this.maxzoom&&n>=this.maxzoom)||this.visibility==="none"}updateTransitions(n){this._transitioningPaint=this._transitionablePaint.transitioned(n,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(n,c){n.getCrossfadeParameters&&(this._crossfadeParameters=n.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(n,void 0,c)),this.paint=this._transitioningPaint.possiblyEvaluate(n,void 0,c)}serialize(){const n={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(n.layout=n.layout||{},n.layout.visibility=this.visibility),Jt(n,(c,d)=>!(c===void 0||d==="layout"&&!Object.keys(c).length||d==="paint"&&!Object.keys(c).length))}_validate(n,c,d,m,b={}){return(!b||b.validate!==!1)&&la(this,n.call(mo,{key:c,layerType:this.type,objectKey:d,value:m,styleSpec:fe,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const n in this.paint._values){const c=this.paint.get(n);if(c instanceof kn&&oo(c.property.specification)&&(c.value.kind==="source"||c.value.kind==="composite")&&c.value.isStateDependent)return!0}return!1}}const qu={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Ls{constructor(n,c){this._structArray=n,this._pos1=c*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Br{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(n,c){return n._trim(),c&&(n.isTransferred=!0,c.push(n.arrayBuffer)),{length:n.length,arrayBuffer:n.arrayBuffer}}static deserialize(n){const c=Object.create(this.prototype);return c.arrayBuffer=n.arrayBuffer,c.length=n.length,c.capacity=n.arrayBuffer.byteLength/c.bytesPerElement,c._refreshViews(),c}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(n){this.reserve(n),this.length=n}reserve(n){if(n>this.capacity){this.capacity=Math.max(n,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const c=this.uint8;this._refreshViews(),c&&this.uint8.set(c)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function $r(h,n=1){let c=0,d=0;return{members:h.map(m=>{const b=qu[m.type].BYTES_PER_ELEMENT,v=c=Yu(c,Math.max(n,b)),w=m.components||1;return d=Math.max(d,b),c+=b*w,{name:m.name,type:m.type,components:w,offset:v}}),size:Yu(c,Math.max(d,n)),alignment:n}}function Yu(h,n){return Math.ceil(h/n)*n}class hs extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c){const d=this.length;return this.resize(d+1),this.emplace(d,n,c)}emplace(n,c,d){const m=2*n;return this.int16[m+0]=c,this.int16[m+1]=d,n}}hs.prototype.bytesPerElement=4,ht("StructArrayLayout2i4",hs);class us extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,n,c,d)}emplace(n,c,d,m){const b=3*n;return this.int16[b+0]=c,this.int16[b+1]=d,this.int16[b+2]=m,n}}us.prototype.bytesPerElement=6,ht("StructArrayLayout3i6",us);class rh extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c,d,m){const b=this.length;return this.resize(b+1),this.emplace(b,n,c,d,m)}emplace(n,c,d,m,b){const v=4*n;return this.int16[v+0]=c,this.int16[v+1]=d,this.int16[v+2]=m,this.int16[v+3]=b,n}}rh.prototype.bytesPerElement=8,ht("StructArrayLayout4i8",rh);class Al extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c,d,m,b,v){const w=this.length;return this.resize(w+1),this.emplace(w,n,c,d,m,b,v)}emplace(n,c,d,m,b,v,w){const A=6*n;return this.int16[A+0]=c,this.int16[A+1]=d,this.int16[A+2]=m,this.int16[A+3]=b,this.int16[A+4]=v,this.int16[A+5]=w,n}}Al.prototype.bytesPerElement=12,ht("StructArrayLayout2i4i12",Al);class Ns extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c,d,m,b,v){const w=this.length;return this.resize(w+1),this.emplace(w,n,c,d,m,b,v)}emplace(n,c,d,m,b,v,w){const A=4*n,P=8*n;return this.int16[A+0]=c,this.int16[A+1]=d,this.uint8[P+4]=m,this.uint8[P+5]=b,this.uint8[P+6]=v,this.uint8[P+7]=w,n}}Ns.prototype.bytesPerElement=8,ht("StructArrayLayout2i4ub8",Ns);class pa extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c){const d=this.length;return this.resize(d+1),this.emplace(d,n,c)}emplace(n,c,d){const m=2*n;return this.float32[m+0]=c,this.float32[m+1]=d,n}}pa.prototype.bytesPerElement=8,ht("StructArrayLayout2f8",pa);class ih extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,c,d,m,b,v,w,A,P,R){const D=this.length;return this.resize(D+1),this.emplace(D,n,c,d,m,b,v,w,A,P,R)}emplace(n,c,d,m,b,v,w,A,P,R,D){const L=10*n;return this.uint16[L+0]=c,this.uint16[L+1]=d,this.uint16[L+2]=m,this.uint16[L+3]=b,this.uint16[L+4]=v,this.uint16[L+5]=w,this.uint16[L+6]=A,this.uint16[L+7]=P,this.uint16[L+8]=R,this.uint16[L+9]=D,n}}ih.prototype.bytesPerElement=20,ht("StructArrayLayout10ui20",ih);class El extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,c,d,m,b,v,w,A,P,R,D,L){const U=this.length;return this.resize(U+1),this.emplace(U,n,c,d,m,b,v,w,A,P,R,D,L)}emplace(n,c,d,m,b,v,w,A,P,R,D,L,U){const j=12*n;return this.int16[j+0]=c,this.int16[j+1]=d,this.int16[j+2]=m,this.int16[j+3]=b,this.uint16[j+4]=v,this.uint16[j+5]=w,this.uint16[j+6]=A,this.uint16[j+7]=P,this.int16[j+8]=R,this.int16[j+9]=D,this.int16[j+10]=L,this.int16[j+11]=U,n}}El.prototype.bytesPerElement=24,ht("StructArrayLayout4i4ui4i24",El);class nh extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,n,c,d)}emplace(n,c,d,m){const b=3*n;return this.float32[b+0]=c,this.float32[b+1]=d,this.float32[b+2]=m,n}}nh.prototype.bytesPerElement=12,ht("StructArrayLayout3f12",nh);class _ extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(n){const c=this.length;return this.resize(c+1),this.emplace(c,n)}emplace(n,c){return this.uint32[1*n+0]=c,n}}_.prototype.bytesPerElement=4,ht("StructArrayLayout1ul4",_);class i extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,c,d,m,b,v,w,A,P){const R=this.length;return this.resize(R+1),this.emplace(R,n,c,d,m,b,v,w,A,P)}emplace(n,c,d,m,b,v,w,A,P,R){const D=10*n,L=5*n;return this.int16[D+0]=c,this.int16[D+1]=d,this.int16[D+2]=m,this.int16[D+3]=b,this.int16[D+4]=v,this.int16[D+5]=w,this.uint32[L+3]=A,this.uint16[D+8]=P,this.uint16[D+9]=R,n}}i.prototype.bytesPerElement=20,ht("StructArrayLayout6i1ul2ui20",i);class l extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c,d,m,b,v){const w=this.length;return this.resize(w+1),this.emplace(w,n,c,d,m,b,v)}emplace(n,c,d,m,b,v,w){const A=6*n;return this.int16[A+0]=c,this.int16[A+1]=d,this.int16[A+2]=m,this.int16[A+3]=b,this.int16[A+4]=v,this.int16[A+5]=w,n}}l.prototype.bytesPerElement=12,ht("StructArrayLayout2i2i2i12",l);class f extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c,d,m,b){const v=this.length;return this.resize(v+1),this.emplace(v,n,c,d,m,b)}emplace(n,c,d,m,b,v){const w=4*n,A=8*n;return this.float32[w+0]=c,this.float32[w+1]=d,this.float32[w+2]=m,this.int16[A+6]=b,this.int16[A+7]=v,n}}f.prototype.bytesPerElement=16,ht("StructArrayLayout2f1f2i16",f);class g extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c,d,m,b,v){const w=this.length;return this.resize(w+1),this.emplace(w,n,c,d,m,b,v)}emplace(n,c,d,m,b,v,w){const A=16*n,P=4*n,R=8*n;return this.uint8[A+0]=c,this.uint8[A+1]=d,this.float32[P+1]=m,this.float32[P+2]=b,this.int16[R+6]=v,this.int16[R+7]=w,n}}g.prototype.bytesPerElement=16,ht("StructArrayLayout2ub2f2i16",g);class y extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,n,c,d)}emplace(n,c,d,m){const b=3*n;return this.uint16[b+0]=c,this.uint16[b+1]=d,this.uint16[b+2]=m,n}}y.prototype.bytesPerElement=6,ht("StructArrayLayout3ui6",y);class x extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c,d,m,b,v,w,A,P,R,D,L,U,j,H,Y,te){const ge=this.length;return this.resize(ge+1),this.emplace(ge,n,c,d,m,b,v,w,A,P,R,D,L,U,j,H,Y,te)}emplace(n,c,d,m,b,v,w,A,P,R,D,L,U,j,H,Y,te,ge){const le=24*n,z=12*n,q=48*n;return this.int16[le+0]=c,this.int16[le+1]=d,this.uint16[le+2]=m,this.uint16[le+3]=b,this.uint32[z+2]=v,this.uint32[z+3]=w,this.uint32[z+4]=A,this.uint16[le+10]=P,this.uint16[le+11]=R,this.uint16[le+12]=D,this.float32[z+7]=L,this.float32[z+8]=U,this.uint8[q+36]=j,this.uint8[q+37]=H,this.uint8[q+38]=Y,this.uint32[z+10]=te,this.int16[le+22]=ge,n}}x.prototype.bytesPerElement=48,ht("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",x);class S extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c,d,m,b,v,w,A,P,R,D,L,U,j,H,Y,te,ge,le,z,q,he,Re,Xe,Be,Ve,Je,Ye){const tt=this.length;return this.resize(tt+1),this.emplace(tt,n,c,d,m,b,v,w,A,P,R,D,L,U,j,H,Y,te,ge,le,z,q,he,Re,Xe,Be,Ve,Je,Ye)}emplace(n,c,d,m,b,v,w,A,P,R,D,L,U,j,H,Y,te,ge,le,z,q,he,Re,Xe,Be,Ve,Je,Ye,tt){const We=32*n,pt=16*n;return this.int16[We+0]=c,this.int16[We+1]=d,this.int16[We+2]=m,this.int16[We+3]=b,this.int16[We+4]=v,this.int16[We+5]=w,this.int16[We+6]=A,this.int16[We+7]=P,this.uint16[We+8]=R,this.uint16[We+9]=D,this.uint16[We+10]=L,this.uint16[We+11]=U,this.uint16[We+12]=j,this.uint16[We+13]=H,this.uint16[We+14]=Y,this.uint16[We+15]=te,this.uint16[We+16]=ge,this.uint16[We+17]=le,this.uint16[We+18]=z,this.uint16[We+19]=q,this.uint16[We+20]=he,this.uint16[We+21]=Re,this.uint16[We+22]=Xe,this.uint32[pt+12]=Be,this.float32[pt+13]=Ve,this.float32[pt+14]=Je,this.uint16[We+30]=Ye,this.uint16[We+31]=tt,n}}S.prototype.bytesPerElement=64,ht("StructArrayLayout8i15ui1ul2f2ui64",S);class I extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n){const c=this.length;return this.resize(c+1),this.emplace(c,n)}emplace(n,c){return this.float32[1*n+0]=c,n}}I.prototype.bytesPerElement=4,ht("StructArrayLayout1f4",I);class M extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,n,c,d)}emplace(n,c,d,m){const b=3*n;return this.uint16[6*n+0]=c,this.float32[b+1]=d,this.float32[b+2]=m,n}}M.prototype.bytesPerElement=12,ht("StructArrayLayout1ui2f12",M);class k extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,n,c,d)}emplace(n,c,d,m){const b=4*n;return this.uint32[2*n+0]=c,this.uint16[b+2]=d,this.uint16[b+3]=m,n}}k.prototype.bytesPerElement=8,ht("StructArrayLayout1ul2ui8",k);class B extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,c){const d=this.length;return this.resize(d+1),this.emplace(d,n,c)}emplace(n,c,d){const m=2*n;return this.uint16[m+0]=c,this.uint16[m+1]=d,n}}B.prototype.bytesPerElement=4,ht("StructArrayLayout2ui4",B);class F extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n){const c=this.length;return this.resize(c+1),this.emplace(c,n)}emplace(n,c){return this.uint16[1*n+0]=c,n}}F.prototype.bytesPerElement=2,ht("StructArrayLayout1ui2",F);class N extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c,d,m){const b=this.length;return this.resize(b+1),this.emplace(b,n,c,d,m)}emplace(n,c,d,m,b){const v=4*n;return this.float32[v+0]=c,this.float32[v+1]=d,this.float32[v+2]=m,this.float32[v+3]=b,n}}N.prototype.bytesPerElement=16,ht("StructArrayLayout4f16",N);class W extends Ls{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new ie(this.anchorPointX,this.anchorPointY)}}W.prototype.size=20;class J extends i{get(n){return new W(this,n)}}ht("CollisionBoxArray",J);class G extends Ls{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(n){this._structArray.uint8[this._pos1+37]=n}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(n){this._structArray.uint8[this._pos1+38]=n}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(n){this._structArray.uint32[this._pos4+10]=n}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}G.prototype.size=48;class Q extends x{get(n){return new G(this,n)}}ht("PlacedSymbolArray",Q);class re extends Ls{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(n){this._structArray.uint32[this._pos4+12]=n}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}re.prototype.size=64;class ae extends S{get(n){return new re(this,n)}}ht("SymbolInstanceArray",ae);class se extends I{getoffsetX(n){return this.float32[1*n+0]}}ht("GlyphOffsetArray",se);class ue extends us{getx(n){return this.int16[3*n+0]}gety(n){return this.int16[3*n+1]}gettileUnitDistanceFromAnchor(n){return this.int16[3*n+2]}}ht("SymbolLineVertexArray",ue);class de extends Ls{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}de.prototype.size=12;class oe extends M{get(n){return new de(this,n)}}ht("TextAnchorOffsetArray",oe);class ye extends Ls{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}ye.prototype.size=8;class Oe extends k{get(n){return new ye(this,n)}}ht("FeatureIndexArray",Oe);class Ce extends hs{}class Me extends hs{}class Fe extends hs{}class nt extends Al{}class it extends Ns{}class qe extends pa{}class ft extends ih{}class Nt extends El{}class sr extends nh{}class Lr extends _{}class ur extends l{}class Nr extends g{}class br extends y{}class dr extends B{}const vr=$r([{name:"a_pos",components:2,type:"Int16"}],4),{members:xi}=vr;class rr{constructor(n=[]){this._forceNewSegmentOnNextPrepare=!1,this.segments=n}prepareSegment(n,c,d,m){const b=this.segments[this.segments.length-1];return n>rr.MAX_VERTEX_ARRAY_LENGTH&&hr(`Max vertices per segment is ${rr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${n}. Consider using the \`fillLargeMeshArrays\` function if you require meshes with more than ${rr.MAX_VERTEX_ARRAY_LENGTH} vertices.`),this._forceNewSegmentOnNextPrepare||!b||b.vertexLength+n>rr.MAX_VERTEX_ARRAY_LENGTH||b.sortKey!==m?this.createNewSegment(c,d,m):b}createNewSegment(n,c,d){const m={vertexOffset:n.length,primitiveOffset:c.length,vertexLength:0,primitiveLength:0,vaos:{}};return d!==void 0&&(m.sortKey=d),this._forceNewSegmentOnNextPrepare=!1,this.segments.push(m),m}getOrCreateLatestSegment(n,c,d){return this.prepareSegment(0,n,c,d)}forceNewSegmentOnNextPrepare(){this._forceNewSegmentOnNextPrepare=!0}get(){return this.segments}destroy(){for(const n of this.segments)for(const c in n.vaos)n.vaos[c].destroy()}static simpleSegment(n,c,d,m){return new rr([{vertexOffset:n,primitiveOffset:c,vertexLength:d,primitiveLength:m,vaos:{},sortKey:0}])}}function hi(h,n){return 256*(h=kt(Math.floor(h),0,255))+kt(Math.floor(n),0,255)}rr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,ht("SegmentVector",rr);const wi=$r([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var ds,fs,ps,Dn={exports:{}},ga={exports:{}},ma={exports:{}},bo=function(){if(ps)return Dn.exports;ps=1;var h=(ds||(ds=1,ga.exports=function(c,d){var m,b,v,w,A,P,R,D;for(b=c.length-(m=3&c.length),v=d,A=3432918353,P=461845907,D=0;D<b;)R=255&c.charCodeAt(D)|(255&c.charCodeAt(++D))<<8|(255&c.charCodeAt(++D))<<16|(255&c.charCodeAt(++D))<<24,++D,v=27492+(65535&(w=5*(65535&(v=(v^=R=(65535&(R=(R=(65535&R)*A+(((R>>>16)*A&65535)<<16)&4294967295)<<15|R>>>17))*P+(((R>>>16)*P&65535)<<16)&4294967295)<<13|v>>>19))+((5*(v>>>16)&65535)<<16)&4294967295))+((58964+(w>>>16)&65535)<<16);switch(R=0,m){case 3:R^=(255&c.charCodeAt(D+2))<<16;case 2:R^=(255&c.charCodeAt(D+1))<<8;case 1:v^=R=(65535&(R=(R=(65535&(R^=255&c.charCodeAt(D)))*A+(((R>>>16)*A&65535)<<16)&4294967295)<<15|R>>>17))*P+(((R>>>16)*P&65535)<<16)&4294967295}return v^=c.length,v=2246822507*(65535&(v^=v>>>16))+((2246822507*(v>>>16)&65535)<<16)&4294967295,v=3266489909*(65535&(v^=v>>>13))+((3266489909*(v>>>16)&65535)<<16)&4294967295,(v^=v>>>16)>>>0}),ga.exports),n=(fs||(fs=1,ma.exports=function(c,d){for(var m,b=c.length,v=d^b,w=0;b>=4;)m=1540483477*(65535&(m=255&c.charCodeAt(w)|(255&c.charCodeAt(++w))<<8|(255&c.charCodeAt(++w))<<16|(255&c.charCodeAt(++w))<<24))+((1540483477*(m>>>16)&65535)<<16),v=1540483477*(65535&v)+((1540483477*(v>>>16)&65535)<<16)^(m=1540483477*(65535&(m^=m>>>24))+((1540483477*(m>>>16)&65535)<<16)),b-=4,++w;switch(b){case 3:v^=(255&c.charCodeAt(w+2))<<16;case 2:v^=(255&c.charCodeAt(w+1))<<8;case 1:v=1540483477*(65535&(v^=255&c.charCodeAt(w)))+((1540483477*(v>>>16)&65535)<<16)}return v=1540483477*(65535&(v^=v>>>13))+((1540483477*(v>>>16)&65535)<<16),(v^=v>>>15)>>>0}),ma.exports);return Dn.exports=h,Dn.exports.murmur3=h,Dn.exports.murmur2=n,Dn.exports}(),Yi=T(bo);class _n{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(n,c,d,m){this.ids.push(gs(n)),this.positions.push(c,d,m)}getPositions(n){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const c=gs(n);let d=0,m=this.ids.length-1;for(;d<m;){const v=d+m>>1;this.ids[v]>=c?m=v:d=v+1}const b=[];for(;this.ids[d]===c;)b.push({index:this.positions[3*d],start:this.positions[3*d+1],end:this.positions[3*d+2]}),d++;return b}static serialize(n,c){const d=new Float64Array(n.ids),m=new Uint32Array(n.positions);return zs(d,m,0,d.length-1),c&&c.push(d.buffer,m.buffer),{ids:d,positions:m}}static deserialize(n){const c=new _n;return c.ids=n.ids,c.positions=n.positions,c.indexed=!0,c}}function gs(h){const n=+h;return!isNaN(n)&&n<=Number.MAX_SAFE_INTEGER?n:Yi(String(h))}function zs(h,n,c,d){for(;c<d;){const m=h[c+d>>1];let b=c-1,v=d+1;for(;;){do b++;while(h[b]<m);do v--;while(h[v]>m);if(b>=v)break;Hr(h,b,v),Hr(n,3*b,3*v),Hr(n,3*b+1,3*v+1),Hr(n,3*b+2,3*v+2)}v-c<d-v?(zs(h,n,c,v),c=v+1):(zs(h,n,v+1,d),d=v)}}function Hr(h,n,c){const d=h[n];h[n]=h[c],h[c]=d}ht("FeaturePositionMap",_n);class Ar{constructor(n,c){this.gl=n.gl,this.location=c}}class $i extends Ar{constructor(n,c){super(n,c),this.current=0}set(n){this.current!==n&&(this.current=n,this.gl.uniform1f(this.location,n))}}class ii extends Ar{constructor(n,c){super(n,c),this.current=[0,0,0,0]}set(n){n[0]===this.current[0]&&n[1]===this.current[1]&&n[2]===this.current[2]&&n[3]===this.current[3]||(this.current=n,this.gl.uniform4f(this.location,n[0],n[1],n[2],n[3]))}}class Gu extends Ar{constructor(n,c){super(n,c),this.current=Xt.transparent}set(n){n.r===this.current.r&&n.g===this.current.g&&n.b===this.current.b&&n.a===this.current.a||(this.current=n,this.gl.uniform4f(this.location,n.r,n.g,n.b,n.a))}}const Hf=new Float32Array(16);function sh(h){return[hi(255*h.r,255*h.g),hi(255*h.b,255*h.a)]}class _a{constructor(n,c,d){this.value=n,this.uniformNames=c.map(m=>`u_${m}`),this.type=d}setUniform(n,c,d){n.set(d.constantOr(this.value))}getBinding(n,c,d){return this.type==="color"?new Gu(n,c):new $i(n,c)}}class vo{constructor(n,c){this.uniformNames=c.map(d=>`u_${d}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(n,c){this.pixelRatioFrom=c.pixelRatio,this.pixelRatioTo=n.pixelRatio,this.patternFrom=c.tlbr,this.patternTo=n.tlbr}setUniform(n,c,d,m){const b=m==="u_pattern_to"?this.patternTo:m==="u_pattern_from"?this.patternFrom:m==="u_pixel_ratio_to"?this.pixelRatioTo:m==="u_pixel_ratio_from"?this.pixelRatioFrom:null;b&&n.set(b)}getBinding(n,c,d){return d.substr(0,9)==="u_pattern"?new ii(n,c):new $i(n,c)}}class Zn{constructor(n,c,d,m){this.expression=n,this.type=d,this.maxValue=0,this.paintVertexAttributes=c.map(b=>({name:`a_${b}`,type:"Float32",components:d==="color"?2:1,offset:0})),this.paintVertexArray=new m}populatePaintArray(n,c,d,m,b){const v=this.paintVertexArray.length,w=this.expression.evaluate(new Rr(0),c,{},m,[],b);this.paintVertexArray.resize(n),this._setPaintValue(v,n,w)}updatePaintArray(n,c,d,m){const b=this.expression.evaluate({zoom:0},d,m);this._setPaintValue(n,c,b)}_setPaintValue(n,c,d){if(this.type==="color"){const m=sh(d);for(let b=n;b<c;b++)this.paintVertexArray.emplace(b,m[0],m[1])}else{for(let m=n;m<c;m++)this.paintVertexArray.emplace(m,d);this.maxValue=Math.max(this.maxValue,Math.abs(d))}}upload(n){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=n.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ti{constructor(n,c,d,m,b,v){this.expression=n,this.uniformNames=c.map(w=>`u_${w}_t`),this.type=d,this.useIntegerZoom=m,this.zoom=b,this.maxValue=0,this.paintVertexAttributes=c.map(w=>({name:`a_${w}`,type:"Float32",components:d==="color"?4:2,offset:0})),this.paintVertexArray=new v}populatePaintArray(n,c,d,m,b){const v=this.expression.evaluate(new Rr(this.zoom),c,{},m,[],b),w=this.expression.evaluate(new Rr(this.zoom+1),c,{},m,[],b),A=this.paintVertexArray.length;this.paintVertexArray.resize(n),this._setPaintValue(A,n,v,w)}updatePaintArray(n,c,d,m){const b=this.expression.evaluate({zoom:this.zoom},d,m),v=this.expression.evaluate({zoom:this.zoom+1},d,m);this._setPaintValue(n,c,b,v)}_setPaintValue(n,c,d,m){if(this.type==="color"){const b=sh(d),v=sh(m);for(let w=n;w<c;w++)this.paintVertexArray.emplace(w,b[0],b[1],v[0],v[1])}else{for(let b=n;b<c;b++)this.paintVertexArray.emplace(b,d,m);this.maxValue=Math.max(this.maxValue,Math.abs(d),Math.abs(m))}}upload(n){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=n.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(n,c){const d=this.useIntegerZoom?Math.floor(c.zoom):c.zoom,m=kt(this.expression.interpolationFactor(d,this.zoom,this.zoom+1),0,1);n.set(m)}getBinding(n,c,d){return new $i(n,c)}}class Xn{constructor(n,c,d,m,b,v){this.expression=n,this.type=c,this.useIntegerZoom=d,this.zoom=m,this.layerId=v,this.zoomInPaintVertexArray=new b,this.zoomOutPaintVertexArray=new b}populatePaintArray(n,c,d){const m=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(n),this.zoomOutPaintVertexArray.resize(n),this._setPaintValues(m,n,c.patterns&&c.patterns[this.layerId],d)}updatePaintArray(n,c,d,m,b){this._setPaintValues(n,c,d.patterns&&d.patterns[this.layerId],b)}_setPaintValues(n,c,d,m){if(!m||!d)return;const{min:b,mid:v,max:w}=d,A=m[b],P=m[v],R=m[w];if(A&&P&&R)for(let D=n;D<c;D++)this.zoomInPaintVertexArray.emplace(D,P.tl[0],P.tl[1],P.br[0],P.br[1],A.tl[0],A.tl[1],A.br[0],A.br[1],P.pixelRatio,A.pixelRatio),this.zoomOutPaintVertexArray.emplace(D,P.tl[0],P.tl[1],P.br[0],P.br[1],R.tl[0],R.tl[1],R.br[0],R.br[1],P.pixelRatio,R.pixelRatio)}upload(n){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=n.createVertexBuffer(this.zoomInPaintVertexArray,wi.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=n.createVertexBuffer(this.zoomOutPaintVertexArray,wi.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class oh{constructor(n,c,d){this.binders={},this._buffers=[];const m=[];for(const b in n.paint._values){if(!d(b))continue;const v=n.paint.get(b);if(!(v instanceof kn&&oo(v.property.specification)))continue;const w=ah(b,n.type),A=v.value,P=v.property.specification.type,R=v.property.useIntegerZoom,D=v.property.specification["property-type"],L=D==="cross-faded"||D==="cross-faded-data-driven";if(A.kind==="constant")this.binders[b]=L?new vo(A.value,w):new _a(A.value,w,P),m.push(`/u_${b}`);else if(A.kind==="source"||L){const U=lh(b,P,"source");this.binders[b]=L?new Xn(A,P,R,c,U,n.id):new Zn(A,w,P,U),m.push(`/a_${b}`)}else{const U=lh(b,P,"composite");this.binders[b]=new Ti(A,w,P,R,c,U),m.push(`/z_${b}`)}}this.cacheKey=m.sort().join("")}getMaxValue(n){const c=this.binders[n];return c instanceof Zn||c instanceof Ti?c.maxValue:0}populatePaintArrays(n,c,d,m,b){for(const v in this.binders){const w=this.binders[v];(w instanceof Zn||w instanceof Ti||w instanceof Xn)&&w.populatePaintArray(n,c,d,m,b)}}setConstantPatternPositions(n,c){for(const d in this.binders){const m=this.binders[d];m instanceof vo&&m.setConstantPatternPositions(n,c)}}updatePaintArrays(n,c,d,m,b){let v=!1;for(const w in n){const A=c.getPositions(w);for(const P of A){const R=d.feature(P.index);for(const D in this.binders){const L=this.binders[D];if((L instanceof Zn||L instanceof Ti||L instanceof Xn)&&L.expression.isStateDependent===!0){const U=m.paint.get(D);L.expression=U.value,L.updatePaintArray(P.start,P.end,R,n[w],b),v=!0}}}}return v}defines(){const n=[];for(const c in this.binders){const d=this.binders[c];(d instanceof _a||d instanceof vo)&&n.push(...d.uniformNames.map(m=>`#define HAS_UNIFORM_${m}`))}return n}getBinderAttributes(){const n=[];for(const c in this.binders){const d=this.binders[c];if(d instanceof Zn||d instanceof Ti)for(let m=0;m<d.paintVertexAttributes.length;m++)n.push(d.paintVertexAttributes[m].name);else if(d instanceof Xn)for(let m=0;m<wi.members.length;m++)n.push(wi.members[m].name)}return n}getBinderUniforms(){const n=[];for(const c in this.binders){const d=this.binders[c];if(d instanceof _a||d instanceof vo||d instanceof Ti)for(const m of d.uniformNames)n.push(m)}return n}getPaintVertexBuffers(){return this._buffers}getUniforms(n,c){const d=[];for(const m in this.binders){const b=this.binders[m];if(b instanceof _a||b instanceof vo||b instanceof Ti){for(const v of b.uniformNames)if(c[v]){const w=b.getBinding(n,c[v],v);d.push({name:v,property:m,binding:w})}}}return d}setUniforms(n,c,d,m){for(const{name:b,property:v,binding:w}of c)this.binders[v].setUniform(w,m,d.get(v),b)}updatePaintBuffers(n){this._buffers=[];for(const c in this.binders){const d=this.binders[c];if(n&&d instanceof Xn){const m=n.fromScale===2?d.zoomInPaintVertexBuffer:d.zoomOutPaintVertexBuffer;m&&this._buffers.push(m)}else(d instanceof Zn||d instanceof Ti)&&d.paintVertexBuffer&&this._buffers.push(d.paintVertexBuffer)}}upload(n){for(const c in this.binders){const d=this.binders[c];(d instanceof Zn||d instanceof Ti||d instanceof Xn)&&d.upload(n)}this.updatePaintBuffers()}destroy(){for(const n in this.binders){const c=this.binders[n];(c instanceof Zn||c instanceof Ti||c instanceof Xn)&&c.destroy()}}}class ms{constructor(n,c,d=()=>!0){this.programConfigurations={};for(const m of n)this.programConfigurations[m.id]=new oh(m,c,d);this.needsUpload=!1,this._featureMap=new _n,this._bufferOffset=0}populatePaintArrays(n,c,d,m,b,v){for(const w in this.programConfigurations)this.programConfigurations[w].populatePaintArrays(n,c,m,b,v);c.id!==void 0&&this._featureMap.add(c.id,d,this._bufferOffset,n),this._bufferOffset=n,this.needsUpload=!0}updatePaintArrays(n,c,d,m){for(const b of d)this.needsUpload=this.programConfigurations[b.id].updatePaintArrays(n,this._featureMap,c,b,m)||this.needsUpload}get(n){return this.programConfigurations[n]}upload(n){if(this.needsUpload){for(const c in this.programConfigurations)this.programConfigurations[c].upload(n);this.needsUpload=!1}}destroy(){for(const n in this.programConfigurations)this.programConfigurations[n].destroy()}}function ah(h,n){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[h]||[h.replace(`${n}-`,"").replace(/-/g,"_")]}function lh(h,n,c){const d={color:{source:pa,composite:N},number:{source:I,composite:pa}},m=function(b){return{"line-pattern":{source:ft,composite:ft},"fill-pattern":{source:ft,composite:ft},"fill-extrusion-pattern":{source:ft,composite:ft}}[b]}(h);return m&&m[c]||d[n][c]}ht("ConstantBinder",_a),ht("CrossFadedConstantBinder",vo),ht("SourceExpressionBinder",Zn),ht("CrossFadedCompositeBinder",Xn),ht("CompositeExpressionBinder",Ti),ht("ProgramConfiguration",oh,{omit:["_buffers"]}),ht("ProgramConfigurationSet",ms);const ya=Math.pow(2,14)-1,jm=-ya-1;function ba(h){const n=yt/h.extent,c=h.loadGeometry();for(let d=0;d<c.length;d++){const m=c[d];for(let b=0;b<m.length;b++){const v=m[b],w=Math.round(v.x*n),A=Math.round(v.y*n);v.x=kt(w,jm,ya),v.y=kt(A,jm,ya),(w<v.x||w>v.x+1||A<v.y||A>v.y+1)&&hr("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return c}function va(h,n){return{type:h.type,id:h.id,properties:h.properties,geometry:n?ba(h):[]}}const $m=-32768;function uw(h,n,c,d,m){h.emplaceBack($m+8*n+d,$m+8*c+m)}class Zf{constructor(n){this.zoom=n.zoom,this.globalState=n.globalState,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(c=>c.id),this.index=n.index,this.hasPattern=!1,this.layoutVertexArray=new Me,this.indexArray=new br,this.segments=new rr,this.programConfigurations=new ms(n.layers,n.zoom),this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(n,c,d){const m=this.layers[0],b=[];let v=null,w=!1,A=m.type==="heatmap";if(m.type==="circle"){const R=m;v=R.layout.get("circle-sort-key"),w=!v.isConstant(),A=A||R.paint.get("circle-pitch-alignment")==="map"}const P=A?c.subdivisionGranularity.circle:1;for(const{feature:R,id:D,index:L,sourceLayerIndex:U}of n){const j=this.layers[0]._featureFilter.needGeometry,H=va(R,j);if(!this.layers[0]._featureFilter.filter(new Rr(this.zoom,{globalState:this.globalState}),H,d))continue;const Y=w?v.evaluate(H,{},d):void 0,te={id:D,properties:R.properties,type:R.type,sourceLayerIndex:U,index:L,geometry:j?H.geometry:ba(R),patterns:{},sortKey:Y};b.push(te)}w&&b.sort((R,D)=>R.sortKey-D.sortKey);for(const R of b){const{geometry:D,index:L,sourceLayerIndex:U}=R,j=n[L].feature;this.addFeature(R,D,L,d,P),c.featureIndex.insert(j,D,L,U,this.index)}}update(n,c,d){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(n,c,this.stateDependentLayers,d)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(n){this.uploaded||(this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,xi),this.indexBuffer=n.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(n),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(n,c,d,m,b=1){let v;switch(b){case 1:v=[0,7];break;case 3:v=[0,2,5,7];break;case 5:v=[0,1,3,4,6,7];break;case 7:v=[0,1,2,3,4,5,6,7];break;default:throw new Error(`Invalid circle bucket granularity: ${b}; valid values are 1, 3, 5, 7.`)}const w=v.length;for(const A of c)for(const P of A){const R=P.x,D=P.y;if(R<0||R>=yt||D<0||D>=yt)continue;const L=this.segments.prepareSegment(w*w,this.layoutVertexArray,this.indexArray,n.sortKey),U=L.vertexLength;for(let j=0;j<w;j++)for(let H=0;H<w;H++)uw(this.layoutVertexArray,R,D,v[H],v[j]);for(let j=0;j<w-1;j++)for(let H=0;H<w-1;H++){const Y=U+j*w+H,te=U+(j+1)*w+H;this.indexArray.emplaceBack(Y,te+1,Y+1),this.indexArray.emplaceBack(Y,te,te+1)}L.vertexLength+=w*w,L.primitiveLength+=(w-1)*(w-1)*2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,d,{},m)}}function Wm(h,n){for(let c=0;c<h.length;c++)if(Il(n,h[c]))return!0;for(let c=0;c<n.length;c++)if(Il(h,n[c]))return!0;return!!Xf(h,n)}function dw(h,n,c){return!!Il(h,n)||!!qf(n,h,c)}function Hm(h,n){if(h.length===1)return Xm(n,h[0]);for(let c=0;c<n.length;c++){const d=n[c];for(let m=0;m<d.length;m++)if(Il(h,d[m]))return!0}for(let c=0;c<h.length;c++)if(Xm(n,h[c]))return!0;for(let c=0;c<n.length;c++)if(Xf(h,n[c]))return!0;return!1}function fw(h,n,c){if(h.length>1){if(Xf(h,n))return!0;for(let d=0;d<n.length;d++)if(qf(n[d],h,c))return!0}for(let d=0;d<h.length;d++)if(qf(h[d],n,c))return!0;return!1}function Xf(h,n){if(h.length===0||n.length===0)return!1;for(let c=0;c<h.length-1;c++){const d=h[c],m=h[c+1];for(let b=0;b<n.length-1;b++)if(pw(d,m,n[b],n[b+1]))return!0}return!1}function pw(h,n,c,d){return Ct(h,c,d)!==Ct(n,c,d)&&Ct(h,n,c)!==Ct(h,n,d)}function qf(h,n,c){const d=c*c;if(n.length===1)return h.distSqr(n[0])<d;for(let m=1;m<n.length;m++)if(Zm(h,n[m-1],n[m])<d)return!0;return!1}function Zm(h,n,c){const d=n.distSqr(c);if(d===0)return h.distSqr(n);const m=((h.x-n.x)*(c.x-n.x)+(h.y-n.y)*(c.y-n.y))/d;return h.distSqr(m<0?n:m>1?c:c.sub(n)._mult(m)._add(n))}function Xm(h,n){let c,d,m,b=!1;for(let v=0;v<h.length;v++){c=h[v];for(let w=0,A=c.length-1;w<c.length;A=w++)d=c[w],m=c[A],d.y>n.y!=m.y>n.y&&n.x<(m.x-d.x)*(n.y-d.y)/(m.y-d.y)+d.x&&(b=!b)}return b}function Il(h,n){let c=!1;for(let d=0,m=h.length-1;d<h.length;m=d++){const b=h[d],v=h[m];b.y>n.y!=v.y>n.y&&n.x<(v.x-b.x)*(n.y-b.y)/(v.y-b.y)+b.x&&(c=!c)}return c}function gw(h,n,c){const d=c[0],m=c[2];if(h.x<d.x&&n.x<d.x||h.x>m.x&&n.x>m.x||h.y<d.y&&n.y<d.y||h.y>m.y&&n.y>m.y)return!1;const b=Ct(h,n,c[0]);return b!==Ct(h,n,c[1])||b!==Ct(h,n,c[2])||b!==Ct(h,n,c[3])}function ch(h,n,c){const d=n.paint.get(h).value;return d.kind==="constant"?d.value:c.programConfigurations.get(n.id).getMaxValue(h)}function Ku(h){return Math.sqrt(h[0]*h[0]+h[1]*h[1])}function Ju(h,n,c,d,m){if(!n[0]&&!n[1])return h;const b=ie.convert(n)._mult(m);c==="viewport"&&b._rotate(-d);const v=[];for(let w=0;w<h.length;w++)v.push(h[w].sub(b));return v}let qm,Ym;ht("CircleBucket",Zf,{omit:["layers"]});var mw={get paint(){return Ym=Ym||new ji({"circle-radius":new St(fe.paint_circle["circle-radius"]),"circle-color":new St(fe.paint_circle["circle-color"]),"circle-blur":new St(fe.paint_circle["circle-blur"]),"circle-opacity":new St(fe.paint_circle["circle-opacity"]),"circle-translate":new gt(fe.paint_circle["circle-translate"]),"circle-translate-anchor":new gt(fe.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new gt(fe.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new gt(fe.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new St(fe.paint_circle["circle-stroke-width"]),"circle-stroke-color":new St(fe.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new St(fe.paint_circle["circle-stroke-opacity"])})},get layout(){return qm=qm||new ji({"circle-sort-key":new St(fe.layout_circle["circle-sort-key"])})}};class _w extends vi{constructor(n){super(n,mw)}createBucket(n){return new Zf(n)}queryRadius(n){const c=n;return ch("circle-radius",this,c)+ch("circle-stroke-width",this,c)+Ku(this.paint.get("circle-translate"))}queryIntersectsFeature({queryGeometry:n,feature:c,featureState:d,geometry:m,transform:b,pixelsToTileUnits:v,unwrappedTileID:w,getElevation:A}){const P=Ju(n,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),-b.bearingInRadians,v),R=this.paint.get("circle-radius").evaluate(c,d)+this.paint.get("circle-stroke-width").evaluate(c,d),D=this.paint.get("circle-pitch-alignment")==="map",L=D?P:function(j,H,Y,te){return j.map(ge=>Gm(ge,H,Y,te))}(P,b,w,A),U=D?R*v:R;for(const j of m)for(const H of j){const Y=D?H:Gm(H,b,w,A);let te=U;const ge=b.projectTileCoordinates(H.x,H.y,w,A).signedDistanceFromCamera;if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"?te*=ge/b.cameraToCenterDistance:this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"&&(te*=b.cameraToCenterDistance/ge),dw(L,Y,te))return!0}return!1}}function Gm(h,n,c,d){const m=n.projectTileCoordinates(h.x,h.y,c,d).point;return new ie((.5*m.x+.5)*n.width,(.5*-m.y+.5)*n.height)}class Km extends Zf{}let Jm;ht("HeatmapBucket",Km,{omit:["layers"]});var yw={get paint(){return Jm=Jm||new ji({"heatmap-radius":new St(fe.paint_heatmap["heatmap-radius"]),"heatmap-weight":new St(fe.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new gt(fe.paint_heatmap["heatmap-intensity"]),"heatmap-color":new fa(fe.paint_heatmap["heatmap-color"]),"heatmap-opacity":new gt(fe.paint_heatmap["heatmap-opacity"])})}};function Yf(h,{width:n,height:c},d,m){if(m){if(m instanceof Uint8ClampedArray)m=new Uint8Array(m.buffer);else if(m.length!==n*c*d)throw new RangeError(`mismatched image size. expected: ${m.length} but got: ${n*c*d}`)}else m=new Uint8Array(n*c*d);return h.width=n,h.height=c,h.data=m,h}function Qm(h,{width:n,height:c},d){if(n===h.width&&c===h.height)return;const m=Yf({},{width:n,height:c},d);Gf(h,m,{x:0,y:0},{x:0,y:0},{width:Math.min(h.width,n),height:Math.min(h.height,c)},d),h.width=n,h.height=c,h.data=m.data}function Gf(h,n,c,d,m,b){if(m.width===0||m.height===0)return n;if(m.width>h.width||m.height>h.height||c.x>h.width-m.width||c.y>h.height-m.height)throw new RangeError("out of range source coordinates for image copy");if(m.width>n.width||m.height>n.height||d.x>n.width-m.width||d.y>n.height-m.height)throw new RangeError("out of range destination coordinates for image copy");const v=h.data,w=n.data;if(v===w)throw new Error("srcData equals dstData, so image is already copied");for(let A=0;A<m.height;A++){const P=((c.y+A)*h.width+c.x)*b,R=((d.y+A)*n.width+d.x)*b;for(let D=0;D<m.width*b;D++)w[R+D]=v[P+D]}return n}class hh{constructor(n,c){Yf(this,n,1,c)}resize(n){Qm(this,n,1)}clone(){return new hh({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(n,c,d,m,b){Gf(n,c,d,m,b,1)}}class sn{constructor(n,c){Yf(this,n,4,c)}resize(n){Qm(this,n,4)}replace(n,c){c?this.data.set(n):this.data=n instanceof Uint8ClampedArray?new Uint8Array(n.buffer):n}clone(){return new sn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(n,c,d,m,b){Gf(n,c,d,m,b,4)}setPixel(n,c,d){const m=4*(n*this.width+c);this.data[m+0]=Math.round(255*d.r/d.a),this.data[m+1]=Math.round(255*d.g/d.a),this.data[m+2]=Math.round(255*d.b/d.a),this.data[m+3]=Math.round(255*d.a)}}function e_(h){const n={},c=h.resolution||256,d=h.clips?h.clips.length:1,m=h.image||new sn({width:c,height:d});if(Math.log(c)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${c}`);const b=(v,w,A)=>{n[h.evaluationKey]=A;const P=h.expression.evaluate(n);m.setPixel(v/4/c,w/4,P)};if(h.clips)for(let v=0,w=0;v<d;++v,w+=4*c)for(let A=0,P=0;A<c;A++,P+=4){const R=A/(c-1),{start:D,end:L}=h.clips[v];b(w,P,D*(1-R)+L*R)}else for(let v=0,w=0;v<c;v++,w+=4)b(0,w,v/(c-1));return m}ht("AlphaImage",hh),ht("RGBAImage",sn);const Kf="big-fb";class bw extends vi{createBucket(n){return new Km(n)}constructor(n){super(n,yw),this.heatmapFbos=new Map,this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(n){n==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=e_({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbos.has(Kf)&&this.heatmapFbos.delete(Kf)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let t_;var vw={get paint(){return t_=t_||new ji({"hillshade-illumination-direction":new gt(fe.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-altitude":new gt(fe.paint_hillshade["hillshade-illumination-altitude"]),"hillshade-illumination-anchor":new gt(fe.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new gt(fe.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new gt(fe.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new gt(fe.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new gt(fe.paint_hillshade["hillshade-accent-color"]),"hillshade-method":new gt(fe.paint_hillshade["hillshade-method"])})}};class xw extends vi{constructor(n){super(n,vw),this.recalculate({zoom:0,zoomHistory:{}},void 0)}getIlluminationProperties(){let n=this.paint.get("hillshade-illumination-direction").values,c=this.paint.get("hillshade-illumination-altitude").values,d=this.paint.get("hillshade-highlight-color").values,m=this.paint.get("hillshade-shadow-color").values;const b=Math.max(n.length,c.length,d.length,m.length);n=n.concat(Array(b-n.length).fill(n.at(-1))),c=c.concat(Array(b-c.length).fill(c.at(-1))),d=d.concat(Array(b-d.length).fill(d.at(-1))),m=m.concat(Array(b-m.length).fill(m.at(-1)));const v=c.map(yr);return{directionRadians:n.map(yr),altitudeRadians:v,shadowColor:m,highlightColor:d}}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}let r_;var ww={get paint(){return r_=r_||new ji({"color-relief-opacity":new gt(fe["paint_color-relief"]["color-relief-opacity"]),"color-relief-color":new fa(fe["paint_color-relief"]["color-relief-color"])})}};class Jf{constructor(n,c,d,m){this.context=n,this.format=d,this.texture=n.gl.createTexture(),this.update(c,m)}update(n,c,d){const{width:m,height:b}=n,v=!(this.size&&this.size[0]===m&&this.size[1]===b||d),{context:w}=this,{gl:A}=w;if(this.useMipmap=!!(c&&c.useMipmap),A.bindTexture(A.TEXTURE_2D,this.texture),w.pixelStoreUnpackFlipY.set(!1),w.pixelStoreUnpack.set(1),w.pixelStoreUnpackPremultiplyAlpha.set(this.format===A.RGBA&&(!c||c.premultiply!==!1)),v)this.size=[m,b],n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement||n instanceof ImageData||Ni(n)?A.texImage2D(A.TEXTURE_2D,0,this.format,this.format,A.UNSIGNED_BYTE,n):A.texImage2D(A.TEXTURE_2D,0,this.format,m,b,0,this.format,A.UNSIGNED_BYTE,n.data);else{const{x:P,y:R}=d||{x:0,y:0};n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement||n instanceof ImageData||Ni(n)?A.texSubImage2D(A.TEXTURE_2D,0,P,R,A.RGBA,A.UNSIGNED_BYTE,n):A.texSubImage2D(A.TEXTURE_2D,0,P,R,m,b,A.RGBA,A.UNSIGNED_BYTE,n.data)}this.useMipmap&&this.isSizePowerOfTwo()&&A.generateMipmap(A.TEXTURE_2D),w.pixelStoreUnpackFlipY.setDefault(),w.pixelStoreUnpack.setDefault(),w.pixelStoreUnpackPremultiplyAlpha.setDefault()}bind(n,c,d){const{context:m}=this,{gl:b}=m;b.bindTexture(b.TEXTURE_2D,this.texture),d!==b.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(d=b.LINEAR),n!==this.filter&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,n),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,d||n),this.filter=n),c!==this.wrap&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,c),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,c),this.wrap=c)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}}class i_{constructor(n,c,d,m=1,b=1,v=1,w=0){if(this.uid=n,c.height!==c.width)throw new RangeError("DEM tiles must be square");if(d&&!["mapbox","terrarium","custom"].includes(d))return void hr(`"${d}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=c.height;const A=this.dim=c.height-2;switch(this.data=new Uint32Array(c.data.buffer),d){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=m,this.greenFactor=b,this.blueFactor=v,this.baseShift=w;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let P=0;P<A;P++)this.data[this._idx(-1,P)]=this.data[this._idx(0,P)],this.data[this._idx(A,P)]=this.data[this._idx(A-1,P)],this.data[this._idx(P,-1)]=this.data[this._idx(P,0)],this.data[this._idx(P,A)]=this.data[this._idx(P,A-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(A,-1)]=this.data[this._idx(A-1,0)],this.data[this._idx(-1,A)]=this.data[this._idx(0,A-1)],this.data[this._idx(A,A)]=this.data[this._idx(A-1,A-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let P=0;P<A;P++)for(let R=0;R<A;R++){const D=this.get(P,R);D>this.max&&(this.max=D),D<this.min&&(this.min=D)}}get(n,c){const d=new Uint8Array(this.data.buffer),m=4*this._idx(n,c);return this.unpack(d[m],d[m+1],d[m+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(n,c){if(n<-1||n>=this.dim+1||c<-1||c>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(c+1)*this.stride+(n+1)}unpack(n,c,d){return n*this.redFactor+c*this.greenFactor+d*this.blueFactor-this.baseShift}pack(n){return n_(n,this.getUnpackVector())}getPixels(){return new sn({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(n,c,d){if(this.dim!==n.dim)throw new Error("dem dimension mismatch");let m=c*this.dim,b=c*this.dim+this.dim,v=d*this.dim,w=d*this.dim+this.dim;switch(c){case-1:m=b-1;break;case 1:b=m+1}switch(d){case-1:v=w-1;break;case 1:w=v+1}const A=-c*this.dim,P=-d*this.dim;for(let R=v;R<w;R++)for(let D=m;D<b;D++)this.data[this._idx(D,R)]=n.data[this._idx(D+A,R+P)]}}function n_(h,n){const c=n[0],d=n[1],m=n[2],b=n[3],v=Math.min(c,d,m),w=Math.round((h+b)/v);return{r:Math.floor(w*v/c)%256,g:Math.floor(w*v/d)%256,b:Math.floor(w*v/m)%256}}ht("DEMData",i_);class Tw extends vi{constructor(n){super(n,ww)}_createColorRamp(n){const c={elevationStops:[],colorStops:[]},d=this._transitionablePaint._values["color-relief-color"].value.expression;if(d instanceof ra&&d._styleExpression.expression instanceof Ui){this.colorRampExpression=d;const v=d._styleExpression.expression;c.elevationStops=v.labels,c.colorStops=[];for(const w of c.elevationStops)c.colorStops.push(v.evaluate({globals:{elevation:w}}))}if(c.elevationStops.length<1&&(c.elevationStops=[0],c.colorStops=[Xt.transparent]),c.elevationStops.length<2&&(c.elevationStops.push(c.elevationStops[0]+1),c.colorStops.push(c.colorStops[0])),c.elevationStops.length<=n)return c;const m={elevationStops:[],colorStops:[]},b=(c.elevationStops.length-1)/(n-1);for(let v=0;v<c.elevationStops.length-.5;v+=b)m.elevationStops.push(c.elevationStops[Math.round(v)]),m.colorStops.push(c.colorStops[Math.round(v)]);return hr(`Too many colors in specification of ${this.id} color-relief layer, may not render properly.`),m}_colorRampChanged(){return this.colorRampExpression!=this._transitionablePaint._values["color-relief-color"].value.expression}getColorRampTextures(n,c,d){if(this.colorRampTextures&&!this._colorRampChanged())return this.colorRampTextures;const m=this._createColorRamp(c),b=new sn({width:m.colorStops.length,height:1}),v=new sn({width:m.colorStops.length,height:1});for(let w=0;w<m.elevationStops.length;w++){const A=n_(m.elevationStops[w],d);v.setPixel(0,w,new Xt(A.r/255,A.g/255,A.b/255,1)),b.setPixel(0,w,m.colorStops[w])}return this.colorRampTextures={elevationTexture:new Jf(n,v,n.gl.RGBA),colorTexture:new Jf(n,b,n.gl.RGBA)},this.colorRampTextures}hasOffscreenPass(){return this.visibility!=="none"&&!!this.colorRampTextures}}const Sw=$r([{name:"a_pos",components:2,type:"Int16"}],4),{members:Aw}=Sw;function Qf(h,n,c){const d=c.patternDependencies;let m=!1;for(const b of n){const v=b.paint.get(`${h}-pattern`);v.isConstant()||(m=!0);const w=v.constantOr(null);w&&(m=!0,d[w.to]=!0,d[w.from]=!0)}return m}function ep(h,n,c,d,m){const b=m.patternDependencies;for(const v of n){const w=v.paint.get(`${h}-pattern`).value;if(w.kind!=="constant"){let A=w.evaluate({zoom:d-1},c,{},m.availableImages),P=w.evaluate({zoom:d},c,{},m.availableImages),R=w.evaluate({zoom:d+1},c,{},m.availableImages);A=A&&A.name?A.name:A,P=P&&P.name?P.name:P,R=R&&R.name?R.name:R,b[A]=!0,b[P]=!0,b[R]=!0,c.patterns[v.id]={min:A,mid:P,max:R}}}return c}function s_(h,n,c,d,m){let b;if(m===function(v,w,A,P){let R=0;for(let D=w,L=A-P;D<A;D+=P)R+=(v[L]-v[D])*(v[D+1]+v[L+1]),L=D;return R}(h,n,c,d)>0)for(let v=n;v<c;v+=d)b=c_(v/d|0,h[v],h[v+1],b);else for(let v=c-d;v>=n;v-=d)b=c_(v/d|0,h[v],h[v+1],b);return b&&Cl(b,b.next)&&(ph(b),b=b.next),b}function xa(h,n){if(!h)return h;n||(n=h);let c,d=h;do if(c=!1,d.steiner||!Cl(d,d.next)&&qr(d.prev,d,d.next)!==0)d=d.next;else{if(ph(d),d=n=d.prev,d===d.next)break;c=!0}while(c||d!==n);return n}function uh(h,n,c,d,m,b,v){if(!h)return;!v&&b&&function(A,P,R,D){let L=A;do L.z===0&&(L.z=tp(L.x,L.y,P,R,D)),L.prevZ=L.prev,L.nextZ=L.next,L=L.next;while(L!==A);L.prevZ.nextZ=null,L.prevZ=null,function(U){let j,H=1;do{let Y,te=U;U=null;let ge=null;for(j=0;te;){j++;let le=te,z=0;for(let he=0;he<H&&(z++,le=le.nextZ,le);he++);let q=H;for(;z>0||q>0&&le;)z!==0&&(q===0||!le||te.z<=le.z)?(Y=te,te=te.nextZ,z--):(Y=le,le=le.nextZ,q--),ge?ge.nextZ=Y:U=Y,Y.prevZ=ge,ge=Y;te=le}ge.nextZ=null,H*=2}while(j>1)}(L)}(h,d,m,b);let w=h;for(;h.prev!==h.next;){const A=h.prev,P=h.next;if(b?Iw(h,d,m,b):Ew(h))n.push(A.i,h.i,P.i),ph(h),h=P.next,w=P.next;else if((h=P)===w){v?v===1?uh(h=Cw(xa(h),n),n,c,d,m,b,2):v===2&&Pw(h,n,c,d,m,b):uh(xa(h),n,c,d,m,b,1);break}}}function Ew(h){const n=h.prev,c=h,d=h.next;if(qr(n,c,d)>=0)return!1;const m=n.x,b=c.x,v=d.x,w=n.y,A=c.y,P=d.y,R=Math.min(m,b,v),D=Math.min(w,A,P),L=Math.max(m,b,v),U=Math.max(w,A,P);let j=d.next;for(;j!==n;){if(j.x>=R&&j.x<=L&&j.y>=D&&j.y<=U&&dh(m,w,b,A,v,P,j.x,j.y)&&qr(j.prev,j,j.next)>=0)return!1;j=j.next}return!0}function Iw(h,n,c,d){const m=h.prev,b=h,v=h.next;if(qr(m,b,v)>=0)return!1;const w=m.x,A=b.x,P=v.x,R=m.y,D=b.y,L=v.y,U=Math.min(w,A,P),j=Math.min(R,D,L),H=Math.max(w,A,P),Y=Math.max(R,D,L),te=tp(U,j,n,c,d),ge=tp(H,Y,n,c,d);let le=h.prevZ,z=h.nextZ;for(;le&&le.z>=te&&z&&z.z<=ge;){if(le.x>=U&&le.x<=H&&le.y>=j&&le.y<=Y&&le!==m&&le!==v&&dh(w,R,A,D,P,L,le.x,le.y)&&qr(le.prev,le,le.next)>=0||(le=le.prevZ,z.x>=U&&z.x<=H&&z.y>=j&&z.y<=Y&&z!==m&&z!==v&&dh(w,R,A,D,P,L,z.x,z.y)&&qr(z.prev,z,z.next)>=0))return!1;z=z.nextZ}for(;le&&le.z>=te;){if(le.x>=U&&le.x<=H&&le.y>=j&&le.y<=Y&&le!==m&&le!==v&&dh(w,R,A,D,P,L,le.x,le.y)&&qr(le.prev,le,le.next)>=0)return!1;le=le.prevZ}for(;z&&z.z<=ge;){if(z.x>=U&&z.x<=H&&z.y>=j&&z.y<=Y&&z!==m&&z!==v&&dh(w,R,A,D,P,L,z.x,z.y)&&qr(z.prev,z,z.next)>=0)return!1;z=z.nextZ}return!0}function Cw(h,n){let c=h;do{const d=c.prev,m=c.next.next;!Cl(d,m)&&a_(d,c,c.next,m)&&fh(d,m)&&fh(m,d)&&(n.push(d.i,c.i,m.i),ph(c),ph(c.next),c=h=m),c=c.next}while(c!==h);return xa(c)}function Pw(h,n,c,d,m,b){let v=h;do{let w=v.next.next;for(;w!==v.prev;){if(v.i!==w.i&&Ow(v,w)){let A=l_(v,w);return v=xa(v,v.next),A=xa(A,A.next),uh(v,n,c,d,m,b,0),void uh(A,n,c,d,m,b,0)}w=w.next}v=v.next}while(v!==h)}function Mw(h,n){let c=h.x-n.x;return c===0&&(c=h.y-n.y,c===0)&&(c=(h.next.y-h.y)/(h.next.x-h.x)-(n.next.y-n.y)/(n.next.x-n.x)),c}function Rw(h,n){const c=function(m,b){let v=b;const w=m.x,A=m.y;let P,R=-1/0;if(Cl(m,v))return v;do{if(Cl(m,v.next))return v.next;if(A<=v.y&&A>=v.next.y&&v.next.y!==v.y){const H=v.x+(A-v.y)*(v.next.x-v.x)/(v.next.y-v.y);if(H<=w&&H>R&&(R=H,P=v.x<v.next.x?v:v.next,H===w))return P}v=v.next}while(v!==b);if(!P)return null;const D=P,L=P.x,U=P.y;let j=1/0;v=P;do{if(w>=v.x&&v.x>=L&&w!==v.x&&o_(A<U?w:R,A,L,U,A<U?R:w,A,v.x,v.y)){const H=Math.abs(A-v.y)/(w-v.x);fh(v,m)&&(H<j||H===j&&(v.x>P.x||v.x===P.x&&kw(P,v)))&&(P=v,j=H)}v=v.next}while(v!==D);return P}(h,n);if(!c)return n;const d=l_(c,h);return xa(d,d.next),xa(c,c.next)}function kw(h,n){return qr(h.prev,h,n.prev)<0&&qr(n.next,h,h.next)<0}function tp(h,n,c,d,m){return(h=1431655765&((h=858993459&((h=252645135&((h=16711935&((h=(h-c)*m|0)|h<<8))|h<<4))|h<<2))|h<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-d)*m|0)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function Dw(h){let n=h,c=h;do(n.x<c.x||n.x===c.x&&n.y<c.y)&&(c=n),n=n.next;while(n!==h);return c}function o_(h,n,c,d,m,b,v,w){return(m-v)*(n-w)>=(h-v)*(b-w)&&(h-v)*(d-w)>=(c-v)*(n-w)&&(c-v)*(b-w)>=(m-v)*(d-w)}function dh(h,n,c,d,m,b,v,w){return!(h===v&&n===w)&&o_(h,n,c,d,m,b,v,w)}function Ow(h,n){return h.next.i!==n.i&&h.prev.i!==n.i&&!function(c,d){let m=c;do{if(m.i!==c.i&&m.next.i!==c.i&&m.i!==d.i&&m.next.i!==d.i&&a_(m,m.next,c,d))return!0;m=m.next}while(m!==c);return!1}(h,n)&&(fh(h,n)&&fh(n,h)&&function(c,d){let m=c,b=!1;const v=(c.x+d.x)/2,w=(c.y+d.y)/2;do m.y>w!=m.next.y>w&&m.next.y!==m.y&&v<(m.next.x-m.x)*(w-m.y)/(m.next.y-m.y)+m.x&&(b=!b),m=m.next;while(m!==c);return b}(h,n)&&(qr(h.prev,h,n.prev)||qr(h,n.prev,n))||Cl(h,n)&&qr(h.prev,h,h.next)>0&&qr(n.prev,n,n.next)>0)}function qr(h,n,c){return(n.y-h.y)*(c.x-n.x)-(n.x-h.x)*(c.y-n.y)}function Cl(h,n){return h.x===n.x&&h.y===n.y}function a_(h,n,c,d){const m=ed(qr(h,n,c)),b=ed(qr(h,n,d)),v=ed(qr(c,d,h)),w=ed(qr(c,d,n));return m!==b&&v!==w||!(m!==0||!Qu(h,c,n))||!(b!==0||!Qu(h,d,n))||!(v!==0||!Qu(c,h,d))||!(w!==0||!Qu(c,n,d))}function Qu(h,n,c){return n.x<=Math.max(h.x,c.x)&&n.x>=Math.min(h.x,c.x)&&n.y<=Math.max(h.y,c.y)&&n.y>=Math.min(h.y,c.y)}function ed(h){return h>0?1:h<0?-1:0}function fh(h,n){return qr(h.prev,h,h.next)<0?qr(h,n,h.next)>=0&&qr(h,h.prev,n)>=0:qr(h,n,h.prev)<0||qr(h,h.next,n)<0}function l_(h,n){const c=rp(h.i,h.x,h.y),d=rp(n.i,n.x,n.y),m=h.next,b=n.prev;return h.next=n,n.prev=h,c.next=m,m.prev=c,d.next=c,c.prev=d,b.next=d,d.prev=b,d}function c_(h,n,c,d){const m=rp(h,n,c);return d?(m.next=d.next,m.prev=d,d.next.prev=m,d.next=m):(m.prev=m,m.next=m),m}function ph(h){h.next.prev=h.prev,h.prev.next=h.next,h.prevZ&&(h.prevZ.nextZ=h.nextZ),h.nextZ&&(h.nextZ.prevZ=h.prevZ)}function rp(h,n,c){return{i:h,x:n,y:c,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class Pl{constructor(n,c){if(c>n)throw new Error("Min granularity must not be greater than base granularity.");this._baseZoomGranularity=n,this._minGranularity=c}getGranularityForZoomLevel(n){return Math.max(Math.floor(this._baseZoomGranularity/(1<<n)),this._minGranularity,1)}}class td{constructor(n){this.fill=n.fill,this.line=n.line,this.tile=n.tile,this.stencil=n.stencil,this.circle=n.circle}}td.noSubdivision=new td({fill:new Pl(0,0),line:new Pl(0,0),tile:new Pl(0,0),stencil:new Pl(0,0),circle:1}),ht("SubdivisionGranularityExpression",Pl),ht("SubdivisionGranularitySetting",td);const Ml=-32768,gh=32767;class Fw{constructor(n,c){this._vertexBuffer=[],this._vertexDictionary=new Map,this._used=!1,this._granularity=n,this._granularityCellSize=yt/n,this._canonical=c}_getKey(n,c){return(n+=32768)<<16|c+32768}_vertexToIndex(n,c){if(n<-32768||c<-32768||n>32767||c>32767)throw new Error("Vertex coordinates are out of signed 16 bit integer range.");const d=0|Math.round(n),m=0|Math.round(c),b=this._getKey(d,m);if(this._vertexDictionary.has(b))return this._vertexDictionary.get(b);const v=this._vertexBuffer.length/2;return this._vertexDictionary.set(b,v),this._vertexBuffer.push(d,m),v}_subdivideTrianglesScanline(n){if(this._granularity<2)return function(m,b){const v=[];for(let w=0;w<b.length;w+=3){const A=b[w],P=b[w+1],R=b[w+2],D=m[2*A],L=m[2*A+1];(m[2*P]-D)*(m[2*R+1]-L)-(m[2*P+1]-L)*(m[2*R]-D)>0?(v.push(A),v.push(R),v.push(P)):(v.push(A),v.push(P),v.push(R))}return v}(this._vertexBuffer,n);const c=[],d=n.length;for(let m=0;m<d;m+=3){const b=[n[m+0],n[m+1],n[m+2]],v=[this._vertexBuffer[2*n[m+0]+0],this._vertexBuffer[2*n[m+0]+1],this._vertexBuffer[2*n[m+1]+0],this._vertexBuffer[2*n[m+1]+1],this._vertexBuffer[2*n[m+2]+0],this._vertexBuffer[2*n[m+2]+1]];let w=1/0,A=1/0,P=-1/0,R=-1/0;for(let H=0;H<3;H++){const Y=v[2*H],te=v[2*H+1];w=Math.min(w,Y),P=Math.max(P,Y),A=Math.min(A,te),R=Math.max(R,te)}if(w===P||A===R)continue;const D=Math.floor(w/this._granularityCellSize),L=Math.ceil(P/this._granularityCellSize),U=Math.floor(A/this._granularityCellSize),j=Math.ceil(R/this._granularityCellSize);if(D!==L||U!==j)for(let H=U;H<j;H++){const Y=this._scanlineGenerateVertexRingForCellRow(H,v,b);Bw(this._vertexBuffer,Y,c)}else c.push(...b)}return c}_scanlineGenerateVertexRingForCellRow(n,c,d){const m=n*this._granularityCellSize,b=m+this._granularityCellSize,v=[];for(let w=0;w<3;w++){const A=c[2*w],P=c[2*w+1],R=c[2*(w+1)%6],D=c[(2*(w+1)+1)%6],L=c[2*(w+2)%6],U=c[(2*(w+2)+1)%6],j=R-A,H=D-P,Y=j===0,te=H===0,ge=(m-P)/H,le=(b-P)/H,z=Math.min(ge,le),q=Math.max(ge,le);if(!te&&(z>=1||q<=0)||te&&(P<m||P>b)){D>=m&&D<=b&&v.push(d[(w+1)%3]);continue}!te&&z>0&&v.push(this._vertexToIndex(A+j*z,P+H*z));const he=A+j*Math.max(z,0),Re=A+j*Math.min(q,1);Y||this._generateIntraEdgeVertices(v,A,P,R,D,he,Re),!te&&q<1&&v.push(this._vertexToIndex(A+j*q,P+H*q)),(te||D>=m&&D<=b)&&v.push(d[(w+1)%3]),!te&&(D<=m||D>=b)&&this._generateInterEdgeVertices(v,A,P,R,D,L,U,Re,m,b)}return v}_generateIntraEdgeVertices(n,c,d,m,b,v,w){const A=m-c,P=b-d,R=P===0,D=R?Math.min(c,m):Math.min(v,w),L=R?Math.max(c,m):Math.max(v,w),U=Math.floor(D/this._granularityCellSize)+1,j=Math.ceil(L/this._granularityCellSize)-1;if(R?c<m:v<w)for(let H=U;H<=j;H++){const Y=H*this._granularityCellSize;n.push(this._vertexToIndex(Y,d+P*(Y-c)/A))}else for(let H=j;H>=U;H--){const Y=H*this._granularityCellSize;n.push(this._vertexToIndex(Y,d+P*(Y-c)/A))}}_generateInterEdgeVertices(n,c,d,m,b,v,w,A,P,R){const D=b-d,L=v-m,U=w-b,j=(P-b)/U,H=(R-b)/U,Y=Math.min(j,H),te=Math.max(j,H),ge=m+L*Y;let le=Math.floor(Math.min(ge,A)/this._granularityCellSize)+1,z=Math.ceil(Math.max(ge,A)/this._granularityCellSize)-1,q=A<ge;const he=U===0;if(he&&(w===P||w===R))return;if(he||Y>=1||te<=0){const Xe=d-w,Be=v+(c-v)*Math.min((P-w)/Xe,(R-w)/Xe);le=Math.floor(Math.min(Be,A)/this._granularityCellSize)+1,z=Math.ceil(Math.max(Be,A)/this._granularityCellSize)-1,q=A<Be}const Re=D>0?R:P;if(q)for(let Xe=le;Xe<=z;Xe++)n.push(this._vertexToIndex(Xe*this._granularityCellSize,Re));else for(let Xe=z;Xe>=le;Xe--)n.push(this._vertexToIndex(Xe*this._granularityCellSize,Re))}_generateOutline(n){const c=[];for(const d of n){const m=wa(d,this._granularity,!0),b=this._pointArrayToIndices(m),v=[];for(let w=1;w<b.length;w++)v.push(b[w-1]),v.push(b[w]);c.push(v)}return c}_handlePoles(n){let c=!1,d=!1;this._canonical&&(this._canonical.y===0&&(c=!0),this._canonical.y===(1<<this._canonical.z)-1&&(d=!0)),(c||d)&&this._fillPoles(n,c,d)}_ensureNoPoleVertices(){const n=this._vertexBuffer;for(let c=0;c<n.length;c+=2){const d=n[c+1];d===Ml&&(n[c+1]=-32767),d===gh&&(n[c+1]=32766)}}_generatePoleQuad(n,c,d,m,b,v){m>b!=(v===Ml)?(n.push(c),n.push(d),n.push(this._vertexToIndex(m,v)),n.push(d),n.push(this._vertexToIndex(b,v)),n.push(this._vertexToIndex(m,v))):(n.push(d),n.push(c),n.push(this._vertexToIndex(m,v)),n.push(this._vertexToIndex(b,v)),n.push(d),n.push(this._vertexToIndex(m,v)))}_fillPoles(n,c,d){const m=this._vertexBuffer,b=yt,v=n.length;for(let w=2;w<v;w+=3){const A=n[w-2],P=n[w-1],R=n[w],D=m[2*A],L=m[2*A+1],U=m[2*P],j=m[2*P+1],H=m[2*R],Y=m[2*R+1];c&&(L===0&&j===0&&this._generatePoleQuad(n,A,P,D,U,Ml),j===0&&Y===0&&this._generatePoleQuad(n,P,R,U,H,Ml),Y===0&&L===0&&this._generatePoleQuad(n,R,A,H,D,Ml)),d&&(L===b&&j===b&&this._generatePoleQuad(n,A,P,D,U,gh),j===b&&Y===b&&this._generatePoleQuad(n,P,R,U,H,gh),Y===b&&L===b&&this._generatePoleQuad(n,R,A,H,D,gh))}}_initializeVertices(n){for(let c=0;c<n.length;c+=2)this._vertexToIndex(n[c],n[c+1])}subdividePolygonInternal(n,c){if(this._used)throw new Error("Subdivision: multiple use not allowed.");this._used=!0;const{flattened:d,holeIndices:m}=function(w){const A=[],P=[];for(const R of w)if(R.length!==0){R!==w[0]&&A.push(P.length/2);for(let D=0;D<R.length;D++)P.push(R[D].x),P.push(R[D].y)}return{flattened:P,holeIndices:A}}(n);let b;this._initializeVertices(d);try{const w=function(P,R,D=2){const L=R&&R.length,U=L?R[0]*D:P.length;let j=s_(P,0,U,D,!0);const H=[];if(!j||j.next===j.prev)return H;let Y,te,ge;if(L&&(j=function(le,z,q,he){const Re=[];for(let Xe=0,Be=z.length;Xe<Be;Xe++){const Ve=s_(le,z[Xe]*he,Xe<Be-1?z[Xe+1]*he:le.length,he,!1);Ve===Ve.next&&(Ve.steiner=!0),Re.push(Dw(Ve))}Re.sort(Mw);for(let Xe=0;Xe<Re.length;Xe++)q=Rw(Re[Xe],q);return q}(P,R,j,D)),P.length>80*D){Y=1/0,te=1/0;let le=-1/0,z=-1/0;for(let q=D;q<U;q+=D){const he=P[q],Re=P[q+1];he<Y&&(Y=he),Re<te&&(te=Re),he>le&&(le=he),Re>z&&(z=Re)}ge=Math.max(le-Y,z-te),ge=ge!==0?32767/ge:0}return uh(j,H,D,Y,te,ge,0),H}(d,m),A=this._convertIndices(d,w);b=this._subdivideTrianglesScanline(A)}catch(w){console.error(w)}let v=[];return c&&(v=this._generateOutline(n)),this._ensureNoPoleVertices(),this._handlePoles(b),{verticesFlattened:this._vertexBuffer,indicesTriangles:b,indicesLineList:v}}_convertIndices(n,c){const d=[];for(let m=0;m<c.length;m++)d.push(this._vertexToIndex(n[2*c[m]],n[2*c[m]+1]));return d}_pointArrayToIndices(n){const c=[];for(let d=0;d<n.length;d++){const m=n[d];c.push(this._vertexToIndex(m.x,m.y))}return c}}function h_(h,n,c,d=!0){return new Fw(c,n).subdividePolygonInternal(h,d)}function wa(h,n,c=!1){if(!h||h.length<1)return[];if(h.length<2)return[];const d=h[0],m=h[h.length-1],b=c&&(d.x!==m.x||d.y!==m.y);if(n<2)return b?[...h,h[0]]:[...h];const v=Math.floor(yt/n),w=[];w.push(new ie(h[0].x,h[0].y));const A=h.length,P=b?A:A-1;for(let R=0;R<P;R++){const D=h[R],L=R<A-1?h[R+1]:h[0],U=D.x,j=D.y,H=L.x,Y=L.y,te=U!==H,ge=j!==Y;if(!te&&!ge)continue;const le=H-U,z=Y-j,q=Math.abs(le),he=Math.abs(z);let Re=U,Xe=j;for(;;){const Ve=le>0?(Math.floor(Re/v)+1)*v:(Math.ceil(Re/v)-1)*v,Je=z>0?(Math.floor(Xe/v)+1)*v:(Math.ceil(Xe/v)-1)*v,Ye=Math.abs(Re-Ve),tt=Math.abs(Xe-Je),We=Math.abs(Re-H),pt=Math.abs(Xe-Y),wt=te?Ye/q:Number.POSITIVE_INFINITY,xt=ge?tt/he:Number.POSITIVE_INFINITY;if((We<=Ye||!te)&&(pt<=tt||!ge))break;if(wt<xt&&te||!ge){Re=Ve,Xe+=z*wt;const _t=new ie(Re,Math.round(Xe));w[w.length-1].x===_t.x&&w[w.length-1].y===_t.y||w.push(_t)}else{Re+=le*xt,Xe=Je;const _t=new ie(Math.round(Re),Xe);w[w.length-1].x===_t.x&&w[w.length-1].y===_t.y||w.push(_t)}}const Be=new ie(H,Y);w[w.length-1].x===Be.x&&w[w.length-1].y===Be.y||w.push(Be)}return w}function Bw(h,n,c){if(n.length===0)throw new Error("Subdivision vertex ring is empty.");let d=0,m=h[2*n[0]];for(let A=1;A<n.length;A++){const P=h[2*n[A]];P<m&&(m=P,d=A)}const b=n.length;let v=d,w=(v+1)%b;for(;;){const A=v-1>=0?v-1:b-1,P=(w+1)%b,R=h[2*n[A]],D=h[2*n[P]],L=h[2*n[v]],U=h[2*n[v]+1],j=h[2*n[w]+1];let H=!1;if(R<D)H=!0;else if(R>D)H=!1;else{const Y=j-U,te=-(h[2*n[w]]-L),ge=U<j?1:-1;((R-L)*Y+(h[2*n[A]+1]-U)*te)*ge>((D-L)*Y+(h[2*n[P]+1]-U)*te)*ge&&(H=!0)}if(H){const Y=n[A],te=n[v],ge=n[w];Y!==te&&Y!==ge&&te!==ge&&c.push(ge,te,Y),v--,v<0&&(v=b-1)}else{const Y=n[P],te=n[v],ge=n[w];Y!==te&&Y!==ge&&te!==ge&&c.push(ge,te,Y),w++,w>=b&&(w=0)}if(A===P)break}}function u_(h,n,c,d,m,b,v,w,A){const P=m.length/2,R=v&&w&&A;if(P<rr.MAX_VERTEX_ARRAY_LENGTH){const D=n.prepareSegment(P,c,d),L=D.vertexLength;for(let H=0;H<b.length;H+=3)d.emplaceBack(L+b[H],L+b[H+1],L+b[H+2]);let U,j;D.vertexLength+=P,D.primitiveLength+=b.length/3,R&&(j=v.prepareSegment(P,c,w),U=j.vertexLength,j.vertexLength+=P);for(let H=0;H<m.length;H+=2)h(m[H],m[H+1]);if(R)for(let H=0;H<A.length;H++){const Y=A[H];for(let te=1;te<Y.length;te+=2)w.emplaceBack(U+Y[te-1],U+Y[te]);j.primitiveLength+=Y.length/2}}else(function(D,L,U,j,H,Y){const te=[];for(let he=0;he<j.length/2;he++)te.push(-1);const ge={count:0};let le=0,z=D.getOrCreateLatestSegment(L,U),q=z.vertexLength;for(let he=2;he<H.length;he+=3){const Re=H[he-2],Xe=H[he-1],Be=H[he];let Ve=te[Re]<le,Je=te[Xe]<le,Ye=te[Be]<le;z.vertexLength+((Ve?1:0)+(Je?1:0)+(Ye?1:0))>rr.MAX_VERTEX_ARRAY_LENGTH&&(z=D.createNewSegment(L,U),le=ge.count,Ve=!0,Je=!0,Ye=!0,q=0);const tt=mh(te,j,Y,ge,Re,Ve,z),We=mh(te,j,Y,ge,Xe,Je,z),pt=mh(te,j,Y,ge,Be,Ye,z);U.emplaceBack(q+tt-le,q+We-le,q+pt-le),z.primitiveLength++}})(n,c,d,m,b,h),R&&function(D,L,U,j,H,Y){const te=[];for(let he=0;he<j.length/2;he++)te.push(-1);const ge={count:0};let le=0,z=D.getOrCreateLatestSegment(L,U),q=z.vertexLength;for(let he=0;he<H.length;he++){const Re=H[he];for(let Xe=1;Xe<H[he].length;Xe+=2){const Be=Re[Xe-1],Ve=Re[Xe];let Je=te[Be]<le,Ye=te[Ve]<le;z.vertexLength+((Je?1:0)+(Ye?1:0))>rr.MAX_VERTEX_ARRAY_LENGTH&&(z=D.createNewSegment(L,U),le=ge.count,Je=!0,Ye=!0,q=0);const tt=mh(te,j,Y,ge,Be,Je,z),We=mh(te,j,Y,ge,Ve,Ye,z);U.emplaceBack(q+tt-le,q+We-le),z.primitiveLength++}}}(v,c,w,m,A,h),n.forceNewSegmentOnNextPrepare(),v?.forceNewSegmentOnNextPrepare()}function mh(h,n,c,d,m,b,v){if(b){const w=d.count;return c(n[2*m],n[2*m+1]),h[m]=d.count,d.count++,v.vertexLength++,w}return h[m]}class ip{constructor(n){this.zoom=n.zoom,this.globalState=n.globalState,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(c=>c.id),this.index=n.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Fe,this.indexArray=new br,this.indexArray2=new dr,this.programConfigurations=new ms(n.layers,n.zoom),this.segments=new rr,this.segments2=new rr,this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(n,c,d){this.hasPattern=Qf("fill",this.layers,c);const m=this.layers[0].layout.get("fill-sort-key"),b=!m.isConstant(),v=[];for(const{feature:w,id:A,index:P,sourceLayerIndex:R}of n){const D=this.layers[0]._featureFilter.needGeometry,L=va(w,D);if(!this.layers[0]._featureFilter.filter(new Rr(this.zoom,{globalState:this.globalState}),L,d))continue;const U=b?m.evaluate(L,{},d,c.availableImages):void 0,j={id:A,properties:w.properties,type:w.type,sourceLayerIndex:R,index:P,geometry:D?L.geometry:ba(w),patterns:{},sortKey:U};v.push(j)}b&&v.sort((w,A)=>w.sortKey-A.sortKey);for(const w of v){const{geometry:A,index:P,sourceLayerIndex:R}=w;if(this.hasPattern){const D=ep("fill",this.layers,w,this.zoom,c);this.patternFeatures.push(D)}else this.addFeature(w,A,P,d,{},c.subdivisionGranularity);c.featureIndex.insert(n[P].feature,A,P,R,this.index)}}update(n,c,d){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(n,c,this.stateDependentLayers,d)}addFeatures(n,c,d){for(const m of this.patternFeatures)this.addFeature(m,m.geometry,m.index,c,d,n.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(n){this.uploaded||(this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,Aw),this.indexBuffer=n.createIndexBuffer(this.indexArray),this.indexBuffer2=n.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(n),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(n,c,d,m,b,v){for(const w of tl(c,500)){const A=h_(w,m,v.fill.getGranularityForZoomLevel(m.z)),P=this.layoutVertexArray;u_((R,D)=>{P.emplaceBack(R,D)},this.segments,this.layoutVertexArray,this.indexArray,A.verticesFlattened,A.indicesTriangles,this.segments2,this.indexArray2,A.indicesLineList)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,d,b,m)}}let d_,f_;ht("FillBucket",ip,{omit:["layers","patternFeatures"]});var Lw={get paint(){return f_=f_||new ji({"fill-antialias":new gt(fe.paint_fill["fill-antialias"]),"fill-opacity":new St(fe.paint_fill["fill-opacity"]),"fill-color":new St(fe.paint_fill["fill-color"]),"fill-outline-color":new St(fe.paint_fill["fill-outline-color"]),"fill-translate":new gt(fe.paint_fill["fill-translate"]),"fill-translate-anchor":new gt(fe.paint_fill["fill-translate-anchor"]),"fill-pattern":new Sl(fe.paint_fill["fill-pattern"])})},get layout(){return d_=d_||new ji({"fill-sort-key":new St(fe.layout_fill["fill-sort-key"])})}};class Nw extends vi{constructor(n){super(n,Lw)}recalculate(n,c){super.recalculate(n,c);const d=this.paint._values["fill-outline-color"];d.value.kind==="constant"&&d.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(n){return new ip(n)}queryRadius(){return Ku(this.paint.get("fill-translate"))}queryIntersectsFeature({queryGeometry:n,geometry:c,transform:d,pixelsToTileUnits:m}){return Hm(Ju(n,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),-d.bearingInRadians,m),c)}isTileClipped(){return!0}}const zw=$r([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),Uw=$r([{name:"a_centroid",components:2,type:"Int16"}],4),{members:Vw}=zw;var np,p_,sp,g_,op,m_,__,rd={};function y_(){if(p_)return np;p_=1;var h=O();function n(m,b,v,w,A){this.properties={},this.extent=v,this.type=0,this._pbf=m,this._geometry=-1,this._keys=w,this._values=A,m.readFields(c,this,b)}function c(m,b,v){m==1?b.id=v.readVarint():m==2?function(w,A){for(var P=w.readVarint()+w.pos;w.pos<P;){var R=A._keys[w.readVarint()],D=A._values[w.readVarint()];A.properties[R]=D}}(v,b):m==3?b.type=v.readVarint():m==4&&(b._geometry=v.pos)}function d(m){for(var b,v,w=0,A=0,P=m.length,R=P-1;A<P;R=A++)w+=((v=m[R]).x-(b=m[A]).x)*(b.y+v.y);return w}return np=n,n.types=["Unknown","Point","LineString","Polygon"],n.prototype.loadGeometry=function(){var m=this._pbf;m.pos=this._geometry;for(var b,v=m.readVarint()+m.pos,w=1,A=0,P=0,R=0,D=[];m.pos<v;){if(A<=0){var L=m.readVarint();w=7&L,A=L>>3}if(A--,w===1||w===2)P+=m.readSVarint(),R+=m.readSVarint(),w===1&&(b&&D.push(b),b=[]),b.push(new h(P,R));else{if(w!==7)throw new Error("unknown command "+w);b&&b.push(b[0].clone())}}return b&&D.push(b),D},n.prototype.bbox=function(){var m=this._pbf;m.pos=this._geometry;for(var b=m.readVarint()+m.pos,v=1,w=0,A=0,P=0,R=1/0,D=-1/0,L=1/0,U=-1/0;m.pos<b;){if(w<=0){var j=m.readVarint();v=7&j,w=j>>3}if(w--,v===1||v===2)(A+=m.readSVarint())<R&&(R=A),A>D&&(D=A),(P+=m.readSVarint())<L&&(L=P),P>U&&(U=P);else if(v!==7)throw new Error("unknown command "+v)}return[R,L,D,U]},n.prototype.toGeoJSON=function(m,b,v){var w,A,P=this.extent*Math.pow(2,v),R=this.extent*m,D=this.extent*b,L=this.loadGeometry(),U=n.types[this.type];function j(te){for(var ge=0;ge<te.length;ge++){var le=te[ge];te[ge]=[360*(le.x+R)/P-180,360/Math.PI*Math.atan(Math.exp((180-360*(le.y+D)/P)*Math.PI/180))-90]}}switch(this.type){case 1:var H=[];for(w=0;w<L.length;w++)H[w]=L[w][0];j(L=H);break;case 2:for(w=0;w<L.length;w++)j(L[w]);break;case 3:for(L=function(te){var ge=te.length;if(ge<=1)return[te];for(var le,z,q=[],he=0;he<ge;he++){var Re=d(te[he]);Re!==0&&(z===void 0&&(z=Re<0),z===Re<0?(le&&q.push(le),le=[te[he]]):le.push(te[he]))}return le&&q.push(le),q}(L),w=0;w<L.length;w++)for(A=0;A<L[w].length;A++)j(L[w][A])}L.length===1?L=L[0]:U="Multi"+U;var Y={type:"Feature",geometry:{type:U,coordinates:L},properties:this.properties};return"id"in this&&(Y.id=this.id),Y},np}function b_(){if(g_)return sp;g_=1;var h=y_();function n(d,m){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=d,this._keys=[],this._values=[],this._features=[],d.readFields(c,this,m),this.length=this._features.length}function c(d,m,b){d===15?m.version=b.readVarint():d===1?m.name=b.readString():d===5?m.extent=b.readVarint():d===2?m._features.push(b.pos):d===3?m._keys.push(b.readString()):d===4&&m._values.push(function(v){for(var w=null,A=v.readVarint()+v.pos;v.pos<A;){var P=v.readVarint()>>3;w=P===1?v.readString():P===2?v.readFloat():P===3?v.readDouble():P===4?v.readVarint64():P===5?v.readVarint():P===6?v.readSVarint():P===7?v.readBoolean():null}return w}(b))}return sp=n,n.prototype.feature=function(d){if(d<0||d>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[d];var m=this._pbf.readVarint()+this._pbf.pos;return new h(this._pbf,m,this.extent,this._keys,this._values)},sp}function v_(){return __||(__=1,rd.VectorTile=function(){if(m_)return op;m_=1;var h=b_();function n(c,d,m){if(c===3){var b=new h(m,m.readVarint()+m.pos);b.length&&(d[b.name]=b)}}return op=function(c,d){this.layers=c.readFields(n,{},d)},op}(),rd.VectorTileFeature=y_(),rd.VectorTileLayer=b_()),rd}var _h=T(v_());const jw=_h.VectorTileFeature.types,ap=Math.pow(2,13);function yh(h,n,c,d,m,b,v,w){h.emplaceBack(n,c,2*Math.floor(d*ap)+v,m*ap*2,b*ap*2,Math.round(w))}class lp{constructor(n){this.zoom=n.zoom,this.globalState=n.globalState,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(c=>c.id),this.index=n.index,this.hasPattern=!1,this.layoutVertexArray=new nt,this.centroidVertexArray=new Ce,this.indexArray=new br,this.programConfigurations=new ms(n.layers,n.zoom),this.segments=new rr,this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(n,c,d){this.features=[],this.hasPattern=Qf("fill-extrusion",this.layers,c);for(const{feature:m,id:b,index:v,sourceLayerIndex:w}of n){const A=this.layers[0]._featureFilter.needGeometry,P=va(m,A);if(!this.layers[0]._featureFilter.filter(new Rr(this.zoom,{globalState:this.globalState}),P,d))continue;const R={id:b,sourceLayerIndex:w,index:v,geometry:A?P.geometry:ba(m),properties:m.properties,type:m.type,patterns:{}};this.hasPattern?this.features.push(ep("fill-extrusion",this.layers,R,this.zoom,c)):this.addFeature(R,R.geometry,v,d,{},c.subdivisionGranularity),c.featureIndex.insert(m,R.geometry,v,w,this.index,!0)}}addFeatures(n,c,d){for(const m of this.features){const{geometry:b}=m;this.addFeature(m,b,m.index,c,d,n.subdivisionGranularity)}}update(n,c,d){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(n,c,this.stateDependentLayers,d)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(n){this.uploaded||(this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,Vw),this.centroidVertexBuffer=n.createVertexBuffer(this.centroidVertexArray,Uw.members,!0),this.indexBuffer=n.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(n),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(n,c,d,m,b,v){for(const w of tl(c,500)){const A={x:0,y:0,sampleCount:0},P=this.layoutVertexArray.length;this.processPolygon(A,m,n,w,v);const R=this.layoutVertexArray.length-P,D=Math.floor(A.x/A.sampleCount),L=Math.floor(A.y/A.sampleCount);for(let U=0;U<R;U++)this.centroidVertexArray.emplaceBack(D,L)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,d,b,m)}processPolygon(n,c,d,m,b){if(m.length<1||x_(m[0]))return;for(const D of m)D.length!==0&&$w(n,D);const v={segment:this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray)},w=b.fill.getGranularityForZoomLevel(c.z),A=jw[d.type]==="Polygon";for(const D of m){if(D.length===0||x_(D))continue;const L=wa(D,w,A);this._generateSideFaces(L,v)}if(!A)return;const P=h_(m,c,w,!1),R=this.layoutVertexArray;u_((D,L)=>{yh(R,D,L,0,0,1,1,0)},this.segments,this.layoutVertexArray,this.indexArray,P.verticesFlattened,P.indicesTriangles)}_generateSideFaces(n,c){let d=0;for(let m=1;m<n.length;m++){const b=n[m],v=n[m-1];if(Ww(b,v))continue;c.segment.vertexLength+4>rr.MAX_VERTEX_ARRAY_LENGTH&&(c.segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const w=b.sub(v)._perp()._unit(),A=v.dist(b);d+A>32768&&(d=0),yh(this.layoutVertexArray,b.x,b.y,w.x,w.y,0,0,d),yh(this.layoutVertexArray,b.x,b.y,w.x,w.y,0,1,d),d+=A,yh(this.layoutVertexArray,v.x,v.y,w.x,w.y,0,0,d),yh(this.layoutVertexArray,v.x,v.y,w.x,w.y,0,1,d);const P=c.segment.vertexLength;this.indexArray.emplaceBack(P,P+2,P+1),this.indexArray.emplaceBack(P+1,P+2,P+3),c.segment.vertexLength+=4,c.segment.primitiveLength+=2}}}function $w(h,n){for(let c=0;c<n.length;c++){const d=n[c];c===n.length-1&&n[0].x===d.x&&n[0].y===d.y||(h.x+=d.x,h.y+=d.y,h.sampleCount++)}}function Ww(h,n){return h.x===n.x&&(h.x<0||h.x>yt)||h.y===n.y&&(h.y<0||h.y>yt)}function x_(h){return h.every(n=>n.x<0)||h.every(n=>n.x>yt)||h.every(n=>n.y<0)||h.every(n=>n.y>yt)}let w_;ht("FillExtrusionBucket",lp,{omit:["layers","features"]});var Hw={get paint(){return w_=w_||new ji({"fill-extrusion-opacity":new gt(fe["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new St(fe["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new gt(fe["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new gt(fe["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Sl(fe["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new St(fe["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new St(fe["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new gt(fe["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class Zw extends vi{constructor(n){super(n,Hw)}createBucket(n){return new lp(n)}queryRadius(){return Ku(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature({queryGeometry:n,feature:c,featureState:d,geometry:m,transform:b,pixelsToTileUnits:v,pixelPosMatrix:w}){const A=Ju(n,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),-b.bearingInRadians,v),P=this.paint.get("fill-extrusion-height").evaluate(c,d),R=this.paint.get("fill-extrusion-base").evaluate(c,d),D=function(U,j){const H=[];for(const Y of U){const te=[Y.x,Y.y,0,1];Bt(te,te,j),H.push(new ie(te[0]/te[3],te[1]/te[3]))}return H}(A,w),L=function(U,j,H,Y){const te=[],ge=[],le=Y[8]*j,z=Y[9]*j,q=Y[10]*j,he=Y[11]*j,Re=Y[8]*H,Xe=Y[9]*H,Be=Y[10]*H,Ve=Y[11]*H;for(const Je of U){const Ye=[],tt=[];for(const We of Je){const pt=We.x,wt=We.y,xt=Y[0]*pt+Y[4]*wt+Y[12],_t=Y[1]*pt+Y[5]*wt+Y[13],Kt=Y[2]*pt+Y[6]*wt+Y[14],Wr=Y[3]*pt+Y[7]*wt+Y[15],ni=Kt+q,Bi=Wr+he,bn=xt+Re,on=_t+Xe,Si=Kt+Be,zr=Wr+Ve,di=new ie((xt+le)/Bi,(_t+z)/Bi);di.z=ni/Bi,Ye.push(di);const Ai=new ie(bn/zr,on/zr);Ai.z=Si/zr,tt.push(Ai)}te.push(Ye),ge.push(tt)}return[te,ge]}(m,R,P,w);return function(U,j,H){let Y=1/0;Hm(H,j)&&(Y=T_(H,j[0]));for(let te=0;te<j.length;te++){const ge=j[te],le=U[te];for(let z=0;z<ge.length-1;z++){const q=ge[z],he=[q,ge[z+1],le[z+1],le[z],q];Wm(H,he)&&(Y=Math.min(Y,T_(H,he)))}}return Y!==1/0&&Y}(L[0],L[1],D)}}function bh(h,n){return h.x*n.x+h.y*n.y}function T_(h,n){if(h.length===1){let c=0;const d=n[c++];let m;for(;!m||d.equals(m);)if(m=n[c++],!m)return 1/0;for(;c<n.length;c++){const b=n[c],v=h[0],w=m.sub(d),A=b.sub(d),P=v.sub(d),R=bh(w,w),D=bh(w,A),L=bh(A,A),U=bh(P,w),j=bh(P,A),H=R*L-D*D,Y=(L*U-D*j)/H,te=(R*j-D*U)/H,ge=d.z*(1-Y-te)+m.z*Y+b.z*te;if(isFinite(ge))return ge}return 1/0}{let c=1/0;for(const d of n)c=Math.min(c,d.z);return c}}const Xw=$r([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:qw}=Xw,Yw=$r([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:Gw}=Yw,Kw=_h.VectorTileFeature.types,Jw=Math.cos(Math.PI/180*37.5),S_=Math.pow(2,14)/.5;class cp{constructor(n){this.zoom=n.zoom,this.globalState=n.globalState,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(c=>c.id),this.index=n.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(c=>{this.gradients[c.id]={}}),this.layoutVertexArray=new it,this.layoutVertexArray2=new qe,this.indexArray=new br,this.programConfigurations=new ms(n.layers,n.zoom),this.segments=new rr,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(n,c,d){this.hasPattern=Qf("line",this.layers,c);const m=this.layers[0].layout.get("line-sort-key"),b=!m.isConstant(),v=[];for(const{feature:w,id:A,index:P,sourceLayerIndex:R}of n){const D=this.layers[0]._featureFilter.needGeometry,L=va(w,D);if(!this.layers[0]._featureFilter.filter(new Rr(this.zoom,{globalState:this.globalState}),L,d))continue;const U=b?m.evaluate(L,{},d):void 0,j={id:A,properties:w.properties,type:w.type,sourceLayerIndex:R,index:P,geometry:D?L.geometry:ba(w),patterns:{},sortKey:U};v.push(j)}b&&v.sort((w,A)=>w.sortKey-A.sortKey);for(const w of v){const{geometry:A,index:P,sourceLayerIndex:R}=w;if(this.hasPattern){const D=ep("line",this.layers,w,this.zoom,c);this.patternFeatures.push(D)}else this.addFeature(w,A,P,d,{},c.subdivisionGranularity);c.featureIndex.insert(n[P].feature,A,P,R,this.index)}}update(n,c,d){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(n,c,this.stateDependentLayers,d)}addFeatures(n,c,d){for(const m of this.patternFeatures)this.addFeature(m,m.geometry,m.index,c,d,n.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(n){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=n.createVertexBuffer(this.layoutVertexArray2,Gw)),this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,qw),this.indexBuffer=n.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(n),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(n){if(n.properties&&Object.prototype.hasOwnProperty.call(n.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(n.properties,"mapbox_clip_end"))return{start:+n.properties.mapbox_clip_start,end:+n.properties.mapbox_clip_end}}addFeature(n,c,d,m,b,v){const w=this.layers[0].layout,A=w.get("line-join").evaluate(n,{}),P=w.get("line-cap"),R=w.get("line-miter-limit"),D=w.get("line-round-limit");this.lineClips=this.lineFeatureClips(n);for(const L of c)this.addLine(L,n,A,P,R,D,m,v);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,d,b,m)}addLine(n,c,d,m,b,v,w,A){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,n=wa(n,w?A.line.getGranularityForZoomLevel(w.z):1),this.lineClips){this.lineClipsArray.push(this.lineClips);for(let le=0;le<n.length-1;le++)this.totalDistance+=n[le].dist(n[le+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const P=Kw[c.type]==="Polygon";let R=n.length;for(;R>=2&&n[R-1].equals(n[R-2]);)R--;let D=0;for(;D<R-1&&n[D].equals(n[D+1]);)D++;if(R<(P?3:2))return;d==="bevel"&&(b=1.05);const L=this.overscaling<=16?122880/(512*this.overscaling):0,U=this.segments.prepareSegment(10*R,this.layoutVertexArray,this.indexArray);let j,H,Y,te,ge;this.e1=this.e2=-1,P&&(j=n[R-2],ge=n[D].sub(j)._unit()._perp());for(let le=D;le<R;le++){if(Y=le===R-1?P?n[D+1]:void 0:n[le+1],Y&&n[le].equals(Y))continue;ge&&(te=ge),j&&(H=j),j=n[le],ge=Y?Y.sub(j)._unit()._perp():te,te=te||ge;let z=te.add(ge);z.x===0&&z.y===0||z._unit();const q=te.x*ge.x+te.y*ge.y,he=z.x*ge.x+z.y*ge.y,Re=he!==0?1/he:1/0,Xe=2*Math.sqrt(2-2*he),Be=he<Jw&&H&&Y,Ve=te.x*ge.y-te.y*ge.x>0;if(Be&&le>D){const tt=j.dist(H);if(tt>2*L){const We=j.sub(j.sub(H)._mult(L/tt)._round());this.updateDistance(H,We),this.addCurrentVertex(We,te,0,0,U),H=We}}const Je=H&&Y;let Ye=Je?d:P?"butt":m;if(Je&&Ye==="round"&&(Re<v?Ye="miter":Re<=2&&(Ye="fakeround")),Ye==="miter"&&Re>b&&(Ye="bevel"),Ye==="bevel"&&(Re>2&&(Ye="flipbevel"),Re<b&&(Ye="miter")),H&&this.updateDistance(H,j),Ye==="miter")z._mult(Re),this.addCurrentVertex(j,z,0,0,U);else if(Ye==="flipbevel"){if(Re>100)z=ge.mult(-1);else{const tt=Re*te.add(ge).mag()/te.sub(ge).mag();z._perp()._mult(tt*(Ve?-1:1))}this.addCurrentVertex(j,z,0,0,U),this.addCurrentVertex(j,z.mult(-1),0,0,U)}else if(Ye==="bevel"||Ye==="fakeround"){const tt=-Math.sqrt(Re*Re-1),We=Ve?tt:0,pt=Ve?0:tt;if(H&&this.addCurrentVertex(j,te,We,pt,U),Ye==="fakeround"){const wt=Math.round(180*Xe/Math.PI/20);for(let xt=1;xt<wt;xt++){let _t=xt/wt;if(_t!==.5){const Wr=_t-.5;_t+=_t*Wr*(_t-1)*((1.0904+q*(q*(3.55645-1.43519*q)-3.2452))*Wr*Wr+(.848013+q*(.215638*q-1.06021)))}const Kt=ge.sub(te)._mult(_t)._add(te)._unit()._mult(Ve?-1:1);this.addHalfVertex(j,Kt.x,Kt.y,!1,Ve,0,U)}}Y&&this.addCurrentVertex(j,ge,-We,-pt,U)}else if(Ye==="butt")this.addCurrentVertex(j,z,0,0,U);else if(Ye==="square"){const tt=H?1:-1;this.addCurrentVertex(j,z,tt,tt,U)}else Ye==="round"&&(H&&(this.addCurrentVertex(j,te,0,0,U),this.addCurrentVertex(j,te,1,1,U,!0)),Y&&(this.addCurrentVertex(j,ge,-1,-1,U,!0),this.addCurrentVertex(j,ge,0,0,U)));if(Be&&le<R-1){const tt=j.dist(Y);if(tt>2*L){const We=j.add(Y.sub(j)._mult(L/tt)._round());this.updateDistance(j,We),this.addCurrentVertex(We,ge,0,0,U),j=We}}}}addCurrentVertex(n,c,d,m,b,v=!1){const w=c.y*m-c.x,A=-c.y-c.x*m;this.addHalfVertex(n,c.x+c.y*d,c.y-c.x*d,v,!1,d,b),this.addHalfVertex(n,w,A,v,!0,-m,b),this.distance>S_/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(n,c,d,m,b,v))}addHalfVertex({x:n,y:c},d,m,b,v,w,A){const P=.5*(this.lineClips?this.scaledDistance*(S_-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((n<<1)+(b?1:0),(c<<1)+(v?1:0),Math.round(63*d)+128,Math.round(63*m)+128,1+(w===0?0:w<0?-1:1)|(63&P)<<2,P>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const R=A.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,R,this.e2),A.primitiveLength++),v?this.e2=R:this.e1=R}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(n,c){this.distance+=n.dist(c),this.updateScaledDistance()}}let A_,E_;ht("LineBucket",cp,{omit:["layers","patternFeatures"]});var I_={get paint(){return E_=E_||new ji({"line-opacity":new St(fe.paint_line["line-opacity"]),"line-color":new St(fe.paint_line["line-color"]),"line-translate":new gt(fe.paint_line["line-translate"]),"line-translate-anchor":new gt(fe.paint_line["line-translate-anchor"]),"line-width":new St(fe.paint_line["line-width"]),"line-gap-width":new St(fe.paint_line["line-gap-width"]),"line-offset":new St(fe.paint_line["line-offset"]),"line-blur":new St(fe.paint_line["line-blur"]),"line-dasharray":new th(fe.paint_line["line-dasharray"]),"line-pattern":new Sl(fe.paint_line["line-pattern"]),"line-gradient":new fa(fe.paint_line["line-gradient"])})},get layout(){return A_=A_||new ji({"line-cap":new gt(fe.layout_line["line-cap"]),"line-join":new St(fe.layout_line["line-join"]),"line-miter-limit":new gt(fe.layout_line["line-miter-limit"]),"line-round-limit":new gt(fe.layout_line["line-round-limit"]),"line-sort-key":new St(fe.layout_line["line-sort-key"])})}};class Qw extends St{possiblyEvaluate(n,c){return c=new Rr(Math.floor(c.zoom),{now:c.now,fadeDuration:c.fadeDuration,zoomHistory:c.zoomHistory,transition:c.transition}),super.possiblyEvaluate(n,c)}evaluate(n,c,d,m){return c=Tt({},c,{zoom:Math.floor(c.zoom)}),super.evaluate(n,c,d,m)}}let id;class e1 extends vi{constructor(n){super(n,I_),this.gradientVersion=0,id||(id=new Qw(I_.paint.properties["line-width"].specification),id.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(n){if(n==="line-gradient"){const c=this.gradientExpression();this.stepInterpolant=!!function(d){return d._styleExpression!==void 0}(c)&&c._styleExpression.expression instanceof Js,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(n,c){super.recalculate(n,c),this.paint._values["line-floorwidth"]=id.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,n)}createBucket(n){return new cp(n)}queryRadius(n){const c=n,d=C_(ch("line-width",this,c),ch("line-gap-width",this,c)),m=ch("line-offset",this,c);return d/2+Math.abs(m)+Ku(this.paint.get("line-translate"))}queryIntersectsFeature({queryGeometry:n,feature:c,featureState:d,geometry:m,transform:b,pixelsToTileUnits:v}){const w=Ju(n,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),-b.bearingInRadians,v),A=v/2*C_(this.paint.get("line-width").evaluate(c,d),this.paint.get("line-gap-width").evaluate(c,d)),P=this.paint.get("line-offset").evaluate(c,d);return P&&(m=function(R,D){const L=[];for(let U=0;U<R.length;U++){const j=R[U],H=[];for(let Y=0;Y<j.length;Y++){const te=j[Y-1],ge=j[Y],le=j[Y+1],z=Y===0?new ie(0,0):ge.sub(te)._unit()._perp(),q=Y===j.length-1?new ie(0,0):le.sub(ge)._unit()._perp(),he=z._add(q)._unit(),Re=he.x*q.x+he.y*q.y;Re!==0&&he._mult(1/Re),H.push(he._mult(D)._add(ge))}L.push(H)}return L}(m,P*v)),function(R,D,L){for(let U=0;U<D.length;U++){const j=D[U];if(R.length>=3){for(let H=0;H<j.length;H++)if(Il(R,j[H]))return!0}if(fw(R,j,L))return!0}return!1}(w,m,A)}isTileClipped(){return!0}}function C_(h,n){return n>0?n+2*h:h}const t1=$r([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),r1=$r([{name:"a_projected_pos",components:3,type:"Float32"}],4);$r([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const i1=$r([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);$r([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const P_=$r([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),n1=$r([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function s1(h,n,c){return h.sections.forEach(d=>{d.text=function(m,b,v){const w=b.layout.get("text-transform").evaluate(v,{});return w==="uppercase"?m=m.toLocaleUpperCase():w==="lowercase"&&(m=m.toLocaleLowerCase()),cs.applyArabicShaping&&(m=cs.applyArabicShaping(m)),m}(d.text,n,c)}),h}$r([{name:"triangle",components:3,type:"Uint16"}]),$r([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),$r([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),$r([{type:"Float32",name:"offsetX"}]),$r([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),$r([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);const vh={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"};var M_,hp,R_,ui=24,up={};function o1(){return M_||(M_=1,up.read=function(h,n,c,d,m){var b,v,w=8*m-d-1,A=(1<<w)-1,P=A>>1,R=-7,D=c?m-1:0,L=c?-1:1,U=h[n+D];for(D+=L,b=U&(1<<-R)-1,U>>=-R,R+=w;R>0;b=256*b+h[n+D],D+=L,R-=8);for(v=b&(1<<-R)-1,b>>=-R,R+=d;R>0;v=256*v+h[n+D],D+=L,R-=8);if(b===0)b=1-P;else{if(b===A)return v?NaN:1/0*(U?-1:1);v+=Math.pow(2,d),b-=P}return(U?-1:1)*v*Math.pow(2,b-d)},up.write=function(h,n,c,d,m,b){var v,w,A,P=8*b-m-1,R=(1<<P)-1,D=R>>1,L=m===23?Math.pow(2,-24)-Math.pow(2,-77):0,U=d?0:b-1,j=d?1:-1,H=n<0||n===0&&1/n<0?1:0;for(n=Math.abs(n),isNaN(n)||n===1/0?(w=isNaN(n)?1:0,v=R):(v=Math.floor(Math.log(n)/Math.LN2),n*(A=Math.pow(2,-v))<1&&(v--,A*=2),(n+=v+D>=1?L/A:L*Math.pow(2,1-D))*A>=2&&(v++,A/=2),v+D>=R?(w=0,v=R):v+D>=1?(w=(n*A-1)*Math.pow(2,m),v+=D):(w=n*Math.pow(2,D-1)*Math.pow(2,m),v=0));m>=8;h[c+U]=255&w,U+=j,w/=256,m-=8);for(v=v<<m|w,P+=m;P>0;h[c+U]=255&v,U+=j,v/=256,P-=8);h[c+U-j]|=128*H}),up}function k_(){if(R_)return hp;R_=1,hp=n;var h=o1();function n(z){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(z)?z:new Uint8Array(z||0),this.pos=0,this.type=0,this.length=this.buf.length}n.Varint=0,n.Fixed64=1,n.Bytes=2,n.Fixed32=5;var c=4294967296,d=1/c,m=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");function b(z){return z.type===n.Bytes?z.readVarint()+z.pos:z.pos+1}function v(z,q,he){return he?4294967296*q+(z>>>0):4294967296*(q>>>0)+(z>>>0)}function w(z,q,he){var Re=q<=16383?1:q<=2097151?2:q<=268435455?3:Math.floor(Math.log(q)/(7*Math.LN2));he.realloc(Re);for(var Xe=he.pos-1;Xe>=z;Xe--)he.buf[Xe+Re]=he.buf[Xe]}function A(z,q){for(var he=0;he<z.length;he++)q.writeVarint(z[he])}function P(z,q){for(var he=0;he<z.length;he++)q.writeSVarint(z[he])}function R(z,q){for(var he=0;he<z.length;he++)q.writeFloat(z[he])}function D(z,q){for(var he=0;he<z.length;he++)q.writeDouble(z[he])}function L(z,q){for(var he=0;he<z.length;he++)q.writeBoolean(z[he])}function U(z,q){for(var he=0;he<z.length;he++)q.writeFixed32(z[he])}function j(z,q){for(var he=0;he<z.length;he++)q.writeSFixed32(z[he])}function H(z,q){for(var he=0;he<z.length;he++)q.writeFixed64(z[he])}function Y(z,q){for(var he=0;he<z.length;he++)q.writeSFixed64(z[he])}function te(z,q){return(z[q]|z[q+1]<<8|z[q+2]<<16)+16777216*z[q+3]}function ge(z,q,he){z[he]=q,z[he+1]=q>>>8,z[he+2]=q>>>16,z[he+3]=q>>>24}function le(z,q){return(z[q]|z[q+1]<<8|z[q+2]<<16)+(z[q+3]<<24)}return n.prototype={destroy:function(){this.buf=null},readFields:function(z,q,he){for(he=he||this.length;this.pos<he;){var Re=this.readVarint(),Xe=Re>>3,Be=this.pos;this.type=7&Re,z(Xe,q,this),this.pos===Be&&this.skip(Re)}return q},readMessage:function(z,q){return this.readFields(z,q,this.readVarint()+this.pos)},readFixed32:function(){var z=te(this.buf,this.pos);return this.pos+=4,z},readSFixed32:function(){var z=le(this.buf,this.pos);return this.pos+=4,z},readFixed64:function(){var z=te(this.buf,this.pos)+te(this.buf,this.pos+4)*c;return this.pos+=8,z},readSFixed64:function(){var z=te(this.buf,this.pos)+le(this.buf,this.pos+4)*c;return this.pos+=8,z},readFloat:function(){var z=h.read(this.buf,this.pos,!0,23,4);return this.pos+=4,z},readDouble:function(){var z=h.read(this.buf,this.pos,!0,52,8);return this.pos+=8,z},readVarint:function(z){var q,he,Re=this.buf;return q=127&(he=Re[this.pos++]),he<128?q:(q|=(127&(he=Re[this.pos++]))<<7,he<128?q:(q|=(127&(he=Re[this.pos++]))<<14,he<128?q:(q|=(127&(he=Re[this.pos++]))<<21,he<128?q:function(Xe,Be,Ve){var Je,Ye,tt=Ve.buf;if(Je=(112&(Ye=tt[Ve.pos++]))>>4,Ye<128||(Je|=(127&(Ye=tt[Ve.pos++]))<<3,Ye<128)||(Je|=(127&(Ye=tt[Ve.pos++]))<<10,Ye<128)||(Je|=(127&(Ye=tt[Ve.pos++]))<<17,Ye<128)||(Je|=(127&(Ye=tt[Ve.pos++]))<<24,Ye<128)||(Je|=(1&(Ye=tt[Ve.pos++]))<<31,Ye<128))return v(Xe,Je,Be);throw new Error("Expected varint not more than 10 bytes")}(q|=(15&(he=Re[this.pos]))<<28,z,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var z=this.readVarint();return z%2==1?(z+1)/-2:z/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var z=this.readVarint()+this.pos,q=this.pos;return this.pos=z,z-q>=12&&m?function(he,Re,Xe){return m.decode(he.subarray(Re,Xe))}(this.buf,q,z):function(he,Re,Xe){for(var Be="",Ve=Re;Ve<Xe;){var Je,Ye,tt,We=he[Ve],pt=null,wt=We>239?4:We>223?3:We>191?2:1;if(Ve+wt>Xe)break;wt===1?We<128&&(pt=We):wt===2?(192&(Je=he[Ve+1]))==128&&(pt=(31&We)<<6|63&Je)<=127&&(pt=null):wt===3?(Ye=he[Ve+2],(192&(Je=he[Ve+1]))==128&&(192&Ye)==128&&((pt=(15&We)<<12|(63&Je)<<6|63&Ye)<=2047||pt>=55296&&pt<=57343)&&(pt=null)):wt===4&&(Ye=he[Ve+2],tt=he[Ve+3],(192&(Je=he[Ve+1]))==128&&(192&Ye)==128&&(192&tt)==128&&((pt=(15&We)<<18|(63&Je)<<12|(63&Ye)<<6|63&tt)<=65535||pt>=1114112)&&(pt=null)),pt===null?(pt=65533,wt=1):pt>65535&&(pt-=65536,Be+=String.fromCharCode(pt>>>10&1023|55296),pt=56320|1023&pt),Be+=String.fromCharCode(pt),Ve+=wt}return Be}(this.buf,q,z)},readBytes:function(){var z=this.readVarint()+this.pos,q=this.buf.subarray(this.pos,z);return this.pos=z,q},readPackedVarint:function(z,q){if(this.type!==n.Bytes)return z.push(this.readVarint(q));var he=b(this);for(z=z||[];this.pos<he;)z.push(this.readVarint(q));return z},readPackedSVarint:function(z){if(this.type!==n.Bytes)return z.push(this.readSVarint());var q=b(this);for(z=z||[];this.pos<q;)z.push(this.readSVarint());return z},readPackedBoolean:function(z){if(this.type!==n.Bytes)return z.push(this.readBoolean());var q=b(this);for(z=z||[];this.pos<q;)z.push(this.readBoolean());return z},readPackedFloat:function(z){if(this.type!==n.Bytes)return z.push(this.readFloat());var q=b(this);for(z=z||[];this.pos<q;)z.push(this.readFloat());return z},readPackedDouble:function(z){if(this.type!==n.Bytes)return z.push(this.readDouble());var q=b(this);for(z=z||[];this.pos<q;)z.push(this.readDouble());return z},readPackedFixed32:function(z){if(this.type!==n.Bytes)return z.push(this.readFixed32());var q=b(this);for(z=z||[];this.pos<q;)z.push(this.readFixed32());return z},readPackedSFixed32:function(z){if(this.type!==n.Bytes)return z.push(this.readSFixed32());var q=b(this);for(z=z||[];this.pos<q;)z.push(this.readSFixed32());return z},readPackedFixed64:function(z){if(this.type!==n.Bytes)return z.push(this.readFixed64());var q=b(this);for(z=z||[];this.pos<q;)z.push(this.readFixed64());return z},readPackedSFixed64:function(z){if(this.type!==n.Bytes)return z.push(this.readSFixed64());var q=b(this);for(z=z||[];this.pos<q;)z.push(this.readSFixed64());return z},skip:function(z){var q=7&z;if(q===n.Varint)for(;this.buf[this.pos++]>127;);else if(q===n.Bytes)this.pos=this.readVarint()+this.pos;else if(q===n.Fixed32)this.pos+=4;else{if(q!==n.Fixed64)throw new Error("Unimplemented type: "+q);this.pos+=8}},writeTag:function(z,q){this.writeVarint(z<<3|q)},realloc:function(z){for(var q=this.length||16;q<this.pos+z;)q*=2;if(q!==this.length){var he=new Uint8Array(q);he.set(this.buf),this.buf=he,this.length=q}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(z){this.realloc(4),ge(this.buf,z,this.pos),this.pos+=4},writeSFixed32:function(z){this.realloc(4),ge(this.buf,z,this.pos),this.pos+=4},writeFixed64:function(z){this.realloc(8),ge(this.buf,-1&z,this.pos),ge(this.buf,Math.floor(z*d),this.pos+4),this.pos+=8},writeSFixed64:function(z){this.realloc(8),ge(this.buf,-1&z,this.pos),ge(this.buf,Math.floor(z*d),this.pos+4),this.pos+=8},writeVarint:function(z){(z=+z||0)>268435455||z<0?function(q,he){var Re,Xe;if(q>=0?(Re=q%4294967296|0,Xe=q/4294967296|0):(Xe=~(-q/4294967296),4294967295^(Re=~(-q%4294967296))?Re=Re+1|0:(Re=0,Xe=Xe+1|0)),q>=18446744073709552e3||q<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");he.realloc(10),function(Be,Ve,Je){Je.buf[Je.pos++]=127&Be|128,Be>>>=7,Je.buf[Je.pos++]=127&Be|128,Be>>>=7,Je.buf[Je.pos++]=127&Be|128,Be>>>=7,Je.buf[Je.pos++]=127&Be|128,Je.buf[Je.pos]=127&(Be>>>=7)}(Re,0,he),function(Be,Ve){var Je=(7&Be)<<4;Ve.buf[Ve.pos++]|=Je|((Be>>>=3)?128:0),Be&&(Ve.buf[Ve.pos++]=127&Be|((Be>>>=7)?128:0),Be&&(Ve.buf[Ve.pos++]=127&Be|((Be>>>=7)?128:0),Be&&(Ve.buf[Ve.pos++]=127&Be|((Be>>>=7)?128:0),Be&&(Ve.buf[Ve.pos++]=127&Be|((Be>>>=7)?128:0),Be&&(Ve.buf[Ve.pos++]=127&Be)))))}(Xe,he)}(z,this):(this.realloc(4),this.buf[this.pos++]=127&z|(z>127?128:0),z<=127||(this.buf[this.pos++]=127&(z>>>=7)|(z>127?128:0),z<=127||(this.buf[this.pos++]=127&(z>>>=7)|(z>127?128:0),z<=127||(this.buf[this.pos++]=z>>>7&127))))},writeSVarint:function(z){this.writeVarint(z<0?2*-z-1:2*z)},writeBoolean:function(z){this.writeVarint(!!z)},writeString:function(z){z=String(z),this.realloc(4*z.length),this.pos++;var q=this.pos;this.pos=function(Re,Xe,Be){for(var Ve,Je,Ye=0;Ye<Xe.length;Ye++){if((Ve=Xe.charCodeAt(Ye))>55295&&Ve<57344){if(!Je){Ve>56319||Ye+1===Xe.length?(Re[Be++]=239,Re[Be++]=191,Re[Be++]=189):Je=Ve;continue}if(Ve<56320){Re[Be++]=239,Re[Be++]=191,Re[Be++]=189,Je=Ve;continue}Ve=Je-55296<<10|Ve-56320|65536,Je=null}else Je&&(Re[Be++]=239,Re[Be++]=191,Re[Be++]=189,Je=null);Ve<128?Re[Be++]=Ve:(Ve<2048?Re[Be++]=Ve>>6|192:(Ve<65536?Re[Be++]=Ve>>12|224:(Re[Be++]=Ve>>18|240,Re[Be++]=Ve>>12&63|128),Re[Be++]=Ve>>6&63|128),Re[Be++]=63&Ve|128)}return Be}(this.buf,z,this.pos);var he=this.pos-q;he>=128&&w(q,he,this),this.pos=q-1,this.writeVarint(he),this.pos+=he},writeFloat:function(z){this.realloc(4),h.write(this.buf,z,this.pos,!0,23,4),this.pos+=4},writeDouble:function(z){this.realloc(8),h.write(this.buf,z,this.pos,!0,52,8),this.pos+=8},writeBytes:function(z){var q=z.length;this.writeVarint(q),this.realloc(q);for(var he=0;he<q;he++)this.buf[this.pos++]=z[he]},writeRawMessage:function(z,q){this.pos++;var he=this.pos;z(q,this);var Re=this.pos-he;Re>=128&&w(he,Re,this),this.pos=he-1,this.writeVarint(Re),this.pos+=Re},writeMessage:function(z,q,he){this.writeTag(z,n.Bytes),this.writeRawMessage(q,he)},writePackedVarint:function(z,q){q.length&&this.writeMessage(z,A,q)},writePackedSVarint:function(z,q){q.length&&this.writeMessage(z,P,q)},writePackedBoolean:function(z,q){q.length&&this.writeMessage(z,L,q)},writePackedFloat:function(z,q){q.length&&this.writeMessage(z,R,q)},writePackedDouble:function(z,q){q.length&&this.writeMessage(z,D,q)},writePackedFixed32:function(z,q){q.length&&this.writeMessage(z,U,q)},writePackedSFixed32:function(z,q){q.length&&this.writeMessage(z,j,q)},writePackedFixed64:function(z,q){q.length&&this.writeMessage(z,H,q)},writePackedSFixed64:function(z,q){q.length&&this.writeMessage(z,Y,q)},writeBytesField:function(z,q){this.writeTag(z,n.Bytes),this.writeBytes(q)},writeFixed32Field:function(z,q){this.writeTag(z,n.Fixed32),this.writeFixed32(q)},writeSFixed32Field:function(z,q){this.writeTag(z,n.Fixed32),this.writeSFixed32(q)},writeFixed64Field:function(z,q){this.writeTag(z,n.Fixed64),this.writeFixed64(q)},writeSFixed64Field:function(z,q){this.writeTag(z,n.Fixed64),this.writeSFixed64(q)},writeVarintField:function(z,q){this.writeTag(z,n.Varint),this.writeVarint(q)},writeSVarintField:function(z,q){this.writeTag(z,n.Varint),this.writeSVarint(q)},writeStringField:function(z,q){this.writeTag(z,n.Bytes),this.writeString(q)},writeFloatField:function(z,q){this.writeTag(z,n.Fixed32),this.writeFloat(q)},writeDoubleField:function(z,q){this.writeTag(z,n.Fixed64),this.writeDouble(q)},writeBooleanField:function(z,q){this.writeVarintField(z,!!q)}},hp}var xo,dp=T(k_());function a1(h,n,c){h===1&&c.readMessage(l1,n)}function l1(h,n,c){if(h===3){const{id:d,bitmap:m,width:b,height:v,left:w,top:A,advance:P}=c.readMessage(c1,{});n.push({id:d,bitmap:new hh({width:b+6,height:v+6},m),metrics:{width:b,height:v,left:w,top:A,advance:P}})}}function c1(h,n,c){h===1?n.id=c.readVarint():h===2?n.bitmap=c.readBytes():h===3?n.width=c.readVarint():h===4?n.height=c.readVarint():h===5?n.left=c.readSVarint():h===6?n.top=c.readSVarint():h===7&&(n.advance=c.readVarint())}function D_(h){let n=0,c=0;for(const v of h)n+=v.w*v.h,c=Math.max(c,v.w);h.sort((v,w)=>w.h-v.h);const d=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(n/.95)),c),h:1/0}];let m=0,b=0;for(const v of h)for(let w=d.length-1;w>=0;w--){const A=d[w];if(!(v.w>A.w||v.h>A.h)){if(v.x=A.x,v.y=A.y,b=Math.max(b,v.y+v.h),m=Math.max(m,v.x+v.w),v.w===A.w&&v.h===A.h){const P=d.pop();w<d.length&&(d[w]=P)}else v.h===A.h?(A.x+=v.w,A.w-=v.w):v.w===A.w?(A.y+=v.h,A.h-=v.h):(d.push({x:A.x+v.w,y:A.y,w:A.w-v.w,h:v.h}),A.y+=v.h,A.h-=v.h);break}}return{w:m,h:b,fill:n/(m*b)||0}}class fp{constructor(n,{pixelRatio:c,version:d,stretchX:m,stretchY:b,content:v,textFitWidth:w,textFitHeight:A}){this.paddedRect=n,this.pixelRatio=c,this.stretchX=m,this.stretchY=b,this.content=v,this.version=d,this.textFitWidth=w,this.textFitHeight=A}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class O_{constructor(n,c){const d={},m={};this.haveRenderCallbacks=[];const b=[];this.addImages(n,d,b),this.addImages(c,m,b);const{w:v,h:w}=D_(b),A=new sn({width:v||1,height:w||1});for(const P in n){const R=n[P],D=d[P].paddedRect;sn.copy(R.data,A,{x:0,y:0},{x:D.x+1,y:D.y+1},R.data)}for(const P in c){const R=c[P],D=m[P].paddedRect,L=D.x+1,U=D.y+1,j=R.data.width,H=R.data.height;sn.copy(R.data,A,{x:0,y:0},{x:L,y:U},R.data),sn.copy(R.data,A,{x:0,y:H-1},{x:L,y:U-1},{width:j,height:1}),sn.copy(R.data,A,{x:0,y:0},{x:L,y:U+H},{width:j,height:1}),sn.copy(R.data,A,{x:j-1,y:0},{x:L-1,y:U},{width:1,height:H}),sn.copy(R.data,A,{x:0,y:0},{x:L+j,y:U},{width:1,height:H})}this.image=A,this.iconPositions=d,this.patternPositions=m}addImages(n,c,d){for(const m in n){const b=n[m],v={x:0,y:0,w:b.data.width+2,h:b.data.height+2};d.push(v),c[m]=new fp(v,b),b.hasRenderCallback&&this.haveRenderCallbacks.push(m)}}patchUpdatedImages(n,c){n.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const d in n.updatedImages)this.patchUpdatedImage(this.iconPositions[d],n.getImage(d),c),this.patchUpdatedImage(this.patternPositions[d],n.getImage(d),c)}patchUpdatedImage(n,c,d){if(!n||!c||n.version===c.version)return;n.version=c.version;const[m,b]=n.tl;d.update(c.data,void 0,{x:m,y:b})}}ht("ImagePosition",fp),ht("ImageAtlas",O_),p.an=void 0,(xo=p.an||(p.an={}))[xo.none=0]="none",xo[xo.horizontal=1]="horizontal",xo[xo.vertical=2]="vertical",xo[xo.horizontalOnly=3]="horizontalOnly";class xh{constructor(){this.scale=1,this.fontStack="",this.imageName=null,this.verticalAlign="bottom"}static forText(n,c,d){const m=new xh;return m.scale=n||1,m.fontStack=c,m.verticalAlign=d||"bottom",m}static forImage(n,c){const d=new xh;return d.imageName=n,d.verticalAlign=c||"bottom",d}}class Rl{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(n,c){const d=new Rl;for(let m=0;m<n.sections.length;m++){const b=n.sections[m];b.image?d.addImageSection(b):d.addTextSection(b,c)}return d}length(){return this.text.length}getSection(n){return this.sections[this.sectionIndex[n]]}getSectionIndex(n){return this.sectionIndex[n]}getCharCode(n){return this.text.charCodeAt(n)}verticalizePunctuation(){this.text=function(n){let c="";for(let d=0;d<n.length;d++){const m=n.charCodeAt(d+1)||null,b=n.charCodeAt(d-1)||null;c+=m&&Jc(m)&&!vh[n[d+1]]||b&&Jc(b)&&!vh[n[d-1]]||!vh[n[d]]?n[d]:vh[n[d]]}return c}(this.text)}trim(){let n=0;for(let d=0;d<this.text.length&&sd[this.text.charCodeAt(d)];d++)n++;let c=this.text.length;for(let d=this.text.length-1;d>=0&&d>=n&&sd[this.text.charCodeAt(d)];d--)c--;this.text=this.text.substring(n,c),this.sectionIndex=this.sectionIndex.slice(n,c)}substring(n,c){const d=new Rl;return d.text=this.text.substring(n,c),d.sectionIndex=this.sectionIndex.slice(n,c),d.sections=this.sections,d}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((n,c)=>Math.max(n,this.sections[c].scale),0)}getMaxImageSize(n){let c=0,d=0;for(let m=0;m<this.length();m++){const b=this.getSection(m);if(b.imageName){const v=n[b.imageName];if(!v)continue;const w=v.displaySize;c=Math.max(c,w[0]),d=Math.max(d,w[1])}}return{maxImageWidth:c,maxImageHeight:d}}addTextSection(n,c){this.text+=n.text,this.sections.push(xh.forText(n.scale,n.fontStack||c,n.verticalAlign));const d=this.sections.length-1;for(let m=0;m<n.text.length;++m)this.sectionIndex.push(d)}addImageSection(n){const c=n.image?n.image.name:"";if(c.length===0)return void hr("Can't add FormattedSection with an empty image.");const d=this.getNextImageSectionCharCode();d?(this.text+=String.fromCharCode(d),this.sections.push(xh.forImage(c,n.verticalAlign)),this.sectionIndex.push(this.sections.length-1)):hr("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function nd(h,n,c,d,m,b,v,w,A,P,R,D,L,U,j){const H=Rl.fromFeature(h,m);let Y;D===p.an.vertical&&H.verticalizePunctuation();const{processBidirectionalText:te,processStyledBidirectionalText:ge}=cs;if(te&&H.sections.length===1){Y=[];const q=te(H.toString(),pp(H,P,b,n,d,U));for(const he of q){const Re=new Rl;Re.text=he,Re.sections=H.sections;for(let Xe=0;Xe<he.length;Xe++)Re.sectionIndex.push(0);Y.push(Re)}}else if(ge){Y=[];const q=ge(H.text,H.sectionIndex,pp(H,P,b,n,d,U));for(const he of q){const Re=new Rl;Re.text=he[0],Re.sectionIndex=he[1],Re.sections=H.sections,Y.push(Re)}}else Y=function(q,he){const Re=[],Xe=q.text;let Be=0;for(const Ve of he)Re.push(q.substring(Be,Ve)),Be=Ve;return Be<Xe.length&&Re.push(q.substring(Be,Xe.length)),Re}(H,pp(H,P,b,n,d,U));const le=[],z={positionedLines:le,text:H.toString(),top:R[1],bottom:R[1],left:R[0],right:R[0],writingMode:D,iconsInText:!1,verticalizable:!1};return function(q,he,Re,Xe,Be,Ve,Je,Ye,tt,We,pt,wt){let xt=0,_t=0,Kt=0,Wr=0;const ni=Ye==="right"?1:Ye==="left"?0:.5,Bi=ui/wt;let bn=0;for(const zr of Be){zr.trim();const di=zr.getMaxScale(),Ai={positionedGlyphs:[],lineOffset:0};q.positionedLines[bn]=Ai;const Ei=Ai.positionedGlyphs;let Gi=0;if(!zr.length()){_t+=Ve,++bn;continue}const vn=f1(Xe,zr,Bi);for(let an=0;an<zr.length();an++){const si=zr.getSection(an),pi=zr.getSectionIndex(an),gi=zr.getCharCode(an),Jr=p1(tt,pt,gi);let Er;if(si.imageName){if(q.iconsInText=!0,si.scale=si.scale*Bi,Er=m1(si,Jr,di,vn,Xe),!Er)continue;Gi=Math.max(Gi,Er.imageOffset)}else if(Er=g1(si,gi,Jr,vn,he,Re),!Er)continue;const{rect:qn,metrics:Fl,baselineOffset:Yn}=Er;Ei.push({glyph:gi,imageName:si.imageName,x:xt,y:_t+Yn+-17,vertical:Jr,scale:si.scale,fontStack:si.fontStack,sectionIndex:pi,metrics:Fl,rect:qn}),Jr?(q.verticalizable=!0,xt+=(si.imageName?Fl.advance:ui)*si.scale+We):xt+=Fl.advance*si.scale+We}Ei.length!==0&&(Kt=Math.max(xt-We,Kt),_1(Ei,0,Ei.length-1,ni)),xt=0,Ai.lineOffset=Math.max(Gi,(di-1)*ui);const fi=Ve*di+Gi;_t+=fi,Wr=Math.max(fi,Wr),++bn}const{horizontalAlign:on,verticalAlign:Si}=gp(Je);(function(zr,di,Ai,Ei,Gi,vn,fi,an,si){const pi=(di-Ai)*Gi;let gi=0;gi=vn!==fi?-an*Ei- -17:-Ei*si*fi+.5*fi;for(const Jr of zr)for(const Er of Jr.positionedGlyphs)Er.x+=pi,Er.y+=gi})(q.positionedLines,ni,on,Si,Kt,Wr,Ve,_t,Be.length),q.top+=-Si*_t,q.bottom=q.top+_t,q.left+=-on*Kt,q.right=q.left+Kt}(z,n,c,d,Y,v,w,A,D,P,L,j),!function(q){for(const he of q)if(he.positionedGlyphs.length!==0)return!1;return!0}(le)&&z}const sd={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},h1={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},u1={40:!0};function F_(h,n,c,d,m,b){if(n.imageName){const v=d[n.imageName];return v?v.displaySize[0]*n.scale*ui/b+m:0}{const v=c[n.fontStack],w=v&&v[h];return w?w.metrics.advance*n.scale+m:0}}function B_(h,n,c,d){const m=Math.pow(h-n,2);return d?h<n?m/2:2*m:m+Math.abs(c)*c}function d1(h,n,c){let d=0;return h===10&&(d-=1e4),c&&(d+=150),h!==40&&h!==65288||(d+=50),n!==41&&n!==65289||(d+=50),d}function L_(h,n,c,d,m,b){let v=null,w=B_(n,c,m,b);for(const A of d){const P=B_(n-A.x,c,m,b)+A.badness;P<=w&&(v=A,w=P)}return{index:h,x:n,priorBreak:v,badness:w}}function N_(h){return h?N_(h.priorBreak).concat(h.index):[]}function pp(h,n,c,d,m,b){if(!h)return[];const v=[],w=function(D,L,U,j,H,Y){let te=0;for(let ge=0;ge<D.length();ge++){const le=D.getSection(ge);te+=F_(D.getCharCode(ge),le,j,H,L,Y)}return te/Math.max(1,Math.ceil(te/U))}(h,n,c,d,m,b),A=h.text.indexOf("​")>=0;let P=0;for(let D=0;D<h.length();D++){const L=h.getSection(D),U=h.getCharCode(D);if(sd[U]||(P+=F_(U,L,d,m,n,b)),D<h.length()-1){const j=!((R=U)<11904)&&(!!Yt["CJK Compatibility Forms"](R)||!!Yt["CJK Compatibility"](R)||!!Yt["CJK Strokes"](R)||!!Yt["CJK Symbols and Punctuation"](R)||!!Yt["Enclosed CJK Letters and Months"](R)||!!Yt["Halfwidth and Fullwidth Forms"](R)||!!Yt["Ideographic Description Characters"](R)||!!Yt["Vertical Forms"](R)||Kc.test(String.fromCodePoint(R)));(h1[U]||j||L.imageName||D!==h.length()-2&&u1[h.getCharCode(D+1)])&&v.push(L_(D+1,P,w,v,d1(U,h.getCharCode(D+1),j&&A),!1))}}var R;return N_(L_(h.length(),P,w,v,0,!0))}function gp(h){let n=.5,c=.5;switch(h){case"right":case"top-right":case"bottom-right":n=1;break;case"left":case"top-left":case"bottom-left":n=0}switch(h){case"bottom":case"bottom-right":case"bottom-left":c=1;break;case"top":case"top-right":case"top-left":c=0}return{horizontalAlign:n,verticalAlign:c}}function f1(h,n,c){const d=n.getMaxScale()*ui,{maxImageWidth:m,maxImageHeight:b}=n.getMaxImageSize(h),v=Math.max(d,b*c);return{verticalLineContentWidth:Math.max(d,m*c),horizontalLineContentHeight:v}}function z_(h){switch(h){case"top":return 0;case"center":return .5;default:return 1}}function p1(h,n,c){return!(h===p.an.horizontal||!n&&!xl(c)||n&&(sd[c]||(d=c,new RegExp("\\p{sc=Arab}","u").test(String.fromCodePoint(d)))));var d}function g1(h,n,c,d,m,b){const v=b[h.fontStack],w=function(P,R,D,L){if(P&&P.rect)return P;const U=R[D.fontStack],j=U&&U[L];return j?{rect:null,metrics:j.metrics}:null}(v&&v[n],m,h,n);if(w===null)return null;let A;if(c)A=d.verticalLineContentWidth-h.scale*ui;else{const P=z_(h.verticalAlign);A=(d.horizontalLineContentHeight-h.scale*ui)*P}return{rect:w.rect,metrics:w.metrics,baselineOffset:A}}function m1(h,n,c,d,m){const b=m[h.imageName];if(!b)return null;const v=b.paddedRect,w=b.displaySize,A={width:w[0],height:w[1],left:1,top:-3,advance:n?w[1]:w[0]};let P;if(n)P=d.verticalLineContentWidth-w[1]*h.scale;else{const R=z_(h.verticalAlign);P=(d.horizontalLineContentHeight-w[1]*h.scale)*R}return{rect:v,metrics:A,baselineOffset:P,imageOffset:(n?w[0]:w[1])*h.scale-ui*c}}function _1(h,n,c,d){if(d===0)return;const m=h[c],b=(h[c].x+m.metrics.advance*m.scale)*d;for(let v=n;v<=c;v++)h[v].x-=b}function y1(h,n,c){const{horizontalAlign:d,verticalAlign:m}=gp(c),b=n[0]-h.displaySize[0]*d,v=n[1]-h.displaySize[1]*m;return{image:h,top:v,bottom:v+h.displaySize[1],left:b,right:b+h.displaySize[0]}}function U_(h){var n,c;let d=h.left,m=h.top,b=h.right-d,v=h.bottom-m;const w=(n=h.image.textFitWidth)!==null&&n!==void 0?n:"stretchOrShrink",A=(c=h.image.textFitHeight)!==null&&c!==void 0?c:"stretchOrShrink",P=(h.image.content[2]-h.image.content[0])/(h.image.content[3]-h.image.content[1]);if(A==="proportional"){if(w==="stretchOnly"&&b/v<P||w==="proportional"){const R=Math.ceil(v*P);d*=R/b,b=R}}else if(w==="proportional"&&A==="stretchOnly"&&P!==0&&b/v>P){const R=Math.ceil(b/P);m*=R/v,v=R}return{x1:d,y1:m,x2:d+b,y2:m+v}}function V_(h,n,c,d,m,b){const v=h.image;let w;if(v.content){const Y=v.content,te=v.pixelRatio||1;w=[Y[0]/te,Y[1]/te,v.displaySize[0]-Y[2]/te,v.displaySize[1]-Y[3]/te]}const A=n.left*b,P=n.right*b;let R,D,L,U;c==="width"||c==="both"?(U=m[0]+A-d[3],D=m[0]+P+d[1]):(U=m[0]+(A+P-v.displaySize[0])/2,D=U+v.displaySize[0]);const j=n.top*b,H=n.bottom*b;return c==="height"||c==="both"?(R=m[1]+j-d[0],L=m[1]+H+d[2]):(R=m[1]+(j+H-v.displaySize[1])/2,L=R+v.displaySize[1]),{image:v,top:R,right:D,bottom:L,left:U,collisionPadding:w}}const Us=128,wo=32640;function j_(h,n){const{expression:c}=n;if(c.kind==="constant")return{kind:"constant",layoutSize:c.evaluate(new Rr(h+1))};if(c.kind==="source")return{kind:"source"};{const{zoomStops:d,interpolationType:m}=c;let b=0;for(;b<d.length&&d[b]<=h;)b++;b=Math.max(0,b-1);let v=b;for(;v<d.length&&d[v]<h+1;)v++;v=Math.min(d.length-1,v);const w=d[b],A=d[v];return c.kind==="composite"?{kind:"composite",minZoom:w,maxZoom:A,interpolationType:m}:{kind:"camera",minZoom:w,maxZoom:A,minSize:c.evaluate(new Rr(w)),maxSize:c.evaluate(new Rr(A)),interpolationType:m}}}function mp(h,n,c){let d="never";const m=h.get(n);return m?d=m:h.get(c)&&(d="always"),d}const b1=_h.VectorTileFeature.types,v1=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function od(h,n,c,d,m,b,v,w,A,P,R,D,L){const U=w?Math.min(wo,Math.round(w[0])):0,j=w?Math.min(wo,Math.round(w[1])):0;h.emplaceBack(n,c,Math.round(32*d),Math.round(32*m),b,v,(U<<1)+(A?1:0),j,16*P,16*R,256*D,256*L)}function _p(h,n,c){h.emplaceBack(n.x,n.y,c),h.emplaceBack(n.x,n.y,c),h.emplaceBack(n.x,n.y,c),h.emplaceBack(n.x,n.y,c)}function x1(h){for(const n of h.sections)if(Qc(n.text))return!0;return!1}class yp{constructor(n){this.layoutVertexArray=new Nt,this.indexArray=new br,this.programConfigurations=n,this.segments=new rr,this.dynamicLayoutVertexArray=new sr,this.opacityVertexArray=new Lr,this.hasVisibleVertices=!1,this.placedSymbolArray=new Q}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(n,c,d,m){this.isEmpty()||(d&&(this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,t1.members),this.indexBuffer=n.createIndexBuffer(this.indexArray,c),this.dynamicLayoutVertexBuffer=n.createVertexBuffer(this.dynamicLayoutVertexArray,r1.members,!0),this.opacityVertexBuffer=n.createVertexBuffer(this.opacityVertexArray,v1,!0),this.opacityVertexBuffer.itemSize=1),(d||m)&&this.programConfigurations.upload(n))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}ht("SymbolBuffers",yp);class bp{constructor(n,c,d){this.layoutVertexArray=new n,this.layoutAttributes=c,this.indexArray=new d,this.segments=new rr,this.collisionVertexArray=new Nr}upload(n){this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=n.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=n.createVertexBuffer(this.collisionVertexArray,i1.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}ht("CollisionBuffers",bp);class kl{constructor(n){this.collisionBoxArray=n.collisionBoxArray,this.zoom=n.zoom,this.globalState=n.globalState,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(v=>v.id),this.index=n.index,this.pixelRatio=n.pixelRatio,this.sourceLayerIndex=n.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[];const c=this.layers[0]._unevaluatedLayout._values;this.textSizeData=j_(this.zoom,c["text-size"]),this.iconSizeData=j_(this.zoom,c["icon-size"]);const d=this.layers[0].layout,m=d.get("symbol-sort-key"),b=d.get("symbol-z-order");this.canOverlap=mp(d,"text-overlap","text-allow-overlap")!=="never"||mp(d,"icon-overlap","icon-allow-overlap")!=="never"||d.get("text-ignore-placement")||d.get("icon-ignore-placement"),this.sortFeaturesByKey=b!=="viewport-y"&&!m.isConstant(),this.sortFeaturesByY=(b==="viewport-y"||b==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,d.get("symbol-placement")==="point"&&(this.writingModes=d.get("text-writing-mode").map(v=>p.an[v])),this.stateDependentLayerIds=this.layers.filter(v=>v.isStateDependent()).map(v=>v.id),this.sourceID=n.sourceID}createArrays(){this.text=new yp(new ms(this.layers,this.zoom,n=>/^text/.test(n))),this.icon=new yp(new ms(this.layers,this.zoom,n=>/^icon/.test(n))),this.glyphOffsetArray=new se,this.lineVertexArray=new ue,this.symbolInstances=new ae,this.textAnchorOffsets=new oe}calculateGlyphDependencies(n,c,d,m,b){for(let v=0;v<n.length;v++)if(c[n.charCodeAt(v)]=!0,(d||m)&&b){const w=vh[n.charAt(v)];w&&(c[w.charCodeAt(0)]=!0)}}populate(n,c,d){const m=this.layers[0],b=m.layout,v=b.get("text-font"),w=b.get("text-field"),A=b.get("icon-image"),P=(w.value.kind!=="constant"||w.value.value instanceof Di&&!w.value.value.isEmpty()||w.value.value.toString().length>0)&&(v.value.kind!=="constant"||v.value.value.length>0),R=A.value.kind!=="constant"||!!A.value.value||Object.keys(A.parameters).length>0,D=b.get("symbol-sort-key");if(this.features=[],!P&&!R)return;const L=c.iconDependencies,U=c.glyphDependencies,j=c.availableImages,H=new Rr(this.zoom,{globalState:this.globalState});for(const{feature:Y,id:te,index:ge,sourceLayerIndex:le}of n){const z=m._featureFilter.needGeometry,q=va(Y,z);if(!m._featureFilter.filter(H,q,d))continue;let he,Re;if(z||(q.geometry=ba(Y)),P){const Be=m.getValueAndResolveTokens("text-field",q,d,j),Ve=Di.factory(Be),Je=this.hasRTLText=this.hasRTLText||x1(Ve);(!Je||cs.getRTLTextPluginStatus()==="unavailable"||Je&&cs.isParsed())&&(he=s1(Ve,m,q))}if(R){const Be=m.getValueAndResolveTokens("icon-image",q,d,j);Re=Be instanceof Hi?Be:Hi.fromString(Be)}if(!he&&!Re)continue;const Xe=this.sortFeaturesByKey?D.evaluate(q,{},d):void 0;if(this.features.push({id:te,text:he,icon:Re,index:ge,sourceLayerIndex:le,geometry:q.geometry,properties:Y.properties,type:b1[Y.type],sortKey:Xe}),Re&&(L[Re.name]=!0),he){const Be=v.evaluate(q,{},d).join(","),Ve=b.get("text-rotation-alignment")!=="viewport"&&b.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(p.an.vertical)>=0;for(const Je of he.sections)if(Je.image)L[Je.image.name]=!0;else{const Ye=Gc(he.toString()),tt=Je.fontStack||Be,We=U[tt]=U[tt]||{};this.calculateGlyphDependencies(Je.text,We,Ve,this.allowVerticalPlacement,Ye)}}}b.get("symbol-placement")==="line"&&(this.features=function(Y){const te={},ge={},le=[];let z=0;function q(Be){le.push(Y[Be]),z++}function he(Be,Ve,Je){const Ye=ge[Be];return delete ge[Be],ge[Ve]=Ye,le[Ye].geometry[0].pop(),le[Ye].geometry[0]=le[Ye].geometry[0].concat(Je[0]),Ye}function Re(Be,Ve,Je){const Ye=te[Ve];return delete te[Ve],te[Be]=Ye,le[Ye].geometry[0].shift(),le[Ye].geometry[0]=Je[0].concat(le[Ye].geometry[0]),Ye}function Xe(Be,Ve,Je){const Ye=Je?Ve[0][Ve[0].length-1]:Ve[0][0];return`${Be}:${Ye.x}:${Ye.y}`}for(let Be=0;Be<Y.length;Be++){const Ve=Y[Be],Je=Ve.geometry,Ye=Ve.text?Ve.text.toString():null;if(!Ye){q(Be);continue}const tt=Xe(Ye,Je),We=Xe(Ye,Je,!0);if(tt in ge&&We in te&&ge[tt]!==te[We]){const pt=Re(tt,We,Je),wt=he(tt,We,le[pt].geometry);delete te[tt],delete ge[We],ge[Xe(Ye,le[wt].geometry,!0)]=wt,le[pt].geometry=null}else tt in ge?he(tt,We,Je):We in te?Re(tt,We,Je):(q(Be),te[tt]=z-1,ge[We]=z-1)}return le.filter(Be=>Be.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((Y,te)=>Y.sortKey-te.sortKey)}update(n,c,d){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(n,c,this.layers,d),this.icon.programConfigurations.updatePaintArrays(n,c,this.layers,d))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(n){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(n),this.iconCollisionBox.upload(n)),this.text.upload(n,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(n,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(n,c){const d=this.lineVertexArray.length;if(n.segment!==void 0){let m=n.dist(c[n.segment+1]),b=n.dist(c[n.segment]);const v={};for(let w=n.segment+1;w<c.length;w++)v[w]={x:c[w].x,y:c[w].y,tileUnitDistanceFromAnchor:m},w<c.length-1&&(m+=c[w+1].dist(c[w]));for(let w=n.segment||0;w>=0;w--)v[w]={x:c[w].x,y:c[w].y,tileUnitDistanceFromAnchor:b},w>0&&(b+=c[w-1].dist(c[w]));for(let w=0;w<c.length;w++){const A=v[w];this.lineVertexArray.emplaceBack(A.x,A.y,A.tileUnitDistanceFromAnchor)}}return{lineStartIndex:d,lineLength:this.lineVertexArray.length-d}}addSymbols(n,c,d,m,b,v,w,A,P,R,D,L){const U=n.indexArray,j=n.layoutVertexArray,H=n.segments.prepareSegment(4*c.length,j,U,this.canOverlap?v.sortKey:void 0),Y=this.glyphOffsetArray.length,te=H.vertexLength,ge=this.allowVerticalPlacement&&w===p.an.vertical?Math.PI/2:0,le=v.text&&v.text.sections;for(let z=0;z<c.length;z++){const{tl:q,tr:he,bl:Re,br:Xe,tex:Be,pixelOffsetTL:Ve,pixelOffsetBR:Je,minFontScaleX:Ye,minFontScaleY:tt,glyphOffset:We,isSDF:pt,sectionIndex:wt}=c[z],xt=H.vertexLength,_t=We[1];od(j,A.x,A.y,q.x,_t+q.y,Be.x,Be.y,d,pt,Ve.x,Ve.y,Ye,tt),od(j,A.x,A.y,he.x,_t+he.y,Be.x+Be.w,Be.y,d,pt,Je.x,Ve.y,Ye,tt),od(j,A.x,A.y,Re.x,_t+Re.y,Be.x,Be.y+Be.h,d,pt,Ve.x,Je.y,Ye,tt),od(j,A.x,A.y,Xe.x,_t+Xe.y,Be.x+Be.w,Be.y+Be.h,d,pt,Je.x,Je.y,Ye,tt),_p(n.dynamicLayoutVertexArray,A,ge),U.emplaceBack(xt,xt+2,xt+1),U.emplaceBack(xt+1,xt+2,xt+3),H.vertexLength+=4,H.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(We[0]),z!==c.length-1&&wt===c[z+1].sectionIndex||n.programConfigurations.populatePaintArrays(j.length,v,v.index,{},L,le&&le[wt])}n.placedSymbolArray.emplaceBack(A.x,A.y,Y,this.glyphOffsetArray.length-Y,te,P,R,A.segment,d?d[0]:0,d?d[1]:0,m[0],m[1],w,0,!1,0,D)}_addCollisionDebugVertex(n,c,d,m,b,v){return c.emplaceBack(0,0),n.emplaceBack(d.x,d.y,m,b,Math.round(v.x),Math.round(v.y))}addCollisionDebugVertices(n,c,d,m,b,v,w){const A=b.segments.prepareSegment(4,b.layoutVertexArray,b.indexArray),P=A.vertexLength,R=b.layoutVertexArray,D=b.collisionVertexArray,L=w.anchorX,U=w.anchorY;this._addCollisionDebugVertex(R,D,v,L,U,new ie(n,c)),this._addCollisionDebugVertex(R,D,v,L,U,new ie(d,c)),this._addCollisionDebugVertex(R,D,v,L,U,new ie(d,m)),this._addCollisionDebugVertex(R,D,v,L,U,new ie(n,m)),A.vertexLength+=4;const j=b.indexArray;j.emplaceBack(P,P+1),j.emplaceBack(P+1,P+2),j.emplaceBack(P+2,P+3),j.emplaceBack(P+3,P),A.primitiveLength+=4}addDebugCollisionBoxes(n,c,d,m){for(let b=n;b<c;b++){const v=this.collisionBoxArray.get(b);this.addCollisionDebugVertices(v.x1,v.y1,v.x2,v.y2,m?this.textCollisionBox:this.iconCollisionBox,v.anchorPoint,d)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new bp(ur,P_.members,dr),this.iconCollisionBox=new bp(ur,P_.members,dr);for(let n=0;n<this.symbolInstances.length;n++){const c=this.symbolInstances.get(n);this.addDebugCollisionBoxes(c.textBoxStartIndex,c.textBoxEndIndex,c,!0),this.addDebugCollisionBoxes(c.verticalTextBoxStartIndex,c.verticalTextBoxEndIndex,c,!0),this.addDebugCollisionBoxes(c.iconBoxStartIndex,c.iconBoxEndIndex,c,!1),this.addDebugCollisionBoxes(c.verticalIconBoxStartIndex,c.verticalIconBoxEndIndex,c,!1)}}_deserializeCollisionBoxesForSymbol(n,c,d,m,b,v,w,A,P){const R={};for(let D=c;D<d;D++){const L=n.get(D);R.textBox={x1:L.x1,y1:L.y1,x2:L.x2,y2:L.y2,anchorPointX:L.anchorPointX,anchorPointY:L.anchorPointY},R.textFeatureIndex=L.featureIndex;break}for(let D=m;D<b;D++){const L=n.get(D);R.verticalTextBox={x1:L.x1,y1:L.y1,x2:L.x2,y2:L.y2,anchorPointX:L.anchorPointX,anchorPointY:L.anchorPointY},R.verticalTextFeatureIndex=L.featureIndex;break}for(let D=v;D<w;D++){const L=n.get(D);R.iconBox={x1:L.x1,y1:L.y1,x2:L.x2,y2:L.y2,anchorPointX:L.anchorPointX,anchorPointY:L.anchorPointY},R.iconFeatureIndex=L.featureIndex;break}for(let D=A;D<P;D++){const L=n.get(D);R.verticalIconBox={x1:L.x1,y1:L.y1,x2:L.x2,y2:L.y2,anchorPointX:L.anchorPointX,anchorPointY:L.anchorPointY},R.verticalIconFeatureIndex=L.featureIndex;break}return R}deserializeCollisionBoxes(n){this.collisionArrays=[];for(let c=0;c<this.symbolInstances.length;c++){const d=this.symbolInstances.get(c);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(n,d.textBoxStartIndex,d.textBoxEndIndex,d.verticalTextBoxStartIndex,d.verticalTextBoxEndIndex,d.iconBoxStartIndex,d.iconBoxEndIndex,d.verticalIconBoxStartIndex,d.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(n,c){const d=n.placedSymbolArray.get(c),m=d.vertexStartIndex+4*d.numGlyphs;for(let b=d.vertexStartIndex;b<m;b+=4)n.indexArray.emplaceBack(b,b+2,b+1),n.indexArray.emplaceBack(b+1,b+2,b+3)}getSortedSymbolIndexes(n){if(this.sortedAngle===n&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const c=Math.sin(n),d=Math.cos(n),m=[],b=[],v=[];for(let w=0;w<this.symbolInstances.length;++w){v.push(w);const A=this.symbolInstances.get(w);m.push(0|Math.round(c*A.anchorX+d*A.anchorY)),b.push(A.featureIndex)}return v.sort((w,A)=>m[w]-m[A]||b[A]-b[w]),v}addToSortKeyRanges(n,c){const d=this.sortKeyRanges[this.sortKeyRanges.length-1];d&&d.sortKey===c?d.symbolInstanceEnd=n+1:this.sortKeyRanges.push({sortKey:c,symbolInstanceStart:n,symbolInstanceEnd:n+1})}sortFeatures(n){if(this.sortFeaturesByY&&this.sortedAngle!==n&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(n),this.sortedAngle=n,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const c of this.symbolInstanceIndexes){const d=this.symbolInstances.get(c);this.featureSortOrder.push(d.featureIndex),[d.rightJustifiedTextSymbolIndex,d.centerJustifiedTextSymbolIndex,d.leftJustifiedTextSymbolIndex].forEach((m,b,v)=>{m>=0&&v.indexOf(m)===b&&this.addIndicesForPlacedSymbol(this.text,m)}),d.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,d.verticalPlacedTextSymbolIndex),d.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,d.placedIconSymbolIndex),d.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,d.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let $_,W_;ht("SymbolBucket",kl,{omit:["layers","collisionBoxArray","features","compareText"]}),kl.MAX_GLYPHS=65535,kl.addDynamicAttributes=_p;var vp={get paint(){return W_=W_||new ji({"icon-opacity":new St(fe.paint_symbol["icon-opacity"]),"icon-color":new St(fe.paint_symbol["icon-color"]),"icon-halo-color":new St(fe.paint_symbol["icon-halo-color"]),"icon-halo-width":new St(fe.paint_symbol["icon-halo-width"]),"icon-halo-blur":new St(fe.paint_symbol["icon-halo-blur"]),"icon-translate":new gt(fe.paint_symbol["icon-translate"]),"icon-translate-anchor":new gt(fe.paint_symbol["icon-translate-anchor"]),"text-opacity":new St(fe.paint_symbol["text-opacity"]),"text-color":new St(fe.paint_symbol["text-color"],{runtimeType:tn,getOverride:h=>h.textColor,hasOverride:h=>!!h.textColor}),"text-halo-color":new St(fe.paint_symbol["text-halo-color"]),"text-halo-width":new St(fe.paint_symbol["text-halo-width"]),"text-halo-blur":new St(fe.paint_symbol["text-halo-blur"]),"text-translate":new gt(fe.paint_symbol["text-translate"]),"text-translate-anchor":new gt(fe.paint_symbol["text-translate-anchor"])})},get layout(){return $_=$_||new ji({"symbol-placement":new gt(fe.layout_symbol["symbol-placement"]),"symbol-spacing":new gt(fe.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new gt(fe.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new St(fe.layout_symbol["symbol-sort-key"]),"symbol-z-order":new gt(fe.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new gt(fe.layout_symbol["icon-allow-overlap"]),"icon-overlap":new gt(fe.layout_symbol["icon-overlap"]),"icon-ignore-placement":new gt(fe.layout_symbol["icon-ignore-placement"]),"icon-optional":new gt(fe.layout_symbol["icon-optional"]),"icon-rotation-alignment":new gt(fe.layout_symbol["icon-rotation-alignment"]),"icon-size":new St(fe.layout_symbol["icon-size"]),"icon-text-fit":new gt(fe.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new gt(fe.layout_symbol["icon-text-fit-padding"]),"icon-image":new St(fe.layout_symbol["icon-image"]),"icon-rotate":new St(fe.layout_symbol["icon-rotate"]),"icon-padding":new St(fe.layout_symbol["icon-padding"]),"icon-keep-upright":new gt(fe.layout_symbol["icon-keep-upright"]),"icon-offset":new St(fe.layout_symbol["icon-offset"]),"icon-anchor":new St(fe.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new gt(fe.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new gt(fe.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new gt(fe.layout_symbol["text-rotation-alignment"]),"text-field":new St(fe.layout_symbol["text-field"]),"text-font":new St(fe.layout_symbol["text-font"]),"text-size":new St(fe.layout_symbol["text-size"]),"text-max-width":new St(fe.layout_symbol["text-max-width"]),"text-line-height":new gt(fe.layout_symbol["text-line-height"]),"text-letter-spacing":new St(fe.layout_symbol["text-letter-spacing"]),"text-justify":new St(fe.layout_symbol["text-justify"]),"text-radial-offset":new St(fe.layout_symbol["text-radial-offset"]),"text-variable-anchor":new gt(fe.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new St(fe.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new St(fe.layout_symbol["text-anchor"]),"text-max-angle":new gt(fe.layout_symbol["text-max-angle"]),"text-writing-mode":new gt(fe.layout_symbol["text-writing-mode"]),"text-rotate":new St(fe.layout_symbol["text-rotate"]),"text-padding":new gt(fe.layout_symbol["text-padding"]),"text-keep-upright":new gt(fe.layout_symbol["text-keep-upright"]),"text-transform":new St(fe.layout_symbol["text-transform"]),"text-offset":new St(fe.layout_symbol["text-offset"]),"text-allow-overlap":new gt(fe.layout_symbol["text-allow-overlap"]),"text-overlap":new gt(fe.layout_symbol["text-overlap"]),"text-ignore-placement":new gt(fe.layout_symbol["text-ignore-placement"]),"text-optional":new gt(fe.layout_symbol["text-optional"])})}};class H_{constructor(n){if(n.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=n.property.overrides?n.property.overrides.runtimeType:Es,this.defaultValue=n}evaluate(n){if(n.formattedSection){const c=this.defaultValue.property.overrides;if(c&&c.hasOverride(n.formattedSection))return c.getOverride(n.formattedSection)}return n.feature&&n.featureState?this.defaultValue.evaluate(n.feature,n.featureState):this.defaultValue.property.specification.default}eachChild(n){this.defaultValue.isConstant()||n(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}ht("FormatSectionOverride",H_,{omit:["defaultValue"]});class ad extends vi{constructor(n){super(n,vp)}recalculate(n,c){if(super.recalculate(n,c),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const d=this.layout.get("text-writing-mode");if(d){const m=[];for(const b of d)m.indexOf(b)<0&&m.push(b);this.layout._values["text-writing-mode"]=m}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(n,c,d,m){const b=this.layout.get(n).evaluate(c,{},d,m),v=this._unevaluatedLayout._values[n];return v.isDataDriven()||cl(v.value)||!b?b:function(w,A){return A.replace(/{([^{}]+)}/g,(P,R)=>w&&R in w?String(w[R]):"")}(c.properties,b)}createBucket(n){return new kl(n)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const n of vp.paint.overridableProperties){if(!ad.hasPaintOverride(this.layout,n))continue;const c=this.paint.get(n),d=new H_(c),m=new ll(d,c.property.specification);let b=null;b=c.value.kind==="constant"||c.value.kind==="source"?new ra("source",m):new ul("composite",m,c.value.zoomStops),this.paint._values[n]=new kn(c.property,b,c.parameters)}}_handleOverridablePaintPropertyUpdate(n,c,d){return!(!this.layout||c.isDataDriven()||d.isDataDriven())&&ad.hasPaintOverride(this.layout,n)}static hasPaintOverride(n,c){const d=n.get("text-field"),m=vp.paint.properties[c];let b=!1;const v=w=>{for(const A of w)if(m.overrides&&m.overrides.hasOverride(A))return void(b=!0)};if(d.value.kind==="constant"&&d.value.value instanceof Di)v(d.value.value.sections);else if(d.value.kind==="source"){const w=P=>{b||(P instanceof zi&&Pt(P.value)===Is?v(P.value.sections):P instanceof Yo?v(P.sections):P.eachChild(w))},A=d.value;A._styleExpression&&w(A._styleExpression.expression)}return b}}let Z_;var w1={get paint(){return Z_=Z_||new ji({"background-color":new gt(fe.paint_background["background-color"]),"background-pattern":new th(fe.paint_background["background-pattern"]),"background-opacity":new gt(fe.paint_background["background-opacity"])})}};class T1 extends vi{constructor(n){super(n,w1)}}let X_;var S1={get paint(){return X_=X_||new ji({"raster-opacity":new gt(fe.paint_raster["raster-opacity"]),"raster-hue-rotate":new gt(fe.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new gt(fe.paint_raster["raster-brightness-min"]),"raster-brightness-max":new gt(fe.paint_raster["raster-brightness-max"]),"raster-saturation":new gt(fe.paint_raster["raster-saturation"]),"raster-contrast":new gt(fe.paint_raster["raster-contrast"]),"raster-resampling":new gt(fe.paint_raster["raster-resampling"]),"raster-fade-duration":new gt(fe.paint_raster["raster-fade-duration"])})}};class A1 extends vi{constructor(n){super(n,S1)}}class E1 extends vi{constructor(n){super(n,{}),this.onAdd=c=>{this.implementation.onAdd&&this.implementation.onAdd(c,c.painter.context.gl)},this.onRemove=c=>{this.implementation.onRemove&&this.implementation.onRemove(c,c.painter.context.gl)},this.implementation=n}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class I1{constructor(n){this._methodToThrottle=n,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._methodToThrottle()},0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const C1={once:!0},xp=63710088e-1;class To{constructor(n,c){if(isNaN(n)||isNaN(c))throw new Error(`Invalid LngLat object: (${n}, ${c})`);if(this.lng=+n,this.lat=+c,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new To(gr(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(n){const c=Math.PI/180,d=this.lat*c,m=n.lat*c,b=Math.sin(d)*Math.sin(m)+Math.cos(d)*Math.cos(m)*Math.cos((n.lng-this.lng)*c);return xp*Math.acos(Math.min(b,1))}static convert(n){if(n instanceof To)return n;if(Array.isArray(n)&&(n.length===2||n.length===3))return new To(Number(n[0]),Number(n[1]));if(!Array.isArray(n)&&typeof n=="object"&&n!==null)return new To(Number("lng"in n?n.lng:n.lon),Number(n.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const q_=2*Math.PI*xp;function Y_(h){return q_*Math.cos(h*Math.PI/180)}function G_(h){return(180+h)/360}function K_(h){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+h*Math.PI/360)))/360}function J_(h,n){return h/Y_(n)}function wp(h){return 360/Math.PI*Math.atan(Math.exp((180-360*h)*Math.PI/180))-90}function Q_(h,n){return h*Y_(wp(n))}class wh{constructor(n,c,d=0){this.x=+n,this.y=+c,this.z=+d}static fromLngLat(n,c=0){const d=To.convert(n);return new wh(G_(d.lng),K_(d.lat),J_(c,d.lat))}toLngLat(){return new To(360*this.x-180,wp(this.y))}toAltitude(){return Q_(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/q_*(n=wp(this.y),1/Math.cos(n*Math.PI/180));var n}}function ey(h,n,c){var d=2*Math.PI*6378137/256/Math.pow(2,c);return[h*d-2*Math.PI*6378137/2,n*d-2*Math.PI*6378137/2]}class Tp{constructor(n,c,d){if(!function(m,b,v){return!(m<0||m>25||v<0||v>=Math.pow(2,m)||b<0||b>=Math.pow(2,m))}(n,c,d))throw new Error(`x=${c}, y=${d}, z=${n} outside of bounds. 0<=x<${Math.pow(2,n)}, 0<=y<${Math.pow(2,n)} 0<=z<=25 `);this.z=n,this.x=c,this.y=d,this.key=Dl(0,n,n,c,d)}equals(n){return this.z===n.z&&this.x===n.x&&this.y===n.y}url(n,c,d){const m=(v=this.y,w=this.z,A=ey(256*(b=this.x),256*(v=Math.pow(2,w)-v-1),w),P=ey(256*(b+1),256*(v+1),w),A[0]+","+A[1]+","+P[0]+","+P[1]);var b,v,w,A,P;const R=function(D,L,U){let j,H="";for(let Y=D;Y>0;Y--)j=1<<Y-1,H+=(L&j?1:0)+(U&j?2:0);return H}(this.z,this.x,this.y);return n[(this.x+this.y)%n.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(d==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,c>1?"@2x":"").replace(/{quadkey}/g,R).replace(/{bbox-epsg-3857}/g,m)}isChildOf(n){const c=this.z-n.z;return c>0&&n.x===this.x>>c&&n.y===this.y>>c}getTilePoint(n){const c=Math.pow(2,this.z);return new ie((n.x*c-this.x)*yt,(n.y*c-this.y)*yt)}toString(){return`${this.z}/${this.x}/${this.y}`}}class ty{constructor(n,c){this.wrap=n,this.canonical=c,this.key=Dl(n,c.z,c.z,c.x,c.y)}}class yn{constructor(n,c,d,m,b){if(this.terrainRttPosMatrix32f=null,n<d)throw new Error(`overscaledZ should be >= z; overscaledZ = ${n}; z = ${d}`);this.overscaledZ=n,this.wrap=c,this.canonical=new Tp(d,+m,+b),this.key=Dl(c,n,d,m,b)}clone(){return new yn(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(n){return this.overscaledZ===n.overscaledZ&&this.wrap===n.wrap&&this.canonical.equals(n.canonical)}scaledTo(n){if(n>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${n}; overscaledZ = ${this.overscaledZ}`);const c=this.canonical.z-n;return n>this.canonical.z?new yn(n,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new yn(n,this.wrap,n,this.canonical.x>>c,this.canonical.y>>c)}calculateScaledKey(n,c){if(n>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${n}; overscaledZ = ${this.overscaledZ}`);const d=this.canonical.z-n;return n>this.canonical.z?Dl(this.wrap*+c,n,this.canonical.z,this.canonical.x,this.canonical.y):Dl(this.wrap*+c,n,n,this.canonical.x>>d,this.canonical.y>>d)}isChildOf(n){if(n.wrap!==this.wrap)return!1;const c=this.canonical.z-n.canonical.z;return n.overscaledZ===0||n.overscaledZ<this.overscaledZ&&n.canonical.x===this.canonical.x>>c&&n.canonical.y===this.canonical.y>>c}children(n){if(this.overscaledZ>=n)return[new yn(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const c=this.canonical.z+1,d=2*this.canonical.x,m=2*this.canonical.y;return[new yn(c,this.wrap,c,d,m),new yn(c,this.wrap,c,d+1,m),new yn(c,this.wrap,c,d,m+1),new yn(c,this.wrap,c,d+1,m+1)]}isLessThan(n){return this.wrap<n.wrap||!(this.wrap>n.wrap)&&(this.overscaledZ<n.overscaledZ||!(this.overscaledZ>n.overscaledZ)&&(this.canonical.x<n.canonical.x||!(this.canonical.x>n.canonical.x)&&this.canonical.y<n.canonical.y))}wrapped(){return new yn(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(n){return new yn(this.overscaledZ,n,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new ty(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(n){return this.canonical.getTilePoint(new wh(n.x-this.wrap,n.y))}}function Dl(h,n,c,d,m){(h*=2)<0&&(h=-1*h-1);const b=1<<c;return(b*b*h+b*m+d).toString(36)+c.toString(36)+n.toString(36)}ht("CanonicalTileID",Tp),ht("OverscaledTileID",yn,{omit:["terrainRttPosMatrix32f"]});class Ta{constructor(){this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0}extend(n){return this.minX=Math.min(this.minX,n.x),this.minY=Math.min(this.minY,n.y),this.maxX=Math.max(this.maxX,n.x),this.maxY=Math.max(this.maxY,n.y),this}expandBy(n){return this.minX-=n,this.minY-=n,this.maxX+=n,this.maxY+=n,(this.minX>this.maxX||this.minY>this.maxY)&&(this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0),this}shrinkBy(n){return this.expandBy(-n)}map(n){const c=new Ta;return c.extend(n(new ie(this.minX,this.minY))),c.extend(n(new ie(this.maxX,this.minY))),c.extend(n(new ie(this.minX,this.maxY))),c.extend(n(new ie(this.maxX,this.maxY))),c}static fromPoints(n){const c=new Ta;for(const d of n)c.extend(d);return c}contains(n){return n.x>=this.minX&&n.x<=this.maxX&&n.y>=this.minY&&n.y<=this.maxY}empty(){return this.minX>this.maxX}width(){return this.maxX-this.minX}height(){return this.maxY-this.minY}covers(n){return!this.empty()&&!n.empty()&&n.minX>=this.minX&&n.maxX<=this.maxX&&n.minY>=this.minY&&n.maxY<=this.maxY}intersects(n){return!this.empty()&&!n.empty()&&n.minX<=this.maxX&&n.maxX>=this.minX&&n.minY<=this.maxY&&n.maxY>=this.minY}}class ry{constructor(n){this._stringToNumber={},this._numberToString=[];for(let c=0;c<n.length;c++){const d=n[c];this._stringToNumber[d]=c,this._numberToString[c]=d}}encode(n){return this._stringToNumber[n]}decode(n){if(n>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${n} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[n]}}class iy{constructor(n,c,d,m,b){this.type="Feature",this._vectorTileFeature=n,n._z=c,n._x=d,n._y=m,this.properties=n.properties,this.id=b}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(n){this._geometry=n}toJSON(){const n={geometry:this.geometry};for(const c in this)c!=="_geometry"&&c!=="_vectorTileFeature"&&(n[c]=this[c]);return n}}class ny{constructor(n,c){this.tileID=n,this.x=n.canonical.x,this.y=n.canonical.y,this.z=n.canonical.z,this.grid=new _o(yt,16,0),this.grid3D=new _o(yt,16,0),this.featureIndexArray=new Oe,this.promoteId=c}insert(n,c,d,m,b,v){const w=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(d,m,b);const A=v?this.grid3D:this.grid;for(let P=0;P<c.length;P++){const R=c[P],D=[1/0,1/0,-1/0,-1/0];for(let L=0;L<R.length;L++){const U=R[L];D[0]=Math.min(D[0],U.x),D[1]=Math.min(D[1],U.y),D[2]=Math.max(D[2],U.x),D[3]=Math.max(D[3],U.y)}D[0]<yt&&D[1]<yt&&D[2]>=0&&D[3]>=0&&A.insert(w,D[0],D[1],D[2],D[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new _h.VectorTile(new dp(this.rawTileData)).layers,this.sourceLayerCoder=new ry(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(n,c,d,m){this.loadVTLayers();const b=n.params,v=yt/n.tileSize/n.scale,w=as(b.filter),A=n.queryGeometry,P=n.queryPadding*v,R=Ta.fromPoints(A),D=this.grid.query(R.minX-P,R.minY-P,R.maxX+P,R.maxY+P),L=Ta.fromPoints(n.cameraQueryGeometry).expandBy(P),U=this.grid3D.query(L.minX,L.minY,L.maxX,L.maxY,(Y,te,ge,le)=>function(z,q,he,Re,Xe){for(const Ve of z)if(q<=Ve.x&&he<=Ve.y&&Re>=Ve.x&&Xe>=Ve.y)return!0;const Be=[new ie(q,he),new ie(q,Xe),new ie(Re,Xe),new ie(Re,he)];if(z.length>2){for(const Ve of Be)if(Il(z,Ve))return!0}for(let Ve=0;Ve<z.length-1;Ve++)if(gw(z[Ve],z[Ve+1],Be))return!0;return!1}(n.cameraQueryGeometry,Y-P,te-P,ge+P,le+P));for(const Y of U)D.push(Y);D.sort(P1);const j={};let H;for(let Y=0;Y<D.length;Y++){const te=D[Y];if(te===H)continue;H=te;const ge=this.featureIndexArray.get(te);let le=null;this.loadMatchingFeature(j,ge.bucketIndex,ge.sourceLayerIndex,ge.featureIndex,w,b.layers,b.availableImages,c,d,m,(z,q,he)=>(le||(le=ba(z)),q.queryIntersectsFeature({queryGeometry:A,feature:z,featureState:he,geometry:le,zoom:this.z,transform:n.transform,pixelsToTileUnits:v,pixelPosMatrix:n.pixelPosMatrix,unwrappedTileID:this.tileID.toUnwrapped(),getElevation:n.getElevation})))}return j}loadMatchingFeature(n,c,d,m,b,v,w,A,P,R,D){const L=this.bucketLayerIDs[c];if(v&&!L.some(Y=>v.has(Y)))return;const U=this.sourceLayerCoder.decode(d),j=this.vtLayers[U].feature(m);if(b.needGeometry){const Y=va(j,!0);if(!b.filter(new Rr(this.tileID.overscaledZ),Y,this.tileID.canonical))return}else if(!b.filter(new Rr(this.tileID.overscaledZ),j))return;const H=this.getId(j,U);for(let Y=0;Y<L.length;Y++){const te=L[Y];if(v&&!v.has(te))continue;const ge=A[te];if(!ge)continue;let le={};H&&R&&(le=R.getState(ge.sourceLayer||"_geojsonTileLayer",H));const z=Tt({},P[te]);z.paint=sy(z.paint,ge.paint,j,le,w),z.layout=sy(z.layout,ge.layout,j,le,w);const q=!D||D(j,ge,le);if(!q)continue;const he=new iy(j,this.z,this.x,this.y,H);he.layer=z;let Re=n[te];Re===void 0&&(Re=n[te]=[]),Re.push({featureIndex:m,feature:he,intersectionZ:q})}}lookupSymbolFeatures(n,c,d,m,b,v,w,A){const P={};this.loadVTLayers();const R=as(b);for(const D of n)this.loadMatchingFeature(P,d,m,D,R,v,w,A,c);return P}hasLayer(n){for(const c of this.bucketLayerIDs)for(const d of c)if(n===d)return!0;return!1}getId(n,c){var d;let m=n.id;return this.promoteId&&(m=n.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[c]],typeof m=="boolean"&&(m=Number(m)),m===void 0&&(!((d=n.properties)===null||d===void 0)&&d.cluster)&&this.promoteId&&(m=Number(n.properties.cluster_id))),m}}function sy(h,n,c,d,m){return zt(h,(b,v)=>{const w=n instanceof Tl?n.get(v):null;return w&&w.evaluate?w.evaluate(c,d,m):w})}function P1(h,n){return n-h}function oy(h,n,c,d,m){const b=[];for(let v=0;v<h.length;v++){const w=h[v];let A;for(let P=0;P<w.length-1;P++){let R=w[P],D=w[P+1];R.x<n&&D.x<n||(R.x<n?R=new ie(n,R.y+(n-R.x)/(D.x-R.x)*(D.y-R.y))._round():D.x<n&&(D=new ie(n,R.y+(n-R.x)/(D.x-R.x)*(D.y-R.y))._round()),R.y<c&&D.y<c||(R.y<c?R=new ie(R.x+(c-R.y)/(D.y-R.y)*(D.x-R.x),c)._round():D.y<c&&(D=new ie(R.x+(c-R.y)/(D.y-R.y)*(D.x-R.x),c)._round()),R.x>=d&&D.x>=d||(R.x>=d?R=new ie(d,R.y+(d-R.x)/(D.x-R.x)*(D.y-R.y))._round():D.x>=d&&(D=new ie(d,R.y+(d-R.x)/(D.x-R.x)*(D.y-R.y))._round()),R.y>=m&&D.y>=m||(R.y>=m?R=new ie(R.x+(m-R.y)/(D.y-R.y)*(D.x-R.x),m)._round():D.y>=m&&(D=new ie(R.x+(m-R.y)/(D.y-R.y)*(D.x-R.x),m)._round()),A&&R.equals(A[A.length-1])||(A=[R],b.push(A)),A.push(D)))))}}return b}ht("FeatureIndex",ny,{omit:["rawTileData","sourceLayerCoder"]});class So extends ie{constructor(n,c,d,m){super(n,c),this.angle=d,m!==void 0&&(this.segment=m)}clone(){return new So(this.x,this.y,this.angle,this.segment)}}function ay(h,n,c,d,m){if(n.segment===void 0||c===0)return!0;let b=n,v=n.segment+1,w=0;for(;w>-c/2;){if(v--,v<0)return!1;w-=h[v].dist(b),b=h[v]}w+=h[v].dist(h[v+1]),v++;const A=[];let P=0;for(;w<c/2;){const R=h[v],D=h[v+1];if(!D)return!1;let L=h[v-1].angleTo(R)-R.angleTo(D);for(L=Math.abs((L+3*Math.PI)%(2*Math.PI)-Math.PI),A.push({distance:w,angleDelta:L}),P+=L;w-A[0].distance>d;)P-=A.shift().angleDelta;if(P>m)return!1;v++,w+=R.dist(D)}return!0}function ly(h){let n=0;for(let c=0;c<h.length-1;c++)n+=h[c].dist(h[c+1]);return n}function cy(h,n,c){return h?.6*n*c:0}function hy(h,n){return Math.max(h?h.right-h.left:0,n?n.right-n.left:0)}function M1(h,n,c,d,m,b){const v=cy(c,m,b),w=hy(c,d)*b;let A=0;const P=ly(h)/2;for(let R=0;R<h.length-1;R++){const D=h[R],L=h[R+1],U=D.dist(L);if(A+U>P){const j=(P-A)/U,H=nn.number(D.x,L.x,j),Y=nn.number(D.y,L.y,j),te=new So(H,Y,L.angleTo(D),R);return te._round(),!v||ay(h,te,w,v,n)?te:void 0}A+=U}}function R1(h,n,c,d,m,b,v,w,A){const P=cy(d,b,v),R=hy(d,m),D=R*v,L=h[0].x===0||h[0].x===A||h[0].y===0||h[0].y===A;return n-D<n/4&&(n=D+n/4),uy(h,L?n/2*w%n:(R/2+2*b)*v*w%n,n,P,c,D,L,!1,A)}function uy(h,n,c,d,m,b,v,w,A){const P=b/2,R=ly(h);let D=0,L=n-c,U=[];for(let j=0;j<h.length-1;j++){const H=h[j],Y=h[j+1],te=H.dist(Y),ge=Y.angleTo(H);for(;L+c<D+te;){L+=c;const le=(L-D)/te,z=nn.number(H.x,Y.x,le),q=nn.number(H.y,Y.y,le);if(z>=0&&z<A&&q>=0&&q<A&&L-P>=0&&L+P<=R){const he=new So(z,q,ge,j);he._round(),d&&!ay(h,he,b,d,m)||U.push(he)}}D+=te}return w||U.length||v||(U=uy(h,D/2,c,d,m,b,v,!0,A)),U}function dy(h,n,c,d){const m=[],b=h.image,v=b.pixelRatio,w=b.paddedRect.w-2,A=b.paddedRect.h-2;let P={x1:h.left,y1:h.top,x2:h.right,y2:h.bottom};const R=b.stretchX||[[0,w]],D=b.stretchY||[[0,A]],L=(We,pt)=>We+pt[1]-pt[0],U=R.reduce(L,0),j=D.reduce(L,0),H=w-U,Y=A-j;let te=0,ge=U,le=0,z=j,q=0,he=H,Re=0,Xe=Y;if(b.content&&d){const We=b.content,pt=We[2]-We[0],wt=We[3]-We[1];(b.textFitWidth||b.textFitHeight)&&(P=U_(h)),te=ld(R,0,We[0]),le=ld(D,0,We[1]),ge=ld(R,We[0],We[2]),z=ld(D,We[1],We[3]),q=We[0]-te,Re=We[1]-le,he=pt-ge,Xe=wt-z}const Be=P.x1,Ve=P.y1,Je=P.x2-Be,Ye=P.y2-Ve,tt=(We,pt,wt,xt)=>{const _t=cd(We.stretch-te,ge,Je,Be),Kt=hd(We.fixed-q,he,We.stretch,U),Wr=cd(pt.stretch-le,z,Ye,Ve),ni=hd(pt.fixed-Re,Xe,pt.stretch,j),Bi=cd(wt.stretch-te,ge,Je,Be),bn=hd(wt.fixed-q,he,wt.stretch,U),on=cd(xt.stretch-le,z,Ye,Ve),Si=hd(xt.fixed-Re,Xe,xt.stretch,j),zr=new ie(_t,Wr),di=new ie(Bi,Wr),Ai=new ie(Bi,on),Ei=new ie(_t,on),Gi=new ie(Kt/v,ni/v),vn=new ie(bn/v,Si/v),fi=n*Math.PI/180;if(fi){const pi=Math.sin(fi),gi=Math.cos(fi),Jr=[gi,-pi,pi,gi];zr._matMult(Jr),di._matMult(Jr),Ei._matMult(Jr),Ai._matMult(Jr)}const an=We.stretch+We.fixed,si=pt.stretch+pt.fixed;return{tl:zr,tr:di,bl:Ei,br:Ai,tex:{x:b.paddedRect.x+1+an,y:b.paddedRect.y+1+si,w:wt.stretch+wt.fixed-an,h:xt.stretch+xt.fixed-si},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Gi,pixelOffsetBR:vn,minFontScaleX:he/v/Je,minFontScaleY:Xe/v/Ye,isSDF:c}};if(d&&(b.stretchX||b.stretchY)){const We=fy(R,H,U),pt=fy(D,Y,j);for(let wt=0;wt<We.length-1;wt++){const xt=We[wt],_t=We[wt+1];for(let Kt=0;Kt<pt.length-1;Kt++)m.push(tt(xt,pt[Kt],_t,pt[Kt+1]))}}else m.push(tt({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:w+1},{fixed:0,stretch:A+1}));return m}function ld(h,n,c){let d=0;for(const m of h)d+=Math.max(n,Math.min(c,m[1]))-Math.max(n,Math.min(c,m[0]));return d}function fy(h,n,c){const d=[{fixed:-1,stretch:0}];for(const[m,b]of h){const v=d[d.length-1];d.push({fixed:m-v.stretch,stretch:v.stretch}),d.push({fixed:m-v.stretch,stretch:v.stretch+(b-m)})}return d.push({fixed:n+1,stretch:c}),d}function cd(h,n,c,d){return h/n*c+d}function hd(h,n,c,d){return h-n*c/d}ht("Anchor",So);class ud{constructor(n,c,d,m,b,v,w,A,P,R){var D;if(this.boxStartIndex=n.length,P){let L=v.top,U=v.bottom;const j=v.collisionPadding;j&&(L-=j[1],U+=j[3]);let H=U-L;H>0&&(H=Math.max(10,H),this.circleDiameter=H)}else{const L=!((D=v.image)===null||D===void 0)&&D.content&&(v.image.textFitWidth||v.image.textFitHeight)?U_(v):{x1:v.left,y1:v.top,x2:v.right,y2:v.bottom};L.y1=L.y1*w-A[0],L.y2=L.y2*w+A[2],L.x1=L.x1*w-A[3],L.x2=L.x2*w+A[1];const U=v.collisionPadding;if(U&&(L.x1-=U[0]*w,L.y1-=U[1]*w,L.x2+=U[2]*w,L.y2+=U[3]*w),R){const j=new ie(L.x1,L.y1),H=new ie(L.x2,L.y1),Y=new ie(L.x1,L.y2),te=new ie(L.x2,L.y2),ge=R*Math.PI/180;j._rotate(ge),H._rotate(ge),Y._rotate(ge),te._rotate(ge),L.x1=Math.min(j.x,H.x,Y.x,te.x),L.x2=Math.max(j.x,H.x,Y.x,te.x),L.y1=Math.min(j.y,H.y,Y.y,te.y),L.y2=Math.max(j.y,H.y,Y.y,te.y)}n.emplaceBack(c.x,c.y,L.x1,L.y1,L.x2,L.y2,d,m,b)}this.boxEndIndex=n.length}}class k1{constructor(n=[],c=(d,m)=>d<m?-1:d>m?1:0){if(this.data=n,this.length=this.data.length,this.compare=c,this.length>0)for(let d=(this.length>>1)-1;d>=0;d--)this._down(d)}push(n){this.data.push(n),this._up(this.length++)}pop(){if(this.length===0)return;const n=this.data[0],c=this.data.pop();return--this.length>0&&(this.data[0]=c,this._down(0)),n}peek(){return this.data[0]}_up(n){const{data:c,compare:d}=this,m=c[n];for(;n>0;){const b=n-1>>1,v=c[b];if(d(m,v)>=0)break;c[n]=v,n=b}c[n]=m}_down(n){const{data:c,compare:d}=this,m=this.length>>1,b=c[n];for(;n<m;){let v=1+(n<<1);const w=v+1;if(w<this.length&&d(c[w],c[v])<0&&(v=w),d(c[v],b)>=0)break;c[n]=c[v],n=v}c[n]=b}}function D1(h,n=1,c=!1){const d=Ta.fromPoints(h[0]),m=Math.min(d.width(),d.height());let b=m/2;const v=new k1([],O1),{minX:w,minY:A,maxX:P,maxY:R}=d;if(m===0)return new ie(w,A);for(let U=w;U<P;U+=m)for(let j=A;j<R;j+=m)v.push(new Ol(U+b,j+b,b,h));let D=function(U){let j=0,H=0,Y=0;const te=U[0];for(let ge=0,le=te.length,z=le-1;ge<le;z=ge++){const q=te[ge],he=te[z],Re=q.x*he.y-he.x*q.y;H+=(q.x+he.x)*Re,Y+=(q.y+he.y)*Re,j+=3*Re}return new Ol(H/j,Y/j,0,U)}(h),L=v.length;for(;v.length;){const U=v.pop();(U.d>D.d||!D.d)&&(D=U,c&&console.log("found best %d after %d probes",Math.round(1e4*U.d)/1e4,L)),U.max-D.d<=n||(b=U.h/2,v.push(new Ol(U.p.x-b,U.p.y-b,b,h)),v.push(new Ol(U.p.x+b,U.p.y-b,b,h)),v.push(new Ol(U.p.x-b,U.p.y+b,b,h)),v.push(new Ol(U.p.x+b,U.p.y+b,b,h)),L+=4)}return c&&(console.log(`num probes: ${L}`),console.log(`best distance: ${D.d}`)),D.p}function O1(h,n){return n.max-h.max}function Ol(h,n,c,d){this.p=new ie(h,n),this.h=c,this.d=function(m,b){let v=!1,w=1/0;for(let A=0;A<b.length;A++){const P=b[A];for(let R=0,D=P.length,L=D-1;R<D;L=R++){const U=P[R],j=P[L];U.y>m.y!=j.y>m.y&&m.x<(j.x-U.x)*(m.y-U.y)/(j.y-U.y)+U.x&&(v=!v),w=Math.min(w,Zm(m,U,j))}}return(v?1:-1)*Math.sqrt(w)}(this.p,d),this.max=this.d+this.h*Math.SQRT2}var Fi;p.aD=void 0,(Fi=p.aD||(p.aD={}))[Fi.center=1]="center",Fi[Fi.left=2]="left",Fi[Fi.right=3]="right",Fi[Fi.top=4]="top",Fi[Fi.bottom=5]="bottom",Fi[Fi["top-left"]=6]="top-left",Fi[Fi["top-right"]=7]="top-right",Fi[Fi["bottom-left"]=8]="bottom-left",Fi[Fi["bottom-right"]=9]="bottom-right";const Sp=Number.POSITIVE_INFINITY;function py(h,n){return n[1]!==Sp?function(c,d,m){let b=0,v=0;switch(d=Math.abs(d),m=Math.abs(m),c){case"top-right":case"top-left":case"top":v=m-7;break;case"bottom-right":case"bottom-left":case"bottom":v=7-m}switch(c){case"top-right":case"bottom-right":case"right":b=-d;break;case"top-left":case"bottom-left":case"left":b=d}return[b,v]}(h,n[0],n[1]):function(c,d){let m=0,b=0;d<0&&(d=0);const v=d/Math.SQRT2;switch(c){case"top-right":case"top-left":b=v-7;break;case"bottom-right":case"bottom-left":b=7-v;break;case"bottom":b=7-d;break;case"top":b=d-7}switch(c){case"top-right":case"bottom-right":m=-v;break;case"top-left":case"bottom-left":m=v;break;case"left":m=d;break;case"right":m=-d}return[m,b]}(h,n[0])}function gy(h,n,c){var d;const m=h.layout,b=(d=m.get("text-variable-anchor-offset"))===null||d===void 0?void 0:d.evaluate(n,{},c);if(b){const w=b.values,A=[];for(let P=0;P<w.length;P+=2){const R=A[P]=w[P],D=w[P+1].map(L=>L*ui);R.startsWith("top")?D[1]-=7:R.startsWith("bottom")&&(D[1]+=7),A[P+1]=D}return new tr(A)}const v=m.get("text-variable-anchor");if(v){let w;w=h._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[m.get("text-radial-offset").evaluate(n,{},c)*ui,Sp]:m.get("text-offset").evaluate(n,{},c).map(P=>P*ui);const A=[];for(const P of v)A.push(P,py(P,w));return new tr(A)}return null}function Ap(h){switch(h){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function F1(h,n,c,d,m,b,v,w,A,P,R,D){let L=b.textMaxSize.evaluate(n,{});L===void 0&&(L=v);const U=h.layers[0].layout,j=U.get("icon-offset").evaluate(n,{},R),H=_y(c.horizontal),Y=v/24,te=h.tilePixelRatio*Y,ge=h.tilePixelRatio*L/24,le=h.tilePixelRatio*w,z=h.tilePixelRatio*U.get("symbol-spacing"),q=U.get("text-padding")*h.tilePixelRatio,he=function(wt,xt,_t,Kt=1){const Wr=wt.get("icon-padding").evaluate(xt,{},_t),ni=Wr&&Wr.values;return[ni[0]*Kt,ni[1]*Kt,ni[2]*Kt,ni[3]*Kt]}(U,n,R,h.tilePixelRatio),Re=U.get("text-max-angle")/180*Math.PI,Xe=U.get("text-rotation-alignment")!=="viewport"&&U.get("symbol-placement")!=="point",Be=U.get("icon-rotation-alignment")==="map"&&U.get("symbol-placement")!=="point",Ve=U.get("symbol-placement"),Je=z/2,Ye=U.get("icon-text-fit");let tt;d&&Ye!=="none"&&(h.allowVerticalPlacement&&c.vertical&&(tt=V_(d,c.vertical,Ye,U.get("icon-text-fit-padding"),j,Y)),H&&(d=V_(d,H,Ye,U.get("icon-text-fit-padding"),j,Y)));const We=R?D.line.getGranularityForZoomLevel(R.z):1,pt=(wt,xt)=>{xt.x<0||xt.x>=yt||xt.y<0||xt.y>=yt||function(_t,Kt,Wr,ni,Bi,bn,on,Si,zr,di,Ai,Ei,Gi,vn,fi,an,si,pi,gi,Jr,Er,qn,Fl,Yn,N1){const Bl=_t.addToLineVertexArray(Kt,Wr);let Sa,Ll,Nl,zl,xy=0,wy=0,Ty=0,Sy=0,Dp=-1,Op=-1;const Vs={};let Ay=Yi("");if(_t.allowVerticalPlacement&&ni.vertical){const Wi=Si.layout.get("text-rotate").evaluate(Er,{},Yn)+90;Nl=new ud(zr,Kt,di,Ai,Ei,ni.vertical,Gi,vn,fi,Wi),on&&(zl=new ud(zr,Kt,di,Ai,Ei,on,si,pi,fi,Wi))}if(Bi){const Wi=Si.layout.get("icon-rotate").evaluate(Er,{}),xn=Si.layout.get("icon-text-fit")!=="none",Aa=dy(Bi,Wi,Fl,xn),Kn=on?dy(on,Wi,Fl,xn):void 0;Ll=new ud(zr,Kt,di,Ai,Ei,Bi,si,pi,!1,Wi),xy=4*Aa.length;const Ea=_t.iconSizeData;let _s=null;Ea.kind==="source"?(_s=[Us*Si.layout.get("icon-size").evaluate(Er,{})],_s[0]>wo&&hr(`${_t.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):Ea.kind==="composite"&&(_s=[Us*qn.compositeIconSizes[0].evaluate(Er,{},Yn),Us*qn.compositeIconSizes[1].evaluate(Er,{},Yn)],(_s[0]>wo||_s[1]>wo)&&hr(`${_t.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),_t.addSymbols(_t.icon,Aa,_s,Jr,gi,Er,p.an.none,Kt,Bl.lineStartIndex,Bl.lineLength,-1,Yn),Dp=_t.icon.placedSymbolArray.length-1,Kn&&(wy=4*Kn.length,_t.addSymbols(_t.icon,Kn,_s,Jr,gi,Er,p.an.vertical,Kt,Bl.lineStartIndex,Bl.lineLength,-1,Yn),Op=_t.icon.placedSymbolArray.length-1)}const Ey=Object.keys(ni.horizontal);for(const Wi of Ey){const xn=ni.horizontal[Wi];if(!Sa){Ay=Yi(xn.text);const Kn=Si.layout.get("text-rotate").evaluate(Er,{},Yn);Sa=new ud(zr,Kt,di,Ai,Ei,xn,Gi,vn,fi,Kn)}const Aa=xn.positionedLines.length===1;if(Ty+=my(_t,Kt,xn,bn,Si,fi,Er,an,Bl,ni.vertical?p.an.horizontal:p.an.horizontalOnly,Aa?Ey:[Wi],Vs,Dp,qn,Yn),Aa)break}ni.vertical&&(Sy+=my(_t,Kt,ni.vertical,bn,Si,fi,Er,an,Bl,p.an.vertical,["vertical"],Vs,Op,qn,Yn));const z1=Sa?Sa.boxStartIndex:_t.collisionBoxArray.length,U1=Sa?Sa.boxEndIndex:_t.collisionBoxArray.length,V1=Nl?Nl.boxStartIndex:_t.collisionBoxArray.length,j1=Nl?Nl.boxEndIndex:_t.collisionBoxArray.length,$1=Ll?Ll.boxStartIndex:_t.collisionBoxArray.length,W1=Ll?Ll.boxEndIndex:_t.collisionBoxArray.length,H1=zl?zl.boxStartIndex:_t.collisionBoxArray.length,Z1=zl?zl.boxEndIndex:_t.collisionBoxArray.length;let Gn=-1;const fd=(Wi,xn)=>Wi&&Wi.circleDiameter?Math.max(Wi.circleDiameter,xn):xn;Gn=fd(Sa,Gn),Gn=fd(Nl,Gn),Gn=fd(Ll,Gn),Gn=fd(zl,Gn);const Iy=Gn>-1?1:0;Iy&&(Gn*=N1/ui),_t.glyphOffsetArray.length>=kl.MAX_GLYPHS&&hr("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Er.sortKey!==void 0&&_t.addToSortKeyRanges(_t.symbolInstances.length,Er.sortKey);const X1=gy(Si,Er,Yn),[q1,Y1]=function(Wi,xn){const Aa=Wi.length,Kn=xn?.values;if(Kn?.length>0)for(let Ea=0;Ea<Kn.length;Ea+=2){const _s=Kn[Ea+1];Wi.emplaceBack(p.aD[Kn[Ea]],_s[0],_s[1])}return[Aa,Wi.length]}(_t.textAnchorOffsets,X1);_t.symbolInstances.emplaceBack(Kt.x,Kt.y,Vs.right>=0?Vs.right:-1,Vs.center>=0?Vs.center:-1,Vs.left>=0?Vs.left:-1,Vs.vertical||-1,Dp,Op,Ay,z1,U1,V1,j1,$1,W1,H1,Z1,di,Ty,Sy,xy,wy,Iy,0,Gi,Gn,q1,Y1)}(h,xt,wt,c,d,m,tt,h.layers[0],h.collisionBoxArray,n.index,n.sourceLayerIndex,h.index,te,[q,q,q,q],Xe,A,le,he,Be,j,n,b,P,R,v)};if(Ve==="line")for(const wt of oy(n.geometry,0,0,yt,yt)){const xt=wa(wt,We),_t=R1(xt,z,Re,c.vertical||H,d,24,ge,h.overscaling,yt);for(const Kt of _t)H&&B1(h,H.text,Je,Kt)||pt(xt,Kt)}else if(Ve==="line-center"){for(const wt of n.geometry)if(wt.length>1){const xt=wa(wt,We),_t=M1(xt,Re,c.vertical||H,d,24,ge);_t&&pt(xt,_t)}}else if(n.type==="Polygon")for(const wt of tl(n.geometry,0)){const xt=D1(wt,16);pt(wa(wt[0],We,!0),new So(xt.x,xt.y,0))}else if(n.type==="LineString")for(const wt of n.geometry){const xt=wa(wt,We);pt(xt,new So(xt[0].x,xt[0].y,0))}else if(n.type==="Point")for(const wt of n.geometry)for(const xt of wt)pt([xt],new So(xt.x,xt.y,0))}function my(h,n,c,d,m,b,v,w,A,P,R,D,L,U,j){const H=function(ge,le,z,q,he,Re,Xe,Be){const Ve=q.layout.get("text-rotate").evaluate(Re,{})*Math.PI/180,Je=[];for(const Ye of le.positionedLines)for(const tt of Ye.positionedGlyphs){if(!tt.rect)continue;const We=tt.rect||{};let pt=4,wt=!0,xt=1,_t=0;const Kt=(he||Be)&&tt.vertical,Wr=tt.metrics.advance*tt.scale/2;if(Be&&le.verticalizable&&(_t=Ye.lineOffset/2-(tt.imageName?-(ui-tt.metrics.width*tt.scale)/2:(tt.scale-1)*ui)),tt.imageName){const pi=Xe[tt.imageName];wt=pi.sdf,xt=pi.pixelRatio,pt=1/xt}const ni=he?[tt.x+Wr,tt.y]:[0,0];let Bi=he?[0,0]:[tt.x+Wr+z[0],tt.y+z[1]-_t],bn=[0,0];Kt&&(bn=Bi,Bi=[0,0]);const on=tt.metrics.isDoubleResolution?2:1,Si=(tt.metrics.left-pt)*tt.scale-Wr+Bi[0],zr=(-tt.metrics.top-pt)*tt.scale+Bi[1],di=Si+We.w/on*tt.scale/xt,Ai=zr+We.h/on*tt.scale/xt,Ei=new ie(Si,zr),Gi=new ie(di,zr),vn=new ie(Si,Ai),fi=new ie(di,Ai);if(Kt){const pi=new ie(-Wr,Wr- -17),gi=-Math.PI/2,Jr=12-Wr,Er=new ie(22-Jr,-(tt.imageName?Jr:0)),qn=new ie(...bn);Ei._rotateAround(gi,pi)._add(Er)._add(qn),Gi._rotateAround(gi,pi)._add(Er)._add(qn),vn._rotateAround(gi,pi)._add(Er)._add(qn),fi._rotateAround(gi,pi)._add(Er)._add(qn)}if(Ve){const pi=Math.sin(Ve),gi=Math.cos(Ve),Jr=[gi,-pi,pi,gi];Ei._matMult(Jr),Gi._matMult(Jr),vn._matMult(Jr),fi._matMult(Jr)}const an=new ie(0,0),si=new ie(0,0);Je.push({tl:Ei,tr:Gi,bl:vn,br:fi,tex:We,writingMode:le.writingMode,glyphOffset:ni,sectionIndex:tt.sectionIndex,isSDF:wt,pixelOffsetTL:an,pixelOffsetBR:si,minFontScaleX:0,minFontScaleY:0})}return Je}(0,c,w,m,b,v,d,h.allowVerticalPlacement),Y=h.textSizeData;let te=null;Y.kind==="source"?(te=[Us*m.layout.get("text-size").evaluate(v,{})],te[0]>wo&&hr(`${h.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):Y.kind==="composite"&&(te=[Us*U.compositeTextSizes[0].evaluate(v,{},j),Us*U.compositeTextSizes[1].evaluate(v,{},j)],(te[0]>wo||te[1]>wo)&&hr(`${h.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),h.addSymbols(h.text,H,te,w,b,v,P,n,A.lineStartIndex,A.lineLength,L,j);for(const ge of R)D[ge]=h.text.placedSymbolArray.length-1;return 4*H.length}function _y(h){for(const n in h)return h[n];return null}function B1(h,n,c,d){const m=h.compareText;if(n in m){const b=m[n];for(let v=b.length-1;v>=0;v--)if(d.dist(b[v])<c)return!0}else m[n]=[];return m[n].push(d),!1}const yy=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Ep{static from(n){if(!(n instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[c,d]=new Uint8Array(n,0,2);if(c!==219)throw new Error("Data does not appear to be in a KDBush format.");const m=d>>4;if(m!==1)throw new Error(`Got v${m} data when expected v1.`);const b=yy[15&d];if(!b)throw new Error("Unrecognized array type.");const[v]=new Uint16Array(n,2,1),[w]=new Uint32Array(n,4,1);return new Ep(w,v,b,n)}constructor(n,c=64,d=Float64Array,m){if(isNaN(n)||n<0)throw new Error(`Unpexpected numItems value: ${n}.`);this.numItems=+n,this.nodeSize=Math.min(Math.max(+c,2),65535),this.ArrayType=d,this.IndexArrayType=n<65536?Uint16Array:Uint32Array;const b=yy.indexOf(this.ArrayType),v=2*n*this.ArrayType.BYTES_PER_ELEMENT,w=n*this.IndexArrayType.BYTES_PER_ELEMENT,A=(8-w%8)%8;if(b<0)throw new Error(`Unexpected typed array class: ${d}.`);m&&m instanceof ArrayBuffer?(this.data=m,this.ids=new this.IndexArrayType(this.data,8,n),this.coords=new this.ArrayType(this.data,8+w+A,2*n),this._pos=2*n,this._finished=!0):(this.data=new ArrayBuffer(8+v+w+A),this.ids=new this.IndexArrayType(this.data,8,n),this.coords=new this.ArrayType(this.data,8+w+A,2*n),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+b]),new Uint16Array(this.data,2,1)[0]=c,new Uint32Array(this.data,4,1)[0]=n)}add(n,c){const d=this._pos>>1;return this.ids[d]=d,this.coords[this._pos++]=n,this.coords[this._pos++]=c,d}finish(){const n=this._pos>>1;if(n!==this.numItems)throw new Error(`Added ${n} items when expected ${this.numItems}.`);return Ip(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(n,c,d,m){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:b,coords:v,nodeSize:w}=this,A=[0,b.length-1,0],P=[];for(;A.length;){const R=A.pop()||0,D=A.pop()||0,L=A.pop()||0;if(D-L<=w){for(let Y=L;Y<=D;Y++){const te=v[2*Y],ge=v[2*Y+1];te>=n&&te<=d&&ge>=c&&ge<=m&&P.push(b[Y])}continue}const U=L+D>>1,j=v[2*U],H=v[2*U+1];j>=n&&j<=d&&H>=c&&H<=m&&P.push(b[U]),(R===0?n<=j:c<=H)&&(A.push(L),A.push(U-1),A.push(1-R)),(R===0?d>=j:m>=H)&&(A.push(U+1),A.push(D),A.push(1-R))}return P}within(n,c,d){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:m,coords:b,nodeSize:v}=this,w=[0,m.length-1,0],A=[],P=d*d;for(;w.length;){const R=w.pop()||0,D=w.pop()||0,L=w.pop()||0;if(D-L<=v){for(let Y=L;Y<=D;Y++)vy(b[2*Y],b[2*Y+1],n,c)<=P&&A.push(m[Y]);continue}const U=L+D>>1,j=b[2*U],H=b[2*U+1];vy(j,H,n,c)<=P&&A.push(m[U]),(R===0?n-d<=j:c-d<=H)&&(w.push(L),w.push(U-1),w.push(1-R)),(R===0?n+d>=j:c+d>=H)&&(w.push(U+1),w.push(D),w.push(1-R))}return A}}function Ip(h,n,c,d,m,b){if(m-d<=c)return;const v=d+m>>1;by(h,n,v,d,m,b),Ip(h,n,c,d,v-1,1-b),Ip(h,n,c,v+1,m,1-b)}function by(h,n,c,d,m,b){for(;m>d;){if(m-d>600){const P=m-d+1,R=c-d+1,D=Math.log(P),L=.5*Math.exp(2*D/3),U=.5*Math.sqrt(D*L*(P-L)/P)*(R-P/2<0?-1:1);by(h,n,c,Math.max(d,Math.floor(c-R*L/P+U)),Math.min(m,Math.floor(c+(P-R)*L/P+U)),b)}const v=n[2*c+b];let w=d,A=m;for(Th(h,n,d,c),n[2*m+b]>v&&Th(h,n,d,m);w<A;){for(Th(h,n,w,A),w++,A--;n[2*w+b]<v;)w++;for(;n[2*A+b]>v;)A--}n[2*d+b]===v?Th(h,n,d,A):(A++,Th(h,n,A,m)),A<=c&&(d=A+1),c<=A&&(m=A-1)}}function Th(h,n,c,d){Cp(h,c,d),Cp(n,2*c,2*d),Cp(n,2*c+1,2*d+1)}function Cp(h,n,c){const d=h[n];h[n]=h[c],h[c]=d}function vy(h,n,c,d){const m=h-c,b=n-d;return m*m+b*b}var Pp;p.cw=void 0,(Pp=p.cw||(p.cw={})).create="create",Pp.load="load",Pp.fullLoad="fullLoad";let dd=null,Sh=[];const Mp=1e3/60,Rp="loadTime",kp="fullLoadTime",L1={mark(h){performance.mark(h)},frame(h){const n=h;dd!=null&&Sh.push(n-dd),dd=n},clearMetrics(){dd=null,Sh=[],performance.clearMeasures(Rp),performance.clearMeasures(kp);for(const h in p.cw)performance.clearMarks(p.cw[h])},getPerformanceMetrics(){performance.measure(Rp,p.cw.create,p.cw.load),performance.measure(kp,p.cw.create,p.cw.fullLoad);const h=performance.getEntriesByName(Rp)[0].duration,n=performance.getEntriesByName(kp)[0].duration,c=Sh.length,d=1/(Sh.reduce((b,v)=>b+v,0)/c/1e3),m=Sh.filter(b=>b>Mp).reduce((b,v)=>b+(v-Mp)/Mp,0);return{loadTime:h,fullLoadTime:n,fps:d,percentDroppedFrames:m/(c+m)*100,totalFrames:c}}};p.$=yt,p.A=Ke,p.B=function([h,n,c]){return n+=90,n*=Math.PI/180,c*=Math.PI/180,{x:h*Math.cos(n)*Math.sin(c),y:h*Math.sin(n)*Math.sin(c),z:h*Math.cos(c)}},p.C=nn,p.D=gt,p.E=He,p.F=Rr,p.G=bl,p.H=function(h){if(Mi==null){const n=h.navigator?h.navigator.userAgent:null;Mi=!!h.safari||!(!n||!(/\b(iPad|iPhone|iPod)\b/.test(n)||n.match("Safari")&&!n.match("Chrome")))}return Mi},p.I=fp,p.J=class{constructor(h,n){this.target=h,this.mapId=n,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new I1(()=>this.process()),this.subscription=_r(this.target,"message",c=>this.receive(c),!1),this.globalScope=Qt(self)?h:window}registerMessageHandler(h,n){this.messageHandlers[h]=n}sendAsync(h,n){return new Promise((c,d)=>{const m=Math.round(1e18*Math.random()).toString(36).substring(0,10),b=n?_r(n.signal,"abort",()=>{b?.unsubscribe(),delete this.resolveRejects[m];const A={id:m,type:"<cancel>",origin:location.origin,targetMapId:h.targetMapId,sourceMapId:this.mapId};this.target.postMessage(A)},C1):null;this.resolveRejects[m]={resolve:A=>{b?.unsubscribe(),c(A)},reject:A=>{b?.unsubscribe(),d(A)}};const v=[],w=Object.assign(Object.assign({},h),{id:m,sourceMapId:this.mapId,origin:location.origin,data:ha(h.data,v)});this.target.postMessage(w,{transfer:v})})}receive(h){const n=h.data,c=n.id;if(!(n.origin!=="file://"&&location.origin!=="file://"&&n.origin!=="resource://android"&&location.origin!=="resource://android"&&n.origin!==location.origin||n.targetMapId&&this.mapId!==n.targetMapId)){if(n.type==="<cancel>"){delete this.tasks[c];const d=this.abortControllers[c];return delete this.abortControllers[c],void(d&&d.abort())}if(Qt(self)||n.mustQueue)return this.tasks[c]=n,this.taskQueue.push(c),void this.invoker.trigger();this.processTask(c,n)}}process(){if(this.taskQueue.length===0)return;const h=this.taskQueue.shift(),n=this.tasks[h];delete this.tasks[h],this.taskQueue.length>0&&this.invoker.trigger(),n&&this.processTask(h,n)}processTask(h,n){return o(this,void 0,void 0,function*(){if(n.type==="<response>"){const m=this.resolveRejects[h];return delete this.resolveRejects[h],m?void(n.error?m.reject(yo(n.error)):m.resolve(yo(n.data))):void 0}if(!this.messageHandlers[n.type])return void this.completeTask(h,new Error(`Could not find a registered handler for ${n.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const c=yo(n.data),d=new AbortController;this.abortControllers[h]=d;try{const m=yield this.messageHandlers[n.type](n.sourceMapId,c,d);this.completeTask(h,null,m)}catch(m){this.completeTask(h,m)}})}completeTask(h,n,c){const d=[];delete this.abortControllers[h];const m={id:h,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:n?ha(n):null,data:ha(c,d)};this.target.postMessage(m,{transfer:d})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},p.K=K,p.L=function(){var h=new Ke(16);return Ke!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=0,h[12]=0,h[13]=0,h[14]=0),h[0]=1,h[5]=1,h[10]=1,h[15]=1,h},p.M=function(h,n,c){var d,m,b,v,w,A,P,R,D,L,U,j,H=c[0],Y=c[1],te=c[2];return n===h?(h[12]=n[0]*H+n[4]*Y+n[8]*te+n[12],h[13]=n[1]*H+n[5]*Y+n[9]*te+n[13],h[14]=n[2]*H+n[6]*Y+n[10]*te+n[14],h[15]=n[3]*H+n[7]*Y+n[11]*te+n[15]):(m=n[1],b=n[2],v=n[3],w=n[4],A=n[5],P=n[6],R=n[7],D=n[8],L=n[9],U=n[10],j=n[11],h[0]=d=n[0],h[1]=m,h[2]=b,h[3]=v,h[4]=w,h[5]=A,h[6]=P,h[7]=R,h[8]=D,h[9]=L,h[10]=U,h[11]=j,h[12]=d*H+w*Y+D*te+n[12],h[13]=m*H+A*Y+L*te+n[13],h[14]=b*H+P*Y+U*te+n[14],h[15]=v*H+R*Y+j*te+n[15]),h},p.N=function(h,n,c){var d=c[0],m=c[1],b=c[2];return h[0]=n[0]*d,h[1]=n[1]*d,h[2]=n[2]*d,h[3]=n[3]*d,h[4]=n[4]*m,h[5]=n[5]*m,h[6]=n[6]*m,h[7]=n[7]*m,h[8]=n[8]*b,h[9]=n[9]*b,h[10]=n[10]*b,h[11]=n[11]*b,h[12]=n[12],h[13]=n[13],h[14]=n[14],h[15]=n[15],h},p.O=function(h,n,c){var d=n[0],m=n[1],b=n[2],v=n[3],w=n[4],A=n[5],P=n[6],R=n[7],D=n[8],L=n[9],U=n[10],j=n[11],H=n[12],Y=n[13],te=n[14],ge=n[15],le=c[0],z=c[1],q=c[2],he=c[3];return h[0]=le*d+z*w+q*D+he*H,h[1]=le*m+z*A+q*L+he*Y,h[2]=le*b+z*P+q*U+he*te,h[3]=le*v+z*R+q*j+he*ge,h[4]=(le=c[4])*d+(z=c[5])*w+(q=c[6])*D+(he=c[7])*H,h[5]=le*m+z*A+q*L+he*Y,h[6]=le*b+z*P+q*U+he*te,h[7]=le*v+z*R+q*j+he*ge,h[8]=(le=c[8])*d+(z=c[9])*w+(q=c[10])*D+(he=c[11])*H,h[9]=le*m+z*A+q*L+he*Y,h[10]=le*b+z*P+q*U+he*te,h[11]=le*v+z*R+q*j+he*ge,h[12]=(le=c[12])*d+(z=c[13])*w+(q=c[14])*D+(he=c[15])*H,h[13]=le*m+z*A+q*L+he*Y,h[14]=le*b+z*P+q*U+he*te,h[15]=le*v+z*R+q*j+he*ge,h},p.P=ie,p.Q=function(h,n){const c={};for(let d=0;d<n.length;d++){const m=n[d];m in h&&(c[m]=h[m])}return c},p.R=sn,p.S=To,p.T=Jf,p.U=K_,p.V=G_,p.W=Le,p.X=Ue,p.Y=en,p.Z=yn,p._=o,p.a=Z,p.a$=function(h,n,c){return h[0]=n[0]*c,h[1]=n[1]*c,h[2]=n[2]*c,h[3]=n[3]*c,h},p.a0=wh,p.a1=Ta,p.a2=25,p.a3=Tp,p.a4=h=>{const n=window.document.createElement("video");return n.muted=!0,new Promise(c=>{n.onloadstart=()=>{c(n)};for(const d of h){const m=window.document.createElement("source");De(d)||(n.crossOrigin="Anonymous"),m.src=d,n.appendChild(m)}})},p.a5=rt,p.a6=function(){return mr++},p.a7=J,p.a8=kl,p.a9=as,p.aA=ui,p.aB=bt,p.aC=function(h,n,c,d,m=!1){if(!c[0]&&!c[1])return[0,0];const b=m?d==="map"?-h.bearingInRadians:0:d==="viewport"?h.bearingInRadians:0;if(b){const v=Math.sin(b),w=Math.cos(b);c=[c[0]*w-c[1]*v,c[0]*v+c[1]*w]}return[m?c[0]:bt(n,c[0],h.zoom),m?c[1]:bt(n,c[1],h.zoom)]},p.aE=mp,p.aF=Ap,p.aG=gp,p.aH=Ep,p.aI=$r,p.aJ=td,p.aK=Ce,p.aL=rr,p.aM=br,p.aN=gr,p.aO=Yr,p.aP=Q_,p.aQ=mt,p.aR=at,p.aS=function(h){var n=new Ke(3);return n[0]=h[0],n[1]=h[1],n[2]=h[2],n},p.aT=function(h,n,c){return h[0]=n[0]-c[0],h[1]=n[1]-c[1],h[2]=n[2]-c[2],h},p.aU=function(h,n){var c=n[0],d=n[1],m=n[2],b=c*c+d*d+m*m;return b>0&&(b=1/Math.sqrt(b)),h[0]=n[0]*b,h[1]=n[1]*b,h[2]=n[2]*b,h},p.aV=At,p.aW=function(h,n){return h[0]*n[0]+h[1]*n[1]+h[2]*n[2]},p.aX=function(h,n,c){return h[0]=n[0]*c[0],h[1]=n[1]*c[1],h[2]=n[2]*c[2],h[3]=n[3]*c[3],h},p.aY=ze,p.aZ=function(h,n,c){const d=n[0]*c[0]+n[1]*c[1]+n[2]*c[2];return d===0?null:(-(h[0]*c[0]+h[1]*c[1]+h[2]*c[2])-c[3])/d},p.a_=ti,p.aa=va,p.ab=iy,p.ac=function(h){const n={};if(h.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(c,d,m,b)=>{const v=m||b;return n[d]=!v||v.toLowerCase(),""}),n["max-age"]){const c=parseInt(n["max-age"],10);isNaN(c)?delete n["max-age"]:n["max-age"]=c}return n},p.ad=yr,p.ae=function(h){return Math.pow(2,h)},p.af=me,p.ag=kt,p.ah=85.051129,p.ai=J_,p.aj=function(h){return Math.log(h)/Math.LN2},p.ak=function(h){var n=h[0],c=h[1];return n*n+c*c},p.al=function(h,n){const c=[];for(const d in h)d in n||c.push(d);return c},p.am=function(h,n){let c=0,d=0;if(h.kind==="constant")d=h.layoutSize;else if(h.kind!=="source"){const{interpolationType:m,minZoom:b,maxZoom:v}=h,w=m?kt(Ui.interpolationFactor(m,n,b,v),0,1):0;h.kind==="camera"?d=nn.number(h.minSize,h.maxSize,w):c=w}return{uSizeT:c,uSize:d}},p.ao=function(h,{uSize:n,uSizeT:c},{lowerSize:d,upperSize:m}){return h.kind==="source"?d/Us:h.kind==="composite"?nn.number(d/Us,m/Us,c):n},p.ap=function(h,n){var c=n[0],d=n[1],m=n[2],b=n[3],v=n[4],w=n[5],A=n[6],P=n[7],R=n[8],D=n[9],L=n[10],U=n[11],j=n[12],H=n[13],Y=n[14],te=n[15],ge=c*w-d*v,le=c*A-m*v,z=c*P-b*v,q=d*A-m*w,he=d*P-b*w,Re=m*P-b*A,Xe=R*H-D*j,Be=R*Y-L*j,Ve=R*te-U*j,Je=D*Y-L*H,Ye=D*te-U*H,tt=L*te-U*Y,We=ge*tt-le*Ye+z*Je+q*Ve-he*Be+Re*Xe;return We?(h[0]=(w*tt-A*Ye+P*Je)*(We=1/We),h[1]=(m*Ye-d*tt-b*Je)*We,h[2]=(H*Re-Y*he+te*q)*We,h[3]=(L*he-D*Re-U*q)*We,h[4]=(A*Ve-v*tt-P*Be)*We,h[5]=(c*tt-m*Ve+b*Be)*We,h[6]=(Y*z-j*Re-te*le)*We,h[7]=(R*Re-L*z+U*le)*We,h[8]=(v*Ye-w*Ve+P*Xe)*We,h[9]=(d*Ve-c*Ye-b*Xe)*We,h[10]=(j*he-H*z+te*ge)*We,h[11]=(D*z-R*he-U*ge)*We,h[12]=(w*Be-v*Je-A*Xe)*We,h[13]=(c*Je-d*Be+m*Xe)*We,h[14]=(H*le-j*q-Y*ge)*We,h[15]=(R*q-D*le+L*ge)*We,h):null},p.aq=Vr,p.ar=function(h){return Math.hypot(h[0],h[1])},p.as=function(h){return h[0]=0,h[1]=0,h},p.at=function(h,n,c){return h[0]=n[0]*c,h[1]=n[1]*c,h},p.au=_p,p.av=Bt,p.aw=function(h,n,c,d){const m=n.y-h.y,b=n.x-h.x,v=d.y-c.y,w=d.x-c.x,A=v*b-w*m;if(A===0)return null;const P=(w*(h.y-c.y)-v*(h.x-c.x))/A;return new ie(h.x+P*b,h.y+P*m)},p.ax=oy,p.ay=Wm,p.az=function(h){let n=1/0,c=1/0,d=-1/0,m=-1/0;for(const b of h)n=Math.min(n,b.x),c=Math.min(c,b.y),d=Math.max(d,b.x),m=Math.max(m,b.y);return[n,c,d,m]},p.b=Ni,p.b$=n1,p.b0=function(h,n){return h[0]*n[0]+h[1]*n[1]+h[2]*n[2]+h[3]},p.b1=ty,p.b2=Dl,p.b3=function(h,n,c,d,m){var b,v=1/Math.tan(n/2);return h[0]=v/c,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=v,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=-1,h[12]=0,h[13]=0,h[15]=0,m!=null&&m!==1/0?(h[10]=(m+d)*(b=1/(d-m)),h[14]=2*m*d*b):(h[10]=-1,h[14]=-2*d),h},p.b4=function(h){var n=new Ke(16);return n[0]=h[0],n[1]=h[1],n[2]=h[2],n[3]=h[3],n[4]=h[4],n[5]=h[5],n[6]=h[6],n[7]=h[7],n[8]=h[8],n[9]=h[9],n[10]=h[10],n[11]=h[11],n[12]=h[12],n[13]=h[13],n[14]=h[14],n[15]=h[15],n},p.b5=function(h,n,c){var d=Math.sin(c),m=Math.cos(c),b=n[0],v=n[1],w=n[2],A=n[3],P=n[4],R=n[5],D=n[6],L=n[7];return n!==h&&(h[8]=n[8],h[9]=n[9],h[10]=n[10],h[11]=n[11],h[12]=n[12],h[13]=n[13],h[14]=n[14],h[15]=n[15]),h[0]=b*m+P*d,h[1]=v*m+R*d,h[2]=w*m+D*d,h[3]=A*m+L*d,h[4]=P*m-b*d,h[5]=R*m-v*d,h[6]=D*m-w*d,h[7]=L*m-A*d,h},p.b6=function(h,n,c){var d=Math.sin(c),m=Math.cos(c),b=n[4],v=n[5],w=n[6],A=n[7],P=n[8],R=n[9],D=n[10],L=n[11];return n!==h&&(h[0]=n[0],h[1]=n[1],h[2]=n[2],h[3]=n[3],h[12]=n[12],h[13]=n[13],h[14]=n[14],h[15]=n[15]),h[4]=b*m+P*d,h[5]=v*m+R*d,h[6]=w*m+D*d,h[7]=A*m+L*d,h[8]=P*m-b*d,h[9]=R*m-v*d,h[10]=D*m-w*d,h[11]=L*m-A*d,h},p.b7=function(){const h=new Float32Array(16);return me(h),h},p.b8=function(){const h=new Float64Array(16);return me(h),h},p.b9=function(){return new Float64Array(16)},p.bA=function(h){return h[0]=0,h[1]=0,h[2]=0,h},p.bB=function(h,n,c,d){const m=Math.sqrt(h*h+n*n),b=Math.sqrt(c*c+d*d);h/=m,n/=m,c/=b,d/=b;const v=Math.acos(h*c+n*d);return-n*c+h*d>0?v:-v},p.bC=function(h,n){const c=ar(h,2*Math.PI),d=ar(n,2*Math.PI);return Math.min(Math.abs(c-d),Math.abs(c-d+2*Math.PI),Math.abs(c-d-2*Math.PI))},p.bD=function(){const h={},n=fe.$version;for(const c in fe.$root){const d=fe.$root[c];if(d.required){let m=null;m=c==="version"?n:d.type==="array"?[]:{},m!=null&&(h[c]=m)}}return h},p.bE=Yc,p.bF=pe,p.bG=function h(n,c){if(Array.isArray(n)){if(!Array.isArray(c)||n.length!==c.length)return!1;for(let d=0;d<n.length;d++)if(!h(n[d],c[d]))return!1;return!0}if(typeof n=="object"&&n!==null&&c!==null){if(typeof c!="object"||Object.keys(n).length!==Object.keys(c).length)return!1;for(const d in n)if(!h(n[d],c[d]))return!1;return!0}return n===c},p.bH=function(h){h=h.slice();const n=Object.create(null);for(let c=0;c<h.length;c++)n[h[c].id]=h[c];for(let c=0;c<h.length;c++)"ref"in h[c]&&(h[c]=Et(h[c],n[h[c].ref]));return h},p.bI=function(h){if(h.type==="custom")return new E1(h);switch(h.type){case"background":return new T1(h);case"circle":return new _w(h);case"color-relief":return new Tw(h);case"fill":return new Nw(h);case"fill-extrusion":return new Zw(h);case"heatmap":return new bw(h);case"hillshade":return new xw(h);case"line":return new e1(h);case"raster":return new A1(h);case"symbol":return new ad(h)}},p.bJ=Gt,p.bK=function(h,n){if(!h)return[{command:"setStyle",args:[n]}];let c=[];try{if(!ut(h.version,n.version))return[{command:"setStyle",args:[n]}];ut(h.center,n.center)||c.push({command:"setCenter",args:[n.center]}),ut(h.state,n.state)||c.push({command:"setGlobalState",args:[n.state]}),ut(h.centerAltitude,n.centerAltitude)||c.push({command:"setCenterAltitude",args:[n.centerAltitude]}),ut(h.zoom,n.zoom)||c.push({command:"setZoom",args:[n.zoom]}),ut(h.bearing,n.bearing)||c.push({command:"setBearing",args:[n.bearing]}),ut(h.pitch,n.pitch)||c.push({command:"setPitch",args:[n.pitch]}),ut(h.roll,n.roll)||c.push({command:"setRoll",args:[n.roll]}),ut(h.sprite,n.sprite)||c.push({command:"setSprite",args:[n.sprite]}),ut(h.glyphs,n.glyphs)||c.push({command:"setGlyphs",args:[n.glyphs]}),ut(h.transition,n.transition)||c.push({command:"setTransition",args:[n.transition]}),ut(h.light,n.light)||c.push({command:"setLight",args:[n.light]}),ut(h.terrain,n.terrain)||c.push({command:"setTerrain",args:[n.terrain]}),ut(h.sky,n.sky)||c.push({command:"setSky",args:[n.sky]}),ut(h.projection,n.projection)||c.push({command:"setProjection",args:[n.projection]});const d={},m=[];(function(v,w,A,P){let R;for(R in w=w||{},v=v||{})Object.prototype.hasOwnProperty.call(v,R)&&(Object.prototype.hasOwnProperty.call(w,R)||Tr(R,A,P));for(R in w)Object.prototype.hasOwnProperty.call(w,R)&&(Object.prototype.hasOwnProperty.call(v,R)?ut(v[R],w[R])||(v[R].type==="geojson"&&w[R].type==="geojson"&&ir(v,w,R)?vt(A,{command:"setGeoJSONSourceData",args:[R,w[R].data]}):lr(R,w,A,P)):Dt(R,w,A))})(h.sources,n.sources,m,d);const b=[];h.layers&&h.layers.forEach(v=>{"source"in v&&d[v.source]?c.push({command:"removeLayer",args:[v.id]}):b.push(v)}),c=c.concat(m),function(v,w,A){w=w||[];const P=(v=v||[]).map(er),R=w.map(er),D=v.reduce(ai,{}),L=w.reduce(ai,{}),U=P.slice(),j=Object.create(null);let H,Y,te,ge,le;for(let z=0,q=0;z<P.length;z++)H=P[z],Object.prototype.hasOwnProperty.call(L,H)?q++:(vt(A,{command:"removeLayer",args:[H]}),U.splice(U.indexOf(H,q),1));for(let z=0,q=0;z<R.length;z++)H=R[R.length-1-z],U[U.length-1-z]!==H&&(Object.prototype.hasOwnProperty.call(D,H)?(vt(A,{command:"removeLayer",args:[H]}),U.splice(U.lastIndexOf(H,U.length-q),1)):q++,ge=U[U.length-z],vt(A,{command:"addLayer",args:[L[H],ge]}),U.splice(U.length-z,0,H),j[H]=!0);for(let z=0;z<R.length;z++)if(H=R[z],Y=D[H],te=L[H],!j[H]&&!ut(Y,te))if(ut(Y.source,te.source)&&ut(Y["source-layer"],te["source-layer"])&&ut(Y.type,te.type)){for(le in Mt(Y.layout,te.layout,A,H,null,"setLayoutProperty"),Mt(Y.paint,te.paint,A,H,null,"setPaintProperty"),ut(Y.filter,te.filter)||vt(A,{command:"setFilter",args:[H,te.filter]}),ut(Y.minzoom,te.minzoom)&&ut(Y.maxzoom,te.maxzoom)||vt(A,{command:"setLayerZoomRange",args:[H,te.minzoom,te.maxzoom]}),Y)Object.prototype.hasOwnProperty.call(Y,le)&&le!=="layout"&&le!=="paint"&&le!=="filter"&&le!=="metadata"&&le!=="minzoom"&&le!=="maxzoom"&&(le.indexOf("paint.")===0?Mt(Y[le],te[le],A,H,le.slice(6),"setPaintProperty"):ut(Y[le],te[le])||vt(A,{command:"setLayerProperty",args:[H,le,te[le]]}));for(le in te)Object.prototype.hasOwnProperty.call(te,le)&&!Object.prototype.hasOwnProperty.call(Y,le)&&le!=="layout"&&le!=="paint"&&le!=="filter"&&le!=="metadata"&&le!=="minzoom"&&le!=="maxzoom"&&(le.indexOf("paint.")===0?Mt(Y[le],te[le],A,H,le.slice(6),"setPaintProperty"):ut(Y[le],te[le])||vt(A,{command:"setLayerProperty",args:[H,le,te[le]]}))}else vt(A,{command:"removeLayer",args:[H]}),ge=U[U.lastIndexOf(H)+1],vt(A,{command:"addLayer",args:[te,ge]})}(b,n.layers,c)}catch(d){console.warn("Unable to compute style diff:",d),c=[{command:"setStyle",args:[n]}]}return c},p.bL=function(h){const n=[],c=h.id;return c===void 0&&n.push({message:`layers.${c}: missing required property "id"`}),h.render===void 0&&n.push({message:`layers.${c}: missing required method "render"`}),h.renderingMode&&h.renderingMode!=="2d"&&h.renderingMode!=="3d"&&n.push({message:`layers.${c}: property "renderingMode" must be either "2d" or "3d"`}),n},p.bM=zt,p.bN=Jt,p.bO=class extends Ar{constructor(h,n){super(h,n),this.current=0}set(h){this.current!==h&&(this.current=h,this.gl.uniform1i(this.location,h))}},p.bP=Gu,p.bQ=class extends Ar{constructor(h,n){super(h,n),this.current=Hf}set(h){if(h[12]!==this.current[12]||h[0]!==this.current[0])return this.current=h,void this.gl.uniformMatrix4fv(this.location,!1,h);for(let n=1;n<16;n++)if(h[n]!==this.current[n]){this.current=h,this.gl.uniformMatrix4fv(this.location,!1,h);break}}},p.bR=ii,p.bS=class extends Ar{constructor(h,n){super(h,n),this.current=[0,0,0]}set(h){h[0]===this.current[0]&&h[1]===this.current[1]&&h[2]===this.current[2]||(this.current=h,this.gl.uniform3f(this.location,h[0],h[1],h[2]))}},p.bT=class extends Ar{constructor(h,n){super(h,n),this.current=[0,0]}set(h){h[0]===this.current[0]&&h[1]===this.current[1]||(this.current=h,this.gl.uniform2f(this.location,h[0],h[1]))}},p.bU=ct,p.bV=function(h,n){var c=Math.sin(n),d=Math.cos(n);return h[0]=d,h[1]=c,h[2]=0,h[3]=-c,h[4]=d,h[5]=0,h[6]=0,h[7]=0,h[8]=1,h},p.bW=function(h,n,c){var d=n[0],m=n[1],b=n[2];return h[0]=d*c[0]+m*c[3]+b*c[6],h[1]=d*c[1]+m*c[4]+b*c[7],h[2]=d*c[2]+m*c[5]+b*c[8],h},p.bX=function(h,n,c,d,m,b,v){var w=1/(n-c),A=1/(d-m),P=1/(b-v);return h[0]=-2*w,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=-2*A,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=2*P,h[11]=0,h[12]=(n+c)*w,h[13]=(m+d)*A,h[14]=(v+b)*P,h[15]=1,h},p.bY=class extends Ar{constructor(h,n){super(h,n),this.current=new Array}set(h){if(h!=this.current){this.current=h;const n=new Float32Array(4*h.length);for(let c=0;c<h.length;c++)n[4*c]=h[c].r,n[4*c+1]=h[c].g,n[4*c+2]=h[c].b,n[4*c+3]=h[c].a;this.gl.uniform4fv(this.location,n)}}},p.bZ=class extends Ar{constructor(h,n){super(h,n),this.current=new Array}set(h){if(h!=this.current){this.current=h;const n=new Float32Array(h);this.gl.uniform1fv(this.location,n)}}},p.b_=class extends f{},p.ba=function(h,n,c){const d=new Float64Array(4);return Rt(d,h,n-90,c),d},p.bb=function(h,n,c,d){var m,b,v,w,A,P=n[0],R=n[1],D=n[2],L=n[3],U=c[0],j=c[1],H=c[2],Y=c[3];return(b=P*U+R*j+D*H+L*Y)<0&&(b=-b,U=-U,j=-j,H=-H,Y=-Y),1-b>et?(m=Math.acos(b),v=Math.sin(m),w=Math.sin((1-d)*m)/v,A=Math.sin(d*m)/v):(w=1-d,A=d),h[0]=w*P+A*U,h[1]=w*R+A*j,h[2]=w*D+A*H,h[3]=w*L+A*Y,h},p.bc=function(h){const n=new Float64Array(9);var c,d,m,b,v,w,A,P,R,D,L,U,j,H,Y,te,ge,le;D=(m=(d=h)[0])*(A=m+m),L=(b=d[1])*A,j=(v=d[2])*A,H=v*(P=b+b),te=(w=d[3])*A,ge=w*P,le=w*(R=v+v),(c=n)[0]=1-(U=b*P)-(Y=v*R),c[3]=L-le,c[6]=j+ge,c[1]=L+le,c[4]=1-D-Y,c[7]=H-te,c[2]=j-ge,c[5]=H+te,c[8]=1-D-U;const z=Yr(-Math.asin(kt(n[2],-1,1)));let q,he;return Math.hypot(n[5],n[8])<.001?(q=0,he=-Yr(Math.atan2(n[3],n[4]))):(q=Yr(n[5]===0&&n[8]===0?0:Math.atan2(n[5],n[8])),he=Yr(n[1]===0&&n[0]===0?0:Math.atan2(n[1],n[0]))),{roll:q,pitch:z+90,bearing:he}},p.bd=function(h,n){return h.roll==n.roll&&h.pitch==n.pitch&&h.bearing==n.bearing},p.be=Xt,p.bf=$i,p.bg=Ml,p.bh=gh,p.bi=Pl,p.bj=cr,p.bk=Mr,p.bl=Ft,p.bm=function(h,n,c,d,m){return cr(d,m,kt((h-n)/(c-n),0,1))},p.bn=ar,p.bo=function(){return new Float64Array(3)},p.bp=function(h,n,c,d){return h[0]=n[0]+c[0]*d,h[1]=n[1]+c[1]*d,h[2]=n[2]+c[2]*d,h},p.bq=Rt,p.br=function(h,n,c){var d=c[0],m=c[1],b=c[2],v=n[0],w=n[1],A=n[2],P=m*A-b*w,R=b*v-d*A,D=d*w-m*v,L=m*D-b*R,U=b*P-d*D,j=d*R-m*P,H=2*c[3];return R*=H,D*=H,U*=2,j*=2,h[0]=v+(P*=H)+(L*=2),h[1]=w+R+U,h[2]=A+D+j,h},p.bs=function(h,n,c){const d=(m=[h[0],h[1],h[2],n[0],n[1],n[2],c[0],c[1],c[2]])[0]*((R=m[8])*(v=m[4])-(w=m[5])*(P=m[7]))+m[1]*(-R*(b=m[3])+w*(A=m[6]))+m[2]*(P*b-v*A);var m,b,v,w,A,P,R;if(d===0)return null;const D=At([],[n[0],n[1],n[2]],[c[0],c[1],c[2]]),L=At([],[c[0],c[1],c[2]],[h[0],h[1],h[2]]),U=At([],[h[0],h[1],h[2]],[n[0],n[1],n[2]]),j=mt([],D,-h[3]);return at(j,j,mt([],L,-n[3])),at(j,j,mt([],U,-c[3])),mt(j,j,1/d),j},p.bt=xp,p.bu=function(){return new Float64Array(4)},p.bv=function(h,n,c,d){var m=[],b=[];return m[0]=n[0]-c[0],m[1]=n[1]-c[1],m[2]=n[2]-c[2],b[0]=m[0]*Math.cos(d)-m[1]*Math.sin(d),b[1]=m[0]*Math.sin(d)+m[1]*Math.cos(d),b[2]=m[2],h[0]=b[0]+c[0],h[1]=b[1]+c[1],h[2]=b[2]+c[2],h},p.bw=function(h,n,c,d){var m=[],b=[];return m[0]=n[0]-c[0],m[1]=n[1]-c[1],m[2]=n[2]-c[2],b[0]=m[0],b[1]=m[1]*Math.cos(d)-m[2]*Math.sin(d),b[2]=m[1]*Math.sin(d)+m[2]*Math.cos(d),h[0]=b[0]+c[0],h[1]=b[1]+c[1],h[2]=b[2]+c[2],h},p.bx=function(h,n,c,d){var m=[],b=[];return m[0]=n[0]-c[0],m[1]=n[1]-c[1],m[2]=n[2]-c[2],b[0]=m[2]*Math.sin(d)+m[0]*Math.cos(d),b[1]=m[1],b[2]=m[2]*Math.cos(d)-m[0]*Math.sin(d),h[0]=b[0]+c[0],h[1]=b[1]+c[1],h[2]=b[2]+c[2],h},p.by=function(h,n,c){var d=Math.sin(c),m=Math.cos(c),b=n[0],v=n[1],w=n[2],A=n[3],P=n[8],R=n[9],D=n[10],L=n[11];return n!==h&&(h[4]=n[4],h[5]=n[5],h[6]=n[6],h[7]=n[7],h[12]=n[12],h[13]=n[13],h[14]=n[14],h[15]=n[15]),h[0]=b*m-P*d,h[1]=v*m-R*d,h[2]=w*m-D*d,h[3]=A*m-L*d,h[8]=b*d+P*m,h[9]=v*d+R*m,h[10]=w*d+D*m,h[11]=A*d+L*m,h},p.bz=function(h,n){const c=ar(h,360),d=ar(n,360),m=d-c,b=d>c?m-360:m+360;return Math.abs(m)<Math.abs(b)?m:b},p.c=be,p.c0=class extends y{},p.c1=Kf,p.c2=function(h){return h<=1?1:Math.pow(2,Math.ceil(Math.log(h)/Math.LN2))},p.c3=e_,p.c4=function(h,n,c){var d=n[0],m=n[1],b=n[2],v=c[3]*d+c[7]*m+c[11]*b+c[15];return h[0]=(c[0]*d+c[4]*m+c[8]*b+c[12])/(v=v||1),h[1]=(c[1]*d+c[5]*m+c[9]*b+c[13])/v,h[2]=(c[2]*d+c[6]*m+c[10]*b+c[14])/v,h},p.c5=class extends rh{},p.c6=class extends F{},p.c7=function(h,n){return h[0]===n[0]&&h[1]===n[1]&&h[2]===n[2]&&h[3]===n[3]&&h[4]===n[4]&&h[5]===n[5]&&h[6]===n[6]&&h[7]===n[7]&&h[8]===n[8]&&h[9]===n[9]&&h[10]===n[10]&&h[11]===n[11]&&h[12]===n[12]&&h[13]===n[13]&&h[14]===n[14]&&h[15]===n[15]},p.c8=function(h,n){var c=h[0],d=h[1],m=h[2],b=h[3],v=h[4],w=h[5],A=h[6],P=h[7],R=h[8],D=h[9],L=h[10],U=h[11],j=h[12],H=h[13],Y=h[14],te=h[15],ge=n[0],le=n[1],z=n[2],q=n[3],he=n[4],Re=n[5],Xe=n[6],Be=n[7],Ve=n[8],Je=n[9],Ye=n[10],tt=n[11],We=n[12],pt=n[13],wt=n[14],xt=n[15];return Math.abs(c-ge)<=et*Math.max(1,Math.abs(c),Math.abs(ge))&&Math.abs(d-le)<=et*Math.max(1,Math.abs(d),Math.abs(le))&&Math.abs(m-z)<=et*Math.max(1,Math.abs(m),Math.abs(z))&&Math.abs(b-q)<=et*Math.max(1,Math.abs(b),Math.abs(q))&&Math.abs(v-he)<=et*Math.max(1,Math.abs(v),Math.abs(he))&&Math.abs(w-Re)<=et*Math.max(1,Math.abs(w),Math.abs(Re))&&Math.abs(A-Xe)<=et*Math.max(1,Math.abs(A),Math.abs(Xe))&&Math.abs(P-Be)<=et*Math.max(1,Math.abs(P),Math.abs(Be))&&Math.abs(R-Ve)<=et*Math.max(1,Math.abs(R),Math.abs(Ve))&&Math.abs(D-Je)<=et*Math.max(1,Math.abs(D),Math.abs(Je))&&Math.abs(L-Ye)<=et*Math.max(1,Math.abs(L),Math.abs(Ye))&&Math.abs(U-tt)<=et*Math.max(1,Math.abs(U),Math.abs(tt))&&Math.abs(j-We)<=et*Math.max(1,Math.abs(j),Math.abs(We))&&Math.abs(H-pt)<=et*Math.max(1,Math.abs(H),Math.abs(pt))&&Math.abs(Y-wt)<=et*Math.max(1,Math.abs(Y),Math.abs(wt))&&Math.abs(te-xt)<=et*Math.max(1,Math.abs(te),Math.abs(xt))},p.c9=function(h,n){return h[0]=n[0],h[1]=n[1],h[2]=n[2],h[3]=n[3],h[4]=n[4],h[5]=n[5],h[6]=n[6],h[7]=n[7],h[8]=n[8],h[9]=n[9],h[10]=n[10],h[11]=n[11],h[12]=n[12],h[13]=n[13],h[14]=n[14],h[15]=n[15],h},p.cA=function(h){delete Z.REGISTERED_PROTOCOLS[h]},p.cB=function(h,n){const c={};for(let m=0;m<h.length;m++){const b=n&&n[h[m].id]||pl(h[m]);n&&(n[h[m].id]=b);let v=c[b];v||(v=c[b]=[]),v.push(h[m])}const d=[];for(const m in c)d.push(c[m]);return d},p.cC=ht,p.cD=ry,p.cE=ny,p.cF=O_,p.cG=function(h){h.bucket.createArrays(),h.bucket.tilePixelRatio=yt/(512*h.bucket.overscaling),h.bucket.compareText={},h.bucket.iconsNeedLinear=!1;const n=h.bucket.layers[0],c=n.layout,d=n._unevaluatedLayout._values,m={layoutIconSize:d["icon-size"].possiblyEvaluate(new Rr(h.bucket.zoom+1),h.canonical),layoutTextSize:d["text-size"].possiblyEvaluate(new Rr(h.bucket.zoom+1),h.canonical),textMaxSize:d["text-size"].possiblyEvaluate(new Rr(18))};if(h.bucket.textSizeData.kind==="composite"){const{minZoom:P,maxZoom:R}=h.bucket.textSizeData;m.compositeTextSizes=[d["text-size"].possiblyEvaluate(new Rr(P),h.canonical),d["text-size"].possiblyEvaluate(new Rr(R),h.canonical)]}if(h.bucket.iconSizeData.kind==="composite"){const{minZoom:P,maxZoom:R}=h.bucket.iconSizeData;m.compositeIconSizes=[d["icon-size"].possiblyEvaluate(new Rr(P),h.canonical),d["icon-size"].possiblyEvaluate(new Rr(R),h.canonical)]}const b=c.get("text-line-height")*ui,v=c.get("text-rotation-alignment")!=="viewport"&&c.get("symbol-placement")!=="point",w=c.get("text-keep-upright"),A=c.get("text-size");for(const P of h.bucket.features){const R=c.get("text-font").evaluate(P,{},h.canonical).join(","),D=A.evaluate(P,{},h.canonical),L=m.layoutTextSize.evaluate(P,{},h.canonical),U=m.layoutIconSize.evaluate(P,{},h.canonical),j={horizontal:{},vertical:void 0},H=P.text;let Y,te=[0,0];if(H){const z=H.toString(),q=c.get("text-letter-spacing").evaluate(P,{},h.canonical)*ui,he=$u(z)?q:0,Re=c.get("text-anchor").evaluate(P,{},h.canonical),Xe=gy(n,P,h.canonical);if(!Xe){const Ye=c.get("text-radial-offset").evaluate(P,{},h.canonical);te=Ye?py(Re,[Ye*ui,Sp]):c.get("text-offset").evaluate(P,{},h.canonical).map(tt=>tt*ui)}let Be=v?"center":c.get("text-justify").evaluate(P,{},h.canonical);const Ve=c.get("symbol-placement")==="point"?c.get("text-max-width").evaluate(P,{},h.canonical)*ui:1/0,Je=()=>{h.bucket.allowVerticalPlacement&&Gc(z)&&(j.vertical=nd(H,h.glyphMap,h.glyphPositions,h.imagePositions,R,Ve,b,Re,"left",he,te,p.an.vertical,!0,L,D))};if(!v&&Xe){const Ye=new Set;if(Be==="auto")for(let We=0;We<Xe.values.length;We+=2)Ye.add(Ap(Xe.values[We]));else Ye.add(Be);let tt=!1;for(const We of Ye)if(!j.horizontal[We])if(tt)j.horizontal[We]=j.horizontal[0];else{const pt=nd(H,h.glyphMap,h.glyphPositions,h.imagePositions,R,Ve,b,"center",We,he,te,p.an.horizontal,!1,L,D);pt&&(j.horizontal[We]=pt,tt=pt.positionedLines.length===1)}Je()}else{Be==="auto"&&(Be=Ap(Re));const Ye=nd(H,h.glyphMap,h.glyphPositions,h.imagePositions,R,Ve,b,Re,Be,he,te,p.an.horizontal,!1,L,D);Ye&&(j.horizontal[Be]=Ye),Je(),Gc(z)&&v&&w&&(j.vertical=nd(H,h.glyphMap,h.glyphPositions,h.imagePositions,R,Ve,b,Re,Be,he,te,p.an.vertical,!1,L,D))}}let ge=!1;if(P.icon&&P.icon.name){const z=h.imageMap[P.icon.name];z&&(Y=y1(h.imagePositions[P.icon.name],c.get("icon-offset").evaluate(P,{},h.canonical),c.get("icon-anchor").evaluate(P,{},h.canonical)),ge=!!z.sdf,h.bucket.sdfIcons===void 0?h.bucket.sdfIcons=ge:h.bucket.sdfIcons!==ge&&hr("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(z.pixelRatio!==h.bucket.pixelRatio||c.get("icon-rotate").constantOr(1)!==0)&&(h.bucket.iconsNeedLinear=!0))}const le=_y(j.horizontal)||j.vertical;h.bucket.iconsInText=!!le&&le.iconsInText,(le||Y)&&F1(h.bucket,P,j,Y,h.imageMap,m,L,U,te,ge,h.canonical,h.subdivisionGranularity)}h.showCollisionBoxes&&h.bucket.generateCollisionDebugBuffers()},p.cH=cp,p.cI=ip,p.cJ=lp,p.cK=_h,p.cL=dp,p.cM=class{constructor(h){this._marks={start:[h.url,"start"].join("#"),end:[h.url,"end"].join("#"),measure:h.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let h=performance.getEntriesByName(this._marks.measure);return h.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),h=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),h}},p.cN=function(h,n,c,d,m){return o(this,void 0,void 0,function*(){if(Ue())try{return yield en(h,n,c,d,m)}catch{}return function(b,v,w,A,P){const R=b.width,D=b.height;Sr&&oi||(Sr=new OffscreenCanvas(R,D),oi=Sr.getContext("2d",{willReadFrequently:!0})),Sr.width=R,Sr.height=D,oi.drawImage(b,0,0,R,D);const L=oi.getImageData(v,w,A,P);return oi.clearRect(0,0,R,D),L.data}(h,n,c,d,m)})},p.cO=i_,p.cP=T,p.cQ=O,p.cR=v_,p.cS=k_,p.cT=hl,p.cU=cs,p.ca=h=>h.type==="symbol",p.cb=h=>h.type==="circle",p.cc=h=>h.type==="heatmap",p.cd=h=>h.type==="line",p.ce=h=>h.type==="fill",p.cf=h=>h.type==="fill-extrusion",p.cg=h=>h.type==="hillshade",p.ch=h=>h.type==="color-relief",p.ci=h=>h.type==="raster",p.cj=h=>h.type==="background",p.ck=h=>h.type==="custom",p.cl=ri,p.cm=function(h,n,c){const d=It(n.x-c.x,n.y-c.y),m=It(h.x-c.x,h.y-c.y);var b,v;return Yr(Math.atan2(d[0]*m[1]-d[1]*m[0],(b=d)[0]*(v=m)[0]+b[1]*v[1]))},p.cn=Ht,p.co=function(h,n){return As[n]&&(h instanceof MouseEvent||h instanceof WheelEvent)},p.cp=function(h,n){return zn[n]&&"touches"in h},p.cq=function(h){return zn[h]||As[h]},p.cr=function(h,n,c){var d=n[0],m=n[1];return h[0]=c[0]*d+c[4]*m+c[12],h[1]=c[1]*d+c[5]*m+c[13],h},p.cs=function(h,n){const{x:c,y:d}=wh.fromLngLat(n);return!(h<0||h>25||d<0||d>=1||c<0||c>=1)},p.ct=function(h,n){return h[0]=n[0],h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=n[1],h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=n[2],h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h},p.cu=class extends us{},p.cv=L1,p.cx=function(h){return h.message===ki},p.cy=ce,p.cz=function(h,n){Z.REGISTERED_PROTOCOLS[h]=n},p.d=De,p.e=Tt,p.f=h=>o(void 0,void 0,void 0,function*(){if(h.byteLength===0)return createImageBitmap(new ImageData(1,1));const n=new Blob([new Uint8Array(h)],{type:"image/png"});try{return createImageBitmap(n)}catch(c){throw new Error(`Could not load image because of ${c.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}}),p.g=X,p.h=h=>new Promise((n,c)=>{const d=new Image;d.onload=()=>{n(d),URL.revokeObjectURL(d.src),d.onload=null,window.requestAnimationFrame(()=>{d.src=Ri})},d.onerror=()=>c(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const m=new Blob([new Uint8Array(h)],{type:"image/png"});d.src=h.byteLength?URL.createObjectURL(m):Ri}),p.i=Qt,p.j=(h,n)=>xe(Tt(h,{type:"json"}),n),p.k=Ee,p.l=Ne,p.m=xe,p.n=(h,n)=>xe(Tt(h,{type:"arrayBuffer"}),n),p.o=function(h){return new dp(h).readFields(a1,[])},p.p=D_,p.q=hh,p.r=ji,p.s=_r,p.t=eh,p.u=Yt,p.v=fe,p.w=hr,p.x=zf,p.y=la,p.z=mo}),a("worker",["./shared"],function(p){class o{constructor(Z){this.keyCache={},Z&&this.replace(Z)}replace(Z){this._layerConfigs={},this._layers={},this.update(Z,[])}update(Z,X){for(const ce of Z){this._layerConfigs[ce.id]=ce;const pe=this._layers[ce.id]=p.bI(ce);pe._featureFilter=p.a9(pe.filter),this.keyCache[ce.id]&&delete this.keyCache[ce.id]}for(const ce of X)delete this.keyCache[ce],delete this._layerConfigs[ce],delete this._layers[ce];this.familiesBySource={};const K=p.cB(Object.values(this._layerConfigs),this.keyCache);for(const ce of K){const pe=ce.map(Ee=>this._layers[Ee.id]),xe=pe[0];if(xe.visibility==="none")continue;const De=xe.source||"";let ve=this.familiesBySource[De];ve||(ve=this.familiesBySource[De]={});const $e=xe.sourceLayer||"_geojsonTileLayer";let Ne=ve[$e];Ne||(Ne=ve[$e]=[]),Ne.push(pe)}}}class T{constructor(Z){const X={},K=[];for(const De in Z){const ve=Z[De],$e=X[De]={};for(const Ne in ve){const Ee=ve[+Ne];if(!Ee||Ee.bitmap.width===0||Ee.bitmap.height===0)continue;const He={x:0,y:0,w:Ee.bitmap.width+2,h:Ee.bitmap.height+2};K.push(He),$e[Ne]={rect:He,metrics:Ee.metrics}}}const{w:ce,h:pe}=p.p(K),xe=new p.q({width:ce||1,height:pe||1});for(const De in Z){const ve=Z[De];for(const $e in ve){const Ne=ve[+$e];if(!Ne||Ne.bitmap.width===0||Ne.bitmap.height===0)continue;const Ee=X[De][$e].rect;p.q.copy(Ne.bitmap,xe,{x:0,y:0},{x:Ee.x+1,y:Ee.y+1},Ne.bitmap)}}this.image=xe,this.positions=X}}p.cC("GlyphAtlas",T);class E{constructor(Z){this.tileID=new p.Z(Z.tileID.overscaledZ,Z.tileID.wrap,Z.tileID.canonical.z,Z.tileID.canonical.x,Z.tileID.canonical.y),this.uid=Z.uid,this.zoom=Z.zoom,this.pixelRatio=Z.pixelRatio,this.tileSize=Z.tileSize,this.source=Z.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=Z.showCollisionBoxes,this.collectResourceTiming=!!Z.collectResourceTiming,this.returnDependencies=!!Z.returnDependencies,this.promoteId=Z.promoteId,this.inFlightDependencies=[],this.globalState=Z.globalState}parse(Z,X,K,ce,pe){return p._(this,void 0,void 0,function*(){this.status="parsing",this.data=Z,this.collisionBoxArray=new p.a7;const xe=new p.cD(Object.keys(Z.layers).sort()),De=new p.cE(this.tileID,this.promoteId);De.bucketLayerIDs=[];const ve={},$e={featureIndex:De,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:K,subdivisionGranularity:pe},Ne=X.familiesBySource[this.source];for(const Mt in Ne){const er=Z.layers[Mt];if(!er)continue;er.version===1&&p.w(`Vector tile source "${this.source}" layer "${Mt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const ai=xe.encode(Mt),rt=[];for(let bi=0;bi<er.length;bi++){const Dr=er.feature(bi),ns=De.getId(Dr,Mt);rt.push({feature:Dr,id:ns,index:bi,sourceLayerIndex:ai})}for(const bi of Ne[Mt]){const Dr=bi[0];Dr.source!==this.source&&p.w(`layer.source = ${Dr.source} does not equal this.source = ${this.source}`),Dr.minzoom&&this.zoom<Math.floor(Dr.minzoom)||Dr.maxzoom&&this.zoom>=Dr.maxzoom||Dr.visibility!=="none"&&(C(bi,this.zoom,K),(ve[Dr.id]=Dr.createBucket({index:De.bucketLayerIDs.length,layers:bi,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:ai,sourceID:this.source,globalState:this.globalState})).populate(rt,$e,this.tileID.canonical),De.bucketLayerIDs.push(bi.map(ns=>ns.id)))}}const Ee=p.bM($e.glyphDependencies,Mt=>Object.keys(Mt).map(Number));this.inFlightDependencies.forEach(Mt=>Mt?.abort()),this.inFlightDependencies=[];let He=Promise.resolve({});if(Object.keys(Ee).length){const Mt=new AbortController;this.inFlightDependencies.push(Mt),He=ce.sendAsync({type:"GG",data:{stacks:Ee,source:this.source,tileID:this.tileID,type:"glyphs"}},Mt)}const fe=Object.keys($e.iconDependencies);let lt=Promise.resolve({});if(fe.length){const Mt=new AbortController;this.inFlightDependencies.push(Mt),lt=ce.sendAsync({type:"GI",data:{icons:fe,source:this.source,tileID:this.tileID,type:"icons"}},Mt)}const Et=Object.keys($e.patternDependencies);let ut=Promise.resolve({});if(Et.length){const Mt=new AbortController;this.inFlightDependencies.push(Mt),ut=ce.sendAsync({type:"GI",data:{icons:Et,source:this.source,tileID:this.tileID,type:"patterns"}},Mt)}const[vt,Dt,Tr]=yield Promise.all([He,lt,ut]),lr=new T(vt),ir=new p.cF(Dt,Tr);for(const Mt in ve){const er=ve[Mt];er instanceof p.a8?(C(er.layers,this.zoom,K),p.cG({bucket:er,glyphMap:vt,glyphPositions:lr.positions,imageMap:Dt,imagePositions:ir.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical,subdivisionGranularity:$e.subdivisionGranularity})):er.hasPattern&&(er instanceof p.cH||er instanceof p.cI||er instanceof p.cJ)&&(C(er.layers,this.zoom,K),er.addFeatures($e,this.tileID.canonical,ir.patternPositions))}return this.status="done",{buckets:Object.values(ve).filter(Mt=>!Mt.isEmpty()),featureIndex:De,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:lr.image,imageAtlas:ir,glyphMap:this.returnDependencies?vt:null,iconMap:this.returnDependencies?Dt:null,glyphPositions:this.returnDependencies?lr.positions:null}})}}function C(be,Z,X){const K=new p.F(Z);for(const ce of be)ce.recalculate(K,X)}class O{constructor(Z,X,K){this.actor=Z,this.layerIndex=X,this.availableImages=K,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(Z,X){return p._(this,void 0,void 0,function*(){const K=yield p.n(Z.request,X);try{return{vectorTile:new p.cK.VectorTile(new p.cL(K.data)),rawData:K.data,cacheControl:K.cacheControl,expires:K.expires}}catch(ce){const pe=new Uint8Array(K.data);let xe=`Unable to parse the tile at ${Z.request.url}, `;throw xe+=pe[0]===31&&pe[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${ce.message}`,new Error(xe)}})}loadTile(Z){return p._(this,void 0,void 0,function*(){const X=Z.uid,K=!!(Z&&Z.request&&Z.request.collectResourceTiming)&&new p.cM(Z.request),ce=new E(Z);this.loading[X]=ce;const pe=new AbortController;ce.abort=pe;try{const xe=yield this.loadVectorTile(Z,pe);if(delete this.loading[X],!xe)return null;const De=xe.rawData,ve={};xe.expires&&(ve.expires=xe.expires),xe.cacheControl&&(ve.cacheControl=xe.cacheControl);const $e={};if(K){const Ee=K.finish();Ee&&($e.resourceTiming=JSON.parse(JSON.stringify(Ee)))}ce.vectorTile=xe.vectorTile;const Ne=ce.parse(xe.vectorTile,this.layerIndex,this.availableImages,this.actor,Z.subdivisionGranularity);this.loaded[X]=ce,this.fetching[X]={rawTileData:De,cacheControl:ve,resourceTiming:$e};try{const Ee=yield Ne;return p.e({rawTileData:De.slice(0)},Ee,ve,$e)}finally{delete this.fetching[X]}}catch(xe){throw delete this.loading[X],ce.status="done",this.loaded[X]=ce,xe}})}reloadTile(Z){return p._(this,void 0,void 0,function*(){const X=Z.uid;if(!this.loaded||!this.loaded[X])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const K=this.loaded[X];if(K.showCollisionBoxes=Z.showCollisionBoxes,K.globalState=Z.globalState,K.status==="parsing"){const ce=yield K.parse(K.vectorTile,this.layerIndex,this.availableImages,this.actor,Z.subdivisionGranularity);let pe;if(this.fetching[X]){const{rawTileData:xe,cacheControl:De,resourceTiming:ve}=this.fetching[X];delete this.fetching[X],pe=p.e({rawTileData:xe.slice(0)},ce,De,ve)}else pe=ce;return pe}if(K.status==="done"&&K.vectorTile)return K.parse(K.vectorTile,this.layerIndex,this.availableImages,this.actor,Z.subdivisionGranularity)})}abortTile(Z){return p._(this,void 0,void 0,function*(){const X=this.loading,K=Z.uid;X&&X[K]&&X[K].abort&&(X[K].abort.abort(),delete X[K])})}removeTile(Z){return p._(this,void 0,void 0,function*(){this.loaded&&this.loaded[Z.uid]&&delete this.loaded[Z.uid]})}}class ${constructor(){this.loaded={}}loadTile(Z){return p._(this,void 0,void 0,function*(){const{uid:X,encoding:K,rawImageData:ce,redFactor:pe,greenFactor:xe,blueFactor:De,baseShift:ve}=Z,$e=ce.width+2,Ne=ce.height+2,Ee=p.b(ce)?new p.R({width:$e,height:Ne},yield p.cN(ce,-1,-1,$e,Ne)):ce,He=new p.cO(X,Ee,K,pe,xe,De,ve);return this.loaded=this.loaded||{},this.loaded[X]=He,He})}removeTile(Z){const X=this.loaded,K=Z.uid;X&&X[K]&&delete X[K]}}var V,ie,we=function(){if(ie)return V;function be(X,K){if(X.length!==0){Z(X[0],K);for(var ce=1;ce<X.length;ce++)Z(X[ce],!K)}}function Z(X,K){for(var ce=0,pe=0,xe=0,De=X.length,ve=De-1;xe<De;ve=xe++){var $e=(X[xe][0]-X[ve][0])*(X[ve][1]+X[xe][1]),Ne=ce+$e;pe+=Math.abs(ce)>=Math.abs($e)?ce-Ne+$e:$e-Ne+ce,ce=Ne}ce+pe>=0!=!!K&&X.reverse()}return ie=1,V=function X(K,ce){var pe,xe=K&&K.type;if(xe==="FeatureCollection")for(pe=0;pe<K.features.length;pe++)X(K.features[pe],ce);else if(xe==="GeometryCollection")for(pe=0;pe<K.geometries.length;pe++)X(K.geometries[pe],ce);else if(xe==="Feature")X(K.geometry,ce);else if(xe==="Polygon")be(K.coordinates,ce);else if(xe==="MultiPolygon")for(pe=0;pe<K.coordinates.length;pe++)be(K.coordinates[pe],ce);return K}}(),Pe=p.cP(we);const je=p.cK.VectorTileFeature.prototype.toGeoJSON;class Ze{constructor(Z){this._feature=Z,this.extent=p.$,this.type=Z.type,this.properties=Z.tags,"id"in Z&&!isNaN(Z.id)&&(this.id=parseInt(Z.id,10))}loadGeometry(){if(this._feature.type===1){const Z=[];for(const X of this._feature.geometry)Z.push([new p.P(X[0],X[1])]);return Z}{const Z=[];for(const X of this._feature.geometry){const K=[];for(const ce of X)K.push(new p.P(ce[0],ce[1]));Z.push(K)}return Z}}toGeoJSON(Z,X,K){return je.call(this,Z,X,K)}}class Le{constructor(Z){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=p.$,this.length=Z.length,this._features=Z}feature(Z){return new Ze(this._features[Z])}}var Ue,et,Ke,ct={exports:{}},me=function(){if(Ke)return ct.exports;Ke=1;var be=p.cS(),Z=function(){if(et)return Ue;et=1;var Ne=p.cQ(),Ee=p.cR().VectorTileFeature;function He(lt,Et){this.options=Et||{},this.features=lt,this.length=lt.length}function fe(lt,Et){this.id=typeof lt.id=="number"?lt.id:void 0,this.type=lt.type,this.rawGeometry=lt.type===1?[lt.geometry]:lt.geometry,this.properties=lt.tags,this.extent=Et||4096}return Ue=He,He.prototype.feature=function(lt){return new fe(this.features[lt],this.options.extent)},fe.prototype.loadGeometry=function(){var lt=this.rawGeometry;this.geometry=[];for(var Et=0;Et<lt.length;Et++){for(var ut=lt[Et],vt=[],Dt=0;Dt<ut.length;Dt++)vt.push(new Ne(ut[Dt][0],ut[Dt][1]));this.geometry.push(vt)}return this.geometry},fe.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var lt=this.geometry,Et=1/0,ut=-1/0,vt=1/0,Dt=-1/0,Tr=0;Tr<lt.length;Tr++)for(var lr=lt[Tr],ir=0;ir<lr.length;ir++){var Mt=lr[ir];Et=Math.min(Et,Mt.x),ut=Math.max(ut,Mt.x),vt=Math.min(vt,Mt.y),Dt=Math.max(Dt,Mt.y)}return[Et,vt,ut,Dt]},fe.prototype.toGeoJSON=Ee.prototype.toGeoJSON,Ue}();function X(Ne){var Ee=new be;return function(He,fe){for(var lt in He.layers)fe.writeMessage(3,K,He.layers[lt])}(Ne,Ee),Ee.finish()}function K(Ne,Ee){var He;Ee.writeVarintField(15,Ne.version||1),Ee.writeStringField(1,Ne.name||""),Ee.writeVarintField(5,Ne.extent||4096);var fe={keys:[],values:[],keycache:{},valuecache:{}};for(He=0;He<Ne.length;He++)fe.feature=Ne.feature(He),Ee.writeMessage(2,ce,fe);var lt=fe.keys;for(He=0;He<lt.length;He++)Ee.writeStringField(3,lt[He]);var Et=fe.values;for(He=0;He<Et.length;He++)Ee.writeMessage(4,$e,Et[He])}function ce(Ne,Ee){var He=Ne.feature;He.id!==void 0&&Ee.writeVarintField(1,He.id),Ee.writeMessage(2,pe,Ne),Ee.writeVarintField(3,He.type),Ee.writeMessage(4,ve,He)}function pe(Ne,Ee){var He=Ne.feature,fe=Ne.keys,lt=Ne.values,Et=Ne.keycache,ut=Ne.valuecache;for(var vt in He.properties){var Dt=He.properties[vt],Tr=Et[vt];if(Dt!==null){Tr===void 0&&(fe.push(vt),Et[vt]=Tr=fe.length-1),Ee.writeVarint(Tr);var lr=typeof Dt;lr!=="string"&&lr!=="boolean"&&lr!=="number"&&(Dt=JSON.stringify(Dt));var ir=lr+":"+Dt,Mt=ut[ir];Mt===void 0&&(lt.push(Dt),ut[ir]=Mt=lt.length-1),Ee.writeVarint(Mt)}}}function xe(Ne,Ee){return(Ee<<3)+(7&Ne)}function De(Ne){return Ne<<1^Ne>>31}function ve(Ne,Ee){for(var He=Ne.loadGeometry(),fe=Ne.type,lt=0,Et=0,ut=He.length,vt=0;vt<ut;vt++){var Dt=He[vt],Tr=1;fe===1&&(Tr=Dt.length),Ee.writeVarint(xe(1,Tr));for(var lr=fe===3?Dt.length-1:Dt.length,ir=0;ir<lr;ir++){ir===1&&fe!==1&&Ee.writeVarint(xe(2,lr-1));var Mt=Dt[ir].x-lt,er=Dt[ir].y-Et;Ee.writeVarint(De(Mt)),Ee.writeVarint(De(er)),lt+=Mt,Et+=er}fe===3&&Ee.writeVarint(xe(7,1))}}function $e(Ne,Ee){var He=typeof Ne;He==="string"?Ee.writeStringField(1,Ne):He==="boolean"?Ee.writeBooleanField(7,Ne):He==="number"&&(Ne%1!=0?Ee.writeDoubleField(3,Ne):Ne<0?Ee.writeSVarintField(6,Ne):Ee.writeVarintField(5,Ne))}return ct.exports=X,ct.exports.fromVectorTileJs=X,ct.exports.fromGeojsonVt=function(Ne,Ee){Ee=Ee||{};var He={};for(var fe in Ne)He[fe]=new Z(Ne[fe].features,Ee),He[fe].name=fe,He[fe].version=Ee.version,He[fe].extent=Ee.extent;return X({layers:He})},ct.exports.GeoJSONWrapper=Z,ct.exports}(),_e=p.cP(me);const ze={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:be=>be},Qe=Math.fround||(at=new Float32Array(1),be=>(at[0]=+be,at[0]));var at;class mt{constructor(Z){this.options=Object.assign(Object.create(ze),Z),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(Z){const{log:X,minZoom:K,maxZoom:ce}=this.options;X&&console.time("total time");const pe=`prepare ${Z.length} points`;X&&console.time(pe),this.points=Z;const xe=[];for(let ve=0;ve<Z.length;ve++){const $e=Z[ve];if(!$e.geometry)continue;const[Ne,Ee]=$e.geometry.coordinates,He=Qe(ti(Ne)),fe=Qe(Bt(Ee));xe.push(He,fe,1/0,ve,-1,1),this.options.reduce&&xe.push(0)}let De=this.trees[ce+1]=this._createTree(xe);X&&console.timeEnd(pe);for(let ve=ce;ve>=K;ve--){const $e=+Date.now();De=this.trees[ve]=this._createTree(this._cluster(De,ve)),X&&console.log("z%d: %d clusters in %dms",ve,De.numItems,+Date.now()-$e)}return X&&console.timeEnd("total time"),this}getClusters(Z,X){let K=((Z[0]+180)%360+360)%360-180;const ce=Math.max(-90,Math.min(90,Z[1]));let pe=Z[2]===180?180:((Z[2]+180)%360+360)%360-180;const xe=Math.max(-90,Math.min(90,Z[3]));if(Z[2]-Z[0]>=360)K=-180,pe=180;else if(K>pe){const Ee=this.getClusters([K,ce,180,xe],X),He=this.getClusters([-180,ce,pe,xe],X);return Ee.concat(He)}const De=this.trees[this._limitZoom(X)],ve=De.range(ti(K),Bt(xe),ti(pe),Bt(ce)),$e=De.data,Ne=[];for(const Ee of ve){const He=this.stride*Ee;Ne.push($e[He+5]>1?At($e,He,this.clusterProps):this.points[$e[He+3]])}return Ne}getChildren(Z){const X=this._getOriginId(Z),K=this._getOriginZoom(Z),ce="No cluster with the specified id.",pe=this.trees[K];if(!pe)throw new Error(ce);const xe=pe.data;if(X*this.stride>=xe.length)throw new Error(ce);const De=this.options.radius/(this.options.extent*Math.pow(2,K-1)),ve=pe.within(xe[X*this.stride],xe[X*this.stride+1],De),$e=[];for(const Ne of ve){const Ee=Ne*this.stride;xe[Ee+4]===Z&&$e.push(xe[Ee+5]>1?At(xe,Ee,this.clusterProps):this.points[xe[Ee+3]])}if($e.length===0)throw new Error(ce);return $e}getLeaves(Z,X,K){const ce=[];return this._appendLeaves(ce,Z,X=X||10,K=K||0,0),ce}getTile(Z,X,K){const ce=this.trees[this._limitZoom(Z)],pe=Math.pow(2,Z),{extent:xe,radius:De}=this.options,ve=De/xe,$e=(K-ve)/pe,Ne=(K+1+ve)/pe,Ee={features:[]};return this._addTileFeatures(ce.range((X-ve)/pe,$e,(X+1+ve)/pe,Ne),ce.data,X,K,pe,Ee),X===0&&this._addTileFeatures(ce.range(1-ve/pe,$e,1,Ne),ce.data,pe,K,pe,Ee),X===pe-1&&this._addTileFeatures(ce.range(0,$e,ve/pe,Ne),ce.data,-1,K,pe,Ee),Ee.features.length?Ee:null}getClusterExpansionZoom(Z){let X=this._getOriginZoom(Z)-1;for(;X<=this.options.maxZoom;){const K=this.getChildren(Z);if(X++,K.length!==1)break;Z=K[0].properties.cluster_id}return X}_appendLeaves(Z,X,K,ce,pe){const xe=this.getChildren(X);for(const De of xe){const ve=De.properties;if(ve&&ve.cluster?pe+ve.point_count<=ce?pe+=ve.point_count:pe=this._appendLeaves(Z,ve.cluster_id,K,ce,pe):pe<ce?pe++:Z.push(De),Z.length===K)break}return pe}_createTree(Z){const X=new p.aH(Z.length/this.stride|0,this.options.nodeSize,Float32Array);for(let K=0;K<Z.length;K+=this.stride)X.add(Z[K],Z[K+1]);return X.finish(),X.data=Z,X}_addTileFeatures(Z,X,K,ce,pe,xe){for(const De of Z){const ve=De*this.stride,$e=X[ve+5]>1;let Ne,Ee,He;if($e)Ne=or(X,ve,this.clusterProps),Ee=X[ve],He=X[ve+1];else{const Et=this.points[X[ve+3]];Ne=Et.properties;const[ut,vt]=Et.geometry.coordinates;Ee=ti(ut),He=Bt(vt)}const fe={type:1,geometry:[[Math.round(this.options.extent*(Ee*pe-K)),Math.round(this.options.extent*(He*pe-ce))]],tags:Ne};let lt;lt=$e||this.options.generateId?X[ve+3]:this.points[X[ve+3]].id,lt!==void 0&&(fe.id=lt),xe.features.push(fe)}}_limitZoom(Z){return Math.max(this.options.minZoom,Math.min(Math.floor(+Z),this.options.maxZoom+1))}_cluster(Z,X){const{radius:K,extent:ce,reduce:pe,minPoints:xe}=this.options,De=K/(ce*Math.pow(2,X)),ve=Z.data,$e=[],Ne=this.stride;for(let Ee=0;Ee<ve.length;Ee+=Ne){if(ve[Ee+2]<=X)continue;ve[Ee+2]=X;const He=ve[Ee],fe=ve[Ee+1],lt=Z.within(ve[Ee],ve[Ee+1],De),Et=ve[Ee+5];let ut=Et;for(const vt of lt){const Dt=vt*Ne;ve[Dt+2]>X&&(ut+=ve[Dt+5])}if(ut>Et&&ut>=xe){let vt,Dt=He*Et,Tr=fe*Et,lr=-1;const ir=(Ee/Ne<<5)+(X+1)+this.points.length;for(const Mt of lt){const er=Mt*Ne;if(ve[er+2]<=X)continue;ve[er+2]=X;const ai=ve[er+5];Dt+=ve[er]*ai,Tr+=ve[er+1]*ai,ve[er+4]=ir,pe&&(vt||(vt=this._map(ve,Ee,!0),lr=this.clusterProps.length,this.clusterProps.push(vt)),pe(vt,this._map(ve,er)))}ve[Ee+4]=ir,$e.push(Dt/ut,Tr/ut,1/0,ir,-1,ut),pe&&$e.push(lr)}else{for(let vt=0;vt<Ne;vt++)$e.push(ve[Ee+vt]);if(ut>1)for(const vt of lt){const Dt=vt*Ne;if(!(ve[Dt+2]<=X)){ve[Dt+2]=X;for(let Tr=0;Tr<Ne;Tr++)$e.push(ve[Dt+Tr])}}}}return $e}_getOriginId(Z){return Z-this.points.length>>5}_getOriginZoom(Z){return(Z-this.points.length)%32}_map(Z,X,K){if(Z[X+5]>1){const xe=this.clusterProps[Z[X+6]];return K?Object.assign({},xe):xe}const ce=this.points[Z[X+3]].properties,pe=this.options.map(ce);return K&&pe===ce?Object.assign({},pe):pe}}function At(be,Z,X){return{type:"Feature",id:be[Z+3],properties:or(be,Z,X),geometry:{type:"Point",coordinates:[(K=be[Z],360*(K-.5)),wr(be[Z+1])]}};var K}function or(be,Z,X){const K=be[Z+5],ce=K>=1e4?`${Math.round(K/1e3)}k`:K>=1e3?Math.round(K/100)/10+"k":K,pe=be[Z+6],xe=pe===-1?{}:Object.assign({},X[pe]);return Object.assign(xe,{cluster:!0,cluster_id:be[Z+3],point_count:K,point_count_abbreviated:ce})}function ti(be){return be/360+.5}function Bt(be){const Z=Math.sin(be*Math.PI/180),X=.5-.25*Math.log((1+Z)/(1-Z))/Math.PI;return X<0?0:X>1?1:X}function wr(be){const Z=(180-360*be)*Math.PI/180;return 360*Math.atan(Math.exp(Z))/Math.PI-90}function Rt(be,Z,X,K){let ce=K;const pe=Z+(X-Z>>1);let xe,De=X-Z;const ve=be[Z],$e=be[Z+1],Ne=be[X],Ee=be[X+1];for(let He=Z+3;He<X;He+=3){const fe=Vr(be[He],be[He+1],ve,$e,Ne,Ee);if(fe>ce)xe=He,ce=fe;else if(fe===ce){const lt=Math.abs(He-pe);lt<De&&(xe=He,De=lt)}}ce>K&&(xe-Z>3&&Rt(be,Z,xe,K),be[xe+2]=ce,X-xe>3&&Rt(be,xe,X,K))}function Vr(be,Z,X,K,ce,pe){let xe=ce-X,De=pe-K;if(xe!==0||De!==0){const ve=((be-X)*xe+(Z-K)*De)/(xe*xe+De*De);ve>1?(X=ce,K=pe):ve>0&&(X+=xe*ve,K+=De*ve)}return xe=be-X,De=Z-K,xe*xe+De*De}function It(be,Z,X,K){const ce={id:be??null,type:Z,geometry:X,tags:K,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(Z==="Point"||Z==="MultiPoint"||Z==="LineString")yt(ce,X);else if(Z==="Polygon")yt(ce,X[0]);else if(Z==="MultiLineString")for(const pe of X)yt(ce,pe);else if(Z==="MultiPolygon")for(const pe of X)yt(ce,pe[0]);return ce}function yt(be,Z){for(let X=0;X<Z.length;X+=3)be.minX=Math.min(be.minX,Z[X]),be.minY=Math.min(be.minY,Z[X+1]),be.maxX=Math.max(be.maxX,Z[X]),be.maxY=Math.max(be.maxY,Z[X+1])}function bt(be,Z,X,K){if(!Z.geometry)return;const ce=Z.geometry.coordinates;if(ce&&ce.length===0)return;const pe=Z.geometry.type,xe=Math.pow(X.tolerance/((1<<X.maxZoom)*X.extent),2);let De=[],ve=Z.id;if(X.promoteId?ve=Z.properties[X.promoteId]:X.generateId&&(ve=K||0),pe==="Point")ar(ce,De);else if(pe==="MultiPoint")for(const $e of ce)ar($e,De);else if(pe==="LineString")cr(ce,De,xe,!1);else if(pe==="MultiLineString"){if(X.lineMetrics){for(const $e of ce)De=[],cr($e,De,xe,!1),be.push(It(ve,"LineString",De,Z.properties));return}Mr(ce,De,xe,!1)}else if(pe==="Polygon")Mr(ce,De,xe,!0);else{if(pe!=="MultiPolygon"){if(pe==="GeometryCollection"){for(const $e of Z.geometry.geometries)bt(be,{id:ve,geometry:$e,properties:Z.properties},X,K);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const $e of ce){const Ne=[];Mr($e,Ne,xe,!0),De.push(Ne)}}be.push(It(ve,pe,De,Z.properties))}function ar(be,Z){Z.push(ri(be[0]),Ht(be[1]),0)}function cr(be,Z,X,K){let ce,pe,xe=0;for(let ve=0;ve<be.length;ve++){const $e=ri(be[ve][0]),Ne=Ht(be[ve][1]);Z.push($e,Ne,0),ve>0&&(xe+=K?(ce*Ne-$e*pe)/2:Math.sqrt(Math.pow($e-ce,2)+Math.pow(Ne-pe,2))),ce=$e,pe=Ne}const De=Z.length-3;Z[2]=1,Rt(Z,0,De,X),Z[De+2]=1,Z.size=Math.abs(xe),Z.start=0,Z.end=Z.size}function Mr(be,Z,X,K){for(let ce=0;ce<be.length;ce++){const pe=[];cr(be[ce],pe,X,K),Z.push(pe)}}function ri(be){return be/360+.5}function Ht(be){const Z=Math.sin(be*Math.PI/180),X=.5-.25*Math.log((1+Z)/(1-Z))/Math.PI;return X<0?0:X>1?1:X}function kt(be,Z,X,K,ce,pe,xe,De){if(K/=Z,pe>=(X/=Z)&&xe<K)return be;if(xe<X||pe>=K)return null;const ve=[];for(const $e of be){const Ne=$e.geometry;let Ee=$e.type;const He=ce===0?$e.minX:$e.minY,fe=ce===0?$e.maxX:$e.maxY;if(He>=X&&fe<K){ve.push($e);continue}if(fe<X||He>=K)continue;let lt=[];if(Ee==="Point"||Ee==="MultiPoint")gr(Ne,lt,X,K,ce);else if(Ee==="LineString")Tt(Ne,lt,X,K,ce,!1,De.lineMetrics);else if(Ee==="MultiLineString")zt(Ne,lt,X,K,ce,!1);else if(Ee==="Polygon")zt(Ne,lt,X,K,ce,!0);else if(Ee==="MultiPolygon")for(const Et of Ne){const ut=[];zt(Et,ut,X,K,ce,!0),ut.length&&lt.push(ut)}if(lt.length){if(De.lineMetrics&&Ee==="LineString"){for(const Et of lt)ve.push(It($e.id,Ee,Et,$e.tags));continue}Ee!=="LineString"&&Ee!=="MultiLineString"||(lt.length===1?(Ee="LineString",lt=lt[0]):Ee="MultiLineString"),Ee!=="Point"&&Ee!=="MultiPoint"||(Ee=lt.length===3?"Point":"MultiPoint"),ve.push(It($e.id,Ee,lt,$e.tags))}}return ve.length?ve:null}function gr(be,Z,X,K,ce){for(let pe=0;pe<be.length;pe+=3){const xe=be[pe+ce];xe>=X&&xe<=K&&Jt(Z,be[pe],be[pe+1],be[pe+2])}}function Tt(be,Z,X,K,ce,pe,xe){let De=mr(be);const ve=ce===0?Gt:$t;let $e,Ne,Ee=be.start;for(let ut=0;ut<be.length-3;ut+=3){const vt=be[ut],Dt=be[ut+1],Tr=be[ut+2],lr=be[ut+3],ir=be[ut+4],Mt=ce===0?vt:Dt,er=ce===0?lr:ir;let ai=!1;xe&&($e=Math.sqrt(Math.pow(vt-lr,2)+Math.pow(Dt-ir,2))),Mt<X?er>X&&(Ne=ve(De,vt,Dt,lr,ir,X),xe&&(De.start=Ee+$e*Ne)):Mt>K?er<K&&(Ne=ve(De,vt,Dt,lr,ir,K),xe&&(De.start=Ee+$e*Ne)):Jt(De,vt,Dt,Tr),er<X&&Mt>=X&&(Ne=ve(De,vt,Dt,lr,ir,X),ai=!0),er>K&&Mt<=K&&(Ne=ve(De,vt,Dt,lr,ir,K),ai=!0),!pe&&ai&&(xe&&(De.end=Ee+$e*Ne),Z.push(De),De=mr(be)),xe&&(Ee+=$e)}let He=be.length-3;const fe=be[He],lt=be[He+1],Et=ce===0?fe:lt;Et>=X&&Et<=K&&Jt(De,fe,lt,be[He+2]),He=De.length-3,pe&&He>=3&&(De[He]!==De[0]||De[He+1]!==De[1])&&Jt(De,De[0],De[1],De[2]),De.length&&Z.push(De)}function mr(be){const Z=[];return Z.size=be.size,Z.start=be.start,Z.end=be.end,Z}function zt(be,Z,X,K,ce,pe){for(const xe of be)Tt(xe,Z,X,K,ce,pe,!1)}function Jt(be,Z,X,K){be.push(Z,X,K)}function Gt(be,Z,X,K,ce,pe){const xe=(pe-Z)/(K-Z);return Jt(be,pe,X+(ce-X)*xe,1),xe}function $t(be,Z,X,K,ce,pe){const xe=(pe-X)/(ce-X);return Jt(be,Z+(K-Z)*xe,pe,1),xe}function hr(be,Z){const X=[];for(let K=0;K<be.length;K++){const ce=be[K],pe=ce.type;let xe;if(pe==="Point"||pe==="MultiPoint"||pe==="LineString")xe=Ct(ce.geometry,Z);else if(pe==="MultiLineString"||pe==="Polygon"){xe=[];for(const De of ce.geometry)xe.push(Ct(De,Z))}else if(pe==="MultiPolygon"){xe=[];for(const De of ce.geometry){const ve=[];for(const $e of De)ve.push(Ct($e,Z));xe.push(ve)}}X.push(It(ce.id,pe,xe,ce.tags))}return X}function Ct(be,Z){const X=[];X.size=be.size,be.start!==void 0&&(X.start=be.start,X.end=be.end);for(let K=0;K<be.length;K+=3)X.push(be[K]+Z,be[K+1],be[K+2]);return X}function Qt(be,Z){if(be.transformed)return be;const X=1<<be.z,K=be.x,ce=be.y;for(const pe of be.features){const xe=pe.geometry,De=pe.type;if(pe.geometry=[],De===1)for(let ve=0;ve<xe.length;ve+=2)pe.geometry.push(Mi(xe[ve],xe[ve+1],Z,X,K,ce));else for(let ve=0;ve<xe.length;ve++){const $e=[];for(let Ne=0;Ne<xe[ve].length;Ne+=2)$e.push(Mi(xe[ve][Ne],xe[ve][Ne+1],Z,X,K,ce));pe.geometry.push($e)}}return be.transformed=!0,be}function Mi(be,Z,X,K,ce,pe){return[Math.round(X*(be*K-ce)),Math.round(X*(Z*K-pe))]}function Ni(be,Z,X,K,ce){const pe=Z===ce.maxZoom?0:ce.tolerance/((1<<Z)*ce.extent),xe={features:[],numPoints:0,numSimplified:0,numFeatures:be.length,source:null,x:X,y:K,z:Z,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const De of be)Ri(xe,De,pe,ce);return xe}function Ri(be,Z,X,K){const ce=Z.geometry,pe=Z.type,xe=[];if(be.minX=Math.min(be.minX,Z.minX),be.minY=Math.min(be.minY,Z.minY),be.maxX=Math.max(be.maxX,Z.maxX),be.maxY=Math.max(be.maxY,Z.maxY),pe==="Point"||pe==="MultiPoint")for(let De=0;De<ce.length;De+=3)xe.push(ce[De],ce[De+1]),be.numPoints++,be.numSimplified++;else if(pe==="LineString")en(xe,ce,be,X,!1,!1);else if(pe==="MultiLineString"||pe==="Polygon")for(let De=0;De<ce.length;De++)en(xe,ce[De],be,X,pe==="Polygon",De===0);else if(pe==="MultiPolygon")for(let De=0;De<ce.length;De++){const ve=ce[De];for(let $e=0;$e<ve.length;$e++)en(xe,ve[$e],be,X,!0,$e===0)}if(xe.length){let De=Z.tags||null;if(pe==="LineString"&&K.lineMetrics){De={};for(const $e in Z.tags)De[$e]=Z.tags[$e];De.mapbox_clip_start=ce.start/ce.size,De.mapbox_clip_end=ce.end/ce.size}const ve={geometry:xe,type:pe==="Polygon"||pe==="MultiPolygon"?3:pe==="LineString"||pe==="MultiLineString"?2:1,tags:De};Z.id!==null&&(ve.id=Z.id),be.features.push(ve)}}function en(be,Z,X,K,ce,pe){const xe=K*K;if(K>0&&Z.size<(ce?xe:K))return void(X.numPoints+=Z.length/3);const De=[];for(let ve=0;ve<Z.length;ve+=3)(K===0||Z[ve+2]>xe)&&(X.numSimplified++,De.push(Z[ve],Z[ve+1])),X.numPoints++;ce&&function(ve,$e){let Ne=0;for(let Ee=0,He=ve.length,fe=He-2;Ee<He;fe=Ee,Ee+=2)Ne+=(ve[Ee]-ve[fe])*(ve[Ee+1]+ve[fe+1]);if(Ne>0===$e)for(let Ee=0,He=ve.length;Ee<He/2;Ee+=2){const fe=ve[Ee],lt=ve[Ee+1];ve[Ee]=ve[He-2-Ee],ve[Ee+1]=ve[He-1-Ee],ve[He-2-Ee]=fe,ve[He-1-Ee]=lt}}(De,pe),be.push(De)}const Sr={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class oi{constructor(Z,X){const K=(X=this.options=function(pe,xe){for(const De in xe)pe[De]=xe[De];return pe}(Object.create(Sr),X)).debug;if(K&&console.time("preprocess data"),X.maxZoom<0||X.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(X.promoteId&&X.generateId)throw new Error("promoteId and generateId cannot be used together.");let ce=function(pe,xe){const De=[];if(pe.type==="FeatureCollection")for(let ve=0;ve<pe.features.length;ve++)bt(De,pe.features[ve],xe,ve);else bt(De,pe.type==="Feature"?pe:{geometry:pe},xe);return De}(Z,X);this.tiles={},this.tileCoords=[],K&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",X.indexMaxZoom,X.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ce=function(pe,xe){const De=xe.buffer/xe.extent;let ve=pe;const $e=kt(pe,1,-1-De,De,0,-1,2,xe),Ne=kt(pe,1,1-De,2+De,0,-1,2,xe);return($e||Ne)&&(ve=kt(pe,1,-De,1+De,0,-1,2,xe)||[],$e&&(ve=hr($e,1).concat(ve)),Ne&&(ve=ve.concat(hr(Ne,-1)))),ve}(ce,X),ce.length&&this.splitTile(ce,0,0,0),K&&(ce.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(Z,X,K,ce,pe,xe,De){const ve=[Z,X,K,ce],$e=this.options,Ne=$e.debug;for(;ve.length;){ce=ve.pop(),K=ve.pop(),X=ve.pop(),Z=ve.pop();const Ee=1<<X,He=_r(X,K,ce);let fe=this.tiles[He];if(!fe&&(Ne>1&&console.time("creation"),fe=this.tiles[He]=Ni(Z,X,K,ce,$e),this.tileCoords.push({z:X,x:K,y:ce}),Ne)){Ne>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",X,K,ce,fe.numFeatures,fe.numPoints,fe.numSimplified),console.timeEnd("creation"));const ai=`z${X}`;this.stats[ai]=(this.stats[ai]||0)+1,this.total++}if(fe.source=Z,pe==null){if(X===$e.indexMaxZoom||fe.numPoints<=$e.indexMaxPoints)continue}else{if(X===$e.maxZoom||X===pe)continue;if(pe!=null){const ai=pe-X;if(K!==xe>>ai||ce!==De>>ai)continue}}if(fe.source=null,Z.length===0)continue;Ne>1&&console.time("clipping");const lt=.5*$e.buffer/$e.extent,Et=.5-lt,ut=.5+lt,vt=1+lt;let Dt=null,Tr=null,lr=null,ir=null,Mt=kt(Z,Ee,K-lt,K+ut,0,fe.minX,fe.maxX,$e),er=kt(Z,Ee,K+Et,K+vt,0,fe.minX,fe.maxX,$e);Z=null,Mt&&(Dt=kt(Mt,Ee,ce-lt,ce+ut,1,fe.minY,fe.maxY,$e),Tr=kt(Mt,Ee,ce+Et,ce+vt,1,fe.minY,fe.maxY,$e),Mt=null),er&&(lr=kt(er,Ee,ce-lt,ce+ut,1,fe.minY,fe.maxY,$e),ir=kt(er,Ee,ce+Et,ce+vt,1,fe.minY,fe.maxY,$e),er=null),Ne>1&&console.timeEnd("clipping"),ve.push(Dt||[],X+1,2*K,2*ce),ve.push(Tr||[],X+1,2*K,2*ce+1),ve.push(lr||[],X+1,2*K+1,2*ce),ve.push(ir||[],X+1,2*K+1,2*ce+1)}}getTile(Z,X,K){Z=+Z,X=+X,K=+K;const ce=this.options,{extent:pe,debug:xe}=ce;if(Z<0||Z>24)return null;const De=1<<Z,ve=_r(Z,X=X+De&De-1,K);if(this.tiles[ve])return Qt(this.tiles[ve],pe);xe>1&&console.log("drilling down to z%d-%d-%d",Z,X,K);let $e,Ne=Z,Ee=X,He=K;for(;!$e&&Ne>0;)Ne--,Ee>>=1,He>>=1,$e=this.tiles[_r(Ne,Ee,He)];return $e&&$e.source?(xe>1&&(console.log("found parent tile z%d-%d-%d",Ne,Ee,He),console.time("drilling down")),this.splitTile($e.source,Ne,Ee,He,Z,X,K),xe>1&&console.timeEnd("drilling down"),this.tiles[ve]?Qt(this.tiles[ve],pe):null):null}}function _r(be,Z,X){return 32*((1<<be)*X+Z)+be}function yr(be,Z){return Z?be.properties[Z]:be.id}function Yr(be,Z){if(be==null)return!0;if(be.type==="Feature")return yr(be,Z)!=null;if(be.type==="FeatureCollection"){const X=new Set;for(const K of be.features){const ce=yr(K,Z);if(ce==null||X.has(ce))return!1;X.add(ce)}return!0}return!1}function zn(be,Z){const X=new Map;if(be!=null)if(be.type==="Feature")X.set(yr(be,Z),be);else for(const K of be.features)X.set(yr(K,Z),K);return X}class As extends O{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(Z,X){return p._(this,void 0,void 0,function*(){const K=Z.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const ce=this._geoJSONIndex.getTile(K.z,K.x,K.y);if(!ce)return null;const pe=new Le(ce.features);let xe=_e(pe);return xe.byteOffset===0&&xe.byteLength===xe.buffer.byteLength||(xe=new Uint8Array(xe)),{vectorTile:pe,rawData:xe.buffer}})}loadData(Z){return p._(this,void 0,void 0,function*(){var X;(X=this._pendingRequest)===null||X===void 0||X.abort();const K=!!(Z&&Z.request&&Z.request.collectResourceTiming)&&new p.cM(Z.request);this._pendingRequest=new AbortController;try{this._pendingData=this.loadAndProcessGeoJSON(Z,this._pendingRequest),this._geoJSONIndex=Z.cluster?new mt(function({superclusterOptions:xe,clusterProperties:De}){if(!De||!xe)return xe;const ve={},$e={},Ne={accumulated:null,zoom:0},Ee={properties:null},He=Object.keys(De);for(const fe of He){const[lt,Et]=De[fe],ut=p.cT(Et),vt=p.cT(typeof lt=="string"?[lt,["accumulated"],["get",fe]]:lt);ve[fe]=ut.value,$e[fe]=vt.value}return xe.map=fe=>{Ee.properties=fe;const lt={};for(const Et of He)lt[Et]=ve[Et].evaluate(Ne,Ee);return lt},xe.reduce=(fe,lt)=>{Ee.properties=lt;for(const Et of He)Ne.accumulated=fe[Et],fe[Et]=$e[Et].evaluate(Ne,Ee)},xe}(Z)).load((yield this._pendingData).features):(ce=yield this._pendingData,new oi(ce,Z.geojsonVtOptions)),this.loaded={};const pe={};if(K){const xe=K.finish();xe&&(pe.resourceTiming={},pe.resourceTiming[Z.source]=JSON.parse(JSON.stringify(xe)))}return pe}catch(pe){if(delete this._pendingRequest,p.cx(pe))return{abandoned:!0};throw pe}var ce})}getData(){return p._(this,void 0,void 0,function*(){return this._pendingData})}reloadTile(Z){const X=this.loaded;return X&&X[Z.uid]?super.reloadTile(Z):this.loadTile(Z)}loadAndProcessGeoJSON(Z,X){return p._(this,void 0,void 0,function*(){let K=yield this.loadGeoJSON(Z,X);if(delete this._pendingRequest,typeof K!="object")throw new Error(`Input data given to '${Z.source}' is not a valid GeoJSON object.`);if(Pe(K,!0),Z.filter){const ce=p.cT(Z.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(ce.result==="error")throw new Error(ce.value.map(xe=>`${xe.key}: ${xe.message}`).join(", "));K={type:"FeatureCollection",features:K.features.filter(xe=>ce.value.evaluate({zoom:0},xe))}}return K})}loadGeoJSON(Z,X){return p._(this,void 0,void 0,function*(){const{promoteId:K}=Z;if(Z.request){const ce=yield p.j(Z.request,X);return this._dataUpdateable=Yr(ce.data,K)?zn(ce.data,K):void 0,ce.data}if(typeof Z.data=="string")try{const ce=JSON.parse(Z.data);return this._dataUpdateable=Yr(ce,K)?zn(ce,K):void 0,ce}catch{throw new Error(`Input data given to '${Z.source}' is not a valid GeoJSON object.`)}if(!Z.dataDiff)throw new Error(`Input data given to '${Z.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${Z.source}`);return function(ce,pe,xe){var De,ve,$e,Ne;if(pe.removeAll&&ce.clear(),pe.remove)for(const Ee of pe.remove)ce.delete(Ee);if(pe.add)for(const Ee of pe.add){const He=yr(Ee,xe);He!=null&&ce.set(He,Ee)}if(pe.update)for(const Ee of pe.update){let He=ce.get(Ee.id);if(He==null)continue;const fe=!Ee.removeAllProperties&&(((De=Ee.removeProperties)===null||De===void 0?void 0:De.length)>0||((ve=Ee.addOrUpdateProperties)===null||ve===void 0?void 0:ve.length)>0);if((Ee.newGeometry||Ee.removeAllProperties||fe)&&(He=Object.assign({},He),ce.set(Ee.id,He),fe&&(He.properties=Object.assign({},He.properties))),Ee.newGeometry&&(He.geometry=Ee.newGeometry),Ee.removeAllProperties)He.properties={};else if((($e=Ee.removeProperties)===null||$e===void 0?void 0:$e.length)>0)for(const lt of Ee.removeProperties)Object.prototype.hasOwnProperty.call(He.properties,lt)&&delete He.properties[lt];if(((Ne=Ee.addOrUpdateProperties)===null||Ne===void 0?void 0:Ne.length)>0)for(const{key:lt,value:Et}of Ee.addOrUpdateProperties)He.properties[lt]=Et}}(this._dataUpdateable,Z.dataDiff,K),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}})}removeSource(Z){return p._(this,void 0,void 0,function*(){this._pendingRequest&&this._pendingRequest.abort()})}getClusterExpansionZoom(Z){return this._geoJSONIndex.getClusterExpansionZoom(Z.clusterId)}getClusterChildren(Z){return this._geoJSONIndex.getChildren(Z.clusterId)}getClusterLeaves(Z){return this._geoJSONIndex.getLeaves(Z.clusterId,Z.limit,Z.offset)}}class ki{constructor(Z){this.self=Z,this.actor=new p.J(Z),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(X,K)=>{if(this.externalWorkerSourceTypes[X])throw new Error(`Worker source with name "${X}" already registered.`);this.externalWorkerSourceTypes[X]=K},this.self.addProtocol=p.cz,this.self.removeProtocol=p.cA,this.self.registerRTLTextPlugin=X=>{p.cU.setMethods(X)},this.actor.registerMessageHandler("LDT",(X,K)=>this._getDEMWorkerSource(X,K.source).loadTile(K)),this.actor.registerMessageHandler("RDT",(X,K)=>p._(this,void 0,void 0,function*(){this._getDEMWorkerSource(X,K.source).removeTile(K)})),this.actor.registerMessageHandler("GCEZ",(X,K)=>p._(this,void 0,void 0,function*(){return this._getWorkerSource(X,K.type,K.source).getClusterExpansionZoom(K)})),this.actor.registerMessageHandler("GCC",(X,K)=>p._(this,void 0,void 0,function*(){return this._getWorkerSource(X,K.type,K.source).getClusterChildren(K)})),this.actor.registerMessageHandler("GCL",(X,K)=>p._(this,void 0,void 0,function*(){return this._getWorkerSource(X,K.type,K.source).getClusterLeaves(K)})),this.actor.registerMessageHandler("LD",(X,K)=>this._getWorkerSource(X,K.type,K.source).loadData(K)),this.actor.registerMessageHandler("GD",(X,K)=>this._getWorkerSource(X,K.type,K.source).getData()),this.actor.registerMessageHandler("LT",(X,K)=>this._getWorkerSource(X,K.type,K.source).loadTile(K)),this.actor.registerMessageHandler("RT",(X,K)=>this._getWorkerSource(X,K.type,K.source).reloadTile(K)),this.actor.registerMessageHandler("AT",(X,K)=>this._getWorkerSource(X,K.type,K.source).abortTile(K)),this.actor.registerMessageHandler("RMT",(X,K)=>this._getWorkerSource(X,K.type,K.source).removeTile(K)),this.actor.registerMessageHandler("RS",(X,K)=>p._(this,void 0,void 0,function*(){if(!this.workerSources[X]||!this.workerSources[X][K.type]||!this.workerSources[X][K.type][K.source])return;const ce=this.workerSources[X][K.type][K.source];delete this.workerSources[X][K.type][K.source],ce.removeSource!==void 0&&ce.removeSource(K)})),this.actor.registerMessageHandler("RM",X=>p._(this,void 0,void 0,function*(){delete this.layerIndexes[X],delete this.availableImages[X],delete this.workerSources[X],delete this.demWorkerSources[X]})),this.actor.registerMessageHandler("SR",(X,K)=>p._(this,void 0,void 0,function*(){this.referrer=K})),this.actor.registerMessageHandler("SRPS",(X,K)=>this._syncRTLPluginState(X,K)),this.actor.registerMessageHandler("IS",(X,K)=>p._(this,void 0,void 0,function*(){this.self.importScripts(K)})),this.actor.registerMessageHandler("SI",(X,K)=>this._setImages(X,K)),this.actor.registerMessageHandler("UL",(X,K)=>p._(this,void 0,void 0,function*(){this._getLayerIndex(X).update(K.layers,K.removedIds)})),this.actor.registerMessageHandler("SL",(X,K)=>p._(this,void 0,void 0,function*(){this._getLayerIndex(X).replace(K)}))}_setImages(Z,X){return p._(this,void 0,void 0,function*(){this.availableImages[Z]=X;for(const K in this.workerSources[Z]){const ce=this.workerSources[Z][K];for(const pe in ce)ce[pe].availableImages=X}})}_syncRTLPluginState(Z,X){return p._(this,void 0,void 0,function*(){return yield p.cU.syncState(X,this.self.importScripts)})}_getAvailableImages(Z){let X=this.availableImages[Z];return X||(X=[]),X}_getLayerIndex(Z){let X=this.layerIndexes[Z];return X||(X=this.layerIndexes[Z]=new o),X}_getWorkerSource(Z,X,K){if(this.workerSources[Z]||(this.workerSources[Z]={}),this.workerSources[Z][X]||(this.workerSources[Z][X]={}),!this.workerSources[Z][X][K]){const ce={sendAsync:(pe,xe)=>(pe.targetMapId=Z,this.actor.sendAsync(pe,xe))};switch(X){case"vector":this.workerSources[Z][X][K]=new O(ce,this._getLayerIndex(Z),this._getAvailableImages(Z));break;case"geojson":this.workerSources[Z][X][K]=new As(ce,this._getLayerIndex(Z),this._getAvailableImages(Z));break;default:this.workerSources[Z][X][K]=new this.externalWorkerSourceTypes[X](ce,this._getLayerIndex(Z),this._getAvailableImages(Z))}}return this.workerSources[Z][X][K]}_getDEMWorkerSource(Z,X){return this.demWorkerSources[Z]||(this.demWorkerSources[Z]={}),this.demWorkerSources[Z][X]||(this.demWorkerSources[Z][X]=new $),this.demWorkerSources[Z][X]}}return p.i(self)&&(self.worker=new ki(self)),ki}),a("index",["exports","./shared"],function(p,o){var T="5.6.1";function E(){var _=new o.A(4);return o.A!=Float32Array&&(_[1]=0,_[2]=0),_[0]=1,_[3]=1,_}let C,O;const $={now:typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frame(_,i,l){const f=requestAnimationFrame(y=>{g(),i(y)}),{unsubscribe:g}=o.s(_.signal,"abort",()=>{g(),cancelAnimationFrame(f),l(o.c())},!1)},frameAsync(_){return new Promise((i,l)=>{this.frame(_,i,l)})},getImageData(_,i=0){return this.getImageCanvasContext(_).getImageData(-i,-i,_.width+2*i,_.height+2*i)},getImageCanvasContext(_){const i=window.document.createElement("canvas"),l=i.getContext("2d",{willReadFrequently:!0});if(!l)throw new Error("failed to create canvas 2d context");return i.width=_.width,i.height=_.height,l.drawImage(_,0,0,_.width,_.height),l},resolveURL:_=>(C||(C=document.createElement("a")),C.href=_,C.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(O==null&&(O=matchMedia("(prefers-reduced-motion: reduce)")),O.matches)}};class V{static testProp(i){if(!V.docStyle)return i[0];for(let l=0;l<i.length;l++)if(i[l]in V.docStyle)return i[l];return i[0]}static create(i,l,f){const g=window.document.createElement(i);return l!==void 0&&(g.className=l),f&&f.appendChild(g),g}static createNS(i,l){return window.document.createElementNS(i,l)}static disableDrag(){V.docStyle&&V.selectProp&&(V.userSelect=V.docStyle[V.selectProp],V.docStyle[V.selectProp]="none")}static enableDrag(){V.docStyle&&V.selectProp&&(V.docStyle[V.selectProp]=V.userSelect)}static setTransform(i,l){i.style[V.transformProp]=l}static addEventListener(i,l,f,g={}){i.addEventListener(l,f,"passive"in g?g:g.capture)}static removeEventListener(i,l,f,g={}){i.removeEventListener(l,f,"passive"in g?g:g.capture)}static suppressClickInternal(i){i.preventDefault(),i.stopPropagation(),window.removeEventListener("click",V.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",V.suppressClickInternal,!0),window.setTimeout(()=>{window.removeEventListener("click",V.suppressClickInternal,!0)},0)}static getScale(i){const l=i.getBoundingClientRect();return{x:l.width/i.offsetWidth||1,y:l.height/i.offsetHeight||1,boundingClientRect:l}}static getPoint(i,l,f){const g=l.boundingClientRect;return new o.P((f.clientX-g.left)/l.x-i.clientLeft,(f.clientY-g.top)/l.y-i.clientTop)}static mousePos(i,l){const f=V.getScale(i);return V.getPoint(i,f,l)}static touchPos(i,l){const f=[],g=V.getScale(i);for(let y=0;y<l.length;y++)f.push(V.getPoint(i,g,l[y]));return f}static mouseButton(i){return i.button}static remove(i){i.parentNode&&i.parentNode.removeChild(i)}static sanitize(i){const l=new DOMParser().parseFromString(i,"text/html").body||document.createElement("body"),f=l.querySelectorAll("script");for(const g of f)g.remove();return V.clean(l),l.innerHTML}static isPossiblyDangerous(i,l){const f=l.replace(/\s+/g,"").toLowerCase();return!(!["src","href","xlink:href"].includes(i)||!f.includes("javascript:")&&!f.includes("data:"))||!!i.startsWith("on")||void 0}static clean(i){const l=i.children;for(const f of l)V.removeAttributes(f),V.clean(f)}static removeAttributes(i){for(const{name:l,value:f}of i.attributes)V.isPossiblyDangerous(l,f)&&i.removeAttribute(l)}}V.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,V.selectProp=V.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),V.transformProp=V.testProp(["transform","WebkitTransform"]);const ie={supported:!1,testSupport:function(_){!je&&Pe&&(Ze?Le(_):we=_)}};let we,Pe,je=!1,Ze=!1;function Le(_){const i=_.createTexture();_.bindTexture(_.TEXTURE_2D,i);try{if(_.texImage2D(_.TEXTURE_2D,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,Pe),_.isContextLost())return;ie.supported=!0}catch{}_.deleteTexture(i),je=!0}var Ue;typeof document<"u"&&(Pe=document.createElement("img"),Pe.onload=()=>{we&&Le(we),we=null,Ze=!0},Pe.onerror=()=>{je=!0,we=null},Pe.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(_){let i,l,f,g;_.resetRequestQueue=()=>{i=[],l=0,f=0,g={}},_.addThrottleControl=I=>{const M=f++;return g[M]=I,M},_.removeThrottleControl=I=>{delete g[I],x()},_.getImage=(I,M,k=!0)=>new Promise((B,F)=>{ie.supported&&(I.headers||(I.headers={}),I.headers.accept="image/webp,*/*"),o.e(I,{type:"image"}),i.push({abortController:M,requestParameters:I,supportImageRefresh:k,state:"queued",onError:N=>{F(N)},onSuccess:N=>{B(N)}}),x()});const y=I=>o._(this,void 0,void 0,function*(){I.state="running";const{requestParameters:M,supportImageRefresh:k,onError:B,onSuccess:F,abortController:N}=I,W=k===!1&&!o.i(self)&&!o.g(M.url)&&(!M.headers||Object.keys(M.headers).reduce((Q,re)=>Q&&re==="accept",!0));l++;const J=W?S(M,N):o.m(M,N);try{const Q=yield J;delete I.abortController,I.state="completed",Q.data instanceof HTMLImageElement||o.b(Q.data)?F(Q):Q.data&&F({data:yield(G=Q.data,typeof createImageBitmap=="function"?o.f(G):o.h(G)),cacheControl:Q.cacheControl,expires:Q.expires})}catch(Q){delete I.abortController,B(Q)}finally{l--,x()}var G}),x=()=>{const I=(()=>{for(const M of Object.keys(g))if(g[M]())return!0;return!1})()?o.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:o.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let M=l;M<I&&i.length>0;M++){const k=i.shift();k.abortController.signal.aborted?M--:y(k)}},S=(I,M)=>new Promise((k,B)=>{const F=new Image,N=I.url,W=I.credentials;W&&W==="include"?F.crossOrigin="use-credentials":(W&&W==="same-origin"||!o.d(N))&&(F.crossOrigin="anonymous"),M.signal.addEventListener("abort",()=>{F.src="",B(o.c())}),F.fetchPriority="high",F.onload=()=>{F.onerror=F.onload=null,k({data:F})},F.onerror=()=>{F.onerror=F.onload=null,M.signal.aborted||B(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},F.src=N})}(Ue||(Ue={})),Ue.resetRequestQueue();class et{constructor(i){this._transformRequestFn=i}transformRequest(i,l){return this._transformRequestFn&&this._transformRequestFn(i,l)||{url:i}}setTransformRequest(i){this._transformRequestFn=i}}function Ke(_){const i=[];if(typeof _=="string")i.push({id:"default",url:_});else if(_&&_.length>0){const l=[];for(const{id:f,url:g}of _){const y=`${f}${g}`;l.indexOf(y)===-1&&(l.push(y),i.push({id:f,url:g}))}}return i}function ct(_,i,l){try{const f=new URL(_);return f.pathname+=`${i}${l}`,f.toString()}catch{throw new Error(`Invalid sprite URL "${_}", must be absolute. Modify style specification directly or use TransformStyleFunction to correct the issue dynamically`)}}function me(_){const{userImage:i}=_;return!!(i&&i.render&&i.render())&&(_.data.replace(new Uint8Array(i.data.buffer)),!0)}class _e extends o.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new o.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(i){if(this.loaded!==i&&(this.loaded=i,i)){for(const{ids:l,promiseResolve:f}of this.requestors)f(this._getImagesForIds(l));this.requestors=[]}}getImage(i){const l=this.images[i];if(l&&!l.data&&l.spriteData){const f=l.spriteData;l.data=new o.R({width:f.width,height:f.height},f.context.getImageData(f.x,f.y,f.width,f.height).data),l.spriteData=null}return l}addImage(i,l){if(this.images[i])throw new Error(`Image id ${i} already exist, use updateImage instead`);this._validate(i,l)&&(this.images[i]=l)}_validate(i,l){let f=!0;const g=l.data||l.spriteData;return this._validateStretch(l.stretchX,g&&g.width)||(this.fire(new o.k(new Error(`Image "${i}" has invalid "stretchX" value`))),f=!1),this._validateStretch(l.stretchY,g&&g.height)||(this.fire(new o.k(new Error(`Image "${i}" has invalid "stretchY" value`))),f=!1),this._validateContent(l.content,l)||(this.fire(new o.k(new Error(`Image "${i}" has invalid "content" value`))),f=!1),f}_validateStretch(i,l){if(!i)return!0;let f=0;for(const g of i){if(g[0]<f||g[1]<g[0]||l<g[1])return!1;f=g[1]}return!0}_validateContent(i,l){if(!i)return!0;if(i.length!==4)return!1;const f=l.spriteData,g=f&&f.width||l.data.width,y=f&&f.height||l.data.height;return!(i[0]<0||g<i[0]||i[1]<0||y<i[1]||i[2]<0||g<i[2]||i[3]<0||y<i[3]||i[2]<i[0]||i[3]<i[1])}updateImage(i,l,f=!0){const g=this.getImage(i);if(f&&(g.data.width!==l.data.width||g.data.height!==l.data.height))throw new Error(`size mismatch between old image (${g.data.width}x${g.data.height}) and new image (${l.data.width}x${l.data.height}).`);l.version=g.version+1,this.images[i]=l,this.updatedImages[i]=!0}removeImage(i){const l=this.images[i];delete this.images[i],delete this.patterns[i],l.userImage&&l.userImage.onRemove&&l.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(i){return new Promise((l,f)=>{let g=!0;if(!this.isLoaded())for(const y of i)this.images[y]||(g=!1);this.isLoaded()||g?l(this._getImagesForIds(i)):this.requestors.push({ids:i,promiseResolve:l})})}_getImagesForIds(i){const l={};for(const f of i){let g=this.getImage(f);g||(this.fire(new o.l("styleimagemissing",{id:f})),g=this.getImage(f)),g?l[f]={data:g.data.clone(),pixelRatio:g.pixelRatio,sdf:g.sdf,version:g.version,stretchX:g.stretchX,stretchY:g.stretchY,content:g.content,textFitWidth:g.textFitWidth,textFitHeight:g.textFitHeight,hasRenderCallback:!!(g.userImage&&g.userImage.render)}:o.w(`Image "${f}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return l}getPixelSize(){const{width:i,height:l}=this.atlasImage;return{width:i,height:l}}getPattern(i){const l=this.patterns[i],f=this.getImage(i);if(!f)return null;if(l&&l.position.version===f.version)return l.position;if(l)l.position.version=f.version;else{const g={w:f.data.width+2,h:f.data.height+2,x:0,y:0},y=new o.I(g,f);this.patterns[i]={bin:g,position:y}}return this._updatePatternAtlas(),this.patterns[i].position}bind(i){const l=i.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new o.T(i,this.atlasImage,l.RGBA),this.atlasTexture.bind(l.LINEAR,l.CLAMP_TO_EDGE)}_updatePatternAtlas(){const i=[];for(const y in this.patterns)i.push(this.patterns[y].bin);const{w:l,h:f}=o.p(i),g=this.atlasImage;g.resize({width:l||1,height:f||1});for(const y in this.patterns){const{bin:x}=this.patterns[y],S=x.x+1,I=x.y+1,M=this.getImage(y).data,k=M.width,B=M.height;o.R.copy(M,g,{x:0,y:0},{x:S,y:I},{width:k,height:B}),o.R.copy(M,g,{x:0,y:B-1},{x:S,y:I-1},{width:k,height:1}),o.R.copy(M,g,{x:0,y:0},{x:S,y:I+B},{width:k,height:1}),o.R.copy(M,g,{x:k-1,y:0},{x:S-1,y:I},{width:1,height:B}),o.R.copy(M,g,{x:0,y:0},{x:S+k,y:I},{width:1,height:B})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(i){for(const l of i){if(this.callbackDispatchedThisFrame[l])continue;this.callbackDispatchedThisFrame[l]=!0;const f=this.getImage(l);f||o.w(`Image with ID: "${l}" was not found`),me(f)&&this.updateImage(l,f)}}}const ze=1e20;function Qe(_,i,l,f,g,y,x,S,I){for(let M=i;M<i+f;M++)at(_,l*y+M,y,g,x,S,I);for(let M=l;M<l+g;M++)at(_,M*y+i,1,f,x,S,I)}function at(_,i,l,f,g,y,x){y[0]=0,x[0]=-ze,x[1]=ze,g[0]=_[i];for(let S=1,I=0,M=0;S<f;S++){g[S]=_[i+S*l];const k=S*S;do{const B=y[I];M=(g[S]-g[B]+k-B*B)/(S-B)/2}while(M<=x[I]&&--I>-1);I++,y[I]=S,x[I]=M,x[I+1]=ze}for(let S=0,I=0;S<f;S++){for(;x[I+1]<S;)I++;const M=y[I],k=S-M;_[i+S*l]=g[M]+k*k}}class mt{constructor(i,l){this.requestManager=i,this.localIdeographFontFamily=l,this.entries={}}setURL(i){this.url=i}getGlyphs(i){return o._(this,void 0,void 0,function*(){const l=[];for(const y in i)for(const x of i[y])l.push(this._getAndCacheGlyphsPromise(y,x));const f=yield Promise.all(l),g={};for(const{stack:y,id:x,glyph:S}of f)g[y]||(g[y]={}),g[y][x]=S&&{id:S.id,bitmap:S.bitmap.clone(),metrics:S.metrics};return g})}_getAndCacheGlyphsPromise(i,l){return o._(this,void 0,void 0,function*(){let f=this.entries[i];f||(f=this.entries[i]={glyphs:{},requests:{},ranges:{}});let g=f.glyphs[l];if(g!==void 0)return{stack:i,id:l,glyph:g};if(g=this._tinySDF(f,i,l),g)return f.glyphs[l]=g,{stack:i,id:l,glyph:g};const y=Math.floor(l/256);if(256*y>65535)throw new Error("glyphs > 65535 not supported");if(f.ranges[y])return{stack:i,id:l,glyph:g};if(!this.url)throw new Error("glyphsUrl is not set");if(!f.requests[y]){const S=mt.loadGlyphRange(i,y,this.url,this.requestManager);f.requests[y]=S}const x=yield f.requests[y];for(const S in x)this._doesCharSupportLocalGlyph(+S)||(f.glyphs[+S]=x[+S]);return f.ranges[y]=!0,{stack:i,id:l,glyph:x[l]||null}})}_doesCharSupportLocalGlyph(i){return!!this.localIdeographFontFamily&&(new RegExp("\\p{Ideo}|\\p{sc=Hang}|\\p{sc=Hira}|\\p{sc=Kana}","u").test(String.fromCodePoint(i))||o.u["CJK Unified Ideographs"](i)||o.u["Hangul Syllables"](i)||o.u.Hiragana(i)||o.u.Katakana(i)||o.u["CJK Symbols and Punctuation"](i)||o.u["Halfwidth and Fullwidth Forms"](i))}_tinySDF(i,l,f){const g=this.localIdeographFontFamily;if(!g||!this._doesCharSupportLocalGlyph(f))return;let y=i.tinySDF;if(!y){let S="400";/bold/i.test(l)?S="900":/medium/i.test(l)?S="500":/light/i.test(l)&&(S="200"),y=i.tinySDF=new mt.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:g,fontWeight:S})}const x=y.draw(String.fromCharCode(f));return{id:f,bitmap:new o.q({width:x.width||60,height:x.height||60},x.data),metrics:{width:x.glyphWidth/2||24,height:x.glyphHeight/2||24,left:x.glyphLeft/2+.5||0,top:x.glyphTop/2-27.5||-8,advance:x.glyphAdvance/2||24,isDoubleResolution:!0}}}}mt.loadGlyphRange=function(_,i,l,f){return o._(this,void 0,void 0,function*(){const g=256*i,y=g+255,x=f.transformRequest(l.replace("{fontstack}",_).replace("{range}",`${g}-${y}`),"Glyphs"),S=yield o.n(x,new AbortController);if(!S||!S.data)throw new Error(`Could not load glyph range. range: ${i}, ${g}-${y}`);const I={};for(const M of o.o(S.data))I[M.id]=M;return I})},mt.TinySDF=class{constructor({fontSize:_=24,buffer:i=3,radius:l=8,cutoff:f=.25,fontFamily:g="sans-serif",fontWeight:y="normal",fontStyle:x="normal"}={}){this.buffer=i,this.cutoff=f,this.radius=l;const S=this.size=_+4*i,I=this._createCanvas(S),M=this.ctx=I.getContext("2d",{willReadFrequently:!0});M.font=`${x} ${y} ${_}px ${g}`,M.textBaseline="alphabetic",M.textAlign="left",M.fillStyle="black",this.gridOuter=new Float64Array(S*S),this.gridInner=new Float64Array(S*S),this.f=new Float64Array(S),this.z=new Float64Array(S+1),this.v=new Uint16Array(S)}_createCanvas(_){const i=document.createElement("canvas");return i.width=i.height=_,i}draw(_){const{width:i,actualBoundingBoxAscent:l,actualBoundingBoxDescent:f,actualBoundingBoxLeft:g,actualBoundingBoxRight:y}=this.ctx.measureText(_),x=Math.ceil(l),S=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(y-g))),I=Math.min(this.size-this.buffer,x+Math.ceil(f)),M=S+2*this.buffer,k=I+2*this.buffer,B=Math.max(M*k,0),F=new Uint8ClampedArray(B),N={data:F,width:M,height:k,glyphWidth:S,glyphHeight:I,glyphTop:x,glyphLeft:0,glyphAdvance:i};if(S===0||I===0)return N;const{ctx:W,buffer:J,gridInner:G,gridOuter:Q}=this;W.clearRect(J,J,S,I),W.fillText(_,J,J+x);const re=W.getImageData(J,J,S,I);Q.fill(ze,0,B),G.fill(0,0,B);for(let ae=0;ae<I;ae++)for(let se=0;se<S;se++){const ue=re.data[4*(ae*S+se)+3]/255;if(ue===0)continue;const de=(ae+J)*M+se+J;if(ue===1)Q[de]=0,G[de]=ze;else{const oe=.5-ue;Q[de]=oe>0?oe*oe:0,G[de]=oe<0?oe*oe:0}}Qe(Q,0,0,M,k,M,this.f,this.v,this.z),Qe(G,J,J,S,I,M,this.f,this.v,this.z);for(let ae=0;ae<B;ae++){const se=Math.sqrt(Q[ae])-Math.sqrt(G[ae]);F[ae]=Math.round(255-255*(se/this.radius+this.cutoff))}return N}};class At{constructor(){this.specification=o.v.light.position}possiblyEvaluate(i,l){return o.B(i.expression.evaluate(l))}interpolate(i,l,f){return{x:o.C.number(i.x,l.x,f),y:o.C.number(i.y,l.y,f),z:o.C.number(i.z,l.z,f)}}}let or;class ti extends o.E{constructor(i){super(),or=or||new o.r({anchor:new o.D(o.v.light.anchor),position:new At,color:new o.D(o.v.light.color),intensity:new o.D(o.v.light.intensity)}),this._transitionable=new o.t(or),this.setLight(i),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(i,l={}){if(!this._validate(o.x,i,l))for(const f in i){const g=i[f];f.endsWith("-transition")?this._transitionable.setTransition(f.slice(0,-11),g):this._transitionable.setValue(f,g)}}updateTransitions(i){this._transitioning=this._transitionable.transitioned(i,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(i){this.properties=this._transitioning.possiblyEvaluate(i)}_validate(i,l,f){return(!f||f.validate!==!1)&&o.y(this,i.call(o.z,{value:l,style:{glyphs:!0,sprite:!0},styleSpec:o.v}))}}const Bt=new o.r({"sky-color":new o.D(o.v.sky["sky-color"]),"horizon-color":new o.D(o.v.sky["horizon-color"]),"fog-color":new o.D(o.v.sky["fog-color"]),"fog-ground-blend":new o.D(o.v.sky["fog-ground-blend"]),"horizon-fog-blend":new o.D(o.v.sky["horizon-fog-blend"]),"sky-horizon-blend":new o.D(o.v.sky["sky-horizon-blend"]),"atmosphere-blend":new o.D(o.v.sky["atmosphere-blend"])});class wr extends o.E{constructor(i){super(),this._transitionable=new o.t(Bt),this.setSky(i),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new o.F(0))}setSky(i,l={}){if(!this._validate(o.G,i,l)){i||(i={"sky-color":"transparent","horizon-color":"transparent","fog-color":"transparent","fog-ground-blend":1,"atmosphere-blend":0});for(const f in i){const g=i[f];f.endsWith("-transition")?this._transitionable.setTransition(f.slice(0,-11),g):this._transitionable.setValue(f,g)}}}getSky(){return this._transitionable.serialize()}updateTransitions(i){this._transitioning=this._transitionable.transitioned(i,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(i){this.properties=this._transitioning.possiblyEvaluate(i)}_validate(i,l,f={}){return f?.validate!==!1&&o.y(this,i.call(o.z,o.e({value:l,style:{glyphs:!0,sprite:!0},styleSpec:o.v})))}calculateFogBlendOpacity(i){return i<60?0:i<70?(i-60)/10:1}}class Rt{constructor(i,l){this.width=i,this.height=l,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(i,l){const f=i.join(",")+String(l);return this.dashEntry[f]||(this.dashEntry[f]=this.addDash(i,l)),this.dashEntry[f]}getDashRanges(i,l,f){const g=[];let y=i.length%2==1?-i[i.length-1]*f:0,x=i[0]*f,S=!0;g.push({left:y,right:x,isDash:S,zeroLength:i[0]===0});let I=i[0];for(let M=1;M<i.length;M++){S=!S;const k=i[M];y=I*f,I+=k,x=I*f,g.push({left:y,right:x,isDash:S,zeroLength:k===0})}return g}addRoundDash(i,l,f){const g=l/2;for(let y=-f;y<=f;y++){const x=this.width*(this.nextRow+f+y);let S=0,I=i[S];for(let M=0;M<this.width;M++){M/I.right>1&&(I=i[++S]);const k=Math.abs(M-I.left),B=Math.abs(M-I.right),F=Math.min(k,B);let N;const W=y/f*(g+1);if(I.isDash){const J=g-Math.abs(W);N=Math.sqrt(F*F+J*J)}else N=g-Math.sqrt(F*F+W*W);this.data[x+M]=Math.max(0,Math.min(255,N+128))}}}addRegularDash(i){for(let S=i.length-1;S>=0;--S){const I=i[S],M=i[S+1];I.zeroLength?i.splice(S,1):M&&M.isDash===I.isDash&&(M.left=I.left,i.splice(S,1))}const l=i[0],f=i[i.length-1];l.isDash===f.isDash&&(l.left=f.left-this.width,f.right=l.right+this.width);const g=this.width*this.nextRow;let y=0,x=i[y];for(let S=0;S<this.width;S++){S/x.right>1&&(x=i[++y]);const I=Math.abs(S-x.left),M=Math.abs(S-x.right),k=Math.min(I,M);this.data[g+S]=Math.max(0,Math.min(255,(x.isDash?k:-k)+128))}}addDash(i,l){const f=l?7:0,g=2*f+1;if(this.nextRow+g>this.height)return o.w("LineAtlas out of space"),null;let y=0;for(let S=0;S<i.length;S++)y+=i[S];if(y!==0){const S=this.width/y,I=this.getDashRanges(i,this.width,S);l?this.addRoundDash(I,S,f):this.addRegularDash(I)}const x={y:(this.nextRow+f+.5)/this.height,height:2*f/this.height,width:y};return this.nextRow+=g,this.dirty=!0,x}bind(i){const l=i.gl;this.texture?(l.bindTexture(l.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,l.texSubImage2D(l.TEXTURE_2D,0,0,0,this.width,this.height,l.ALPHA,l.UNSIGNED_BYTE,this.data))):(this.texture=l.createTexture(),l.bindTexture(l.TEXTURE_2D,this.texture),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.REPEAT),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.REPEAT),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.LINEAR),l.texImage2D(l.TEXTURE_2D,0,l.ALPHA,this.width,this.height,0,l.ALPHA,l.UNSIGNED_BYTE,this.data))}}const Vr="maplibre_preloaded_worker_pool";class It{constructor(){this.active={}}acquire(i){if(!this.workers)for(this.workers=[];this.workers.length<It.workerCount;)this.workers.push(new Worker(o.a.WORKER_URL));return this.active[i]=!0,this.workers.slice()}release(i){delete this.active[i],this.numActive()===0&&(this.workers.forEach(l=>{l.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Vr]}numActive(){return Object.keys(this.active).length}}const yt=Math.floor($.hardwareConcurrency/2);let bt,ar;function cr(){return bt||(bt=new It),bt}It.workerCount=o.H(globalThis)?Math.max(Math.min(yt,3),1):1;class Mr{constructor(i,l){this.workerPool=i,this.actors=[],this.currentActor=0,this.id=l;const f=this.workerPool.acquire(l);for(let g=0;g<f.length;g++){const y=new o.J(f[g],l);y.name=`Worker ${g}`,this.actors.push(y)}if(!this.actors.length)throw new Error("No actors found")}broadcast(i,l){const f=[];for(const g of this.actors)f.push(g.sendAsync({type:i,data:l}));return Promise.all(f)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(i=!0){this.actors.forEach(l=>{l.remove()}),this.actors=[],i&&this.workerPool.release(this.id)}registerMessageHandler(i,l){for(const f of this.actors)f.registerMessageHandler(i,l)}}function ri(){return ar||(ar=new Mr(cr(),o.K),ar.registerMessageHandler("GR",(_,i,l)=>o.m(i,l))),ar}function Ht(_,i){const l=o.L();return o.M(l,l,[1,1,0]),o.N(l,l,[.5*_.width,.5*_.height,1]),_.calculatePosMatrix?o.O(l,l,_.calculatePosMatrix(i.toUnwrapped())):l}function kt(_,i,l,f,g,y,x){var S;const I=function(F,N,W){if(F)for(const J of F){const G=N[J];if(G&&G.source===W&&G.type==="fill-extrusion")return!0}else for(const J in N){const G=N[J];if(G.source===W&&G.type==="fill-extrusion")return!0}return!1}((S=g?.layers)!==null&&S!==void 0?S:null,i,_.id),M=y.maxPitchScaleFactor(),k=_.tilesIn(f,M,I);k.sort(gr);const B=[];for(const F of k)B.push({wrappedTileID:F.tileID.wrapped().key,queryResults:F.tile.queryRenderedFeatures(i,l,_._state,F.queryGeometry,F.cameraQueryGeometry,F.scale,g,y,M,Ht(_.transform,F.tileID),x?(N,W)=>x(F.tileID,N,W):void 0)});return function(F,N){for(const W in F)for(const J of F[W])Tt(J,N);return F}(function(F){const N={},W={};for(const J of F){const G=J.queryResults,Q=J.wrappedTileID,re=W[Q]=W[Q]||{};for(const ae in G){const se=G[ae],ue=re[ae]=re[ae]||{},de=N[ae]=N[ae]||[];for(const oe of se)ue[oe.featureIndex]||(ue[oe.featureIndex]=!0,de.push(oe))}}return N}(B),_)}function gr(_,i){const l=_.tileID,f=i.tileID;return l.overscaledZ-f.overscaledZ||l.canonical.y-f.canonical.y||l.wrap-f.wrap||l.canonical.x-f.canonical.x}function Tt(_,i){const l=_.feature,f=i.getFeatureState(l.layer["source-layer"],l.id);l.source=l.layer.source,l.layer["source-layer"]&&(l.sourceLayer=l.layer["source-layer"]),l.state=f}function mr(_,i,l){return o._(this,void 0,void 0,function*(){let f=_;if(_.url?f=(yield o.j(i.transformRequest(_.url,"Source"),l)).data:yield $.frameAsync(l),!f)return null;const g=o.Q(o.e(f,_),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in f&&f.vector_layers&&(g.vectorLayerIds=f.vector_layers.map(y=>y.id)),g})}class zt{constructor(i,l){i&&(l?this.setSouthWest(i).setNorthEast(l):Array.isArray(i)&&(i.length===4?this.setSouthWest([i[0],i[1]]).setNorthEast([i[2],i[3]]):this.setSouthWest(i[0]).setNorthEast(i[1])))}setNorthEast(i){return this._ne=i instanceof o.S?new o.S(i.lng,i.lat):o.S.convert(i),this}setSouthWest(i){return this._sw=i instanceof o.S?new o.S(i.lng,i.lat):o.S.convert(i),this}extend(i){const l=this._sw,f=this._ne;let g,y;if(i instanceof o.S)g=i,y=i;else{if(!(i instanceof zt))return Array.isArray(i)?i.length===4||i.every(Array.isArray)?this.extend(zt.convert(i)):this.extend(o.S.convert(i)):i&&("lng"in i||"lon"in i)&&"lat"in i?this.extend(o.S.convert(i)):this;if(g=i._sw,y=i._ne,!g||!y)return this}return l||f?(l.lng=Math.min(g.lng,l.lng),l.lat=Math.min(g.lat,l.lat),f.lng=Math.max(y.lng,f.lng),f.lat=Math.max(y.lat,f.lat)):(this._sw=new o.S(g.lng,g.lat),this._ne=new o.S(y.lng,y.lat)),this}getCenter(){return new o.S((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new o.S(this.getWest(),this.getNorth())}getSouthEast(){return new o.S(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(i){const{lng:l,lat:f}=o.S.convert(i);let g=this._sw.lng<=l&&l<=this._ne.lng;return this._sw.lng>this._ne.lng&&(g=this._sw.lng>=l&&l>=this._ne.lng),this._sw.lat<=f&&f<=this._ne.lat&&g}static convert(i){return i instanceof zt?i:i&&new zt(i)}static fromLngLat(i,l=0){const f=360*l/40075017,g=f/Math.cos(Math.PI/180*i.lat);return new zt(new o.S(i.lng-g,i.lat-f),new o.S(i.lng+g,i.lat+f))}adjustAntiMeridian(){const i=new o.S(this._sw.lng,this._sw.lat),l=new o.S(this._ne.lng,this._ne.lat);return new zt(i,i.lng>l.lng?new o.S(l.lng+360,l.lat):l)}}class Jt{constructor(i,l,f){this.bounds=zt.convert(this.validateBounds(i)),this.minzoom=l||0,this.maxzoom=f||24}validateBounds(i){return Array.isArray(i)&&i.length===4?[Math.max(-180,i[0]),Math.max(-90,i[1]),Math.min(180,i[2]),Math.min(90,i[3])]:[-180,-90,180,90]}contains(i){const l=Math.pow(2,i.z),f=Math.floor(o.V(this.bounds.getWest())*l),g=Math.floor(o.U(this.bounds.getNorth())*l),y=Math.ceil(o.V(this.bounds.getEast())*l),x=Math.ceil(o.U(this.bounds.getSouth())*l);return i.x>=f&&i.x<y&&i.y>=g&&i.y<x}}class Gt extends o.E{constructor(i,l,f,g){if(super(),this.id=i,this.dispatcher=f,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,o.e(this,o.Q(l,["url","scheme","tileSize","promoteId"])),this._options=o.e({type:"vector"},l),this._collectResourceTiming=l.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(g)}load(){return o._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new o.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const i=yield mr(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),i&&(o.e(this,i),i.bounds&&(this.tileBounds=new Jt(i.bounds,this.minzoom,this.maxzoom)),this.fire(new o.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.l("data",{dataType:"source",sourceDataType:"content"})))}catch(i){this._tileJSONRequest=null,this.fire(new o.k(i))}})}loaded(){return this._loaded}hasTile(i){return!this.tileBounds||this.tileBounds.contains(i.canonical)}onAdd(i){this.map=i,this.load()}setSourceProperty(i){this._tileJSONRequest&&this._tileJSONRequest.abort(),i(),this.load()}setTiles(i){return this.setSourceProperty(()=>{this._options.tiles=i}),this}setUrl(i){return this.setSourceProperty(()=>{this.url=i,this._options.url=i}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return o.e({},this._options)}loadTile(i){return o._(this,void 0,void 0,function*(){const l=i.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),f={request:this.map._requestManager.transformRequest(l,"Tile"),uid:i.uid,tileID:i.tileID,zoom:i.tileID.overscaledZ,tileSize:this.tileSize*i.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity,globalState:this.map.getGlobalState()};f.request.collectResourceTiming=this._collectResourceTiming;let g="RT";if(i.actor&&i.state!=="expired"){if(i.state==="loading")return new Promise((y,x)=>{i.reloadPromise={resolve:y,reject:x}})}else i.actor=this.dispatcher.getActor(),g="LT";i.abortController=new AbortController;try{const y=yield i.actor.sendAsync({type:g,data:f},i.abortController);if(delete i.abortController,i.aborted)return;this._afterTileLoadWorkerResponse(i,y)}catch(y){if(delete i.abortController,i.aborted)return;if(y&&y.status!==404)throw y;this._afterTileLoadWorkerResponse(i,null)}})}_afterTileLoadWorkerResponse(i,l){if(l&&l.resourceTiming&&(i.resourceTiming=l.resourceTiming),l&&this.map._refreshExpiredTiles&&i.setExpiryData(l),i.loadVectorData(l,this.map.painter),i.reloadPromise){const f=i.reloadPromise;i.reloadPromise=null,this.loadTile(i).then(f.resolve).catch(f.reject)}}abortTile(i){return o._(this,void 0,void 0,function*(){i.abortController&&(i.abortController.abort(),delete i.abortController),i.actor&&(yield i.actor.sendAsync({type:"AT",data:{uid:i.uid,type:this.type,source:this.id}}))})}unloadTile(i){return o._(this,void 0,void 0,function*(){i.unloadVectorData(),i.actor&&(yield i.actor.sendAsync({type:"RMT",data:{uid:i.uid,type:this.type,source:this.id}}))})}hasTransition(){return!1}}class $t extends o.E{constructor(i,l,f,g){super(),this.id=i,this.dispatcher=f,this.setEventedParent(g),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=o.e({type:"raster"},l),o.e(this,o.Q(l,["url","scheme","tileSize"]))}load(){return o._(this,arguments,void 0,function*(i=!1){this._loaded=!1,this.fire(new o.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const l=yield mr(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,l&&(o.e(this,l),l.bounds&&(this.tileBounds=new Jt(l.bounds,this.minzoom,this.maxzoom)),this.fire(new o.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.l("data",{dataType:"source",sourceDataType:"content",sourceDataChanged:i})))}catch(l){this._tileJSONRequest=null,this.fire(new o.k(l))}})}loaded(){return this._loaded}onAdd(i){this.map=i,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(i){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),i(),this.load(!0)}setTiles(i){return this.setSourceProperty(()=>{this._options.tiles=i}),this}setUrl(i){return this.setSourceProperty(()=>{this.url=i,this._options.url=i}),this}serialize(){return o.e({},this._options)}hasTile(i){return!this.tileBounds||this.tileBounds.contains(i.canonical)}loadTile(i){return o._(this,void 0,void 0,function*(){const l=i.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);i.abortController=new AbortController;try{const f=yield Ue.getImage(this.map._requestManager.transformRequest(l,"Tile"),i.abortController,this.map._refreshExpiredTiles);if(delete i.abortController,i.aborted)return void(i.state="unloaded");if(f&&f.data){this.map._refreshExpiredTiles&&(f.cacheControl||f.expires)&&i.setExpiryData({cacheControl:f.cacheControl,expires:f.expires});const g=this.map.painter.context,y=g.gl,x=f.data;i.texture=this.map.painter.getTileTexture(x.width),i.texture?i.texture.update(x,{useMipmap:!0}):(i.texture=new o.T(g,x,y.RGBA,{useMipmap:!0}),i.texture.bind(y.LINEAR,y.CLAMP_TO_EDGE,y.LINEAR_MIPMAP_NEAREST)),i.state="loaded"}}catch(f){if(delete i.abortController,i.aborted)i.state="unloaded";else if(f)throw i.state="errored",f}})}abortTile(i){return o._(this,void 0,void 0,function*(){i.abortController&&(i.abortController.abort(),delete i.abortController)})}unloadTile(i){return o._(this,void 0,void 0,function*(){i.texture&&this.map.painter.saveTileTexture(i.texture)})}hasTransition(){return!1}}class hr extends $t{constructor(i,l,f,g){super(i,l,f,g),this.type="raster-dem",this.maxzoom=22,this._options=o.e({type:"raster-dem"},l),this.encoding=l.encoding||"mapbox",this.redFactor=l.redFactor,this.greenFactor=l.greenFactor,this.blueFactor=l.blueFactor,this.baseShift=l.baseShift}loadTile(i){return o._(this,void 0,void 0,function*(){const l=i.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),f=this.map._requestManager.transformRequest(l,"Tile");i.neighboringTiles=this._getNeighboringTiles(i.tileID),i.abortController=new AbortController;try{const g=yield Ue.getImage(f,i.abortController,this.map._refreshExpiredTiles);if(delete i.abortController,i.aborted)return void(i.state="unloaded");if(g&&g.data){const y=g.data;this.map._refreshExpiredTiles&&(g.cacheControl||g.expires)&&i.setExpiryData({cacheControl:g.cacheControl,expires:g.expires});const x=o.b(y)&&o.W()?y:yield this.readImageNow(y),S={type:this.type,uid:i.uid,source:this.id,rawImageData:x,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!i.actor||i.state==="expired"){i.actor=this.dispatcher.getActor();const I=yield i.actor.sendAsync({type:"LDT",data:S});i.dem=I,i.needsHillshadePrepare=!0,i.needsTerrainPrepare=!0,i.state="loaded"}}}catch(g){if(delete i.abortController,i.aborted)i.state="unloaded";else if(g)throw i.state="errored",g}})}readImageNow(i){return o._(this,void 0,void 0,function*(){if(typeof VideoFrame<"u"&&o.X()){const l=i.width+2,f=i.height+2;try{return new o.R({width:l,height:f},yield o.Y(i,-1,-1,l,f))}catch{}}return $.getImageData(i,1)})}_getNeighboringTiles(i){const l=i.canonical,f=Math.pow(2,l.z),g=(l.x-1+f)%f,y=l.x===0?i.wrap-1:i.wrap,x=(l.x+1+f)%f,S=l.x+1===f?i.wrap+1:i.wrap,I={};return I[new o.Z(i.overscaledZ,y,l.z,g,l.y).key]={backfilled:!1},I[new o.Z(i.overscaledZ,S,l.z,x,l.y).key]={backfilled:!1},l.y>0&&(I[new o.Z(i.overscaledZ,y,l.z,g,l.y-1).key]={backfilled:!1},I[new o.Z(i.overscaledZ,i.wrap,l.z,l.x,l.y-1).key]={backfilled:!1},I[new o.Z(i.overscaledZ,S,l.z,x,l.y-1).key]={backfilled:!1}),l.y+1<f&&(I[new o.Z(i.overscaledZ,y,l.z,g,l.y+1).key]={backfilled:!1},I[new o.Z(i.overscaledZ,i.wrap,l.z,l.x,l.y+1).key]={backfilled:!1},I[new o.Z(i.overscaledZ,S,l.z,x,l.y+1).key]={backfilled:!1}),I}unloadTile(i){return o._(this,void 0,void 0,function*(){i.demTexture&&this.map.painter.saveTileTexture(i.demTexture),i.fbo&&(i.fbo.destroy(),delete i.fbo),i.dem&&delete i.dem,delete i.neighboringTiles,i.state="unloaded",i.actor&&(yield i.actor.sendAsync({type:"RDT",data:{type:this.type,uid:i.uid,source:this.id}}))})}}class Ct extends o.E{constructor(i,l,f,g){super(),this.id=i,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=f.getActor(),this.setEventedParent(g),this._data=l.data,this._options=o.e({},l),this._collectResourceTiming=l.collectResourceTiming,l.maxzoom!==void 0&&(this.maxzoom=l.maxzoom),l.type&&(this.type=l.type),l.attribution&&(this.attribution=l.attribution),this.promoteId=l.promoteId,l.clusterMaxZoom!==void 0&&this.maxzoom<=l.clusterMaxZoom&&o.w(`The maxzoom value "${this.maxzoom}" is expected to be greater than the clusterMaxZoom value "${l.clusterMaxZoom}".`),this.workerOptions=o.e({source:this.id,cluster:l.cluster||!1,geojsonVtOptions:{buffer:this._pixelsToTileUnits(l.buffer!==void 0?l.buffer:128),tolerance:this._pixelsToTileUnits(l.tolerance!==void 0?l.tolerance:.375),extent:o.$,maxZoom:this.maxzoom,lineMetrics:l.lineMetrics||!1,generateId:l.generateId||!1},superclusterOptions:{maxZoom:this._getClusterMaxZoom(l.clusterMaxZoom),minPoints:Math.max(2,l.clusterMinPoints||2),extent:o.$,radius:this._pixelsToTileUnits(l.clusterRadius||50),log:!1,generateId:l.generateId||!1},clusterProperties:l.clusterProperties,filter:l.filter},l.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}_pixelsToTileUnits(i){return i*(o.$/this.tileSize)}_getClusterMaxZoom(i){const l=i?Math.round(i):this.maxzoom-1;return Number.isInteger(i)||i===void 0||o.w(`Integer expected for option 'clusterMaxZoom': provided value "${i}" rounded to "${l}"`),l}load(){return o._(this,void 0,void 0,function*(){yield this._updateWorkerData()})}onAdd(i){this.map=i,this.load()}setData(i){return this._data=i,this._updateWorkerData(),this}updateData(i){return this._updateWorkerData(i),this}getData(){return o._(this,void 0,void 0,function*(){const i=o.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:i})})}getCoordinatesFromGeometry(i){return i.type==="GeometryCollection"?i.geometries.map(l=>l.coordinates).flat(1/0):i.coordinates.flat(1/0)}getBounds(){return o._(this,void 0,void 0,function*(){const i=new zt,l=yield this.getData();let f;switch(l.type){case"FeatureCollection":f=l.features.map(g=>this.getCoordinatesFromGeometry(g.geometry)).flat(1/0);break;case"Feature":f=this.getCoordinatesFromGeometry(l.geometry);break;default:f=this.getCoordinatesFromGeometry(l)}if(f.length==0)return i;for(let g=0;g<f.length-1;g+=2)i.extend([f[g],f[g+1]]);return i})}setClusterOptions(i){return this.workerOptions.cluster=i.cluster,i&&(i.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=this._pixelsToTileUnits(i.clusterRadius)),i.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=this._getClusterMaxZoom(i.clusterMaxZoom))),this._updateWorkerData(),this}getClusterExpansionZoom(i){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:i,source:this.id}})}getClusterChildren(i){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:i,source:this.id}})}getClusterLeaves(i,l,f){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:i,limit:l,offset:f}})}_updateWorkerData(i){return o._(this,void 0,void 0,function*(){const l=o.e({type:this.type},this.workerOptions);i?l.dataDiff=i:typeof this._data=="string"?(l.request=this.map._requestManager.transformRequest($.resolveURL(this._data),"Source"),l.request.collectResourceTiming=this._collectResourceTiming):l.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new o.l("dataloading",{dataType:"source"}));try{const f=yield this.actor.sendAsync({type:"LD",data:l});if(this._pendingLoads--,this._removed||f.abandoned)return void this.fire(new o.l("dataabort",{dataType:"source"}));let g=null;f.resourceTiming&&f.resourceTiming[this.id]&&(g=f.resourceTiming[this.id].slice(0));const y={dataType:"source"};this._collectResourceTiming&&g&&g.length>0&&o.e(y,{resourceTiming:g}),this.fire(new o.l("data",Object.assign(Object.assign({},y),{sourceDataType:"metadata"}))),this.fire(new o.l("data",Object.assign(Object.assign({},y),{sourceDataType:"content"})))}catch(f){if(this._pendingLoads--,this._removed)return void this.fire(new o.l("dataabort",{dataType:"source"}));this.fire(new o.k(f))}})}loaded(){return this._pendingLoads===0}loadTile(i){return o._(this,void 0,void 0,function*(){const l=i.actor?"RT":"LT";i.actor=this.actor;const f={type:this.type,uid:i.uid,tileID:i.tileID,zoom:i.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity,globalState:this.map.getGlobalState()};i.abortController=new AbortController;const g=yield this.actor.sendAsync({type:l,data:f},i.abortController);delete i.abortController,i.unloadVectorData(),i.aborted||i.loadVectorData(g,this.map.painter,l==="RT")})}abortTile(i){return o._(this,void 0,void 0,function*(){i.abortController&&(i.abortController.abort(),delete i.abortController),i.aborted=!0})}unloadTile(i){return o._(this,void 0,void 0,function*(){i.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:i.uid,type:this.type,source:this.id}})})}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return o.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}class Qt extends o.E{constructor(i,l,f,g){super(),this.flippedWindingOrder=!1,this.id=i,this.dispatcher=f,this.coordinates=l.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(g),this.options=l}load(i){return o._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new o.l("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const l=yield Ue.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,l&&l.data&&(this.image=l.data,i&&(this.coordinates=i),this._finishLoading())}catch(l){this._request=null,this._loaded=!0,this.fire(new o.k(l))}})}loaded(){return this._loaded}updateImage(i){return i.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=i.url,this.load(i.coordinates).finally(()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new o.l("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(i){this.map=i,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(i){this.coordinates=i;const l=i.map(o.a0.fromLngLat);var f;return this.tileID=function(g){const y=o.a1.fromPoints(g),x=y.width(),S=y.height(),I=Math.max(x,S),M=Math.max(0,Math.floor(-Math.log(I)/Math.LN2)),k=Math.pow(2,M);return new o.a3(M,Math.floor((y.minX+y.maxX)/2*k),Math.floor((y.minY+y.maxY)/2*k))}(l),this.terrainTileRanges=this._getOverlappingTileRanges(l),this.minzoom=this.maxzoom=this.tileID.z,this.tileCoords=l.map(g=>this.tileID.getTilePoint(g)._round()),this.flippedWindingOrder=((f=this.tileCoords)[1].x-f[0].x)*(f[2].y-f[0].y)-(f[1].y-f[0].y)*(f[2].x-f[0].x)<0,this.fire(new o.l("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const i=this.map.painter.context,l=i.gl;this.texture||(this.texture=new o.T(i,this.image,l.RGBA),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE));let f=!1;for(const g in this.tiles){const y=this.tiles[g];y.state!=="loaded"&&(y.state="loaded",y.texture=this.texture,f=!0)}f&&this.fire(new o.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(i){return o._(this,void 0,void 0,function*(){this.tileID&&this.tileID.equals(i.tileID.canonical)?(this.tiles[String(i.tileID.wrap)]=i,i.buckets={}):i.state="errored"})}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}_getOverlappingTileRanges(i){const{minX:l,minY:f,maxX:g,maxY:y}=o.a1.fromPoints(i),x={};for(let S=0;S<=o.a2;S++){const I=Math.pow(2,S),M=Math.floor(l*I),k=Math.floor(f*I),B=Math.floor(g*I),F=Math.floor(y*I);x[S]={minTileX:M,minTileY:k,maxTileX:B,maxTileY:F}}return x}}class Mi extends Qt{constructor(i,l,f,g){super(i,l,f,g),this.roundZoom=!0,this.type="video",this.options=l}load(){return o._(this,void 0,void 0,function*(){this._loaded=!1;const i=this.options;this.urls=[];for(const l of i.urls)this.urls.push(this.map._requestManager.transformRequest(l,"Source").url);try{const l=yield o.a4(this.urls);if(this._loaded=!0,!l)return;this.video=l,this.video.loop=!0,this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading()}catch(l){this.fire(new o.k(l))}})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(i){if(this.video){const l=this.video.seekable;i<l.start(0)||i>l.end(0)?this.fire(new o.k(new o.a5(`sources.${this.id}`,null,`Playback for this video can be set only between the ${l.start(0)} and ${l.end(0)}-second mark.`))):this.video.currentTime=i}}getVideo(){return this.video}onAdd(i){this.map||(this.map=i,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const i=this.map.painter.context,l=i.gl;this.texture?this.video.paused||(this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE),l.texSubImage2D(l.TEXTURE_2D,0,0,0,l.RGBA,l.UNSIGNED_BYTE,this.video)):(this.texture=new o.T(i,this.video,l.RGBA),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE));let f=!1;for(const g in this.tiles){const y=this.tiles[g];y.state!=="loaded"&&(y.state="loaded",y.texture=this.texture,f=!0)}f&&this.fire(new o.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class Ni extends Qt{constructor(i,l,f,g){super(i,l,f,g),l.coordinates?Array.isArray(l.coordinates)&&l.coordinates.length===4&&!l.coordinates.some(y=>!Array.isArray(y)||y.length!==2||y.some(x=>typeof x!="number"))||this.fire(new o.k(new o.a5(`sources.${i}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new o.k(new o.a5(`sources.${i}`,null,'missing required property "coordinates"'))),l.animate&&typeof l.animate!="boolean"&&this.fire(new o.k(new o.a5(`sources.${i}`,null,'optional "animate" property must be a boolean value'))),l.canvas?typeof l.canvas=="string"||l.canvas instanceof HTMLCanvasElement||this.fire(new o.k(new o.a5(`sources.${i}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new o.k(new o.a5(`sources.${i}`,null,'missing required property "canvas"'))),this.options=l,this.animate=l.animate===void 0||l.animate}load(){return o._(this,void 0,void 0,function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new o.k(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())})}getCanvas(){return this.canvas}onAdd(i){this.map=i,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let i=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,i=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,i=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const l=this.map.painter.context,f=l.gl;this.texture?(i||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new o.T(l,this.canvas,f.RGBA,{premultiply:!0});let g=!1;for(const y in this.tiles){const x=this.tiles[y];x.state!=="loaded"&&(x.state="loaded",x.texture=this.texture,g=!0)}g&&this.fire(new o.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const i of[this.canvas.width,this.canvas.height])if(isNaN(i)||i<=0)return!0;return!1}}const Ri={},en=_=>{switch(_){case"geojson":return Ct;case"image":return Qt;case"raster":return $t;case"raster-dem":return hr;case"vector":return Gt;case"video":return Mi;case"canvas":return Ni}return Ri[_]},Sr="RTLPluginLoaded";class oi extends o.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=ri()}_syncState(i){return this.status=i,this.dispatcher.broadcast("SRPS",{pluginStatus:i,pluginURL:this.url}).catch(l=>{throw this.status="error",l})}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(i){return o._(this,arguments,void 0,function*(l,f=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=$.resolveURL(l),!this.url)throw new Error(`requested url ${l} is invalid`);if(this.status==="unavailable"){if(!f)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()})}_requestImport(){return o._(this,void 0,void 0,function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new o.l(Sr))})}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let _r=null;function yr(){return _r||(_r=new oi),_r}class Yr{constructor(i,l){this.timeAdded=0,this.fadeEndTime=0,this.tileID=i,this.uid=o.a6(),this.uses=0,this.tileSize=l,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(i){const l=i+this.timeAdded;l<this.fadeEndTime||(this.fadeEndTime=l)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(i){this.demTexture&&i.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(i,l,f){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",i){i.featureIndex&&(this.latestFeatureIndex=i.featureIndex,i.rawTileData?(this.latestRawTileData=i.rawTileData,this.latestFeatureIndex.rawTileData=i.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=i.collisionBoxArray,this.buckets=function(g,y){const x={};if(!y)return x;for(const S of g){const I=S.layerIds.map(M=>y.getLayer(M)).filter(Boolean);if(I.length!==0){S.layers=I,S.stateDependentLayerIds&&(S.stateDependentLayers=S.stateDependentLayerIds.map(M=>I.filter(k=>k.id===M)[0]));for(const M of I)x[M.id]=S}}return x}(i.buckets,l?.style),this.hasSymbolBuckets=!1;for(const g in this.buckets){const y=this.buckets[g];if(y instanceof o.a8){if(this.hasSymbolBuckets=!0,!f)break;y.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const g in this.buckets){const y=this.buckets[g];if(y instanceof o.a8&&y.hasRTLText){this.hasRTLText=!0,yr().lazyLoad();break}}this.queryPadding=0;for(const g in this.buckets){const y=this.buckets[g];this.queryPadding=Math.max(this.queryPadding,l.style.getLayer(g).queryRadius(y))}i.imageAtlas&&(this.imageAtlas=i.imageAtlas),i.glyphAtlasImage&&(this.glyphAtlasImage=i.glyphAtlasImage)}else this.collisionBoxArray=new o.a7}unloadVectorData(){for(const i in this.buckets)this.buckets[i].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(i){return this.buckets[i.id]}upload(i){for(const f in this.buckets){const g=this.buckets[f];g.uploadPending()&&g.upload(i)}const l=i.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new o.T(i,this.imageAtlas.image,l.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new o.T(i,this.glyphAtlasImage,l.ALPHA),this.glyphAtlasImage=null)}prepare(i){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(i,this.imageAtlasTexture)}queryRenderedFeatures(i,l,f,g,y,x,S,I,M,k,B){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:g,cameraQueryGeometry:y,scale:x,tileSize:this.tileSize,pixelPosMatrix:k,transform:I,params:S,queryPadding:this.queryPadding*M,getElevation:B},i,l,f):{}}querySourceFeatures(i,l){const f=this.latestFeatureIndex;if(!f||!f.rawTileData)return;const g=f.loadVTLayers(),y=l&&l.sourceLayer?l.sourceLayer:"",x=g._geojsonTileLayer||g[y];if(!x)return;const S=o.a9(l&&l.filter),{z:I,x:M,y:k}=this.tileID.canonical,B={z:I,x:M,y:k};for(let F=0;F<x.length;F++){const N=x.feature(F);if(S.needGeometry){const G=o.aa(N,!0);if(!S.filter(new o.F(this.tileID.overscaledZ),G,this.tileID.canonical))continue}else if(!S.filter(new o.F(this.tileID.overscaledZ),N))continue;const W=f.getId(N,y),J=new o.ab(N,I,M,k,W);J.tile=B,i.push(J)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(i){const l=this.expirationTime;if(i.cacheControl){const f=o.ac(i.cacheControl);f["max-age"]&&(this.expirationTime=Date.now()+1e3*f["max-age"])}else i.expires&&(this.expirationTime=new Date(i.expires).getTime());if(this.expirationTime){const f=Date.now();let g=!1;if(this.expirationTime>f)g=!1;else if(l)if(this.expirationTime<l)g=!0;else{const y=this.expirationTime-l;y?this.expirationTime=f+Math.max(y,3e4):g=!0}else g=!0;g?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(i,l){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(i).length===0)return;const f=this.latestFeatureIndex.loadVTLayers();for(const g in this.buckets){if(!l.style.hasLayer(g))continue;const y=this.buckets[g],x=y.layers[0].sourceLayer||"_geojsonTileLayer",S=f[x],I=i[x];if(!S||!I||Object.keys(I).length===0)continue;y.update(I,S,this.imageAtlas&&this.imageAtlas.patternPositions||{});const M=l&&l.style&&l.style.getLayer(g);M&&(this.queryPadding=Math.max(this.queryPadding,M.queryRadius(y)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<$.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(i){this.symbolFadeHoldUntil=$.now()+i}setDependencies(i,l){const f={};for(const g of l)f[g]=!0;this.dependencies[i]=f}hasDependency(i,l){for(const f of i){const g=this.dependencies[f];if(g){for(const y of l)if(g[y])return!0}}return!1}}class zn{constructor(i,l){this.max=i,this.onRemove=l,this.reset()}reset(){for(const i in this.data)for(const l of this.data[i])l.timeout&&clearTimeout(l.timeout),this.onRemove(l.value);return this.data={},this.order=[],this}add(i,l,f){const g=i.wrapped().key;this.data[g]===void 0&&(this.data[g]=[]);const y={value:l,timeout:void 0};if(f!==void 0&&(y.timeout=setTimeout(()=>{this.remove(i,y)},f)),this.data[g].push(y),this.order.push(g),this.order.length>this.max){const x=this._getAndRemoveByKey(this.order[0]);x&&this.onRemove(x)}return this}has(i){return i.wrapped().key in this.data}getAndRemove(i){return this.has(i)?this._getAndRemoveByKey(i.wrapped().key):null}_getAndRemoveByKey(i){const l=this.data[i].shift();return l.timeout&&clearTimeout(l.timeout),this.data[i].length===0&&delete this.data[i],this.order.splice(this.order.indexOf(i),1),l.value}getByKey(i){const l=this.data[i];return l?l[0].value:null}get(i){return this.has(i)?this.data[i.wrapped().key][0].value:null}remove(i,l){if(!this.has(i))return this;const f=i.wrapped().key,g=l===void 0?0:this.data[f].indexOf(l),y=this.data[f][g];return this.data[f].splice(g,1),y.timeout&&clearTimeout(y.timeout),this.data[f].length===0&&delete this.data[f],this.onRemove(y.value),this.order.splice(this.order.indexOf(f),1),this}setMaxSize(i){for(this.max=i;this.order.length>this.max;){const l=this._getAndRemoveByKey(this.order[0]);l&&this.onRemove(l)}return this}filter(i){const l=[];for(const f in this.data)for(const g of this.data[f])i(g.value)||l.push(g);for(const f of l)this.remove(f.value.tileID,f)}}class As{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(i,l,f){const g=String(l);if(this.stateChanges[i]=this.stateChanges[i]||{},this.stateChanges[i][g]=this.stateChanges[i][g]||{},o.e(this.stateChanges[i][g],f),this.deletedStates[i]===null){this.deletedStates[i]={};for(const y in this.state[i])y!==g&&(this.deletedStates[i][y]=null)}else if(this.deletedStates[i]&&this.deletedStates[i][g]===null){this.deletedStates[i][g]={};for(const y in this.state[i][g])f[y]||(this.deletedStates[i][g][y]=null)}else for(const y in f)this.deletedStates[i]&&this.deletedStates[i][g]&&this.deletedStates[i][g][y]===null&&delete this.deletedStates[i][g][y]}removeFeatureState(i,l,f){if(this.deletedStates[i]===null)return;const g=String(l);if(this.deletedStates[i]=this.deletedStates[i]||{},f&&l!==void 0)this.deletedStates[i][g]!==null&&(this.deletedStates[i][g]=this.deletedStates[i][g]||{},this.deletedStates[i][g][f]=null);else if(l!==void 0)if(this.stateChanges[i]&&this.stateChanges[i][g])for(f in this.deletedStates[i][g]={},this.stateChanges[i][g])this.deletedStates[i][g][f]=null;else this.deletedStates[i][g]=null;else this.deletedStates[i]=null}getState(i,l){const f=String(l),g=o.e({},(this.state[i]||{})[f],(this.stateChanges[i]||{})[f]);if(this.deletedStates[i]===null)return{};if(this.deletedStates[i]){const y=this.deletedStates[i][l];if(y===null)return{};for(const x in y)delete g[x]}return g}initializeTileState(i,l){i.setFeatureState(this.state,l)}coalesceChanges(i,l){const f={};for(const g in this.stateChanges){this.state[g]=this.state[g]||{};const y={};for(const x in this.stateChanges[g])this.state[g][x]||(this.state[g][x]={}),o.e(this.state[g][x],this.stateChanges[g][x]),y[x]=this.state[g][x];f[g]=y}for(const g in this.deletedStates){this.state[g]=this.state[g]||{};const y={};if(this.deletedStates[g]===null)for(const x in this.state[g])y[x]={},this.state[g][x]={};else for(const x in this.deletedStates[g]){if(this.deletedStates[g][x]===null)this.state[g][x]={};else for(const S of Object.keys(this.deletedStates[g][x]))delete this.state[g][x][S];y[x]=this.state[g][x]}f[g]=f[g]||{},o.e(f[g],y)}if(this.stateChanges={},this.deletedStates={},Object.keys(f).length!==0)for(const g in i)i[g].setFeatureState(f,l)}}const ki=89.25;function be(_,i){const l=o.ag(i.lat,-o.ah,o.ah);return new o.P(o.V(i.lng)*_,o.U(l)*_)}function Z(_,i){return new o.a0(i.x/_,i.y/_).toLngLat()}function X(_){return _.cameraToCenterDistance*Math.min(.85*Math.tan(o.ad(90-_.pitch)),Math.tan(o.ad(ki-_.pitch)))}function K(_,i){const l=_.canonical,f=i/o.ae(l.z),g=l.x+Math.pow(2,l.z)*_.wrap,y=o.af(new Float64Array(16));return o.M(y,y,[g*f,l.y*f,0]),o.N(y,y,[f/o.$,f/o.$,1]),y}function ce(_,i,l,f,g){const y=o.a0.fromLngLat(_,i),x=g*o.ai(1,_.lat),S=x*Math.cos(o.ad(l)),I=Math.sqrt(x*x-S*S),M=I*Math.sin(o.ad(-f)),k=I*Math.cos(o.ad(-f));return new o.a0(y.x+M,y.y+k,y.z+S)}function pe(_,i,l){const f=i.intersectsFrustum(_);if(!l||f===0)return f;const g=i.intersectsPlane(l);return g===0?0:f===2&&g===2?2:1}function xe(_,i,l){let f=0;const g=(l-i)/10;for(let y=0;y<10;y++)f+=g*Math.pow(Math.cos(i+(y+.5)/10*(l-i)),_);return f}function De(_,i){return function(l,f,g,y,x){const S=2*((_-1)/o.aj(Math.cos(o.ad(ki-x))/Math.cos(o.ad(ki)))-1),I=Math.acos(g/y),M=2*xe(S-1,0,o.ad(x/2)),k=Math.min(o.ad(ki),I+o.ad(x/2)),B=xe(S-1,Math.min(k,I-o.ad(x/2)),k),F=Math.atan(f/g),N=Math.hypot(f,g);let W=l;return W+=o.aj(y/N/Math.max(.5,Math.cos(o.ad(x/2)))),W+=S*o.aj(Math.cos(F))/2,W-=o.aj(Math.max(1,B/M/i))/2,W}}const ve=De(9.314,3);function $e(_,i){const l=(i.roundZoom?Math.round:Math.floor)(_.zoom+o.aj(_.tileSize/i.tileSize));return Math.max(0,l)}function Ne(_,i){const l=_.getCameraFrustum(),f=_.getClippingPlane(),g=_.screenPointToMercatorCoordinate(_.getCameraPoint()),y=o.a0.fromLngLat(_.center,_.elevation);g.z=y.z+Math.cos(_.pitchInRadians)*_.cameraToCenterDistance/_.worldSize;const x=_.getCoveringTilesDetailsProvider(),S=x.allowVariableZoom(_,i),I=$e(_,i),M=i.minzoom||0,k=i.maxzoom!==void 0?i.maxzoom:_.maxZoom,B=Math.min(Math.max(0,I),k),F=Math.pow(2,B),N=[F*g.x,F*g.y,0],W=[F*y.x,F*y.y,0],J=Math.hypot(y.x-g.x,y.y-g.y),G=Math.abs(y.z-g.z),Q=Math.hypot(J,G),re=ue=>({zoom:0,x:0,y:0,wrap:ue,fullyVisible:!1}),ae=[],se=[];if(_.renderWorldCopies&&x.allowWorldCopies())for(let ue=1;ue<=3;ue++)ae.push(re(-ue)),ae.push(re(ue));for(ae.push(re(0));ae.length>0;){const ue=ae.pop(),de=ue.x,oe=ue.y;let ye=ue.fullyVisible;const Oe={x:de,y:oe,z:ue.zoom},Ce=x.getTileBoundingVolume(Oe,ue.wrap,_.elevation,i);if(!ye){const it=pe(l,Ce,f);if(it===0)continue;ye=it===2}const Me=x.distanceToTile2d(g.x,g.y,Oe,Ce);let Fe=I;S&&(Fe=(i.calculateTileZoom||ve)(_.zoom+o.aj(_.tileSize/i.tileSize),Me,G,Q,_.fov)),Fe=(i.roundZoom?Math.round:Math.floor)(Fe),Fe=Math.max(0,Fe);const nt=Math.min(Fe,k);if(ue.wrap=x.getWrap(y,Oe,ue.wrap),ue.zoom>=nt){if(ue.zoom<M)continue;const it=B-ue.zoom,qe=N[0]-.5-(de<<it),ft=N[1]-.5-(oe<<it),Nt=i.reparseOverscaled?Math.max(ue.zoom,Fe):ue.zoom;se.push({tileID:new o.Z(ue.zoom===k?Nt:ue.zoom,ue.wrap,ue.zoom,de,oe),distanceSq:o.ak([W[0]-.5-de,W[1]-.5-oe]),tileDistanceToCamera:Math.sqrt(qe*qe+ft*ft)})}else for(let it=0;it<4;it++)ae.push({zoom:ue.zoom+1,x:(de<<1)+it%2,y:(oe<<1)+(it>>1),wrap:ue.wrap,fullyVisible:ye})}return se.sort((ue,de)=>ue.distanceSq-de.distanceSq).map(ue=>ue.tileID)}const Ee=o.a1.fromPoints([new o.P(0,0),new o.P(o.$,o.$)]);class He extends o.E{constructor(i,l,f){super(),this.id=i,this.dispatcher=f,this.on("data",g=>this._dataHandler(g)),this.on("dataloading",()=>{this._sourceErrored=!1}),this.on("error",()=>{this._sourceErrored=this._source.loaded()}),this._source=((g,y,x,S)=>{const I=new(en(y.type))(g,y,x,S);if(I.id!==g)throw new Error(`Expected Source id to be ${g} instead of ${I.id}`);return I})(i,l,f,this),this._tiles={},this._cache=new zn(0,g=>this._unloadTile(g)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new As,this._didEmitContent=!1,this._updated=!1}onAdd(i){this.map=i,this._maxTileCacheSize=i?i._maxTileCacheSize:null,this._maxTileCacheZoomLevels=i?i._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(i)}onRemove(i){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(i)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const i in this._tiles){const l=this._tiles[i];if(l.state!=="loaded"&&l.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const i=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,i&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(i,l,f){return o._(this,void 0,void 0,function*(){try{yield this._source.loadTile(i),this._tileLoaded(i,l,f)}catch(g){i.state="errored",g.status!==404?this._source.fire(new o.k(g,{tile:i})):this.update(this.transform,this.terrain)}})}_unloadTile(i){this._source.unloadTile&&this._source.unloadTile(i)}_abortTile(i){this._source.abortTile&&this._source.abortTile(i),this._source.fire(new o.l("dataabort",{tile:i,coord:i.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(i){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const l in this._tiles){const f=this._tiles[l];f.upload(i),f.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map(i=>i.tileID).sort(fe).map(i=>i.key)}getRenderableIds(i){const l=[];for(const f in this._tiles)this._isIdRenderable(f,i)&&l.push(this._tiles[f]);return i?l.sort((f,g)=>{const y=f.tileID,x=g.tileID,S=new o.P(y.canonical.x,y.canonical.y)._rotate(-this.transform.bearingInRadians),I=new o.P(x.canonical.x,x.canonical.y)._rotate(-this.transform.bearingInRadians);return y.overscaledZ-x.overscaledZ||I.y-S.y||I.x-S.x}).map(f=>f.tileID.key):l.map(f=>f.tileID).sort(fe).map(f=>f.key)}hasRenderableParent(i){const l=this.findLoadedParent(i,0);return!!l&&this._isIdRenderable(l.tileID.key)}_isIdRenderable(i,l){return this._tiles[i]&&this._tiles[i].hasData()&&!this._coveredTiles[i]&&(l||!this._tiles[i].holdingForFade())}reload(i){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const l in this._tiles)i?this._reloadTile(l,"expired"):this._tiles[l].state!=="errored"&&this._reloadTile(l,"reloading")}}_reloadTile(i,l){return o._(this,void 0,void 0,function*(){const f=this._tiles[i];f&&(f.state!=="loading"&&(f.state=l),yield this._loadTile(f,i,l))})}_tileLoaded(i,l,f){i.timeAdded=$.now(),f==="expired"&&(i.refreshedUponExpiration=!0),this._setTileReloadTimer(l,i),this.getSource().type==="raster-dem"&&i.dem&&this._backfillDEM(i),this._state.initializeTileState(i,this.map?this.map.painter:null),i.aborted||this._source.fire(new o.l("data",{dataType:"source",tile:i,coord:i.tileID}))}_backfillDEM(i){const l=this.getRenderableIds();for(let g=0;g<l.length;g++){const y=l[g];if(i.neighboringTiles&&i.neighboringTiles[y]){const x=this.getTileByID(y);f(i,x),f(x,i)}}function f(g,y){g.needsHillshadePrepare=!0,g.needsTerrainPrepare=!0;let x=y.tileID.canonical.x-g.tileID.canonical.x;const S=y.tileID.canonical.y-g.tileID.canonical.y,I=Math.pow(2,g.tileID.canonical.z),M=y.tileID.key;x===0&&S===0||Math.abs(S)>1||(Math.abs(x)>1&&(Math.abs(x+I)===1?x+=I:Math.abs(x-I)===1&&(x-=I)),y.dem&&g.dem&&(g.dem.backfillBorder(y.dem,x,S),g.neighboringTiles&&g.neighboringTiles[M]&&(g.neighboringTiles[M].backfilled=!0)))}}getTile(i){return this.getTileByID(i.key)}getTileByID(i){return this._tiles[i]}_retainLoadedChildren(i,l,f,g){for(const y in this._tiles){let x=this._tiles[y];if(g[y]||!x.hasData()||x.tileID.overscaledZ<=l||x.tileID.overscaledZ>f)continue;let S=x.tileID;for(;x&&x.tileID.overscaledZ>l+1;){const M=x.tileID.scaledTo(x.tileID.overscaledZ-1);x=this._tiles[M.key],x&&x.hasData()&&(S=M)}let I=S;for(;I.overscaledZ>l;)if(I=I.scaledTo(I.overscaledZ-1),i[I.key]||i[I.canonical.key]){g[S.key]=S;break}}}findLoadedParent(i,l){if(i.key in this._loadedParentTiles){const f=this._loadedParentTiles[i.key];return f&&f.tileID.overscaledZ>=l?f:null}for(let f=i.overscaledZ-1;f>=l;f--){const g=i.scaledTo(f),y=this._getLoadedTile(g);if(y)return y}}findLoadedSibling(i){return this._getLoadedTile(i)}_getLoadedTile(i){const l=this._tiles[i.key];return l&&l.hasData()?l:this._cache.getByKey(i.wrapped().key)}updateCacheSize(i){const l=Math.ceil(i.width/this._source.tileSize)+1,f=Math.ceil(i.height/this._source.tileSize)+1,g=Math.floor(l*f*(this._maxTileCacheZoomLevels===null?o.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),y=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,g):g;this._cache.setMaxSize(y)}handleWrapJump(i){const l=Math.round((i-(this._prevLng===void 0?i:this._prevLng))/360);if(this._prevLng=i,l){const f={};for(const g in this._tiles){const y=this._tiles[g];y.tileID=y.tileID.unwrapTo(y.tileID.wrap+l),f[y.tileID.key]=y}this._tiles=f;for(const g in this._timers)clearTimeout(this._timers[g]),delete this._timers[g];for(const g in this._tiles)this._setTileReloadTimer(g,this._tiles[g])}}_updateCoveredAndRetainedTiles(i,l,f,g,y,x){const S={},I={},M=Object.keys(i),k=$.now();for(const B of M){const F=i[B],N=this._tiles[B];if(!N||N.fadeEndTime!==0&&N.fadeEndTime<=k)continue;const W=this.findLoadedParent(F,l),J=this.findLoadedSibling(F),G=W||J||null;G&&(this._addTile(G.tileID),S[G.tileID.key]=G.tileID),I[B]=F}this._retainLoadedChildren(I,g,f,i);for(const B in S)i[B]||(this._coveredTiles[B]=!0,i[B]=S[B]);if(x){const B={},F={};for(const N of y)this._tiles[N.key].hasData()?B[N.key]=N:F[N.key]=N;for(const N in F){const W=F[N].children(this._source.maxzoom);this._tiles[W[0].key]&&this._tiles[W[1].key]&&this._tiles[W[2].key]&&this._tiles[W[3].key]&&(B[W[0].key]=i[W[0].key]=W[0],B[W[1].key]=i[W[1].key]=W[1],B[W[2].key]=i[W[2].key]=W[2],B[W[3].key]=i[W[3].key]=W[3],delete F[N])}for(const N in F){const W=F[N],J=this.findLoadedParent(W,this._source.minzoom),G=this.findLoadedSibling(W),Q=J||G||null;if(Q){B[Q.tileID.key]=i[Q.tileID.key]=Q.tileID;for(const re in B)B[re].isChildOf(Q.tileID)&&delete B[re]}}for(const N in this._tiles)B[N]||(this._coveredTiles[N]=!0)}}update(i,l){if(!this._sourceLoaded||this._paused)return;let f;this.transform=i,this.terrain=l,this.updateCacheSize(i),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?f=i.getVisibleUnwrappedCoordinates(this._source.tileID).map(k=>new o.Z(k.canonical.z,k.wrap,k.canonical.z,k.canonical.x,k.canonical.y)):(f=Ne(i,{tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:l,calculateTileZoom:this._source.calculateTileZoom}),this._source.hasTile&&(f=f.filter(k=>this._source.hasTile(k)))):f=[];const g=$e(i,this._source),y=Math.max(g-He.maxOverzooming,this._source.minzoom),x=Math.max(g+He.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const k={};for(const B of f)if(B.canonical.z>this._source.minzoom){const F=B.scaledTo(B.canonical.z-1);k[F.key]=F;const N=B.scaledTo(Math.max(this._source.minzoom,Math.min(B.canonical.z,5)));k[N.key]=N}f=f.concat(Object.values(k))}const S=f.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,S&&this.fire(new o.l("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const I=this._updateRetainedTiles(f,g);lt(this._source.type)&&this._updateCoveredAndRetainedTiles(I,y,x,g,f,l);for(const k in I)this._tiles[k].clearFadeHold();const M=o.al(this._tiles,I);for(const k of M){const B=this._tiles[k];B.hasSymbolBuckets&&!B.holdingForFade()?B.setHoldDuration(this.map._fadeDuration):B.hasSymbolBuckets&&!B.symbolFadeFinished()||this._removeTile(k)}this._updateLoadedParentTileCache(),this._updateLoadedSiblingTileCache()}releaseSymbolFadeTiles(){for(const i in this._tiles)this._tiles[i].holdingForFade()&&this._removeTile(i)}_updateRetainedTiles(i,l){var f;const g={},y={},x=Math.max(l-He.maxOverzooming,this._source.minzoom),S=Math.max(l+He.maxUnderzooming,this._source.minzoom),I={};for(const M of i){const k=this._addTile(M);g[M.key]=M,k.hasData()||l<this._source.maxzoom&&(I[M.key]=M)}this._retainLoadedChildren(I,l,S,g);for(const M of i){let k=this._tiles[M.key];if(k.hasData())continue;if(l+1>this._source.maxzoom){const F=M.children(this._source.maxzoom)[0],N=this.getTile(F);if(N&&N.hasData()){g[F.key]=F;continue}}else{const F=M.children(this._source.maxzoom);if(g[F[0].key]&&g[F[1].key]&&g[F[2].key]&&g[F[3].key])continue}let B=k.wasRequested();for(let F=M.overscaledZ-1;F>=x;--F){const N=M.scaledTo(F);if(y[N.key])break;if(y[N.key]=!0,k=this.getTile(N),!k&&B&&(k=this._addTile(N)),k){const W=k.hasData();if((W||!(!((f=this.map)===null||f===void 0)&&f.cancelPendingTileRequestsWhileZooming)||B)&&(g[N.key]=N),B=k.wasRequested(),W)break}}}return g}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const i in this._tiles){const l=[];let f,g=this._tiles[i].tileID;for(;g.overscaledZ>0;){if(g.key in this._loadedParentTiles){f=this._loadedParentTiles[g.key];break}l.push(g.key);const y=g.scaledTo(g.overscaledZ-1);if(f=this._getLoadedTile(y),f)break;g=y}for(const y of l)this._loadedParentTiles[y]=f}}_updateLoadedSiblingTileCache(){this._loadedSiblingTiles={};for(const i in this._tiles){const l=this._tiles[i].tileID,f=this._getLoadedTile(l);this._loadedSiblingTiles[l.key]=f}}_addTile(i){let l=this._tiles[i.key];if(l)return l;l=this._cache.getAndRemove(i),l&&(this._setTileReloadTimer(i.key,l),l.tileID=i,this._state.initializeTileState(l,this.map?this.map.painter:null),this._cacheTimers[i.key]&&(clearTimeout(this._cacheTimers[i.key]),delete this._cacheTimers[i.key],this._setTileReloadTimer(i.key,l)));const f=l;return l||(l=new Yr(i,this._source.tileSize*i.overscaleFactor()),this._loadTile(l,i.key,l.state)),l.uses++,this._tiles[i.key]=l,f||this._source.fire(new o.l("dataloading",{tile:l,coord:l.tileID,dataType:"source"})),l}_setTileReloadTimer(i,l){i in this._timers&&(clearTimeout(this._timers[i]),delete this._timers[i]);const f=l.getExpiryTimeout();f&&(this._timers[i]=setTimeout(()=>{this._reloadTile(i,"expired"),delete this._timers[i]},f))}refreshTiles(i){for(const l in this._tiles)(this._isIdRenderable(l)||this._tiles[l].state=="errored")&&i.some(f=>f.equals(this._tiles[l].tileID.canonical))&&this._reloadTile(l,"expired")}_removeTile(i){const l=this._tiles[i];l&&(l.uses--,delete this._tiles[i],this._timers[i]&&(clearTimeout(this._timers[i]),delete this._timers[i]),l.uses>0||(l.hasData()&&l.state!=="reloading"?this._cache.add(l.tileID,l,l.getExpiryTimeout()):(l.aborted=!0,this._abortTile(l),this._unloadTile(l))))}_dataHandler(i){const l=i.sourceDataType;i.dataType==="source"&&l==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&i.dataType==="source"&&l==="content"&&(this.reload(i.sourceDataChanged),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const i in this._tiles)this._removeTile(i);this._cache.reset()}tilesIn(i,l,f){const g=[],y=this.transform;if(!y)return g;const x=y.getCoveringTilesDetailsProvider().allowWorldCopies(),S=f?y.getCameraQueryGeometry(i):i,I=N=>y.screenPointToMercatorCoordinate(N,this.terrain),M=this.transformBbox(i,I,!x),k=this.transformBbox(S,I,!x),B=this.getIds(),F=o.a1.fromPoints(k);for(let N=0;N<B.length;N++){const W=this._tiles[B[N]];if(W.holdingForFade())continue;const J=x?[W.tileID]:[W.tileID.unwrapTo(-1),W.tileID.unwrapTo(0)],G=Math.pow(2,y.zoom-W.tileID.overscaledZ),Q=l*W.queryPadding*o.$/W.tileSize/G;for(const re of J){const ae=F.map(se=>re.getTilePoint(new o.a0(se.x,se.y)));if(ae.expandBy(Q),ae.intersects(Ee)){const se=M.map(de=>re.getTilePoint(de)),ue=k.map(de=>re.getTilePoint(de));g.push({tile:W,tileID:x?re:re.unwrapTo(0),queryGeometry:se,cameraQueryGeometry:ue,scale:G})}}}return g}transformBbox(i,l,f){let g=i.map(l);if(f){const y=o.a1.fromPoints(i);y.shrinkBy(.001*Math.min(y.width(),y.height()));const x=y.map(l);o.a1.fromPoints(g).covers(x)||(g=g.map(S=>S.x>.5?new o.a0(S.x-1,S.y,S.z):S))}return g}getVisibleCoordinates(i){const l=this.getRenderableIds(i).map(f=>this._tiles[f].tileID);return this.transform&&this.transform.populateCache(l),l}hasTransition(){if(this._source.hasTransition())return!0;if(lt(this._source.type)){const i=$.now();for(const l in this._tiles)if(this._tiles[l].fadeEndTime>=i)return!0}return!1}setFeatureState(i,l,f){this._state.updateState(i=i||"_geojsonTileLayer",l,f)}removeFeatureState(i,l,f){this._state.removeFeatureState(i=i||"_geojsonTileLayer",l,f)}getFeatureState(i,l){return this._state.getState(i=i||"_geojsonTileLayer",l)}setDependencies(i,l,f){const g=this._tiles[i];g&&g.setDependencies(l,f)}reloadTilesForDependencies(i,l){for(const f in this._tiles)this._tiles[f].hasDependency(i,l)&&this._reloadTile(f,"reloading");this._cache.filter(f=>!f.hasDependency(i,l))}}function fe(_,i){const l=Math.abs(2*_.wrap)-+(_.wrap<0),f=Math.abs(2*i.wrap)-+(i.wrap<0);return _.overscaledZ-i.overscaledZ||f-l||i.canonical.y-_.canonical.y||i.canonical.x-_.canonical.x}function lt(_){return _==="raster"||_==="image"||_==="video"}He.maxOverzooming=10,He.maxUnderzooming=3;class Et{constructor(i,l){this.reset(i,l)}reset(i,l){this.points=i||[],this._distances=[0];for(let f=1;f<this.points.length;f++)this._distances[f]=this._distances[f-1]+this.points[f].dist(this.points[f-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(l||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(i){if(this.points.length===1)return this.points[0];i=o.ag(i,0,1);let l=1,f=this._distances[l];const g=i*this.paddedLength+this.padding;for(;f<g&&l<this._distances.length;)f=this._distances[++l];const y=l-1,x=this._distances[y],S=f-x,I=S>0?(g-x)/S:0;return this.points[y].mult(1-I).add(this.points[l].mult(I))}}function ut(_,i){let l=!0;return _==="always"||_!=="never"&&i!=="never"||(l=!1),l}class vt{constructor(i,l,f){const g=this.boxCells=[],y=this.circleCells=[];this.xCellCount=Math.ceil(i/f),this.yCellCount=Math.ceil(l/f);for(let x=0;x<this.xCellCount*this.yCellCount;x++)g.push([]),y.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=i,this.height=l,this.xScale=this.xCellCount/i,this.yScale=this.yCellCount/l,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(i,l,f,g,y){this._forEachCell(l,f,g,y,this._insertBoxCell,this.boxUid++),this.boxKeys.push(i),this.bboxes.push(l),this.bboxes.push(f),this.bboxes.push(g),this.bboxes.push(y)}insertCircle(i,l,f,g){this._forEachCell(l-g,f-g,l+g,f+g,this._insertCircleCell,this.circleUid++),this.circleKeys.push(i),this.circles.push(l),this.circles.push(f),this.circles.push(g)}_insertBoxCell(i,l,f,g,y,x){this.boxCells[y].push(x)}_insertCircleCell(i,l,f,g,y,x){this.circleCells[y].push(x)}_query(i,l,f,g,y,x,S){if(f<0||i>this.width||g<0||l>this.height)return[];const I=[];if(i<=0&&l<=0&&this.width<=f&&this.height<=g){if(y)return[{key:null,x1:i,y1:l,x2:f,y2:g}];for(let M=0;M<this.boxKeys.length;M++)I.push({key:this.boxKeys[M],x1:this.bboxes[4*M],y1:this.bboxes[4*M+1],x2:this.bboxes[4*M+2],y2:this.bboxes[4*M+3]});for(let M=0;M<this.circleKeys.length;M++){const k=this.circles[3*M],B=this.circles[3*M+1],F=this.circles[3*M+2];I.push({key:this.circleKeys[M],x1:k-F,y1:B-F,x2:k+F,y2:B+F})}}else this._forEachCell(i,l,f,g,this._queryCell,I,{hitTest:y,overlapMode:x,seenUids:{box:{},circle:{}}},S);return I}query(i,l,f,g){return this._query(i,l,f,g,!1,null)}hitTest(i,l,f,g,y,x){return this._query(i,l,f,g,!0,y,x).length>0}hitTestCircle(i,l,f,g,y){const x=i-f,S=i+f,I=l-f,M=l+f;if(S<0||x>this.width||M<0||I>this.height)return!1;const k=[];return this._forEachCell(x,I,S,M,this._queryCellCircle,k,{hitTest:!0,overlapMode:g,circle:{x:i,y:l,radius:f},seenUids:{box:{},circle:{}}},y),k.length>0}_queryCell(i,l,f,g,y,x,S,I){const{seenUids:M,hitTest:k,overlapMode:B}=S,F=this.boxCells[y];if(F!==null){const W=this.bboxes;for(const J of F)if(!M.box[J]){M.box[J]=!0;const G=4*J,Q=this.boxKeys[J];if(i<=W[G+2]&&l<=W[G+3]&&f>=W[G+0]&&g>=W[G+1]&&(!I||I(Q))&&(!k||!ut(B,Q.overlapMode))&&(x.push({key:Q,x1:W[G],y1:W[G+1],x2:W[G+2],y2:W[G+3]}),k))return!0}}const N=this.circleCells[y];if(N!==null){const W=this.circles;for(const J of N)if(!M.circle[J]){M.circle[J]=!0;const G=3*J,Q=this.circleKeys[J];if(this._circleAndRectCollide(W[G],W[G+1],W[G+2],i,l,f,g)&&(!I||I(Q))&&(!k||!ut(B,Q.overlapMode))){const re=W[G],ae=W[G+1],se=W[G+2];if(x.push({key:Q,x1:re-se,y1:ae-se,x2:re+se,y2:ae+se}),k)return!0}}}return!1}_queryCellCircle(i,l,f,g,y,x,S,I){const{circle:M,seenUids:k,overlapMode:B}=S,F=this.boxCells[y];if(F!==null){const W=this.bboxes;for(const J of F)if(!k.box[J]){k.box[J]=!0;const G=4*J,Q=this.boxKeys[J];if(this._circleAndRectCollide(M.x,M.y,M.radius,W[G+0],W[G+1],W[G+2],W[G+3])&&(!I||I(Q))&&!ut(B,Q.overlapMode))return x.push(!0),!0}}const N=this.circleCells[y];if(N!==null){const W=this.circles;for(const J of N)if(!k.circle[J]){k.circle[J]=!0;const G=3*J,Q=this.circleKeys[J];if(this._circlesCollide(W[G],W[G+1],W[G+2],M.x,M.y,M.radius)&&(!I||I(Q))&&!ut(B,Q.overlapMode))return x.push(!0),!0}}}_forEachCell(i,l,f,g,y,x,S,I){const M=this._convertToXCellCoord(i),k=this._convertToYCellCoord(l),B=this._convertToXCellCoord(f),F=this._convertToYCellCoord(g);for(let N=M;N<=B;N++)for(let W=k;W<=F;W++)if(y.call(this,i,l,f,g,this.xCellCount*W+N,x,S,I))return}_convertToXCellCoord(i){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(i*this.xScale)))}_convertToYCellCoord(i){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(i*this.yScale)))}_circlesCollide(i,l,f,g,y,x){const S=g-i,I=y-l,M=f+x;return M*M>S*S+I*I}_circleAndRectCollide(i,l,f,g,y,x,S){const I=(x-g)/2,M=Math.abs(i-(g+I));if(M>I+f)return!1;const k=(S-y)/2,B=Math.abs(l-(y+k));if(B>k+f)return!1;if(M<=I||B<=k)return!0;const F=M-I,N=B-k;return F*F+N*N<=f*f}}function Dt(_,i,l){const f=o.L();if(!_){const{vecSouth:B,vecEast:F}=lr(i),N=E();N[0]=F[0],N[1]=F[1],N[2]=B[0],N[3]=B[1],g=N,(k=(x=(y=N)[0])*(M=y[3])-(I=y[2])*(S=y[1]))&&(g[0]=M*(k=1/k),g[1]=-S*k,g[2]=-I*k,g[3]=x*k),f[0]=N[0],f[1]=N[1],f[4]=N[2],f[5]=N[3]}var g,y,x,S,I,M,k;return o.N(f,f,[1/l,1/l,1]),f}function Tr(_,i,l,f){if(_){const g=o.L();if(!i){const{vecSouth:y,vecEast:x}=lr(l);g[0]=x[0],g[1]=x[1],g[4]=y[0],g[5]=y[1]}return o.N(g,g,[f,f,1]),g}return l.pixelsToClipSpaceMatrix}function lr(_){const i=Math.cos(_.rollInRadians),l=Math.sin(_.rollInRadians),f=Math.cos(_.pitchInRadians),g=Math.cos(_.bearingInRadians),y=Math.sin(_.bearingInRadians),x=o.aq();x[0]=-g*f*l-y*i,x[1]=-y*f*l+g*i;const S=o.ar(x);S<1e-9?o.as(x):o.at(x,x,1/S);const I=o.aq();I[0]=g*f*i-y*l,I[1]=y*f*i+g*l;const M=o.ar(I);return M<1e-9?o.as(I):o.at(I,I,1/M),{vecEast:I,vecSouth:x}}function ir(_,i,l,f){let g;f?(g=[_,i,f(_,i),1],o.av(g,g,l)):(g=[_,i,0,1],Is(g,g,l));const y=g[3];return{point:new o.P(g[0]/y,g[1]/y),signedDistanceFromCamera:y,isOccluded:!1}}function Mt(_,i){return .5+_/i*.5}function er(_,i){return _.x>=-i[0]&&_.x<=i[0]&&_.y>=-i[1]&&_.y<=i[1]}function ai(_,i,l,f,g,y,x,S,I,M,k,B,F){const N=l?_.textSizeData:_.iconSizeData,W=o.am(N,i.transform.zoom),J=[256/i.width*2+1,256/i.height*2+1],G=l?_.text.dynamicLayoutVertexArray:_.icon.dynamicLayoutVertexArray;G.clear();const Q=_.lineVertexArray,re=l?_.text.placedSymbolArray:_.icon.placedSymbolArray,ae=i.transform.width/i.transform.height;let se=!1;for(let ue=0;ue<re.length;ue++){const de=re.get(ue);if(de.hidden||de.writingMode===o.an.vertical&&!se){Un(de.numGlyphs,G);continue}se=!1;const oe=new o.P(de.anchorX,de.anchorY),ye={getElevation:F,pitchedLabelPlaneMatrix:f,lineVertexArray:Q,pitchWithMap:y,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:i.transform,tileAnchorPoint:oe,unwrappedTileID:I,width:M,height:k,translation:B},Oe=Vt(de.anchorX,de.anchorY,ye);if(!er(Oe.point,J)){Un(de.numGlyphs,G);continue}const Ce=Mt(i.transform.cameraToCenterDistance,Oe.signedDistanceFromCamera),Me=o.ao(N,W,de),Fe=y?Me*i.transform.getPitchedTextCorrection(de.anchorX,de.anchorY,I)/Ce:Me*Ce,nt=Dr({projectionContext:ye,pitchedLabelPlaneMatrixInverse:g,symbol:de,fontSize:Fe,flip:!1,keepUpright:x,glyphOffsetArray:_.glyphOffsetArray,dynamicLayoutVertexArray:G,aspectRatio:ae,rotateToLine:S});se=nt.useVertical,(nt.notEnoughRoom||se||nt.needsFlipping&&Dr({projectionContext:ye,pitchedLabelPlaneMatrixInverse:g,symbol:de,fontSize:Fe,flip:!0,keepUpright:x,glyphOffsetArray:_.glyphOffsetArray,dynamicLayoutVertexArray:G,aspectRatio:ae,rotateToLine:S}).notEnoughRoom)&&Un(de.numGlyphs,G)}l?_.text.dynamicLayoutVertexBuffer.updateData(G):_.icon.dynamicLayoutVertexBuffer.updateData(G)}function rt(_,i,l,f,g,y,x,S){const I=y.glyphStartIndex+y.numGlyphs,M=y.lineStartIndex,k=y.lineStartIndex+y.lineLength,B=i.getoffsetX(y.glyphStartIndex),F=i.getoffsetX(I-1),N=In(_*B,l,f,g,y.segment,M,k,S,x);if(!N)return null;const W=In(_*F,l,f,g,y.segment,M,k,S,x);return W?S.projectionCache.anyProjectionOccluded?null:{first:N,last:W}:null}function bi(_,i,l,f){return _===o.an.horizontal&&Math.abs(l.y-i.y)>Math.abs(l.x-i.x)*f?{useVertical:!0}:(_===o.an.vertical?i.y<l.y:i.x>l.x)?{needsFlipping:!0}:null}function Dr(_){const{projectionContext:i,pitchedLabelPlaneMatrixInverse:l,symbol:f,fontSize:g,flip:y,keepUpright:x,glyphOffsetArray:S,dynamicLayoutVertexArray:I,aspectRatio:M,rotateToLine:k}=_,B=g/24,F=f.lineOffsetX*B,N=f.lineOffsetY*B;let W;if(f.numGlyphs>1){const J=f.glyphStartIndex+f.numGlyphs,G=f.lineStartIndex,Q=f.lineStartIndex+f.lineLength,re=rt(B,S,F,N,y,f,k,i);if(!re)return{notEnoughRoom:!0};const ae=Ut(re.first.point.x,re.first.point.y,i,l),se=Ut(re.last.point.x,re.last.point.y,i,l);if(x&&!y){const ue=bi(f.writingMode,ae,se,M);if(ue)return ue}W=[re.first];for(let ue=f.glyphStartIndex+1;ue<J-1;ue++){const de=In(B*S.getoffsetX(ue),F,N,y,f.segment,G,Q,i,k);if(!de)return{notEnoughRoom:!0};W.push(de)}W.push(re.last)}else{if(x&&!y){const G=st(i.tileAnchorPoint.x,i.tileAnchorPoint.y,i).point,Q=f.lineStartIndex+f.segment+1,re=new o.P(i.lineVertexArray.getx(Q),i.lineVertexArray.gety(Q)),ae=st(re.x,re.y,i),se=ae.signedDistanceFromCamera>0?ae.point:ns(i.tileAnchorPoint,re,G,1,i),ue=Ut(G.x,G.y,i,l),de=Ut(se.x,se.y,i,l),oe=bi(f.writingMode,ue,de,M);if(oe)return oe}const J=In(B*S.getoffsetX(f.glyphStartIndex),F,N,y,f.segment,f.lineStartIndex,f.lineStartIndex+f.lineLength,i,k);if(!J||i.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};W=[J]}for(const J of W)o.au(I,J.point,J.angle);return{}}function ns(_,i,l,f,g){const y=_.add(_.sub(i)._unit()),x=st(y.x,y.y,g).point,S=l.sub(x);return l.add(S._mult(f/S.mag()))}function Es(_,i,l){const f=i.projectionCache;if(f.projections[_])return f.projections[_];const g=new o.P(i.lineVertexArray.getx(_),i.lineVertexArray.gety(_)),y=st(g.x,g.y,i);if(y.signedDistanceFromCamera>0)return f.projections[_]=y.point,f.anyProjectionOccluded=f.anyProjectionOccluded||y.isOccluded,y.point;const x=_-l.direction;return ns(l.distanceFromAnchor===0?i.tileAnchorPoint:new o.P(i.lineVertexArray.getx(x),i.lineVertexArray.gety(x)),g,l.previousVertex,l.absOffsetX-l.distanceFromAnchor+1,i)}function st(_,i,l){const f=_+l.translation[0],g=i+l.translation[1];let y;return l.pitchWithMap?(y=ir(f,g,l.pitchedLabelPlaneMatrix,l.getElevation),y.isOccluded=!1):(y=l.transform.projectTileCoordinates(f,g,l.unwrappedTileID,l.getElevation),y.point.x=(.5*y.point.x+.5)*l.width,y.point.y=(.5*-y.point.y+.5)*l.height),y}function Ut(_,i,l,f){if(l.pitchWithMap){const g=[_,i,0,1];return o.av(g,g,f),l.transform.projectTileCoordinates(g[0]/g[3],g[1]/g[3],l.unwrappedTileID,l.getElevation).point}return{x:_/l.width*2-1,y:1-i/l.height*2}}function Vt(_,i,l){return l.transform.projectTileCoordinates(_,i,l.unwrappedTileID,l.getElevation)}function tn(_,i,l){return _._unit()._perp()._mult(i*l)}function Wa(_,i,l,f,g,y,x,S,I){if(S.projectionCache.offsets[_])return S.projectionCache.offsets[_];const M=l.add(i);if(_+I.direction<f||_+I.direction>=g)return S.projectionCache.offsets[_]=M,M;const k=Es(_+I.direction,S,I),B=tn(k.sub(l),x,I.direction),F=l.add(B),N=k.add(B);return S.projectionCache.offsets[_]=o.aw(y,M,F,N)||M,S.projectionCache.offsets[_]}function In(_,i,l,f,g,y,x,S,I){const M=f?_-i:_+i;let k=M>0?1:-1,B=0;f&&(k*=-1,B=Math.PI),k<0&&(B+=Math.PI);let F,N=k>0?y+g:y+g+1;S.projectionCache.cachedAnchorPoint?F=S.projectionCache.cachedAnchorPoint:(F=st(S.tileAnchorPoint.x,S.tileAnchorPoint.y,S).point,S.projectionCache.cachedAnchorPoint=F);let W,J,G=F,Q=F,re=0,ae=0;const se=Math.abs(M),ue=[];let de;for(;re+ae<=se;){if(N+=k,N<y||N>=x)return null;re+=ae,Q=G,J=W;const Oe={absOffsetX:se,direction:k,distanceFromAnchor:re,previousVertex:Q};if(G=Es(N,S,Oe),l===0)ue.push(Q),de=G.sub(Q);else{let Ce;const Me=G.sub(Q);Ce=Me.mag()===0?tn(Es(N+k,S,Oe).sub(G),l,k):tn(Me,l,k),J||(J=Q.add(Ce)),W=Wa(N,Ce,G,y,x,J,l,S,Oe),ue.push(J),de=W.sub(J)}ae=de.mag()}const oe=de._mult((se-re)/ae)._add(J||Q),ye=B+Math.atan2(G.y-Q.y,G.x-Q.x);return ue.push(oe),{point:oe,angle:I?ye:0,path:ue}}const jt=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function Un(_,i){for(let l=0;l<_;l++){const f=i.length;i.resize(f+4),i.float32.set(jt,3*f)}}function Is(_,i,l){const f=i[0],g=i[1];return _[0]=l[0]*f+l[4]*g+l[12],_[1]=l[1]*f+l[5]*g+l[13],_[3]=l[3]*f+l[7]*g+l[15],_}const Xr=100;class Lo{constructor(i,l=new vt(i.width+200,i.height+200,25),f=new vt(i.width+200,i.height+200,25)){this.transform=i,this.grid=l,this.ignoredGrid=f,this.pitchFactor=Math.cos(i.pitch*Math.PI/180)*i.cameraToCenterDistance,this.screenRightBoundary=i.width+Xr,this.screenBottomBoundary=i.height+Xr,this.gridRightBoundary=i.width+200,this.gridBottomBoundary=i.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(i,l,f,g,y,x,S,I,M,k,B,F){const N=this.projectAndGetPerspectiveRatio(i.anchorPointX+I[0],i.anchorPointY+I[1],y,k,F),W=f*N.perspectiveRatio;let J;if(x||S)J=this._projectCollisionBox(i,W,g,y,x,S,I,N,k,B,F);else{const de=N.x+(B?B.x*W:0),oe=N.y+(B?B.y*W:0);J={allPointsOccluded:!1,box:[de+i.x1*W,oe+i.y1*W,de+i.x2*W,oe+i.y2*W]}}const[G,Q,re,ae]=J.box,se=x?J.allPointsOccluded:N.isOccluded;let ue=se;return ue||(ue=N.perspectiveRatio<this.perspectiveRatioCutoff),ue||(ue=!this.isInsideGrid(G,Q,re,ae)),ue||l!=="always"&&this.grid.hitTest(G,Q,re,ae,l,M)?{box:[G,Q,re,ae],placeable:!1,offscreen:!1,occluded:se}:{box:[G,Q,re,ae],placeable:!0,offscreen:this.isOffscreen(G,Q,re,ae),occluded:se}}placeCollisionCircles(i,l,f,g,y,x,S,I,M,k,B,F,N,W){const J=[],G=new o.P(l.anchorX,l.anchorY),Q=this.getPerspectiveRatio(G.x,G.y,x,W),re=(M?y*this.transform.getPitchedTextCorrection(l.anchorX,l.anchorY,x)/Q:y*Q)/o.aA,ae={getElevation:W,pitchedLabelPlaneMatrix:S,lineVertexArray:f,pitchWithMap:M,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:this.transform,tileAnchorPoint:G,unwrappedTileID:x,width:this.transform.width,height:this.transform.height,translation:N},se=rt(re,g,l.lineOffsetX*re,l.lineOffsetY*re,!1,l,!1,ae);let ue=!1,de=!1,oe=!0;if(se){const ye=.5*B*Q+F,Oe=new o.P(-100,-100),Ce=new o.P(this.screenRightBoundary,this.screenBottomBoundary),Me=new Et,Fe=se.first,nt=se.last;let it=[];for(let Nt=Fe.path.length-1;Nt>=1;Nt--)it.push(Fe.path[Nt]);for(let Nt=1;Nt<nt.path.length;Nt++)it.push(nt.path[Nt]);const qe=2.5*ye;if(M){const Nt=this.projectPathToScreenSpace(it,ae);it=Nt.some(sr=>sr.signedDistanceFromCamera<=0)?[]:Nt.map(sr=>sr.point)}let ft=[];if(it.length>0){const Nt=it[0].clone(),sr=it[0].clone();for(let Lr=1;Lr<it.length;Lr++)Nt.x=Math.min(Nt.x,it[Lr].x),Nt.y=Math.min(Nt.y,it[Lr].y),sr.x=Math.max(sr.x,it[Lr].x),sr.y=Math.max(sr.y,it[Lr].y);ft=Nt.x>=Oe.x&&sr.x<=Ce.x&&Nt.y>=Oe.y&&sr.y<=Ce.y?[it]:sr.x<Oe.x||Nt.x>Ce.x||sr.y<Oe.y||Nt.y>Ce.y?[]:o.ax([it],Oe.x,Oe.y,Ce.x,Ce.y)}for(const Nt of ft){Me.reset(Nt,.25*ye);let sr=0;sr=Me.length<=.5*ye?1:Math.ceil(Me.paddedLength/qe)+1;for(let Lr=0;Lr<sr;Lr++){const ur=Lr/Math.max(sr-1,1),Nr=Me.lerp(ur),br=Nr.x+Xr,dr=Nr.y+Xr;J.push(br,dr,ye,0);const vr=br-ye,xi=dr-ye,rr=br+ye,hi=dr+ye;if(oe=oe&&this.isOffscreen(vr,xi,rr,hi),de=de||this.isInsideGrid(vr,xi,rr,hi),i!=="always"&&this.grid.hitTestCircle(br,dr,ye,i,k)&&(ue=!0,!I))return{circles:[],offscreen:!1,collisionDetected:ue}}}}return{circles:!I&&ue||!de||Q<this.perspectiveRatioCutoff?[]:J,offscreen:oe,collisionDetected:ue}}projectPathToScreenSpace(i,l){const f=function(g,y){const x=o.L();return o.ap(x,y.pitchedLabelPlaneMatrix),g.map(S=>{const I=ir(S.x,S.y,x,y.getElevation),M=y.transform.projectTileCoordinates(I.point.x,I.point.y,y.unwrappedTileID,y.getElevation);return M.point.x=(.5*M.point.x+.5)*y.width,M.point.y=(.5*-M.point.y+.5)*y.height,M})}(i,l);return function(g){let y=0,x=0,S=0,I=0;for(let M=0;M<g.length;M++)g[M].isOccluded?(S=M+1,I=0):(I++,I>x&&(x=I,y=S));return g.slice(y,y+x)}(f)}queryRenderedSymbols(i){if(i.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const l=[],f=new o.a1;for(const B of i){const F=new o.P(B.x+Xr,B.y+Xr);f.extend(F),l.push(F)}const{minX:g,minY:y,maxX:x,maxY:S}=f,I=this.grid.query(g,y,x,S).concat(this.ignoredGrid.query(g,y,x,S)),M={},k={};for(const B of I){const F=B.key;if(M[F.bucketInstanceId]===void 0&&(M[F.bucketInstanceId]={}),M[F.bucketInstanceId][F.featureIndex])continue;const N=[new o.P(B.x1,B.y1),new o.P(B.x2,B.y1),new o.P(B.x2,B.y2),new o.P(B.x1,B.y2)];o.ay(l,N)&&(M[F.bucketInstanceId][F.featureIndex]=!0,k[F.bucketInstanceId]===void 0&&(k[F.bucketInstanceId]=[]),k[F.bucketInstanceId].push(F.featureIndex))}return k}insertCollisionBox(i,l,f,g,y,x){(f?this.ignoredGrid:this.grid).insert({bucketInstanceId:g,featureIndex:y,collisionGroupID:x,overlapMode:l},i[0],i[1],i[2],i[3])}insertCollisionCircles(i,l,f,g,y,x){const S=f?this.ignoredGrid:this.grid,I={bucketInstanceId:g,featureIndex:y,collisionGroupID:x,overlapMode:l};for(let M=0;M<i.length;M+=4)S.insertCircle(I,i[M],i[M+1],i[M+2])}projectAndGetPerspectiveRatio(i,l,f,g,y){if(y){let x;g?(x=[i,l,g(i,l),1],o.av(x,x,y)):(x=[i,l,0,1],Is(x,x,y));const S=x[3];return{x:(x[0]/S+1)/2*this.transform.width+Xr,y:(-x[1]/S+1)/2*this.transform.height+Xr,perspectiveRatio:.5+this.transform.cameraToCenterDistance/S*.5,isOccluded:!1,signedDistanceFromCamera:S}}{const x=this.transform.projectTileCoordinates(i,l,f,g);return{x:(x.point.x+1)/2*this.transform.width+Xr,y:(1-x.point.y)/2*this.transform.height+Xr,perspectiveRatio:.5+this.transform.cameraToCenterDistance/x.signedDistanceFromCamera*.5,isOccluded:x.isOccluded,signedDistanceFromCamera:x.signedDistanceFromCamera}}}getPerspectiveRatio(i,l,f,g){const y=this.transform.projectTileCoordinates(i,l,f,g);return .5+this.transform.cameraToCenterDistance/y.signedDistanceFromCamera*.5}isOffscreen(i,l,f,g){return f<Xr||i>=this.screenRightBoundary||g<Xr||l>this.screenBottomBoundary}isInsideGrid(i,l,f,g){return f>=0&&i<this.gridRightBoundary&&g>=0&&l<this.gridBottomBoundary}getViewportMatrix(){const i=o.af([]);return o.M(i,i,[-100,-100,0]),i}_projectCollisionBox(i,l,f,g,y,x,S,I,M,k,B){let F=1,N=0,W=0,J=1;const G=i.anchorPointX+S[0],Q=i.anchorPointY+S[1];if(x&&!y){const it=this.projectAndGetPerspectiveRatio(G+1,Q,g,M,B),qe=it.x-I.x,ft=Math.atan((it.y-I.y)/qe)+(qe<0?Math.PI:0),Nt=Math.sin(ft),sr=Math.cos(ft);F=sr,N=Nt,W=-Nt,J=sr}else if(!x&&y){const it=lr(this.transform);F=it.vecEast[0],N=it.vecEast[1],W=it.vecSouth[0],J=it.vecSouth[1]}let re=I.x,ae=I.y,se=l;y&&(re=G,ae=Q,se=Math.pow(2,-(this.transform.zoom-f.overscaledZ)),se*=this.transform.getPitchedTextCorrection(G,Q,g),k||(se*=o.ag(.5+I.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))),k&&(re+=F*k.x*se+W*k.y*se,ae+=N*k.x*se+J*k.y*se);const ue=i.x1*se,de=i.x2*se,oe=(ue+de)/2,ye=i.y1*se,Oe=i.y2*se,Ce=(ye+Oe)/2,Me=[{offsetX:ue,offsetY:ye},{offsetX:oe,offsetY:ye},{offsetX:de,offsetY:ye},{offsetX:de,offsetY:Ce},{offsetX:de,offsetY:Oe},{offsetX:oe,offsetY:Oe},{offsetX:ue,offsetY:Oe},{offsetX:ue,offsetY:Ce}];let Fe=[];for(const{offsetX:it,offsetY:qe}of Me)Fe.push(new o.P(re+F*it+W*qe,ae+N*it+J*qe));let nt=!1;if(y){const it=Fe.map(qe=>this.projectAndGetPerspectiveRatio(qe.x,qe.y,g,M,B));nt=it.some(qe=>!qe.isOccluded),Fe=it.map(qe=>new o.P(qe.x,qe.y))}else nt=!0;return{box:o.az(Fe),allPointsOccluded:!nt}}}class No{constructor(i,l,f,g){this.opacity=i?Math.max(0,Math.min(1,i.opacity+(i.placed?l:-l))):g&&f?1:0,this.placed=f}isHidden(){return this.opacity===0&&!this.placed}}class Vn{constructor(i,l,f,g,y){this.text=new No(i?i.text:null,l,f,y),this.icon=new No(i?i.icon:null,l,g,y)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class zo{constructor(i,l,f){this.text=i,this.icon=l,this.skipFade=f}}class rn{constructor(i,l,f,g,y){this.bucketInstanceId=i,this.featureIndex=l,this.sourceLayerIndex=f,this.bucketIndex=g,this.tileID=y}}class Or{constructor(i){this.crossSourceCollisions=i,this.maxGroupID=0,this.collisionGroups={}}get(i){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[i]){const l=++this.maxGroupID;this.collisionGroups[i]={ID:l,predicate:f=>f.collisionGroupID===l}}return this.collisionGroups[i]}}function iu(_,i,l,f,g){const{horizontalAlign:y,verticalAlign:x}=o.aG(_);return new o.P(-(y-.5)*i+f[0]*g,-(x-.5)*l+f[1]*g)}class Uo{constructor(i,l,f,g,y){this.transform=i.clone(),this.terrain=l,this.collisionIndex=new Lo(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=f,this.retainedQueryData={},this.collisionGroups=new Or(g),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=y,y&&(y.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(i){const l=this.terrain;return l?(f,g)=>l.getElevation(i,f,g):null}getBucketParts(i,l,f,g){const y=f.getBucket(l),x=f.latestFeatureIndex;if(!y||!x||l.id!==y.layerIds[0])return;const S=f.collisionBoxArray,I=y.layers[0].layout,M=y.layers[0].paint,k=Math.pow(2,this.transform.zoom-f.tileID.overscaledZ),B=f.tileSize/o.$,F=f.tileID.toUnwrapped(),N=I.get("text-rotation-alignment")==="map",W=o.aB(f,1,this.transform.zoom),J=o.aC(this.collisionIndex.transform,f,M.get("text-translate"),M.get("text-translate-anchor")),G=o.aC(this.collisionIndex.transform,f,M.get("icon-translate"),M.get("icon-translate-anchor")),Q=Dt(N,this.transform,W);this.retainedQueryData[y.bucketInstanceId]=new rn(y.bucketInstanceId,x,y.sourceLayerIndex,y.index,f.tileID);const re={bucket:y,layout:I,translationText:J,translationIcon:G,unwrappedTileID:F,pitchedLabelPlaneMatrix:Q,scale:k,textPixelRatio:B,holdingForFade:f.holdingForFade(),collisionBoxArray:S,partiallyEvaluatedTextSize:o.am(y.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(y.sourceID)};if(g)for(const ae of y.sortKeyRanges){const{sortKey:se,symbolInstanceStart:ue,symbolInstanceEnd:de}=ae;i.push({sortKey:se,symbolInstanceStart:ue,symbolInstanceEnd:de,parameters:re})}else i.push({symbolInstanceStart:0,symbolInstanceEnd:y.symbolInstances.length,parameters:re})}attemptAnchorPlacement(i,l,f,g,y,x,S,I,M,k,B,F,N,W,J,G,Q,re,ae,se){const ue=o.aD[i.textAnchor],de=[i.textOffset0,i.textOffset1],oe=iu(ue,f,g,de,y),ye=this.collisionIndex.placeCollisionBox(l,F,I,M,k,S,x,G,B.predicate,ae,oe,se);if((!re||this.collisionIndex.placeCollisionBox(re,F,I,M,k,S,x,Q,B.predicate,ae,oe,se).placeable)&&ye.placeable){let Oe;if(this.prevPlacement&&this.prevPlacement.variableOffsets[N.crossTileID]&&this.prevPlacement.placements[N.crossTileID]&&this.prevPlacement.placements[N.crossTileID].text&&(Oe=this.prevPlacement.variableOffsets[N.crossTileID].anchor),N.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[N.crossTileID]={textOffset:de,width:f,height:g,anchor:ue,textBoxScale:y,prevAnchor:Oe},this.markUsedJustification(W,ue,N,J),W.allowVerticalPlacement&&(this.markUsedOrientation(W,J,N),this.placedOrientations[N.crossTileID]=J),{shift:oe,placedGlyphBoxes:ye}}}placeLayerBucketPart(i,l,f){const{bucket:g,layout:y,translationText:x,translationIcon:S,unwrappedTileID:I,pitchedLabelPlaneMatrix:M,textPixelRatio:k,holdingForFade:B,collisionBoxArray:F,partiallyEvaluatedTextSize:N,collisionGroup:W}=i.parameters,J=y.get("text-optional"),G=y.get("icon-optional"),Q=o.aE(y,"text-overlap","text-allow-overlap"),re=Q==="always",ae=o.aE(y,"icon-overlap","icon-allow-overlap"),se=ae==="always",ue=y.get("text-rotation-alignment")==="map",de=y.get("text-pitch-alignment")==="map",oe=y.get("icon-text-fit")!=="none",ye=y.get("symbol-z-order")==="viewport-y",Oe=re&&(se||!g.hasIconData()||G),Ce=se&&(re||!g.hasTextData()||J);!g.collisionArrays&&F&&g.deserializeCollisionBoxes(F);const Me=this.retainedQueryData[g.bucketInstanceId].tileID,Fe=this._getTerrainElevationFunc(Me),nt=this.transform.getFastPathSimpleProjectionMatrix(Me),it=(qe,ft,Nt)=>{var sr,Lr;if(l[qe.crossTileID])return;if(B)return void(this.placements[qe.crossTileID]=new zo(!1,!1,!1));let ur=!1,Nr=!1,br=!0,dr=null,vr={box:null,placeable:!1,offscreen:null,occluded:!1},xi={placeable:!1},rr=null,hi=null,wi=null,ds=0,fs=0,ps=0;ft.textFeatureIndex?ds=ft.textFeatureIndex:qe.useRuntimeCollisionCircles&&(ds=qe.featureIndex),ft.verticalTextFeatureIndex&&(fs=ft.verticalTextFeatureIndex);const Dn=ft.textBox;if(Dn){const Yi=Hr=>{let Ar=o.an.horizontal;if(g.allowVerticalPlacement&&!Hr&&this.prevPlacement){const $i=this.prevPlacement.placedOrientations[qe.crossTileID];$i&&(this.placedOrientations[qe.crossTileID]=$i,Ar=$i,this.markUsedOrientation(g,Ar,qe))}return Ar},_n=(Hr,Ar)=>{if(g.allowVerticalPlacement&&qe.numVerticalGlyphVertices>0&&ft.verticalTextBox){for(const $i of g.writingModes)if($i===o.an.vertical?(vr=Ar(),xi=vr):vr=Hr(),vr&&vr.placeable)break}else vr=Hr()},gs=qe.textAnchorOffsetStartIndex,zs=qe.textAnchorOffsetEndIndex;if(zs===gs){const Hr=(Ar,$i)=>{const ii=this.collisionIndex.placeCollisionBox(Ar,Q,k,Me,I,de,ue,x,W.predicate,Fe,void 0,nt);return ii&&ii.placeable&&(this.markUsedOrientation(g,$i,qe),this.placedOrientations[qe.crossTileID]=$i),ii};_n(()=>Hr(Dn,o.an.horizontal),()=>{const Ar=ft.verticalTextBox;return g.allowVerticalPlacement&&qe.numVerticalGlyphVertices>0&&Ar?Hr(Ar,o.an.vertical):{box:null,offscreen:null}}),Yi(vr&&vr.placeable)}else{let Hr=o.aD[(Lr=(sr=this.prevPlacement)===null||sr===void 0?void 0:sr.variableOffsets[qe.crossTileID])===null||Lr===void 0?void 0:Lr.anchor];const Ar=(ii,Gu,Hf)=>{const sh=ii.x2-ii.x1,_a=ii.y2-ii.y1,vo=qe.textBoxScale,Zn=oe&&ae==="never"?Gu:null;let Ti=null,Xn=Q==="never"?1:2,oh="never";Hr&&Xn++;for(let ms=0;ms<Xn;ms++){for(let ah=gs;ah<zs;ah++){const lh=g.textAnchorOffsets.get(ah);if(Hr&&lh.textAnchor!==Hr)continue;const ya=this.attemptAnchorPlacement(lh,ii,sh,_a,vo,ue,de,k,Me,I,W,oh,qe,g,Hf,x,S,Zn,Fe);if(ya&&(Ti=ya.placedGlyphBoxes,Ti&&Ti.placeable))return ur=!0,dr=ya.shift,Ti}Hr?Hr=null:oh=Q}return f&&!Ti&&(Ti={box:this.collisionIndex.placeCollisionBox(Dn,"always",k,Me,I,de,ue,x,W.predicate,Fe,void 0,nt).box,offscreen:!1,placeable:!1,occluded:!1}),Ti};_n(()=>Ar(Dn,ft.iconBox,o.an.horizontal),()=>{const ii=ft.verticalTextBox;return g.allowVerticalPlacement&&(!vr||!vr.placeable)&&qe.numVerticalGlyphVertices>0&&ii?Ar(ii,ft.verticalIconBox,o.an.vertical):{box:null,occluded:!0,offscreen:null}}),vr&&(ur=vr.placeable,br=vr.offscreen);const $i=Yi(vr&&vr.placeable);if(!ur&&this.prevPlacement){const ii=this.prevPlacement.variableOffsets[qe.crossTileID];ii&&(this.variableOffsets[qe.crossTileID]=ii,this.markUsedJustification(g,ii.anchor,qe,$i))}}}if(rr=vr,ur=rr&&rr.placeable,br=rr&&rr.offscreen,qe.useRuntimeCollisionCircles){const Yi=g.text.placedSymbolArray.get(qe.centerJustifiedTextSymbolIndex),_n=o.ao(g.textSizeData,N,Yi),gs=y.get("text-padding");hi=this.collisionIndex.placeCollisionCircles(Q,Yi,g.lineVertexArray,g.glyphOffsetArray,_n,I,M,f,de,W.predicate,qe.collisionCircleDiameter,gs,x,Fe),hi.circles.length&&hi.collisionDetected&&!f&&o.w("Collisions detected, but collision boxes are not shown"),ur=re||hi.circles.length>0&&!hi.collisionDetected,br=br&&hi.offscreen}if(ft.iconFeatureIndex&&(ps=ft.iconFeatureIndex),ft.iconBox){const Yi=_n=>this.collisionIndex.placeCollisionBox(_n,ae,k,Me,I,de,ue,S,W.predicate,Fe,oe&&dr?dr:void 0,nt);xi&&xi.placeable&&ft.verticalIconBox?(wi=Yi(ft.verticalIconBox),Nr=wi.placeable):(wi=Yi(ft.iconBox),Nr=wi.placeable),br=br&&wi.offscreen}const ga=J||qe.numHorizontalGlyphVertices===0&&qe.numVerticalGlyphVertices===0,ma=G||qe.numIconVertices===0;ga||ma?ma?ga||(Nr=Nr&&ur):ur=Nr&&ur:Nr=ur=Nr&&ur;const bo=Nr&&wi.placeable;if(ur&&rr.placeable&&this.collisionIndex.insertCollisionBox(rr.box,Q,y.get("text-ignore-placement"),g.bucketInstanceId,xi&&xi.placeable&&fs?fs:ds,W.ID),bo&&this.collisionIndex.insertCollisionBox(wi.box,ae,y.get("icon-ignore-placement"),g.bucketInstanceId,ps,W.ID),hi&&ur&&this.collisionIndex.insertCollisionCircles(hi.circles,Q,y.get("text-ignore-placement"),g.bucketInstanceId,ds,W.ID),f&&this.storeCollisionData(g.bucketInstanceId,Nt,ft,rr,wi,hi),qe.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(g.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[qe.crossTileID]=new zo((ur||Oe)&&!rr?.occluded,(Nr||Ce)&&!wi?.occluded,br||g.justReloaded),l[qe.crossTileID]=!0};if(ye){if(i.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const qe=g.getSortedSymbolIndexes(-this.transform.bearingInRadians);for(let ft=qe.length-1;ft>=0;--ft){const Nt=qe[ft];it(g.symbolInstances.get(Nt),g.collisionArrays[Nt],Nt)}}else for(let qe=i.symbolInstanceStart;qe<i.symbolInstanceEnd;qe++)it(g.symbolInstances.get(qe),g.collisionArrays[qe],qe);g.justReloaded=!1}storeCollisionData(i,l,f,g,y,x){if(f.textBox||f.iconBox){let S,I;this.collisionBoxArrays.has(i)?S=this.collisionBoxArrays.get(i):(S=new Map,this.collisionBoxArrays.set(i,S)),S.has(l)?I=S.get(l):(I={text:null,icon:null},S.set(l,I)),f.textBox&&(I.text=g.box),f.iconBox&&(I.icon=y.box)}if(x){let S=this.collisionCircleArrays[i];S===void 0&&(S=this.collisionCircleArrays[i]=[]);for(let I=0;I<x.circles.length;I+=4)S.push(x.circles[I+0]-Xr),S.push(x.circles[I+1]-Xr),S.push(x.circles[I+2]),S.push(x.collisionDetected?1:0)}}markUsedJustification(i,l,f,g){let y;y=g===o.an.vertical?f.verticalPlacedTextSymbolIndex:{left:f.leftJustifiedTextSymbolIndex,center:f.centerJustifiedTextSymbolIndex,right:f.rightJustifiedTextSymbolIndex}[o.aF(l)];const x=[f.leftJustifiedTextSymbolIndex,f.centerJustifiedTextSymbolIndex,f.rightJustifiedTextSymbolIndex,f.verticalPlacedTextSymbolIndex];for(const S of x)S>=0&&(i.text.placedSymbolArray.get(S).crossTileID=y>=0&&S!==y?0:f.crossTileID)}markUsedOrientation(i,l,f){const g=l===o.an.horizontal||l===o.an.horizontalOnly?l:0,y=l===o.an.vertical?l:0,x=[f.leftJustifiedTextSymbolIndex,f.centerJustifiedTextSymbolIndex,f.rightJustifiedTextSymbolIndex];for(const S of x)i.text.placedSymbolArray.get(S).placedOrientation=g;f.verticalPlacedTextSymbolIndex&&(i.text.placedSymbolArray.get(f.verticalPlacedTextSymbolIndex).placedOrientation=y)}commit(i){this.commitTime=i,this.zoomAtLastRecencyCheck=this.transform.zoom;const l=this.prevPlacement;let f=!1;this.prevZoomAdjustment=l?l.zoomAdjustment(this.transform.zoom):0;const g=l?l.symbolFadeChange(i):1,y=l?l.opacities:{},x=l?l.variableOffsets:{},S=l?l.placedOrientations:{};for(const I in this.placements){const M=this.placements[I],k=y[I];k?(this.opacities[I]=new Vn(k,g,M.text,M.icon),f=f||M.text!==k.text.placed||M.icon!==k.icon.placed):(this.opacities[I]=new Vn(null,g,M.text,M.icon,M.skipFade),f=f||M.text||M.icon)}for(const I in y){const M=y[I];if(!this.opacities[I]){const k=new Vn(M,g,!1,!1);k.isHidden()||(this.opacities[I]=k,f=f||M.text.placed||M.icon.placed)}}for(const I in x)this.variableOffsets[I]||!this.opacities[I]||this.opacities[I].isHidden()||(this.variableOffsets[I]=x[I]);for(const I in S)this.placedOrientations[I]||!this.opacities[I]||this.opacities[I].isHidden()||(this.placedOrientations[I]=S[I]);if(l&&l.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");f?this.lastPlacementChangeTime=i:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=l?l.lastPlacementChangeTime:i)}updateLayerOpacities(i,l){const f={};for(const g of l){const y=g.getBucket(i);y&&g.latestFeatureIndex&&i.id===y.layerIds[0]&&this.updateBucketOpacities(y,g.tileID,f,g.collisionBoxArray)}}updateBucketOpacities(i,l,f,g){i.hasTextData()&&(i.text.opacityVertexArray.clear(),i.text.hasVisibleVertices=!1),i.hasIconData()&&(i.icon.opacityVertexArray.clear(),i.icon.hasVisibleVertices=!1),i.hasIconCollisionBoxData()&&i.iconCollisionBox.collisionVertexArray.clear(),i.hasTextCollisionBoxData()&&i.textCollisionBox.collisionVertexArray.clear();const y=i.layers[0],x=y.layout,S=new Vn(null,0,!1,!1,!0),I=x.get("text-allow-overlap"),M=x.get("icon-allow-overlap"),k=y._unevaluatedLayout.hasValue("text-variable-anchor")||y._unevaluatedLayout.hasValue("text-variable-anchor-offset"),B=x.get("text-rotation-alignment")==="map",F=x.get("text-pitch-alignment")==="map",N=x.get("icon-text-fit")!=="none",W=new Vn(null,0,I&&(M||!i.hasIconData()||x.get("icon-optional")),M&&(I||!i.hasTextData()||x.get("text-optional")),!0);!i.collisionArrays&&g&&(i.hasIconCollisionBoxData()||i.hasTextCollisionBoxData())&&i.deserializeCollisionBoxes(g);const J=(Q,re,ae)=>{for(let se=0;se<re/4;se++)Q.opacityVertexArray.emplaceBack(ae);Q.hasVisibleVertices=Q.hasVisibleVertices||ae!==Vo},G=this.collisionBoxArrays.get(i.bucketInstanceId);for(let Q=0;Q<i.symbolInstances.length;Q++){const re=i.symbolInstances.get(Q),{numHorizontalGlyphVertices:ae,numVerticalGlyphVertices:se,crossTileID:ue}=re;let de=this.opacities[ue];f[ue]?de=S:de||(de=W,this.opacities[ue]=de),f[ue]=!0;const oe=re.numIconVertices>0,ye=this.placedOrientations[re.crossTileID],Oe=ye===o.an.vertical,Ce=ye===o.an.horizontal||ye===o.an.horizontalOnly;if(ae>0||se>0){const Fe=lu(de.text);J(i.text,ae,Oe?Vo:Fe),J(i.text,se,Ce?Vo:Fe);const nt=de.text.isHidden();[re.rightJustifiedTextSymbolIndex,re.centerJustifiedTextSymbolIndex,re.leftJustifiedTextSymbolIndex].forEach(ft=>{ft>=0&&(i.text.placedSymbolArray.get(ft).hidden=nt||Oe?1:0)}),re.verticalPlacedTextSymbolIndex>=0&&(i.text.placedSymbolArray.get(re.verticalPlacedTextSymbolIndex).hidden=nt||Ce?1:0);const it=this.variableOffsets[re.crossTileID];it&&this.markUsedJustification(i,it.anchor,re,ye);const qe=this.placedOrientations[re.crossTileID];qe&&(this.markUsedJustification(i,"left",re,qe),this.markUsedOrientation(i,qe,re))}if(oe){const Fe=lu(de.icon),nt=!(N&&re.verticalPlacedIconSymbolIndex&&Oe);re.placedIconSymbolIndex>=0&&(J(i.icon,re.numIconVertices,nt?Fe:Vo),i.icon.placedSymbolArray.get(re.placedIconSymbolIndex).hidden=de.icon.isHidden()),re.verticalPlacedIconSymbolIndex>=0&&(J(i.icon,re.numVerticalIconVertices,nt?Vo:Fe),i.icon.placedSymbolArray.get(re.verticalPlacedIconSymbolIndex).hidden=de.icon.isHidden())}const Me=G&&G.has(Q)?G.get(Q):{text:null,icon:null};if(i.hasIconCollisionBoxData()||i.hasTextCollisionBoxData()){const Fe=i.collisionArrays[Q];if(Fe){let nt=new o.P(0,0);if(Fe.textBox||Fe.verticalTextBox){let it=!0;if(k){const qe=this.variableOffsets[ue];qe?(nt=iu(qe.anchor,qe.width,qe.height,qe.textOffset,qe.textBoxScale),B&&nt._rotate(F?-this.transform.bearingInRadians:this.transform.bearingInRadians)):it=!1}if(Fe.textBox||Fe.verticalTextBox){let qe;Fe.textBox&&(qe=Oe),Fe.verticalTextBox&&(qe=Ce),Ha(i.textCollisionBox.collisionVertexArray,de.text.placed,!it||qe,Me.text,nt.x,nt.y)}}if(Fe.iconBox||Fe.verticalIconBox){const it=!!(!Ce&&Fe.verticalIconBox);let qe;Fe.iconBox&&(qe=it),Fe.verticalIconBox&&(qe=!it),Ha(i.iconCollisionBox.collisionVertexArray,de.icon.placed,qe,Me.icon,N?nt.x:0,N?nt.y:0)}}}}if(i.sortFeatures(-this.transform.bearingInRadians),this.retainedQueryData[i.bucketInstanceId]&&(this.retainedQueryData[i.bucketInstanceId].featureSortOrder=i.featureSortOrder),i.hasTextData()&&i.text.opacityVertexBuffer&&i.text.opacityVertexBuffer.updateData(i.text.opacityVertexArray),i.hasIconData()&&i.icon.opacityVertexBuffer&&i.icon.opacityVertexBuffer.updateData(i.icon.opacityVertexArray),i.hasIconCollisionBoxData()&&i.iconCollisionBox.collisionVertexBuffer&&i.iconCollisionBox.collisionVertexBuffer.updateData(i.iconCollisionBox.collisionVertexArray),i.hasTextCollisionBoxData()&&i.textCollisionBox.collisionVertexBuffer&&i.textCollisionBox.collisionVertexBuffer.updateData(i.textCollisionBox.collisionVertexArray),i.text.opacityVertexArray.length!==i.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${i.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${i.text.layoutVertexArray.length}) / 4`);if(i.icon.opacityVertexArray.length!==i.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${i.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${i.icon.layoutVertexArray.length}) / 4`);i.bucketInstanceId in this.collisionCircleArrays&&(i.collisionCircleArray=this.collisionCircleArrays[i.bucketInstanceId],delete this.collisionCircleArrays[i.bucketInstanceId])}symbolFadeChange(i){return this.fadeDuration===0?1:(i-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(i){return Math.max(0,(this.transform.zoom-i)/1.5)}hasTransitions(i){return this.stale||i-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(i,l){const f=this.zoomAtLastRecencyCheck===l?1-this.zoomAdjustment(l):1;return this.zoomAtLastRecencyCheck=l,this.commitTime+this.fadeDuration*f>i}setStale(){this.stale=!0}}function Ha(_,i,l,f,g,y){f&&f.length!==0||(f=[0,0,0,0]);const x=f[0]-Xr,S=f[1]-Xr,I=f[2]-Xr,M=f[3]-Xr;_.emplaceBack(i?1:0,l?1:0,g||0,y||0,x,S),_.emplaceBack(i?1:0,l?1:0,g||0,y||0,I,S),_.emplaceBack(i?1:0,l?1:0,g||0,y||0,I,M),_.emplaceBack(i?1:0,l?1:0,g||0,y||0,x,M)}const Cs=Math.pow(2,25),ss=Math.pow(2,24),nu=Math.pow(2,17),su=Math.pow(2,16),ou=Math.pow(2,9),Zs=Math.pow(2,8),au=Math.pow(2,1);function lu(_){if(_.opacity===0&&!_.placed)return 0;if(_.opacity===1&&_.placed)return 4294967295;const i=_.placed?1:0,l=Math.floor(127*_.opacity);return l*Cs+i*ss+l*nu+i*su+l*ou+i*Zs+l*au+i}const Vo=0;class bf{constructor(i){this._sortAcrossTiles=i.layout.get("symbol-z-order")!=="viewport-y"&&!i.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(i,l,f,g,y){const x=this._bucketParts;for(;this._currentTileIndex<i.length;)if(l.getBucketParts(x,g,i[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,y())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,x.sort((S,I)=>S.sortKey-I.sortKey));this._currentPartIndex<x.length;)if(l.placeLayerBucketPart(x[this._currentPartIndex],this._seenCrossTileIDs,f),this._currentPartIndex++,y())return!0;return!1}}class cu{constructor(i,l,f,g,y,x,S,I){this.placement=new Uo(i,l,x,S,I),this._currentPlacementIndex=f.length-1,this._forceFullPlacement=g,this._showCollisionBoxes=y,this._done=!1}isDone(){return this._done}continuePlacement(i,l,f){const g=$.now(),y=()=>!this._forceFullPlacement&&$.now()-g>2;for(;this._currentPlacementIndex>=0;){const x=l[i[this._currentPlacementIndex]],S=this.placement.collisionIndex.transform.zoom;if(x.type==="symbol"&&(!x.minzoom||x.minzoom<=S)&&(!x.maxzoom||x.maxzoom>S)){if(this._inProgressLayer||(this._inProgressLayer=new bf(x)),this._inProgressLayer.continuePlacement(f[x.source],this.placement,this._showCollisionBoxes,x,y))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(i){return this.placement.commit(i),this.placement}}const Xs=512/o.$/2;class pc{constructor(i,l,f){this.tileID=i,this.bucketInstanceId=f,this._symbolsByKey={};const g=new Map;for(let y=0;y<l.length;y++){const x=l.get(y),S=x.key,I=g.get(S);I?I.push(x):g.set(S,[x])}for(const[y,x]of g){const S={positions:x.map(I=>({x:Math.floor(I.anchorX*Xs),y:Math.floor(I.anchorY*Xs)})),crossTileIDs:x.map(I=>I.crossTileID)};if(S.positions.length>128){const I=new o.aH(S.positions.length,16,Uint16Array);for(const{x:M,y:k}of S.positions)I.add(M,k);I.finish(),delete S.positions,S.index=I}this._symbolsByKey[y]=S}}getScaledCoordinates(i,l){const{x:f,y:g,z:y}=this.tileID.canonical,{x,y:S,z:I}=l.canonical,M=Xs/Math.pow(2,I-y),k=(S*o.$+i.anchorY)*M,B=g*o.$*Xs;return{x:Math.floor((x*o.$+i.anchorX)*M-f*o.$*Xs),y:Math.floor(k-B)}}findMatches(i,l,f){const g=this.tileID.canonical.z<l.canonical.z?1:Math.pow(2,this.tileID.canonical.z-l.canonical.z);for(let y=0;y<i.length;y++){const x=i.get(y);if(x.crossTileID)continue;const S=this._symbolsByKey[x.key];if(!S)continue;const I=this.getScaledCoordinates(x,l);if(S.index){const M=S.index.range(I.x-g,I.y-g,I.x+g,I.y+g).sort();for(const k of M){const B=S.crossTileIDs[k];if(!f[B]){f[B]=!0,x.crossTileID=B;break}}}else if(S.positions)for(let M=0;M<S.positions.length;M++){const k=S.positions[M],B=S.crossTileIDs[M];if(Math.abs(k.x-I.x)<=g&&Math.abs(k.y-I.y)<=g&&!f[B]){f[B]=!0,x.crossTileID=B;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map(({crossTileIDs:i})=>i)}}class gc{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class hu{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(i){const l=Math.round((i-this.lng)/360);if(l!==0)for(const f in this.indexes){const g=this.indexes[f],y={};for(const x in g){const S=g[x];S.tileID=S.tileID.unwrapTo(S.tileID.wrap+l),y[S.tileID.key]=S}this.indexes[f]=y}this.lng=i}addBucket(i,l,f){if(this.indexes[i.overscaledZ]&&this.indexes[i.overscaledZ][i.key]){if(this.indexes[i.overscaledZ][i.key].bucketInstanceId===l.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(i.overscaledZ,this.indexes[i.overscaledZ][i.key])}for(let y=0;y<l.symbolInstances.length;y++)l.symbolInstances.get(y).crossTileID=0;this.usedCrossTileIDs[i.overscaledZ]||(this.usedCrossTileIDs[i.overscaledZ]={});const g=this.usedCrossTileIDs[i.overscaledZ];for(const y in this.indexes){const x=this.indexes[y];if(Number(y)>i.overscaledZ)for(const S in x){const I=x[S];I.tileID.isChildOf(i)&&I.findMatches(l.symbolInstances,i,g)}else{const S=x[i.scaledTo(Number(y)).key];S&&S.findMatches(l.symbolInstances,i,g)}}for(let y=0;y<l.symbolInstances.length;y++){const x=l.symbolInstances.get(y);x.crossTileID||(x.crossTileID=f.generate(),g[x.crossTileID]=!0)}return this.indexes[i.overscaledZ]===void 0&&(this.indexes[i.overscaledZ]={}),this.indexes[i.overscaledZ][i.key]=new pc(i,l.symbolInstances,l.bucketInstanceId),!0}removeBucketCrossTileIDs(i,l){for(const f of l.getCrossTileIDsLists())for(const g of f)delete this.usedCrossTileIDs[i][g]}removeStaleBuckets(i){let l=!1;for(const f in this.indexes){const g=this.indexes[f];for(const y in g)i[g[y].bucketInstanceId]||(this.removeBucketCrossTileIDs(f,g[y]),delete g[y],l=!0)}return l}}class Za{constructor(){this.layerIndexes={},this.crossTileIDs=new gc,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(i,l,f){let g=this.layerIndexes[i.id];g===void 0&&(g=this.layerIndexes[i.id]=new hu);let y=!1;const x={};g.handleWrapJump(f);for(const S of l){const I=S.getBucket(i);I&&i.id===I.layerIds[0]&&(I.bucketInstanceId||(I.bucketInstanceId=++this.maxBucketInstanceId),g.addBucket(S.tileID,I,this.crossTileIDs)&&(y=!0),x[I.bucketInstanceId]=!0)}return g.removeStaleBuckets(x)&&(y=!0),y}pruneUnusedLayers(i){const l={};i.forEach(f=>{l[f]=!0});for(const f in this.layerIndexes)l[f]||delete this.layerIndexes[f]}}var Xa="void main() {fragColor=vec4(1.0);}";const Cn={prelude:Zt(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
out highp vec4 fragColor;`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}mat3 rotationMatrixFromAxisAngle(vec3 u,float angle) {float c=cos(angle);float s=sin(angle);float c2=1.0-c;return mat3(u.x*u.x*c2+      c,u.x*u.y*c2-u.z*s,u.x*u.z*c2+u.y*s,u.y*u.x*c2+u.z*s,u.y*u.y*c2+    c,u.y*u.z*c2-u.x*s,u.z*u.x*c2-u.y*s,u.z*u.y*c2+u.x*s,u.z*u.z*c2+    c
);}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
#ifdef GLOBE
if ((pos.y <-32767.5) || (pos.y > 32766.5)) {return 0.0;}
#endif
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}const float PI=3.141592653589793;uniform mat4 u_projection_matrix;`),projectionMercator:Zt("","float projectLineThickness(float tileY) {return 1.0;}float projectCircleRadius(float tileY) {return 1.0;}vec4 projectTile(vec2 p) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);return result;}vec4 projectTile(vec2 p,vec2 rawPos) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);if (rawPos.y <-32767.5 || rawPos.y > 32766.5) {result.z=-10000000.0;}return result;}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_projection_matrix*vec4(posInTile,elevation,1.0);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {return projectTileWithElevation(posInTile,elevation);}"),projectionGlobe:Zt("",`#define GLOBE_RADIUS 6371008.8
uniform highp vec4 u_projection_tile_mercator_coords;uniform highp vec4 u_projection_clipping_plane;uniform highp float u_projection_transition;uniform mat4 u_projection_fallback_matrix;vec3 globeRotateVector(vec3 vec,vec2 angles) {vec3 axisRight=vec3(vec.z,0.0,-vec.x);vec3 axisUp=cross(axisRight,vec);axisRight=normalize(axisRight);axisUp=normalize(axisUp);vec2 t=tan(angles);return normalize(vec+axisRight*t.x+axisUp*t.y);}mat3 globeGetRotationMatrix(vec3 spherePos) {vec3 axisRight=vec3(spherePos.z,0.0,-spherePos.x);vec3 axisDown=cross(axisRight,spherePos);axisRight=normalize(axisRight);axisDown=normalize(axisDown);return mat3(axisRight,axisDown,spherePos
);}float circumferenceRatioAtTileY(float tileY) {float mercator_pos_y=u_projection_tile_mercator_coords.y+u_projection_tile_mercator_coords.w*tileY;float spherical_y=2.0*atan(exp(PI-(mercator_pos_y*PI*2.0)))-PI*0.5;return cos(spherical_y);}float projectLineThickness(float tileY) {float thickness=1.0/circumferenceRatioAtTileY(tileY); 
if (u_projection_transition < 0.999) {return mix(1.0,thickness,u_projection_transition);} else {return thickness;}}vec3 projectToSphere(vec2 translatedPos,vec2 rawPos) {vec2 mercator_pos=u_projection_tile_mercator_coords.xy+u_projection_tile_mercator_coords.zw*translatedPos;vec2 spherical;spherical.x=mercator_pos.x*PI*2.0+PI;spherical.y=2.0*atan(exp(PI-(mercator_pos.y*PI*2.0)))-PI*0.5;float len=cos(spherical.y);vec3 pos=vec3(sin(spherical.x)*len,sin(spherical.y),cos(spherical.x)*len
);if (rawPos.y <-32767.5) {pos=vec3(0.0,1.0,0.0);}if (rawPos.y > 32766.5) {pos=vec3(0.0,-1.0,0.0);}return pos;}vec3 projectToSphere(vec2 posInTile) {return projectToSphere(posInTile,vec2(0.0,0.0));}float globeComputeClippingZ(vec3 spherePos) {return (1.0-(dot(spherePos,u_projection_clipping_plane.xyz)+u_projection_clipping_plane.w));}vec4 interpolateProjection(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);globePosition.z=globeComputeClippingZ(elevatedPos)*globePosition.w;if (u_projection_transition > 0.999) {return globePosition;}vec4 flatPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);const float z_globeness_threshold=0.2;vec4 result=globePosition;result.z=mix(0.0,globePosition.z,clamp((u_projection_transition-z_globeness_threshold)/(1.0-z_globeness_threshold),0.0,1.0));result.xyw=mix(flatPosition.xyw,globePosition.xyw,u_projection_transition);if ((posInTile.y <-32767.5) || (posInTile.y > 32766.5)) {result=globePosition;const float poles_hidden_anim_percentage=0.02;result.z=mix(globePosition.z,100.0,pow(max((1.0-u_projection_transition)/poles_hidden_anim_percentage,0.0),8.0));}return result;}vec4 interpolateProjectionFor3D(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);if (u_projection_transition > 0.999) {return globePosition;}vec4 fallbackPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);return mix(fallbackPosition,globePosition,u_projection_transition);}vec4 projectTile(vec2 posInTile) {return interpolateProjection(posInTile,projectToSphere(posInTile),0.0);}vec4 projectTile(vec2 posInTile,vec2 rawPos) {return interpolateProjection(posInTile,projectToSphere(posInTile,rawPos),0.0);}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return interpolateProjection(posInTile,projectToSphere(posInTile),elevation);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {vec3 spherePos=projectToSphere(posInTile,posInTile);return interpolateProjectionFor3D(posInTile,spherePos,elevation);}`),background:Zt(`uniform vec4 u_color;uniform float u_opacity;void main() {fragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),backgroundPattern:Zt(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;void main() {gl_Position=projectTile(a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:Zt(`in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);float antialiased_blur=v_data.z;float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));fragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);const float epsilon=0.5/255.0;if (fragColor.r < epsilon && fragColor.g < epsilon && fragColor.b < epsilon && fragColor.a < epsilon) {discard;}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform highp float u_globe_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;uniform vec2 u_translate;in vec2 a_pos;out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 pos_raw=a_pos+32768.0;vec2 extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);vec2 circle_center=floor(pos_raw/8.0)+u_translate;float ele=get_elevation(circle_center);v_visibility=calculate_visibility(projectTileWithElevation(circle_center,ele));if (u_pitch_with_map) {
#ifdef GLOBE
vec3 center_vector=projectToSphere(circle_center);
#endif
float angle_scale=u_globe_extrude_scale;vec2 corner_position=circle_center;if (u_scale_with_map) {angle_scale*=(radius+stroke_width);corner_position+=extrude*u_extrude_scale*(radius+stroke_width);} else {
#ifdef GLOBE
vec4 projected_center=interpolateProjection(circle_center,center_vector,ele);
#else
vec4 projected_center=projectTileWithElevation(circle_center,ele);
#endif
corner_position+=extrude*u_extrude_scale*(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);angle_scale*=(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);}
#ifdef GLOBE
vec2 angles=extrude*angle_scale;vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(corner_position,corner_vector,ele);
#else
gl_Position=projectTileWithElevation(corner_position,ele);
#endif
} else {gl_Position=projectTileWithElevation(circle_center,ele);if (gl_Position.z/gl_Position.w > 1.0) {gl_Position.xy=vec2(10000.0);}if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}float antialiasblur=-max(1.0/u_device_pixel_ratio/(radius+stroke_width),blur);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:Zt(Xa,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),heatmap:Zt(`uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);fragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;uniform highp float u_globe_extrude_scale;in vec2 a_pos;out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 pos_raw=a_pos+32768.0;vec2 unscaled_extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 circle_center=floor(pos_raw/8.0);
#ifdef GLOBE
vec2 angles=v_extrude*radius*u_globe_extrude_scale;vec3 center_vector=projectToSphere(circle_center);vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(circle_center+extrude,corner_vector,0.0);
#else
gl_Position=projectTileFor3D(circle_center+extrude,get_elevation(circle_center));
#endif
}`),heatmapTexture:Zt(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));fragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:Zt("in float v_placed;in float v_notUsed;void main() {float alpha=0.5;fragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {fragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {fragColor*=.1;}}","in vec2 a_anchor_pos;in vec2 a_placed;in vec2 a_box_real;uniform vec2 u_pixel_extrude_scale;out float v_placed;out float v_notUsed;void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Zt("in float v_radius;in vec2 v_extrude;in float v_collision;void main() {float alpha=0.5;float stroke_radius=0.9;float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);fragColor=color*alpha*opacity_t;}","in vec2 a_pos;in float a_radius;in vec2 a_flags;uniform vec2 u_viewport_size;out float v_radius;out vec2 v_extrude;out float v_collision;void main() {float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_collision=collision;gl_Position=vec4((a_pos/u_viewport_size*2.0-1.0)*vec2(1.0,-1.0),0.0,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),colorRelief:Zt(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;uniform vec4 u_unpack;uniform sampler2D u_elevation_stops;uniform sampler2D u_color_stops;uniform int u_color_ramp_size;uniform float u_opacity;in vec2 v_pos;float getElevation(vec2 coord) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack);}float getElevationStop(int stop) {float x=(float(stop)+0.5)/float(u_color_ramp_size);vec4 data=texture(u_elevation_stops,vec2(x,0))*255.0;data.a=-1.0;return dot(data,u_unpack);}void main() {float el=getElevation(v_pos);int r=(u_color_ramp_size-1);int l=0;float el_l=getElevationStop(l);float el_r=getElevationStop(r);while(r-l > 1){int m=(r+l)/2;float el_m=getElevationStop(m);if(el < el_m){r=m;el_r=el_m;}else
{l=m;el_l=el_m;}}float x=(float(l)+(el-el_l)/(el_r-el_l)+0.5)/float(u_color_ramp_size);fragColor=u_opacity*texture(u_color_stops,vec2(x,0));
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_dimension;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_pos/8192.0)*scale+epsilon;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),debug:Zt("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);fragColor=mix(u_color,overlay_color,overlay_color.a);}","in vec2 a_pos;out vec2 v_uv;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=projectTileWithElevation(a_pos*u_overlay_scale,get_elevation(a_pos));}"),depth:Zt(Xa,`in vec2 a_pos;void main() {
#ifdef GLOBE
gl_Position=projectTileFor3D(a_pos,0.0);
#else
gl_Position=u_projection_matrix*vec4(a_pos,0.0,1.0);
#endif
}`),fill:Zt(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
fragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_fill_translate;in vec2 a_pos;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);}`),fillOutline:Zt(`in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=outline_color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillOutlinePattern:Zt(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;in vec2 v_pos_a;in vec2 v_pos_b;in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillPattern:Zt(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:Zt(`in vec4 v_color;void main() {fragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
out vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;vec3 normalForLighting=normal/16384.0;float directional=clamp(dot(normalForLighting,u_lightpos),0.0,1.0);
#ifdef GLOBE
mat3 rotMatrix=globeGetRotationMatrix(spherePos);normalForLighting=rotMatrix*normalForLighting;directional=mix(directional,clamp(dot(normalForLighting,u_lightpos_globe),0.0,1.0),u_projection_transition);
#endif
directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:Zt(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;in vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);fragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
#ifdef GLOBE
out vec3 v_sphere_pos;
#endif
out vec2 v_pos_a;out vec2 v_pos_b;out vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);v_sphere_pos=elevatedPos;gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,elevation*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:Zt(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack);}void main() {vec2 epsilon=1.0/u_dimension;float tileSize=u_dimension.x-2.0;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))*tileSize/pow(2.0,exaggeration+(28.2562-u_zoom));fragColor=clamp(vec4(deriv.x/8.0+0.5,deriv.y/8.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Zt(`uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform float u_exaggeration;uniform vec4 u_accent;uniform int u_method;uniform float u_altitudes[NUM_ILLUMINATION_SOURCES];uniform float u_azimuths[NUM_ILLUMINATION_SOURCES];uniform vec4 u_shadows[NUM_ILLUMINATION_SOURCES];uniform vec4 u_highlights[NUM_ILLUMINATION_SOURCES];
#define PI 3.141592653589793
#define STANDARD 0
#define COMBINED 1
#define IGOR 2
#define MULTIDIRECTIONAL 3
#define BASIC 4
float get_aspect(vec2 deriv){return deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);}void igor_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float aspect=get_aspect(deriv);float azimuth=u_azimuths[0]+PI;float slope_stength=atan(length(deriv))*2.0/PI;float aspect_strength=1.0-abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);float shadow_strength=slope_stength*aspect_strength;float highlight_strength=slope_stength*(1.0-aspect_strength);fragColor=u_shadows[0]*shadow_strength+u_highlights[0]*highlight_strength;}void standard_hillshade(vec2 deriv){float azimuth=u_azimuths[0]+PI;float slope=atan(0.625*length(deriv));float aspect=get_aspect(deriv);float intensity=u_exaggeration;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadows[0],u_highlights[0],shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);fragColor=accent_color*(1.0-shade_color.a)+shade_color;}void basic_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float azimuth=u_azimuths[0]+PI;float cos_az=cos(azimuth);float sin_az=sin(azimuth);float cos_alt=cos(u_altitudes[0]);float sin_alt=sin(u_altitudes[0]);float cang=(sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv));float shade=clamp(cang,0.0,1.0);if(shade > 0.5){fragColor=u_highlights[0]*(2.0*shade-1.0);}else
{fragColor=u_shadows[0]*(1.0-2.0*shade);}}void multidirectional_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;fragColor=vec4(0,0,0,0);for(int i=0; i < NUM_ILLUMINATION_SOURCES; i++){float cos_alt=cos(u_altitudes[i]);float sin_alt=sin(u_altitudes[i]);float cos_az=-cos(u_azimuths[i]);float sin_az=-sin(u_azimuths[i]);float cang=(sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv));float shade=clamp(cang,0.0,1.0);if(shade > 0.5){fragColor+=u_highlights[i]*(2.0*shade-1.0)/float(NUM_ILLUMINATION_SOURCES);}else
{fragColor+=u_shadows[i]*(1.0-2.0*shade)/float(NUM_ILLUMINATION_SOURCES);}}}void combined_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float azimuth=u_azimuths[0]+PI;float cos_az=cos(azimuth);float sin_az=sin(azimuth);float cos_alt=cos(u_altitudes[0]);float sin_alt=sin(u_altitudes[0]);float cang=acos((sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv)));cang=clamp(cang,0.0,PI/2.0);float shade=cang*atan(length(deriv))*4.0/PI/PI;float highlight=(PI/2.0-cang)*atan(length(deriv))*4.0/PI/PI;fragColor=u_shadows[0]*shade+u_highlights[0]*highlight;}void main() {vec4 pixel=texture(u_image,v_pos);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));vec2 deriv=((pixel.rg*8.0)-4.0)/scaleFactor;if (u_method==BASIC) {basic_hillshade(deriv);} else if (u_method==COMBINED) {combined_hillshade(deriv);} else if (u_method==IGOR) {igor_hillshade(deriv);} else if (u_method==MULTIDIRECTIONAL) {multidirectional_hillshade(deriv);} else if (u_method==STANDARD) {standard_hillshade(deriv);} else {standard_hillshade(deriv);}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);v_pos=a_pos/8192.0;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),line:Zt(`uniform lowp float u_device_pixel_ratio;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp float v_linesofar;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:Zt(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:Zt(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture(u_image,pos_a),texture(u_image,pos_b),u_fade);fragColor=color*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:Zt(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture(u_image,v_tex_a).a;float sdfdist_b=texture(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;out vec2 v_normal;out vec2 v_width2;out vec2 v_tex_a;out vec2 v_tex_b;out float v_gamma_scale;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}`),raster:Zt(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;in vec2 v_pos0;in vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture(u_image0,v_pos0);vec4 color1=texture(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);fragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;uniform vec4 u_coords_top;uniform vec4 u_coords_bottom;in vec2 a_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {vec2 fractionalPos=a_pos/8192.0;vec2 position=mix(mix(u_coords_top.xy,u_coords_top.zw,fractionalPos.x),mix(u_coords_bottom.xy,u_coords_bottom.zw,fractionalPos.x),fractionalPos.y);gl_Position=projectTile(position,position);v_pos0=((fractionalPos-0.5)/u_buffer_scale)+0.5;
#ifdef GLOBE
if (a_pos.y <-32767.5) {v_pos0.y=0.0;}if (a_pos.y > 32766.5) {v_pos0.y=1.0;}
#endif
v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),symbolIcon:Zt(`uniform sampler2D u_texture;in vec2 v_tex;in float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;fragColor=texture(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_tex;out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:Zt(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:Zt(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;fragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map && !u_is_along_line) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:Zt("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;uniform bool u_is_globe_mode;in vec2 v_texture_pos;in float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture(u_texture,vec2(v_texture_pos.x,1.0-v_texture_pos.y));if (!u_is_globe_mode && v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);fragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {fragColor=surface_color;}}","in vec3 a_pos3d;uniform mat4 u_fog_matrix;uniform float u_ele_delta;out vec2 v_texture_pos;out float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:Zt("in float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {fragColor=pack(v_depth);}","in vec3 a_pos3d;uniform float u_ele_delta;out float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:Zt("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;in vec2 v_texture_pos;void main() {vec4 rgba=texture(u_texture,v_texture_pos);fragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","in vec3 a_pos3d;uniform float u_ele_delta;out vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);}"),projectionErrorMeasurement:Zt("in vec4 v_output_error_encoded;void main() {fragColor=v_output_error_encoded;}","in vec2 a_pos;uniform highp float u_input;uniform highp float u_output_expected;out vec4 v_output_error_encoded;void main() {float real_output=2.0*atan(exp(PI-(u_input*PI*2.0)))-PI*0.5;float error=real_output-u_output_expected;float abs_error=abs(error)*128.0;v_output_error_encoded.x=min(floor(abs_error*256.0),255.0)/255.0;abs_error-=v_output_error_encoded.x;v_output_error_encoded.y=min(floor(abs_error*65536.0),255.0)/255.0;abs_error-=v_output_error_encoded.x/255.0;v_output_error_encoded.z=min(floor(abs_error*16777216.0),255.0)/255.0;v_output_error_encoded.w=error >=0.0 ? 1.0 : 0.0;gl_Position=vec4(a_pos,0.0,1.0);}"),atmosphere:Zt(`in vec3 view_direction;uniform vec3 u_sun_pos;uniform vec3 u_globe_position;uniform float u_globe_radius;uniform float u_atmosphere_blend;/**Shader use from https:*Made some change to adapt to MapLibre Globe geometry*/const float PI=3.141592653589793;const int iSteps=5;const int jSteps=3;/*radius of the planet*/const float EARTH_RADIUS=6371e3;/*radius of the atmosphere*/const float ATMOS_RADIUS=6471e3;vec2 rsi(vec3 r0,vec3 rd,float sr) {float a=dot(rd,rd);float b=2.0*dot(rd,r0);float c=dot(r0,r0)-(sr*sr);float d=(b*b)-4.0*a*c;if (d < 0.0) return vec2(1e5,-1e5);return vec2((-b-sqrt(d))/(2.0*a),(-b+sqrt(d))/(2.0*a));}vec4 atmosphere(vec3 r,vec3 r0,vec3 pSun,float iSun,float rPlanet,float rAtmos,vec3 kRlh,float kMie,float shRlh,float shMie,float g) {pSun=normalize(pSun);r=normalize(r);vec2 p=rsi(r0,r,rAtmos);if (p.x > p.y) {return vec4(0.0,0.0,0.0,1.0);}if (p.x < 0.0) {p.x=0.0;}vec3 pos=r0+r*p.x;vec2 p2=rsi(r0,r,rPlanet);if (p2.x <=p2.y && p2.x > 0.0) {p.y=min(p.y,p2.x);}float iStepSize=(p.y-p.x)/float(iSteps);float iTime=p.x+iStepSize*0.5;vec3 totalRlh=vec3(0,0,0);vec3 totalMie=vec3(0,0,0);float iOdRlh=0.0;float iOdMie=0.0;float mu=dot(r,pSun);float mumu=mu*mu;float gg=g*g;float pRlh=3.0/(16.0*PI)*(1.0+mumu);float pMie=3.0/(8.0*PI)*((1.0-gg)*(mumu+1.0))/(pow(1.0+gg-2.0*mu*g,1.5)*(2.0+gg));for (int i=0; i < iSteps; i++) {vec3 iPos=r0+r*iTime;float iHeight=length(iPos)-rPlanet;float odStepRlh=exp(-iHeight/shRlh)*iStepSize;float odStepMie=exp(-iHeight/shMie)*iStepSize;iOdRlh+=odStepRlh;iOdMie+=odStepMie;float jStepSize=rsi(iPos,pSun,rAtmos).y/float(jSteps);float jTime=jStepSize*0.5;float jOdRlh=0.0;float jOdMie=0.0;for (int j=0; j < jSteps; j++) {vec3 jPos=iPos+pSun*jTime;float jHeight=length(jPos)-rPlanet;jOdRlh+=exp(-jHeight/shRlh)*jStepSize;jOdMie+=exp(-jHeight/shMie)*jStepSize;jTime+=jStepSize;}vec3 attn=exp(-(kMie*(iOdMie+jOdMie)+kRlh*(iOdRlh+jOdRlh)));totalRlh+=odStepRlh*attn;totalMie+=odStepMie*attn;iTime+=iStepSize;}float opacity=exp(-(length(kRlh)*length(totalRlh)+kMie*length(totalMie)));vec3 color=iSun*(pRlh*kRlh*totalRlh+pMie*kMie*totalMie);return vec4(color,opacity);}void main() {vec3 scale_camera_pos=-u_globe_position*EARTH_RADIUS/u_globe_radius;vec4 color=atmosphere(normalize(view_direction),scale_camera_pos,u_sun_pos,22.0,EARTH_RADIUS,ATMOS_RADIUS,vec3(5.5e-6,13.0e-6,22.4e-6),21e-6,8e3,1.2e3,0.758
);color.rgb=1.0-exp(-1.0*color.rgb);color=pow(color,vec4(1.0/2.2));fragColor=vec4(color.rgb,1.0-color.a)*u_atmosphere_blend;}`,"in vec2 a_pos;uniform mat4 u_inv_proj_matrix;out vec3 view_direction;void main() {view_direction=(u_inv_proj_matrix*vec4(a_pos,0.0,1.0)).xyz;gl_Position=vec4(a_pos,0.0,1.0);}"),sky:Zt("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform vec2 u_horizon;uniform vec2 u_horizon_normal;uniform float u_sky_horizon_blend;uniform float u_sky_blend;void main() {float x=gl_FragCoord.x;float y=gl_FragCoord.y;float blend=(y-u_horizon.y)*u_horizon_normal.y+(x-u_horizon.x)*u_horizon_normal.x;if (blend > 0.0) {if (blend < u_sky_horizon_blend) {fragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {fragColor=u_sky_color;}}fragColor=mix(fragColor,vec4(vec3(0.0),0.0),u_sky_blend);}","in vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function Zt(_,i){const l=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,f=i.match(/in ([\w]+) ([\w]+)/g),g=_.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),y=i.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),x=y?y.concat(g):g,S={};return{fragmentSource:_=_.replace(l,(I,M,k,B,F)=>(S[F]=!0,M==="define"?`
#ifndef HAS_UNIFORM_u_${F}
in ${k} ${B} ${F};
#else
uniform ${k} ${B} u_${F};
#endif
`:`
#ifdef HAS_UNIFORM_u_${F}
    ${k} ${B} ${F} = u_${F};
#endif
`)),vertexSource:i=i.replace(l,(I,M,k,B,F)=>{const N=B==="float"?"vec2":"vec4",W=F.match(/color/)?"color":N;return S[F]?M==="define"?`
#ifndef HAS_UNIFORM_u_${F}
uniform lowp float u_${F}_t;
in ${k} ${N} a_${F};
out ${k} ${B} ${F};
#else
uniform ${k} ${B} u_${F};
#endif
`:W==="vec4"?`
#ifndef HAS_UNIFORM_u_${F}
    ${F} = a_${F};
#else
    ${k} ${B} ${F} = u_${F};
#endif
`:`
#ifndef HAS_UNIFORM_u_${F}
    ${F} = unpack_mix_${W}(a_${F}, u_${F}_t);
#else
    ${k} ${B} ${F} = u_${F};
#endif
`:M==="define"?`
#ifndef HAS_UNIFORM_u_${F}
uniform lowp float u_${F}_t;
in ${k} ${N} a_${F};
#else
uniform ${k} ${B} u_${F};
#endif
`:W==="vec4"?`
#ifndef HAS_UNIFORM_u_${F}
    ${k} ${B} ${F} = a_${F};
#else
    ${k} ${B} ${F} = u_${F};
#endif
`:`
#ifndef HAS_UNIFORM_u_${F}
    ${k} ${B} ${F} = unpack_mix_${W}(a_${F}, u_${F}_t);
#else
    ${k} ${B} ${F} = u_${F};
#endif
`}),staticAttributes:f,staticUniforms:x}}class jn{constructor(i,l,f){this.vertexBuffer=i,this.indexBuffer=l,this.segments=f}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}var $n=o.aI([{name:"a_pos",type:"Int16",components:2}]);const Ps="#define PROJECTION_MERCATOR",mc="mercator";class _c{constructor(){this._cachedMesh=null}get name(){return"mercator"}get useSubdivision(){return!1}get shaderVariantName(){return mc}get shaderDefine(){return Ps}get shaderPreludeCode(){return Cn.projectionMercator}get vertexShaderPreludeCode(){return Cn.projectionMercator.vertexSource}get subdivisionGranularity(){return o.aJ.noSubdivision}get useGlobeControls(){return!1}get transitionState(){return 0}get latitudeErrorCorrectionRadians(){return 0}destroy(){}updateGPUdependent(i){}getMeshFromTileID(i,l,f,g,y){if(this._cachedMesh)return this._cachedMesh;const x=new o.aK;x.emplaceBack(0,0),x.emplaceBack(o.$,0),x.emplaceBack(0,o.$),x.emplaceBack(o.$,o.$);const S=i.createVertexBuffer(x,$n.members),I=o.aL.simpleSegment(0,0,4,2),M=new o.aM;M.emplaceBack(1,0,2),M.emplaceBack(1,2,3);const k=i.createIndexBuffer(M);return this._cachedMesh=new jn(S,k,I),this._cachedMesh}recalculate(){}hasTransition(){return!1}setErrorQueryLatitudeDegrees(i){}}class hn{constructor(i=0,l=0,f=0,g=0){if(isNaN(i)||i<0||isNaN(l)||l<0||isNaN(f)||f<0||isNaN(g)||g<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=i,this.bottom=l,this.left=f,this.right=g}interpolate(i,l,f){return l.top!=null&&i.top!=null&&(this.top=o.C.number(i.top,l.top,f)),l.bottom!=null&&i.bottom!=null&&(this.bottom=o.C.number(i.bottom,l.bottom,f)),l.left!=null&&i.left!=null&&(this.left=o.C.number(i.left,l.left,f)),l.right!=null&&i.right!=null&&(this.right=o.C.number(i.right,l.right,f)),this}getCenter(i,l){const f=o.ag((this.left+i-this.right)/2,0,i),g=o.ag((this.top+l-this.bottom)/2,0,l);return new o.P(f,g)}equals(i){return this.top===i.top&&this.bottom===i.bottom&&this.left===i.left&&this.right===i.right}clone(){return new hn(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Wn(_,i){if(!_.renderWorldCopies||_.lngRange)return;const l=i.lng-_.center.lng;i.lng+=l>180?-360:l<-180?360:0}function Xt(_){return Math.max(0,Math.floor(_))}class jo{constructor(i,l,f,g,y,x){this._callbacks=i,this._tileSize=512,this._renderWorldCopies=x===void 0||!!x,this._minZoom=l||0,this._maxZoom=f||22,this._minPitch=g??0,this._maxPitch=y??60,this.setMaxBounds(),this._width=0,this._height=0,this._center=new o.S(0,0),this._elevation=0,this._zoom=0,this._tileZoom=Xt(this._zoom),this._scale=o.ae(this._zoom),this._bearingInRadians=0,this._fovInRadians=.6435011087932844,this._pitchInRadians=0,this._rollInRadians=0,this._unmodified=!0,this._edgeInsets=new hn,this._minElevationForCurrentTile=0,this._autoCalculateNearFarZ=!0}apply(i,l,f){this._latRange=i.latRange,this._lngRange=i.lngRange,this._width=i.width,this._height=i.height,this._center=i.center,this._elevation=i.elevation,this._minElevationForCurrentTile=i.minElevationForCurrentTile,this._zoom=i.zoom,this._tileZoom=Xt(this._zoom),this._scale=o.ae(this._zoom),this._bearingInRadians=i.bearingInRadians,this._fovInRadians=i.fovInRadians,this._pitchInRadians=i.pitchInRadians,this._rollInRadians=i.rollInRadians,this._unmodified=i.unmodified,this._edgeInsets=new hn(i.padding.top,i.padding.bottom,i.padding.left,i.padding.right),this._minZoom=i.minZoom,this._maxZoom=i.maxZoom,this._minPitch=i.minPitch,this._maxPitch=i.maxPitch,this._renderWorldCopies=i.renderWorldCopies,this._cameraToCenterDistance=i.cameraToCenterDistance,this._nearZ=i.nearZ,this._farZ=i.farZ,this._autoCalculateNearFarZ=!f&&i.autoCalculateNearFarZ,l&&this._constrain(),this._calcMatrices()}get pixelsToClipSpaceMatrix(){return this._pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._clipSpaceToPixelsMatrix}get minElevationForCurrentTile(){return this._minElevationForCurrentTile}setMinElevationForCurrentTile(i){this._minElevationForCurrentTile=i}get tileSize(){return this._tileSize}get tileZoom(){return this._tileZoom}get scale(){return this._scale}get width(){return this._width}get height(){return this._height}get bearingInRadians(){return this._bearingInRadians}get lngRange(){return this._lngRange}get latRange(){return this._latRange}get pixelsToGLUnits(){return this._pixelsToGLUnits}get minZoom(){return this._minZoom}setMinZoom(i){this._minZoom!==i&&(this._minZoom=i,this.setZoom(this.getConstrained(this._center,this.zoom).zoom))}get maxZoom(){return this._maxZoom}setMaxZoom(i){this._maxZoom!==i&&(this._maxZoom=i,this.setZoom(this.getConstrained(this._center,this.zoom).zoom))}get minPitch(){return this._minPitch}setMinPitch(i){this._minPitch!==i&&(this._minPitch=i,this.setPitch(Math.max(this.pitch,i)))}get maxPitch(){return this._maxPitch}setMaxPitch(i){this._maxPitch!==i&&(this._maxPitch=i,this.setPitch(Math.min(this.pitch,i)))}get renderWorldCopies(){return this._renderWorldCopies}setRenderWorldCopies(i){i===void 0?i=!0:i===null&&(i=!1),this._renderWorldCopies=i}get worldSize(){return this._tileSize*this._scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new o.P(this._width,this._height)}get bearing(){return this._bearingInRadians/Math.PI*180}setBearing(i){const l=o.aN(i,-180,180)*Math.PI/180;var f,g,y,x,S,I,M,k,B;this._bearingInRadians!==l&&(this._unmodified=!1,this._bearingInRadians=l,this._calcMatrices(),this._rotationMatrix=E(),f=this._rotationMatrix,y=-this._bearingInRadians,x=(g=this._rotationMatrix)[0],S=g[1],I=g[2],M=g[3],k=Math.sin(y),B=Math.cos(y),f[0]=x*B+I*k,f[1]=S*B+M*k,f[2]=x*-k+I*B,f[3]=S*-k+M*B)}get rotationMatrix(){return this._rotationMatrix}get pitchInRadians(){return this._pitchInRadians}get pitch(){return this._pitchInRadians/Math.PI*180}setPitch(i){const l=o.ag(i,this.minPitch,this.maxPitch)/180*Math.PI;this._pitchInRadians!==l&&(this._unmodified=!1,this._pitchInRadians=l,this._calcMatrices())}get rollInRadians(){return this._rollInRadians}get roll(){return this._rollInRadians/Math.PI*180}setRoll(i){const l=i/180*Math.PI;this._rollInRadians!==l&&(this._unmodified=!1,this._rollInRadians=l,this._calcMatrices())}get fovInRadians(){return this._fovInRadians}get fov(){return o.aO(this._fovInRadians)}setFov(i){i=o.ag(i,.1,150),this.fov!==i&&(this._unmodified=!1,this._fovInRadians=o.ad(i),this._calcMatrices())}get zoom(){return this._zoom}setZoom(i){const l=this.getConstrained(this._center,i).zoom;this._zoom!==l&&(this._unmodified=!1,this._zoom=l,this._tileZoom=Math.max(0,Math.floor(l)),this._scale=o.ae(l),this._constrain(),this._calcMatrices())}get center(){return this._center}setCenter(i){i.lat===this._center.lat&&i.lng===this._center.lng||(this._unmodified=!1,this._center=i,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}setElevation(i){i!==this._elevation&&(this._elevation=i,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}setPadding(i){this._edgeInsets.equals(i)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,i,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this._width,this._height)}get pixelsPerMeter(){return this._pixelPerMeter}get unmodified(){return this._unmodified}get cameraToCenterDistance(){return this._cameraToCenterDistance}get nearZ(){return this._nearZ}get farZ(){return this._farZ}get autoCalculateNearFarZ(){return this._autoCalculateNearFarZ}overrideNearFarZ(i,l){this._autoCalculateNearFarZ=!1,this._nearZ=i,this._farZ=l,this._calcMatrices()}clearNearFarZOverride(){this._autoCalculateNearFarZ=!0,this._calcMatrices()}isPaddingEqual(i){return this._edgeInsets.equals(i)}interpolatePadding(i,l,f){this._unmodified=!1,this._edgeInsets.interpolate(i,l,f),this._constrain(),this._calcMatrices()}resize(i,l,f=!0){this._width=i,this._height=l,f&&this._constrain(),this._calcMatrices()}getMaxBounds(){return this._latRange&&this._latRange.length===2&&this._lngRange&&this._lngRange.length===2?new zt([this._lngRange[0],this._latRange[0]],[this._lngRange[1],this._latRange[1]]):null}setMaxBounds(i){i?(this._lngRange=[i.getWest(),i.getEast()],this._latRange=[i.getSouth(),i.getNorth()],this._constrain()):(this._lngRange=null,this._latRange=[-o.ah,o.ah])}getConstrained(i,l){return this._callbacks.getConstrained(i,l)}getCameraQueryGeometry(i,l){if(l.length===1)return[l[0],i];{const{minX:f,minY:g,maxX:y,maxY:x}=o.a1.fromPoints(l).extend(i);return[new o.P(f,g),new o.P(y,g),new o.P(y,x),new o.P(f,x),new o.P(f,g)]}}_constrain(){if(!this.center||!this._width||!this._height||this._constraining)return;this._constraining=!0;const i=this._unmodified,{center:l,zoom:f}=this.getConstrained(this.center,this.zoom);this.setCenter(l),this.setZoom(f),this._unmodified=i,this._constraining=!1}_calcMatrices(){if(this._width&&this._height){this._pixelsToGLUnits=[2/this._width,-2/this._height];let i=o.af(new Float64Array(16));o.N(i,i,[this._width/2,-this._height/2,1]),o.M(i,i,[1,-1,0]),this._clipSpaceToPixelsMatrix=i,i=o.af(new Float64Array(16)),o.N(i,i,[1,-1,1]),o.M(i,i,[-1,-1,0]),o.N(i,i,[2/this._width,2/this._height,1]),this._pixelsToClipSpaceMatrix=i,this._cameraToCenterDistance=.5/Math.tan(this.fovInRadians/2)*this._height}this._callbacks.calcMatrices()}calculateCenterFromCameraLngLatAlt(i,l,f,g){const y=f!==void 0?f:this.bearing,x=g=g!==void 0?g:this.pitch,S=o.a0.fromLngLat(i,l),I=-Math.cos(o.ad(x)),M=Math.sin(o.ad(x)),k=M*Math.sin(o.ad(y)),B=-M*Math.cos(o.ad(y));let F=this.elevation;const N=l-F;let W;I*N>=0||Math.abs(I)<.1?(W=1e4,F=l+W*I):W=-N/I;let J,G,Q=o.aP(1,S.y),re=0;do{if(re+=1,re>10)break;G=W/Q,J=new o.a0(S.x+k*G,S.y+B*G),Q=1/J.meterInMercatorCoordinateUnits()}while(Math.abs(W-G*Q)>1e-12);return{center:J.toLngLat(),elevation:F,zoom:o.aj(this.height/2/Math.tan(this.fovInRadians/2)/G/this.tileSize)}}recalculateZoomAndCenter(i){if(this.elevation-i==0)return;const l=o.ai(1,this.center.lat)*this.worldSize,f=this.cameraToCenterDistance/l,g=o.a0.fromLngLat(this.center,this.elevation),y=ce(this.center,this.elevation,this.pitch,this.bearing,f);this._elevation=i;const x=this.calculateCenterFromCameraLngLatAlt(y.toLngLat(),o.aP(y.z,g.y),this.bearing,this.pitch);this._elevation=x.elevation,this._center=x.center,this.setZoom(x.zoom)}getCameraPoint(){const i=Math.tan(this.pitchInRadians)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new o.P(i*Math.sin(this.rollInRadians),i*Math.cos(this.rollInRadians)))}getCameraAltitude(){return Math.cos(this.pitchInRadians)*this._cameraToCenterDistance/this._pixelPerMeter+this.elevation}getCameraLngLat(){const i=o.ai(1,this.center.lat)*this.worldSize;return ce(this.center,this.elevation,this.pitch,this.bearing,this.cameraToCenterDistance/i).toLngLat()}getMercatorTileCoordinates(i){if(!i)return[0,0,1,1];const l=i.canonical.z>=0?1<<i.canonical.z:Math.pow(2,i.canonical.z);return[i.canonical.x/l,i.canonical.y/l,1/l/o.$,1/l/o.$]}}class qa{constructor(i,l){this.min=i,this.max=l,this.center=o.aQ([],o.aR([],this.min,this.max),.5)}quadrant(i){const l=[i%2==0,i<2],f=o.aS(this.min),g=o.aS(this.max);for(let y=0;y<l.length;y++)f[y]=l[y]?this.min[y]:this.center[y],g[y]=l[y]?this.center[y]:this.max[y];return g[2]=this.max[2],new qa(f,g)}distanceX(i){return Math.max(Math.min(this.max[0],i[0]),this.min[0])-i[0]}distanceY(i){return Math.max(Math.min(this.max[1],i[1]),this.min[1])-i[1]}intersectsFrustum(i){let l=!0;for(let f=0;f<i.planes.length;f++){const g=this.intersectsPlane(i.planes[f]);if(g===0)return 0;g===1&&(l=!1)}return l?2:i.aabb.min[0]>this.max[0]||i.aabb.min[1]>this.max[1]||i.aabb.min[2]>this.max[2]||i.aabb.max[0]<this.min[0]||i.aabb.max[1]<this.min[1]||i.aabb.max[2]<this.min[2]?0:1}intersectsPlane(i){let l=i[3],f=i[3];for(let g=0;g<3;g++)i[g]>0?(l+=i[g]*this.min[g],f+=i[g]*this.max[g]):(f+=i[g]*this.min[g],l+=i[g]*this.max[g]);return l>=0?2:f<0?0:1}}class yc{distanceToTile2d(i,l,f,g){const y=g.distanceX([i,l]),x=g.distanceY([i,l]);return Math.hypot(y,x)}getWrap(i,l,f){return f}getTileBoundingVolume(i,l,f,g){var y,x;let S=f,I=f;if(g?.terrain){const k=new o.Z(i.z,l,i.z,i.x,i.y),B=g.terrain.getMinMaxElevation(k);S=(y=B.minElevation)!==null&&y!==void 0?y:f,I=(x=B.maxElevation)!==null&&x!==void 0?x:f}const M=1<<i.z;return new qa([l+i.x/M,i.y/M,S],[l+(i.x+1)/M,(i.y+1)/M,I])}allowVariableZoom(i,l){const f=i.fov*(Math.abs(Math.cos(i.rollInRadians))*i.height+Math.abs(Math.sin(i.rollInRadians))*i.width)/i.height,g=o.ag(78.5-f/2,0,60);return!!l.terrain||i.pitch>g}allowWorldCopies(){return!0}prepareNextFrame(){}}class Di{constructor(i,l,f){this.points=i,this.planes=l,this.aabb=f}static fromInvProjectionMatrix(i,l=1,f=0,g,y){const x=y?[[6,5,4],[0,1,2],[0,3,7],[2,1,5],[3,2,6],[0,4,5]]:[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]],S=Math.pow(2,f),I=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(F=>function(N,W,J,G){const Q=o.av([],N,W),re=1/Q[3]/J*G;return o.aX(Q,Q,[re,re,1/Q[3],re])}(F,i,l,S));g&&function(F,N,W,J){const G=J?4:0,Q=J?0:4;let re=0;const ae=[],se=[];for(let oe=0;oe<4;oe++){const ye=o.aT([],F[oe+Q],F[oe+G]),Oe=o.aY(ye);o.aQ(ye,ye,1/Oe),ae.push(Oe),se.push(ye)}for(let oe=0;oe<4;oe++){const ye=o.aZ(F[oe+G],se[oe],W);re=ye!==null&&ye>=0?Math.max(re,ye):Math.max(re,ae[oe])}const ue=function(oe,ye){const Oe=o.aT([],oe[ye[0]],oe[ye[1]]),Ce=o.aT([],oe[ye[2]],oe[ye[1]]),Me=[0,0,0,0];return o.aU(Me,o.aV([],Oe,Ce)),Me[3]=-o.aW(Me,oe[ye[0]]),Me}(F,N),de=function(oe,ye){const Oe=o.a_(oe),Ce=o.a$([],oe,1/Oe),Me=o.aT([],ye,o.aQ([],Ce,o.aW(ye,Ce))),Fe=o.a_(Me);if(Fe>0){const nt=Math.sqrt(1-Ce[3]*Ce[3]),it=o.aQ([],Ce,-Ce[3]),qe=o.aR([],it,o.aQ([],Me,nt/Fe));return o.b0(ye,qe)}return null}(W,ue);if(de!==null){const oe=de/o.aW(se[0],ue);re=Math.min(re,oe)}for(let oe=0;oe<4;oe++){const ye=Math.min(re,ae[oe]);F[oe+Q]=[F[oe+G][0]+se[oe][0]*ye,F[oe+G][1]+se[oe][1]*ye,F[oe+G][2]+se[oe][2]*ye,1]}}(I,x[0],g,y);const M=x.map(F=>{const N=o.aT([],I[F[0]],I[F[1]]),W=o.aT([],I[F[2]],I[F[1]]),J=o.aU([],o.aV([],N,W)),G=-o.aW(J,I[F[1]]);return J.concat(G)}),k=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],B=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(const F of I)for(let N=0;N<3;N++)k[N]=Math.min(k[N],F[N]),B[N]=Math.max(B[N],F[N]);return new Di(I,M,new qa(k,B))}}class Gr{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(i){this._helper.setMinZoom(i)}setMaxZoom(i){this._helper.setMaxZoom(i)}setMinPitch(i){this._helper.setMinPitch(i)}setMaxPitch(i){this._helper.setMaxPitch(i)}setRenderWorldCopies(i){this._helper.setRenderWorldCopies(i)}setBearing(i){this._helper.setBearing(i)}setPitch(i){this._helper.setPitch(i)}setRoll(i){this._helper.setRoll(i)}setFov(i){this._helper.setFov(i)}setZoom(i){this._helper.setZoom(i)}setCenter(i){this._helper.setCenter(i)}setElevation(i){this._helper.setElevation(i)}setMinElevationForCurrentTile(i){this._helper.setMinElevationForCurrentTile(i)}setPadding(i){this._helper.setPadding(i)}interpolatePadding(i,l,f){return this._helper.interpolatePadding(i,l,f)}isPaddingEqual(i){return this._helper.isPaddingEqual(i)}resize(i,l,f=!0){this._helper.resize(i,l,f)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(i){this._helper.setMaxBounds(i)}overrideNearFarZ(i,l){this._helper.overrideNearFarZ(i,l)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(i){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),i)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(i,l){}constructor(i,l,f,g,y){this._posMatrixCache=new Map,this._alignedPosMatrixCache=new Map,this._fogMatrixCacheF32=new Map,this._helper=new jo({calcMatrices:()=>{this._calcMatrices()},getConstrained:(x,S)=>this.getConstrained(x,S)},i,l,f,g,y),this._coveringTilesDetailsProvider=new yc}clone(){const i=new Gr;return i.apply(this),i}apply(i,l,f){this._helper.apply(i,l,f)}get cameraPosition(){return this._cameraPosition}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._viewProjMatrix}get inverseProjectionMatrix(){return this._invProjMatrix}get mercatorMatrix(){return this._mercatorMatrix}getVisibleUnwrappedCoordinates(i){const l=[new o.b1(0,i)];if(this._helper._renderWorldCopies){const f=this.screenPointToMercatorCoordinate(new o.P(0,0)),g=this.screenPointToMercatorCoordinate(new o.P(this._helper._width,0)),y=this.screenPointToMercatorCoordinate(new o.P(this._helper._width,this._helper._height)),x=this.screenPointToMercatorCoordinate(new o.P(0,this._helper._height)),S=Math.floor(Math.min(f.x,g.x,y.x,x.x)),I=Math.floor(Math.max(f.x,g.x,y.x,x.x)),M=1;for(let k=S-M;k<=I+M;k++)k!==0&&l.push(new o.b1(k,i))}return l}getCameraFrustum(){return Di.fromInvProjectionMatrix(this._invViewProjMatrix,this.worldSize)}getClippingPlane(){return null}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(i){const l=this.screenPointToLocation(this.centerPoint,i),f=i?i.getElevationForLngLatZoom(l,this._helper._tileZoom):0;this._helper.recalculateZoomAndCenter(f)}setLocationAtPoint(i,l){const f=o.ai(this.elevation,this.center.lat),g=this.screenPointToMercatorCoordinateAtZ(l,f),y=this.screenPointToMercatorCoordinateAtZ(this.centerPoint,f),x=o.a0.fromLngLat(i),S=new o.a0(x.x-(g.x-y.x),x.y-(g.y-y.y));this.setCenter(S?.toLngLat()),this._helper._renderWorldCopies&&this.setCenter(this.center.wrap())}locationToScreenPoint(i,l){return l?this.coordinatePoint(o.a0.fromLngLat(i),l.getElevationForLngLatZoom(i,this._helper._tileZoom),this._pixelMatrix3D):this.coordinatePoint(o.a0.fromLngLat(i))}screenPointToLocation(i,l){var f;return(f=this.screenPointToMercatorCoordinate(i,l))===null||f===void 0?void 0:f.toLngLat()}screenPointToMercatorCoordinate(i,l){if(l){const f=l.pointCoordinate(i);if(f!=null)return f}return this.screenPointToMercatorCoordinateAtZ(i)}screenPointToMercatorCoordinateAtZ(i,l){const f=l||0,g=[i.x,i.y,0,1],y=[i.x,i.y,1,1];o.av(g,g,this._pixelMatrixInverse),o.av(y,y,this._pixelMatrixInverse);const x=g[3],S=y[3],I=g[1]/x,M=y[1]/S,k=g[2]/x,B=y[2]/S,F=k===B?0:(f-k)/(B-k);return new o.a0(o.C.number(g[0]/x,y[0]/S,F)/this.worldSize,o.C.number(I,M,F)/this.worldSize,f)}coordinatePoint(i,l=0,f=this._pixelMatrix){const g=[i.x*this.worldSize,i.y*this.worldSize,l,1];return o.av(g,g,f),new o.P(g[0]/g[3],g[1]/g[3])}getBounds(){const i=Math.max(0,this._helper._height/2-X(this));return new zt().extend(this.screenPointToLocation(new o.P(0,i))).extend(this.screenPointToLocation(new o.P(this._helper._width,i))).extend(this.screenPointToLocation(new o.P(this._helper._width,this._helper._height))).extend(this.screenPointToLocation(new o.P(0,this._helper._height)))}isPointOnMapSurface(i,l){return l?l.pointCoordinate(i)!=null:i.y>this.height/2-X(this)}calculatePosMatrix(i,l=!1,f){var g;const y=(g=i.key)!==null&&g!==void 0?g:o.b2(i.wrap,i.canonical.z,i.canonical.z,i.canonical.x,i.canonical.y),x=l?this._alignedPosMatrixCache:this._posMatrixCache;if(x.has(y)){const M=x.get(y);return f?M.f32:M.f64}const S=K(i,this.worldSize);o.O(S,l?this._alignedProjMatrix:this._viewProjMatrix,S);const I={f64:S,f32:new Float32Array(S)};return x.set(y,I),f?I.f32:I.f64}calculateFogMatrix(i){const l=i.key,f=this._fogMatrixCacheF32;if(f.has(l))return f.get(l);const g=K(i,this.worldSize);return o.O(g,this._fogMatrix,g),f.set(l,new Float32Array(g)),f.get(l)}getConstrained(i,l){l=o.ag(+l,this.minZoom,this.maxZoom);const f={center:new o.S(i.lng,i.lat),zoom:l};let g=this._helper._lngRange;if(!this._helper._renderWorldCopies&&g===null){const ae=179.9999999999;g=[-ae,ae]}const y=this.tileSize*o.ae(f.zoom);let x=0,S=y,I=0,M=y,k=0,B=0;const{x:F,y:N}=this.size;if(this._helper._latRange){const ae=this._helper._latRange;x=o.U(ae[1])*y,S=o.U(ae[0])*y,S-x<N&&(k=N/(S-x))}g&&(I=o.aN(o.V(g[0])*y,0,y),M=o.aN(o.V(g[1])*y,0,y),M<I&&(M+=y),M-I<F&&(B=F/(M-I)));const{x:W,y:J}=be(y,i);let G,Q;const re=Math.max(B||0,k||0);if(re){const ae=new o.P(B?(M+I)/2:W,k?(S+x)/2:J);return f.center=Z(y,ae).wrap(),f.zoom+=o.aj(re),f}if(this._helper._latRange){const ae=N/2;J-ae<x&&(Q=x+ae),J+ae>S&&(Q=S-ae)}if(g){const ae=(I+M)/2;let se=W;this._helper._renderWorldCopies&&(se=o.aN(W,ae-y/2,ae+y/2));const ue=F/2;se-ue<I&&(G=I+ue),se+ue>M&&(G=M-ue)}if(G!==void 0||Q!==void 0){const ae=new o.P(G??W,Q??J);f.center=Z(y,ae).wrap()}return f}calculateCenterFromCameraLngLatAlt(i,l,f,g){return this._helper.calculateCenterFromCameraLngLatAlt(i,l,f,g)}_calculateNearFarZIfNeeded(i,l,f){if(!this._helper.autoCalculateNearFarZ)return;const g=Math.min(this.elevation,this.minElevationForCurrentTile,this.getCameraAltitude()-100),y=i-g*this._helper._pixelPerMeter/Math.cos(l),x=g<0?y:i,S=Math.PI/2+this.pitchInRadians,I=o.ad(this.fov)*(Math.abs(Math.cos(o.ad(this.roll)))*this.height+Math.abs(Math.sin(o.ad(this.roll)))*this.width)/this.height*(.5+f.y/this.height),M=Math.sin(I)*x/Math.sin(o.ag(Math.PI-S-I,.01,Math.PI-.01)),k=X(this),B=Math.atan(k/this._helper.cameraToCenterDistance),F=o.ad(.75),N=B>F?2*B*(.5+f.y/(2*k)):F,W=Math.sin(N)*x/Math.sin(o.ag(Math.PI-S-N,.01,Math.PI-.01)),J=Math.min(M,W);this._helper._farZ=1.01*(Math.cos(Math.PI/2-l)*J+x),this._helper._nearZ=this._helper._height/50}_calcMatrices(){if(!this._helper._height)return;const i=this.centerOffset,l=be(this.worldSize,this.center),f=l.x,g=l.y;this._helper._pixelPerMeter=o.ai(1,this.center.lat)*this.worldSize;const y=o.ad(Math.min(this.pitch,ki)),x=Math.max(this._helper.cameraToCenterDistance/2,this._helper.cameraToCenterDistance+this._helper._elevation*this._helper._pixelPerMeter/Math.cos(y));let S;this._calculateNearFarZIfNeeded(x,y,i),S=new Float64Array(16),o.b3(S,this.fovInRadians,this._helper._width/this._helper._height,this._helper._nearZ,this._helper._farZ),this._invProjMatrix=new Float64Array(16),o.ap(this._invProjMatrix,S),S[8]=2*-i.x/this._helper._width,S[9]=2*i.y/this._helper._height,this._projectionMatrix=o.b4(S),o.N(S,S,[1,-1,1]),o.M(S,S,[0,0,-this._helper.cameraToCenterDistance]),o.b5(S,S,-this.rollInRadians),o.b6(S,S,this.pitchInRadians),o.b5(S,S,-this.bearingInRadians),o.M(S,S,[-f,-g,0]),this._mercatorMatrix=o.N([],S,[this.worldSize,this.worldSize,this.worldSize]),o.N(S,S,[1,1,this._helper._pixelPerMeter]),this._pixelMatrix=o.O(new Float64Array(16),this.clipSpaceToPixelsMatrix,S),o.M(S,S,[0,0,-this.elevation]),this._viewProjMatrix=S,this._invViewProjMatrix=o.ap([],S);const I=[0,0,-1,1];o.av(I,I,this._invViewProjMatrix),this._cameraPosition=[I[0]/I[3],I[1]/I[3],I[2]/I[3]],this._fogMatrix=new Float64Array(16),o.b3(this._fogMatrix,this.fovInRadians,this.width/this.height,x,this._helper._farZ),this._fogMatrix[8]=2*-i.x/this.width,this._fogMatrix[9]=2*i.y/this.height,o.N(this._fogMatrix,this._fogMatrix,[1,-1,1]),o.M(this._fogMatrix,this._fogMatrix,[0,0,-this.cameraToCenterDistance]),o.b5(this._fogMatrix,this._fogMatrix,-this.rollInRadians),o.b6(this._fogMatrix,this._fogMatrix,this.pitchInRadians),o.b5(this._fogMatrix,this._fogMatrix,-this.bearingInRadians),o.M(this._fogMatrix,this._fogMatrix,[-f,-g,0]),o.N(this._fogMatrix,this._fogMatrix,[1,1,this._helper._pixelPerMeter]),o.M(this._fogMatrix,this._fogMatrix,[0,0,-this.elevation]),this._pixelMatrix3D=o.O(new Float64Array(16),this.clipSpaceToPixelsMatrix,S);const M=this._helper._width%2/2,k=this._helper._height%2/2,B=Math.cos(this.bearingInRadians),F=Math.sin(-this.bearingInRadians),N=f-Math.round(f)+B*M+F*k,W=g-Math.round(g)+B*k+F*M,J=new Float64Array(S);if(o.M(J,J,[N>.5?N-1:N,W>.5?W-1:W,0]),this._alignedProjMatrix=J,S=o.ap(new Float64Array(16),this._pixelMatrix),!S)throw new Error("failed to invert matrix");this._pixelMatrixInverse=S,this._clearMatrixCaches()}_clearMatrixCaches(){this._posMatrixCache.clear(),this._alignedPosMatrixCache.clear(),this._fogMatrixCacheF32.clear()}maxPitchScaleFactor(){if(!this._pixelMatrixInverse)return 1;const i=this.screenPointToMercatorCoordinate(new o.P(0,0)),l=[i.x*this.worldSize,i.y*this.worldSize,0,1];return o.av(l,l,this._pixelMatrix)[3]/this._helper.cameraToCenterDistance}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){const i=o.ai(1,this.center.lat)*this.worldSize;return ce(this.center,this.elevation,this.pitch,this.bearing,this._helper.cameraToCenterDistance/i).toLngLat()}lngLatToCameraDepth(i,l){const f=o.a0.fromLngLat(i),g=[f.x*this.worldSize,f.y*this.worldSize,l,1];return o.av(g,g,this._viewProjMatrix),g[2]/g[3]}getProjectionData(i){const{overscaledTileID:l,aligned:f,applyTerrainMatrix:g}=i,y=this._helper.getMercatorTileCoordinates(l),x=l?this.calculatePosMatrix(l,f,!0):null;let S;return S=l&&l.terrainRttPosMatrix32f&&g?l.terrainRttPosMatrix32f:x||o.b7(),{mainMatrix:S,tileMercatorCoords:y,clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:S}}isLocationOccluded(i){return!1}getPixelScale(){return 1}getCircleRadiusCorrection(){return 1}getPitchedTextCorrection(i,l,f){return 1}transformLightDirection(i){return o.aS(i)}getRayDirectionFromPixel(i){throw new Error("Not implemented.")}projectTileCoordinates(i,l,f,g){const y=this.calculatePosMatrix(f);let x;g?(x=[i,l,g(i,l),1],o.av(x,x,y)):(x=[i,l,0,1],Is(x,x,y));const S=x[3];return{point:new o.P(x[0]/S,x[1]/S),signedDistanceFromCamera:S,isOccluded:!1}}populateCache(i){for(const l of i)this.calculatePosMatrix(l)}getMatrixForModel(i,l){const f=o.a0.fromLngLat(i,l),g=f.meterInMercatorCoordinateUnits(),y=o.b8();return o.M(y,y,[f.x,f.y,f.z]),o.b5(y,y,Math.PI),o.b6(y,y,Math.PI/2),o.N(y,y,[-g,g,g]),y}getProjectionDataForCustomLayer(i=!0){const l=new o.Z(0,0,0,0,0),f=this.getProjectionData({overscaledTileID:l,applyGlobeMatrix:i}),g=K(l,this.worldSize);o.O(g,this._viewProjMatrix,g),f.tileMercatorCoords=[0,0,1,1];const y=[o.$,o.$,this.worldSize/this._helper.pixelsPerMeter],x=o.b9();return o.N(x,g,y),f.fallbackMatrix=x,f.mainMatrix=x,f}getFastPathSimpleProjectionMatrix(i){return this.calculatePosMatrix(i)}}function Oi(){o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}function li(_){if(_.useSlerp)if(_.k<1){const i=o.ba(_.startEulerAngles.roll,_.startEulerAngles.pitch,_.startEulerAngles.bearing),l=o.ba(_.endEulerAngles.roll,_.endEulerAngles.pitch,_.endEulerAngles.bearing),f=new Float64Array(4);o.bb(f,i,l,_.k);const g=o.bc(f);_.tr.setRoll(g.roll),_.tr.setPitch(g.pitch),_.tr.setBearing(g.bearing)}else _.tr.setRoll(_.endEulerAngles.roll),_.tr.setPitch(_.endEulerAngles.pitch),_.tr.setBearing(_.endEulerAngles.bearing);else _.tr.setRoll(o.C.number(_.startEulerAngles.roll,_.endEulerAngles.roll,_.k)),_.tr.setPitch(o.C.number(_.startEulerAngles.pitch,_.endEulerAngles.pitch,_.k)),_.tr.setBearing(o.C.number(_.startEulerAngles.bearing,_.endEulerAngles.bearing,_.k))}function Fr(_,i,l,f,g){const y=g.padding,x=be(g.worldSize,l.getNorthWest()),S=be(g.worldSize,l.getNorthEast()),I=be(g.worldSize,l.getSouthEast()),M=be(g.worldSize,l.getSouthWest()),k=o.ad(-f),B=x.rotate(k),F=S.rotate(k),N=I.rotate(k),W=M.rotate(k),J=new o.P(Math.max(B.x,F.x,W.x,N.x),Math.max(B.y,F.y,W.y,N.y)),G=new o.P(Math.min(B.x,F.x,W.x,N.x),Math.min(B.y,F.y,W.y,N.y)),Q=J.sub(G),re=(g.width-(y.left+y.right+i.left+i.right))/Q.x,ae=(g.height-(y.top+y.bottom+i.top+i.bottom))/Q.y;if(ae<0||re<0)return void Oi();const se=Math.min(o.aj(g.scale*Math.min(re,ae)),_.maxZoom),ue=o.P.convert(_.offset),de=new o.P((i.left-i.right)/2,(i.top-i.bottom)/2).rotate(o.ad(f)),oe=ue.add(de).mult(g.scale/o.ae(se));return{center:Z(g.worldSize,x.add(I).div(2).sub(oe)),zoom:se,bearing:f}}class Ya{get useGlobeControls(){return!1}handlePanInertia(i,l){return{easingOffset:i,easingCenter:l.center}}handleMapControlsRollPitchBearingZoom(i,l){i.bearingDelta&&l.setBearing(l.bearing+i.bearingDelta),i.pitchDelta&&l.setPitch(l.pitch+i.pitchDelta),i.rollDelta&&l.setRoll(l.roll+i.rollDelta),i.zoomDelta&&l.setZoom(l.zoom+i.zoomDelta)}handleMapControlsPan(i,l,f){i.around.distSqr(l.centerPoint)<.01||l.setLocationAtPoint(f,i.around)}cameraForBoxAndBearing(i,l,f,g,y){return Fr(i,l,f,g,y)}handleJumpToCenterZoom(i,l){i.zoom!==(l.zoom!==void 0?+l.zoom:i.zoom)&&i.setZoom(+l.zoom),l.center!==void 0&&i.setCenter(o.S.convert(l.center))}handleEaseTo(i,l){const f=i.zoom,g=i.padding,y={roll:i.roll,pitch:i.pitch,bearing:i.bearing},x={roll:l.roll===void 0?i.roll:l.roll,pitch:l.pitch===void 0?i.pitch:l.pitch,bearing:l.bearing===void 0?i.bearing:l.bearing},S=l.zoom!==void 0,I=!i.isPaddingEqual(l.padding);let M=!1;const k=S?+l.zoom:i.zoom;let B=i.centerPoint.add(l.offsetAsPoint);const F=i.screenPointToLocation(B),{center:N,zoom:W}=i.getConstrained(o.S.convert(l.center||F),k??f);Wn(i,N);const J=be(i.worldSize,F),G=be(i.worldSize,N).sub(J),Q=o.ae(W-f);return M=W!==f,{easeFunc:re=>{if(M&&i.setZoom(o.C.number(f,W,re)),o.bd(y,x)||li({startEulerAngles:y,endEulerAngles:x,tr:i,k:re,useSlerp:y.roll!=x.roll}),I&&(i.interpolatePadding(g,l.padding,re),B=i.centerPoint.add(l.offsetAsPoint)),l.around)i.setLocationAtPoint(l.around,l.aroundPoint);else{const ae=o.ae(i.zoom-f),se=W>f?Math.min(2,Q):Math.max(.5,Q),ue=Math.pow(se,1-re),de=Z(i.worldSize,J.add(G.mult(re*ue)).mult(ae));i.setLocationAtPoint(i.renderWorldCopies?de.wrap():de,B)}},isZooming:M,elevationCenter:N}}handleFlyTo(i,l){const f=l.zoom!==void 0,g=i.zoom,y=i.getConstrained(o.S.convert(l.center||l.locationAtOffset),f?+l.zoom:g),x=y.center,S=y.zoom;Wn(i,x);const I=be(i.worldSize,l.locationAtOffset),M=be(i.worldSize,x).sub(I),k=M.mag(),B=o.ae(S-g);let F;if(l.minZoom!==void 0){const N=Math.min(+l.minZoom,g,S),W=i.getConstrained(x,N).zoom;F=o.ae(W-g)}return{easeFunc:(N,W,J,G)=>{i.setZoom(N===1?S:g+o.aj(W));const Q=N===1?x:Z(i.worldSize,I.add(M.mult(J)).mult(W));i.setLocationAtPoint(i.renderWorldCopies?Q.wrap():Q,G)},scaleOfZoom:B,targetCenter:x,scaleOfMinZoom:F,pixelPathLength:k}}}class tr{constructor(i,l,f){this.blendFunction=i,this.blendColor=l,this.mask=f}}tr.Replace=[1,0],tr.disabled=new tr(tr.Replace,o.be.transparent,[!1,!1,!1,!1]),tr.unblended=new tr(tr.Replace,o.be.transparent,[!0,!0,!0,!0]),tr.alphaBlended=new tr([1,771],o.be.transparent,[!0,!0,!0,!0]);const Hi=2305;class Ft{constructor(i,l,f){this.enable=i,this.mode=l,this.frontFace=f}}Ft.disabled=new Ft(!1,1029,Hi),Ft.backCCW=new Ft(!0,1029,Hi),Ft.frontCCW=new Ft(!0,1028,Hi);class Lt{constructor(i,l,f){this.func=i,this.mask=l,this.range=f}}Lt.ReadOnly=!1,Lt.ReadWrite=!0,Lt.disabled=new Lt(519,Lt.ReadOnly,[0,1]);const Ms=7680;class Pt{constructor(i,l,f,g,y,x){this.test=i,this.ref=l,this.mask=f,this.fail=g,this.depthFail=y,this.pass=x}}Pt.disabled=new Pt({func:519,mask:0},0,0,Ms,Ms,Ms);const Rs=new WeakMap;function zi(_){var i;if(Rs.has(_))return Rs.get(_);{const l=(i=_.getParameter(_.VERSION))===null||i===void 0?void 0:i.startsWith("WebGL 2.0");return Rs.set(_,l),l}}class qs{get awaitingQuery(){return!!this._readbackQueue}constructor(i){this._readbackWaitFrames=4,this._measureWaitFrames=6,this._texWidth=1,this._texHeight=1,this._measuredError=0,this._updateCount=0,this._lastReadbackFrame=-1e3,this._readbackQueue=null,this._cachedRenderContext=i;const l=i.context,f=l.gl;this._texFormat=f.RGBA,this._texType=f.UNSIGNED_BYTE;const g=new o.aK;g.emplaceBack(-1,-1),g.emplaceBack(2,-1),g.emplaceBack(-1,2);const y=new o.aM;y.emplaceBack(0,1,2),this._fullscreenTriangle=new jn(l.createVertexBuffer(g,$n.members),l.createIndexBuffer(y),o.aL.simpleSegment(0,0,g.length,y.length)),this._resultBuffer=new Uint8Array(4),l.activeTexture.set(f.TEXTURE1);const x=f.createTexture();f.bindTexture(f.TEXTURE_2D,x),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texImage2D(f.TEXTURE_2D,0,this._texFormat,this._texWidth,this._texHeight,0,this._texFormat,this._texType,null),this._fbo=l.createFramebuffer(this._texWidth,this._texHeight,!1,!1),this._fbo.colorAttachment.set(x),zi(f)&&(this._pbo=f.createBuffer(),f.bindBuffer(f.PIXEL_PACK_BUFFER,this._pbo),f.bufferData(f.PIXEL_PACK_BUFFER,4,f.STREAM_READ),f.bindBuffer(f.PIXEL_PACK_BUFFER,null))}destroy(){const i=this._cachedRenderContext.context.gl;this._fullscreenTriangle.destroy(),this._fbo.destroy(),i.deleteBuffer(this._pbo),this._fullscreenTriangle=null,this._fbo=null,this._pbo=null,this._resultBuffer=null}updateErrorLoop(i,l){const f=this._updateCount;return this._readbackQueue?f>=this._readbackQueue.frameNumberIssued+this._readbackWaitFrames&&this._tryReadback():f>=this._lastReadbackFrame+this._measureWaitFrames&&this._renderErrorTexture(i,l),this._updateCount++,this._measuredError}_bindFramebuffer(){const i=this._cachedRenderContext.context,l=i.gl;i.activeTexture.set(l.TEXTURE1),l.bindTexture(l.TEXTURE_2D,this._fbo.colorAttachment.get()),i.bindFramebuffer.set(this._fbo.framebuffer)}_renderErrorTexture(i,l){const f=this._cachedRenderContext.context,g=f.gl;if(this._bindFramebuffer(),f.viewport.set([0,0,this._texWidth,this._texHeight]),f.clear({color:o.be.transparent}),this._cachedRenderContext.useProgram("projectionErrorMeasurement").draw(f,g.TRIANGLES,Lt.disabled,Pt.disabled,tr.unblended,Ft.disabled,((y,x)=>({u_input:y,u_output_expected:x}))(i,l),null,null,"$clipping",this._fullscreenTriangle.vertexBuffer,this._fullscreenTriangle.indexBuffer,this._fullscreenTriangle.segments),this._pbo&&zi(g)){g.bindBuffer(g.PIXEL_PACK_BUFFER,this._pbo),g.readBuffer(g.COLOR_ATTACHMENT0),g.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,0),g.bindBuffer(g.PIXEL_PACK_BUFFER,null);const y=g.fenceSync(g.SYNC_GPU_COMMANDS_COMPLETE,0);g.flush(),this._readbackQueue={frameNumberIssued:this._updateCount,sync:y}}else this._readbackQueue={frameNumberIssued:this._updateCount,sync:null}}_tryReadback(){const i=this._cachedRenderContext.context.gl;if(this._pbo&&this._readbackQueue&&zi(i)){const l=i.clientWaitSync(this._readbackQueue.sync,0,0);if(l===i.WAIT_FAILED)return o.w("WebGL2 clientWaitSync failed."),this._readbackQueue=null,void(this._lastReadbackFrame=this._updateCount);if(l===i.TIMEOUT_EXPIRED)return;i.bindBuffer(i.PIXEL_PACK_BUFFER,this._pbo),i.getBufferSubData(i.PIXEL_PACK_BUFFER,0,this._resultBuffer,0,4),i.bindBuffer(i.PIXEL_PACK_BUFFER,null)}else this._bindFramebuffer(),i.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,this._resultBuffer);this._readbackQueue=null,this._measuredError=qs._parseRGBA8float(this._resultBuffer),this._lastReadbackFrame=this._updateCount}static _parseRGBA8float(i){let l=0;return l+=i[0]/256,l+=i[1]/65536,l+=i[2]/16777216,i[3]<127&&(l=-l),l/128}}const Zi=o.$/128;function bc(_,i){const l=_.granularity!==void 0?Math.max(_.granularity,1):1,f=l+(_.generateBorders?2:0),g=l+(_.extendToNorthPole||_.generateBorders?1:0)+(_.extendToSouthPole||_.generateBorders?1:0),y=f+1,x=g+1,S=_.generateBorders?-1:0,I=_.generateBorders||_.extendToNorthPole?-1:0,M=l+(_.generateBorders?1:0),k=l+(_.generateBorders||_.extendToSouthPole?1:0),B=y*x,F=f*g*6,N=y*x>65536;if(N&&i==="16bit")throw new Error("Granularity is too large and meshes would not fit inside 16 bit vertex indices.");const W=N||i==="32bit",J=new Int16Array(2*B);let G=0;for(let ae=I;ae<=k;ae++)for(let se=S;se<=M;se++){let ue=se/l*o.$;se===-1&&(ue=-Zi),se===l+1&&(ue=o.$+Zi);let de=ae/l*o.$;ae===-1&&(de=_.extendToNorthPole?o.bg:-Zi),ae===l+1&&(de=_.extendToSouthPole?o.bh:o.$+Zi),J[G++]=ue,J[G++]=de}const Q=W?new Uint32Array(F):new Uint16Array(F);let re=0;for(let ae=0;ae<g;ae++)for(let se=0;se<f;se++){const ue=se+1+ae*y,de=se+(ae+1)*y,oe=se+1+(ae+1)*y;Q[re++]=se+ae*y,Q[re++]=de,Q[re++]=ue,Q[re++]=ue,Q[re++]=de,Q[re++]=oe}return{vertices:J.buffer.slice(0),indices:Q.buffer.slice(0),uses32bitIndices:W}}const Pn=new o.aJ({fill:new o.bi(128,2),line:new o.bi(512,0),tile:new o.bi(128,32),stencil:new o.bi(128,1),circle:3});class uu{constructor(){this._tileMeshCache={},this._errorCorrectionUsable=0,this._errorMeasurementLastValue=0,this._errorCorrectionPreviousValue=0,this._errorMeasurementLastChangeTime=-1e3}get name(){return"vertical-perspective"}get transitionState(){return 1}get useSubdivision(){return!0}get shaderVariantName(){return"globe"}get shaderDefine(){return"#define GLOBE"}get shaderPreludeCode(){return Cn.projectionGlobe}get vertexShaderPreludeCode(){return Cn.projectionMercator.vertexSource}get subdivisionGranularity(){return Pn}get useGlobeControls(){return!0}get latitudeErrorCorrectionRadians(){return this._errorCorrectionUsable}destroy(){this._errorMeasurement&&this._errorMeasurement.destroy()}updateGPUdependent(i){this._errorMeasurement||(this._errorMeasurement=new qs(i));const l=o.U(this._errorQueryLatitudeDegrees),f=2*Math.atan(Math.exp(Math.PI-l*Math.PI*2))-.5*Math.PI,g=this._errorMeasurement.updateErrorLoop(l,f),y=$.now();g!==this._errorMeasurementLastValue&&(this._errorCorrectionPreviousValue=this._errorCorrectionUsable,this._errorMeasurementLastValue=g,this._errorMeasurementLastChangeTime=y);const x=Math.min(Math.max((y-this._errorMeasurementLastChangeTime)/1e3/.5,0),1);this._errorCorrectionUsable=o.bj(this._errorCorrectionPreviousValue,-this._errorMeasurementLastValue,o.bk(x))}_getMeshKey(i){return`${i.granularity.toString(36)}_${i.generateBorders?"b":""}${i.extendToNorthPole?"n":""}${i.extendToSouthPole?"s":""}`}getMeshFromTileID(i,l,f,g,y){const x=(y==="stencil"?Pn.stencil:Pn.tile).getGranularityForZoomLevel(l.z);return this._getMesh(i,{granularity:x,generateBorders:f,extendToNorthPole:l.y===0&&g,extendToSouthPole:l.y===(1<<l.z)-1&&g})}_getMesh(i,l){const f=this._getMeshKey(l);if(f in this._tileMeshCache)return this._tileMeshCache[f];const g=function(y,x){const S=bc(x,"16bit"),I=o.aK.deserialize({arrayBuffer:S.vertices,length:S.vertices.byteLength/2/2}),M=o.aM.deserialize({arrayBuffer:S.indices,length:S.indices.byteLength/2/3});return new jn(y.createVertexBuffer(I,$n.members),y.createIndexBuffer(M),o.aL.simpleSegment(0,0,I.length,M.length))}(i,l);return this._tileMeshCache[f]=g,g}recalculate(i){}hasTransition(){const i=$.now();let l=!1;return l=l||(i-this._errorMeasurementLastChangeTime)/1e3<.7,l=l||this._errorMeasurement&&this._errorMeasurement.awaitingQuery,l}setErrorQueryLatitudeDegrees(i){this._errorQueryLatitudeDegrees=i}}const du=new o.r({type:new o.D(o.v.projection.type)});class $o extends o.E{constructor(i){super(),this._transitionable=new o.t(du),this.setProjection(i),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new o.F(0)),this._mercatorProjection=new _c,this._verticalPerspectiveProjection=new uu}get transitionState(){const i=this.properties.get("type");if(typeof i=="string"&&i==="mercator")return 0;if(typeof i=="string"&&i==="vertical-perspective")return 1;if(i instanceof o.bl){if(i.from==="vertical-perspective"&&i.to==="mercator")return 1-i.transition;if(i.from==="mercator"&&i.to==="vertical-perspective")return i.transition}return 1}get useGlobeRendering(){return this.transitionState>0}get latitudeErrorCorrectionRadians(){return this._verticalPerspectiveProjection.latitudeErrorCorrectionRadians}get currentProjection(){return this.useGlobeRendering?this._verticalPerspectiveProjection:this._mercatorProjection}get name(){return"globe"}get useSubdivision(){return this.currentProjection.useSubdivision}get shaderVariantName(){return this.currentProjection.shaderVariantName}get shaderDefine(){return this.currentProjection.shaderDefine}get shaderPreludeCode(){return this.currentProjection.shaderPreludeCode}get vertexShaderPreludeCode(){return this.currentProjection.vertexShaderPreludeCode}get subdivisionGranularity(){return this.currentProjection.subdivisionGranularity}get useGlobeControls(){return this.transitionState>0}destroy(){this._mercatorProjection.destroy(),this._verticalPerspectiveProjection.destroy()}updateGPUdependent(i){this._mercatorProjection.updateGPUdependent(i),this._verticalPerspectiveProjection.updateGPUdependent(i)}getMeshFromTileID(i,l,f,g,y){return this.currentProjection.getMeshFromTileID(i,l,f,g,y)}setProjection(i){this._transitionable.setValue("type",i?.type||"mercator")}updateTransitions(i){this._transitioning=this._transitionable.transitioned(i,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()||this.currentProjection.hasTransition()}recalculate(i){this.properties=this._transitioning.possiblyEvaluate(i)}setErrorQueryLatitudeDegrees(i){this._verticalPerspectiveProjection.setErrorQueryLatitudeDegrees(i),this._mercatorProjection.setErrorQueryLatitudeDegrees(i)}}function Wo(_){const i=Ys(_.worldSize,_.center.lat);return 2*Math.PI*i}function pn(_,i,l,f,g){const y=1/(1<<g),x=i/o.$*y+f*y,S=o.bn((_/o.$*y+l*y)*Math.PI*2+Math.PI,2*Math.PI),I=2*Math.atan(Math.exp(Math.PI-x*Math.PI*2))-.5*Math.PI,M=Math.cos(I),k=new Float64Array(3);return k[0]=Math.sin(S)*M,k[1]=Math.sin(I),k[2]=Math.cos(S)*M,k}function ci(_){return function(i,l){const f=Math.cos(l),g=new Float64Array(3);return g[0]=Math.sin(i)*f,g[1]=Math.sin(l),g[2]=Math.cos(i)*f,g}(_.lng*Math.PI/180,_.lat*Math.PI/180)}function Ys(_,i){return _/(2*Math.PI)/Math.cos(i*Math.PI/180)}function Ho(_){const i=Math.asin(_[1])/Math.PI*180,l=Math.sqrt(_[0]*_[0]+_[2]*_[2]);if(l>1e-6){const f=_[0]/l,g=Math.acos(_[2]/l),y=(f>0?g:-g)/Math.PI*180;return new o.S(o.aN(y,-180,180),i)}return new o.S(0,i)}function Gs(_){return Math.cos(_*Math.PI/180)}function Kr(_,i){const l=Gs(_),f=Gs(i);return o.aj(f/l)}function Zo(_,i){const l=_.rotate(i.bearingInRadians),f=i.zoom+Kr(i.center.lat,0),g=o.bj(1/Gs(i.center.lat),1/Gs(Math.min(Math.abs(i.center.lat),60)),o.bm(f,7,3,0,1)),y=360/Wo({worldSize:i.worldSize,center:{lat:i.center.lat}});return new o.S(i.center.lng-l.x*y*g,o.ag(i.center.lat+l.y*y,-o.ah,o.ah))}function Ks(_){const i=.5*_,l=Math.sin(i),f=Math.cos(i);return Math.log(l+f)-Math.log(f-l)}function Js(_,i,l,f){const g=_.lat+l*f;if(Math.abs(l)>1){const y=(Math.sign(_.lat+l)!==Math.sign(_.lat)?-Math.abs(_.lat):Math.abs(_.lat))*Math.PI/180,x=Math.abs(_.lat+l)*Math.PI/180,S=Ks(y+f*(x-y)),I=Ks(y),M=Ks(x);return new o.S(_.lng+i*((S-I)/(M-I)),g)}return new o.S(_.lng+i*f,g)}class vf{constructor(i){this._cachePrevious=new Map,this._cache=new Map,this._hadAnyChanges=!1,this._boundingVolumeFactory=i}swapBuffers(){if(!this._hadAnyChanges)return;const i=this._cachePrevious;this._cachePrevious=this._cache,this._cache=i,this._cache.clear(),this._hadAnyChanges=!1}getTileBoundingVolume(i,l,f,g){const y=`${i.z}_${i.x}_${i.y}_${g?.terrain?"t":""}`,x=this._cache.get(y);if(x)return x;const S=this._cachePrevious.get(y);if(S)return this._cache.set(y,S),S;const I=this._boundingVolumeFactory(i,l,f,g);return this._cache.set(y,I),this._hadAnyChanges=!0,I}}class os{constructor(i,l,f,g){this.min=f,this.max=g,this.points=i,this.planes=l}static fromAabb(i,l){const f=[];for(let g=0;g<8;g++)f.push([1&~g?i[0]:l[0],(g>>1&1)==1?l[1]:i[1],(g>>2&1)==1?l[2]:i[2]]);return new os(f,[[-1,0,0,l[0]],[1,0,0,-i[0]],[0,-1,0,l[1]],[0,1,0,-i[1]],[0,0,-1,l[2]],[0,0,1,-i[2]]],i,l)}static fromCenterSizeAngles(i,l,f){const g=o.bq([],f[0],f[1],f[2]),y=o.br([],[l[0],0,0],g),x=o.br([],[0,l[1],0],g),S=o.br([],[0,0,l[2]],g),I=[...i],M=[...i];for(let B=0;B<8;B++)for(let F=0;F<3;F++){const N=i[F]+y[F]*(1&~B?-1:1)+x[F]*((B>>1&1)==1?1:-1)+S[F]*((B>>2&1)==1?1:-1);I[F]=Math.min(I[F],N),M[F]=Math.max(M[F],N)}const k=[];for(let B=0;B<8;B++){const F=[...i];o.aR(F,F,o.aQ([],y,1&~B?-1:1)),o.aR(F,F,o.aQ([],x,(B>>1&1)==1?1:-1)),o.aR(F,F,o.aQ([],S,(B>>2&1)==1?1:-1)),k.push(F)}return new os(k,[[...y,-o.aW(y,k[0])],[...x,-o.aW(x,k[0])],[...S,-o.aW(S,k[0])],[-y[0],-y[1],-y[2],-o.aW(y,k[7])],[-x[0],-x[1],-x[2],-o.aW(x,k[7])],[-S[0],-S[1],-S[2],-o.aW(S,k[7])]],I,M)}intersectsFrustum(i){let l=!0;const f=this.points.length,g=this.planes.length,y=i.planes.length,x=i.points.length;for(let S=0;S<y;S++){const I=i.planes[S];let M=0;for(let k=0;k<f;k++){const B=this.points[k];I[0]*B[0]+I[1]*B[1]+I[2]*B[2]+I[3]>=0&&M++}if(M===0)return 0;M<f&&(l=!1)}if(l)return 2;for(let S=0;S<g;S++){const I=this.planes[S];let M=0;for(let k=0;k<x;k++){const B=i.points[k];I[0]*B[0]+I[1]*B[1]+I[2]*B[2]+I[3]>=0&&M++}if(M===0)return 0}return 1}intersectsPlane(i){const l=this.points.length;let f=0;for(let g=0;g<l;g++){const y=this.points[g];i[0]*y[0]+i[1]*y[1]+i[2]*y[2]+i[3]>=0&&f++}return f===l?2:f===0?0:1}}function Xo(_,i,l){const f=_-i;return f<0?-f:Math.max(0,f-l)}function vc(_,i,l,f,g){const y=_-l;let x;return x=y<0?Math.min(-y,1+y-g):y>1?Math.min(Math.max(y-g,0),1-y):0,Math.max(x,Xo(i,f,g))}class xf{constructor(){this._boundingVolumeCache=new vf(this._computeTileBoundingVolume)}prepareNextFrame(){this._boundingVolumeCache.swapBuffers()}distanceToTile2d(i,l,f,g){const y=1<<f.z,x=1/y,S=f.x/y,I=f.y/y;let M=2;return M=Math.min(M,vc(i,l,S,I,x)),M=Math.min(M,vc(i,l,S+.5,-I-x,x)),M=Math.min(M,vc(i,l,S+.5,2-I-x,x)),M}getWrap(i,l,f){const g=1<<l.z,y=1/g,x=l.x/g,S=Xo(i.x,x,y),I=Xo(i.x,x-1,y),M=Xo(i.x,x+1,y),k=Math.min(S,I,M);return k===M?1:k===I?-1:0}allowVariableZoom(i,l){return $e(i,l)>4}allowWorldCopies(){return!1}getTileBoundingVolume(i,l,f,g){return this._boundingVolumeCache.getTileBoundingVolume(i,l,f,g)}_computeTileBoundingVolume(i,l,f,g){var y,x;let S=f,I=f;if(g?.terrain){const M=new o.Z(i.z,l,i.z,i.x,i.y),k=g.terrain.getMinMaxElevation(M);S=(y=k.minElevation)!==null&&y!==void 0?y:f,I=(x=k.maxElevation)!==null&&x!==void 0?x:f}if(S/=o.bt,I/=o.bt,S+=1,I+=1,i.z<=0)return os.fromAabb([-I,-I,-I],[I,I,I]);if(i.z===1)return os.fromAabb([i.x===0?-I:0,i.y===0?0:-I,-I],[i.x===0?0:I,i.y===0?I:0,I]);{const M=[pn(0,0,i.x,i.y,i.z),pn(o.$,0,i.x,i.y,i.z),pn(o.$,o.$,i.x,i.y,i.z),pn(0,o.$,i.x,i.y,i.z)],k=[];for(const Me of M)k.push(o.aQ([],Me,I));if(I!==S)for(const Me of M)k.push(o.aQ([],Me,S));i.y===0&&k.push([0,1,0]),i.y===(1<<i.z)-1&&k.push([0,-1,0]);const B=[1,1,1],F=[-1,-1,-1];for(const Me of k)for(let Fe=0;Fe<3;Fe++)B[Fe]=Math.min(B[Fe],Me[Fe]),F[Fe]=Math.max(F[Fe],Me[Fe]);const N=pn(o.$/2,o.$/2,i.x,i.y,i.z),W=o.aV([],[0,1,0],N);o.aU(W,W);const J=o.aV([],N,W);o.aU(J,J);const G=o.aV([],M[2],M[1]);o.aU(G,G);const Q=o.aV([],M[0],M[3]);o.aU(Q,Q),k.push(o.aQ([],N,I)),i.y>=(1<<i.z)/2&&k.push(o.aQ([],pn(o.$/2,0,i.x,i.y,i.z),I)),i.y<(1<<i.z)/2&&k.push(o.aQ([],pn(o.$/2,o.$,i.x,i.y,i.z),I));const re=Ui(N,k),ae=Ui(J,k),se=[-N[0],-N[1],-N[2],re.max],ue=[N[0],N[1],N[2],-re.min],de=[-J[0],-J[1],-J[2],ae.max],oe=[J[0],J[1],J[2],-ae.min],ye=[...G,0],Oe=[...Q,0],Ce=[];return i.y===0?Ce.push(o.bs(Oe,ye,se),o.bs(Oe,ye,ue)):Ce.push(o.bs(de,ye,se),o.bs(de,ye,ue),o.bs(de,Oe,se),o.bs(de,Oe,ue)),i.y===(1<<i.z)-1?Ce.push(o.bs(Oe,ye,se),o.bs(Oe,ye,ue)):Ce.push(o.bs(oe,ye,se),o.bs(oe,ye,ue),o.bs(oe,Oe,se),o.bs(oe,Oe,ue)),new os(Ce,[se,ue,de,oe,ye,Oe],B,F)}}}function Ui(_,i){let l=1/0,f=-1/0;for(const g of i){const y=o.aW(_,g);l=Math.min(l,y),f=Math.max(f,y)}return{min:l,max:f}}class Qs{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(i){this._helper.setMinZoom(i)}setMaxZoom(i){this._helper.setMaxZoom(i)}setMinPitch(i){this._helper.setMinPitch(i)}setMaxPitch(i){this._helper.setMaxPitch(i)}setRenderWorldCopies(i){this._helper.setRenderWorldCopies(i)}setBearing(i){this._helper.setBearing(i)}setPitch(i){this._helper.setPitch(i)}setRoll(i){this._helper.setRoll(i)}setFov(i){this._helper.setFov(i)}setZoom(i){this._helper.setZoom(i)}setCenter(i){this._helper.setCenter(i)}setElevation(i){this._helper.setElevation(i)}setMinElevationForCurrentTile(i){this._helper.setMinElevationForCurrentTile(i)}setPadding(i){this._helper.setPadding(i)}interpolatePadding(i,l,f){return this._helper.interpolatePadding(i,l,f)}isPaddingEqual(i){return this._helper.isPaddingEqual(i)}resize(i,l){this._helper.resize(i,l)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(i){this._helper.setMaxBounds(i)}overrideNearFarZ(i,l){this._helper.overrideNearFarZ(i,l)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(i){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),i)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(i){}constructor(){this._cachedClippingPlane=o.bu(),this._projectionMatrix=o.b8(),this._globeViewProjMatrix32f=o.b7(),this._globeViewProjMatrixNoCorrection=o.b8(),this._globeViewProjMatrixNoCorrectionInverted=o.b8(),this._globeProjMatrixInverted=o.b8(),this._cameraPosition=o.bo(),this._globeLatitudeErrorCorrectionRadians=0,this._helper=new jo({calcMatrices:()=>{this._calcMatrices()},getConstrained:(i,l)=>this.getConstrained(i,l)}),this._coveringTilesDetailsProvider=new xf}clone(){const i=new Qs;return i.apply(this),i}apply(i,l){this._globeLatitudeErrorCorrectionRadians=l||0,this._helper.apply(i)}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._globeViewProjMatrixNoCorrection}get inverseProjectionMatrix(){return this._globeProjMatrixInverted}get cameraPosition(){const i=o.bo();return i[0]=this._cameraPosition[0],i[1]=this._cameraPosition[1],i[2]=this._cameraPosition[2],i}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}getProjectionData(i){const{overscaledTileID:l,applyGlobeMatrix:f}=i,g=this._helper.getMercatorTileCoordinates(l);return{mainMatrix:this._globeViewProjMatrix32f,tileMercatorCoords:g,clippingPlane:this._cachedClippingPlane,projectionTransition:f?1:0,fallbackMatrix:this._globeViewProjMatrix32f}}_computeClippingPlane(i){const l=this.pitchInRadians,f=this.cameraToCenterDistance/i,g=Math.sin(l)*f,y=Math.cos(l)*f+1,x=1/Math.sqrt(g*g+y*y)*1;let S=-g,I=y;const M=Math.sqrt(S*S+I*I);S/=M,I/=M;const k=[0,S,I];o.bv(k,k,[0,0,0],-this.bearingInRadians),o.bw(k,k,[0,0,0],-1*this.center.lat*Math.PI/180),o.bx(k,k,[0,0,0],this.center.lng*Math.PI/180);const B=1/o.aY(k);return o.aQ(k,k,B),[...k,-x*B]}isLocationOccluded(i){return!this.isSurfacePointVisible(ci(i))}transformLightDirection(i){const l=this._helper._center.lng*Math.PI/180,f=this._helper._center.lat*Math.PI/180,g=Math.cos(f),y=[Math.sin(l)*g,Math.sin(f),Math.cos(l)*g],x=[y[2],0,-y[0]],S=[0,0,0];o.aV(S,x,y),o.aU(x,x),o.aU(S,S);const I=[0,0,0];return o.aU(I,[x[0]*i[0]+S[0]*i[1]+y[0]*i[2],x[1]*i[0]+S[1]*i[1]+y[1]*i[2],x[2]*i[0]+S[2]*i[1]+y[2]*i[2]]),I}getPixelScale(){return 1/Math.cos(this._helper._center.lat*Math.PI/180)}getCircleRadiusCorrection(){return Math.cos(this._helper._center.lat*Math.PI/180)}getPitchedTextCorrection(i,l,f){const g=function(S,I,M){const k=1/(1<<M.z);return new o.a0(S/o.$*k+M.x*k,I/o.$*k+M.y*k)}(i,l,f.canonical),y=(x=g.y,[o.bn(g.x*Math.PI*2+Math.PI,2*Math.PI),2*Math.atan(Math.exp(Math.PI-x*Math.PI*2))-.5*Math.PI]);var x;return this.getCircleRadiusCorrection()/Math.cos(y[1])}projectTileCoordinates(i,l,f,g){const y=f.canonical,x=pn(i,l,y.x,y.y,y.z),S=1+(g?g(i,l):0)/o.bt,I=[x[0]*S,x[1]*S,x[2]*S,1];o.av(I,I,this._globeViewProjMatrixNoCorrection);const M=this._cachedClippingPlane,k=M[0]*x[0]+M[1]*x[1]+M[2]*x[2]+M[3]<0;return{point:new o.P(I[0]/I[3],I[1]/I[3]),signedDistanceFromCamera:I[3],isOccluded:k}}_calcMatrices(){if(!this._helper._width||!this._helper._height)return;const i=Ys(this.worldSize,this.center.lat),l=o.b9(),f=o.b9();this._helper.autoCalculateNearFarZ&&(this._helper._nearZ=.5,this._helper._farZ=this.cameraToCenterDistance+2*i),o.b3(l,this.fovInRadians,this.width/this.height,this._helper._nearZ,this._helper._farZ);const g=this.centerOffset;l[8]=2*-g.x/this._helper._width,l[9]=2*g.y/this._helper._height,this._projectionMatrix=o.b4(l),this._globeProjMatrixInverted=o.b9(),o.ap(this._globeProjMatrixInverted,l),o.M(l,l,[0,0,-this.cameraToCenterDistance]),o.b5(l,l,this.rollInRadians),o.b6(l,l,-this.pitchInRadians),o.b5(l,l,this.bearingInRadians),o.M(l,l,[0,0,-i]);const y=o.bo();y[0]=i,y[1]=i,y[2]=i,o.b6(f,l,this.center.lat*Math.PI/180),o.by(f,f,-this.center.lng*Math.PI/180),o.N(f,f,y),this._globeViewProjMatrixNoCorrection=f,o.b6(l,l,this.center.lat*Math.PI/180-this._globeLatitudeErrorCorrectionRadians),o.by(l,l,-this.center.lng*Math.PI/180),o.N(l,l,y),this._globeViewProjMatrix32f=new Float32Array(l),this._globeViewProjMatrixNoCorrectionInverted=o.b9(),o.ap(this._globeViewProjMatrixNoCorrectionInverted,f);const x=o.bo();this._cameraPosition=o.bo(),this._cameraPosition[2]=this.cameraToCenterDistance/i,o.bv(this._cameraPosition,this._cameraPosition,x,-this.rollInRadians),o.bw(this._cameraPosition,this._cameraPosition,x,this.pitchInRadians),o.bv(this._cameraPosition,this._cameraPosition,x,-this.bearingInRadians),o.aR(this._cameraPosition,this._cameraPosition,[0,0,1]),o.bw(this._cameraPosition,this._cameraPosition,x,-this.center.lat*Math.PI/180),o.bx(this._cameraPosition,this._cameraPosition,x,this.center.lng*Math.PI/180),this._cachedClippingPlane=this._computeClippingPlane(i);const S=o.b4(this._globeViewProjMatrixNoCorrectionInverted);o.N(S,S,[1,1,-1]),this._cachedFrustum=Di.fromInvProjectionMatrix(S,1,0,this._cachedClippingPlane,!0)}calculateFogMatrix(i){o.w("calculateFogMatrix is not supported on globe projection.");const l=o.b9();return o.af(l),l}getVisibleUnwrappedCoordinates(i){return[new o.b1(0,i)]}getCameraFrustum(){return this._cachedFrustum}getClippingPlane(){return this._cachedClippingPlane}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(i){i&&o.w("terrain is not fully supported on vertical perspective projection."),this._helper.recalculateZoomAndCenter(0)}maxPitchScaleFactor(){return 1}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(i,l){if(!this._globeViewProjMatrixNoCorrection)return 1;const f=ci(i);o.aQ(f,f,1+l/o.bt);const g=o.bu();return o.av(g,[f[0],f[1],f[2],1],this._globeViewProjMatrixNoCorrection),g[2]/g[3]}populateCache(i){}getBounds(){const i=.5*this.width,l=.5*this.height,f=[new o.P(0,0),new o.P(i,0),new o.P(this.width,0),new o.P(this.width,l),new o.P(this.width,this.height),new o.P(i,this.height),new o.P(0,this.height),new o.P(0,l)],g=[];for(const B of f)g.push(this.unprojectScreenPoint(B));let y=0,x=0,S=0,I=0;const M=this.center;for(const B of g){const F=o.bz(M.lng,B.lng),N=o.bz(M.lat,B.lat);F<x&&(x=F),F>y&&(y=F),N<I&&(I=N),N>S&&(S=N)}const k=[M.lng+x,M.lat+I,M.lng+y,M.lat+S];return this.isSurfacePointOnScreen([0,1,0])&&(k[3]=90,k[0]=-180,k[2]=180),this.isSurfacePointOnScreen([0,-1,0])&&(k[1]=-90,k[0]=-180,k[2]=180),new zt(k)}getConstrained(i,l){const f=o.ag(i.lat,-o.ah,o.ah),g=o.ag(+l,this.minZoom+Kr(0,f),this.maxZoom);return{center:new o.S(i.lng,f),zoom:g}}calculateCenterFromCameraLngLatAlt(i,l,f,g){return this._helper.calculateCenterFromCameraLngLatAlt(i,l,f,g)}setLocationAtPoint(i,l){const f=ci(this.unprojectScreenPoint(l)),g=ci(i),y=o.bo();o.bA(y);const x=o.bo();o.bx(x,f,y,-this.center.lng*Math.PI/180),o.bw(x,x,y,this.center.lat*Math.PI/180);const S=g[0]*g[0]+g[2]*g[2],I=x[0]*x[0];if(S<I)return;const M=Math.sqrt(S-I),k=-M,B=o.bB(g[0],g[2],x[0],M),F=o.bB(g[0],g[2],x[0],k),N=o.bo();o.bx(N,g,y,-B);const W=o.bB(N[1],N[2],x[1],x[2]),J=o.bo();o.bx(J,g,y,-F);const G=o.bB(J[1],J[2],x[1],x[2]),Q=.5*Math.PI,re=W>=-Q&&W<=Q,ae=G>=-Q&&G<=Q;let se,ue;if(re&&ae){const Oe=this.center.lng*Math.PI/180,Ce=this.center.lat*Math.PI/180;o.bC(B,Oe)+o.bC(W,Ce)<o.bC(F,Oe)+o.bC(G,Ce)?(se=B,ue=W):(se=F,ue=G)}else if(re)se=B,ue=W;else{if(!ae)return;se=F,ue=G}const de=se/Math.PI*180,oe=ue/Math.PI*180,ye=this.center.lat;this.setCenter(new o.S(de,o.ag(oe,-90,90))),this.setZoom(this.zoom+Kr(ye,this.center.lat))}locationToScreenPoint(i,l){const f=ci(i);if(l){const g=l.getElevationForLngLatZoom(i,this._helper._tileZoom);o.aQ(f,f,1+g/o.bt)}return this._projectSurfacePointToScreen(f)}_projectSurfacePointToScreen(i){const l=o.bu();return o.av(l,[...i,1],this._globeViewProjMatrixNoCorrection),l[0]/=l[3],l[1]/=l[3],new o.P((.5*l[0]+.5)*this.width,(.5*-l[1]+.5)*this.height)}screenPointToMercatorCoordinate(i,l){if(l){const f=l.pointCoordinate(i);if(f)return f}return o.a0.fromLngLat(this.unprojectScreenPoint(i))}screenPointToLocation(i,l){var f;return(f=this.screenPointToMercatorCoordinate(i,l))===null||f===void 0?void 0:f.toLngLat()}isPointOnMapSurface(i,l){const f=this._cameraPosition,g=this.getRayDirectionFromPixel(i);return!!this.rayPlanetIntersection(f,g)}getRayDirectionFromPixel(i){const l=o.bu();l[0]=i.x/this.width*2-1,l[1]=-1*(i.y/this.height*2-1),l[2]=1,l[3]=1,o.av(l,l,this._globeViewProjMatrixNoCorrectionInverted),l[0]/=l[3],l[1]/=l[3],l[2]/=l[3];const f=o.bo();f[0]=l[0]-this._cameraPosition[0],f[1]=l[1]-this._cameraPosition[1],f[2]=l[2]-this._cameraPosition[2];const g=o.bo();return o.aU(g,f),g}isSurfacePointVisible(i){const l=this._cachedClippingPlane;return l[0]*i[0]+l[1]*i[1]+l[2]*i[2]+l[3]>=0}isSurfacePointOnScreen(i){if(!this.isSurfacePointVisible(i))return!1;const l=o.bu();return o.av(l,[...i,1],this._globeViewProjMatrixNoCorrection),l[0]/=l[3],l[1]/=l[3],l[2]/=l[3],l[0]>-1&&l[0]<1&&l[1]>-1&&l[1]<1&&l[2]>-1&&l[2]<1}rayPlanetIntersection(i,l){const f=o.aW(i,l),g=o.bo(),y=o.bo();o.aQ(y,l,f),o.aT(g,i,y);const x=1-o.aW(g,g);if(x<0)return null;const S=o.aW(i,i)-1,I=-f+(f<0?1:-1)*Math.sqrt(x),M=S/I,k=I;return{tMin:Math.min(M,k),tMax:Math.max(M,k)}}unprojectScreenPoint(i){const l=this._cameraPosition,f=this.getRayDirectionFromPixel(i),g=this.rayPlanetIntersection(l,f);if(g){const k=o.bo();o.aR(k,l,[f[0]*g.tMin,f[1]*g.tMin,f[2]*g.tMin]);const B=o.bo();return o.aU(B,k),Ho(B)}const y=this._cachedClippingPlane,x=y[0]*f[0]+y[1]*f[1]+y[2]*f[2],S=-o.b0(y,l)/x,I=o.bo();if(S>0)o.aR(I,l,[f[0]*S,f[1]*S,f[2]*S]);else{const k=o.bo();o.aR(k,l,[2*f[0],2*f[1],2*f[2]]);const B=o.b0(this._cachedClippingPlane,k);o.aT(I,k,[this._cachedClippingPlane[0]*B,this._cachedClippingPlane[1]*B,this._cachedClippingPlane[2]*B])}const M=function(k){const B=o.bo();return B[0]=k[0]*-k[3],B[1]=k[1]*-k[3],B[2]=k[2]*-k[3],{center:B,radius:Math.sqrt(1-k[3]*k[3])}}(y);return Ho(function(k,B,F){const N=o.bo();o.aT(N,F,k);const W=o.bo();return o.bp(W,k,N,B/o.a_(N)),W}(M.center,M.radius,I))}getMatrixForModel(i,l){const f=o.S.convert(i),g=1/o.bt,y=o.b8();return o.by(y,y,f.lng/180*Math.PI),o.b6(y,y,-f.lat/180*Math.PI),o.M(y,y,[0,0,1+l/o.bt]),o.b6(y,y,.5*Math.PI),o.N(y,y,[g,g,g]),y}getProjectionDataForCustomLayer(i=!0){const l=this.getProjectionData({overscaledTileID:new o.Z(0,0,0,0,0),applyGlobeMatrix:i});return l.tileMercatorCoords=[0,0,1,1],l}getFastPathSimpleProjectionMatrix(i){}}class nn{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(i){this._helper.setMinZoom(i)}setMaxZoom(i){this._helper.setMaxZoom(i)}setMinPitch(i){this._helper.setMinPitch(i)}setMaxPitch(i){this._helper.setMaxPitch(i)}setRenderWorldCopies(i){this._helper.setRenderWorldCopies(i)}setBearing(i){this._helper.setBearing(i)}setPitch(i){this._helper.setPitch(i)}setRoll(i){this._helper.setRoll(i)}setFov(i){this._helper.setFov(i)}setZoom(i){this._helper.setZoom(i)}setCenter(i){this._helper.setCenter(i)}setElevation(i){this._helper.setElevation(i)}setMinElevationForCurrentTile(i){this._helper.setMinElevationForCurrentTile(i)}setPadding(i){this._helper.setPadding(i)}interpolatePadding(i,l,f){return this._helper.interpolatePadding(i,l,f)}isPaddingEqual(i){return this._helper.isPaddingEqual(i)}resize(i,l,f=!0){this._helper.resize(i,l,f)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(i){this._helper.setMaxBounds(i)}overrideNearFarZ(i,l){this._helper.overrideNearFarZ(i,l)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(i){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),i)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}get isGlobeRendering(){return this._globeness>0}setTransitionState(i,l){this._globeness=i,this._globeLatitudeErrorCorrectionRadians=l,this._calcMatrices(),this._verticalPerspectiveTransform.getCoveringTilesDetailsProvider().prepareNextFrame(),this._mercatorTransform.getCoveringTilesDetailsProvider().prepareNextFrame()}get currentTransform(){return this.isGlobeRendering?this._verticalPerspectiveTransform:this._mercatorTransform}constructor(){this._globeLatitudeErrorCorrectionRadians=0,this._globeness=1,this._helper=new jo({calcMatrices:()=>{this._calcMatrices()},getConstrained:(i,l)=>this.getConstrained(i,l)}),this._globeness=1,this._mercatorTransform=new Gr,this._verticalPerspectiveTransform=new Qs}clone(){const i=new nn;return i._globeness=this._globeness,i._globeLatitudeErrorCorrectionRadians=this._globeLatitudeErrorCorrectionRadians,i.apply(this),i}apply(i){this._helper.apply(i),this._mercatorTransform.apply(this),this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians)}get projectionMatrix(){return this.currentTransform.projectionMatrix}get modelViewProjectionMatrix(){return this.currentTransform.modelViewProjectionMatrix}get inverseProjectionMatrix(){return this.currentTransform.inverseProjectionMatrix}get cameraPosition(){return this.currentTransform.cameraPosition}getProjectionData(i){const l=this._mercatorTransform.getProjectionData(i),f=this._verticalPerspectiveTransform.getProjectionData(i);return{mainMatrix:this.isGlobeRendering?f.mainMatrix:l.mainMatrix,clippingPlane:f.clippingPlane,tileMercatorCoords:f.tileMercatorCoords,projectionTransition:i.applyGlobeMatrix?this._globeness:0,fallbackMatrix:l.fallbackMatrix}}isLocationOccluded(i){return this.currentTransform.isLocationOccluded(i)}transformLightDirection(i){return this.currentTransform.transformLightDirection(i)}getPixelScale(){return o.bj(this._mercatorTransform.getPixelScale(),this._verticalPerspectiveTransform.getPixelScale(),this._globeness)}getCircleRadiusCorrection(){return o.bj(this._mercatorTransform.getCircleRadiusCorrection(),this._verticalPerspectiveTransform.getCircleRadiusCorrection(),this._globeness)}getPitchedTextCorrection(i,l,f){const g=this._mercatorTransform.getPitchedTextCorrection(i,l,f),y=this._verticalPerspectiveTransform.getPitchedTextCorrection(i,l,f);return o.bj(g,y,this._globeness)}projectTileCoordinates(i,l,f,g){return this.currentTransform.projectTileCoordinates(i,l,f,g)}_calcMatrices(){this._helper._width&&this._helper._height&&(this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians),this._helper._nearZ=this._verticalPerspectiveTransform.nearZ,this._helper._farZ=this._verticalPerspectiveTransform.farZ,this._mercatorTransform.apply(this,!0,this.isGlobeRendering),this._helper._nearZ=this._mercatorTransform.nearZ,this._helper._farZ=this._mercatorTransform.farZ)}calculateFogMatrix(i){return this.currentTransform.calculateFogMatrix(i)}getVisibleUnwrappedCoordinates(i){return this.currentTransform.getVisibleUnwrappedCoordinates(i)}getCameraFrustum(){return this.currentTransform.getCameraFrustum()}getClippingPlane(){return this.currentTransform.getClippingPlane()}getCoveringTilesDetailsProvider(){return this.currentTransform.getCoveringTilesDetailsProvider()}recalculateZoomAndCenter(i){this._mercatorTransform.recalculateZoomAndCenter(i),this._verticalPerspectiveTransform.recalculateZoomAndCenter(i)}maxPitchScaleFactor(){return this._mercatorTransform.maxPitchScaleFactor()}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(i,l){return this.currentTransform.lngLatToCameraDepth(i,l)}populateCache(i){this._mercatorTransform.populateCache(i),this._verticalPerspectiveTransform.populateCache(i)}getBounds(){return this.currentTransform.getBounds()}getConstrained(i,l){return this.currentTransform.getConstrained(i,l)}calculateCenterFromCameraLngLatAlt(i,l,f,g){return this._helper.calculateCenterFromCameraLngLatAlt(i,l,f,g)}setLocationAtPoint(i,l){if(!this.isGlobeRendering)return this._mercatorTransform.setLocationAtPoint(i,l),void this.apply(this._mercatorTransform);this._verticalPerspectiveTransform.setLocationAtPoint(i,l),this.apply(this._verticalPerspectiveTransform)}locationToScreenPoint(i,l){return this.currentTransform.locationToScreenPoint(i,l)}screenPointToMercatorCoordinate(i,l){return this.currentTransform.screenPointToMercatorCoordinate(i,l)}screenPointToLocation(i,l){return this.currentTransform.screenPointToLocation(i,l)}isPointOnMapSurface(i,l){return this.currentTransform.isPointOnMapSurface(i,l)}getRayDirectionFromPixel(i){return this._verticalPerspectiveTransform.getRayDirectionFromPixel(i)}getMatrixForModel(i,l){return this.currentTransform.getMatrixForModel(i,l)}getProjectionDataForCustomLayer(i=!0){const l=this._mercatorTransform.getProjectionDataForCustomLayer(i);if(!this.isGlobeRendering)return l;const f=this._verticalPerspectiveTransform.getProjectionDataForCustomLayer(i);return f.fallbackMatrix=l.mainMatrix,f}getFastPathSimpleProjectionMatrix(i){return this.currentTransform.getFastPathSimpleProjectionMatrix(i)}}class Xi{get useGlobeControls(){return!0}handlePanInertia(i,l){const f=Zo(i,l);return Math.abs(f.lng-l.center.lng)>180&&(f.lng=l.center.lng+179.5*Math.sign(f.lng-l.center.lng)),{easingCenter:f,easingOffset:new o.P(0,0)}}handleMapControlsRollPitchBearingZoom(i,l){const f=i.around,g=l.screenPointToLocation(f);i.bearingDelta&&l.setBearing(l.bearing+i.bearingDelta),i.pitchDelta&&l.setPitch(l.pitch+i.pitchDelta),i.rollDelta&&l.setRoll(l.roll+i.rollDelta);const y=l.zoom;i.zoomDelta&&l.setZoom(l.zoom+i.zoomDelta);const x=l.zoom-y;if(x===0)return;const S=o.bz(l.center.lng,g.lng),I=S/(Math.abs(S/180)+1),M=o.bz(l.center.lat,g.lat),k=l.getRayDirectionFromPixel(f),B=l.cameraPosition,F=-1*o.aW(B,k),N=o.bo();o.aR(N,B,[k[0]*F,k[1]*F,k[2]*F]);const W=o.aY(N)-1,J=Math.exp(.5*-Math.max(W-.3,0)),G=Ys(l.worldSize,l.center.lat)/Math.min(l.width,l.height),Q=o.bm(G,.9,.5,1,.25),re=(1-o.ae(-x))*Math.min(J,Q),ae=l.center.lat,se=l.zoom,ue=new o.S(l.center.lng+I*re,o.ag(l.center.lat+M*re,-o.ah,o.ah));l.setLocationAtPoint(g,f);const de=l.center,oe=o.bm(Math.abs(S),45,85,0,1),ye=o.bm(G,.75,.35,0,1),Oe=Math.pow(Math.max(oe,ye),.25),Ce=o.bz(de.lng,ue.lng),Me=o.bz(de.lat,ue.lat);l.setCenter(new o.S(de.lng+Ce*Oe,de.lat+Me*Oe).wrap()),l.setZoom(se+Kr(ae,l.center.lat))}handleMapControlsPan(i,l,f){if(!i.panDelta)return;const g=l.center.lat,y=l.zoom;l.setCenter(Zo(i.panDelta,l).wrap()),l.setZoom(y+Kr(g,l.center.lat))}cameraForBoxAndBearing(i,l,f,g,y){const x=Fr(i,l,f,g,y),S=l.left/y.width*2-1,I=(y.width-l.right)/y.width*2-1,M=l.top/y.height*-2+1,k=(y.height-l.bottom)/y.height*-2+1,B=o.bz(f.getWest(),f.getEast())<0,F=B?f.getEast():f.getWest(),N=B?f.getWest():f.getEast(),W=Math.max(f.getNorth(),f.getSouth()),J=Math.min(f.getNorth(),f.getSouth()),G=F+.5*o.bz(F,N),Q=W+.5*o.bz(W,J),re=y.clone();re.setCenter(x.center),re.setBearing(x.bearing),re.setPitch(0),re.setRoll(0),re.setZoom(x.zoom);const ae=re.modelViewProjectionMatrix,se=[ci(f.getNorthWest()),ci(f.getNorthEast()),ci(f.getSouthWest()),ci(f.getSouthEast()),ci(new o.S(N,Q)),ci(new o.S(F,Q)),ci(new o.S(G,W)),ci(new o.S(G,J))],ue=ci(x.center);let de=Number.POSITIVE_INFINITY;for(const oe of se)S<0&&(de=Xi.getLesserNonNegativeNonNull(de,Xi.solveVectorScale(oe,ue,ae,"x",S))),I>0&&(de=Xi.getLesserNonNegativeNonNull(de,Xi.solveVectorScale(oe,ue,ae,"x",I))),M>0&&(de=Xi.getLesserNonNegativeNonNull(de,Xi.solveVectorScale(oe,ue,ae,"y",M))),k<0&&(de=Xi.getLesserNonNegativeNonNull(de,Xi.solveVectorScale(oe,ue,ae,"y",k)));if(Number.isFinite(de)&&de!==0)return x.zoom=re.zoom+o.aj(de),x;Oi()}handleJumpToCenterZoom(i,l){const f=i.center.lat,g=i.getConstrained(l.center?o.S.convert(l.center):i.center,i.zoom).center;i.setCenter(g.wrap());const y=l.zoom!==void 0?+l.zoom:i.zoom+Kr(f,g.lat);i.zoom!==y&&i.setZoom(y)}handleEaseTo(i,l){const f=i.zoom,g=i.center,y=i.padding,x={roll:i.roll,pitch:i.pitch,bearing:i.bearing},S={roll:l.roll===void 0?i.roll:l.roll,pitch:l.pitch===void 0?i.pitch:l.pitch,bearing:l.bearing===void 0?i.bearing:l.bearing},I=l.zoom!==void 0,M=!i.isPaddingEqual(l.padding);let k=!1;const B=l.center?o.S.convert(l.center):g,F=i.getConstrained(B,f).center;Wn(i,F);const N=i.clone();N.setCenter(F),N.setZoom(I?+l.zoom:f+Kr(g.lat,B.lat)),N.setBearing(l.bearing);const W=new o.P(o.ag(i.centerPoint.x+l.offsetAsPoint.x,0,i.width),o.ag(i.centerPoint.y+l.offsetAsPoint.y,0,i.height));N.setLocationAtPoint(F,W);const J=(l.offset&&l.offsetAsPoint.mag())>0?N.center:F,G=I?+l.zoom:f+Kr(g.lat,J.lat),Q=f+Kr(g.lat,0),re=G+Kr(J.lat,0),ae=o.bz(g.lng,J.lng),se=o.bz(g.lat,J.lat),ue=o.ae(re-Q);return k=G!==f,{easeFunc:de=>{if(o.bd(x,S)||li({startEulerAngles:x,endEulerAngles:S,tr:i,k:de,useSlerp:x.roll!=S.roll}),M&&i.interpolatePadding(y,l.padding,de),l.around)o.w("Easing around a point is not supported under globe projection."),i.setLocationAtPoint(l.around,l.aroundPoint);else{const oe=re>Q?Math.min(2,ue):Math.max(.5,ue),ye=Math.pow(oe,1-de),Oe=Js(g,ae,se,de*ye);i.setCenter(Oe.wrap())}if(k){const oe=o.C.number(Q,re,de)+Kr(0,i.center.lat);i.setZoom(oe)}},isZooming:k,elevationCenter:J}}handleFlyTo(i,l){const f=l.zoom!==void 0,g=i.center,y=i.zoom,x=i.padding,S=!i.isPaddingEqual(l.padding),I=i.getConstrained(o.S.convert(l.center||l.locationAtOffset),y).center,M=f?+l.zoom:i.zoom+Kr(i.center.lat,I.lat),k=i.clone();k.setCenter(I),k.setZoom(M),k.setBearing(l.bearing);const B=new o.P(o.ag(i.centerPoint.x+l.offsetAsPoint.x,0,i.width),o.ag(i.centerPoint.y+l.offsetAsPoint.y,0,i.height));k.setLocationAtPoint(I,B);const F=k.center;Wn(i,F);const N=function(se,ue,de){const oe=ci(ue),ye=ci(de),Oe=o.aW(oe,ye),Ce=Math.acos(Oe),Me=Wo(se);return Ce/(2*Math.PI)*Me}(i,g,F),W=y+Kr(g.lat,0),J=M+Kr(F.lat,0),G=o.ae(J-W);let Q;if(typeof l.minZoom=="number"){const se=+l.minZoom+Kr(F.lat,0),ue=Math.min(se,W,J)+Kr(0,F.lat),de=i.getConstrained(F,ue).zoom+Kr(F.lat,0);Q=o.ae(de-W)}const re=o.bz(g.lng,F.lng),ae=o.bz(g.lat,F.lat);return{easeFunc:(se,ue,de,oe)=>{const ye=Js(g,re,ae,de);S&&i.interpolatePadding(x,l.padding,se);const Oe=se===1?F:ye;i.setCenter(Oe.wrap());const Ce=W+o.aj(ue);i.setZoom(se===1?M:Ce+Kr(0,Oe.lat))},scaleOfZoom:G,targetCenter:F,scaleOfMinZoom:Q,pixelPathLength:N}}static solveVectorScale(i,l,f,g,y){const x=g==="x"?[f[0],f[4],f[8],f[12]]:[f[1],f[5],f[9],f[13]],S=[f[3],f[7],f[11],f[15]],I=i[0]*x[0]+i[1]*x[1]+i[2]*x[2],M=i[0]*S[0]+i[1]*S[1]+i[2]*S[2],k=l[0]*x[0]+l[1]*x[1]+l[2]*x[2],B=l[0]*S[0]+l[1]*S[1]+l[2]*S[2];return k+y*M===I+y*B||S[3]*(I-k)+x[3]*(B-M)+I*B==k*M?null:(k+x[3]-y*B-y*S[3])/(k-I-y*B+y*M)}static getLesserNonNegativeNonNull(i,l){return l!==null&&l>=0&&l<i?l:i}}class xc{constructor(i){this._globe=i,this._mercatorCameraHelper=new Ya,this._verticalPerspectiveCameraHelper=new Xi}get useGlobeControls(){return this._globe.useGlobeRendering}get currentHelper(){return this.useGlobeControls?this._verticalPerspectiveCameraHelper:this._mercatorCameraHelper}handlePanInertia(i,l){return this.currentHelper.handlePanInertia(i,l)}handleMapControlsRollPitchBearingZoom(i,l){return this.currentHelper.handleMapControlsRollPitchBearingZoom(i,l)}handleMapControlsPan(i,l,f){this.currentHelper.handleMapControlsPan(i,l,f)}cameraForBoxAndBearing(i,l,f,g,y){return this.currentHelper.cameraForBoxAndBearing(i,l,f,g,y)}handleJumpToCenterZoom(i,l){this.currentHelper.handleJumpToCenterZoom(i,l)}handleEaseTo(i,l){return this.currentHelper.handleEaseTo(i,l)}handleFlyTo(i,l){return this.currentHelper.handleFlyTo(i,l)}}const qo=(_,i)=>o.y(_,i&&i.filter(l=>l.identifier!=="source.canvas")),eo=o.bD();class wc extends o.E{constructor(i,l={}){super(),this._rtlPluginLoaded=()=>{for(const f in this.sourceCaches){const g=this.sourceCaches[f].getSource().type;g!=="vector"&&g!=="geojson"||this.sourceCaches[f].reload()}},this.map=i,this.dispatcher=new Mr(cr(),i._getMapId()),this.dispatcher.registerMessageHandler("GG",(f,g)=>this.getGlyphs(f,g)),this.dispatcher.registerMessageHandler("GI",(f,g)=>this.getImages(f,g)),this.imageManager=new _e,this.imageManager.setEventedParent(this),this.glyphManager=new mt(i._requestManager,l.localIdeographFontFamily),this.lineAtlas=new Rt(256,512),this.crossTileSymbolIndex=new Za,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new o.bE,this._loaded=!1,this._availableImages=[],this._globalState={},this._resetUpdates(),this.dispatcher.broadcast("SR",o.bF()),yr().on(Sr,this._rtlPluginLoaded),this.on("data",f=>{if(f.dataType!=="source"||f.sourceDataType!=="metadata")return;const g=this.sourceCaches[f.sourceId];if(!g)return;const y=g.getSource();if(y&&y.vectorLayerIds)for(const x in this._layers){const S=this._layers[x];S.source===y.id&&this._validateLayer(S)}})}setGlobalStateProperty(i,l){var f,g,y;this._checkLoaded();const x=l===null?(y=(g=(f=this.stylesheet.state)===null||f===void 0?void 0:f[i])===null||g===void 0?void 0:g.default)!==null&&y!==void 0?y:null:l;if(o.bG(x,this._globalState[i]))return this;this._globalState[i]=x;const S=this._findGlobalStateAffectedSources([i]);for(const I in this.sourceCaches)S.has(I)&&(this._reloadSource(I),this._changed=!0)}getGlobalState(){return this._globalState}setGlobalState(i){this._checkLoaded();const l=[];for(const g in i)!o.bG(this._globalState[g],i[g].default)&&(l.push(g),this._globalState[g]=i[g].default);const f=this._findGlobalStateAffectedSources(l);for(const g in this.sourceCaches)f.has(g)&&(this._reloadSource(g),this._changed=!0)}_findGlobalStateAffectedSources(i){if(i.length===0)return new Set;const l=new Set;for(const f in this._layers){const g=this._layers[f],y=g.getLayoutAffectingGlobalStateRefs();for(const x of i)y.has(x)&&l.add(g.source)}return l}loadURL(i,l={},f){this.fire(new o.l("dataloading",{dataType:"style"})),l.validate=typeof l.validate!="boolean"||l.validate;const g=this.map._requestManager.transformRequest(i,"Style");this._loadStyleRequest=new AbortController;const y=this._loadStyleRequest;o.j(g,this._loadStyleRequest).then(x=>{this._loadStyleRequest=null,this._load(x.data,l,f)}).catch(x=>{this._loadStyleRequest=null,x&&!y.signal.aborted&&this.fire(new o.k(x))})}loadJSON(i,l={},f){this.fire(new o.l("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,$.frameAsync(this._frameRequest).then(()=>{this._frameRequest=null,l.validate=l.validate!==!1,this._load(i,l,f)}).catch(()=>{})}loadEmpty(){this.fire(new o.l("dataloading",{dataType:"style"})),this._load(eo,{validate:!1})}_load(i,l,f){var g,y,x;const S=l.transformStyle?l.transformStyle(f,i):i;if(!l.validate||!qo(this,o.z(S))){this._loaded=!0,this.stylesheet=S;for(const I in S.sources)this.addSource(I,S.sources[I],{validate:!1});S.sprite?this._loadSprite(S.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(S.glyphs),this._createLayers(),this.light=new ti(this.stylesheet.light),this._setProjectionInternal(((g=this.stylesheet.projection)===null||g===void 0?void 0:g.type)||"mercator"),this.sky=new wr(this.stylesheet.sky),this.map.setTerrain((y=this.stylesheet.terrain)!==null&&y!==void 0?y:null),this.setGlobalState((x=this.stylesheet.state)!==null&&x!==void 0?x:null),this.fire(new o.l("data",{dataType:"style"})),this.fire(new o.l("style.load"))}}_createLayers(){const i=o.bH(this.stylesheet.layers);this.dispatcher.broadcast("SL",i),this._order=i.map(l=>l.id),this._layers={},this._serializedLayers=null;for(const l of i){const f=o.bI(l);f.setEventedParent(this,{layer:{id:l.id}}),this._layers[l.id]=f}}_loadSprite(i,l=!1,f=void 0){let g;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,function(y,x,S,I){return o._(this,void 0,void 0,function*(){const M=Ke(y),k=S>1?"@2x":"",B={},F={};for(const{id:N,url:W}of M){const J=x.transformRequest(ct(W,k,".json"),"SpriteJSON");B[N]=o.j(J,I);const G=x.transformRequest(ct(W,k,".png"),"SpriteImage");F[N]=Ue.getImage(G,I)}return yield Promise.all([...Object.values(B),...Object.values(F)]),function(N,W){return o._(this,void 0,void 0,function*(){const J={};for(const G in N){J[G]={};const Q=$.getImageCanvasContext((yield W[G]).data),re=(yield N[G]).data;for(const ae in re){const{width:se,height:ue,x:de,y:oe,sdf:ye,pixelRatio:Oe,stretchX:Ce,stretchY:Me,content:Fe,textFitWidth:nt,textFitHeight:it}=re[ae];J[G][ae]={data:null,pixelRatio:Oe,sdf:ye,stretchX:Ce,stretchY:Me,content:Fe,textFitWidth:nt,textFitHeight:it,spriteData:{width:se,height:ue,x:de,y:oe,context:Q}}}}return J})}(B,F)})}(i,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then(y=>{if(this._spriteRequest=null,y)for(const x in y){this._spritesImagesIds[x]=[];const S=this._spritesImagesIds[x]?this._spritesImagesIds[x].filter(I=>!(I in y)):[];for(const I of S)this.imageManager.removeImage(I),this._changedImages[I]=!0;for(const I in y[x]){const M=x==="default"?I:`${x}:${I}`;this._spritesImagesIds[x].push(M),M in this.imageManager.images?this.imageManager.updateImage(M,y[x][I],!1):this.imageManager.addImage(M,y[x][I]),l&&(this._changedImages[M]=!0)}}}).catch(y=>{this._spriteRequest=null,g=y,this.fire(new o.k(g))}).finally(()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),l&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new o.l("data",{dataType:"style"})),f&&f(g)})}_unloadSprite(){for(const i of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(i),this._changedImages[i]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new o.l("data",{dataType:"style"}))}_validateLayer(i){const l=this.sourceCaches[i.source];if(!l)return;const f=i.sourceLayer;if(!f)return;const g=l.getSource();(g.type==="geojson"||g.vectorLayerIds&&g.vectorLayerIds.indexOf(f)===-1)&&this.fire(new o.k(new Error(`Source layer "${f}" does not exist on source "${g.id}" as specified by style layer "${i.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const i in this.sourceCaches)if(!this.sourceCaches[i].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(i,l=!1){const f=this._serializedAllLayers();if(!i||i.length===0)return Object.values(l?o.bJ(f):f);const g=[];for(const y of i)if(f[y]){const x=l?o.bJ(f[y]):f[y];g.push(x)}return g}_serializedAllLayers(){let i=this._serializedLayers;if(i)return i;i=this._serializedLayers={};const l=Object.keys(this._layers);for(const f of l){const g=this._layers[f];g.type!=="custom"&&(i[f]=g.serialize())}return i}hasTransitions(){var i,l,f;if(!((i=this.light)===null||i===void 0)&&i.hasTransition()||!((l=this.sky)===null||l===void 0)&&l.hasTransition()||!((f=this.projection)===null||f===void 0)&&f.hasTransition())return!0;for(const g in this.sourceCaches)if(this.sourceCaches[g].hasTransition())return!0;for(const g in this._layers)if(this._layers[g].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(i){if(!this._loaded)return;const l=this._changed;if(l){const g=Object.keys(this._updatedLayers),y=Object.keys(this._removedLayers);(g.length||y.length)&&this._updateWorkerLayers(g,y);for(const x in this._updatedSources){const S=this._updatedSources[x];if(S==="reload")this._reloadSource(x);else{if(S!=="clear")throw new Error(`Invalid action ${S}`);this._clearSource(x)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const x in this._updatedPaintProps)this._layers[x].updateTransitions(i);this.light.updateTransitions(i),this.sky.updateTransitions(i),this._resetUpdates()}const f={};for(const g in this.sourceCaches){const y=this.sourceCaches[g];f[g]=y.used,y.used=!1}for(const g of this._order){const y=this._layers[g];y.recalculate(i,this._availableImages),!y.isHidden(i.zoom)&&y.source&&(this.sourceCaches[y.source].used=!0)}for(const g in f){const y=this.sourceCaches[g];!!f[g]!=!!y.used&&y.fire(new o.l("data",{sourceDataType:"visibility",dataType:"source",sourceId:g}))}this.light.recalculate(i),this.sky.recalculate(i),this.projection.recalculate(i),this.z=i.zoom,l&&this.fire(new o.l("data",{dataType:"style"}))}_updateTilesForChangedImages(){const i=Object.keys(this._changedImages);if(i.length){for(const l in this.sourceCaches)this.sourceCaches[l].reloadTilesForDependencies(["icons","patterns"],i);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const i in this.sourceCaches)this.sourceCaches[i].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(i,l){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(i,!1),removedIds:l})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(i,l={}){var f;this._checkLoaded();const g=this.serialize();if(i=l.transformStyle?l.transformStyle(g,i):i,((f=l.validate)===null||f===void 0||f)&&qo(this,o.z(i)))return!1;(i=o.bJ(i)).layers=o.bH(i.layers);const y=o.bK(g,i),x=this._getOperationsToPerform(y);if(x.unimplemented.length>0)throw new Error(`Unimplemented: ${x.unimplemented.join(", ")}.`);if(x.operations.length===0)return!1;for(const S of x.operations)S();return this.stylesheet=i,this._serializedLayers=null,!0}_getOperationsToPerform(i){const l=[],f=[];for(const g of i)switch(g.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":case"setRoll":continue;case"addLayer":l.push(()=>this.addLayer.apply(this,g.args));break;case"removeLayer":l.push(()=>this.removeLayer.apply(this,g.args));break;case"setPaintProperty":l.push(()=>this.setPaintProperty.apply(this,g.args));break;case"setLayoutProperty":l.push(()=>this.setLayoutProperty.apply(this,g.args));break;case"setFilter":l.push(()=>this.setFilter.apply(this,g.args));break;case"addSource":l.push(()=>this.addSource.apply(this,g.args));break;case"removeSource":l.push(()=>this.removeSource.apply(this,g.args));break;case"setLayerZoomRange":l.push(()=>this.setLayerZoomRange.apply(this,g.args));break;case"setLight":l.push(()=>this.setLight.apply(this,g.args));break;case"setGeoJSONSourceData":l.push(()=>this.setGeoJSONSourceData.apply(this,g.args));break;case"setGlyphs":l.push(()=>this.setGlyphs.apply(this,g.args));break;case"setSprite":l.push(()=>this.setSprite.apply(this,g.args));break;case"setTerrain":l.push(()=>this.map.setTerrain.apply(this,g.args));break;case"setSky":l.push(()=>this.setSky.apply(this,g.args));break;case"setProjection":this.setProjection.apply(this,g.args);break;case"setGlobalState":l.push(()=>this.setGlobalState.apply(this,g.args));break;case"setTransition":l.push(()=>{});break;default:f.push(g.command)}return{operations:l,unimplemented:f}}addImage(i,l){if(this.getImage(i))return this.fire(new o.k(new Error(`An image named "${i}" already exists.`)));this.imageManager.addImage(i,l),this._afterImageUpdated(i)}updateImage(i,l){this.imageManager.updateImage(i,l)}getImage(i){return this.imageManager.getImage(i)}removeImage(i){if(!this.getImage(i))return this.fire(new o.k(new Error(`An image named "${i}" does not exist.`)));this.imageManager.removeImage(i),this._afterImageUpdated(i)}_afterImageUpdated(i){this._availableImages=this.imageManager.listImages(),this._changedImages[i]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new o.l("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(i,l,f={}){if(this._checkLoaded(),this.sourceCaches[i]!==void 0)throw new Error(`Source "${i}" already exists.`);if(!l.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(l).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(l.type)>=0&&this._validate(o.z.source,`sources.${i}`,l,null,f))return;this.map&&this.map._collectResourceTiming&&(l.collectResourceTiming=!0);const g=this.sourceCaches[i]=new He(i,l,this.dispatcher);g.style=this,g.setEventedParent(this,()=>({isSourceLoaded:g.loaded(),source:g.serialize(),sourceId:i})),g.onAdd(this.map),this._changed=!0}removeSource(i){if(this._checkLoaded(),this.sourceCaches[i]===void 0)throw new Error("There is no source with this ID");for(const f in this._layers)if(this._layers[f].source===i)return this.fire(new o.k(new Error(`Source "${i}" cannot be removed while layer "${f}" is using it.`)));const l=this.sourceCaches[i];delete this.sourceCaches[i],delete this._updatedSources[i],l.fire(new o.l("data",{sourceDataType:"metadata",dataType:"source",sourceId:i})),l.setEventedParent(null),l.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(i,l){if(this._checkLoaded(),this.sourceCaches[i]===void 0)throw new Error(`There is no source with this ID=${i}`);const f=this.sourceCaches[i].getSource();if(f.type!=="geojson")throw new Error(`geojsonSource.type is ${f.type}, which is !== 'geojson`);f.setData(l),this._changed=!0}getSource(i){return this.sourceCaches[i]&&this.sourceCaches[i].getSource()}addLayer(i,l,f={}){this._checkLoaded();const g=i.id;if(this.getLayer(g))return void this.fire(new o.k(new Error(`Layer "${g}" already exists on this map.`)));let y;if(i.type==="custom"){if(qo(this,o.bL(i)))return;y=o.bI(i)}else{if("source"in i&&typeof i.source=="object"&&(this.addSource(g,i.source),i=o.bJ(i),i=o.e(i,{source:g})),this._validate(o.z.layer,`layers.${g}`,i,{arrayIndex:-1},f))return;y=o.bI(i),this._validateLayer(y),y.setEventedParent(this,{layer:{id:g}})}const x=l?this._order.indexOf(l):this._order.length;if(l&&x===-1)this.fire(new o.k(new Error(`Cannot add layer "${g}" before non-existing layer "${l}".`)));else{if(this._order.splice(x,0,g),this._layerOrderChanged=!0,this._layers[g]=y,this._removedLayers[g]&&y.source&&y.type!=="custom"){const S=this._removedLayers[g];delete this._removedLayers[g],S.type!==y.type?this._updatedSources[y.source]="clear":(this._updatedSources[y.source]="reload",this.sourceCaches[y.source].pause())}this._updateLayer(y),y.onAdd&&y.onAdd(this.map)}}moveLayer(i,l){if(this._checkLoaded(),this._changed=!0,!this._layers[i])return void this.fire(new o.k(new Error(`The layer '${i}' does not exist in the map's style and cannot be moved.`)));if(i===l)return;const f=this._order.indexOf(i);this._order.splice(f,1);const g=l?this._order.indexOf(l):this._order.length;l&&g===-1?this.fire(new o.k(new Error(`Cannot move layer "${i}" before non-existing layer "${l}".`))):(this._order.splice(g,0,i),this._layerOrderChanged=!0)}removeLayer(i){this._checkLoaded();const l=this._layers[i];if(!l)return void this.fire(new o.k(new Error(`Cannot remove non-existing layer "${i}".`)));l.setEventedParent(null);const f=this._order.indexOf(i);this._order.splice(f,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[i]=l,delete this._layers[i],this._serializedLayers&&delete this._serializedLayers[i],delete this._updatedLayers[i],delete this._updatedPaintProps[i],l.onRemove&&l.onRemove(this.map)}getLayer(i){return this._layers[i]}getLayersOrder(){return[...this._order]}hasLayer(i){return i in this._layers}setLayerZoomRange(i,l,f){this._checkLoaded();const g=this.getLayer(i);g?g.minzoom===l&&g.maxzoom===f||(l!=null&&(g.minzoom=l),f!=null&&(g.maxzoom=f),this._updateLayer(g)):this.fire(new o.k(new Error(`Cannot set the zoom range of non-existing layer "${i}".`)))}setFilter(i,l,f={}){this._checkLoaded();const g=this.getLayer(i);if(g){if(!o.bG(g.filter,l))return l==null?(g.setFilter(void 0),void this._updateLayer(g)):void(this._validate(o.z.filter,`layers.${g.id}.filter`,l,null,f)||(g.setFilter(o.bJ(l)),this._updateLayer(g)))}else this.fire(new o.k(new Error(`Cannot filter non-existing layer "${i}".`)))}getFilter(i){return o.bJ(this.getLayer(i).filter)}setLayoutProperty(i,l,f,g={}){this._checkLoaded();const y=this.getLayer(i);y?o.bG(y.getLayoutProperty(l),f)||(y.setLayoutProperty(l,f,g),this._updateLayer(y)):this.fire(new o.k(new Error(`Cannot style non-existing layer "${i}".`)))}getLayoutProperty(i,l){const f=this.getLayer(i);if(f)return f.getLayoutProperty(l);this.fire(new o.k(new Error(`Cannot get style of non-existing layer "${i}".`)))}setPaintProperty(i,l,f,g={}){this._checkLoaded();const y=this.getLayer(i);y?o.bG(y.getPaintProperty(l),f)||(y.setPaintProperty(l,f,g)&&this._updateLayer(y),this._changed=!0,this._updatedPaintProps[i]=!0,this._serializedLayers=null):this.fire(new o.k(new Error(`Cannot style non-existing layer "${i}".`)))}getPaintProperty(i,l){return this.getLayer(i).getPaintProperty(l)}setFeatureState(i,l){this._checkLoaded();const f=i.source,g=i.sourceLayer,y=this.sourceCaches[f];if(y===void 0)return void this.fire(new o.k(new Error(`The source '${f}' does not exist in the map's style.`)));const x=y.getSource().type;x==="geojson"&&g?this.fire(new o.k(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):x!=="vector"||g?(i.id===void 0&&this.fire(new o.k(new Error("The feature id parameter must be provided."))),y.setFeatureState(g,i.id,l)):this.fire(new o.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(i,l){this._checkLoaded();const f=i.source,g=this.sourceCaches[f];if(g===void 0)return void this.fire(new o.k(new Error(`The source '${f}' does not exist in the map's style.`)));const y=g.getSource().type,x=y==="vector"?i.sourceLayer:void 0;y!=="vector"||x?l&&typeof i.id!="string"&&typeof i.id!="number"?this.fire(new o.k(new Error("A feature id is required to remove its specific state property."))):g.removeFeatureState(x,i.id,l):this.fire(new o.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(i){this._checkLoaded();const l=i.source,f=i.sourceLayer,g=this.sourceCaches[l];if(g!==void 0)return g.getSource().type!=="vector"||f?(i.id===void 0&&this.fire(new o.k(new Error("The feature id parameter must be provided."))),g.getFeatureState(f,i.id)):void this.fire(new o.k(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new o.k(new Error(`The source '${l}' does not exist in the map's style.`)))}getTransition(){return o.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const i=o.bM(this.sourceCaches,y=>y.serialize()),l=this._serializeByIds(this._order,!0),f=this.map.getTerrain()||void 0,g=this.stylesheet;return o.bN({version:g.version,name:g.name,metadata:g.metadata,light:g.light,sky:g.sky,center:g.center,zoom:g.zoom,bearing:g.bearing,pitch:g.pitch,sprite:g.sprite,glyphs:g.glyphs,transition:g.transition,projection:g.projection,sources:i,layers:l,terrain:f},y=>y!==void 0)}_updateLayer(i){this._updatedLayers[i.id]=!0,i.source&&!this._updatedSources[i.source]&&this.sourceCaches[i.source].getSource().type!=="raster"&&(this._updatedSources[i.source]="reload",this.sourceCaches[i.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(i){const l=x=>this._layers[x].type==="fill-extrusion",f={},g=[];for(let x=this._order.length-1;x>=0;x--){const S=this._order[x];if(l(S)){f[S]=x;for(const I of i){const M=I[S];if(M)for(const k of M)g.push(k)}}}g.sort((x,S)=>S.intersectionZ-x.intersectionZ);const y=[];for(let x=this._order.length-1;x>=0;x--){const S=this._order[x];if(l(S))for(let I=g.length-1;I>=0;I--){const M=g[I].feature;if(f[M.layer.id]<x)break;y.push(M),g.pop()}else for(const I of i){const M=I[S];if(M)for(const k of M)y.push(k.feature)}}return y}queryRenderedFeatures(i,l,f){l&&l.filter&&this._validate(o.z.filter,"queryRenderedFeatures.filter",l.filter,null,l);const g={};if(l&&l.layers){if(!(Array.isArray(l.layers)||l.layers instanceof Set))return this.fire(new o.k(new Error("parameters.layers must be an Array or a Set of strings"))),[];for(const M of l.layers){const k=this._layers[M];if(!k)return this.fire(new o.k(new Error(`The layer '${M}' does not exist in the map's style and cannot be queried for features.`))),[];g[k.source]=!0}}const y=[];l.availableImages=this._availableImages;const x=this._serializedAllLayers(),S=l.layers instanceof Set?l.layers:Array.isArray(l.layers)?new Set(l.layers):null,I=Object.assign(Object.assign({},l),{layers:S});for(const M in this.sourceCaches)l.layers&&!g[M]||y.push(kt(this.sourceCaches[M],this._layers,x,i,I,f,this.map.terrain?(k,B,F)=>this.map.terrain.getElevation(k,B,F):void 0));return this.placement&&y.push(function(M,k,B,F,N,W,J){const G={},Q=W.queryRenderedSymbols(F),re=[];for(const ae of Object.keys(Q).map(Number))re.push(J[ae]);re.sort(gr);for(const ae of re){const se=ae.featureIndex.lookupSymbolFeatures(Q[ae.bucketInstanceId],k,ae.bucketIndex,ae.sourceLayerIndex,N.filter,N.layers,N.availableImages,M);for(const ue in se){const de=G[ue]=G[ue]||[],oe=se[ue];oe.sort((ye,Oe)=>{const Ce=ae.featureSortOrder;if(Ce){const Me=Ce.indexOf(ye.featureIndex);return Ce.indexOf(Oe.featureIndex)-Me}return Oe.featureIndex-ye.featureIndex});for(const ye of oe)de.push(ye)}}return function(ae,se,ue){for(const de in ae)for(const oe of ae[de])Tt(oe,ue[se[de].source]);return ae}(G,M,B)}(this._layers,x,this.sourceCaches,i,I,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(y)}querySourceFeatures(i,l){l&&l.filter&&this._validate(o.z.filter,"querySourceFeatures.filter",l.filter,null,l);const f=this.sourceCaches[i];return f?function(g,y){const x=g.getRenderableIds().map(M=>g.getTileByID(M)),S=[],I={};for(let M=0;M<x.length;M++){const k=x[M],B=k.tileID.canonical.key;I[B]||(I[B]=!0,k.querySourceFeatures(S,y))}return S}(f,l):[]}getLight(){return this.light.getLight()}setLight(i,l={}){this._checkLoaded();const f=this.light.getLight();let g=!1;for(const x in i)if(!o.bG(i[x],f[x])){g=!0;break}if(!g)return;const y={now:$.now(),transition:o.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(i,l),this.light.updateTransitions(y)}getProjection(){var i;return(i=this.stylesheet)===null||i===void 0?void 0:i.projection}setProjection(i){if(this._checkLoaded(),this.projection){if(this.projection.name===i.type)return;this.projection.destroy(),delete this.projection}this.stylesheet.projection=i,this._setProjectionInternal(i.type)}getSky(){var i;return(i=this.stylesheet)===null||i===void 0?void 0:i.sky}setSky(i,l={}){this._checkLoaded();const f=this.getSky();let g=!1;if(!i&&!f)return;if(i&&!f)g=!0;else if(!i&&f)g=!0;else for(const x in i)if(!o.bG(i[x],f[x])){g=!0;break}if(!g)return;const y={now:$.now(),transition:o.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=i,this.sky.setSky(i,l),this.sky.updateTransitions(y)}_setProjectionInternal(i){const l=function(f){if(Array.isArray(f)){const g=new $o({type:f});return{projection:g,transform:new nn,cameraHelper:new xc(g)}}switch(f){case"mercator":return{projection:new _c,transform:new Gr,cameraHelper:new Ya};case"globe":{const g=new $o({type:["interpolate",["linear"],["zoom"],11,"vertical-perspective",12,"mercator"]});return{projection:g,transform:new nn,cameraHelper:new xc(g)}}case"vertical-perspective":return{projection:new uu,transform:new Qs,cameraHelper:new Xi};default:return o.w(`Unknown projection name: ${f}. Falling back to mercator projection.`),{projection:new _c,transform:new Gr,cameraHelper:new Ya}}}(i);this.projection=l.projection,this.map.migrateProjection(l.transform,l.cameraHelper);for(const f in this.sourceCaches)this.sourceCaches[f].reload()}_validate(i,l,f,g,y={}){return(!y||y.validate!==!1)&&qo(this,i.call(o.z,o.e({key:l,style:this.serialize(),value:f,styleSpec:o.v},g)))}_remove(i=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),yr().off(Sr,this._rtlPluginLoaded);for(const l in this._layers)this._layers[l].setEventedParent(null);for(const l in this.sourceCaches){const f=this.sourceCaches[l];f.setEventedParent(null),f.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),i&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(i)}_clearSource(i){this.sourceCaches[i].clearTiles()}_reloadSource(i){this.sourceCaches[i].resume(),this.sourceCaches[i].reload()}_updateSources(i){for(const l in this.sourceCaches)this.sourceCaches[l].update(i,this.map.terrain)}_generateCollisionBoxes(){for(const i in this.sourceCaches)this._reloadSource(i)}_updatePlacement(i,l,f,g,y=!1){let x=!1,S=!1;const I={};for(const M of this._order){const k=this._layers[M];if(k.type!=="symbol")continue;if(!I[k.source]){const F=this.sourceCaches[k.source];I[k.source]=F.getRenderableIds(!0).map(N=>F.getTileByID(N)).sort((N,W)=>W.tileID.overscaledZ-N.tileID.overscaledZ||(N.tileID.isLessThan(W.tileID)?-1:1))}const B=this.crossTileSymbolIndex.addLayer(k,I[k.source],i.center.lng);x=x||B}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((y=y||this._layerOrderChanged||f===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent($.now(),i.zoom))&&(this.pauseablePlacement=new cu(i,this.map.terrain,this._order,y,l,f,g,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,I),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit($.now()),S=!0),x&&this.pauseablePlacement.placement.setStale()),S||x)for(const M of this._order){const k=this._layers[M];k.type==="symbol"&&this.placement.updateLayerOpacities(k,I[k.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions($.now())}_releaseSymbolFadeTiles(){for(const i in this.sourceCaches)this.sourceCaches[i].releaseSymbolFadeTiles()}getImages(i,l){return o._(this,void 0,void 0,function*(){const f=yield this.imageManager.getImages(l.icons);this._updateTilesForChangedImages();const g=this.sourceCaches[l.source];return g&&g.setDependencies(l.tileID.key,l.type,l.icons),f})}getGlyphs(i,l){return o._(this,void 0,void 0,function*(){const f=yield this.glyphManager.getGlyphs(l.stacks),g=this.sourceCaches[l.source];return g&&g.setDependencies(l.tileID.key,l.type,[""]),f})}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(i,l={}){this._checkLoaded(),i&&this._validate(o.z.glyphs,"glyphs",i,null,l)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=i,this.glyphManager.entries={},this.glyphManager.setURL(i))}addSprite(i,l,f={},g){this._checkLoaded();const y=[{id:i,url:l}],x=[...Ke(this.stylesheet.sprite),...y];this._validate(o.z.sprite,"sprite",x,null,f)||(this.stylesheet.sprite=x,this._loadSprite(y,!0,g))}removeSprite(i){this._checkLoaded();const l=Ke(this.stylesheet.sprite);if(l.find(f=>f.id===i)){if(this._spritesImagesIds[i])for(const f of this._spritesImagesIds[i])this.imageManager.removeImage(f),this._changedImages[f]=!0;l.splice(l.findIndex(f=>f.id===i),1),this.stylesheet.sprite=l.length>0?l:void 0,delete this._spritesImagesIds[i],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new o.l("data",{dataType:"style"}))}else this.fire(new o.k(new Error(`Sprite "${i}" doesn't exists on this map.`)))}getSprite(){return Ke(this.stylesheet.sprite)}setSprite(i,l={},f){this._checkLoaded(),i&&this._validate(o.z.sprite,"sprite",i,null,l)||(this.stylesheet.sprite=i,i?this._loadSprite(i,!0,f):(this._unloadSprite(),f&&f(null)))}}var wf=o.aI([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class Tf{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(i,l,f,g,y,x,S,I,M){this.context=i;let k=this.boundPaintVertexBuffers.length!==g.length;for(let B=0;!k&&B<g.length;B++)this.boundPaintVertexBuffers[B]!==g[B]&&(k=!0);!this.vao||this.boundProgram!==l||this.boundLayoutVertexBuffer!==f||k||this.boundIndexBuffer!==y||this.boundVertexOffset!==x||this.boundDynamicVertexBuffer!==S||this.boundDynamicVertexBuffer2!==I||this.boundDynamicVertexBuffer3!==M?this.freshBind(l,f,g,y,x,S,I,M):(i.bindVertexArray.set(this.vao),S&&S.bind(),y&&y.dynamicDraw&&y.bind(),I&&I.bind(),M&&M.bind())}freshBind(i,l,f,g,y,x,S,I){const M=i.numAttributes,k=this.context,B=k.gl;this.vao&&this.destroy(),this.vao=k.createVertexArray(),k.bindVertexArray.set(this.vao),this.boundProgram=i,this.boundLayoutVertexBuffer=l,this.boundPaintVertexBuffers=f,this.boundIndexBuffer=g,this.boundVertexOffset=y,this.boundDynamicVertexBuffer=x,this.boundDynamicVertexBuffer2=S,this.boundDynamicVertexBuffer3=I,l.enableAttributes(B,i);for(const F of f)F.enableAttributes(B,i);x&&x.enableAttributes(B,i),S&&S.enableAttributes(B,i),I&&I.enableAttributes(B,i),l.bind(),l.setVertexAttribPointers(B,i,y);for(const F of f)F.bind(),F.setVertexAttribPointers(B,i,y);x&&(x.bind(),x.setVertexAttribPointers(B,i,y)),g&&g.bind(),S&&(S.bind(),S.setVertexAttribPointers(B,i,y)),I&&(I.bind(),I.setVertexAttribPointers(B,i,y)),k.currentNumAttributes=M}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}const Sf=(_,i,l,f,g)=>({u_texture:0,u_ele_delta:_,u_fog_matrix:i,u_fog_color:l?l.properties.get("fog-color"):o.be.white,u_fog_ground_blend:l?l.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:g?0:l?l.calculateFogBlendOpacity(f):0,u_horizon_color:l?l.properties.get("horizon-color"):o.be.white,u_horizon_fog_blend:l?l.properties.get("horizon-fog-blend"):1,u_is_globe_mode:g?1:0}),Af={mainMatrix:"u_projection_matrix",tileMercatorCoords:"u_projection_tile_mercator_coords",clippingPlane:"u_projection_clipping_plane",projectionTransition:"u_projection_transition",fallbackMatrix:"u_projection_fallback_matrix"};function Ga(_){const i=[];for(let l=0;l<_.length;l++){if(_[l]===null)continue;const f=_[l].split(" ");i.push(f.pop())}return i}class Ka{constructor(i,l,f,g,y,x,S,I,M=[]){const k=i.gl;this.program=k.createProgram();const B=Ga(l.staticAttributes),F=f?f.getBinderAttributes():[],N=B.concat(F),W=Cn.prelude.staticUniforms?Ga(Cn.prelude.staticUniforms):[],J=S.staticUniforms?Ga(S.staticUniforms):[],G=l.staticUniforms?Ga(l.staticUniforms):[],Q=f?f.getBinderUniforms():[],re=W.concat(J).concat(G).concat(Q),ae=[];for(const Ce of re)ae.indexOf(Ce)<0&&ae.push(Ce);const se=f?f.defines():[];zi(k)&&se.unshift("#version 300 es"),y&&se.push("#define OVERDRAW_INSPECTOR;"),x&&se.push("#define TERRAIN3D;"),I&&se.push(I),M&&se.push(...M);let ue=se.concat(Cn.prelude.fragmentSource,S.fragmentSource,l.fragmentSource).join(`
`),de=se.concat(Cn.prelude.vertexSource,S.vertexSource,l.vertexSource).join(`
`);zi(k)||(ue=function(Ce){return Ce.replace(/\bin\s/g,"varying ").replace("out highp vec4 fragColor;","").replace(/fragColor/g,"gl_FragColor").replace(/texture\(/g,"texture2D(")}(ue),de=function(Ce){return Ce.replace(/\bin\s/g,"attribute ").replace(/\bout\s/g,"varying ").replace(/texture\(/g,"texture2D(")}(de));const oe=k.createShader(k.FRAGMENT_SHADER);if(k.isContextLost())return void(this.failedToCreate=!0);if(k.shaderSource(oe,ue),k.compileShader(oe),!k.getShaderParameter(oe,k.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${k.getShaderInfoLog(oe)}`);k.attachShader(this.program,oe);const ye=k.createShader(k.VERTEX_SHADER);if(k.isContextLost())return void(this.failedToCreate=!0);if(k.shaderSource(ye,de),k.compileShader(ye),!k.getShaderParameter(ye,k.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${k.getShaderInfoLog(ye)}`);k.attachShader(this.program,ye),this.attributes={};const Oe={};this.numAttributes=N.length;for(let Ce=0;Ce<this.numAttributes;Ce++)N[Ce]&&(k.bindAttribLocation(this.program,Ce,N[Ce]),this.attributes[N[Ce]]=Ce);if(k.linkProgram(this.program),!k.getProgramParameter(this.program,k.LINK_STATUS))throw new Error(`Program failed to link: ${k.getProgramInfoLog(this.program)}`);k.deleteShader(ye),k.deleteShader(oe);for(let Ce=0;Ce<ae.length;Ce++){const Me=ae[Ce];if(Me&&!Oe[Me]){const Fe=k.getUniformLocation(this.program,Me);Fe&&(Oe[Me]=Fe)}}this.fixedUniforms=g(i,Oe),this.terrainUniforms=((Ce,Me)=>({u_depth:new o.bO(Ce,Me.u_depth),u_terrain:new o.bO(Ce,Me.u_terrain),u_terrain_dim:new o.bf(Ce,Me.u_terrain_dim),u_terrain_matrix:new o.bQ(Ce,Me.u_terrain_matrix),u_terrain_unpack:new o.bR(Ce,Me.u_terrain_unpack),u_terrain_exaggeration:new o.bf(Ce,Me.u_terrain_exaggeration)}))(i,Oe),this.projectionUniforms=((Ce,Me)=>({u_projection_matrix:new o.bQ(Ce,Me.u_projection_matrix),u_projection_tile_mercator_coords:new o.bR(Ce,Me.u_projection_tile_mercator_coords),u_projection_clipping_plane:new o.bR(Ce,Me.u_projection_clipping_plane),u_projection_transition:new o.bf(Ce,Me.u_projection_transition),u_projection_fallback_matrix:new o.bQ(Ce,Me.u_projection_fallback_matrix)}))(i,Oe),this.binderUniforms=f?f.getUniforms(i,Oe):[]}draw(i,l,f,g,y,x,S,I,M,k,B,F,N,W,J,G,Q,re,ae){const se=i.gl;if(this.failedToCreate)return;if(i.program.set(this.program),i.setDepthMode(f),i.setStencilMode(g),i.setColorMode(y),i.setCullFace(x),I){i.activeTexture.set(se.TEXTURE2),se.bindTexture(se.TEXTURE_2D,I.depthTexture),i.activeTexture.set(se.TEXTURE3),se.bindTexture(se.TEXTURE_2D,I.texture);for(const de in this.terrainUniforms)this.terrainUniforms[de].set(I[de])}if(M)for(const de in M)this.projectionUniforms[Af[de]].set(M[de]);if(S)for(const de in this.fixedUniforms)this.fixedUniforms[de].set(S[de]);G&&G.setUniforms(i,this.binderUniforms,W,{zoom:J});let ue=0;switch(l){case se.LINES:ue=2;break;case se.TRIANGLES:ue=3;break;case se.LINE_STRIP:ue=1}for(const de of N.get()){const oe=de.vaos||(de.vaos={});(oe[k]||(oe[k]=new Tf)).bind(i,this,B,G?G.getPaintVertexBuffers():[],F,de.vertexOffset,Q,re,ae),se.drawElements(l,de.primitiveLength*ue,se.UNSIGNED_SHORT,de.primitiveOffset*ue*2)}}}function Ja(_,i,l){const f=1/o.aB(l,1,i.transform.tileZoom),g=Math.pow(2,l.tileID.overscaledZ),y=l.tileSize*Math.pow(2,i.transform.tileZoom)/g,x=y*(l.tileID.canonical.x+l.tileID.wrap*g),S=y*l.tileID.canonical.y;return{u_image:0,u_texsize:l.imageAtlasTexture.size,u_scale:[f,_.fromScale,_.toScale],u_fade:_.t,u_pixel_coord_upper:[x>>16,S>>16],u_pixel_coord_lower:[65535&x,65535&S]}}const Yo=(_,i,l,f)=>{const g=_.style.light,y=g.properties.get("position"),x=[y.x,y.y,y.z],S=o.bU();g.properties.get("anchor")==="viewport"&&o.bV(S,_.transform.bearingInRadians),o.bW(x,x,S);const I=_.transform.transformLightDirection(x),M=g.properties.get("color");return{u_lightpos:x,u_lightpos_globe:I,u_lightintensity:g.properties.get("intensity"),u_lightcolor:[M.r,M.g,M.b],u_vertical_gradient:+i,u_opacity:l,u_fill_translate:f}},Tc=(_,i,l,f,g,y,x)=>o.e(Yo(_,i,l,f),Ja(y,_,x),{u_height_factor:-Math.pow(2,g.overscaledZ)/x.tileSize/8}),Qa=(_,i,l,f)=>o.e(Ja(i,_,l),{u_fill_translate:f}),Mn=(_,i)=>({u_world:_,u_fill_translate:i}),Ef=(_,i,l,f,g)=>o.e(Qa(_,i,l,g),{u_world:f}),Sc=(_,i,l,f,g)=>{const y=_.transform;let x,S,I=0;if(l.paint.get("circle-pitch-alignment")==="map"){const M=o.aB(i,1,y.zoom);x=!0,S=[M,M],I=M/(o.$*Math.pow(2,i.tileID.overscaledZ))*2*Math.PI*g}else x=!1,S=y.pixelsToGLUnits;return{u_camera_to_center_distance:y.cameraToCenterDistance,u_scale_with_map:+(l.paint.get("circle-pitch-scale")==="map"),u_pitch_with_map:+x,u_device_pixel_ratio:_.pixelRatio,u_extrude_scale:S,u_globe_extrude_scale:I,u_translate:f}},Go=_=>({u_pixel_extrude_scale:[1/_.width,1/_.height]}),Ko=_=>({u_viewport_size:[_.width,_.height]}),fu=(_,i=1)=>({u_color:_,u_overlay:0,u_overlay_scale:i}),Jo=(_,i,l,f)=>{const g=o.aB(_,1,i)/(o.$*Math.pow(2,_.tileID.overscaledZ))*2*Math.PI*f;return{u_extrude_scale:o.aB(_,1,i),u_intensity:l,u_globe_extrude_scale:g}},pu=(_,i,l,f)=>{const g=o.L();o.bX(g,0,_.width,_.height,0,0,1);const y=_.context.gl;return{u_matrix:g,u_world:[y.drawingBufferWidth,y.drawingBufferHeight],u_image:l,u_color_ramp:f,u_opacity:i.paint.get("heatmap-opacity")}},to=(_,i,l)=>{const f=l.paint.get("hillshade-accent-color");let g;switch(l.paint.get("hillshade-method")){case"basic":g=4;break;case"combined":g=1;break;case"igor":g=2;break;case"multidirectional":g=3;break;default:g=0}const y=l.getIlluminationProperties();for(let x=0;x<y.directionRadians.length;x++)l.paint.get("hillshade-illumination-anchor")==="viewport"&&(y.directionRadians[x]+=_.transform.bearingInRadians);return{u_image:0,u_latrange:gu(0,i.tileID),u_exaggeration:l.paint.get("hillshade-exaggeration"),u_altitudes:y.altitudeRadians,u_azimuths:y.directionRadians,u_accent:f,u_method:g,u_highlights:y.highlightColor,u_shadows:y.shadowColor}},If=(_,i)=>{const l=i.stride,f=o.L();return o.bX(f,0,o.$,-o.$,0,0,1),o.M(f,f,[0,-o.$,0]),{u_matrix:f,u_image:1,u_dimension:[l,l],u_zoom:_.overscaledZ,u_unpack:i.getUnpackVector()}};function gu(_,i){const l=Math.pow(2,i.canonical.z),f=i.canonical.y;return[new o.a0(0,f/l).toLngLat().lat,new o.a0(0,(f+1)/l).toLngLat().lat]}const Cf=(_,i,l=0)=>({u_image:0,u_unpack:i.getUnpackVector(),u_dimension:[i.stride,i.stride],u_elevation_stops:1,u_color_stops:4,u_color_ramp_size:l,u_opacity:_.paint.get("color-relief-opacity")}),el=(_,i,l,f)=>{const g=_.transform;return{u_translation:Ic(_,i,l),u_ratio:f/o.aB(i,1,g.zoom),u_device_pixel_ratio:_.pixelRatio,u_units_to_pixels:[1/g.pixelsToGLUnits[0],1/g.pixelsToGLUnits[1]]}},Ac=(_,i,l,f,g)=>o.e(el(_,i,l,f),{u_image:0,u_image_height:g}),mu=(_,i,l,f,g)=>{const y=_.transform,x=Ec(i,y);return{u_translation:Ic(_,i,l),u_texsize:i.imageAtlasTexture.size,u_ratio:f/o.aB(i,1,y.zoom),u_device_pixel_ratio:_.pixelRatio,u_image:0,u_scale:[x,g.fromScale,g.toScale],u_fade:g.t,u_units_to_pixels:[1/y.pixelsToGLUnits[0],1/y.pixelsToGLUnits[1]]}},_u=(_,i,l,f,g,y)=>{const x=_.lineAtlas,S=Ec(i,_.transform),I=l.layout.get("line-cap")==="round",M=x.getDash(g.from,I),k=x.getDash(g.to,I),B=M.width*y.fromScale,F=k.width*y.toScale;return o.e(el(_,i,l,f),{u_patternscale_a:[S/B,-M.height/2],u_patternscale_b:[S/F,-k.height/2],u_sdfgamma:x.width/(256*Math.min(B,F)*_.pixelRatio)/2,u_image:0,u_tex_y_a:M.y,u_tex_y_b:k.y,u_mix:y.t})};function Ec(_,i){return 1/o.aB(_,1,i.tileZoom)}function Ic(_,i,l){return o.aC(_.transform,i,l.paint.get("line-translate"),l.paint.get("line-translate-anchor"))}const ks=(_,i,l,f,g)=>{return{u_tl_parent:_,u_scale_parent:i,u_buffer_scale:1,u_fade_t:l.mix,u_opacity:l.opacity*f.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:f.paint.get("raster-brightness-min"),u_brightness_high:f.paint.get("raster-brightness-max"),u_saturation_factor:(x=f.paint.get("raster-saturation"),x>0?1-1/(1.001-x):-x),u_contrast_factor:(y=f.paint.get("raster-contrast"),y>0?1/(1-y):1+y),u_spin_weights:yu(f.paint.get("raster-hue-rotate")),u_coords_top:[g[0].x,g[0].y,g[1].x,g[1].y],u_coords_bottom:[g[3].x,g[3].y,g[2].x,g[2].y]};var y,x};function yu(_){_*=Math.PI/180;const i=Math.sin(_),l=Math.cos(_);return[(2*l+1)/3,(-Math.sqrt(3)*i-l+1)/3,(Math.sqrt(3)*i-l+1)/3]}const Cc=(_,i,l,f,g,y,x,S,I,M,k,B,F)=>{const N=x.transform;return{u_is_size_zoom_constant:+(_==="constant"||_==="source"),u_is_size_feature_constant:+(_==="constant"||_==="camera"),u_size_t:i?i.uSizeT:0,u_size:i?i.uSize:0,u_camera_to_center_distance:N.cameraToCenterDistance,u_pitch:N.pitch/360*2*Math.PI,u_rotate_symbol:+l,u_aspect_ratio:N.width/N.height,u_fade_change:x.options.fadeDuration?x.symbolFadeChange:1,u_label_plane_matrix:S,u_coord_matrix:I,u_is_text:+k,u_pitch_with_map:+f,u_is_along_line:g,u_is_variable_anchor:y,u_texsize:B,u_texture:0,u_translation:M,u_pitched_scale:F}},ro=(_,i,l,f,g,y,x,S,I,M,k,B,F,N)=>{const W=x.transform;return o.e(Cc(_,i,l,f,g,y,x,S,I,M,k,B,N),{u_gamma_scale:f?Math.cos(W.pitch*Math.PI/180)*W.cameraToCenterDistance:1,u_device_pixel_ratio:x.pixelRatio,u_is_halo:1})},Pf=(_,i,l,f,g,y,x,S,I,M,k,B,F)=>o.e(ro(_,i,l,f,g,y,x,S,I,M,!0,k,0,F),{u_texsize_icon:B,u_texture_icon:1}),tl=(_,i)=>({u_opacity:_,u_color:i}),Mf=(_,i,l,f,g)=>o.e(function(y,x,S,I){const M=S.imageManager.getPattern(y.from.toString()),k=S.imageManager.getPattern(y.to.toString()),{width:B,height:F}=S.imageManager.getPixelSize(),N=Math.pow(2,I.tileID.overscaledZ),W=I.tileSize*Math.pow(2,S.transform.tileZoom)/N,J=W*(I.tileID.canonical.x+I.tileID.wrap*N),G=W*I.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:M.tl,u_pattern_br_a:M.br,u_pattern_tl_b:k.tl,u_pattern_br_b:k.br,u_texsize:[B,F],u_mix:x.t,u_pattern_size_a:M.displaySize,u_pattern_size_b:k.displaySize,u_scale_a:x.fromScale,u_scale_b:x.toScale,u_tile_units_to_pixels:1/o.aB(I,1,S.transform.tileZoom),u_pixel_coord_upper:[J>>16,G>>16],u_pixel_coord_lower:[65535&J,65535&G]}}(l,g,i,f),{u_opacity:_}),bu=(_,i)=>{},vu={fillExtrusion:(_,i)=>({u_lightpos:new o.bS(_,i.u_lightpos),u_lightpos_globe:new o.bS(_,i.u_lightpos_globe),u_lightintensity:new o.bf(_,i.u_lightintensity),u_lightcolor:new o.bS(_,i.u_lightcolor),u_vertical_gradient:new o.bf(_,i.u_vertical_gradient),u_opacity:new o.bf(_,i.u_opacity),u_fill_translate:new o.bT(_,i.u_fill_translate)}),fillExtrusionPattern:(_,i)=>({u_lightpos:new o.bS(_,i.u_lightpos),u_lightpos_globe:new o.bS(_,i.u_lightpos_globe),u_lightintensity:new o.bf(_,i.u_lightintensity),u_lightcolor:new o.bS(_,i.u_lightcolor),u_vertical_gradient:new o.bf(_,i.u_vertical_gradient),u_height_factor:new o.bf(_,i.u_height_factor),u_opacity:new o.bf(_,i.u_opacity),u_fill_translate:new o.bT(_,i.u_fill_translate),u_image:new o.bO(_,i.u_image),u_texsize:new o.bT(_,i.u_texsize),u_pixel_coord_upper:new o.bT(_,i.u_pixel_coord_upper),u_pixel_coord_lower:new o.bT(_,i.u_pixel_coord_lower),u_scale:new o.bS(_,i.u_scale),u_fade:new o.bf(_,i.u_fade)}),fill:(_,i)=>({u_fill_translate:new o.bT(_,i.u_fill_translate)}),fillPattern:(_,i)=>({u_image:new o.bO(_,i.u_image),u_texsize:new o.bT(_,i.u_texsize),u_pixel_coord_upper:new o.bT(_,i.u_pixel_coord_upper),u_pixel_coord_lower:new o.bT(_,i.u_pixel_coord_lower),u_scale:new o.bS(_,i.u_scale),u_fade:new o.bf(_,i.u_fade),u_fill_translate:new o.bT(_,i.u_fill_translate)}),fillOutline:(_,i)=>({u_world:new o.bT(_,i.u_world),u_fill_translate:new o.bT(_,i.u_fill_translate)}),fillOutlinePattern:(_,i)=>({u_world:new o.bT(_,i.u_world),u_image:new o.bO(_,i.u_image),u_texsize:new o.bT(_,i.u_texsize),u_pixel_coord_upper:new o.bT(_,i.u_pixel_coord_upper),u_pixel_coord_lower:new o.bT(_,i.u_pixel_coord_lower),u_scale:new o.bS(_,i.u_scale),u_fade:new o.bf(_,i.u_fade),u_fill_translate:new o.bT(_,i.u_fill_translate)}),circle:(_,i)=>({u_camera_to_center_distance:new o.bf(_,i.u_camera_to_center_distance),u_scale_with_map:new o.bO(_,i.u_scale_with_map),u_pitch_with_map:new o.bO(_,i.u_pitch_with_map),u_extrude_scale:new o.bT(_,i.u_extrude_scale),u_device_pixel_ratio:new o.bf(_,i.u_device_pixel_ratio),u_globe_extrude_scale:new o.bf(_,i.u_globe_extrude_scale),u_translate:new o.bT(_,i.u_translate)}),collisionBox:(_,i)=>({u_pixel_extrude_scale:new o.bT(_,i.u_pixel_extrude_scale)}),collisionCircle:(_,i)=>({u_viewport_size:new o.bT(_,i.u_viewport_size)}),debug:(_,i)=>({u_color:new o.bP(_,i.u_color),u_overlay:new o.bO(_,i.u_overlay),u_overlay_scale:new o.bf(_,i.u_overlay_scale)}),depth:bu,clippingMask:bu,heatmap:(_,i)=>({u_extrude_scale:new o.bf(_,i.u_extrude_scale),u_intensity:new o.bf(_,i.u_intensity),u_globe_extrude_scale:new o.bf(_,i.u_globe_extrude_scale)}),heatmapTexture:(_,i)=>({u_matrix:new o.bQ(_,i.u_matrix),u_world:new o.bT(_,i.u_world),u_image:new o.bO(_,i.u_image),u_color_ramp:new o.bO(_,i.u_color_ramp),u_opacity:new o.bf(_,i.u_opacity)}),hillshade:(_,i)=>({u_image:new o.bO(_,i.u_image),u_latrange:new o.bT(_,i.u_latrange),u_exaggeration:new o.bf(_,i.u_exaggeration),u_altitudes:new o.bZ(_,i.u_altitudes),u_azimuths:new o.bZ(_,i.u_azimuths),u_accent:new o.bP(_,i.u_accent),u_method:new o.bO(_,i.u_method),u_shadows:new o.bY(_,i.u_shadows),u_highlights:new o.bY(_,i.u_highlights)}),hillshadePrepare:(_,i)=>({u_matrix:new o.bQ(_,i.u_matrix),u_image:new o.bO(_,i.u_image),u_dimension:new o.bT(_,i.u_dimension),u_zoom:new o.bf(_,i.u_zoom),u_unpack:new o.bR(_,i.u_unpack)}),colorRelief:(_,i)=>({u_image:new o.bO(_,i.u_image),u_unpack:new o.bR(_,i.u_unpack),u_dimension:new o.bT(_,i.u_dimension),u_elevation_stops:new o.bO(_,i.u_elevation_stops),u_color_stops:new o.bO(_,i.u_color_stops),u_color_ramp_size:new o.bO(_,i.u_color_ramp_size),u_opacity:new o.bf(_,i.u_opacity)}),line:(_,i)=>({u_translation:new o.bT(_,i.u_translation),u_ratio:new o.bf(_,i.u_ratio),u_device_pixel_ratio:new o.bf(_,i.u_device_pixel_ratio),u_units_to_pixels:new o.bT(_,i.u_units_to_pixels)}),lineGradient:(_,i)=>({u_translation:new o.bT(_,i.u_translation),u_ratio:new o.bf(_,i.u_ratio),u_device_pixel_ratio:new o.bf(_,i.u_device_pixel_ratio),u_units_to_pixels:new o.bT(_,i.u_units_to_pixels),u_image:new o.bO(_,i.u_image),u_image_height:new o.bf(_,i.u_image_height)}),linePattern:(_,i)=>({u_translation:new o.bT(_,i.u_translation),u_texsize:new o.bT(_,i.u_texsize),u_ratio:new o.bf(_,i.u_ratio),u_device_pixel_ratio:new o.bf(_,i.u_device_pixel_ratio),u_image:new o.bO(_,i.u_image),u_units_to_pixels:new o.bT(_,i.u_units_to_pixels),u_scale:new o.bS(_,i.u_scale),u_fade:new o.bf(_,i.u_fade)}),lineSDF:(_,i)=>({u_translation:new o.bT(_,i.u_translation),u_ratio:new o.bf(_,i.u_ratio),u_device_pixel_ratio:new o.bf(_,i.u_device_pixel_ratio),u_units_to_pixels:new o.bT(_,i.u_units_to_pixels),u_patternscale_a:new o.bT(_,i.u_patternscale_a),u_patternscale_b:new o.bT(_,i.u_patternscale_b),u_sdfgamma:new o.bf(_,i.u_sdfgamma),u_image:new o.bO(_,i.u_image),u_tex_y_a:new o.bf(_,i.u_tex_y_a),u_tex_y_b:new o.bf(_,i.u_tex_y_b),u_mix:new o.bf(_,i.u_mix)}),raster:(_,i)=>({u_tl_parent:new o.bT(_,i.u_tl_parent),u_scale_parent:new o.bf(_,i.u_scale_parent),u_buffer_scale:new o.bf(_,i.u_buffer_scale),u_fade_t:new o.bf(_,i.u_fade_t),u_opacity:new o.bf(_,i.u_opacity),u_image0:new o.bO(_,i.u_image0),u_image1:new o.bO(_,i.u_image1),u_brightness_low:new o.bf(_,i.u_brightness_low),u_brightness_high:new o.bf(_,i.u_brightness_high),u_saturation_factor:new o.bf(_,i.u_saturation_factor),u_contrast_factor:new o.bf(_,i.u_contrast_factor),u_spin_weights:new o.bS(_,i.u_spin_weights),u_coords_top:new o.bR(_,i.u_coords_top),u_coords_bottom:new o.bR(_,i.u_coords_bottom)}),symbolIcon:(_,i)=>({u_is_size_zoom_constant:new o.bO(_,i.u_is_size_zoom_constant),u_is_size_feature_constant:new o.bO(_,i.u_is_size_feature_constant),u_size_t:new o.bf(_,i.u_size_t),u_size:new o.bf(_,i.u_size),u_camera_to_center_distance:new o.bf(_,i.u_camera_to_center_distance),u_pitch:new o.bf(_,i.u_pitch),u_rotate_symbol:new o.bO(_,i.u_rotate_symbol),u_aspect_ratio:new o.bf(_,i.u_aspect_ratio),u_fade_change:new o.bf(_,i.u_fade_change),u_label_plane_matrix:new o.bQ(_,i.u_label_plane_matrix),u_coord_matrix:new o.bQ(_,i.u_coord_matrix),u_is_text:new o.bO(_,i.u_is_text),u_pitch_with_map:new o.bO(_,i.u_pitch_with_map),u_is_along_line:new o.bO(_,i.u_is_along_line),u_is_variable_anchor:new o.bO(_,i.u_is_variable_anchor),u_texsize:new o.bT(_,i.u_texsize),u_texture:new o.bO(_,i.u_texture),u_translation:new o.bT(_,i.u_translation),u_pitched_scale:new o.bf(_,i.u_pitched_scale)}),symbolSDF:(_,i)=>({u_is_size_zoom_constant:new o.bO(_,i.u_is_size_zoom_constant),u_is_size_feature_constant:new o.bO(_,i.u_is_size_feature_constant),u_size_t:new o.bf(_,i.u_size_t),u_size:new o.bf(_,i.u_size),u_camera_to_center_distance:new o.bf(_,i.u_camera_to_center_distance),u_pitch:new o.bf(_,i.u_pitch),u_rotate_symbol:new o.bO(_,i.u_rotate_symbol),u_aspect_ratio:new o.bf(_,i.u_aspect_ratio),u_fade_change:new o.bf(_,i.u_fade_change),u_label_plane_matrix:new o.bQ(_,i.u_label_plane_matrix),u_coord_matrix:new o.bQ(_,i.u_coord_matrix),u_is_text:new o.bO(_,i.u_is_text),u_pitch_with_map:new o.bO(_,i.u_pitch_with_map),u_is_along_line:new o.bO(_,i.u_is_along_line),u_is_variable_anchor:new o.bO(_,i.u_is_variable_anchor),u_texsize:new o.bT(_,i.u_texsize),u_texture:new o.bO(_,i.u_texture),u_gamma_scale:new o.bf(_,i.u_gamma_scale),u_device_pixel_ratio:new o.bf(_,i.u_device_pixel_ratio),u_is_halo:new o.bO(_,i.u_is_halo),u_translation:new o.bT(_,i.u_translation),u_pitched_scale:new o.bf(_,i.u_pitched_scale)}),symbolTextAndIcon:(_,i)=>({u_is_size_zoom_constant:new o.bO(_,i.u_is_size_zoom_constant),u_is_size_feature_constant:new o.bO(_,i.u_is_size_feature_constant),u_size_t:new o.bf(_,i.u_size_t),u_size:new o.bf(_,i.u_size),u_camera_to_center_distance:new o.bf(_,i.u_camera_to_center_distance),u_pitch:new o.bf(_,i.u_pitch),u_rotate_symbol:new o.bO(_,i.u_rotate_symbol),u_aspect_ratio:new o.bf(_,i.u_aspect_ratio),u_fade_change:new o.bf(_,i.u_fade_change),u_label_plane_matrix:new o.bQ(_,i.u_label_plane_matrix),u_coord_matrix:new o.bQ(_,i.u_coord_matrix),u_is_text:new o.bO(_,i.u_is_text),u_pitch_with_map:new o.bO(_,i.u_pitch_with_map),u_is_along_line:new o.bO(_,i.u_is_along_line),u_is_variable_anchor:new o.bO(_,i.u_is_variable_anchor),u_texsize:new o.bT(_,i.u_texsize),u_texsize_icon:new o.bT(_,i.u_texsize_icon),u_texture:new o.bO(_,i.u_texture),u_texture_icon:new o.bO(_,i.u_texture_icon),u_gamma_scale:new o.bf(_,i.u_gamma_scale),u_device_pixel_ratio:new o.bf(_,i.u_device_pixel_ratio),u_is_halo:new o.bO(_,i.u_is_halo),u_translation:new o.bT(_,i.u_translation),u_pitched_scale:new o.bf(_,i.u_pitched_scale)}),background:(_,i)=>({u_opacity:new o.bf(_,i.u_opacity),u_color:new o.bP(_,i.u_color)}),backgroundPattern:(_,i)=>({u_opacity:new o.bf(_,i.u_opacity),u_image:new o.bO(_,i.u_image),u_pattern_tl_a:new o.bT(_,i.u_pattern_tl_a),u_pattern_br_a:new o.bT(_,i.u_pattern_br_a),u_pattern_tl_b:new o.bT(_,i.u_pattern_tl_b),u_pattern_br_b:new o.bT(_,i.u_pattern_br_b),u_texsize:new o.bT(_,i.u_texsize),u_mix:new o.bf(_,i.u_mix),u_pattern_size_a:new o.bT(_,i.u_pattern_size_a),u_pattern_size_b:new o.bT(_,i.u_pattern_size_b),u_scale_a:new o.bf(_,i.u_scale_a),u_scale_b:new o.bf(_,i.u_scale_b),u_pixel_coord_upper:new o.bT(_,i.u_pixel_coord_upper),u_pixel_coord_lower:new o.bT(_,i.u_pixel_coord_lower),u_tile_units_to_pixels:new o.bf(_,i.u_tile_units_to_pixels)}),terrain:(_,i)=>({u_texture:new o.bO(_,i.u_texture),u_ele_delta:new o.bf(_,i.u_ele_delta),u_fog_matrix:new o.bQ(_,i.u_fog_matrix),u_fog_color:new o.bP(_,i.u_fog_color),u_fog_ground_blend:new o.bf(_,i.u_fog_ground_blend),u_fog_ground_blend_opacity:new o.bf(_,i.u_fog_ground_blend_opacity),u_horizon_color:new o.bP(_,i.u_horizon_color),u_horizon_fog_blend:new o.bf(_,i.u_horizon_fog_blend),u_is_globe_mode:new o.bf(_,i.u_is_globe_mode)}),terrainDepth:(_,i)=>({u_ele_delta:new o.bf(_,i.u_ele_delta)}),terrainCoords:(_,i)=>({u_texture:new o.bO(_,i.u_texture),u_terrain_coords_id:new o.bf(_,i.u_terrain_coords_id),u_ele_delta:new o.bf(_,i.u_ele_delta)}),projectionErrorMeasurement:(_,i)=>({u_input:new o.bf(_,i.u_input),u_output_expected:new o.bf(_,i.u_output_expected)}),atmosphere:(_,i)=>({u_sun_pos:new o.bS(_,i.u_sun_pos),u_atmosphere_blend:new o.bf(_,i.u_atmosphere_blend),u_globe_position:new o.bS(_,i.u_globe_position),u_globe_radius:new o.bf(_,i.u_globe_radius),u_inv_proj_matrix:new o.bQ(_,i.u_inv_proj_matrix)}),sky:(_,i)=>({u_sky_color:new o.bP(_,i.u_sky_color),u_horizon_color:new o.bP(_,i.u_horizon_color),u_horizon:new o.bT(_,i.u_horizon),u_horizon_normal:new o.bT(_,i.u_horizon_normal),u_sky_horizon_blend:new o.bf(_,i.u_sky_horizon_blend),u_sky_blend:new o.bf(_,i.u_sky_blend)})};class xu{constructor(i,l,f){this.context=i;const g=i.gl;this.buffer=g.createBuffer(),this.dynamicDraw=!!f,this.context.unbindVAO(),i.bindElementBuffer.set(this.buffer),g.bufferData(g.ELEMENT_ARRAY_BUFFER,l.arrayBuffer,this.dynamicDraw?g.DYNAMIC_DRAW:g.STATIC_DRAW),this.dynamicDraw||delete l.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(i){const l=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),l.bufferSubData(l.ELEMENT_ARRAY_BUFFER,0,i.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const wu={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Pc{constructor(i,l,f,g){this.length=l.length,this.attributes=f,this.itemSize=l.bytesPerElement,this.dynamicDraw=g,this.context=i;const y=i.gl;this.buffer=y.createBuffer(),i.bindVertexBuffer.set(this.buffer),y.bufferData(y.ARRAY_BUFFER,l.arrayBuffer,this.dynamicDraw?y.DYNAMIC_DRAW:y.STATIC_DRAW),this.dynamicDraw||delete l.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(i){if(i.length!==this.length)throw new Error(`Length of new data is ${i.length}, which doesn't match current length of ${this.length}`);const l=this.context.gl;this.bind(),l.bufferSubData(l.ARRAY_BUFFER,0,i.arrayBuffer)}enableAttributes(i,l){for(let f=0;f<this.attributes.length;f++){const g=l.attributes[this.attributes[f].name];g!==void 0&&i.enableVertexAttribArray(g)}}setVertexAttribPointers(i,l,f){for(let g=0;g<this.attributes.length;g++){const y=this.attributes[g],x=l.attributes[y.name];x!==void 0&&i.vertexAttribPointer(x,y.components,i[wu[y.type]],!1,this.itemSize,y.offset+this.itemSize*(f||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class nr{constructor(i){this.gl=i.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(i){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class rl extends nr{getDefault(){return o.be.transparent}set(i){const l=this.current;(i.r!==l.r||i.g!==l.g||i.b!==l.b||i.a!==l.a||this.dirty)&&(this.gl.clearColor(i.r,i.g,i.b,i.a),this.current=i,this.dirty=!1)}}class Hn extends nr{getDefault(){return 1}set(i){(i!==this.current||this.dirty)&&(this.gl.clearDepth(i),this.current=i,this.dirty=!1)}}class Mc extends nr{getDefault(){return 0}set(i){(i!==this.current||this.dirty)&&(this.gl.clearStencil(i),this.current=i,this.dirty=!1)}}class Rc extends nr{getDefault(){return[!0,!0,!0,!0]}set(i){const l=this.current;(i[0]!==l[0]||i[1]!==l[1]||i[2]!==l[2]||i[3]!==l[3]||this.dirty)&&(this.gl.colorMask(i[0],i[1],i[2],i[3]),this.current=i,this.dirty=!1)}}class kc extends nr{getDefault(){return!0}set(i){(i!==this.current||this.dirty)&&(this.gl.depthMask(i),this.current=i,this.dirty=!1)}}class Tu extends nr{getDefault(){return 255}set(i){(i!==this.current||this.dirty)&&(this.gl.stencilMask(i),this.current=i,this.dirty=!1)}}class Dc extends nr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(i){const l=this.current;(i.func!==l.func||i.ref!==l.ref||i.mask!==l.mask||this.dirty)&&(this.gl.stencilFunc(i.func,i.ref,i.mask),this.current=i,this.dirty=!1)}}class Ds extends nr{getDefault(){const i=this.gl;return[i.KEEP,i.KEEP,i.KEEP]}set(i){const l=this.current;(i[0]!==l[0]||i[1]!==l[1]||i[2]!==l[2]||this.dirty)&&(this.gl.stencilOp(i[0],i[1],i[2]),this.current=i,this.dirty=!1)}}class Oc extends nr{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;i?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),this.current=i,this.dirty=!1}}class Rf extends nr{getDefault(){return[0,1]}set(i){const l=this.current;(i[0]!==l[0]||i[1]!==l[1]||this.dirty)&&(this.gl.depthRange(i[0],i[1]),this.current=i,this.dirty=!1)}}class kf extends nr{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;i?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),this.current=i,this.dirty=!1}}class Df extends nr{getDefault(){return this.gl.LESS}set(i){(i!==this.current||this.dirty)&&(this.gl.depthFunc(i),this.current=i,this.dirty=!1)}}class Of extends nr{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;i?l.enable(l.BLEND):l.disable(l.BLEND),this.current=i,this.dirty=!1}}class Su extends nr{getDefault(){const i=this.gl;return[i.ONE,i.ZERO]}set(i){const l=this.current;(i[0]!==l[0]||i[1]!==l[1]||this.dirty)&&(this.gl.blendFunc(i[0],i[1]),this.current=i,this.dirty=!1)}}class Ff extends nr{getDefault(){return o.be.transparent}set(i){const l=this.current;(i.r!==l.r||i.g!==l.g||i.b!==l.b||i.a!==l.a||this.dirty)&&(this.gl.blendColor(i.r,i.g,i.b,i.a),this.current=i,this.dirty=!1)}}class Au extends nr{getDefault(){return this.gl.FUNC_ADD}set(i){(i!==this.current||this.dirty)&&(this.gl.blendEquation(i),this.current=i,this.dirty=!1)}}class il extends nr{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;i?l.enable(l.CULL_FACE):l.disable(l.CULL_FACE),this.current=i,this.dirty=!1}}class nl extends nr{getDefault(){return this.gl.BACK}set(i){(i!==this.current||this.dirty)&&(this.gl.cullFace(i),this.current=i,this.dirty=!1)}}class sl extends nr{getDefault(){return this.gl.CCW}set(i){(i!==this.current||this.dirty)&&(this.gl.frontFace(i),this.current=i,this.dirty=!1)}}class Fc extends nr{getDefault(){return null}set(i){(i!==this.current||this.dirty)&&(this.gl.useProgram(i),this.current=i,this.dirty=!1)}}class Os extends nr{getDefault(){return this.gl.TEXTURE0}set(i){(i!==this.current||this.dirty)&&(this.gl.activeTexture(i),this.current=i,this.dirty=!1)}}class Qo extends nr{getDefault(){const i=this.gl;return[0,0,i.drawingBufferWidth,i.drawingBufferHeight]}set(i){const l=this.current;(i[0]!==l[0]||i[1]!==l[1]||i[2]!==l[2]||i[3]!==l[3]||this.dirty)&&(this.gl.viewport(i[0],i[1],i[2],i[3]),this.current=i,this.dirty=!1)}}class io extends nr{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.bindFramebuffer(l.FRAMEBUFFER,i),this.current=i,this.dirty=!1}}class un extends nr{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.bindRenderbuffer(l.RENDERBUFFER,i),this.current=i,this.dirty=!1}}class Eu extends nr{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.bindTexture(l.TEXTURE_2D,i),this.current=i,this.dirty=!1}}class Iu extends nr{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.bindBuffer(l.ARRAY_BUFFER,i),this.current=i,this.dirty=!1}}class Bc extends nr{getDefault(){return null}set(i){const l=this.gl;l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,i),this.current=i,this.dirty=!1}}class Fs extends nr{getDefault(){return null}set(i){var l;if(i===this.current&&!this.dirty)return;const f=this.gl;zi(f)?f.bindVertexArray(i):(l=f.getExtension("OES_vertex_array_object"))===null||l===void 0||l.bindVertexArrayOES(i),this.current=i,this.dirty=!1}}class ol extends nr{getDefault(){return 4}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_ALIGNMENT,i),this.current=i,this.dirty=!1}}class al extends nr{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i),this.current=i,this.dirty=!1}}class ea extends nr{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,i),this.current=i,this.dirty=!1}}class no extends nr{constructor(i,l){super(i),this.context=i,this.parent=l}getDefault(){return null}}class Cu extends no{setDirty(){this.dirty=!0}set(i){if(i===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,i,0),this.current=i,this.dirty=!1}}class so extends no{set(i){if(i===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferRenderbuffer(l.FRAMEBUFFER,l.DEPTH_ATTACHMENT,l.RENDERBUFFER,i),this.current=i,this.dirty=!1}}class oo extends no{set(i){if(i===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferRenderbuffer(l.FRAMEBUFFER,l.DEPTH_STENCIL_ATTACHMENT,l.RENDERBUFFER,i),this.current=i,this.dirty=!1}}const Lc="Framebuffer is not complete";class Nc{constructor(i,l,f,g,y){this.context=i,this.width=l,this.height=f;const x=i.gl,S=this.framebuffer=x.createFramebuffer();if(this.colorAttachment=new Cu(i,S),g)this.depthAttachment=y?new oo(i,S):new so(i,S);else if(y)throw new Error("Stencil cannot be set without depth");if(x.checkFramebufferStatus(x.FRAMEBUFFER)!==x.FRAMEBUFFER_COMPLETE)throw new Error(Lc)}destroy(){const i=this.context.gl,l=this.colorAttachment.get();if(l&&i.deleteTexture(l),this.depthAttachment){const f=this.depthAttachment.get();f&&i.deleteRenderbuffer(f)}i.deleteFramebuffer(this.framebuffer)}}class qt{constructor(i){var l,f;if(this.gl=i,this.clearColor=new rl(this),this.clearDepth=new Hn(this),this.clearStencil=new Mc(this),this.colorMask=new Rc(this),this.depthMask=new kc(this),this.stencilMask=new Tu(this),this.stencilFunc=new Dc(this),this.stencilOp=new Ds(this),this.stencilTest=new Oc(this),this.depthRange=new Rf(this),this.depthTest=new kf(this),this.depthFunc=new Df(this),this.blend=new Of(this),this.blendFunc=new Su(this),this.blendColor=new Ff(this),this.blendEquation=new Au(this),this.cullFace=new il(this),this.cullFaceSide=new nl(this),this.frontFace=new sl(this),this.program=new Fc(this),this.activeTexture=new Os(this),this.viewport=new Qo(this),this.bindFramebuffer=new io(this),this.bindRenderbuffer=new un(this),this.bindTexture=new Eu(this),this.bindVertexBuffer=new Iu(this),this.bindElementBuffer=new Bc(this),this.bindVertexArray=new Fs(this),this.pixelStoreUnpack=new ol(this),this.pixelStoreUnpackPremultiplyAlpha=new al(this),this.pixelStoreUnpackFlipY=new ea(this),this.extTextureFilterAnisotropic=i.getExtension("EXT_texture_filter_anisotropic")||i.getExtension("MOZ_EXT_texture_filter_anisotropic")||i.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=i.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),zi(i)){this.HALF_FLOAT=i.HALF_FLOAT;const g=i.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(l=i.RGBA16F)!==null&&l!==void 0?l:g?.RGBA16F_EXT,this.RGB16F=(f=i.RGB16F)!==null&&f!==void 0?f:g?.RGB16F_EXT,i.getExtension("EXT_color_buffer_float")}else{i.getExtension("EXT_color_buffer_half_float"),i.getExtension("OES_texture_half_float_linear");const g=i.getExtension("OES_texture_half_float");this.HALF_FLOAT=g?.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(i,l){return new xu(this,i,l)}createVertexBuffer(i,l,f){return new Pc(this,i,l,f)}createRenderbuffer(i,l,f){const g=this.gl,y=g.createRenderbuffer();return this.bindRenderbuffer.set(y),g.renderbufferStorage(g.RENDERBUFFER,i,l,f),this.bindRenderbuffer.set(null),y}createFramebuffer(i,l,f,g){return new Nc(this,i,l,f,g)}clear({color:i,depth:l,stencil:f}){const g=this.gl;let y=0;i&&(y|=g.COLOR_BUFFER_BIT,this.clearColor.set(i),this.colorMask.set([!0,!0,!0,!0])),l!==void 0&&(y|=g.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(l),this.depthMask.set(!0)),f!==void 0&&(y|=g.STENCIL_BUFFER_BIT,this.clearStencil.set(f),this.stencilMask.set(255)),g.clear(y)}setCullFace(i){i.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(i.mode),this.frontFace.set(i.frontFace))}setDepthMode(i){i.func!==this.gl.ALWAYS||i.mask?(this.depthTest.set(!0),this.depthFunc.set(i.func),this.depthMask.set(i.mask),this.depthRange.set(i.range)):this.depthTest.set(!1)}setStencilMode(i){i.test.func!==this.gl.ALWAYS||i.mask?(this.stencilTest.set(!0),this.stencilMask.set(i.mask),this.stencilOp.set([i.fail,i.depthFail,i.pass]),this.stencilFunc.set({func:i.test.func,ref:i.ref,mask:i.test.mask})):this.stencilTest.set(!1)}setColorMode(i){o.bG(i.blendFunction,tr.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(i.blendFunction),this.blendColor.set(i.blendColor)),this.colorMask.set(i.mask)}createVertexArray(){var i;return zi(this.gl)?this.gl.createVertexArray():(i=this.gl.getExtension("OES_vertex_array_object"))===null||i===void 0?void 0:i.createVertexArrayOES()}deleteVertexArray(i){var l;return zi(this.gl)?this.gl.deleteVertexArray(i):(l=this.gl.getExtension("OES_vertex_array_object"))===null||l===void 0?void 0:l.deleteVertexArrayOES(i)}unbindVAO(){this.bindVertexArray.set(null)}}let Bs;function Pu(_,i,l,f,g){const y=_.context,x=_.transform,S=y.gl,I=_.useProgram("collisionBox"),M=[];let k=0,B=0;for(let Q=0;Q<f.length;Q++){const re=f[Q],ae=i.getTile(re).getBucket(l);if(!ae)continue;const se=g?ae.textCollisionBox:ae.iconCollisionBox,ue=ae.collisionCircleArray;ue.length>0&&(M.push({circleArray:ue,circleOffset:B,coord:re}),k+=ue.length/4,B=k),se&&I.draw(y,S.LINES,Lt.disabled,Pt.disabled,_.colorModeForRenderPass(),Ft.disabled,Go(_.transform),_.style.map.terrain&&_.style.map.terrain.getTerrainData(re),x.getProjectionData({overscaledTileID:re,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),l.id,se.layoutVertexBuffer,se.indexBuffer,se.segments,null,_.transform.zoom,null,null,se.collisionVertexBuffer)}if(!g||!M.length)return;const F=_.useProgram("collisionCircle"),N=new o.b_;N.resize(4*k),N._trim();let W=0;for(const Q of M)for(let re=0;re<Q.circleArray.length/4;re++){const ae=4*re,se=Q.circleArray[ae+0],ue=Q.circleArray[ae+1],de=Q.circleArray[ae+2],oe=Q.circleArray[ae+3];N.emplace(W++,se,ue,de,oe,0),N.emplace(W++,se,ue,de,oe,1),N.emplace(W++,se,ue,de,oe,2),N.emplace(W++,se,ue,de,oe,3)}(!Bs||Bs.length<2*k)&&(Bs=function(Q){const re=2*Q,ae=new o.c0;ae.resize(re),ae._trim();for(let se=0;se<re;se++){const ue=6*se;ae.uint16[ue+0]=4*se+0,ae.uint16[ue+1]=4*se+1,ae.uint16[ue+2]=4*se+2,ae.uint16[ue+3]=4*se+2,ae.uint16[ue+4]=4*se+3,ae.uint16[ue+5]=4*se+0}return ae}(k));const J=y.createIndexBuffer(Bs,!0),G=y.createVertexBuffer(N,o.b$.members,!0);for(const Q of M){const re=Ko(_.transform);F.draw(y,S.TRIANGLES,Lt.disabled,Pt.disabled,_.colorModeForRenderPass(),Ft.disabled,re,_.style.map.terrain&&_.style.map.terrain.getTerrainData(Q.coord),null,l.id,G,J,o.aL.simpleSegment(0,2*Q.circleOffset,Q.circleArray.length,Q.circleArray.length/2),null,_.transform.zoom,null,null,null)}G.destroy(),J.destroy()}const Mu=o.af(new Float32Array(16));function ta(_,i,l,f,g,y){const{horizontalAlign:x,verticalAlign:S}=o.aG(_);return new o.P((-(x-.5)*i/g+f[0])*y,(-(S-.5)*l/g+f[1])*y)}function Bf(_,i,l,f,g,y){const x=i.tileAnchorPoint.add(new o.P(i.translation[0],i.translation[1]));if(i.pitchWithMap){let S=f.mult(y);l||(S=S.rotate(-g));const I=x.add(S);return ir(I.x,I.y,i.pitchedLabelPlaneMatrix,i.getElevation).point}if(l){const S=st(i.tileAnchorPoint.x+1,i.tileAnchorPoint.y,i).point.sub(_),I=Math.atan(S.y/S.x)+(S.x<0?Math.PI:0);return _.add(f.rotate(I))}return _.add(f)}function Lf(_,i,l,f,g,y,x,S,I,M,k,B){const F=_.text.placedSymbolArray,N=_.text.dynamicLayoutVertexArray,W=_.icon.dynamicLayoutVertexArray,J={};N.clear();for(let G=0;G<F.length;G++){const Q=F.get(G),re=Q.hidden||!Q.crossTileID||_.allowVerticalPlacement&&!Q.placedOrientation?null:f[Q.crossTileID];if(re){const ae=new o.P(Q.anchorX,Q.anchorY),se={getElevation:B,width:g.width,height:g.height,pitchedLabelPlaneMatrix:y,pitchWithMap:l,transform:g,tileAnchorPoint:ae,translation:M,unwrappedTileID:k},ue=l?Vt(ae.x,ae.y,se):st(ae.x,ae.y,se),de=Mt(g.cameraToCenterDistance,ue.signedDistanceFromCamera);let oe=o.ao(_.textSizeData,S,Q)*de/o.aA;l&&(oe*=_.tilePixelRatio/x);const{width:ye,height:Oe,anchor:Ce,textOffset:Me,textBoxScale:Fe}=re,nt=ta(Ce,ye,Oe,Me,Fe,oe),it=g.getPitchedTextCorrection(ae.x+M[0],ae.y+M[1],k),qe=Bf(ue.point,se,i,nt,-g.bearingInRadians,it),ft=_.allowVerticalPlacement&&Q.placedOrientation===o.an.vertical?Math.PI/2:0;for(let Nt=0;Nt<Q.numGlyphs;Nt++)o.au(N,qe,ft);I&&Q.associatedIconIndex>=0&&(J[Q.associatedIconIndex]={shiftedAnchor:qe,angle:ft})}else Un(Q.numGlyphs,N)}if(I){W.clear();const G=_.icon.placedSymbolArray;for(let Q=0;Q<G.length;Q++){const re=G.get(Q);if(re.hidden)Un(re.numGlyphs,W);else{const ae=J[Q];if(ae)for(let se=0;se<re.numGlyphs;se++)o.au(W,ae.shiftedAnchor,ae.angle);else Un(re.numGlyphs,W)}}_.icon.dynamicLayoutVertexBuffer.updateData(W)}_.text.dynamicLayoutVertexBuffer.updateData(N)}function Ru(_,i,l){return l.iconsInText&&i?"symbolTextAndIcon":_?"symbolSDF":"symbolIcon"}function ku(_,i,l,f,g,y,x,S,I,M,k,B,F){const N=_.context,W=N.gl,J=_.transform,G=S==="map",Q=I==="map",re=S!=="viewport"&&l.layout.get("symbol-placement")!=="point",ae=G&&!Q&&!re,se=!l.layout.get("symbol-sort-key").isConstant();let ue=!1;const de=_.getDepthModeForSublayer(0,Lt.ReadOnly),oe=l._unevaluatedLayout.hasValue("text-variable-anchor")||l._unevaluatedLayout.hasValue("text-variable-anchor-offset"),ye=[],Oe=J.getCircleRadiusCorrection();for(const Ce of f){const Me=i.getTile(Ce),Fe=Me.getBucket(l);if(!Fe)continue;const nt=g?Fe.text:Fe.icon;if(!nt||!nt.segments.get().length||!nt.hasVisibleVertices)continue;const it=nt.programConfigurations.get(l.id),qe=g||Fe.sdfIcons,ft=g?Fe.textSizeData:Fe.iconSizeData,Nt=Q||J.pitch!==0,sr=_.useProgram(Ru(qe,g,Fe),it),Lr=o.am(ft,J.zoom),ur=_.style.map.terrain&&_.style.map.terrain.getTerrainData(Ce);let Nr,br,dr,vr,xi=[0,0],rr=null;if(g)br=Me.glyphAtlasTexture,dr=W.LINEAR,Nr=Me.glyphAtlasTexture.size,Fe.iconsInText&&(xi=Me.imageAtlasTexture.size,rr=Me.imageAtlasTexture,vr=Nt||_.options.rotating||_.options.zooming||ft.kind==="composite"||ft.kind==="camera"?W.LINEAR:W.NEAREST);else{const Hr=l.layout.get("icon-size").constantOr(0)!==1||Fe.iconsNeedLinear;br=Me.imageAtlasTexture,dr=qe||_.options.rotating||_.options.zooming||Hr||Nt?W.LINEAR:W.NEAREST,Nr=Me.imageAtlasTexture.size}const hi=o.aB(Me,1,_.transform.zoom),wi=Dt(G,_.transform,hi),ds=o.L();o.ap(ds,wi);const fs=Tr(Q,G,_.transform,hi),ps=o.aC(J,Me,y,x),Dn=J.getProjectionData({overscaledTileID:Ce,applyGlobeMatrix:!F,applyTerrainMatrix:!0}),ga=oe&&Fe.hasTextData(),ma=l.layout.get("icon-text-fit")!=="none"&&ga&&Fe.hasIconData();if(re){const Hr=_.style.map.terrain?($i,ii)=>_.style.map.terrain.getElevation(Ce,$i,ii):null,Ar=l.layout.get("text-rotation-alignment")==="map";ai(Fe,_,g,wi,ds,Q,M,Ar,Ce.toUnwrapped(),J.width,J.height,ps,Hr)}const bo=g&&oe||ma,Yi=re||bo?Mu:Q?wi:_.transform.clipSpaceToPixelsMatrix,_n=qe&&l.paint.get(g?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let gs;gs=qe?Fe.iconsInText?Pf(ft.kind,Lr,ae,Q,re,bo,_,Yi,fs,ps,Nr,xi,Oe):ro(ft.kind,Lr,ae,Q,re,bo,_,Yi,fs,ps,g,Nr,0,Oe):Cc(ft.kind,Lr,ae,Q,re,bo,_,Yi,fs,ps,g,Nr,Oe);const zs={program:sr,buffers:nt,uniformValues:gs,projectionData:Dn,atlasTexture:br,atlasTextureIcon:rr,atlasInterpolation:dr,atlasInterpolationIcon:vr,isSDF:qe,hasHalo:_n};if(se&&Fe.canOverlap){ue=!0;const Hr=nt.segments.get();for(const Ar of Hr)ye.push({segments:new o.aL([Ar]),sortKey:Ar.sortKey,state:zs,terrainData:ur})}else ye.push({segments:nt.segments,sortKey:0,state:zs,terrainData:ur})}ue&&ye.sort((Ce,Me)=>Ce.sortKey-Me.sortKey);for(const Ce of ye){const Me=Ce.state;if(N.activeTexture.set(W.TEXTURE0),Me.atlasTexture.bind(Me.atlasInterpolation,W.CLAMP_TO_EDGE),Me.atlasTextureIcon&&(N.activeTexture.set(W.TEXTURE1),Me.atlasTextureIcon&&Me.atlasTextureIcon.bind(Me.atlasInterpolationIcon,W.CLAMP_TO_EDGE)),Me.isSDF){const Fe=Me.uniformValues;Me.hasHalo&&(Fe.u_is_halo=1,ll(Me.buffers,Ce.segments,l,_,Me.program,de,k,B,Fe,Me.projectionData,Ce.terrainData)),Fe.u_is_halo=0}ll(Me.buffers,Ce.segments,l,_,Me.program,de,k,B,Me.uniformValues,Me.projectionData,Ce.terrainData)}}function ll(_,i,l,f,g,y,x,S,I,M,k){const B=f.context;g.draw(B,B.gl.TRIANGLES,y,x,S,Ft.backCCW,I,k,M,l.id,_.layoutVertexBuffer,_.indexBuffer,i,l.paint,f.transform.zoom,_.programConfigurations.get(l.id),_.dynamicLayoutVertexBuffer,_.opacityVertexBuffer)}function cl(_,i,l,f,g){const y=_.context,x=y.gl,S=Pt.disabled,I=new tr([x.ONE,x.ONE],o.be.transparent,[!0,!0,!0,!0]),M=i.getBucket(l);if(!M)return;const k=f.key;let B=l.heatmapFbos.get(k);B||(B=ra(y,i.tileSize,i.tileSize),l.heatmapFbos.set(k,B)),y.bindFramebuffer.set(B.framebuffer),y.viewport.set([0,0,i.tileSize,i.tileSize]),y.clear({color:o.be.transparent});const F=M.programConfigurations.get(l.id),N=_.useProgram("heatmap",F,!g),W=_.transform.getProjectionData({overscaledTileID:i.tileID,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),J=_.style.map.terrain.getTerrainData(f);N.draw(y,x.TRIANGLES,Lt.disabled,S,I,Ft.disabled,Jo(i,_.transform.zoom,l.paint.get("heatmap-intensity"),1),J,W,l.id,M.layoutVertexBuffer,M.indexBuffer,M.segments,l.paint,_.transform.zoom,F)}function hl(_,i,l,f,g){const y=_.context,x=y.gl,S=_.transform;y.setColorMode(_.colorModeForRenderPass());const I=ul(y,i),M=l.key,k=i.heatmapFbos.get(M);if(!k)return;y.activeTexture.set(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,k.colorAttachment.get()),y.activeTexture.set(x.TEXTURE1),I.bind(x.LINEAR,x.CLAMP_TO_EDGE);const B=S.getProjectionData({overscaledTileID:l,applyTerrainMatrix:g,applyGlobeMatrix:!f});_.useProgram("heatmapTexture").draw(y,x.TRIANGLES,Lt.disabled,Pt.disabled,_.colorModeForRenderPass(),Ft.disabled,pu(_,i,0,1),null,B,i.id,_.rasterBoundsBuffer,_.quadTriangleIndexBuffer,_.rasterBoundsSegments,i.paint,S.zoom),k.destroy(),i.heatmapFbos.delete(M)}function ra(_,i,l){var f,g;const y=_.gl,x=y.createTexture();y.bindTexture(y.TEXTURE_2D,x),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,y.LINEAR),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,y.LINEAR);const S=(f=_.HALF_FLOAT)!==null&&f!==void 0?f:y.UNSIGNED_BYTE,I=(g=_.RGBA16F)!==null&&g!==void 0?g:y.RGBA;y.texImage2D(y.TEXTURE_2D,0,I,i,l,0,y.RGBA,S,null);const M=_.createFramebuffer(i,l,!1,!1);return M.colorAttachment.set(x),M}function ul(_,i){return i.colorRampTexture||(i.colorRampTexture=new o.T(_,i.colorRamp,_.gl.RGBA)),i.colorRampTexture}function zc(_,i,l,f,g){if(!l||!f||!f.imageAtlas)return;const y=f.imageAtlas.patternPositions;let x=y[l.to.toString()],S=y[l.from.toString()];if(!x&&S&&(x=S),!S&&x&&(S=x),!x||!S){const I=g.getPaintProperty(i);x=y[I],S=y[I]}x&&S&&_.setConstantPatternPositions(x,S)}function ia(_,i,l,f,g,y,x,S){const I=_.context.gl,M="fill-pattern",k=l.paint.get(M),B=k&&k.constantOr(1),F=l.getCrossfadeParameters();let N,W,J,G,Q;const re=_.transform,ae=l.paint.get("fill-translate"),se=l.paint.get("fill-translate-anchor");x?(W=B&&!l.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",N=I.LINES):(W=B?"fillPattern":"fill",N=I.TRIANGLES);const ue=k.constantOr(null);for(const de of f){const oe=i.getTile(de);if(B&&!oe.patternsLoaded())continue;const ye=oe.getBucket(l);if(!ye)continue;const Oe=ye.programConfigurations.get(l.id),Ce=_.useProgram(W,Oe),Me=_.style.map.terrain&&_.style.map.terrain.getTerrainData(de);B&&(_.context.activeTexture.set(I.TEXTURE0),oe.imageAtlasTexture.bind(I.LINEAR,I.CLAMP_TO_EDGE),Oe.updatePaintBuffers(F)),zc(Oe,M,ue,oe,l);const Fe=re.getProjectionData({overscaledTileID:de,applyGlobeMatrix:!S,applyTerrainMatrix:!0}),nt=o.aC(re,oe,ae,se);if(x){G=ye.indexBuffer2,Q=ye.segments2;const qe=[I.drawingBufferWidth,I.drawingBufferHeight];J=W==="fillOutlinePattern"&&B?Ef(_,F,oe,qe,nt):Mn(qe,nt)}else G=ye.indexBuffer,Q=ye.segments,J=B?Qa(_,F,oe,nt):{u_fill_translate:nt};const it=_.stencilModeForClipping(de);Ce.draw(_.context,N,g,it,y,Ft.backCCW,J,Me,Fe,l.id,ye.layoutVertexBuffer,G,Q,l.paint,_.transform.zoom,Oe)}}function ao(_,i,l,f,g,y,x,S){const I=_.context,M=I.gl,k="fill-extrusion-pattern",B=l.paint.get(k),F=B.constantOr(1),N=l.getCrossfadeParameters(),W=l.paint.get("fill-extrusion-opacity"),J=B.constantOr(null),G=_.transform;for(const Q of f){const re=i.getTile(Q),ae=re.getBucket(l);if(!ae)continue;const se=_.style.map.terrain&&_.style.map.terrain.getTerrainData(Q),ue=ae.programConfigurations.get(l.id),de=_.useProgram(F?"fillExtrusionPattern":"fillExtrusion",ue);F&&(_.context.activeTexture.set(M.TEXTURE0),re.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),ue.updatePaintBuffers(N));const oe=G.getProjectionData({overscaledTileID:Q,applyGlobeMatrix:!S,applyTerrainMatrix:!0});zc(ue,k,J,re,l);const ye=o.aC(G,re,l.paint.get("fill-extrusion-translate"),l.paint.get("fill-extrusion-translate-anchor")),Oe=l.paint.get("fill-extrusion-vertical-gradient"),Ce=F?Tc(_,Oe,W,ye,Q,N,re):Yo(_,Oe,W,ye);de.draw(I,I.gl.TRIANGLES,g,y,x,Ft.backCCW,Ce,se,oe,l.id,ae.layoutVertexBuffer,ae.indexBuffer,ae.segments,l.paint,_.transform.zoom,ue,_.style.map.terrain&&ae.centroidVertexBuffer)}}function lo(_,i,l,f,g,y,x,S,I){var M;const k=_.style.projection,B=_.context,F=_.transform,N=B.gl,W=[`#define NUM_ILLUMINATION_SOURCES ${l.paint.get("hillshade-highlight-color").values.length}`],J=_.useProgram("hillshade",null,!1,W),G=!_.options.moving;for(const Q of f){const re=i.getTile(Q),ae=re.fbo;if(!ae)continue;const se=k.getMeshFromTileID(B,Q.canonical,S,!0,"raster"),ue=(M=_.style.map.terrain)===null||M===void 0?void 0:M.getTerrainData(Q);B.activeTexture.set(N.TEXTURE0),N.bindTexture(N.TEXTURE_2D,ae.colorAttachment.get());const de=F.getProjectionData({overscaledTileID:Q,aligned:G,applyGlobeMatrix:!I,applyTerrainMatrix:!0});J.draw(B,N.TRIANGLES,y,g[Q.overscaledZ],x,Ft.backCCW,to(_,re,l),ue,de,l.id,se.vertexBuffer,se.indexBuffer,se.segments)}}function na(_,i,l,f,g,y,x,S,I){var M;const k=_.style.projection,B=_.context,F=_.transform,N=B.gl,W=_.useProgram("colorRelief"),J=!_.options.moving;let G=!0,Q=0;for(const re of f){const ae=i.getTile(re),se=ae.dem;if(G){const Ce=N.getParameter(N.MAX_TEXTURE_SIZE),{elevationTexture:Me,colorTexture:Fe}=l.getColorRampTextures(B,Ce,se.getUnpackVector());B.activeTexture.set(N.TEXTURE1),Me.bind(N.NEAREST,N.CLAMP_TO_EDGE),B.activeTexture.set(N.TEXTURE4),Fe.bind(N.LINEAR,N.CLAMP_TO_EDGE),G=!1,Q=Me.size[0]}if(!se||!se.data)continue;const ue=se.stride,de=se.getPixels();if(B.activeTexture.set(N.TEXTURE0),B.pixelStoreUnpackPremultiplyAlpha.set(!1),ae.demTexture=ae.demTexture||_.getTileTexture(ue),ae.demTexture){const Ce=ae.demTexture;Ce.update(de,{premultiply:!1}),Ce.bind(N.LINEAR,N.CLAMP_TO_EDGE)}else ae.demTexture=new o.T(B,de,N.RGBA,{premultiply:!1}),ae.demTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE);const oe=k.getMeshFromTileID(B,re.canonical,S,!0,"raster"),ye=(M=_.style.map.terrain)===null||M===void 0?void 0:M.getTerrainData(re),Oe=F.getProjectionData({overscaledTileID:re,aligned:J,applyGlobeMatrix:!I,applyTerrainMatrix:!0});W.draw(B,N.TRIANGLES,y,g[re.overscaledZ],x,Ft.backCCW,Cf(l,ae.dem,Q),ye,Oe,l.id,oe.vertexBuffer,oe.indexBuffer,oe.segments)}}const Uc=[new o.P(0,0),new o.P(o.$,0),new o.P(o.$,o.$),new o.P(0,o.$)];function as(_,i,l,f,g,y,x,S,I=!1,M=!1){const k=f[f.length-1].overscaledZ,B=_.context,F=B.gl,N=_.useProgram("raster"),W=_.transform,J=_.style.projection,G=_.colorModeForRenderPass(),Q=!_.options.moving;for(const re of f){const ae=_.getDepthModeForSublayer(re.overscaledZ-k,l.paint.get("raster-opacity")===1?Lt.ReadWrite:Lt.ReadOnly,F.LESS),se=i.getTile(re);se.registerFadeDuration(l.paint.get("raster-fade-duration"));const ue=i.findLoadedParent(re,0),de=i.findLoadedSibling(re),oe=Nf(se,ue||de||null,i,l,_.transform,_.style.map.terrain);let ye,Oe;const Ce=l.paint.get("raster-resampling")==="nearest"?F.NEAREST:F.LINEAR;B.activeTexture.set(F.TEXTURE0),se.texture.bind(Ce,F.CLAMP_TO_EDGE,F.LINEAR_MIPMAP_NEAREST),B.activeTexture.set(F.TEXTURE1),ue?(ue.texture.bind(Ce,F.CLAMP_TO_EDGE,F.LINEAR_MIPMAP_NEAREST),ye=Math.pow(2,ue.tileID.overscaledZ-se.tileID.overscaledZ),Oe=[se.tileID.canonical.x*ye%1,se.tileID.canonical.y*ye%1]):se.texture.bind(Ce,F.CLAMP_TO_EDGE,F.LINEAR_MIPMAP_NEAREST),se.texture.useMipmap&&B.extTextureFilterAnisotropic&&_.transform.pitch>20&&F.texParameterf(F.TEXTURE_2D,B.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,B.extTextureFilterAnisotropicMax);const Me=_.style.map.terrain&&_.style.map.terrain.getTerrainData(re),Fe=W.getProjectionData({overscaledTileID:re,aligned:Q,applyGlobeMatrix:!M,applyTerrainMatrix:!0}),nt=ks(Oe||[0,0],ye||1,oe,l,S),it=J.getMeshFromTileID(B,re.canonical,y,x,"raster");N.draw(B,F.TRIANGLES,ae,g?g[re.overscaledZ]:Pt.disabled,G,I?Ft.frontCCW:Ft.backCCW,nt,Me,Fe,l.id,it.vertexBuffer,it.indexBuffer,it.segments)}}function Nf(_,i,l,f,g,y){const x=f.paint.get("raster-fade-duration");if(!y&&x>0){const S=$.now(),I=(S-_.timeAdded)/x,M=i?(S-i.timeAdded)/x:-1,k=l.getSource(),B=$e(g,{tileSize:k.tileSize,roundZoom:k.roundZoom}),F=!i||Math.abs(i.tileID.overscaledZ-B)>Math.abs(_.tileID.overscaledZ-B),N=F&&_.refreshedUponExpiration?1:o.ag(F?I:1-M,0,1);return _.refreshedUponExpiration&&I>=1&&(_.refreshedUponExpiration=!1),i?{opacity:1,mix:1-N}:{opacity:N,mix:0}}return{opacity:1,mix:0}}const Du=new o.be(1,0,0,1),dl=new o.be(0,1,0,1),Vc=new o.be(0,0,1,1),Ou=new o.be(1,0,1,1),Fu=new o.be(0,1,1,1);function sa(_,i,l,f){pl(_,0,i+l/2,_.transform.width,l,f)}function fl(_,i,l,f){pl(_,i-l/2,0,l,_.transform.height,f)}function pl(_,i,l,f,g,y){const x=_.context,S=x.gl;S.enable(S.SCISSOR_TEST),S.scissor(i*_.pixelRatio,l*_.pixelRatio,f*_.pixelRatio,g*_.pixelRatio),x.clear({color:y}),S.disable(S.SCISSOR_TEST)}function Bu(_,i,l){const f=_.context,g=f.gl,y=_.useProgram("debug"),x=Lt.disabled,S=Pt.disabled,I=_.colorModeForRenderPass(),M="$debug",k=_.style.map.terrain&&_.style.map.terrain.getTerrainData(l);f.activeTexture.set(g.TEXTURE0);const B=i.getTileByID(l.key).latestRawTileData,F=Math.floor((B&&B.byteLength||0)/1024),N=i.getTile(l).tileSize,W=512/Math.min(N,512)*(l.overscaledZ/_.transform.zoom)*.5;let J=l.canonical.toString();l.overscaledZ!==l.canonical.z&&(J+=` => ${l.overscaledZ}`),function(Q,re){Q.initDebugOverlayCanvas();const ae=Q.debugOverlayCanvas,se=Q.context.gl,ue=Q.debugOverlayCanvas.getContext("2d");ue.clearRect(0,0,ae.width,ae.height),ue.shadowColor="white",ue.shadowBlur=2,ue.lineWidth=1.5,ue.strokeStyle="white",ue.textBaseline="top",ue.font="bold 36px Open Sans, sans-serif",ue.fillText(re,5,5),ue.strokeText(re,5,5),Q.debugOverlayTexture.update(ae),Q.debugOverlayTexture.bind(se.LINEAR,se.CLAMP_TO_EDGE)}(_,`${J} ${F}kB`);const G=_.transform.getProjectionData({overscaledTileID:l,applyGlobeMatrix:!0,applyTerrainMatrix:!0});y.draw(f,g.TRIANGLES,x,S,tr.alphaBlended,Ft.disabled,fu(o.be.transparent,W),null,G,M,_.debugBuffer,_.quadTriangleIndexBuffer,_.debugSegments),y.draw(f,g.LINE_STRIP,x,S,I,Ft.disabled,fu(o.be.red),k,G,M,_.debugBuffer,_.tileBorderIndexBuffer,_.debugSegments)}function jr(_,i,l,f){const{isRenderingGlobe:g}=f,y=_.context,x=y.gl,S=_.transform,I=_.colorModeForRenderPass(),M=_.getDepthModeFor3D(),k=_.useProgram("terrain");y.bindFramebuffer.set(null),y.viewport.set([0,0,_.width,_.height]);for(const B of l){const F=i.getTerrainMesh(B.tileID),N=_.renderToTexture.getTexture(B),W=i.getTerrainData(B.tileID);y.activeTexture.set(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,N.texture);const J=i.getMeshFrameDelta(S.zoom),G=S.calculateFogMatrix(B.tileID.toUnwrapped()),Q=Sf(J,G,_.style.sky,S.pitch,g),re=S.getProjectionData({overscaledTileID:B.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});k.draw(y,x.TRIANGLES,M,Pt.disabled,I,Ft.backCCW,Q,W,re,"terrain",F.vertexBuffer,F.indexBuffer,F.segments)}}function ls(_,i){if(!i.mesh){const l=new o.aK;l.emplaceBack(-1,-1),l.emplaceBack(1,-1),l.emplaceBack(1,1),l.emplaceBack(-1,1);const f=new o.aM;f.emplaceBack(0,1,2),f.emplaceBack(0,2,3),i.mesh=new jn(_.createVertexBuffer(l,$n.members),_.createIndexBuffer(f),o.aL.simpleSegment(0,0,l.length,f.length))}return i.mesh}class dn{constructor(i,l){this.context=new qt(i),this.transform=l,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:o.af(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=He.maxUnderzooming+He.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Za}resize(i,l,f){if(this.width=Math.floor(i*f),this.height=Math.floor(l*f),this.pixelRatio=f,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const g of this.style._order)this.style._layers[g].resize()}setup(){const i=this.context,l=new o.aK;l.emplaceBack(0,0),l.emplaceBack(o.$,0),l.emplaceBack(0,o.$),l.emplaceBack(o.$,o.$),this.tileExtentBuffer=i.createVertexBuffer(l,$n.members),this.tileExtentSegments=o.aL.simpleSegment(0,0,4,2);const f=new o.aK;f.emplaceBack(0,0),f.emplaceBack(o.$,0),f.emplaceBack(0,o.$),f.emplaceBack(o.$,o.$),this.debugBuffer=i.createVertexBuffer(f,$n.members),this.debugSegments=o.aL.simpleSegment(0,0,4,5);const g=new o.c5;g.emplaceBack(0,0,0,0),g.emplaceBack(o.$,0,o.$,0),g.emplaceBack(0,o.$,0,o.$),g.emplaceBack(o.$,o.$,o.$,o.$),this.rasterBoundsBuffer=i.createVertexBuffer(g,wf.members),this.rasterBoundsSegments=o.aL.simpleSegment(0,0,4,2);const y=new o.aK;y.emplaceBack(0,0),y.emplaceBack(o.$,0),y.emplaceBack(0,o.$),y.emplaceBack(o.$,o.$),this.rasterBoundsBufferPosOnly=i.createVertexBuffer(y,$n.members),this.rasterBoundsSegmentsPosOnly=o.aL.simpleSegment(0,0,4,5);const x=new o.aK;x.emplaceBack(0,0),x.emplaceBack(1,0),x.emplaceBack(0,1),x.emplaceBack(1,1),this.viewportBuffer=i.createVertexBuffer(x,$n.members),this.viewportSegments=o.aL.simpleSegment(0,0,4,2);const S=new o.c6;S.emplaceBack(0),S.emplaceBack(1),S.emplaceBack(3),S.emplaceBack(2),S.emplaceBack(0),this.tileBorderIndexBuffer=i.createIndexBuffer(S);const I=new o.aM;I.emplaceBack(1,0,2),I.emplaceBack(1,2,3),this.quadTriangleIndexBuffer=i.createIndexBuffer(I);const M=this.context.gl;this.stencilClearMode=new Pt({func:M.ALWAYS,mask:0},0,255,M.ZERO,M.ZERO,M.ZERO),this.tileExtentMesh=new jn(this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}clearStencil(){const i=this.context,l=i.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const f=o.L();o.bX(f,0,this.width,this.height,0,0,1),o.N(f,f,[l.drawingBufferWidth,l.drawingBufferHeight,0]);const g={mainMatrix:f,tileMercatorCoords:[0,0,1,1],clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:f};this.useProgram("clippingMask",null,!0).draw(i,l.TRIANGLES,Lt.disabled,this.stencilClearMode,tr.disabled,Ft.disabled,null,null,g,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(i,l,f){if(this.currentStencilSource===i.source||!i.isTileClipped()||!l||!l.length)return;this.currentStencilSource=i.source,this.nextStencilID+l.length>256&&this.clearStencil();const g=this.context;g.setColorMode(tr.disabled),g.setDepthMode(Lt.disabled);const y={};for(const x of l)y[x.key]=this.nextStencilID++;this._renderTileMasks(y,l,f,!0),this._renderTileMasks(y,l,f,!1),this._tileClippingMaskIDs=y}_renderTileMasks(i,l,f,g){const y=this.context,x=y.gl,S=this.style.projection,I=this.transform,M=this.useProgram("clippingMask");for(const k of l){const B=i[k.key],F=this.style.map.terrain&&this.style.map.terrain.getTerrainData(k),N=S.getMeshFromTileID(this.context,k.canonical,g,!0,"stencil"),W=I.getProjectionData({overscaledTileID:k,applyGlobeMatrix:!f,applyTerrainMatrix:!0});M.draw(y,x.TRIANGLES,Lt.disabled,new Pt({func:x.ALWAYS,mask:0},B,255,x.KEEP,x.KEEP,x.REPLACE),tr.disabled,f?Ft.disabled:Ft.backCCW,null,F,W,"$clipping",N.vertexBuffer,N.indexBuffer,N.segments)}}_renderTilesDepthBuffer(){const i=this.context,l=i.gl,f=this.style.projection,g=this.transform,y=this.useProgram("depth"),x=this.getDepthModeFor3D(),S=Ne(g,{tileSize:g.tileSize});for(const I of S){const M=this.style.map.terrain&&this.style.map.terrain.getTerrainData(I),k=f.getMeshFromTileID(this.context,I.canonical,!0,!0,"raster"),B=g.getProjectionData({overscaledTileID:I,applyGlobeMatrix:!0,applyTerrainMatrix:!0});y.draw(i,l.TRIANGLES,x,Pt.disabled,tr.disabled,Ft.backCCW,null,M,B,"$clipping",k.vertexBuffer,k.indexBuffer,k.segments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const i=this.nextStencilID++,l=this.context.gl;return new Pt({func:l.NOTEQUAL,mask:255},i,255,l.KEEP,l.KEEP,l.REPLACE)}stencilModeForClipping(i){const l=this.context.gl;return new Pt({func:l.EQUAL,mask:255},this._tileClippingMaskIDs[i.key],0,l.KEEP,l.KEEP,l.REPLACE)}getStencilConfigForOverlapAndUpdateStencilID(i){const l=this.context.gl,f=i.sort((x,S)=>S.overscaledZ-x.overscaledZ),g=f[f.length-1].overscaledZ,y=f[0].overscaledZ-g+1;if(y>1){this.currentStencilSource=void 0,this.nextStencilID+y>256&&this.clearStencil();const x={};for(let S=0;S<y;S++)x[S+g]=new Pt({func:l.GEQUAL,mask:255},S+this.nextStencilID,255,l.KEEP,l.KEEP,l.REPLACE);return this.nextStencilID+=y,[x,f]}return[{[g]:Pt.disabled},f]}stencilConfigForOverlapTwoPass(i){const l=this.context.gl,f=i.sort((x,S)=>S.overscaledZ-x.overscaledZ),g=f[f.length-1].overscaledZ,y=f[0].overscaledZ-g+1;if(this.clearStencil(),y>1){const x={},S={};for(let I=0;I<y;I++)x[I+g]=new Pt({func:l.GREATER,mask:255},y+1+I,255,l.KEEP,l.KEEP,l.REPLACE),S[I+g]=new Pt({func:l.GREATER,mask:255},1+I,255,l.KEEP,l.KEEP,l.REPLACE);return this.nextStencilID=2*y+1,[x,S,f]}return this.nextStencilID=3,[{[g]:new Pt({func:l.GREATER,mask:255},2,255,l.KEEP,l.KEEP,l.REPLACE)},{[g]:new Pt({func:l.GREATER,mask:255},1,255,l.KEEP,l.KEEP,l.REPLACE)},f]}colorModeForRenderPass(){const i=this.context.gl;return this._showOverdrawInspector?new tr([i.CONSTANT_COLOR,i.ONE],new o.be(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?tr.unblended:tr.alphaBlended}getDepthModeForSublayer(i,l,f){if(!this.opaquePassEnabledForLayer())return Lt.disabled;const g=1-((1+this.currentLayer)*this.numSublayers+i)*this.depthEpsilon;return new Lt(f||this.context.gl.LEQUAL,l,[g,g])}getDepthModeFor3D(){return new Lt(this.context.gl.LEQUAL,Lt.ReadWrite,this.depthRangeFor3D)}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(i,l){var f,g;this.style=i,this.options=l,this.lineAtlas=i.lineAtlas,this.imageManager=i.imageManager,this.glyphManager=i.glyphManager,this.symbolFadeChange=i.placement.symbolFadeChange($.now()),this.imageManager.beginFrame();const y=this.style._order,x=this.style.sourceCaches,S={},I={},M={},k={isRenderingToTexture:!1,isRenderingGlobe:((f=i.projection)===null||f===void 0?void 0:f.transitionState)>0};for(const F in x){const N=x[F];N.used&&N.prepare(this.context),S[F]=N.getVisibleCoordinates(!1),I[F]=S[F].slice().reverse(),M[F]=N.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let F=0;F<y.length;F++)if(this.style._layers[y[F]].is3D()){this.opaquePassCutoff=F;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const F of y){const N=this.style._layers[F];if(!N.hasOffscreenPass()||N.isHidden(this.transform.zoom))continue;const W=I[N.source];(N.type==="custom"||W.length)&&this.renderLayer(this,x[N.source],N,W,k)}if((g=this.style.projection)===null||g===void 0||g.updateGPUdependent({context:this.context,useProgram:F=>this.useProgram(F)}),this.context.viewport.set([0,0,this.width,this.height]),this.context.bindFramebuffer.set(null),this.context.clear({color:l.showOverdrawInspector?o.be.black:o.be.transparent,depth:1}),this.clearStencil(),this.style.sky&&function(F,N){const W=F.context,J=W.gl,G=((de,oe,ye)=>{const Oe=Math.cos(oe.rollInRadians),Ce=Math.sin(oe.rollInRadians),Me=X(oe),Fe=oe.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}).projectionTransition;return{u_sky_color:de.properties.get("sky-color"),u_horizon_color:de.properties.get("horizon-color"),u_horizon:[(oe.width/2-Me*Ce)*ye,(oe.height/2+Me*Oe)*ye],u_horizon_normal:[-Ce,Oe],u_sky_horizon_blend:de.properties.get("sky-horizon-blend")*oe.height/2*ye,u_sky_blend:Fe}})(N,F.style.map.transform,F.pixelRatio),Q=new Lt(J.LEQUAL,Lt.ReadWrite,[0,1]),re=Pt.disabled,ae=F.colorModeForRenderPass(),se=F.useProgram("sky"),ue=ls(W,N);se.draw(W,J.TRIANGLES,Q,re,ae,Ft.disabled,G,null,void 0,"sky",ue.vertexBuffer,ue.indexBuffer,ue.segments)}(this,this.style.sky),this._showOverdrawInspector=l.showOverdrawInspector,this.depthRangeFor3D=[0,1-(i._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=y.length-1;this.currentLayer>=0;this.currentLayer--){const F=this.style._layers[y[this.currentLayer]],N=x[F.source],W=S[F.source];this._renderTileClippingMasks(F,W,!1),this.renderLayer(this,N,F,W,k)}this.renderPass="translucent";let B=!1;for(this.currentLayer=0;this.currentLayer<y.length;this.currentLayer++){const F=this.style._layers[y[this.currentLayer]],N=x[F.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(F,k))continue;this.opaquePassEnabledForLayer()||B||(B=!0,k.isRenderingGlobe&&!this.style.map.terrain&&this._renderTilesDepthBuffer());const W=(F.type==="symbol"?M:I)[F.source];this._renderTileClippingMasks(F,S[F.source],!!this.renderToTexture),this.renderLayer(this,N,F,W,k)}if(k.isRenderingGlobe&&function(F,N,W){const J=F.context,G=J.gl,Q=F.useProgram("atmosphere"),re=new Lt(G.LEQUAL,Lt.ReadOnly,[0,1]),ae=F.transform,se=function(Fe,nt){const it=Fe.properties.get("position"),qe=[-it.x,-it.y,-it.z],ft=o.af(new Float64Array(16));return Fe.properties.get("anchor")==="map"&&(o.b5(ft,ft,nt.rollInRadians),o.b6(ft,ft,-nt.pitchInRadians),o.b5(ft,ft,nt.bearingInRadians),o.b6(ft,ft,nt.center.lat*Math.PI/180),o.by(ft,ft,-nt.center.lng*Math.PI/180)),o.c4(qe,qe,ft),qe}(W,F.transform),ue=ae.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),de=N.properties.get("atmosphere-blend")*ue.projectionTransition;if(de===0)return;const oe=Ys(ae.worldSize,ae.center.lat),ye=ae.inverseProjectionMatrix,Oe=new Float64Array(4);Oe[3]=1,o.av(Oe,Oe,ae.modelViewProjectionMatrix),Oe[0]/=Oe[3],Oe[1]/=Oe[3],Oe[2]/=Oe[3],Oe[3]=1,o.av(Oe,Oe,ye),Oe[0]/=Oe[3],Oe[1]/=Oe[3],Oe[2]/=Oe[3],Oe[3]=1;const Ce=((Fe,nt,it,qe,ft)=>({u_sun_pos:Fe,u_atmosphere_blend:nt,u_globe_position:it,u_globe_radius:qe,u_inv_proj_matrix:ft}))(se,de,[Oe[0],Oe[1],Oe[2]],oe,ye),Me=ls(J,N);Q.draw(J,G.TRIANGLES,re,Pt.disabled,tr.alphaBlended,Ft.disabled,Ce,null,null,"atmosphere",Me.vertexBuffer,Me.indexBuffer,Me.segments)}(this,this.style.sky,this.style.light),this.options.showTileBoundaries){const F=function(N,W){let J=null;const G=Object.values(N._layers).flatMap(se=>se.source&&!se.isHidden(W)?[N.sourceCaches[se.source]]:[]),Q=G.filter(se=>se.getSource().type==="vector"),re=G.filter(se=>se.getSource().type!=="vector"),ae=se=>{(!J||J.getSource().maxzoom<se.getSource().maxzoom)&&(J=se)};return Q.forEach(se=>ae(se)),J||re.forEach(se=>ae(se)),J}(this.style,this.transform.zoom);F&&function(N,W,J){for(let G=0;G<J.length;G++)Bu(N,W,J[G])}(this,F,F.getVisibleCoordinates())}this.options.showPadding&&function(F){const N=F.transform.padding;sa(F,F.transform.height-(N.top||0),3,Du),sa(F,N.bottom||0,3,dl),fl(F,N.left||0,3,Vc),fl(F,F.transform.width-(N.right||0),3,Ou);const W=F.transform.centerPoint;(function(J,G,Q,re){pl(J,G-1,Q-10,2,20,re),pl(J,G-10,Q-1,20,2,re)})(F,W.x,F.transform.height-W.y,Fu)}(this),this.context.setDefault()}maybeDrawDepthAndCoords(i){if(!this.style||!this.style.map||!this.style.map.terrain)return;const l=this.terrainFacilitator.matrix,f=this.transform.modelViewProjectionMatrix;let g=this.terrainFacilitator.dirty;g||(g=i?!o.c7(l,f):!o.c8(l,f)),g||(g=this.style.map.terrain.sourceCache.anyTilesAfterTime(this.terrainFacilitator.renderTime)),g&&(o.c9(l,f),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(y,x){const S=y.context,I=S.gl,M=y.transform,k=tr.unblended,B=new Lt(I.LEQUAL,Lt.ReadWrite,[0,1]),F=x.sourceCache.getRenderableTiles(),N=y.useProgram("terrainDepth");S.bindFramebuffer.set(x.getFramebuffer("depth").framebuffer),S.viewport.set([0,0,y.width/devicePixelRatio,y.height/devicePixelRatio]),S.clear({color:o.be.transparent,depth:1});for(const W of F){const J=x.getTerrainMesh(W.tileID),G=x.getTerrainData(W.tileID),Q=M.getProjectionData({overscaledTileID:W.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0}),re={u_ele_delta:x.getMeshFrameDelta(M.zoom)};N.draw(S,I.TRIANGLES,B,Pt.disabled,k,Ft.backCCW,re,G,Q,"terrain",J.vertexBuffer,J.indexBuffer,J.segments)}S.bindFramebuffer.set(null),S.viewport.set([0,0,y.width,y.height])}(this,this.style.map.terrain),function(y,x){const S=y.context,I=S.gl,M=y.transform,k=tr.unblended,B=new Lt(I.LEQUAL,Lt.ReadWrite,[0,1]),F=x.getCoordsTexture(),N=x.sourceCache.getRenderableTiles(),W=y.useProgram("terrainCoords");S.bindFramebuffer.set(x.getFramebuffer("coords").framebuffer),S.viewport.set([0,0,y.width/devicePixelRatio,y.height/devicePixelRatio]),S.clear({color:o.be.transparent,depth:1}),x.coordsIndex=[];for(const J of N){const G=x.getTerrainMesh(J.tileID),Q=x.getTerrainData(J.tileID);S.activeTexture.set(I.TEXTURE0),I.bindTexture(I.TEXTURE_2D,F.texture);const re={u_terrain_coords_id:(255-x.coordsIndex.length)/255,u_texture:0,u_ele_delta:x.getMeshFrameDelta(M.zoom)},ae=M.getProjectionData({overscaledTileID:J.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});W.draw(S,I.TRIANGLES,B,Pt.disabled,k,Ft.backCCW,re,Q,ae,"terrain",G.vertexBuffer,G.indexBuffer,G.segments),x.coordsIndex.push(J.tileID.key)}S.bindFramebuffer.set(null),S.viewport.set([0,0,y.width,y.height])}(this,this.style.map.terrain))}renderLayer(i,l,f,g,y){f.isHidden(this.transform.zoom)||(f.type==="background"||f.type==="custom"||(g||[]).length)&&(this.id=f.id,o.ca(f)?function(x,S,I,M,k,B){if(x.renderPass!=="translucent")return;const{isRenderingToTexture:F}=B,N=Pt.disabled,W=x.colorModeForRenderPass();(I._unevaluatedLayout.hasValue("text-variable-anchor")||I._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(J,G,Q,re,ae,se,ue,de,oe){const ye=G.transform,Oe=G.style.map.terrain,Ce=ae==="map",Me=se==="map";for(const Fe of J){const nt=re.getTile(Fe),it=nt.getBucket(Q);if(!it||!it.text||!it.text.segments.get().length)continue;const qe=o.am(it.textSizeData,ye.zoom),ft=o.aB(nt,1,G.transform.zoom),Nt=Dt(Ce,G.transform,ft),sr=Q.layout.get("icon-text-fit")!=="none"&&it.hasIconData();if(qe){const Lr=Math.pow(2,ye.zoom-nt.tileID.overscaledZ),ur=Oe?(Nr,br)=>Oe.getElevation(Fe,Nr,br):null;Lf(it,Ce,Me,oe,ye,Nt,Lr,qe,sr,o.aC(ye,nt,ue,de),Fe.toUnwrapped(),ur)}}}(M,x,I,S,I.layout.get("text-rotation-alignment"),I.layout.get("text-pitch-alignment"),I.paint.get("text-translate"),I.paint.get("text-translate-anchor"),k),I.paint.get("icon-opacity").constantOr(1)!==0&&ku(x,S,I,M,!1,I.paint.get("icon-translate"),I.paint.get("icon-translate-anchor"),I.layout.get("icon-rotation-alignment"),I.layout.get("icon-pitch-alignment"),I.layout.get("icon-keep-upright"),N,W,F),I.paint.get("text-opacity").constantOr(1)!==0&&ku(x,S,I,M,!0,I.paint.get("text-translate"),I.paint.get("text-translate-anchor"),I.layout.get("text-rotation-alignment"),I.layout.get("text-pitch-alignment"),I.layout.get("text-keep-upright"),N,W,F),S.map.showCollisionBoxes&&(Pu(x,S,I,M,!0),Pu(x,S,I,M,!1))}(i,l,f,g,this.style.placement.variableOffsets,y):o.cb(f)?function(x,S,I,M,k){if(x.renderPass!=="translucent")return;const{isRenderingToTexture:B}=k,F=I.paint.get("circle-opacity"),N=I.paint.get("circle-stroke-width"),W=I.paint.get("circle-stroke-opacity"),J=!I.layout.get("circle-sort-key").isConstant();if(F.constantOr(1)===0&&(N.constantOr(1)===0||W.constantOr(1)===0))return;const G=x.context,Q=G.gl,re=x.transform,ae=x.getDepthModeForSublayer(0,Lt.ReadOnly),se=Pt.disabled,ue=x.colorModeForRenderPass(),de=[],oe=re.getCircleRadiusCorrection();for(let ye=0;ye<M.length;ye++){const Oe=M[ye],Ce=S.getTile(Oe),Me=Ce.getBucket(I);if(!Me)continue;const Fe=I.paint.get("circle-translate"),nt=I.paint.get("circle-translate-anchor"),it=o.aC(re,Ce,Fe,nt),qe=Me.programConfigurations.get(I.id),ft=x.useProgram("circle",qe),Nt=Me.layoutVertexBuffer,sr=Me.indexBuffer,Lr=x.style.map.terrain&&x.style.map.terrain.getTerrainData(Oe),ur={programConfiguration:qe,program:ft,layoutVertexBuffer:Nt,indexBuffer:sr,uniformValues:Sc(x,Ce,I,it,oe),terrainData:Lr,projectionData:re.getProjectionData({overscaledTileID:Oe,applyGlobeMatrix:!B,applyTerrainMatrix:!0})};if(J){const Nr=Me.segments.get();for(const br of Nr)de.push({segments:new o.aL([br]),sortKey:br.sortKey,state:ur})}else de.push({segments:Me.segments,sortKey:0,state:ur})}J&&de.sort((ye,Oe)=>ye.sortKey-Oe.sortKey);for(const ye of de){const{programConfiguration:Oe,program:Ce,layoutVertexBuffer:Me,indexBuffer:Fe,uniformValues:nt,terrainData:it,projectionData:qe}=ye.state;Ce.draw(G,Q.TRIANGLES,ae,se,ue,Ft.backCCW,nt,it,qe,I.id,Me,Fe,ye.segments,I.paint,x.transform.zoom,Oe)}}(i,l,f,g,y):o.cc(f)?function(x,S,I,M,k){if(I.paint.get("heatmap-opacity")===0)return;const B=x.context,{isRenderingToTexture:F,isRenderingGlobe:N}=k;if(x.style.map.terrain){for(const W of M){const J=S.getTile(W);S.hasRenderableParent(W)||(x.renderPass==="offscreen"?cl(x,J,I,W,N):x.renderPass==="translucent"&&hl(x,I,W,F,N))}B.viewport.set([0,0,x.width,x.height])}else x.renderPass==="offscreen"?function(W,J,G,Q){const re=W.context,ae=re.gl,se=W.transform,ue=Pt.disabled,de=new tr([ae.ONE,ae.ONE],o.be.transparent,[!0,!0,!0,!0]);(function(oe,ye,Oe){const Ce=oe.gl;oe.activeTexture.set(Ce.TEXTURE1),oe.viewport.set([0,0,ye.width/4,ye.height/4]);let Me=Oe.heatmapFbos.get(o.c1);Me?(Ce.bindTexture(Ce.TEXTURE_2D,Me.colorAttachment.get()),oe.bindFramebuffer.set(Me.framebuffer)):(Me=ra(oe,ye.width/4,ye.height/4),Oe.heatmapFbos.set(o.c1,Me))})(re,W,G),re.clear({color:o.be.transparent});for(let oe=0;oe<Q.length;oe++){const ye=Q[oe];if(J.hasRenderableParent(ye))continue;const Oe=J.getTile(ye),Ce=Oe.getBucket(G);if(!Ce)continue;const Me=Ce.programConfigurations.get(G.id),Fe=W.useProgram("heatmap",Me),nt=se.getProjectionData({overscaledTileID:ye,applyGlobeMatrix:!0,applyTerrainMatrix:!1}),it=se.getCircleRadiusCorrection();Fe.draw(re,ae.TRIANGLES,Lt.disabled,ue,de,Ft.backCCW,Jo(Oe,se.zoom,G.paint.get("heatmap-intensity"),it),null,nt,G.id,Ce.layoutVertexBuffer,Ce.indexBuffer,Ce.segments,G.paint,se.zoom,Me)}re.viewport.set([0,0,W.width,W.height])}(x,S,I,M):x.renderPass==="translucent"&&function(W,J){const G=W.context,Q=G.gl;G.setColorMode(W.colorModeForRenderPass());const re=J.heatmapFbos.get(o.c1);re&&(G.activeTexture.set(Q.TEXTURE0),Q.bindTexture(Q.TEXTURE_2D,re.colorAttachment.get()),G.activeTexture.set(Q.TEXTURE1),ul(G,J).bind(Q.LINEAR,Q.CLAMP_TO_EDGE),W.useProgram("heatmapTexture").draw(G,Q.TRIANGLES,Lt.disabled,Pt.disabled,W.colorModeForRenderPass(),Ft.disabled,pu(W,J,0,1),null,null,J.id,W.viewportBuffer,W.quadTriangleIndexBuffer,W.viewportSegments,J.paint,W.transform.zoom))}(x,I)}(i,l,f,g,y):o.cd(f)?function(x,S,I,M,k){if(x.renderPass!=="translucent")return;const{isRenderingToTexture:B}=k,F=I.paint.get("line-opacity"),N=I.paint.get("line-width");if(F.constantOr(1)===0||N.constantOr(1)===0)return;const W=x.getDepthModeForSublayer(0,Lt.ReadOnly),J=x.colorModeForRenderPass(),G=I.paint.get("line-dasharray"),Q=I.paint.get("line-pattern"),re=Q.constantOr(1),ae=I.paint.get("line-gradient"),se=I.getCrossfadeParameters(),ue=re?"linePattern":G?"lineSDF":ae?"lineGradient":"line",de=x.context,oe=de.gl,ye=x.transform;let Oe=!0;for(const Ce of M){const Me=S.getTile(Ce);if(re&&!Me.patternsLoaded())continue;const Fe=Me.getBucket(I);if(!Fe)continue;const nt=Fe.programConfigurations.get(I.id),it=x.context.program.get(),qe=x.useProgram(ue,nt),ft=Oe||qe.program!==it,Nt=x.style.map.terrain&&x.style.map.terrain.getTerrainData(Ce),sr=Q.constantOr(null);if(sr&&Me.imageAtlas){const dr=Me.imageAtlas,vr=dr.patternPositions[sr.to.toString()],xi=dr.patternPositions[sr.from.toString()];vr&&xi&&nt.setConstantPatternPositions(vr,xi)}const Lr=ye.getProjectionData({overscaledTileID:Ce,applyGlobeMatrix:!B,applyTerrainMatrix:!0}),ur=ye.getPixelScale(),Nr=re?mu(x,Me,I,ur,se):G?_u(x,Me,I,ur,G,se):ae?Ac(x,Me,I,ur,Fe.lineClipsArray.length):el(x,Me,I,ur);if(re)de.activeTexture.set(oe.TEXTURE0),Me.imageAtlasTexture.bind(oe.LINEAR,oe.CLAMP_TO_EDGE),nt.updatePaintBuffers(se);else if(G&&(ft||x.lineAtlas.dirty))de.activeTexture.set(oe.TEXTURE0),x.lineAtlas.bind(de);else if(ae){const dr=Fe.gradients[I.id];let vr=dr.texture;if(I.gradientVersion!==dr.version){let xi=256;if(I.stepInterpolant){const rr=S.getSource().maxzoom,hi=Ce.canonical.z===rr?Math.ceil(1<<x.transform.maxZoom-Ce.canonical.z):1;xi=o.ag(o.c2(Fe.maxLineLength/o.$*1024*hi),256,de.maxTextureSize)}dr.gradient=o.c3({expression:I.gradientExpression(),evaluationKey:"lineProgress",resolution:xi,image:dr.gradient||void 0,clips:Fe.lineClipsArray}),dr.texture?dr.texture.update(dr.gradient):dr.texture=new o.T(de,dr.gradient,oe.RGBA),dr.version=I.gradientVersion,vr=dr.texture}de.activeTexture.set(oe.TEXTURE0),vr.bind(I.stepInterpolant?oe.NEAREST:oe.LINEAR,oe.CLAMP_TO_EDGE)}const br=x.stencilModeForClipping(Ce);qe.draw(de,oe.TRIANGLES,W,br,J,Ft.disabled,Nr,Nt,Lr,I.id,Fe.layoutVertexBuffer,Fe.indexBuffer,Fe.segments,I.paint,x.transform.zoom,nt,Fe.layoutVertexBuffer2),Oe=!1}}(i,l,f,g,y):o.ce(f)?function(x,S,I,M,k){const B=I.paint.get("fill-color"),F=I.paint.get("fill-opacity");if(F.constantOr(1)===0)return;const{isRenderingToTexture:N}=k,W=x.colorModeForRenderPass(),J=I.paint.get("fill-pattern"),G=x.opaquePassEnabledForLayer()&&!J.constantOr(1)&&B.constantOr(o.be.transparent).a===1&&F.constantOr(0)===1?"opaque":"translucent";if(x.renderPass===G){const Q=x.getDepthModeForSublayer(1,x.renderPass==="opaque"?Lt.ReadWrite:Lt.ReadOnly);ia(x,S,I,M,Q,W,!1,N)}if(x.renderPass==="translucent"&&I.paint.get("fill-antialias")){const Q=x.getDepthModeForSublayer(I.getPaintProperty("fill-outline-color")?2:0,Lt.ReadOnly);ia(x,S,I,M,Q,W,!0,N)}}(i,l,f,g,y):o.cf(f)?function(x,S,I,M,k){const B=I.paint.get("fill-extrusion-opacity");if(B===0)return;const{isRenderingToTexture:F}=k;if(x.renderPass==="translucent"){const N=new Lt(x.context.gl.LEQUAL,Lt.ReadWrite,x.depthRangeFor3D);if(B!==1||I.paint.get("fill-extrusion-pattern").constantOr(1))ao(x,S,I,M,N,Pt.disabled,tr.disabled,F),ao(x,S,I,M,N,x.stencilModeFor3D(),x.colorModeForRenderPass(),F);else{const W=x.colorModeForRenderPass();ao(x,S,I,M,N,Pt.disabled,W,F)}}}(i,l,f,g,y):o.cg(f)?function(x,S,I,M,k){if(x.renderPass!=="offscreen"&&x.renderPass!=="translucent")return;const{isRenderingToTexture:B}=k,F=x.context,N=x.style.projection.useSubdivision,W=x.getDepthModeForSublayer(0,Lt.ReadOnly),J=x.colorModeForRenderPass();if(x.renderPass==="offscreen")(function(G,Q,re,ae,se,ue,de){const oe=G.context,ye=oe.gl;for(const Oe of re){const Ce=Q.getTile(Oe),Me=Ce.dem;if(!Me||!Me.data||!Ce.needsHillshadePrepare)continue;const Fe=Me.dim,nt=Me.stride,it=Me.getPixels();if(oe.activeTexture.set(ye.TEXTURE1),oe.pixelStoreUnpackPremultiplyAlpha.set(!1),Ce.demTexture=Ce.demTexture||G.getTileTexture(nt),Ce.demTexture){const ft=Ce.demTexture;ft.update(it,{premultiply:!1}),ft.bind(ye.NEAREST,ye.CLAMP_TO_EDGE)}else Ce.demTexture=new o.T(oe,it,ye.RGBA,{premultiply:!1}),Ce.demTexture.bind(ye.NEAREST,ye.CLAMP_TO_EDGE);oe.activeTexture.set(ye.TEXTURE0);let qe=Ce.fbo;if(!qe){const ft=new o.T(oe,{width:Fe,height:Fe,data:null},ye.RGBA);ft.bind(ye.LINEAR,ye.CLAMP_TO_EDGE),qe=Ce.fbo=oe.createFramebuffer(Fe,Fe,!0,!1),qe.colorAttachment.set(ft.texture)}oe.bindFramebuffer.set(qe.framebuffer),oe.viewport.set([0,0,Fe,Fe]),G.useProgram("hillshadePrepare").draw(oe,ye.TRIANGLES,se,ue,de,Ft.disabled,If(Ce.tileID,Me),null,null,ae.id,G.rasterBoundsBuffer,G.quadTriangleIndexBuffer,G.rasterBoundsSegments),Ce.needsHillshadePrepare=!1}})(x,S,M,I,W,Pt.disabled,J),F.viewport.set([0,0,x.width,x.height]);else if(x.renderPass==="translucent")if(N){const[G,Q,re]=x.stencilConfigForOverlapTwoPass(M);lo(x,S,I,re,G,W,J,!1,B),lo(x,S,I,re,Q,W,J,!0,B)}else{const[G,Q]=x.getStencilConfigForOverlapAndUpdateStencilID(M);lo(x,S,I,Q,G,W,J,!1,B)}}(i,l,f,g,y):o.ch(f)?function(x,S,I,M,k){if(x.renderPass!=="translucent"||!M.length)return;const{isRenderingToTexture:B}=k,F=x.style.projection.useSubdivision,N=x.getDepthModeForSublayer(0,Lt.ReadOnly),W=x.colorModeForRenderPass();if(F){const[J,G,Q]=x.stencilConfigForOverlapTwoPass(M);na(x,S,I,Q,J,N,W,!1,B),na(x,S,I,Q,G,N,W,!0,B)}else{const[J,G]=x.getStencilConfigForOverlapAndUpdateStencilID(M);na(x,S,I,G,J,N,W,!1,B)}}(i,l,f,g,y):o.ci(f)?function(x,S,I,M,k){if(x.renderPass!=="translucent"||I.paint.get("raster-opacity")===0||!M.length)return;const{isRenderingToTexture:B}=k,F=S.getSource(),N=x.style.projection.useSubdivision;if(F instanceof Qt)as(x,S,I,M,null,!1,!1,F.tileCoords,F.flippedWindingOrder,B);else if(N){const[W,J,G]=x.stencilConfigForOverlapTwoPass(M);as(x,S,I,G,W,!1,!0,Uc,!1,B),as(x,S,I,G,J,!0,!0,Uc,!1,B)}else{const[W,J]=x.getStencilConfigForOverlapAndUpdateStencilID(M);as(x,S,I,J,W,!1,!0,Uc,!1,B)}}(i,l,f,g,y):o.cj(f)?function(x,S,I,M,k){const B=I.paint.get("background-color"),F=I.paint.get("background-opacity");if(F===0)return;const{isRenderingToTexture:N}=k,W=x.context,J=W.gl,G=x.style.projection,Q=x.transform,re=Q.tileSize,ae=I.paint.get("background-pattern");if(x.isPatternMissing(ae))return;const se=!ae&&B.a===1&&F===1&&x.opaquePassEnabledForLayer()?"opaque":"translucent";if(x.renderPass!==se)return;const ue=Pt.disabled,de=x.getDepthModeForSublayer(0,se==="opaque"?Lt.ReadWrite:Lt.ReadOnly),oe=x.colorModeForRenderPass(),ye=x.useProgram(ae?"backgroundPattern":"background"),Oe=M||Ne(Q,{tileSize:re,terrain:x.style.map.terrain});ae&&(W.activeTexture.set(J.TEXTURE0),x.imageManager.bind(x.context));const Ce=I.getCrossfadeParameters();for(const Me of Oe){const Fe=Q.getProjectionData({overscaledTileID:Me,applyGlobeMatrix:!N,applyTerrainMatrix:!0}),nt=ae?Mf(F,x,ae,{tileID:Me,tileSize:re},Ce):tl(F,B),it=x.style.map.terrain&&x.style.map.terrain.getTerrainData(Me),qe=G.getMeshFromTileID(W,Me.canonical,!1,!0,"raster");ye.draw(W,J.TRIANGLES,de,ue,oe,Ft.backCCW,nt,it,Fe,I.id,qe.vertexBuffer,qe.indexBuffer,qe.segments)}}(i,0,f,g,y):o.ck(f)&&function(x,S,I,M){const{isRenderingGlobe:k}=M,B=x.context,F=I.implementation,N=x.style.projection,W=x.transform,J=W.getProjectionDataForCustomLayer(k),G={farZ:W.farZ,nearZ:W.nearZ,fov:W.fov*Math.PI/180,modelViewProjectionMatrix:W.modelViewProjectionMatrix,projectionMatrix:W.projectionMatrix,shaderData:{variantName:N.shaderVariantName,vertexShaderPrelude:`const float PI = 3.141592653589793;
uniform mat4 u_projection_matrix;
${N.shaderPreludeCode.vertexSource}`,define:N.shaderDefine},defaultProjectionData:J},Q=F.renderingMode?F.renderingMode:"2d";if(x.renderPass==="offscreen"){const re=F.prerender;re&&(x.setCustomLayerDefaults(),B.setColorMode(x.colorModeForRenderPass()),re.call(F,B.gl,G),B.setDirty(),x.setBaseState())}else if(x.renderPass==="translucent"){x.setCustomLayerDefaults(),B.setColorMode(x.colorModeForRenderPass()),B.setStencilMode(Pt.disabled);const re=Q==="3d"?x.getDepthModeFor3D():x.getDepthModeForSublayer(0,Lt.ReadOnly);B.setDepthMode(re),F.render(B.gl,G),B.setDirty(),x.setBaseState(),B.bindFramebuffer.set(null)}}(i,0,f,y))}saveTileTexture(i){const l=this._tileTextures[i.size[0]];l?l.push(i):this._tileTextures[i.size[0]]=[i]}getTileTexture(i){const l=this._tileTextures[i];return l&&l.length>0?l.pop():null}isPatternMissing(i){if(!i)return!1;if(!i.from||!i.to)return!0;const l=this.imageManager.getPattern(i.from.toString()),f=this.imageManager.getPattern(i.to.toString());return!l||!f}useProgram(i,l,f=!1,g=[]){this.cache=this.cache||{};const y=!!this.style.map.terrain,x=this.style.projection,S=f?Cn.projectionMercator:x.shaderPreludeCode,I=f?Ps:x.shaderDefine,M=i+(l?l.cacheKey:"")+`/${f?mc:x.shaderVariantName}`+(this._showOverdrawInspector?"/overdraw":"")+(y?"/terrain":"")+(g?`/${g.join("/")}`:"");return this.cache[M]||(this.cache[M]=new Ka(this.context,Cn[i],l,vu[i],this._showOverdrawInspector,y,S,I,g)),this.cache[M]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const i=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(i.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new o.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){const{drawingBufferWidth:i,drawingBufferHeight:l}=this.context.gl;return this.width!==i||this.height!==l}}function gl(_,i){let l,f=!1,g=null,y=null;const x=()=>{g=null,f&&(_.apply(y,l),g=setTimeout(x,i),f=!1)};return(...S)=>(f=!0,y=this,l=S,g||x(),g)}class oa{constructor(i){this._getCurrentHash=()=>{const l=window.location.hash.replace("#","");if(this._hashName){let f;return l.split("&").map(g=>g.split("=")).forEach(g=>{g[0]===this._hashName&&(f=g)}),(f&&f[1]||"").split("/")}return l.split("/")},this._onHashChange=()=>{const l=this._getCurrentHash();if(!this._isValidHash(l))return!1;const f=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(l[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+l[2],+l[1]],zoom:+l[0],bearing:f,pitch:+(l[4]||0)}),!0},this._updateHashUnthrottled=()=>{const l=window.location.href.replace(/(#.*)?$/,this.getHashString());window.history.replaceState(window.history.state,null,l)},this._removeHash=()=>{const l=this._getCurrentHash();if(l.length===0)return;const f=l.join("/");let g=f;g.split("&").length>0&&(g=g.split("&")[0]),this._hashName&&(g=`${this._hashName}=${f}`);let y=window.location.hash.replace(g,"");y.startsWith("#&")?y=y.slice(0,1)+y.slice(2):y==="#"&&(y="");let x=window.location.href.replace(/(#.+)?$/,y);x=x.replace("&&","&"),window.history.replaceState(window.history.state,null,x)},this._updateHash=gl(this._updateHashUnthrottled,300),this._hashName=i&&encodeURIComponent(i)}addTo(i){return this._map=i,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(i){const l=this._map.getCenter(),f=Math.round(100*this._map.getZoom())/100,g=Math.ceil((f*Math.LN2+Math.log(512/360/.5))/Math.LN10),y=Math.pow(10,g),x=Math.round(l.lng*y)/y,S=Math.round(l.lat*y)/y,I=this._map.getBearing(),M=this._map.getPitch();let k="";if(k+=i?`/${x}/${S}/${f}`:`${f}/${S}/${x}`,(I||M)&&(k+="/"+Math.round(10*I)/10),M&&(k+=`/${Math.round(M)}`),this._hashName){const B=this._hashName;let F=!1;const N=window.location.hash.slice(1).split("&").map(W=>{const J=W.split("=")[0];return J===B?(F=!0,`${J}=${k}`):W}).filter(W=>W);return F||N.push(`${B}=${k}`),`#${N.join("&")}`}return`#${k}`}_isValidHash(i){if(i.length<3||i.some(isNaN))return!1;try{new o.S(+i[2],+i[1])}catch{return!1}const l=+i[0],f=+(i[3]||0),g=+(i[4]||0);return l>=this._map.getMinZoom()&&l<=this._map.getMaxZoom()&&f>=-180&&f<=180&&g>=this._map.getMinPitch()&&g<=this._map.getMaxPitch()}}const co={linearity:.3,easing:o.cl(0,0,.3,1)},ho=o.e({deceleration:2500,maxSpeed:1400},co),jc=o.e({deceleration:20,maxSpeed:1400},co),aa=o.e({deceleration:1e3,maxSpeed:360},co),$c=o.e({deceleration:1e3,maxSpeed:90},co),Lu=o.e({deceleration:1e3,maxSpeed:360},co);class Nu{constructor(i){this._map=i,this.clear()}clear(){this._inertiaBuffer=[]}record(i){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:$.now(),settings:i})}_drainInertiaBuffer(){const i=this._inertiaBuffer,l=$.now();for(;i.length>0&&l-i[0].time>160;)i.shift()}_onMoveEnd(i){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const l={zoom:0,bearing:0,pitch:0,roll:0,pan:new o.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:y}of this._inertiaBuffer)l.zoom+=y.zoomDelta||0,l.bearing+=y.bearingDelta||0,l.pitch+=y.pitchDelta||0,l.roll+=y.rollDelta||0,y.panDelta&&l.pan._add(y.panDelta),y.around&&(l.around=y.around),y.pinchAround&&(l.pinchAround=y.pinchAround);const f=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,g={};if(l.pan.mag()){const y=fo(l.pan.mag(),f,o.e({},ho,i||{})),x=l.pan.mult(y.amount/l.pan.mag()),S=this._map.cameraHelper.handlePanInertia(x,this._map.transform);g.center=S.easingCenter,g.offset=S.easingOffset,uo(g,y)}if(l.zoom){const y=fo(l.zoom,f,jc);g.zoom=this._map.transform.zoom+y.amount,uo(g,y)}if(l.bearing){const y=fo(l.bearing,f,aa);g.bearing=this._map.transform.bearing+o.ag(y.amount,-179,179),uo(g,y)}if(l.pitch){const y=fo(l.pitch,f,$c);g.pitch=this._map.transform.pitch+y.amount,uo(g,y)}if(l.roll){const y=fo(l.roll,f,Lu);g.roll=this._map.transform.roll+o.ag(y.amount,-179,179),uo(g,y)}if(g.zoom||g.bearing){const y=l.pinchAround===void 0?l.around:l.pinchAround;g.around=y?this._map.unproject(y):this._map.getCenter()}return this.clear(),o.e(g,{noMoveStart:!0})}}function uo(_,i){(!_.duration||_.duration<i.duration)&&(_.duration=i.duration,_.easing=i.easing)}function fo(_,i,l){const{maxSpeed:f,linearity:g,deceleration:y}=l,x=o.ag(_*g/(i/1e3),-f,f),S=Math.abs(x)/(y*g);return{easing:l.easing,duration:1e3*S,amount:x*(S/2)}}class qi extends o.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(i,l,f,g={}){f=f instanceof MouseEvent?f:new MouseEvent(i,f);const y=V.mousePos(l.getCanvas(),f),x=l.unproject(y);super(i,o.e({point:y,lngLat:x,originalEvent:f},g)),this._defaultPrevented=!1,this.target=l}}class gn extends o.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(i,l,f){const g=i==="touchend"?f.changedTouches:f.touches,y=V.touchPos(l.getCanvasContainer(),g),x=y.map(I=>l.unproject(I)),S=y.reduce((I,M,k,B)=>I.add(M.div(B.length)),new o.P(0,0));super(i,{points:y,point:S,lngLats:x,lngLat:l.unproject(S),originalEvent:f}),this._defaultPrevented=!1}}class Wc extends o.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(i,l,f){super(i,{originalEvent:f}),this._defaultPrevented=!1}}class zu{constructor(i,l){this._map=i,this._clickTolerance=l.clickTolerance}reset(){delete this._mousedownPos}wheel(i){return this._firePreventable(new Wc(i.type,this._map,i))}mousedown(i,l){return this._mousedownPos=l,this._firePreventable(new qi(i.type,this._map,i))}mouseup(i){this._map.fire(new qi(i.type,this._map,i))}click(i,l){this._mousedownPos&&this._mousedownPos.dist(l)>=this._clickTolerance||this._map.fire(new qi(i.type,this._map,i))}dblclick(i){return this._firePreventable(new qi(i.type,this._map,i))}mouseover(i){this._map.fire(new qi(i.type,this._map,i))}mouseout(i){this._map.fire(new qi(i.type,this._map,i))}touchstart(i){return this._firePreventable(new gn(i.type,this._map,i))}touchmove(i){this._map.fire(new gn(i.type,this._map,i))}touchend(i){this._map.fire(new gn(i.type,this._map,i))}touchcancel(i){this._map.fire(new gn(i.type,this._map,i))}_firePreventable(i){if(this._map.fire(i),i.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Uu{constructor(i){this._map=i}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(i){this._map.fire(new qi(i.type,this._map,i))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new qi("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(i){this._delayContextMenu?this._contextMenuEvent=i:this._ignoreContextMenu||this._map.fire(new qi(i.type,this._map,i)),this._map.listens("contextmenu")&&i.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class po{constructor(i){this._map=i}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(i){return this.transform.screenPointToLocation(o.P.convert(i),this._map.terrain)}}class Hc{constructor(i,l){this._map=i,this._tr=new po(i),this._el=i.getCanvasContainer(),this._container=i.getContainer(),this._clickTolerance=l.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(i,l){this.isEnabled()&&i.shiftKey&&i.button===0&&(V.disableDrag(),this._startPos=this._lastPos=l,this._active=!0)}mousemoveWindow(i,l){if(!this._active)return;const f=l;if(this._lastPos.equals(f)||!this._box&&f.dist(this._startPos)<this._clickTolerance)return;const g=this._startPos;this._lastPos=f,this._box||(this._box=V.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",i));const y=Math.min(g.x,f.x),x=Math.max(g.x,f.x),S=Math.min(g.y,f.y),I=Math.max(g.y,f.y);V.setTransform(this._box,`translate(${y}px,${S}px)`),this._box.style.width=x-y+"px",this._box.style.height=I-S+"px"}mouseupWindow(i,l){if(!this._active||i.button!==0)return;const f=this._startPos,g=l;if(this.reset(),V.suppressClick(),f.x!==g.x||f.y!==g.y)return this._map.fire(new o.l("boxzoomend",{originalEvent:i})),{cameraAnimation:y=>y.fitScreenCoordinates(f,g,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",i)}keydown(i){this._active&&i.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",i))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(V.remove(this._box),this._box=null),V.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(i,l){return this._map.fire(new o.l(i,{originalEvent:l}))}}function ml(_,i){if(_.length!==i.length)throw new Error(`The number of touches and points are not equal - touches ${_.length}, points ${i.length}`);const l={};for(let f=0;f<_.length;f++)l[_[f].identifier]=i[f];return l}class Vu{constructor(i){this.reset(),this.numTouches=i.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(i,l,f){(this.centroid||f.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=i.timeStamp),f.length===this.numTouches&&(this.centroid=function(g){const y=new o.P(0,0);for(const x of g)y._add(x);return y.div(g.length)}(l),this.touches=ml(f,l)))}touchmove(i,l,f){if(this.aborted||!this.centroid)return;const g=ml(f,l);for(const y in this.touches){const x=g[y];(!x||x.dist(this.touches[y])>30)&&(this.aborted=!0)}}touchend(i,l,f){if((!this.centroid||i.timeStamp-this.startTime>500)&&(this.aborted=!0),f.length===0){const g=!this.aborted&&this.centroid;if(this.reset(),g)return g}}}class _l{constructor(i){this.singleTap=new Vu(i),this.numTaps=i.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(i,l,f){this.singleTap.touchstart(i,l,f)}touchmove(i,l,f){this.singleTap.touchmove(i,l,f)}touchend(i,l,f){const g=this.singleTap.touchend(i,l,f);if(g){const y=i.timeStamp-this.lastTime<500,x=!this.lastTap||this.lastTap.dist(g)<30;if(y&&x||this.reset(),this.count++,this.lastTime=i.timeStamp,this.lastTap=g,this.count===this.numTaps)return this.reset(),g}}}class yl{constructor(i){this._tr=new po(i),this._zoomIn=new _l({numTouches:1,numTaps:2}),this._zoomOut=new _l({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(i,l,f){this._zoomIn.touchstart(i,l,f),this._zoomOut.touchstart(i,l,f)}touchmove(i,l,f){this._zoomIn.touchmove(i,l,f),this._zoomOut.touchmove(i,l,f)}touchend(i,l,f){const g=this._zoomIn.touchend(i,l,f),y=this._zoomOut.touchend(i,l,f),x=this._tr;return g?(this._active=!0,i.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:S=>S.easeTo({duration:300,zoom:x.zoom+1,around:x.unproject(g)},{originalEvent:i})}):y?(this._active=!0,i.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:S=>S.easeTo({duration:300,zoom:x.zoom-1,around:x.unproject(y)},{originalEvent:i})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class go{constructor(i){this._enabled=!!i.enable,this._moveStateManager=i.moveStateManager,this._clickTolerance=i.clickTolerance||1,this._moveFunction=i.move,this._activateOnStart=!!i.activateOnStart,i.assignEvents(this),this.reset()}reset(i){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(i)}_move(...i){const l=this._moveFunction(...i);if(l.bearingDelta||l.pitchDelta||l.rollDelta||l.around||l.panDelta)return this._active=!0,l}dragStart(i,l){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(i)&&(this._moveStateManager.startMove(i),this._lastPoint=Array.isArray(l)?l[0]:l,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(i,l){if(!this.isEnabled())return;const f=this._lastPoint;if(!f)return;if(i.preventDefault(),!this._moveStateManager.isValidMoveEvent(i))return void this.reset(i);const g=Array.isArray(l)?l[0]:l;return!this._moved&&g.dist(f)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=g,this._move(f,g))}dragEnd(i){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(i)&&(this._moved&&V.suppressClick(),this.reset(i))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const fn=0,mn=2,ju={[fn]:1,[mn]:2};class Vi{constructor(i){this._correctEvent=i.checkCorrectEvent}startMove(i){const l=V.mouseButton(i);this._eventButton=l}endMove(i){delete this._eventButton}isValidStartEvent(i){return this._correctEvent(i)}isValidMoveEvent(i){return!function(l,f){const g=ju[f];return l.buttons===void 0||(l.buttons&g)!==g}(i,this._eventButton)}isValidEndEvent(i){return V.mouseButton(i)===this._eventButton}}class mo{constructor(){this._firstTouch=void 0}_isOneFingerTouch(i){return i.targetTouches.length===1}_isSameTouchEvent(i){return i.targetTouches[0].identifier===this._firstTouch}startMove(i){this._firstTouch=i.targetTouches[0].identifier}endMove(i){delete this._firstTouch}isValidStartEvent(i){return this._isOneFingerTouch(i)}isValidMoveEvent(i){return this._isOneFingerTouch(i)&&this._isSameTouchEvent(i)}isValidEndEvent(i){return this._isOneFingerTouch(i)&&this._isSameTouchEvent(i)}}class zf{constructor(i=new Vi({checkCorrectEvent:()=>!0}),l=new mo){this.mouseMoveStateManager=i,this.oneFingerTouchMoveStateManager=l}_executeRelevantHandler(i,l,f){return i instanceof MouseEvent?l(i):typeof TouchEvent<"u"&&i instanceof TouchEvent?f(i):void 0}startMove(i){this._executeRelevantHandler(i,l=>this.mouseMoveStateManager.startMove(l),l=>this.oneFingerTouchMoveStateManager.startMove(l))}endMove(i){this._executeRelevantHandler(i,l=>this.mouseMoveStateManager.endMove(l),l=>this.oneFingerTouchMoveStateManager.endMove(l))}isValidStartEvent(i){return this._executeRelevantHandler(i,l=>this.mouseMoveStateManager.isValidStartEvent(l),l=>this.oneFingerTouchMoveStateManager.isValidStartEvent(l))}isValidMoveEvent(i){return this._executeRelevantHandler(i,l=>this.mouseMoveStateManager.isValidMoveEvent(l),l=>this.oneFingerTouchMoveStateManager.isValidMoveEvent(l))}isValidEndEvent(i){return this._executeRelevantHandler(i,l=>this.mouseMoveStateManager.isValidEndEvent(l),l=>this.oneFingerTouchMoveStateManager.isValidEndEvent(l))}}const bl=_=>{_.mousedown=_.dragStart,_.mousemoveWindow=_.dragMove,_.mouseup=_.dragEnd,_.contextmenu=i=>{i.preventDefault()}};class Uf{constructor(i,l){this._clickTolerance=i.clickTolerance||1,this._map=l,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new o.P(0,0)}_shouldBePrevented(i){return i<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(i,l,f){return this._calculateTransform(i,l,f)}touchmove(i,l,f){if(this._active){if(!this._shouldBePrevented(f.length))return i.preventDefault(),this._calculateTransform(i,l,f);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",i)}}touchend(i,l,f){this._calculateTransform(i,l,f),this._active&&this._shouldBePrevented(f.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(i,l,f){f.length>0&&(this._active=!0);const g=ml(f,l),y=new o.P(0,0),x=new o.P(0,0);let S=0;for(const M in g){const k=g[M],B=this._touches[M];B&&(y._add(k),x._add(k.sub(B)),S++,g[M]=k)}if(this._touches=g,this._shouldBePrevented(S)||!x.mag())return;const I=x.div(S);return this._sum._add(I),this._sum.mag()<this._clickTolerance?void 0:{around:y.div(S),panDelta:I}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Zc{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(i,l,f){this._firstTwoTouches||f.length<2||(this._firstTwoTouches=[f[0].identifier,f[1].identifier],this._start([l[0],l[1]]))}touchmove(i,l,f){if(!this._firstTwoTouches)return;i.preventDefault();const[g,y]=this._firstTwoTouches,x=la(f,l,g),S=la(f,l,y);if(!x||!S)return;const I=this._aroundCenter?null:x.add(S).div(2);return this._move([x,S],I,i)}touchend(i,l,f){if(!this._firstTwoTouches)return;const[g,y]=this._firstTwoTouches,x=la(f,l,g),S=la(f,l,y);x&&S||(this._active&&V.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(i){this._enabled=!0,this._aroundCenter=!!i&&i.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function la(_,i,l){for(let f=0;f<_.length;f++)if(_[f].identifier===l)return i[f]}function _o(_,i){return Math.log(_/i)/Math.LN2}class Rn extends Zc{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(i){this._startDistance=this._distance=i[0].dist(i[1])}_move(i,l){const f=this._distance;if(this._distance=i[0].dist(i[1]),this._active||!(Math.abs(_o(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:_o(this._distance,f),pinchAround:l}}}function ht(_,i){return 180*_.angleWith(i)/Math.PI}class Xc extends Zc{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(i){this._startVector=this._vector=i[0].sub(i[1]),this._minDiameter=i[0].dist(i[1])}_move(i,l,f){const g=this._vector;if(this._vector=i[0].sub(i[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:ht(this._vector,g),pinchAround:l}}_isBelowThreshold(i){this._minDiameter=Math.min(this._minDiameter,i.mag());const l=25/(Math.PI*this._minDiameter)*360,f=ht(i,this._startVector);return Math.abs(f)<l}}function ca(_){return Math.abs(_.y)>Math.abs(_.x)}class qc extends Zc{constructor(i){super(),this._currentTouchCount=0,this._map=i}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(i,l,f){super.touchstart(i,l,f),this._currentTouchCount=f.length}_start(i){this._lastPoints=i,ca(i[0].sub(i[1]))&&(this._valid=!1)}_move(i,l,f){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const g=i[0].sub(this._lastPoints[0]),y=i[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(g,y,f.timeStamp),this._valid?(this._lastPoints=i,this._active=!0,{pitchDelta:(g.y+y.y)/2*-.5}):void 0}gestureBeginsVertically(i,l,f){if(this._valid!==void 0)return this._valid;const g=i.mag()>=2,y=l.mag()>=2;if(!g&&!y)return;if(!g||!y)return this._firstMove===void 0&&(this._firstMove=f),f-this._firstMove<100&&void 0;const x=i.y>0==l.y>0;return ca(i)&&ca(l)&&x}}const ha={panStep:100,bearingStep:15,pitchStep:10};class yo{constructor(i){this._tr=new po(i);const l=ha;this._panStep=l.panStep,this._bearingStep=l.bearingStep,this._pitchStep=l.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(i){if(i.altKey||i.ctrlKey||i.metaKey)return;let l=0,f=0,g=0,y=0,x=0;switch(i.keyCode){case 61:case 107:case 171:case 187:l=1;break;case 189:case 109:case 173:l=-1;break;case 37:i.shiftKey?f=-1:(i.preventDefault(),y=-1);break;case 39:i.shiftKey?f=1:(i.preventDefault(),y=1);break;case 38:i.shiftKey?g=1:(i.preventDefault(),x=-1);break;case 40:i.shiftKey?g=-1:(i.preventDefault(),x=1);break;default:return}return this._rotationDisabled&&(f=0,g=0),{cameraAnimation:S=>{const I=this._tr;S.easeTo({duration:300,easeId:"keyboardHandler",easing:Yc,zoom:l?Math.round(I.zoom)+l*(i.shiftKey?2:1):I.zoom,bearing:I.bearing+f*this._bearingStep,pitch:I.pitch+g*this._pitchStep,offset:[-y*this._panStep,-x*this._panStep],center:I.center},{originalEvent:i})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Yc(_){return _*(2-_)}const Yt=4.000244140625,Gc=1/450;class $u{constructor(i,l){this._onTimeout=f=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(f)},this._map=i,this._tr=new po(i),this._triggerRenderFrame=l,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Gc}setZoomRate(i){this._defaultZoomRate=i}setWheelZoomRate(i){this._wheelZoomRate=i}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(i){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!i&&i.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(i){return!!this._map.cooperativeGestures.isEnabled()&&!(i.ctrlKey||this._map.cooperativeGestures.isBypassed(i))}wheel(i){if(!this.isEnabled())return;if(this._shouldBePrevented(i))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",i);let l=i.deltaMode===WheelEvent.DOM_DELTA_LINE?40*i.deltaY:i.deltaY;const f=$.now(),g=f-(this._lastWheelEventTime||0);this._lastWheelEventTime=f,l!==0&&l%Yt==0?this._type="wheel":l!==0&&Math.abs(l)<4?this._type="trackpad":g>400?(this._type=null,this._lastValue=l,this._timeout=setTimeout(this._onTimeout,40,i)):this._type||(this._type=Math.abs(g*l)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,l+=this._lastValue)),i.shiftKey&&l&&(l/=4),this._type&&(this._lastWheelEvent=i,this._delta-=l,this._active||this._start(i)),i.preventDefault()}_start(i){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const l=V.mousePos(this._map.getCanvas(),i),f=this._tr;this._aroundPoint=this._aroundCenter?f.transform.locationToScreenPoint(o.S.convert(f.center)):l,this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const i=this._tr.transform;if(typeof this._lastExpectedZoom=="number"){const S=i.zoom-this._lastExpectedZoom;typeof this._startZoom=="number"&&(this._startZoom+=S),typeof this._targetZoom=="number"&&(this._targetZoom+=S)}if(this._delta!==0){const S=this._type==="wheel"&&Math.abs(this._delta)>Yt?this._wheelZoomRate:this._defaultZoomRate;let I=2/(1+Math.exp(-Math.abs(this._delta*S)));this._delta<0&&I!==0&&(I=1/I);const M=typeof this._targetZoom!="number"?i.scale:o.ae(this._targetZoom);this._targetZoom=i.getConstrained(i.getCameraLngLat(),o.aj(M*I)).zoom,this._type==="wheel"&&(this._startZoom=i.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const l=typeof this._targetZoom!="number"?i.zoom:this._targetZoom,f=this._startZoom,g=this._easing;let y,x=!1;if(this._type==="wheel"&&f&&g){const S=$.now()-this._lastWheelEventTime,I=Math.min((S+5)/200,1),M=g(I);y=o.C.number(f,l,M),I<1?this._frameId||(this._frameId=!0):x=!0}else y=l,x=!0;return this._active=!0,x&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._lastExpectedZoom,delete this._finishTimeout},200)),this._lastExpectedZoom=y,{noInertia:!0,needsRenderFrame:!x,zoomDelta:y-i.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(i){let l=o.cn;if(this._prevEase){const f=this._prevEase,g=($.now()-f.start)/f.duration,y=f.easing(g+.01)-f.easing(g),x=.27/Math.sqrt(y*y+1e-4)*.01,S=Math.sqrt(.0729-x*x);l=o.cl(x,S,.25,1)}return this._prevEase={start:$.now(),duration:i,easing:l},l}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,delete this._lastExpectedZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class vl{constructor(i,l){this._clickZoom=i,this._tapZoom=l}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Vf{constructor(i){this._tr=new po(i),this.reset()}reset(){this._active=!1}dblclick(i,l){return i.preventDefault(),{cameraAnimation:f=>{f.easeTo({duration:300,zoom:this._tr.zoom+(i.shiftKey?-1:1),around:this._tr.unproject(l)},{originalEvent:i})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class jf{constructor(){this._tap=new _l({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(i,l,f){if(!this._swipePoint)if(this._tapTime){const g=l[0],y=i.timeStamp-this._tapTime<500,x=this._tapPoint.dist(g)<30;y&&x?f.length>0&&(this._swipePoint=g,this._swipeTouch=f[0].identifier):this.reset()}else this._tap.touchstart(i,l,f)}touchmove(i,l,f){if(this._tapTime){if(this._swipePoint){if(f[0].identifier!==this._swipeTouch)return;const g=l[0],y=g.y-this._swipePoint.y;return this._swipePoint=g,i.preventDefault(),this._active=!0,{zoomDelta:y/128}}}else this._tap.touchmove(i,l,f)}touchend(i,l,f){if(this._tapTime)this._swipePoint&&f.length===0&&this.reset();else{const g=this._tap.touchend(i,l,f);g&&(this._tapTime=i.timeStamp,this._tapPoint=g)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Kc{constructor(i,l,f){this._el=i,this._mousePan=l,this._touchPan=f}enable(i){this._inertiaOptions=i||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class xl{constructor(i,l,f,g){this._pitchWithRotate=i.pitchWithRotate,this._rollEnabled=i.rollEnabled,this._mouseRotate=l,this._mousePitch=f,this._mouseRoll=g}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable(),this._rollEnabled&&this._mouseRoll.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable(),this._mouseRoll.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())&&(!this._rollEnabled||this._mouseRoll.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()||this._mouseRoll.isActive()}}class Jc{constructor(i,l,f,g){this._el=i,this._touchZoom=l,this._touchRotate=f,this._tapDragZoom=g,this._rotationDisabled=!1,this._enabled=!0}enable(i){this._touchZoom.enable(i),this._rotationDisabled||this._touchRotate.enable(i),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class Wu{constructor(i,l){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=i,this._options=l,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const i=this._map.getCanvasContainer();i.classList.add("maplibregl-cooperative-gestures"),this._container=V.create("div","maplibregl-cooperative-gesture-screen",i);let l=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(l=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const f=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),g=document.createElement("div");g.className="maplibregl-desktop-message",g.textContent=l,this._container.appendChild(g);const y=document.createElement("div");y.className="maplibregl-mobile-message",y.textContent=f,this._container.appendChild(y),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(V.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(i){return i[this._bypassKey]}notifyGestureBlocked(i,l){this._enabled&&(this._map.fire(new o.l("cooperativegestureprevented",{gestureType:i,originalEvent:l})),this._container.classList.add("maplibregl-show"),setTimeout(()=>{this._container.classList.remove("maplibregl-show")},100))}}const ua=_=>_.zoom||_.drag||_.roll||_.pitch||_.rotate;class $f extends o.l{}function Qc(_){return _.panDelta&&_.panDelta.mag()||_.zoomDelta||_.bearingDelta||_.pitchDelta||_.rollDelta}class cs{constructor(i,l){this.handleWindowEvent=g=>{this.handleEvent(g,`${g.type}Window`)},this.handleEvent=(g,y)=>{if(g.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const x=g.type==="renderFrame"?void 0:g,S={needsRenderFrame:!1},I={},M={};for(const{handlerName:F,handler:N,allowed:W}of this._handlers){if(!N.isEnabled())continue;let J;if(this._blockedByActive(M,W,F))N.reset();else if(N[y||g.type]){if(o.co(g,y||g.type)){const G=V.mousePos(this._map.getCanvas(),g);J=N[y||g.type](g,G)}else if(o.cp(g,y||g.type)){const G=this._getMapTouches(g.touches),Q=V.touchPos(this._map.getCanvas(),G);J=N[y||g.type](g,Q,G)}else o.cq(y||g.type)||(J=N[y||g.type](g));this.mergeHandlerResult(S,I,J,F,x),J&&J.needsRenderFrame&&this._triggerRenderFrame()}(J||N.isActive())&&(M[F]=N)}const k={};for(const F in this._previousActiveHandlers)M[F]||(k[F]=x);this._previousActiveHandlers=M,(Object.keys(k).length||Qc(S))&&(this._changes.push([S,I,k]),this._triggerRenderFrame()),(Object.keys(M).length||Qc(S))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:B}=S;B&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],B(this._map))},this._map=i,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Nu(i),this._bearingSnap=l.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(l);const f=this._el;this._listeners=[[f,"touchstart",{passive:!0}],[f,"touchmove",{passive:!1}],[f,"touchend",void 0],[f,"touchcancel",void 0],[f,"mousedown",void 0],[f,"mousemove",void 0],[f,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[f,"mouseover",void 0],[f,"mouseout",void 0],[f,"dblclick",void 0],[f,"click",void 0],[f,"keydown",{capture:!1}],[f,"keyup",void 0],[f,"wheel",{passive:!1}],[f,"contextmenu",void 0],[window,"blur",void 0]];for(const[g,y,x]of this._listeners)V.addEventListener(g,y,g===document?this.handleWindowEvent:this.handleEvent,x)}destroy(){for(const[i,l,f]of this._listeners)V.removeEventListener(i,l,i===document?this.handleWindowEvent:this.handleEvent,f)}_addDefaultHandlers(i){const l=this._map,f=l.getCanvasContainer();this._add("mapEvent",new zu(l,i));const g=l.boxZoom=new Hc(l,i);this._add("boxZoom",g),i.interactive&&i.boxZoom&&g.enable();const y=l.cooperativeGestures=new Wu(l,i.cooperativeGestures);this._add("cooperativeGestures",y),i.cooperativeGestures&&y.enable();const x=new yl(l),S=new Vf(l);l.doubleClickZoom=new vl(S,x),this._add("tapZoom",x),this._add("clickZoom",S),i.interactive&&i.doubleClickZoom&&l.doubleClickZoom.enable();const I=new jf;this._add("tapDragZoom",I);const M=l.touchPitch=new qc(l);this._add("touchPitch",M),i.interactive&&i.touchPitch&&l.touchPitch.enable(i.touchPitch);const k=()=>l.project(l.getCenter()),B=function({enable:se,clickTolerance:ue,aroundCenter:de=!0,minPixelCenterThreshold:oe=100,rotateDegreesPerPixelMoved:ye=.8},Oe){const Ce=new Vi({checkCorrectEvent:Me=>V.mouseButton(Me)===0&&Me.ctrlKey||V.mouseButton(Me)===2&&!Me.ctrlKey});return new go({clickTolerance:ue,move:(Me,Fe)=>{const nt=Oe();if(de&&Math.abs(nt.y-Me.y)>oe)return{bearingDelta:o.cm(new o.P(Me.x,Fe.y),Fe,nt)};let it=(Fe.x-Me.x)*ye;return de&&Fe.y<nt.y&&(it=-it),{bearingDelta:it}},moveStateManager:Ce,enable:se,assignEvents:bl})}(i,k),F=function({enable:se,clickTolerance:ue,pitchDegreesPerPixelMoved:de=-.5}){const oe=new Vi({checkCorrectEvent:ye=>V.mouseButton(ye)===0&&ye.ctrlKey||V.mouseButton(ye)===2});return new go({clickTolerance:ue,move:(ye,Oe)=>({pitchDelta:(Oe.y-ye.y)*de}),moveStateManager:oe,enable:se,assignEvents:bl})}(i),N=function({enable:se,clickTolerance:ue,rollDegreesPerPixelMoved:de=.3},oe){const ye=new Vi({checkCorrectEvent:Oe=>V.mouseButton(Oe)===2&&Oe.ctrlKey});return new go({clickTolerance:ue,move:(Oe,Ce)=>{const Me=oe();let Fe=(Ce.x-Oe.x)*de;return Ce.y<Me.y&&(Fe=-Fe),{rollDelta:Fe}},moveStateManager:ye,enable:se,assignEvents:bl})}(i,k);l.dragRotate=new xl(i,B,F,N),this._add("mouseRotate",B,["mousePitch"]),this._add("mousePitch",F,["mouseRotate","mouseRoll"]),this._add("mouseRoll",N,["mousePitch"]),i.interactive&&i.dragRotate&&l.dragRotate.enable();const W=function({enable:se,clickTolerance:ue}){const de=new Vi({checkCorrectEvent:oe=>V.mouseButton(oe)===0&&!oe.ctrlKey});return new go({clickTolerance:ue,move:(oe,ye)=>({around:ye,panDelta:ye.sub(oe)}),activateOnStart:!0,moveStateManager:de,enable:se,assignEvents:bl})}(i),J=new Uf(i,l);l.dragPan=new Kc(f,W,J),this._add("mousePan",W),this._add("touchPan",J,["touchZoom","touchRotate"]),i.interactive&&i.dragPan&&l.dragPan.enable(i.dragPan);const G=new Xc,Q=new Rn;l.touchZoomRotate=new Jc(f,Q,G,I),this._add("touchRotate",G,["touchPan","touchZoom"]),this._add("touchZoom",Q,["touchPan","touchRotate"]),i.interactive&&i.touchZoomRotate&&l.touchZoomRotate.enable(i.touchZoomRotate);const re=l.scrollZoom=new $u(l,()=>this._triggerRenderFrame());this._add("scrollZoom",re,["mousePan"]),i.interactive&&i.scrollZoom&&l.scrollZoom.enable(i.scrollZoom);const ae=l.keyboard=new yo(l);this._add("keyboard",ae),i.interactive&&i.keyboard&&l.keyboard.enable(),this._add("blockableMapEvent",new Uu(l))}_add(i,l,f){this._handlers.push({handlerName:i,handler:l,allowed:f}),this._handlersById[i]=l}stop(i){if(!this._updatingCamera){for(const{handler:l}of this._handlers)l.reset();this._inertia.clear(),this._fireEvents({},{},i),this._changes=[]}}isActive(){for(const{handler:i}of this._handlers)if(i.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!ua(this._eventsInProgress)||this.isZooming()}_blockedByActive(i,l,f){for(const g in i)if(g!==f&&(!l||l.indexOf(g)<0))return!0;return!1}_getMapTouches(i){const l=[];for(const f of i)this._el.contains(f.target)&&l.push(f);return l}mergeHandlerResult(i,l,f,g,y){if(!f)return;o.e(i,f);const x={handlerName:g,originalEvent:f.originalEvent||y};f.zoomDelta!==void 0&&(l.zoom=x),f.panDelta!==void 0&&(l.drag=x),f.rollDelta!==void 0&&(l.roll=x),f.pitchDelta!==void 0&&(l.pitch=x),f.bearingDelta!==void 0&&(l.rotate=x)}_applyChanges(){const i={},l={},f={};for(const[g,y,x]of this._changes)g.panDelta&&(i.panDelta=(i.panDelta||new o.P(0,0))._add(g.panDelta)),g.zoomDelta&&(i.zoomDelta=(i.zoomDelta||0)+g.zoomDelta),g.bearingDelta&&(i.bearingDelta=(i.bearingDelta||0)+g.bearingDelta),g.pitchDelta&&(i.pitchDelta=(i.pitchDelta||0)+g.pitchDelta),g.rollDelta&&(i.rollDelta=(i.rollDelta||0)+g.rollDelta),g.around!==void 0&&(i.around=g.around),g.pinchAround!==void 0&&(i.pinchAround=g.pinchAround),g.noInertia&&(i.noInertia=g.noInertia),o.e(l,y),o.e(f,x);this._updateMapTransform(i,l,f),this._changes=[]}_updateMapTransform(i,l,f){const g=this._map,y=g._getTransformForUpdate(),x=g.terrain;if(!(Qc(i)||x&&this._terrainMovement))return this._fireEvents(l,f,!0);g._stop(!0);let{panDelta:S,zoomDelta:I,bearingDelta:M,pitchDelta:k,rollDelta:B,around:F,pinchAround:N}=i;N!==void 0&&(F=N),F=F||g.transform.centerPoint,x&&!y.isPointOnMapSurface(F)&&(F=y.centerPoint);const W={panDelta:S,zoomDelta:I,rollDelta:B,pitchDelta:k,bearingDelta:M,around:F};this._map.cameraHelper.useGlobeControls&&!y.isPointOnMapSurface(F)&&(F=y.centerPoint);const J=F.distSqr(y.centerPoint)<.01?y.center:y.screenPointToLocation(S?F.sub(S):F);x?(this._map.cameraHelper.handleMapControlsRollPitchBearingZoom(W,y),this._terrainMovement||!l.drag&&!l.zoom?l.drag&&this._terrainMovement?y.setCenter(y.screenPointToLocation(y.centerPoint.sub(S))):this._map.cameraHelper.handleMapControlsPan(W,y,J):(this._terrainMovement=!0,this._map._elevationFreeze=!0,this._map.cameraHelper.handleMapControlsPan(W,y,J))):(this._map.cameraHelper.handleMapControlsRollPitchBearingZoom(W,y),this._map.cameraHelper.handleMapControlsPan(W,y,J)),g._applyUpdatedTransform(y),this._map._update(),i.noInertia||this._inertia.record(i),this._fireEvents(l,f,!0)}_fireEvents(i,l,f){const g=ua(this._eventsInProgress),y=ua(i),x={};for(const B in i){const{originalEvent:F}=i[B];this._eventsInProgress[B]||(x[`${B}start`]=F),this._eventsInProgress[B]=i[B]}!g&&y&&this._fireEvent("movestart",y.originalEvent);for(const B in x)this._fireEvent(B,x[B]);y&&this._fireEvent("move",y.originalEvent);for(const B in i){const{originalEvent:F}=i[B];this._fireEvent(B,F)}const S={};let I;for(const B in this._eventsInProgress){const{handlerName:F,originalEvent:N}=this._eventsInProgress[B];this._handlersById[F].isActive()||(delete this._eventsInProgress[B],I=l[F]||N,S[`${B}end`]=I)}for(const B in S)this._fireEvent(B,S[B]);const M=ua(this._eventsInProgress),k=(g||y)&&!M;if(k&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;const B=this._map._getTransformForUpdate();this._map.getCenterClampedToGround()&&B.recalculateZoomAndCenter(this._map.terrain),this._map._applyUpdatedTransform(B)}if(f&&k){this._updatingCamera=!0;const B=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),F=N=>N!==0&&-this._bearingSnap<N&&N<this._bearingSnap;!B||!B.essential&&$.prefersReducedMotion?(this._map.fire(new o.l("moveend",{originalEvent:I})),F(this._map.getBearing())&&this._map.resetNorth()):(F(B.bearing||this._map.getBearing())&&(B.bearing=0),B.freezeElevation=!0,this._map.easeTo(B,{originalEvent:I})),this._updatingCamera=!1}}_fireEvent(i,l){this._map.fire(new o.l(i,l?{originalEvent:l}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(i=>{delete this._frameId,this.handleEvent(new $f("renderFrame",{timeStamp:i})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class Rr extends o.E{constructor(i,l,f){super(),this._renderFrameCallback=()=>{const g=Math.min(($.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(g)),g<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=i,this._bearingSnap=f.bearingSnap,this.cameraHelper=l,this.on("moveend",()=>{delete this._requestedCameraState})}migrateProjection(i,l){i.apply(this.transform),this.transform=i,this.cameraHelper=l}getCenter(){return new o.S(this.transform.center.lng,this.transform.center.lat)}setCenter(i,l){return this.jumpTo({center:i},l)}getCenterElevation(){return this.transform.elevation}setCenterElevation(i,l){return this.jumpTo({elevation:i},l),this}getCenterClampedToGround(){return this._centerClampedToGround}setCenterClampedToGround(i){this._centerClampedToGround=i}panBy(i,l,f){return i=o.P.convert(i).mult(-1),this.panTo(this.transform.center,o.e({offset:i},l),f)}panTo(i,l,f){return this.easeTo(o.e({center:i},l),f)}getZoom(){return this.transform.zoom}setZoom(i,l){return this.jumpTo({zoom:i},l),this}zoomTo(i,l,f){return this.easeTo(o.e({zoom:i},l),f)}zoomIn(i,l){return this.zoomTo(this.getZoom()+1,i,l),this}zoomOut(i,l){return this.zoomTo(this.getZoom()-1,i,l),this}getVerticalFieldOfView(){return this.transform.fov}setVerticalFieldOfView(i,l){return i!=this.transform.fov&&(this.transform.setFov(i),this.fire(new o.l("movestart",l)).fire(new o.l("move",l)).fire(new o.l("moveend",l))),this}getBearing(){return this.transform.bearing}setBearing(i,l){return this.jumpTo({bearing:i},l),this}getPadding(){return this.transform.padding}setPadding(i,l){return this.jumpTo({padding:i},l),this}rotateTo(i,l,f){return this.easeTo(o.e({bearing:i},l),f)}resetNorth(i,l){return this.rotateTo(0,o.e({duration:1e3},i),l),this}resetNorthPitch(i,l){return this.easeTo(o.e({bearing:0,pitch:0,roll:0,duration:1e3},i),l),this}snapToNorth(i,l){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(i,l):this}getPitch(){return this.transform.pitch}setPitch(i,l){return this.jumpTo({pitch:i},l),this}getRoll(){return this.transform.roll}setRoll(i,l){return this.jumpTo({roll:i},l),this}cameraForBounds(i,l){i=zt.convert(i).adjustAntiMeridian();const f=l&&l.bearing||0;return this._cameraForBoxAndBearing(i.getNorthWest(),i.getSouthEast(),f,l)}_cameraForBoxAndBearing(i,l,f,g){const y={top:0,bottom:0,right:0,left:0};if(typeof(g=o.e({padding:y,offset:[0,0],maxZoom:this.transform.maxZoom},g)).padding=="number"){const M=g.padding;g.padding={top:M,bottom:M,right:M,left:M}}const x=o.e(y,g.padding);g.padding=x;const S=this.transform,I=new zt(i,l);return this.cameraHelper.cameraForBoxAndBearing(g,x,I,f,S)}fitBounds(i,l,f){return this._fitInternal(this.cameraForBounds(i,l),l,f)}fitScreenCoordinates(i,l,f,g,y){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.screenPointToLocation(o.P.convert(i)),this.transform.screenPointToLocation(o.P.convert(l)),f,g),g,y)}_fitInternal(i,l,f){return i?(delete(l=o.e(i,l)).padding,l.linear?this.easeTo(l,f):this.flyTo(l,f)):this}jumpTo(i,l){this.stop();const f=this._getTransformForUpdate();let g=!1,y=!1,x=!1;const S=f.zoom;this.cameraHelper.handleJumpToCenterZoom(f,i);const I=f.zoom!==S;return"elevation"in i&&f.elevation!==+i.elevation&&f.setElevation(+i.elevation),"bearing"in i&&f.bearing!==+i.bearing&&(g=!0,f.setBearing(+i.bearing)),"pitch"in i&&f.pitch!==+i.pitch&&(y=!0,f.setPitch(+i.pitch)),"roll"in i&&f.roll!==+i.roll&&(x=!0,f.setRoll(+i.roll)),i.padding==null||f.isPaddingEqual(i.padding)||f.setPadding(i.padding),this._applyUpdatedTransform(f),this.fire(new o.l("movestart",l)).fire(new o.l("move",l)),I&&this.fire(new o.l("zoomstart",l)).fire(new o.l("zoom",l)).fire(new o.l("zoomend",l)),g&&this.fire(new o.l("rotatestart",l)).fire(new o.l("rotate",l)).fire(new o.l("rotateend",l)),y&&this.fire(new o.l("pitchstart",l)).fire(new o.l("pitch",l)).fire(new o.l("pitchend",l)),x&&this.fire(new o.l("rollstart",l)).fire(new o.l("roll",l)).fire(new o.l("rollend",l)),this.fire(new o.l("moveend",l))}calculateCameraOptionsFromTo(i,l,f,g=0){const y=o.a0.fromLngLat(i,l),x=o.a0.fromLngLat(f,g),S=x.x-y.x,I=x.y-y.y,M=x.z-y.z,k=Math.hypot(S,I,M);if(k===0)throw new Error("Can't calculate camera options with same From and To");const B=Math.hypot(S,I),F=o.aj(this.transform.cameraToCenterDistance/k/this.transform.tileSize),N=180*Math.atan2(S,-I)/Math.PI;let W=180*Math.acos(B/k)/Math.PI;return W=M<0?90-W:90+W,{center:x.toLngLat(),elevation:g,zoom:F,pitch:W,bearing:N}}calculateCameraOptionsFromCameraLngLatAltRotation(i,l,f,g,y){const x=this.transform.calculateCenterFromCameraLngLatAlt(i,l,f,g);return{center:x.center,elevation:x.elevation,zoom:x.zoom,bearing:f,pitch:g,roll:y}}easeTo(i,l){this._stop(!1,i.easeId),((i=o.e({offset:[0,0],duration:500,easing:o.cn},i)).animate===!1||!i.essential&&$.prefersReducedMotion)&&(i.duration=0);const f=this._getTransformForUpdate(),g=this.getBearing(),y=f.pitch,x=f.roll,S="bearing"in i?this._normalizeBearing(i.bearing,g):g,I="pitch"in i?+i.pitch:y,M="roll"in i?this._normalizeBearing(i.roll,x):x,k="padding"in i?i.padding:f.padding,B=o.P.convert(i.offset);let F,N;i.around&&(F=o.S.convert(i.around),N=f.locationToScreenPoint(F));const W={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching,rolling:this._rolling},J=this.cameraHelper.handleEaseTo(f,{bearing:S,pitch:I,roll:M,padding:k,around:F,aroundPoint:N,offsetAsPoint:B,offset:i.offset,zoom:i.zoom,center:i.center});return this._rotating=this._rotating||g!==S,this._pitching=this._pitching||I!==y,this._rolling=this._rolling||M!==x,this._padding=!f.isPaddingEqual(k),this._zooming=this._zooming||J.isZooming,this._easeId=i.easeId,this._prepareEase(l,i.noMoveStart,W),this.terrain&&this._prepareElevation(J.elevationCenter),this._ease(G=>{J.easeFunc(G),this.terrain&&!i.freezeElevation&&this._updateElevation(G),this._applyUpdatedTransform(f),this._fireMoveEvents(l)},G=>{this.terrain&&i.freezeElevation&&this._finalizeElevation(),this._afterEase(l,G)},i),this}_prepareEase(i,l,f={}){this._moving=!0,l||f.moving||this.fire(new o.l("movestart",i)),this._zooming&&!f.zooming&&this.fire(new o.l("zoomstart",i)),this._rotating&&!f.rotating&&this.fire(new o.l("rotatestart",i)),this._pitching&&!f.pitching&&this.fire(new o.l("pitchstart",i)),this._rolling&&!f.rolling&&this.fire(new o.l("rollstart",i))}_prepareElevation(i){this._elevationCenter=i,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(i,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(i){this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom));const l=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(i<1&&l!==this._elevationTarget){const f=this._elevationTarget-this._elevationStart;this._elevationStart+=i*(f-(l-(f*i+this._elevationStart))/(1-i)),this._elevationTarget=l}this.transform.setElevation(o.C.number(this._elevationStart,this._elevationTarget,i))}_finalizeElevation(){this._elevationFreeze=!1,this.getCenterClampedToGround()&&this.transform.recalculateZoomAndCenter(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(i){if(!this.terrain&&i.elevation>=0&&i.pitch<=90)return{};const l=i.getCameraLngLat(),f=i.getCameraAltitude(),g=this.terrain?this.terrain.getElevationForLngLatZoom(l,i.zoom):0;if(f<g){const y=this.calculateCameraOptionsFromTo(l,g,i.center,i.elevation);return{pitch:y.pitch,zoom:y.zoom}}return{}}_applyUpdatedTransform(i){const l=[];if(l.push(g=>this._elevateCameraIfInsideTerrain(g)),this.transformCameraUpdate&&l.push(g=>this.transformCameraUpdate(g)),!l.length)return;const f=i.clone();for(const g of l){const y=f.clone(),{center:x,zoom:S,roll:I,pitch:M,bearing:k,elevation:B}=g(y);x&&y.setCenter(x),B!==void 0&&y.setElevation(B),S!==void 0&&y.setZoom(S),I!==void 0&&y.setRoll(I),M!==void 0&&y.setPitch(M),k!==void 0&&y.setBearing(k),f.apply(y)}this.transform.apply(f)}_fireMoveEvents(i){this.fire(new o.l("move",i)),this._zooming&&this.fire(new o.l("zoom",i)),this._rotating&&this.fire(new o.l("rotate",i)),this._pitching&&this.fire(new o.l("pitch",i)),this._rolling&&this.fire(new o.l("roll",i))}_afterEase(i,l){if(this._easeId&&l&&this._easeId===l)return;delete this._easeId;const f=this._zooming,g=this._rotating,y=this._pitching,x=this._rolling;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._rolling=!1,this._padding=!1,f&&this.fire(new o.l("zoomend",i)),g&&this.fire(new o.l("rotateend",i)),y&&this.fire(new o.l("pitchend",i)),x&&this.fire(new o.l("rollend",i)),this.fire(new o.l("moveend",i))}flyTo(i,l){if(!i.essential&&$.prefersReducedMotion){const Fe=o.Q(i,["center","zoom","bearing","pitch","roll","elevation"]);return this.jumpTo(Fe,l)}this.stop(),i=o.e({offset:[0,0],speed:1.2,curve:1.42,easing:o.cn},i);const f=this._getTransformForUpdate(),g=f.bearing,y=f.pitch,x=f.roll,S=f.padding,I="bearing"in i?this._normalizeBearing(i.bearing,g):g,M="pitch"in i?+i.pitch:y,k="roll"in i?this._normalizeBearing(i.roll,x):x,B="padding"in i?i.padding:f.padding,F=o.P.convert(i.offset);let N=f.centerPoint.add(F);const W=f.screenPointToLocation(N),J=this.cameraHelper.handleFlyTo(f,{bearing:I,pitch:M,roll:k,padding:B,locationAtOffset:W,offsetAsPoint:F,center:i.center,minZoom:i.minZoom,zoom:i.zoom});let G=i.curve;const Q=Math.max(f.width,f.height),re=Q/J.scaleOfZoom,ae=J.pixelPathLength;typeof J.scaleOfMinZoom=="number"&&(G=Math.sqrt(Q/J.scaleOfMinZoom/ae*2));const se=G*G;function ue(Fe){const nt=(re*re-Q*Q+(Fe?-1:1)*se*se*ae*ae)/(2*(Fe?re:Q)*se*ae);return Math.log(Math.sqrt(nt*nt+1)-nt)}function de(Fe){return(Math.exp(Fe)-Math.exp(-Fe))/2}function oe(Fe){return(Math.exp(Fe)+Math.exp(-Fe))/2}const ye=ue(!1);let Oe=function(Fe){return oe(ye)/oe(ye+G*Fe)},Ce=function(Fe){return Q*((oe(ye)*(de(nt=ye+G*Fe)/oe(nt))-de(ye))/se)/ae;var nt},Me=(ue(!0)-ye)/G;if(Math.abs(ae)<2e-6||!isFinite(Me)){if(Math.abs(Q-re)<1e-6)return this.easeTo(i,l);const Fe=re<Q?-1:1;Me=Math.abs(Math.log(re/Q))/G,Ce=()=>0,Oe=nt=>Math.exp(Fe*G*nt)}return i.duration="duration"in i?+i.duration:1e3*Me/("screenSpeed"in i?+i.screenSpeed/G:+i.speed),i.maxDuration&&i.duration>i.maxDuration&&(i.duration=0),this._zooming=!0,this._rotating=g!==I,this._pitching=M!==y,this._rolling=k!==x,this._padding=!f.isPaddingEqual(B),this._prepareEase(l,!1),this.terrain&&this._prepareElevation(J.targetCenter),this._ease(Fe=>{const nt=Fe*Me,it=1/Oe(nt),qe=Ce(nt);this._rotating&&f.setBearing(o.C.number(g,I,Fe)),this._pitching&&f.setPitch(o.C.number(y,M,Fe)),this._rolling&&f.setRoll(o.C.number(x,k,Fe)),this._padding&&(f.interpolatePadding(S,B,Fe),N=f.centerPoint.add(F)),J.easeFunc(Fe,it,qe,N),this.terrain&&!i.freezeElevation&&this._updateElevation(Fe),this._applyUpdatedTransform(f),this._fireMoveEvents(l)},()=>{this.terrain&&i.freezeElevation&&this._finalizeElevation(),this._afterEase(l)},i),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(i,l){var f;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const g=this._onEaseEnd;delete this._onEaseEnd,g.call(this,l)}return i||(f=this.handlers)===null||f===void 0||f.stop(!1),this}_ease(i,l,f){f.animate===!1||f.duration===0?(i(1),l()):(this._easeStart=$.now(),this._easeOptions=f,this._onEaseFrame=i,this._onEaseEnd=l,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(i,l){i=o.aN(i,-180,180);const f=Math.abs(i-l);return Math.abs(i-360-l)<f&&(i-=360),Math.abs(i+360-l)<f&&(i+=360),i}queryTerrainElevation(i){return this.terrain?this.terrain.getElevationForLngLatZoom(o.S.convert(i),this.transform.tileZoom):null}}const da={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class wl{constructor(i=da){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=l=>{!l||l.sourceDataType!=="metadata"&&l.sourceDataType!=="visibility"&&l.dataType!=="style"&&l.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=i}getDefaultPosition(){return"bottom-right"}onAdd(i){return this._map=i,this._compact=this.options.compact,this._container=V.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=V.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=V.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){V.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(i,l){const f=this._map._getUIString(`AttributionControl.${l}`);i.title=f,i.setAttribute("aria-label",f)}_updateAttributions(){if(!this._map.style)return;let i=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?i=i.concat(this.options.customAttribution.map(g=>typeof g!="string"?"":g)):typeof this.options.customAttribution=="string"&&i.push(this.options.customAttribution)),this._map.style.stylesheet){const g=this._map.style.stylesheet;this.styleOwner=g.owner,this.styleId=g.id}const l=this._map.style.sourceCaches;for(const g in l){const y=l[g];if(y.used||y.usedForTerrain){const x=y.getSource();x.attribution&&i.indexOf(x.attribution)<0&&i.push(x.attribution)}}i=i.filter(g=>String(g).trim()),i.sort((g,y)=>g.length-y.length),i=i.filter((g,y)=>{for(let x=y+1;x<i.length;x++)if(i[x].indexOf(g)>=0)return!1;return!0});const f=i.join(" | ");f!==this._attribHTML&&(this._attribHTML=f,i.length?(this._innerContainer.innerHTML=V.sanitize(f),this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class eh{constructor(i={}){this._updateCompact=()=>{const l=this._container.children;if(l.length){const f=l[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&f.classList.add("maplibregl-compact"):f.classList.remove("maplibregl-compact")}},this.options=i}getDefaultPosition(){return"bottom-left"}onAdd(i){this._map=i,this._compact=this.options&&this.options.compact,this._container=V.create("div","maplibregl-ctrl");const l=V.create("a","maplibregl-ctrl-logo");return l.target="_blank",l.rel="noopener nofollow",l.href="https://maplibre.org/",l.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),l.setAttribute("rel","noopener nofollow"),this._container.appendChild(l),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){V.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class Hu{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(i){const l=++this._id;return this._queue.push({callback:i,id:l,cancelled:!1}),l}remove(i){const l=this._currentlyRunning,f=l?this._queue.concat(l):this._queue;for(const g of f)if(g.id===i)return void(g.cancelled=!0)}run(i=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const l=this._currentlyRunning=this._queue;this._queue=[];for(const f of l)if(!f.cancelled&&(f.callback(i),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var Zu=o.aI([{name:"a_pos3d",type:"Int16",components:3}]);class Wf extends o.E{constructor(i){super(),this._lastTilesetChange=$.now(),this.sourceCache=i,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.deltaZoom=1,this.tileSize=i._source.tileSize*2**this.deltaZoom,i.usedForTerrain=!0,i.tileSize=this.tileSize}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(i,l){this.sourceCache.update(i,l),this._renderableTilesKeys=[];const f={};for(const g of Ne(i,{tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:l,calculateTileZoom:this.sourceCache._source.calculateTileZoom}))f[g.key]=!0,this._renderableTilesKeys.push(g.key),this._tiles[g.key]||(g.terrainRttPosMatrix32f=new Float64Array(16),o.bX(g.terrainRttPosMatrix32f,0,o.$,o.$,0,0,1),this._tiles[g.key]=new Yr(g,this.tileSize),this._lastTilesetChange=$.now());for(const g in this._tiles)f[g]||delete this._tiles[g]}freeRtt(i){for(const l in this._tiles){const f=this._tiles[l];(!i||f.tileID.equals(i)||f.tileID.isChildOf(i)||i.isChildOf(f.tileID))&&(f.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map(i=>this.getTileByID(i))}getTileByID(i){return this._tiles[i]}getTerrainCoords(i,l){return l?this._getTerrainCoordsForTileRanges(i,l):this._getTerrainCoordsForRegularTile(i)}_getTerrainCoordsForRegularTile(i){const l={};for(const f of this._renderableTilesKeys){const g=this._tiles[f].tileID,y=i.clone(),x=o.b9();if(g.canonical.equals(i.canonical))o.bX(x,0,o.$,o.$,0,0,1);else if(g.canonical.isChildOf(i.canonical)){const S=g.canonical.z-i.canonical.z,I=g.canonical.x-(g.canonical.x>>S<<S),M=g.canonical.y-(g.canonical.y>>S<<S),k=o.$>>S;o.bX(x,0,k,k,0,0,1),o.M(x,x,[-I*k,-M*k,0])}else{if(!i.canonical.isChildOf(g.canonical))continue;{const S=i.canonical.z-g.canonical.z,I=i.canonical.x-(i.canonical.x>>S<<S),M=i.canonical.y-(i.canonical.y>>S<<S),k=o.$>>S;o.bX(x,0,o.$,o.$,0,0,1),o.M(x,x,[I*k,M*k,0]),o.N(x,x,[1/2**S,1/2**S,0])}}y.terrainRttPosMatrix32f=new Float32Array(x),l[f]=y}return l}_getTerrainCoordsForTileRanges(i,l){const f={};for(const g of this._renderableTilesKeys){const y=this._tiles[g].tileID;if(!this._isWithinTileRanges(y,l))continue;const x=i.clone(),S=o.b9();if(y.canonical.z===i.canonical.z){const I=i.canonical.x-y.canonical.x,M=i.canonical.y-y.canonical.y;o.bX(S,0,o.$,o.$,0,0,1),o.M(S,S,[I*o.$,M*o.$,0])}else if(y.canonical.z>i.canonical.z){const I=y.canonical.z-i.canonical.z,M=y.canonical.x-(y.canonical.x>>I<<I),k=y.canonical.y-(y.canonical.y>>I<<I),B=i.canonical.x-(y.canonical.x>>I),F=i.canonical.y-(y.canonical.y>>I),N=o.$>>I;o.bX(S,0,N,N,0,0,1),o.M(S,S,[-M*N+B*o.$,-k*N+F*o.$,0])}else{const I=i.canonical.z-y.canonical.z,M=i.canonical.x-(i.canonical.x>>I<<I),k=i.canonical.y-(i.canonical.y>>I<<I),B=(i.canonical.x>>I)-y.canonical.x,F=(i.canonical.y>>I)-y.canonical.y,N=o.$<<I;o.bX(S,0,N,N,0,0,1),o.M(S,S,[M*o.$+B*N,k*o.$+F*N,0])}x.terrainRttPosMatrix32f=new Float32Array(S),f[g]=x}return f}getSourceTile(i,l){const f=this.sourceCache._source;let g=i.overscaledZ-this.deltaZoom;if(g>f.maxzoom&&(g=f.maxzoom),g<f.minzoom)return null;this._sourceTileCache[i.key]||(this._sourceTileCache[i.key]=i.scaledTo(g).key);let y=this.sourceCache.getTileByID(this._sourceTileCache[i.key]);if((!y||!y.dem)&&l)for(;g>=f.minzoom&&(!y||!y.dem);)y=this.sourceCache.getTileByID(i.scaledTo(g--).key);return y}anyTilesAfterTime(i=Date.now()){return this._lastTilesetChange>=i}_isWithinTileRanges(i,l){return l[i.canonical.z]&&i.canonical.x>=l[i.canonical.z].minTileX&&i.canonical.x<=l[i.canonical.z].maxTileX&&i.canonical.y>=l[i.canonical.z].minTileY&&i.canonical.y<=l[i.canonical.z].maxTileY}}class kn{constructor(i,l,f){this._meshCache={},this.painter=i,this.sourceCache=new Wf(l),this.options=f,this.exaggeration=typeof f.exaggeration=="number"?f.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(i,l,f,g=o.$){var y;if(!(l>=0&&l<g&&f>=0&&f<g))return 0;const x=this.getTerrainData(i),S=(y=x.tile)===null||y===void 0?void 0:y.dem;if(!S)return 0;const I=o.cr([],[l/g*o.$,f/g*o.$],x.u_terrain_matrix),M=[I[0]*S.dim,I[1]*S.dim],k=Math.floor(M[0]),B=Math.floor(M[1]),F=M[0]-k,N=M[1]-B;return S.get(k,B)*(1-F)*(1-N)+S.get(k+1,B)*F*(1-N)+S.get(k,B+1)*(1-F)*N+S.get(k+1,B+1)*F*N}getElevationForLngLatZoom(i,l){if(!o.cs(l,i.wrap()))return 0;const{tileID:f,mercatorX:g,mercatorY:y}=this._getOverscaledTileIDFromLngLatZoom(i,l);return this.getElevation(f,g%o.$,y%o.$,o.$)}getElevation(i,l,f,g=o.$){return this.getDEMElevation(i,l,f,g)*this.exaggeration}getTerrainData(i){if(!this._emptyDemTexture){const g=this.painter.context,y=new o.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new o.T(g,y,g.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new o.T(g,new o.R({width:1,height:1}),g.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(g.gl.NEAREST,g.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=o.af([])}const l=this.sourceCache.getSourceTile(i,!0);if(l&&l.dem&&(!l.demTexture||l.needsTerrainPrepare)){const g=this.painter.context;l.demTexture=this.painter.getTileTexture(l.dem.stride),l.demTexture?l.demTexture.update(l.dem.getPixels(),{premultiply:!1}):l.demTexture=new o.T(g,l.dem.getPixels(),g.gl.RGBA,{premultiply:!1}),l.demTexture.bind(g.gl.NEAREST,g.gl.CLAMP_TO_EDGE),l.needsTerrainPrepare=!1}const f=l&&l+l.tileID.key+i.key;if(f&&!this._demMatrixCache[f]){const g=this.sourceCache.sourceCache._source.maxzoom;let y=i.canonical.z-l.tileID.canonical.z;i.overscaledZ>i.canonical.z&&(i.canonical.z>=g?y=i.canonical.z-g:o.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const x=i.canonical.x-(i.canonical.x>>y<<y),S=i.canonical.y-(i.canonical.y>>y<<y),I=o.ct(new Float64Array(16),[1/(o.$<<y),1/(o.$<<y),0]);o.M(I,I,[x*o.$,S*o.$,0]),this._demMatrixCache[i.key]={matrix:I,coord:i}}return{u_depth:2,u_terrain:3,u_terrain_dim:l&&l.dem&&l.dem.dim||1,u_terrain_matrix:f?this._demMatrixCache[i.key].matrix:this._emptyDemMatrix,u_terrain_unpack:l&&l.dem&&l.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(l&&l.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:l}}getFramebuffer(i){const l=this.painter,f=l.width/devicePixelRatio,g=l.height/devicePixelRatio;return!this._fbo||this._fbo.width===f&&this._fbo.height===g||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new o.T(l.context,{width:f,height:g,data:null},l.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(l.context.gl.NEAREST,l.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new o.T(l.context,{width:f,height:g,data:null},l.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(l.context.gl.NEAREST,l.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=l.context.createFramebuffer(f,g,!0,!1),this._fbo.depthAttachment.set(l.context.createRenderbuffer(l.context.gl.DEPTH_COMPONENT16,f,g))),this._fbo.colorAttachment.set(i==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const i=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const l=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let y=0,x=0;y<this._coordsTextureSize;y++)for(let S=0;S<this._coordsTextureSize;S++,x+=4)l[x+0]=255&S,l[x+1]=255&y,l[x+2]=S>>8<<4|y>>8,l[x+3]=0;const f=new o.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(l.buffer)),g=new o.T(i,f,i.gl.RGBA,{premultiply:!1});return g.bind(i.gl.NEAREST,i.gl.CLAMP_TO_EDGE),this._coordsTexture=g,g}pointCoordinate(i){this.painter.maybeDrawDepthAndCoords(!0);const l=new Uint8Array(4),f=this.painter.context,g=f.gl,y=Math.round(i.x*this.painter.pixelRatio/devicePixelRatio),x=Math.round(i.y*this.painter.pixelRatio/devicePixelRatio),S=Math.round(this.painter.height/devicePixelRatio);f.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),g.readPixels(y,S-x-1,1,1,g.RGBA,g.UNSIGNED_BYTE,l),f.bindFramebuffer.set(null);const I=l[0]+(l[2]>>4<<8),M=l[1]+((15&l[2])<<8),k=this.coordsIndex[255-l[3]],B=k&&this.sourceCache.getTileByID(k);if(!B)return null;const F=this._coordsTextureSize,N=(1<<B.tileID.canonical.z)*F;return new o.a0((B.tileID.canonical.x*F+I)/N+B.tileID.wrap,(B.tileID.canonical.y*F+M)/N,this.getElevation(B.tileID,I,M,F))}depthAtPoint(i){const l=new Uint8Array(4),f=this.painter.context,g=f.gl;return f.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),g.readPixels(i.x,this.painter.height/devicePixelRatio-i.y-1,1,1,g.RGBA,g.UNSIGNED_BYTE,l),f.bindFramebuffer.set(null),(l[0]/16777216+l[1]/65536+l[2]/256+l[3])/256}getTerrainMesh(i){var l;const f=((l=this.painter.style.projection)===null||l===void 0?void 0:l.transitionState)>0,g=f&&i.canonical.y===0,y=f&&i.canonical.y===(1<<i.canonical.z)-1,x=`m_${g?"n":""}_${y?"s":""}`;if(this._meshCache[x])return this._meshCache[x];const S=this.painter.context,I=new o.cu,M=new o.aM,k=this.meshSize,B=o.$/k,F=k*k;for(let oe=0;oe<=k;oe++)for(let ye=0;ye<=k;ye++)I.emplaceBack(ye*B,oe*B,0);for(let oe=0;oe<F;oe+=k+1)for(let ye=0;ye<k;ye++)M.emplaceBack(ye+oe,k+ye+oe+1,k+ye+oe+2),M.emplaceBack(ye+oe,k+ye+oe+2,ye+oe+1);const N=I.length,W=N+(k+1),J=(k+1)*k,G=g?o.bg:0,Q=g?0:1,re=y?o.bh:o.$,ae=y?0:1;for(let oe=0;oe<=k;oe++)I.emplaceBack(oe*B,G,Q);for(let oe=0;oe<=k;oe++)I.emplaceBack(oe*B,re,ae);for(let oe=0;oe<k;oe++)M.emplaceBack(J+oe,W+oe,W+oe+1),M.emplaceBack(J+oe,W+oe+1,J+oe+1),M.emplaceBack(0+oe,N+oe+1,N+oe),M.emplaceBack(0+oe,0+oe+1,N+oe+1);const se=I.length,ue=se+2*(k+1);for(const oe of[0,1])for(let ye=0;ye<=k;ye++)for(const Oe of[0,1])I.emplaceBack(oe*o.$,ye*B,Oe);for(let oe=0;oe<2*k;oe+=2)M.emplaceBack(se+oe,se+oe+1,se+oe+3),M.emplaceBack(se+oe,se+oe+3,se+oe+2),M.emplaceBack(ue+oe,ue+oe+3,ue+oe+1),M.emplaceBack(ue+oe,ue+oe+2,ue+oe+3);const de=new jn(S.createVertexBuffer(I,Zu.members),S.createIndexBuffer(M),o.aL.simpleSegment(0,0,I.length,M.length));return this._meshCache[x]=de,de}getMeshFrameDelta(i){return 2*Math.PI*o.bt/Math.pow(2,Math.max(i,0))/5}getMinTileElevationForLngLatZoom(i,l){var f;const{tileID:g}=this._getOverscaledTileIDFromLngLatZoom(i,l);return(f=this.getMinMaxElevation(g).minElevation)!==null&&f!==void 0?f:0}getMinMaxElevation(i){const l=this.getTerrainData(i).tile,f={minElevation:null,maxElevation:null};return l&&l.dem&&(f.minElevation=l.dem.min*this.exaggeration,f.maxElevation=l.dem.max*this.exaggeration),f}_getOverscaledTileIDFromLngLatZoom(i,l){const f=o.a0.fromLngLat(i.wrap()),g=(1<<l)*o.$,y=f.x*g,x=f.y*g,S=Math.floor(y/o.$),I=Math.floor(x/o.$);return{tileID:new o.Z(l,0,l,S,I),mercatorX:y,mercatorY:x}}}class Tl{constructor(i,l,f){this._context=i,this._size=l,this._tileSize=f,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const i of this._objects)i.texture.destroy(),i.fbo.destroy()}_createObject(i){const l=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),f=new o.T(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return f.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),this._context.extTextureFilterAnisotropic&&this._context.gl.texParameterf(this._context.gl.TEXTURE_2D,this._context.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._context.extTextureFilterAnisotropicMax),l.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),l.colorAttachment.set(f.texture),{id:i,fbo:l,texture:f,stamp:-1,inUse:!1}}getObjectForId(i){return this._objects[i]}useObject(i){i.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter(l=>i.id!==l),this._recentlyUsed.push(i.id)}stampObject(i){i.stamp=++this._stamp}getOrCreateFreeObject(){for(const l of this._recentlyUsed)if(!this._objects[l].inUse)return this._objects[l];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const i=this._createObject(this._objects.length);return this._objects.push(i),i}freeObject(i){i.inUse=!1}freeAllObjects(){for(const i of this._objects)this.freeObject(i)}isFull(){return!(this._objects.length<this._size)&&this._objects.some(i=>!i.inUse)===!1}}const gt={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0,"color-relief":!0};class St{constructor(i,l){this.painter=i,this.terrain=l,this.pool=new Tl(i.context,30,l.sourceCache.tileSize*l.qualityFactor)}destruct(){this.pool.destruct()}getTexture(i){return this.pool.getObjectForId(i.rtt[this._stacks.length-1].id).texture}prepareForRender(i,l){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=i._order.filter(f=>!i._layers[f].isHidden(l)),this._coordsAscending={};for(const f in i.sourceCaches){this._coordsAscending[f]={};const g=i.sourceCaches[f].getVisibleCoordinates(),y=i.sourceCaches[f].getSource(),x=y instanceof Qt?y.terrainTileRanges:null;for(const S of g){const I=this.terrain.sourceCache.getTerrainCoords(S,x);for(const M in I)this._coordsAscending[f][M]||(this._coordsAscending[f][M]=[]),this._coordsAscending[f][M].push(I[M])}}this._coordsAscendingStr={};for(const f of i._order){const g=i._layers[f],y=g.source;if(gt[g.type]&&!this._coordsAscendingStr[y]){this._coordsAscendingStr[y]={};for(const x in this._coordsAscending[y])this._coordsAscendingStr[y][x]=this._coordsAscending[y][x].map(S=>S.key).sort().join()}}for(const f of this._renderableTiles)for(const g in this._coordsAscendingStr){const y=this._coordsAscendingStr[g][f.tileID.key];y&&y!==f.rttCoords[g]&&(f.rtt=[])}}renderLayer(i,l){if(i.isHidden(this.painter.transform.zoom))return!1;const f=Object.assign(Object.assign({},l),{isRenderingToTexture:!0}),g=i.type,y=this.painter,x=this._renderableLayerIds[this._renderableLayerIds.length-1]===i.id;if(gt[g]&&(this._prevType&&gt[this._prevType]||this._stacks.push([]),this._prevType=g,this._stacks[this._stacks.length-1].push(i.id),!x))return!0;if(gt[this._prevType]||gt[g]&&x){this._prevType=g;const S=this._stacks.length-1,I=this._stacks[S]||[];for(const M of this._renderableTiles){if(this.pool.isFull()&&(jr(this.painter,this.terrain,this._rttTiles,f),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(M),M.rtt[S]){const B=this.pool.getObjectForId(M.rtt[S].id);if(B.stamp===M.rtt[S].stamp){this.pool.useObject(B);continue}}const k=this.pool.getOrCreateFreeObject();this.pool.useObject(k),this.pool.stampObject(k),M.rtt[S]={id:k.id,stamp:k.stamp},y.context.bindFramebuffer.set(k.fbo.framebuffer),y.context.clear({color:o.be.transparent,stencil:0}),y.currentStencilSource=void 0;for(let B=0;B<I.length;B++){const F=y.style._layers[I[B]],N=F.source?this._coordsAscending[F.source][M.tileID.key]:[M.tileID];y.context.viewport.set([0,0,k.fbo.width,k.fbo.height]),y._renderTileClippingMasks(F,N,!0),y.renderLayer(y,y.style.sourceCaches[F.source],F,N,f),F.source&&(M.rttCoords[F.source]=this._coordsAscendingStr[F.source][M.tileID.key])}}return jr(this.painter,this.terrain,this._rttTiles,f),this._rttTiles=[],this.pool.freeAllObjects(),gt[g]}return!1}}const Sl={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","GlobeControl.Enable":"Enable globe","GlobeControl.Disable":"Disable globe","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use ⌘ + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},th=T,fa={hash:!1,interactive:!0,bearingSnap:7,attributionControl:da,maplibreLogo:!1,refreshExpiredTiles:!0,canvasContextAttributes:{antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,desynchronized:!1,contextType:void 0},scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],elevation:0,zoom:0,bearing:0,pitch:0,roll:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:o.a.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,rollEnabled:!1,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0,centerClampedToGround:!0},ji={showCompass:!0,showZoom:!0,visualizePitch:!1,visualizeRoll:!0};class Xu{constructor(i,l,f=!1){this.mousedown=y=>{this.startMove(y,V.mousePos(this.element,y)),V.addEventListener(window,"mousemove",this.mousemove),V.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=y=>{this.move(y,V.mousePos(this.element,y))},this.mouseup=y=>{this._rotatePitchHanlder.dragEnd(y),this.offTemp()},this.touchstart=y=>{y.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=V.touchPos(this.element,y.targetTouches)[0],this.startMove(y,this._startPos),V.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),V.addEventListener(window,"touchend",this.touchend))},this.touchmove=y=>{y.targetTouches.length!==1?this.reset():(this._lastPos=V.touchPos(this.element,y.targetTouches)[0],this.move(y,this._lastPos))},this.touchend=y=>{y.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this._rotatePitchHanlder.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10,this.element=l;const g=new zf;this._rotatePitchHanlder=new go({clickTolerance:3,move:(y,x)=>{const S=l.getBoundingClientRect(),I=new o.P((S.bottom-S.top)/2,(S.right-S.left)/2);return{bearingDelta:o.cm(new o.P(y.x,x.y),x,I),pitchDelta:f?-.5*(x.y-y.y):void 0}},moveStateManager:g,enable:!0,assignEvents:()=>{}}),this.map=i,V.addEventListener(l,"mousedown",this.mousedown),V.addEventListener(l,"touchstart",this.touchstart,{passive:!1}),V.addEventListener(l,"touchcancel",this.reset)}startMove(i,l){this._rotatePitchHanlder.dragStart(i,l),V.disableDrag()}move(i,l){const f=this.map,{bearingDelta:g,pitchDelta:y}=this._rotatePitchHanlder.dragMove(i,l)||{};g&&f.setBearing(f.getBearing()+g),y&&f.setPitch(f.getPitch()+y)}off(){const i=this.element;V.removeEventListener(i,"mousedown",this.mousedown),V.removeEventListener(i,"touchstart",this.touchstart,{passive:!1}),V.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),V.removeEventListener(window,"touchend",this.touchend),V.removeEventListener(i,"touchcancel",this.reset),this.offTemp()}offTemp(){V.enableDrag(),V.removeEventListener(window,"mousemove",this.mousemove),V.removeEventListener(window,"mouseup",this.mouseup),V.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),V.removeEventListener(window,"touchend",this.touchend)}}let vi;function qu(_,i,l,f=!1){if(f||!l.getCoveringTilesDetailsProvider().allowWorldCopies())return _?.wrap();const g=new o.S(_.lng,_.lat);if(_=new o.S(_.lng,_.lat),i){const y=new o.S(_.lng-360,_.lat),x=new o.S(_.lng+360,_.lat),S=l.locationToScreenPoint(_).distSqr(i);l.locationToScreenPoint(y).distSqr(i)<S?_=y:l.locationToScreenPoint(x).distSqr(i)<S&&(_=x)}for(;Math.abs(_.lng-l.center.lng)>180;){const y=l.locationToScreenPoint(_);if(y.x>=0&&y.y>=0&&y.x<=l.width&&y.y<=l.height)break;_.lng>l.center.lng?_.lng-=360:_.lng+=360}return _.lng!==g.lng&&l.isPointOnMapSurface(l.locationToScreenPoint(_))?_:g}const Ls={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function Br(_,i,l){const f=_.classList;for(const g in Ls)f.remove(`maplibregl-${l}-anchor-${g}`);f.add(`maplibregl-${l}-anchor-${i}`)}class $r extends o.E{constructor(i){if(super(),this._onKeyPress=l=>{const f=l.code,g=l.charCode||l.keyCode;f!=="Space"&&f!=="Enter"&&g!==32&&g!==13||this.togglePopup()},this._onMapClick=l=>{const f=l.originalEvent.target,g=this._element;this._popup&&(f===g||g.contains(f))&&this.togglePopup()},this._update=l=>{if(!this._map)return;const f=this._map.loaded()&&!this._map.isMoving();(l?.type==="terrain"||l?.type==="render"&&!f)&&this._map.once("render",this._update),this._lngLat=qu(this._lngLat,this._flatPos,this._map.transform),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationToScreenPoint(this._lngLat)._add(this._offset));let g="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?g=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(g=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let y="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?y="rotateX(0deg)":this._pitchAlignment==="map"&&(y=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||l&&l.type!=="moveend"||(this._pos=this._pos.round()),V.setTransform(this._element,`${Ls[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${y} ${g}`),$.frameAsync(new AbortController).then(()=>{this._updateOpacity(l&&l.type==="moveend")}).catch(()=>{})},this._onMove=l=>{if(!this._isDragging){const f=this._clickTolerance||this._map._clickTolerance;this._isDragging=l.point.dist(this._pointerdownPos)>=f}this._isDragging&&(this._pos=l.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new o.l("dragstart"))),this.fire(new o.l("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new o.l("dragend")),this._state="inactive"},this._addDragHandler=l=>{this._element.contains(l.originalEvent.target)&&(l.preventDefault(),this._positionDelta=l.point.sub(this._pos).add(this._offset),this._pointerdownPos=l.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=i&&i.anchor||"center",this._color=i&&i.color||"#3FB1CE",this._scale=i&&i.scale||1,this._draggable=i&&i.draggable||!1,this._clickTolerance=i&&i.clickTolerance||0,this._subpixelPositioning=i&&i.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=i&&i.rotation||0,this._rotationAlignment=i&&i.rotationAlignment||"auto",this._pitchAlignment=i&&i.pitchAlignment&&i.pitchAlignment!=="auto"?i.pitchAlignment:this._rotationAlignment,this.setOpacity(i?.opacity,i?.opacityWhenCovered),i&&i.element)this._element=i.element,this._offset=o.P.convert(i&&i.offset||[0,0]);else{this._defaultMarker=!0,this._element=V.create("div");const l=V.createNS("http://www.w3.org/2000/svg","svg"),f=41,g=27;l.setAttributeNS(null,"display","block"),l.setAttributeNS(null,"height",`${f}px`),l.setAttributeNS(null,"width",`${g}px`),l.setAttributeNS(null,"viewBox",`0 0 ${g} ${f}`);const y=V.createNS("http://www.w3.org/2000/svg","g");y.setAttributeNS(null,"stroke","none"),y.setAttributeNS(null,"stroke-width","1"),y.setAttributeNS(null,"fill","none"),y.setAttributeNS(null,"fill-rule","evenodd");const x=V.createNS("http://www.w3.org/2000/svg","g");x.setAttributeNS(null,"fill-rule","nonzero");const S=V.createNS("http://www.w3.org/2000/svg","g");S.setAttributeNS(null,"transform","translate(3.0, 29.0)"),S.setAttributeNS(null,"fill","#000000");const I=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const Q of I){const re=V.createNS("http://www.w3.org/2000/svg","ellipse");re.setAttributeNS(null,"opacity","0.04"),re.setAttributeNS(null,"cx","10.5"),re.setAttributeNS(null,"cy","5.80029008"),re.setAttributeNS(null,"rx",Q.rx),re.setAttributeNS(null,"ry",Q.ry),S.appendChild(re)}const M=V.createNS("http://www.w3.org/2000/svg","g");M.setAttributeNS(null,"fill",this._color);const k=V.createNS("http://www.w3.org/2000/svg","path");k.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),M.appendChild(k);const B=V.createNS("http://www.w3.org/2000/svg","g");B.setAttributeNS(null,"opacity","0.25"),B.setAttributeNS(null,"fill","#000000");const F=V.createNS("http://www.w3.org/2000/svg","path");F.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),B.appendChild(F);const N=V.createNS("http://www.w3.org/2000/svg","g");N.setAttributeNS(null,"transform","translate(6.0, 7.0)"),N.setAttributeNS(null,"fill","#FFFFFF");const W=V.createNS("http://www.w3.org/2000/svg","g");W.setAttributeNS(null,"transform","translate(8.0, 8.0)");const J=V.createNS("http://www.w3.org/2000/svg","circle");J.setAttributeNS(null,"fill","#000000"),J.setAttributeNS(null,"opacity","0.25"),J.setAttributeNS(null,"cx","5.5"),J.setAttributeNS(null,"cy","5.5"),J.setAttributeNS(null,"r","5.4999962");const G=V.createNS("http://www.w3.org/2000/svg","circle");G.setAttributeNS(null,"fill","#FFFFFF"),G.setAttributeNS(null,"cx","5.5"),G.setAttributeNS(null,"cy","5.5"),G.setAttributeNS(null,"r","5.4999962"),W.appendChild(J),W.appendChild(G),x.appendChild(S),x.appendChild(M),x.appendChild(B),x.appendChild(N),x.appendChild(W),l.appendChild(x),l.setAttributeNS(null,"height",f*this._scale+"px"),l.setAttributeNS(null,"width",g*this._scale+"px"),this._element.appendChild(l),this._offset=o.P.convert(i&&i.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",l=>{l.preventDefault()}),this._element.addEventListener("mousedown",l=>{l.preventDefault()}),Br(this._element,this._anchor,"marker"),i&&i.className)for(const l of i.className.split(" "))this._element.classList.add(l);this._popup=null}addTo(i){return this.remove(),this._map=i,this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label",i._getUIString("Marker.Title")),i.getCanvasContainer().appendChild(this._element),i.on("move",this._update),i.on("moveend",this._update),i.on("terrain",this._update),i.on("projectiontransition",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("projectiontransition",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),V.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(i){return this._lngLat=o.S.convert(i),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(i){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),i){if(!("offset"in i.options)){const g=Math.abs(13.5)/Math.SQRT2;i.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[g,-1*(38.1-13.5+g)],"bottom-right":[-g,-1*(38.1-13.5+g)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=i,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(i){return this._subpixelPositioning=i,this}getPopup(){return this._popup}togglePopup(){const i=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:i?(i.isOpen()?i.remove():(i.setLngLat(this._lngLat),i.addTo(this._map)),this):this}_updateOpacity(i=!1){var l,f;const g=(l=this._map)===null||l===void 0?void 0:l.terrain,y=this._map.transform.isLocationOccluded(this._lngLat);if(!g||y){const N=y?this._opacityWhenCovered:this._opacity;return void(this._element.style.opacity!==N&&(this._element.style.opacity=N))}if(i)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout(()=>{this._opacityTimeout=null},100)}const x=this._map,S=x.terrain.depthAtPoint(this._pos),I=x.terrain.getElevationForLngLatZoom(this._lngLat,x.transform.tileZoom);if(x.transform.lngLatToCameraDepth(this._lngLat,I)-S<.006)return void(this._element.style.opacity=this._opacity);const M=-this._offset.y/x.transform.pixelsPerMeter,k=Math.sin(x.getPitch()*Math.PI/180)*M,B=x.terrain.depthAtPoint(new o.P(this._pos.x,this._pos.y-this._offset.y)),F=x.transform.lngLatToCameraDepth(this._lngLat,I+k)-B>.006;!((f=this._popup)===null||f===void 0)&&f.isOpen()&&F&&this._popup.remove(),this._element.style.opacity=F?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(i){return this._offset=o.P.convert(i),this._update(),this}addClassName(i){this._element.classList.add(i)}removeClassName(i){this._element.classList.remove(i)}toggleClassName(i){return this._element.classList.toggle(i)}setDraggable(i){return this._draggable=!!i,this._map&&(i?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(i){return this._rotation=i||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(i){return this._rotationAlignment=i||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(i){return this._pitchAlignment=i&&i!=="auto"?i:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(i,l){return(this._opacity===void 0||i===void 0&&l===void 0)&&(this._opacity="1",this._opacityWhenCovered="0.2"),i!==void 0&&(this._opacity=i),l!==void 0&&(this._opacityWhenCovered=l),this._map&&this._updateOpacity(!0),this}}const Yu={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let hs=0,us=!1;const rh={maxWidth:100,unit:"metric"};function Al(_,i,l){const f=l&&l.maxWidth||100,g=_._container.clientHeight/2,y=_._container.clientWidth/2,x=_.unproject([y-f/2,g]),S=_.unproject([y+f/2,g]),I=Math.round(_.project(S).x-_.project(x).x),M=Math.min(f,I,_._container.clientWidth),k=x.distanceTo(S);if(l&&l.unit==="imperial"){const B=3.2808*k;B>5280?Ns(i,M,B/5280,_._getUIString("ScaleControl.Miles")):Ns(i,M,B,_._getUIString("ScaleControl.Feet"))}else l&&l.unit==="nautical"?Ns(i,M,k/1852,_._getUIString("ScaleControl.NauticalMiles")):k>=1e3?Ns(i,M,k/1e3,_._getUIString("ScaleControl.Kilometers")):Ns(i,M,k,_._getUIString("ScaleControl.Meters"))}function Ns(_,i,l,f){const g=function(y){const x=Math.pow(10,`${Math.floor(y)}`.length-1);let S=y/x;return S=S>=10?10:S>=5?5:S>=3?3:S>=2?2:S>=1?1:function(I){const M=Math.pow(10,Math.ceil(-Math.log(I)/Math.LN10));return Math.round(I*M)/M}(S),x*S}(l);_.style.width=i*(g/l)+"px",_.innerHTML=`${g}&nbsp;${f}`}const pa={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1,locationOccludedOpacity:void 0},ih=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function El(_){if(_){if(typeof _=="number"){const i=Math.round(Math.abs(_)/Math.SQRT2);return{center:new o.P(0,0),top:new o.P(0,_),"top-left":new o.P(i,i),"top-right":new o.P(-i,i),bottom:new o.P(0,-_),"bottom-left":new o.P(i,-i),"bottom-right":new o.P(-i,-i),left:new o.P(_,0),right:new o.P(-_,0)}}if(_ instanceof o.P||Array.isArray(_)){const i=o.P.convert(_);return{center:i,top:i,"top-left":i,"top-right":i,bottom:i,"bottom-left":i,"bottom-right":i,left:i,right:i}}return{center:o.P.convert(_.center||[0,0]),top:o.P.convert(_.top||[0,0]),"top-left":o.P.convert(_["top-left"]||[0,0]),"top-right":o.P.convert(_["top-right"]||[0,0]),bottom:o.P.convert(_.bottom||[0,0]),"bottom-left":o.P.convert(_["bottom-left"]||[0,0]),"bottom-right":o.P.convert(_["bottom-right"]||[0,0]),left:o.P.convert(_.left||[0,0]),right:o.P.convert(_.right||[0,0])}}return El(new o.P(0,0))}const nh=T;p.AJAXError=o.cy,p.Event=o.l,p.Evented=o.E,p.LngLat=o.S,p.MercatorCoordinate=o.a0,p.Point=o.P,p.addProtocol=o.cz,p.config=o.a,p.removeProtocol=o.cA,p.AttributionControl=wl,p.BoxZoomHandler=Hc,p.CanvasSource=Ni,p.CooperativeGesturesHandler=Wu,p.DoubleClickZoomHandler=vl,p.DragPanHandler=Kc,p.DragRotateHandler=xl,p.EdgeInsets=hn,p.FullscreenControl=class extends o.E{constructor(_={}){super(),this._onFullscreenChange=()=>{var i;let l=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((i=l?.shadowRoot)===null||i===void 0)&&i.fullscreenElement;)l=l.shadowRoot.fullscreenElement;l===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,_&&_.container&&(_.container instanceof HTMLElement?this._container=_.container:o.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(_){return this._map=_,this._container||(this._container=this._map.getContainer()),this._controlContainer=V.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){V.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const _=this._fullscreenButton=V.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);V.create("span","maplibregl-ctrl-icon",_).setAttribute("aria-hidden","true"),_.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const _=this._getTitle();this._fullscreenButton.setAttribute("aria-label",_),this._fullscreenButton.title=_}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new o.l("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new o.l("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},p.GeoJSONSource=Ct,p.GeolocateControl=class extends o.E{constructor(_){super(),this._onSuccess=i=>{if(this._map){if(this._isOutOfMapMaxBounds(i))return this._setErrorState(),this.fire(new o.l("outofmaxbounds",i)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=i,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(i),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(i),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new o.l("geolocate",i)),this._finish()}},this._updateCamera=i=>{const l=new o.S(i.coords.longitude,i.coords.latitude),f=i.coords.accuracy,g=this._map.getBearing(),y=o.e({bearing:g},this.options.fitBoundsOptions),x=zt.fromLngLat(l,f);this._map.fitBounds(x,y,{geolocateSource:!0})},this._updateMarker=i=>{if(i){const l=new o.S(i.coords.longitude,i.coords.latitude);this._accuracyCircleMarker.setLngLat(l).addTo(this._map),this._userLocationDotMarker.setLngLat(l).addTo(this._map),this._accuracy=i.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=i=>{if(this._map){if(i.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const l=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=l,this._geolocateButton.setAttribute("aria-label",l),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(i.code===3&&us)return;this.options.trackUserLocation&&this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new o.l("error",i)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",i=>i.preventDefault()),this._geolocateButton=V.create("button","maplibregl-ctrl-geolocate",this._container),V.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=i=>{if(this._map){if(i===!1){o.w("Geolocation support is not available so the GeolocateControl will be disabled.");const l=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=l,this._geolocateButton.setAttribute("aria-label",l)}else{const l=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=l,this._geolocateButton.setAttribute("aria-label",l)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=V.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new $r({element:this._dotElement}),this._circleElement=V.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new $r({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",()=>this.trigger()),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",l=>{l.geolocateSource||this._watchState!=="ACTIVE_LOCK"||l.originalEvent&&l.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new o.l("trackuserlocationend")),this.fire(new o.l("userlocationlostfocus")))})}},this.options=o.e({},Yu,_)}onAdd(_){return this._map=_,this._container=V.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),function(){return o._(this,arguments,void 0,function*(i=!1){if(vi!==void 0&&!i)return vi;if(window.navigator.permissions===void 0)return vi=!!window.navigator.geolocation,vi;try{vi=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{vi=!!window.navigator.geolocation}return vi})}().then(i=>this._finishSetupUI(i)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),V.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,hs=0,us=!1}_isOutOfMapMaxBounds(_){const i=this._map.getMaxBounds(),l=_.coords;return i&&(l.longitude<i.getWest()||l.longitude>i.getEast()||l.latitude<i.getSouth()||l.latitude>i.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const _=this._map.getBounds(),i=_.getSouthEast(),l=_.getNorthEast(),f=i.distanceTo(l),g=Math.ceil(this._accuracy/(f/this._map._container.clientHeight)*2);this._circleElement.style.width=`${g}px`,this._circleElement.style.height=`${g}px`}trigger(){if(!this._setup)return o.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new o.l("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":hs--,us=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new o.l("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new o.l("trackuserlocationstart")),this.fire(new o.l("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let _;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),hs++,hs>1?(_={maximumAge:6e5,timeout:0},us=!0):(_=this.options.positionOptions,us=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,_)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},p.GlobeControl=class{constructor(){this._toggleProjection=()=>{var _;const i=(_=this._map.getProjection())===null||_===void 0?void 0:_.type;this._map.setProjection(i!=="mercator"&&i?{type:"mercator"}:{type:"globe"}),this._updateGlobeIcon()},this._updateGlobeIcon=()=>{var _;this._globeButton.classList.remove("maplibregl-ctrl-globe"),this._globeButton.classList.remove("maplibregl-ctrl-globe-enabled"),((_=this._map.getProjection())===null||_===void 0?void 0:_.type)==="globe"?(this._globeButton.classList.add("maplibregl-ctrl-globe-enabled"),this._globeButton.title=this._map._getUIString("GlobeControl.Disable")):(this._globeButton.classList.add("maplibregl-ctrl-globe"),this._globeButton.title=this._map._getUIString("GlobeControl.Enable"))}}onAdd(_){return this._map=_,this._container=V.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._globeButton=V.create("button","maplibregl-ctrl-globe",this._container),V.create("span","maplibregl-ctrl-icon",this._globeButton).setAttribute("aria-hidden","true"),this._globeButton.type="button",this._globeButton.addEventListener("click",this._toggleProjection),this._updateGlobeIcon(),this._map.on("styledata",this._updateGlobeIcon),this._container}onRemove(){V.remove(this._container),this._map.off("styledata",this._updateGlobeIcon),this._globeButton.removeEventListener("click",this._toggleProjection),this._map=void 0}},p.Hash=oa,p.ImageSource=Qt,p.KeyboardHandler=yo,p.LngLatBounds=zt,p.LogoControl=eh,p.Map=class extends Rr{constructor(_){var i,l;o.cv.mark(o.cw.create);const f=Object.assign(Object.assign(Object.assign({},fa),_),{canvasContextAttributes:Object.assign(Object.assign({},fa.canvasContextAttributes),_.canvasContextAttributes)});if(f.minZoom!=null&&f.maxZoom!=null&&f.minZoom>f.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(f.minPitch!=null&&f.maxPitch!=null&&f.minPitch>f.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(f.minPitch!=null&&f.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(f.maxPitch!=null&&f.maxPitch>180)throw new Error("maxPitch must be less than or equal to 180");const g=new Gr,y=new Ya;if(f.minZoom!==void 0&&g.setMinZoom(f.minZoom),f.maxZoom!==void 0&&g.setMaxZoom(f.maxZoom),f.minPitch!==void 0&&g.setMinPitch(f.minPitch),f.maxPitch!==void 0&&g.setMaxPitch(f.maxPitch),f.renderWorldCopies!==void 0&&g.setRenderWorldCopies(f.renderWorldCopies),super(g,y,{bearingSnap:f.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new Hu,this._controls=[],this._mapId=o.a6(),this._contextLost=S=>{S.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new o.l("webglcontextlost",{originalEvent:S}))},this._contextRestored=S=>{this._setupPainter(),this.resize(),this._update(),this.fire(new o.l("webglcontextrestored",{originalEvent:S}))},this._onMapScroll=S=>{if(S.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=f.interactive,this._maxTileCacheSize=f.maxTileCacheSize,this._maxTileCacheZoomLevels=f.maxTileCacheZoomLevels,this._canvasContextAttributes=Object.assign({},f.canvasContextAttributes),this._trackResize=f.trackResize===!0,this._bearingSnap=f.bearingSnap,this._centerClampedToGround=f.centerClampedToGround,this._refreshExpiredTiles=f.refreshExpiredTiles===!0,this._fadeDuration=f.fadeDuration,this._crossSourceCollisions=f.crossSourceCollisions===!0,this._collectResourceTiming=f.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},Sl),f.locale),this._clickTolerance=f.clickTolerance,this._overridePixelRatio=f.pixelRatio,this._maxCanvasSize=f.maxCanvasSize,this.transformCameraUpdate=f.transformCameraUpdate,this.cancelPendingTileRequestsWhileZooming=f.cancelPendingTileRequestsWhileZooming===!0,this._imageQueueHandle=Ue.addThrottleControl(()=>this.isMoving()),this._requestManager=new et(f.transformRequest),typeof f.container=="string"){if(this._container=document.getElementById(f.container),!this._container)throw new Error(`Container '${f.container}' not found.`)}else{if(!(f.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=f.container}if(f.maxBounds&&this.setMaxBounds(f.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this.on("terrain",()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)}),this.once("idle",()=>{this._idleTriggered=!0}),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let S=!1;const I=gl(M=>{this._trackResize&&!this._removed&&(this.resize(M),this.redraw())},50);this._resizeObserver=new ResizeObserver(M=>{S?I(M):S=!0}),this._resizeObserver.observe(this._container)}this.handlers=new cs(this,f),this._hash=f.hash&&new oa(typeof f.hash=="string"&&f.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:f.center,elevation:f.elevation,zoom:f.zoom,bearing:f.bearing,pitch:f.pitch,roll:f.roll}),f.bounds&&(this.resize(),this.fitBounds(f.bounds,o.e({},f.fitBoundsOptions,{duration:0}))));const x=typeof f.style=="string"||((l=(i=f.style)===null||i===void 0?void 0:i.projection)===null||l===void 0?void 0:l.type)!=="globe";this.resize(null,x),this._localIdeographFontFamily=f.localIdeographFontFamily,this._validateStyle=f.validateStyle,f.style&&this.setStyle(f.style,{localIdeographFontFamily:f.localIdeographFontFamily}),f.attributionControl&&this.addControl(new wl(typeof f.attributionControl=="boolean"?void 0:f.attributionControl)),f.maplibreLogo&&this.addControl(new eh,f.logoPosition),this.on("style.load",()=>{if(x||this._resizeTransform(),this.transform.unmodified){const S=o.Q(this.style.stylesheet,["center","zoom","bearing","pitch","roll"]);this.jumpTo(S)}}),this.on("data",S=>{this._update(S.dataType==="style"),this.fire(new o.l(`${S.dataType}data`,S))}),this.on("dataloading",S=>{this.fire(new o.l(`${S.dataType}dataloading`,S))}),this.on("dataabort",S=>{this.fire(new o.l("sourcedataabort",S))})}_getMapId(){return this._mapId}setGlobalStateProperty(_,i){return this.style.setGlobalStateProperty(_,i),this._update(!0)}getGlobalState(){return this.style.getGlobalState()}addControl(_,i){if(i===void 0&&(i=_.getDefaultPosition?_.getDefaultPosition():"top-right"),!_||!_.onAdd)return this.fire(new o.k(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const l=_.onAdd(this);this._controls.push(_);const f=this._controlPositions[i];return i.indexOf("bottom")!==-1?f.insertBefore(l,f.firstChild):f.appendChild(l),this}removeControl(_){if(!_||!_.onRemove)return this.fire(new o.k(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const i=this._controls.indexOf(_);return i>-1&&this._controls.splice(i,1),_.onRemove(this),this}hasControl(_){return this._controls.indexOf(_)>-1}calculateCameraOptionsFromTo(_,i,l,f){return f==null&&this.terrain&&(f=this.terrain.getElevationForLngLatZoom(l,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(_,i,l,f)}resize(_,i=!0){const[l,f]=this._containerDimensions(),g=this._getClampedPixelRatio(l,f);if(this._resizeCanvas(l,f,g),this.painter.resize(l,f,g),this.painter.overLimit()){const x=this.painter.context.gl;this._maxCanvasSize=[x.drawingBufferWidth,x.drawingBufferHeight];const S=this._getClampedPixelRatio(l,f);this._resizeCanvas(l,f,S),this.painter.resize(l,f,S)}this._resizeTransform(i);const y=!this._moving;return y&&(this.stop(),this.fire(new o.l("movestart",_)).fire(new o.l("move",_))),this.fire(new o.l("resize",_)),y&&this.fire(new o.l("moveend",_)),this}_resizeTransform(_=!0){var i;const[l,f]=this._containerDimensions();this.transform.resize(l,f,_),(i=this._requestedCameraState)===null||i===void 0||i.resize(l,f,_)}_getClampedPixelRatio(_,i){const{0:l,1:f}=this._maxCanvasSize,g=this.getPixelRatio(),y=_*g,x=i*g;return Math.min(y>l?l/y:1,x>f?f/x:1)*g}getPixelRatio(){var _;return(_=this._overridePixelRatio)!==null&&_!==void 0?_:devicePixelRatio}setPixelRatio(_){this._overridePixelRatio=_,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(_){return this.transform.setMaxBounds(zt.convert(_)),this._update()}setMinZoom(_){if((_=_??-2)>=-2&&_<=this.transform.maxZoom)return this.transform.setMinZoom(_),this._update(),this.getZoom()<_&&this.setZoom(_),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(_){if((_=_??22)>=this.transform.minZoom)return this.transform.setMaxZoom(_),this._update(),this.getZoom()>_&&this.setZoom(_),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(_){if((_=_??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(_>=0&&_<=this.transform.maxPitch)return this.transform.setMinPitch(_),this._update(),this.getPitch()<_&&this.setPitch(_),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(_){if((_=_??60)>180)throw new Error("maxPitch must be less than or equal to 180");if(_>=this.transform.minPitch)return this.transform.setMaxPitch(_),this._update(),this.getPitch()>_&&this.setPitch(_),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(_){return this.transform.setRenderWorldCopies(_),this._update()}project(_){return this.transform.locationToScreenPoint(o.S.convert(_),this.style&&this.terrain)}unproject(_){return this.transform.screenPointToLocation(o.P.convert(_),this.terrain)}isMoving(){var _;return this._moving||((_=this.handlers)===null||_===void 0?void 0:_.isMoving())}isZooming(){var _;return this._zooming||((_=this.handlers)===null||_===void 0?void 0:_.isZooming())}isRotating(){var _;return this._rotating||((_=this.handlers)===null||_===void 0?void 0:_.isRotating())}_createDelegatedListener(_,i,l){if(_==="mouseenter"||_==="mouseover"){let f=!1;return{layers:i,listener:l,delegates:{mousemove:y=>{const x=i.filter(I=>this.getLayer(I)),S=x.length!==0?this.queryRenderedFeatures(y.point,{layers:x}):[];S.length?f||(f=!0,l.call(this,new qi(_,this,y.originalEvent,{features:S}))):f=!1},mouseout:()=>{f=!1}}}}if(_==="mouseleave"||_==="mouseout"){let f=!1;return{layers:i,listener:l,delegates:{mousemove:x=>{const S=i.filter(I=>this.getLayer(I));(S.length!==0?this.queryRenderedFeatures(x.point,{layers:S}):[]).length?f=!0:f&&(f=!1,l.call(this,new qi(_,this,x.originalEvent)))},mouseout:x=>{f&&(f=!1,l.call(this,new qi(_,this,x.originalEvent)))}}}}{const f=g=>{const y=i.filter(S=>this.getLayer(S)),x=y.length!==0?this.queryRenderedFeatures(g.point,{layers:y}):[];x.length&&(g.features=x,l.call(this,g),delete g.features)};return{layers:i,listener:l,delegates:{[_]:f}}}}_saveDelegatedListener(_,i){this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[_]=this._delegatedListeners[_]||[],this._delegatedListeners[_].push(i)}_removeDelegatedListener(_,i,l){if(!this._delegatedListeners||!this._delegatedListeners[_])return;const f=this._delegatedListeners[_];for(let g=0;g<f.length;g++){const y=f[g];if(y.listener===l&&y.layers.length===i.length&&y.layers.every(x=>i.includes(x))){for(const x in y.delegates)this.off(x,y.delegates[x]);return void f.splice(g,1)}}}on(_,i,l){if(l===void 0)return super.on(_,i);const f=typeof i=="string"?[i]:i,g=this._createDelegatedListener(_,f,l);this._saveDelegatedListener(_,g);for(const y in g.delegates)this.on(y,g.delegates[y]);return{unsubscribe:()=>{this._removeDelegatedListener(_,f,l)}}}once(_,i,l){if(l===void 0)return super.once(_,i);const f=typeof i=="string"?[i]:i,g=this._createDelegatedListener(_,f,l);for(const y in g.delegates){const x=g.delegates[y];g.delegates[y]=(...S)=>{this._removeDelegatedListener(_,f,l),x(...S)}}this._saveDelegatedListener(_,g);for(const y in g.delegates)this.once(y,g.delegates[y]);return this}off(_,i,l){return l===void 0?super.off(_,i):(this._removeDelegatedListener(_,typeof i=="string"?[i]:i,l),this)}queryRenderedFeatures(_,i){if(!this.style)return[];let l;const f=_ instanceof o.P||Array.isArray(_),g=f?_:[[0,0],[this.transform.width,this.transform.height]];if(i=i||(f?{}:_)||{},g instanceof o.P||typeof g[0]=="number")l=[o.P.convert(g)];else{const y=o.P.convert(g[0]),x=o.P.convert(g[1]);l=[y,new o.P(x.x,y.y),x,new o.P(y.x,x.y),y]}return this.style.queryRenderedFeatures(l,i,this.transform)}querySourceFeatures(_,i){return this.style.querySourceFeatures(_,i)}setStyle(_,i){return(i=o.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},i)).diff!==!1&&i.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&_?(this._diffStyle(_,i),this):(this._localIdeographFontFamily=i.localIdeographFontFamily,this._updateStyle(_,i))}setTransformRequest(_){return this._requestManager.setTransformRequest(_),this}_getUIString(_){const i=this._locale[_];if(i==null)throw new Error(`Missing UI string '${_}'`);return i}_updateStyle(_,i){var l,f;if(i.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",()=>this._updateStyle(_,i));const g=this.style&&i.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!_)),_?(this.style=new wc(this,i||{}),this.style.setEventedParent(this,{style:this.style}),typeof _=="string"?this.style.loadURL(_,i,g):this.style.loadJSON(_,i,g),this):((f=(l=this.style)===null||l===void 0?void 0:l.projection)===null||f===void 0||f.destroy(),delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new wc(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(_,i){if(typeof _=="string"){const l=this._requestManager.transformRequest(_,"Style");o.j(l,new AbortController).then(f=>{this._updateDiff(f.data,i)}).catch(f=>{f&&this.fire(new o.k(f))})}else typeof _=="object"&&this._updateDiff(_,i)}_updateDiff(_,i){try{this.style.setState(_,i)&&this._update(!0)}catch(l){o.w(`Unable to perform style diff: ${l.message||l.error||l}.  Rebuilding the style from scratch.`),this._updateStyle(_,i)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():o.w("There is no style added to the map.")}addSource(_,i){return this._lazyInitEmptyStyle(),this.style.addSource(_,i),this._update(!0)}isSourceLoaded(_){const i=this.style&&this.style.sourceCaches[_];if(i!==void 0)return i.loaded();this.fire(new o.k(new Error(`There is no source with ID '${_}'`)))}setTerrain(_){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),_){const i=this.style.sourceCaches[_.source];if(!i)throw new Error(`cannot load terrain, because there exists no source with ID: ${_.source}`);this.terrain===null&&i.reload();for(const l in this.style._layers){const f=this.style._layers[l];f.type==="hillshade"&&f.source===_.source&&o.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality."),f.type==="color-relief"&&f.source===_.source&&o.w("You are using the same source for a color-relief layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new kn(this.painter,i,_),this.painter.renderToTexture=new St(this.painter,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._terrainDataCallback=l=>{var f;l.dataType==="style"?this.terrain.sourceCache.freeRtt():l.dataType==="source"&&l.tile&&(l.sourceId!==_.source||this._elevationFreeze||(this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))),((f=l.source)===null||f===void 0?void 0:f.type)==="image"?this.terrain.sourceCache.freeRtt():this.terrain.sourceCache.freeRtt(l.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0);return this.fire(new o.l("terrain",{terrain:_})),this}getTerrain(){var _,i;return(i=(_=this.terrain)===null||_===void 0?void 0:_.options)!==null&&i!==void 0?i:null}areTilesLoaded(){const _=this.style&&this.style.sourceCaches;for(const i in _){const l=_[i]._tiles;for(const f in l){const g=l[f];if(g.state!=="loaded"&&g.state!=="errored")return!1}}return!0}removeSource(_){return this.style.removeSource(_),this._update(!0)}getSource(_){return this.style.getSource(_)}setSourceTileLodParams(_,i,l){if(l){const f=this.getSource(l);if(!f)throw new Error(`There is no source with ID "${l}", cannot set LOD parameters`);f.calculateTileZoom=De(Math.max(1,_),Math.max(1,i))}else for(const f in this.style.sourceCaches)this.style.sourceCaches[f].getSource().calculateTileZoom=De(Math.max(1,_),Math.max(1,i));return this._update(!0),this}refreshTiles(_,i){const l=this.style.sourceCaches[_];if(!l)throw new Error(`There is no source cache with ID "${_}", cannot refresh tile`);i===void 0?l.reload(!0):l.refreshTiles(i.map(f=>new o.a3(f.z,f.x,f.y)))}addImage(_,i,l={}){const{pixelRatio:f=1,sdf:g=!1,stretchX:y,stretchY:x,content:S,textFitWidth:I,textFitHeight:M}=l;if(this._lazyInitEmptyStyle(),!(i instanceof HTMLImageElement||o.b(i))){if(i.width===void 0||i.height===void 0)return this.fire(new o.k(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:k,height:B,data:F}=i,N=i;return this.style.addImage(_,{data:new o.R({width:k,height:B},new Uint8Array(F)),pixelRatio:f,stretchX:y,stretchY:x,content:S,textFitWidth:I,textFitHeight:M,sdf:g,version:0,userImage:N}),N.onAdd&&N.onAdd(this,_),this}}{const{width:k,height:B,data:F}=$.getImageData(i);this.style.addImage(_,{data:new o.R({width:k,height:B},F),pixelRatio:f,stretchX:y,stretchY:x,content:S,textFitWidth:I,textFitHeight:M,sdf:g,version:0})}}updateImage(_,i){const l=this.style.getImage(_);if(!l)return this.fire(new o.k(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const f=i instanceof HTMLImageElement||o.b(i)?$.getImageData(i):i,{width:g,height:y,data:x}=f;if(g===void 0||y===void 0)return this.fire(new o.k(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(g!==l.data.width||y!==l.data.height)return this.fire(new o.k(new Error("The width and height of the updated image must be that same as the previous version of the image")));const S=!(i instanceof HTMLImageElement||o.b(i));return l.data.replace(x,S),this.style.updateImage(_,l),this}getImage(_){return this.style.getImage(_)}hasImage(_){return _?!!this.style.getImage(_):(this.fire(new o.k(new Error("Missing required image id"))),!1)}removeImage(_){this.style.removeImage(_)}loadImage(_){return Ue.getImage(this._requestManager.transformRequest(_,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(_,i){return this._lazyInitEmptyStyle(),this.style.addLayer(_,i),this._update(!0)}moveLayer(_,i){return this.style.moveLayer(_,i),this._update(!0)}removeLayer(_){return this.style.removeLayer(_),this._update(!0)}getLayer(_){return this.style.getLayer(_)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(_,i,l){return this.style.setLayerZoomRange(_,i,l),this._update(!0)}setFilter(_,i,l={}){return this.style.setFilter(_,i,l),this._update(!0)}getFilter(_){return this.style.getFilter(_)}setPaintProperty(_,i,l,f={}){return this.style.setPaintProperty(_,i,l,f),this._update(!0)}getPaintProperty(_,i){return this.style.getPaintProperty(_,i)}setLayoutProperty(_,i,l,f={}){return this.style.setLayoutProperty(_,i,l,f),this._update(!0)}getLayoutProperty(_,i){return this.style.getLayoutProperty(_,i)}setGlyphs(_,i={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(_,i),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(_,i,l={}){return this._lazyInitEmptyStyle(),this.style.addSprite(_,i,l,f=>{f||this._update(!0)}),this}removeSprite(_){return this._lazyInitEmptyStyle(),this.style.removeSprite(_),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(_,i={}){return this._lazyInitEmptyStyle(),this.style.setSprite(_,i,l=>{l||this._update(!0)}),this}setLight(_,i={}){return this._lazyInitEmptyStyle(),this.style.setLight(_,i),this._update(!0)}getLight(){return this.style.getLight()}setSky(_,i={}){return this._lazyInitEmptyStyle(),this.style.setSky(_,i),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(_,i){return this.style.setFeatureState(_,i),this._update()}removeFeatureState(_,i){return this.style.removeFeatureState(_,i),this._update()}getFeatureState(_){return this.style.getFeatureState(_)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let _=0,i=0;return this._container&&(_=this._container.clientWidth||400,i=this._container.clientHeight||300),[_,i]}_setupContainer(){const _=this._container;_.classList.add("maplibregl-map");const i=this._canvasContainer=V.create("div","maplibregl-canvas-container",_);this._interactive&&i.classList.add("maplibregl-interactive"),this._canvas=V.create("canvas","maplibregl-canvas",i),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const l=this._containerDimensions(),f=this._getClampedPixelRatio(l[0],l[1]);this._resizeCanvas(l[0],l[1],f);const g=this._controlContainer=V.create("div","maplibregl-control-container",_),y=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(x=>{y[x]=V.create("div",`maplibregl-ctrl-${x} `,g)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(_,i,l){this._canvas.width=Math.floor(l*_),this._canvas.height=Math.floor(l*i),this._canvas.style.width=`${_}px`,this._canvas.style.height=`${i}px`}_setupPainter(){const _=Object.assign(Object.assign({},this._canvasContextAttributes),{alpha:!0,depth:!0,stencil:!0,premultipliedAlpha:!0});let i=null;this._canvas.addEventListener("webglcontextcreationerror",f=>{i={requestedAttributes:_},f&&(i.statusMessage=f.statusMessage,i.type=f.type)},{once:!0});let l=null;if(l=this._canvasContextAttributes.contextType?this._canvas.getContext(this._canvasContextAttributes.contextType,_):this._canvas.getContext("webgl2",_)||this._canvas.getContext("webgl",_),!l){const f="Failed to initialize WebGL";throw i?(i.message=f,new Error(JSON.stringify(i))):new Error(f)}this.painter=new dn(l,this.transform),ie.testSupport(l)}migrateProjection(_,i){super.migrateProjection(_,i),this.painter.transform=_,this.fire(new o.l("projectiontransition",{newProjection:this.style.projection.name}))}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(_){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||_,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(_){return this._update(),this._renderTaskQueue.add(_)}_cancelRenderFrame(_){this._renderTaskQueue.remove(_)}_render(_){var i,l,f,g,y;const x=this._idleTriggered?this._fadeDuration:0,S=((i=this.style.projection)===null||i===void 0?void 0:i.transitionState)>0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(_),this._removed)return;let I=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const B=this.transform.zoom,F=$.now();this.style.zoomHistory.update(B,F);const N=new o.F(B,{now:F,fadeDuration:x,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition(),globalState:this.style.getGlobalState()}),W=N.crossFadingFactor();W===1&&W===this._crossFadingFactor||(I=!0,this._crossFadingFactor=W),this.style.update(N)}const M=((l=this.style.projection)===null||l===void 0?void 0:l.transitionState)>0!==S;(f=this.style.projection)===null||f===void 0||f.setErrorQueryLatitudeDegrees(this.transform.center.lat),this.transform.setTransitionState((g=this.style.projection)===null||g===void 0?void 0:g.transitionState,(y=this.style.projection)===null||y===void 0?void 0:y.latitudeErrorCorrectionRadians),this.style&&(this._sourcesDirty||M)&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),!this._elevationFreeze&&this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0)),this._placementDirty=this.style&&this.style._updatePlacement(this.transform,this.showCollisionBoxes,x,this._crossSourceCollisions,M),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:x,showPadding:this.showPadding}),this.fire(new o.l("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,o.cv.mark(o.cw.load),this.fire(new o.l("load"))),this.style&&(this.style.hasTransitions()||I)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const k=this._sourcesDirty||this._styleDirty||this._placementDirty;return k||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new o.l("idle")),!this._loaded||this._fullyLoaded||k||(this._fullyLoaded=!0,o.cv.mark(o.cw.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var _;this._hash&&this._hash.remove();for(const l of this._controls)l.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),Ue.removeThrottleControl(this._imageQueueHandle),(_=this._resizeObserver)===null||_===void 0||_.disconnect();const i=this.painter.context.gl.getExtension("WEBGL_lose_context");i?.loseContext&&i.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),V.remove(this._canvasContainer),V.remove(this._controlContainer),this._container.removeEventListener("scroll",this._onMapScroll,!1),this._container.classList.remove("maplibregl-map"),o.cv.clearMetrics(),this._removed=!0,this.fire(new o.l("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,$.frame(this._frameRequest,_=>{o.cv.frame(_),this._frameRequest=null;try{this._render(_)}catch(i){if(!o.cx(i)&&!function(l){return l.message===Lc}(i))throw i}},()=>{}))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(_){this._showTileBoundaries!==_&&(this._showTileBoundaries=_,this._update())}get showPadding(){return!!this._showPadding}set showPadding(_){this._showPadding!==_&&(this._showPadding=_,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(_){this._showCollisionBoxes!==_&&(this._showCollisionBoxes=_,_?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(_){this._showOverdrawInspector!==_&&(this._showOverdrawInspector=_,this._update())}get repaint(){return!!this._repaint}set repaint(_){this._repaint!==_&&(this._repaint=_,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(_){this._vertices=_,this._update()}get version(){return th}getCameraTargetElevation(){return this.transform.elevation}getProjection(){return this.style.getProjection()}setProjection(_){return this._lazyInitEmptyStyle(),this.style.setProjection(_),this._update(!0)}},p.MapMouseEvent=qi,p.MapTouchEvent=gn,p.MapWheelEvent=Wc,p.Marker=$r,p.NavigationControl=class{constructor(_){this._updateZoomButtons=()=>{const i=this._map.getZoom(),l=i===this._map.getMaxZoom(),f=i===this._map.getMinZoom();this._zoomInButton.disabled=l,this._zoomOutButton.disabled=f,this._zoomInButton.setAttribute("aria-disabled",l.toString()),this._zoomOutButton.setAttribute("aria-disabled",f.toString())},this._rotateCompassArrow=()=>{this._compassIcon.style.transform=this.options.visualizePitch&&this.options.visualizeRoll?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateZ(${-this._map.transform.roll}deg) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizeRoll?`rotate(${-this._map.transform.bearing-this._map.transform.roll}deg)`:`rotate(${-this._map.transform.bearing}deg)`},this._setButtonTitle=(i,l)=>{const f=this._map._getUIString(`NavigationControl.${l}`);i.title=f,i.setAttribute("aria-label",f)},this.options=o.e({},ji,_),this._container=V.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",i=>i.preventDefault()),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",i=>this._map.zoomIn({},{originalEvent:i})),V.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",i=>this._map.zoomOut({},{originalEvent:i})),V.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",i=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:i}):this._map.resetNorth({},{originalEvent:i})}),this._compassIcon=V.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(_){return this._map=_,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.on("roll",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Xu(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){V.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.off("roll",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(_,i){const l=V.create("button",_,this._container);return l.type="button",l.addEventListener("click",i),l}},p.Popup=class extends o.E{constructor(_){super(),this._updateOpacity=()=>{this.options.locationOccludedOpacity!==void 0&&(this._container.style.opacity=this._map.transform.isLocationOccluded(this.getLngLat())?`${this.options.locationOccludedOpacity}`:"")},this.remove=()=>(this._content&&V.remove(this._content),this._container&&(V.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new o.l("close"))),this),this._onMouseUp=i=>{this._update(i.point)},this._onMouseMove=i=>{this._update(i.point)},this._onDrag=i=>{this._update(i.point)},this._update=i=>{if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=V.create("div","maplibregl-popup",this._map.getContainer()),this._tip=V.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const x of this.options.className.split(" "))this._container.classList.add(x);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=qu(this._lngLat,this._flatPos,this._map.transform,this._trackPointer),this._trackPointer&&!i)return;const l=this._flatPos=this._pos=this._trackPointer&&i?i:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&i?i:this._map.transform.locationToScreenPoint(this._lngLat));let f=this.options.anchor;const g=El(this.options.offset);if(!f){const x=this._container.offsetWidth,S=this._container.offsetHeight;let I;I=l.y+g.bottom.y<S?["top"]:l.y>this._map.transform.height-S?["bottom"]:[],l.x<x/2?I.push("left"):l.x>this._map.transform.width-x/2&&I.push("right"),f=I.length===0?"bottom":I.join("-")}let y=l.add(g[f]);this.options.subpixelPositioning||(y=y.round()),V.setTransform(this._container,`${Ls[f]} translate(${y.x}px,${y.y}px)`),Br(this._container,f,"popup"),this._updateOpacity()},this._onClose=()=>{this.remove()},this.options=o.e(Object.create(pa),_)}addTo(_){return this._map&&this.remove(),this._map=_,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new o.l("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(_){return this._lngLat=o.S.convert(_),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(_){return this.setDOMContent(document.createTextNode(_))}setHTML(_){const i=document.createDocumentFragment(),l=document.createElement("body");let f;for(l.innerHTML=_;f=l.firstChild,f;)i.appendChild(f);return this.setDOMContent(i)}getMaxWidth(){var _;return(_=this._container)===null||_===void 0?void 0:_.style.maxWidth}setMaxWidth(_){return this.options.maxWidth=_,this._update(),this}setDOMContent(_){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=V.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(_),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(_){return this._container&&this._container.classList.add(_),this}removeClassName(_){return this._container&&this._container.classList.remove(_),this}setOffset(_){return this.options.offset=_,this._update(),this}toggleClassName(_){if(this._container)return this._container.classList.toggle(_)}setSubpixelPositioning(_){this.options.subpixelPositioning=_}_createCloseButton(){this.options.closeButton&&(this._closeButton=V.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const _=this._container.querySelector(ih);_&&_.focus()}},p.RasterDEMTileSource=hr,p.RasterTileSource=$t,p.ScaleControl=class{constructor(_){this._onMove=()=>{Al(this._map,this._container,this.options)},this.setUnit=i=>{this.options.unit=i,Al(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},rh),_)}getDefaultPosition(){return"bottom-left"}onAdd(_){return this._map=_,this._container=V.create("div","maplibregl-ctrl maplibregl-ctrl-scale",_.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){V.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},p.ScrollZoomHandler=$u,p.Style=wc,p.TerrainControl=class{constructor(_){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=_}onAdd(_){return this._map=_,this._container=V.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=V.create("button","maplibregl-ctrl-terrain",this._container),V.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){V.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},p.TwoFingersTouchPitchHandler=qc,p.TwoFingersTouchRotateHandler=Xc,p.TwoFingersTouchZoomHandler=Rn,p.TwoFingersTouchZoomRotateHandler=Jc,p.VectorTileSource=Gt,p.VideoSource=Mi,p.addSourceType=(_,i)=>o._(void 0,void 0,void 0,function*(){if(en(_))throw new Error(`A source type called "${_}" already exists.`);((l,f)=>{Ri[l]=f})(_,i)}),p.clearPrewarmedResources=function(){const _=bt;_&&(_.isPreloaded()&&_.numActive()===1?(_.release(Vr),bt=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},p.createTileMesh=bc,p.getMaxParallelImageRequests=function(){return o.a.MAX_PARALLEL_IMAGE_REQUESTS},p.getRTLTextPluginStatus=function(){return yr().getRTLTextPluginStatus()},p.getVersion=function(){return nh},p.getWorkerCount=function(){return It.workerCount},p.getWorkerUrl=function(){return o.a.WORKER_URL},p.importScriptInWorkers=function(_){return ri().broadcast("IS",_)},p.prewarm=function(){cr().acquire(Vr)},p.setMaxParallelImageRequests=function(_){o.a.MAX_PARALLEL_IMAGE_REQUESTS=_},p.setRTLTextPlugin=function(_,i){return yr().setRTLTextPlugin(_,i)},p.setWorkerCount=function(_){It.workerCount=_},p.setWorkerUrl=function(_){o.a.WORKER_URL=_}});var u=t;return u})}(Md)),Md.exports}var sT=nT();const pd=Fv(sT);function jd(r,e){if(!r)throw new Error(e||"loader assertion failed.")}const Jg=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),My=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);My&&parseFloat(My[1]);const Ry=globalThis,ky=globalThis.process||{},oT=globalThis.navigator||{};function Lv(r){if(typeof window<"u"&&window.process?.type==="renderer"||typeof process<"u"&&process.versions?.electron)return!0;const t=typeof navigator<"u"&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}function Va(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process?.browser)||Lv()}function aT(r){return Va()?Lv()?"Electron":(oT.userAgent||"").indexOf("Edge")>-1?"Edge":globalThis.chrome?"Chrome":globalThis.safari?"Safari":globalThis.mozInnerScreenX?"Firefox":"Unknown":"Node"}const Nv="4.1.0";function lT(r){try{const e=window[r],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}class cT{constructor(e,t,s="sessionStorage"){this.storage=lT(s),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function hT(r){let e;return r<10?e=`${r.toFixed(2)}ms`:r<100?e=`${r.toFixed(1)}ms`:r<1e3?e=`${r.toFixed(0)}ms`:e=`${(r/1e3).toFixed(2)}s`,e}function uT(r,e=8){const t=Math.max(e-r.length,0);return`${" ".repeat(t)}${r}`}var $d;(function(r){r[r.BLACK=30]="BLACK",r[r.RED=31]="RED",r[r.GREEN=32]="GREEN",r[r.YELLOW=33]="YELLOW",r[r.BLUE=34]="BLUE",r[r.MAGENTA=35]="MAGENTA",r[r.CYAN=36]="CYAN",r[r.WHITE=37]="WHITE",r[r.BRIGHT_BLACK=90]="BRIGHT_BLACK",r[r.BRIGHT_RED=91]="BRIGHT_RED",r[r.BRIGHT_GREEN=92]="BRIGHT_GREEN",r[r.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",r[r.BRIGHT_BLUE=94]="BRIGHT_BLUE",r[r.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",r[r.BRIGHT_CYAN=96]="BRIGHT_CYAN",r[r.BRIGHT_WHITE=97]="BRIGHT_WHITE"})($d||($d={}));const dT=10;function Dy(r){return typeof r!="string"?r:(r=r.toUpperCase(),$d[r]||$d.WHITE)}function fT(r,e,t){return!Va&&typeof r=="string"&&(e&&(r=`\x1B[${Dy(e)}m${r}\x1B[39m`),t&&(r=`\x1B[${Dy(t)+dT}m${r}\x1B[49m`)),r}function pT(r,e=["constructor"]){const t=Object.getPrototypeOf(r),s=Object.getOwnPropertyNames(t),a=r;for(const u of s){const p=a[u];typeof p=="function"&&(e.find(o=>u===o)||(a[u]=p.bind(r)))}}function Qg(r,e){if(!r)throw new Error("Assertion failed")}function Ul(){let r;if(Va()&&Ry.performance)r=Ry?.performance?.now?.();else if("hrtime"in ky){const e=ky?.hrtime?.();r=e[0]*1e3+e[1]/1e6}else r=Date.now();return r}const Vl={debug:Va()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},gT={enabled:!0,level:0};function jl(){}const Oy={},Fy={once:!0};class Qh{constructor({id:e}={id:""}){this.VERSION=Nv,this._startTs=Ul(),this._deltaTs=Ul(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new cT(`__probe-${this.id}__`,gT),this.timeStamp(`${this.id} started`),pT(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Ul()-this._startTs).toPrecision(10))}getDelta(){return Number((Ul()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){if(!e)throw new Error(t||"Assertion failed")}warn(e){return this._getLogFunction(0,e,Vl.warn,arguments,Fy)}error(e){return this._getLogFunction(0,e,Vl.error,arguments)}deprecated(e,t){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${t}\` instead`)}removed(e,t){return this.error(`\`${e}\` has been removed. Use \`${t}\` instead`)}probe(e,t){return this._getLogFunction(e,t,Vl.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,Vl.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,Vl.debug||Vl.info,arguments,Fy)}table(e,t,s){return t?this._getLogFunction(e,t,console.table||jl,s&&[s],{tag:_T(t)}):jl}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||jl)}group(e,t,s={collapsed:!1}){const a=By({logLevel:e,message:t,opts:s}),{collapsed:u}=s;return a.method=(u?console.groupCollapsed:console.group)||console.info,this._getLogFunction(a)}groupCollapsed(e,t,s={}){return this.group(e,t,Object.assign({},s,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||jl)}withGroup(e,t,s){this.group(e,t)();try{s()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=zv(e)}_getLogFunction(e,t,s,a,u){if(this._shouldLog(e)){u=By({logLevel:e,message:t,args:a,opts:u}),s=s||u.method,Qg(s),u.total=this.getTotal(),u.delta=this.getDelta(),this._deltaTs=Ul();const p=u.tag||u.message;if(u.once&&p)if(!Oy[p])Oy[p]=Ul();else return jl;return t=mT(this.id,u.message,u),s.bind(console,t,...u.args)}return jl}}Qh.VERSION=Nv;function zv(r){if(!r)return 0;let e;switch(typeof r){case"number":e=r;break;case"object":e=r.logLevel||r.priority||0;break;default:return 0}return Qg(Number.isFinite(e)&&e>=0),e}function By(r){const{logLevel:e,message:t}=r;r.logLevel=zv(e);const s=r.args?Array.from(r.args):[];for(;s.length&&s.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&s.unshift(t),r.message=e;break;case"object":Object.assign(r,e);break}typeof r.message=="function"&&(r.message=r.message());const a=typeof r.message;return Qg(a==="string"||a==="object"),Object.assign(r,{args:s},r.opts)}function mT(r,e,t){if(typeof e=="string"){const s=t.time?uT(hT(t.total)):"";e=t.time?`${r}: ${s}  ${e}`:`${r}: ${e}`,e=fT(e,t.color,t.background)}return e}function _T(r){for(const e in r)for(const t in r[e])return t||"untitled";return"empty"}const Fp="4.3.3",yT=Fp[0]>="0"&&Fp[0]<="9"?`v${Fp}`:"";function bT(){const r=new Qh({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=r,globalThis.loaders.version=yT,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=r,r}const vT=bT();function xT(r,e){return Uv(r||{},e)}function Uv(r,e,t=0){if(t>3)return e;const s={...r};for(const[a,u]of Object.entries(e))u&&typeof u=="object"&&!Array.isArray(u)?s[a]=Uv(s[a]||{},e[a],t+1):s[a]=e[a];return s}const wT="latest";function TT(){return globalThis._loadersgl_?.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.3"),globalThis._loadersgl_.version}const ST=TT();function Bo(r,e){if(!r)throw new Error(e||"loaders.gl assertion failed.")}const ka=typeof process!="object"||String(process)!=="[object process]"||process.browser,AT=typeof window<"u"&&typeof window.orientation<"u",Ly=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);Ly&&parseFloat(Ly[1]);class ET{name;workerThread;isRunning=!0;result;_resolve=()=>{};_reject=()=>{};constructor(e,t){this.name=e,this.workerThread=t,this.result=new Promise((s,a)=>{this._resolve=s,this._reject=a})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){Bo(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){Bo(this.isRunning),this.isRunning=!1,this._reject(e)}}class Bp{terminate(){}}const Lp=new Map;function IT(r){Bo(r.source&&!r.url||!r.source&&r.url);let e=Lp.get(r.source||r.url);return e||(r.url&&(e=CT(r.url),Lp.set(r.url,e)),r.source&&(e=Vv(r.source),Lp.set(r.source,e))),Bo(e),e}function CT(r){if(!r.startsWith("http"))return r;const e=PT(r);return Vv(e)}function Vv(r){const e=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(e)}function PT(r){return`try {
  importScripts('${r}');
} catch (error) {
  console.error(error);
  throw error;
}`}function jv(r,e=!0,t){const s=t||new Set;if(r){if(Ny(r))s.add(r);else if(Ny(r.buffer))s.add(r.buffer);else if(!ArrayBuffer.isView(r)){if(e&&typeof r=="object")for(const a in r)jv(r[a],e,s)}}return t===void 0?Array.from(s):[]}function Ny(r){return r?r instanceof ArrayBuffer||typeof MessagePort<"u"&&r instanceof MessagePort||typeof ImageBitmap<"u"&&r instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&r instanceof OffscreenCanvas:!1}const Np=()=>{};class yg{name;source;url;terminated=!1;worker;onMessage;onError;_loadableURL="";static isSupported(){return typeof Worker<"u"&&ka||typeof Bp<"u"&&!ka}constructor(e){const{name:t,source:s,url:a}=e;Bo(s||a),this.name=t,this.source=s,this.url=a,this.onMessage=Np,this.onError=u=>console.log(u),this.worker=ka?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=Np,this.onError=Np,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||jv(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),new Error(t)}_createBrowserWorker(){this._loadableURL=IT({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){const s=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new Bp(s,{eval:!1})}else if(this.source)e=new Bp(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}}class MT{name="unnamed";source;url;maxConcurrency=1;maxMobileConcurrency=1;onDebug=()=>{};reuseWorkers=!0;props={};jobQueue=[];idleQueue=[];count=0;isDestroyed=!1;static isSupported(){return yg.isSupported()}constructor(e){this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(a,u,p)=>a.done(p),s=(a,u)=>a.error(u)){const a=new Promise(u=>(this.jobQueue.push({name:e,onMessage:t,onError:s,onStart:u}),this));return this._startQueuedJob(),await a}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const s=new ET(t.name,e);e.onMessage=a=>t.onMessage(s,a.type,a.payload),e.onError=a=>t.onError(s,a),t.onStart(s);try{await s.result}catch(a){console.error(`Worker exception: ${a}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!ka||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new yg({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return AT?this.maxMobileConcurrency:this.maxConcurrency}}const RT={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class Mo{props;workerPools=new Map;static _workerFarm;static isSupported(){return yg.isSupported()}static getWorkerFarm(e={}){return Mo._workerFarm=Mo._workerFarm||new Mo({}),Mo._workerFarm.setProps(e),Mo._workerFarm}constructor(e){this.props={...RT},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:s,url:a}=e;let u=this.workerPools.get(t);return u||(u=new MT({name:t,source:s,url:a}),u.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,u)),u}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}function kT(r,e={}){const t=e[r.id]||{},s=ka?`${r.id}-worker.js`:`${r.id}-worker-node.js`;let a=t.workerUrl;if(!a&&r.id==="compression"&&(a=e.workerUrl),e._workerType==="test"&&(ka?a=`modules/${r.module}/dist/${s}`:a=`modules/${r.module}/src/workers/${r.id}-worker-node.ts`),!a){let u=r.version;u==="latest"&&(u=wT);const p=u?`@${u}`:"";a=`https://unpkg.com/@loaders.gl/${r.module}${p}/dist/${s}`}return Bo(a),a}function DT(r,e=ST){Bo(r,"no worker provided");const t=r.version;return!(!e||!t)}function OT(r,e){return!Mo.isSupported()||!ka&&!e?._nodeWorkers?!1:r.worker&&e?.worker}async function FT(r,e,t,s,a){const u=r.id,p=kT(r,t),T=Mo.getWorkerFarm(t).getWorkerPool({name:u,url:p});t=JSON.parse(JSON.stringify(t)),s=JSON.parse(JSON.stringify(s||{}));const E=await T.startJob("process-on-worker",BT.bind(null,a));return E.postMessage("process",{input:e,options:t,context:s}),await(await E.result).result}async function BT(r,e,t,s){switch(t){case"done":e.done(s);break;case"error":e.error(new Error(s.error));break;case"process":const{id:a,input:u,options:p}=s;try{const o=await r(u,p);e.postMessage("done",{id:a,result:o})}catch(o){const T=o instanceof Error?o.message:"unknown error";e.postMessage("error",{id:a,error:T})}break;default:console.warn(`parse-with-worker unknown message ${t}`)}}function LT(r,e,t){if(t=t||r.byteLength,r.byteLength<t||e.byteLength<t)return!1;const s=new Uint8Array(r),a=new Uint8Array(e);for(let u=0;u<s.length;++u)if(s[u]!==a[u])return!1;return!0}function NT(...r){return zT(r)}function zT(r){const e=r.map(u=>u instanceof ArrayBuffer?new Uint8Array(u):u),t=e.reduce((u,p)=>u+p.byteLength,0),s=new Uint8Array(t);let a=0;for(const u of e)s.set(u,a),a+=u.byteLength;return s.buffer}async function UT(r){const e=[];for await(const t of r)e.push(t);return NT(...e)}function zy(){let r;if(typeof window<"u"&&window.performance)r=window.performance.now();else if(typeof process<"u"&&process.hrtime){const e=process.hrtime();r=e[0]*1e3+e[1]/1e6}else r=Date.now();return r}class Uy{constructor(e,t){this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=e,this.type=t,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=zy(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(zy()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class cf{constructor(e){this.stats={},this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e,t="count"){return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(const e of Object.values(this.stats))e.reset();return this}forEach(e){for(const t of Object.values(this.stats))e(t)}getTable(){const e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(e=[]){e.forEach(t=>this._getOrCreate(t))}_getOrCreate(e){const{name:t,type:s}=e;let a=this.stats[t];return a||(e instanceof Uy?a=e:a=new Uy(t,s),this.stats[t]=a),a}}let VT="";const Vy={};function jT(r){for(const e in Vy)if(r.startsWith(e)){const t=Vy[e];r=r.replace(e,t)}return!r.startsWith("http://")&&!r.startsWith("https://")&&(r=`${VT}${r}`),r}function $T(r){return r&&typeof r=="object"&&r.isBuffer}function $v(r){if($T(r))return r;if(r instanceof ArrayBuffer)return r;if(ArrayBuffer.isView(r))return r.byteOffset===0&&r.byteLength===r.buffer.byteLength?r.buffer:r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);if(typeof r=="string"){const e=r;return new TextEncoder().encode(e).buffer}if(r&&typeof r=="object"&&r._toArrayBuffer)return r._toArrayBuffer();throw new Error("toArrayBuffer")}function Wv(r){const e=r?r.lastIndexOf("/"):-1;return e>=0?r.substr(e+1):""}function WT(r){const e=r?r.lastIndexOf("/"):-1;return e>=0?r.substr(0,e):""}const HT=r=>typeof r=="boolean",Oh=r=>typeof r=="function",eu=r=>r!==null&&typeof r=="object",jy=r=>eu(r)&&r.constructor==={}.constructor,ZT=r=>!!r&&typeof r[Symbol.iterator]=="function",XT=r=>r&&typeof r[Symbol.asyncIterator]=="function",ja=r=>typeof Response<"u"&&r instanceof Response||r&&r.arrayBuffer&&r.text&&r.json,$a=r=>typeof Blob<"u"&&r instanceof Blob,qT=r=>r&&typeof r=="object"&&r.isBuffer,YT=r=>typeof ReadableStream<"u"&&r instanceof ReadableStream||eu(r)&&Oh(r.tee)&&Oh(r.cancel)&&Oh(r.getReader),GT=r=>eu(r)&&Oh(r.read)&&Oh(r.pipe)&&HT(r.readable),Hv=r=>YT(r)||GT(r);class KT extends Error{constructor(e,t){super(e),this.reason=t.reason,this.url=t.url,this.response=t.response}reason;url;response}const JT=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,QT=/^([-\w.]+\/[-\w.+]+)/;function $y(r,e){return r.toLowerCase()===e.toLowerCase()}function e2(r){const e=QT.exec(r);return e?e[1]:r}function Wy(r){const e=JT.exec(r);return e?e[1]:""}const Zv=/\?.*/;function t2(r){const e=r.match(Zv);return e&&e[0]}function em(r){return r.replace(Zv,"")}function r2(r){if(r.length<50)return r;const e=r.slice(r.length-15);return`${r.substr(0,32)}...${e}`}function hf(r){return ja(r)?r.url:$a(r)?r.name||"":typeof r=="string"?r:""}function tm(r){if(ja(r)){const e=r,t=e.headers.get("content-type")||"",s=em(e.url);return e2(t)||Wy(s)}return $a(r)?r.type||"":typeof r=="string"?Wy(r):""}function i2(r){return ja(r)?r.headers["content-length"]||-1:$a(r)?r.size:typeof r=="string"?r.length:r instanceof ArrayBuffer||ArrayBuffer.isView(r)?r.byteLength:-1}async function Xv(r){if(ja(r))return r;const e={},t=i2(r);t>=0&&(e["content-length"]=String(t));const s=hf(r),a=tm(r);a&&(e["content-type"]=a);const u=await o2(r);u&&(e["x-first-bytes"]=u),typeof r=="string"&&(r=new TextEncoder().encode(r));const p=new Response(r,{headers:e});return Object.defineProperty(p,"url",{value:s}),p}async function n2(r){if(!r.ok)throw await s2(r)}async function s2(r){const e=r2(r.url);let t=`Failed to fetch resource (${r.status}) ${r.statusText}: ${e}`;t=t.length>100?`${t.slice(0,100)}...`:t;const s={reason:r.statusText,url:r.url,response:r};try{const a=r.headers.get("Content-Type");s.reason=!r.bodyUsed&&a?.includes("application/json")?await r.json():await r.text()}catch{}return new KT(t,s)}async function o2(r){if(typeof r=="string")return`data:,${r.slice(0,5)}`;if(r instanceof Blob){const t=r.slice(0,5);return await new Promise(s=>{const a=new FileReader;a.onload=u=>s(u?.target?.result),a.readAsDataURL(t)})}if(r instanceof ArrayBuffer){const t=r.slice(0,5);return`data:base64,${a2(t)}`}return null}function a2(r){let e="";const t=new Uint8Array(r);for(let s=0;s<t.byteLength;s++)e+=String.fromCharCode(t[s]);return btoa(e)}function l2(r){return!c2(r)&&!h2(r)}function c2(r){return r.startsWith("http:")||r.startsWith("https:")}function h2(r){return r.startsWith("data:")}async function Hy(r,e){if(typeof r=="string"){const t=jT(r);return l2(t)&&globalThis.loaders?.fetchNode?globalThis.loaders?.fetchNode(t,e):await fetch(t,e)}return await Xv(r)}const Zy=new Qh({id:"loaders.gl"});class u2{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class d2{console;constructor(){this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const qv={fetch:null,mimeType:void 0,nothrow:!1,log:new d2,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:Jg,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},f2={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function Yv(){globalThis.loaders=globalThis.loaders||{};const{loaders:r}=globalThis;return r._state||(r._state={}),r._state}function Gv(){const r=Yv();return r.globalOptions=r.globalOptions||{...qv},r.globalOptions}function p2(r,e,t,s){return t=t||[],t=Array.isArray(t)?t:[t],g2(r,t),_2(e,r,s)}function g2(r,e){Xy(r,null,qv,f2,e);for(const t of e){const s=r&&r[t.id]||{},a=t.options&&t.options[t.id]||{},u=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};Xy(s,t.id,a,u,e)}}function Xy(r,e,t,s,a){const u=e||"Top level",p=e?`${e}.`:"";for(const o in r){const T=!e&&eu(r[o]),E=o==="baseUri"&&!e,C=o==="workerUrl"&&e;if(!(o in t)&&!E&&!C){if(o in s)Zy.warn(`${u} loader option '${p}${o}' no longer supported, use '${s[o]}'`)();else if(!T){const O=m2(o,a);Zy.warn(`${u} loader option '${p}${o}' not recognized. ${O}`)()}}}}function m2(r,e){const t=r.toLowerCase();let s="";for(const a of e)for(const u in a.options){if(r===u)return`Did you mean '${a.id}.${u}'?`;const p=u.toLowerCase();(t.startsWith(p)||p.startsWith(t))&&(s=s||`Did you mean '${a.id}.${u}'?`)}return s}function _2(r,e,t){const a={...r.options||{}};return y2(a,t),a.log===null&&(a.log=new u2),qy(a,Gv()),qy(a,e),a}function qy(r,e){for(const t in e)if(t in e){const s=e[t];jy(s)&&jy(r[t])?r[t]={...r[t],...e[t]}:r[t]=e[t]}}function y2(r,e){e&&!("baseUri"in r)&&(r.baseUri=e)}function rm(r){return r?(Array.isArray(r)&&(r=r[0]),Array.isArray(r?.extensions)):!1}function im(r){jd(r,"null loader"),jd(rm(r),"invalid loader");let e;return Array.isArray(r)&&(e=r[1],r=r[0],r={...r,options:{...r.options,...e}}),(r?.parseTextSync||r?.parseText)&&(r.text=!0),r.text||(r.binary=!0),r}const Kv=()=>{const r=Yv();return r.loaderRegistry=r.loaderRegistry||[],r.loaderRegistry};function b2(r){const e=Kv();r=Array.isArray(r)?r:[r];for(const t of r){const s=im(t);e.find(a=>s===a)||e.unshift(s)}}function v2(){return Kv()}const x2=/\.([^.]+)$/;async function w2(r,e=[],t,s){if(!Jv(r))return null;let a=Yy(r,e,{...t,nothrow:!0},s);if(a)return a;if($a(r)&&(r=await r.slice(0,10).arrayBuffer(),a=Yy(r,e,t,s)),!a&&!t?.nothrow)throw new Error(Qv(r));return a}function Yy(r,e=[],t,s){if(!Jv(r))return null;if(e&&!Array.isArray(e))return im(e);let a=[];e&&(a=a.concat(e)),t?.ignoreRegisteredLoaders||a.push(...v2()),S2(a);const u=T2(r,a,t,s);if(!u&&!t?.nothrow)throw new Error(Qv(r));return u}function T2(r,e,t,s){const a=hf(r),u=tm(r),p=em(a)||s?.url;let o=null,T="";return t?.mimeType&&(o=zp(e,t?.mimeType),T=`match forced by supplied MIME type ${t?.mimeType}`),o=o||A2(e,p),T=T||(o?`matched url ${p}`:""),o=o||zp(e,u),T=T||(o?`matched MIME type ${u}`:""),o=o||I2(e,r),T=T||(o?`matched initial data ${ex(r)}`:""),t?.fallbackMimeType&&(o=o||zp(e,t?.fallbackMimeType),T=T||(o?`matched fallback MIME type ${u}`:"")),T&&vT.log(1,`selectLoader selected ${o?.name}: ${T}.`),o}function Jv(r){return!(r instanceof Response&&r.status===204)}function Qv(r){const e=hf(r),t=tm(r);let s="No valid loader found (";s+=e?`${Wv(e)}, `:"no url provided, ",s+=`MIME type: ${t?`"${t}"`:"not provided"}, `;const a=r?ex(r):"";return s+=a?` first bytes: "${a}"`:"first bytes: not available",s+=")",s}function S2(r){for(const e of r)im(e)}function A2(r,e){const t=e&&x2.exec(e),s=t&&t[1];return s?E2(r,s):null}function E2(r,e){e=e.toLowerCase();for(const t of r)for(const s of t.extensions)if(s.toLowerCase()===e)return t;return null}function zp(r,e){for(const t of r)if(t.mimeTypes?.some(s=>$y(e,s))||$y(e,`application/x.${t.id}`))return t;return null}function I2(r,e){if(!e)return null;for(const t of r)if(typeof e=="string"){if(C2(e,t))return t}else if(ArrayBuffer.isView(e)){if(Gy(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&Gy(e,0,t))return t;return null}function C2(r,e){return e.testText?e.testText(r):(Array.isArray(e.tests)?e.tests:[e.tests]).some(s=>r.startsWith(s))}function Gy(r,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(a=>P2(r,e,t,a))}function P2(r,e,t,s){if(s instanceof ArrayBuffer)return LT(s,r,s.byteLength);switch(typeof s){case"function":return s(r);case"string":const a=bg(r,e,s.length);return s===a;default:return!1}}function ex(r,e=5){return typeof r=="string"?r.slice(0,e):ArrayBuffer.isView(r)?bg(r.buffer,r.byteOffset,e):r instanceof ArrayBuffer?bg(r,0,e):""}function bg(r,e,t){if(r.byteLength<e+t)return"";const s=new DataView(r);let a="";for(let u=0;u<t;u++)a+=String.fromCharCode(s.getUint8(e+u));return a}const M2=256*1024;function*R2(r,e){const t=e?.chunkSize||M2;let s=0;const a=new TextEncoder;for(;s<r.length;){const u=Math.min(r.length-s,t),p=r.slice(s,s+u);s+=u,yield a.encode(p)}}const k2=256*1024;function*D2(r,e={}){const{chunkSize:t=k2}=e;let s=0;for(;s<r.byteLength;){const a=Math.min(r.byteLength-s,t),u=new ArrayBuffer(a),p=new Uint8Array(r,s,a);new Uint8Array(u).set(p),s+=a,yield u}}const O2=1024*1024;async function*F2(r,e){const t=e?.chunkSize||O2;let s=0;for(;s<r.size;){const a=s+t,u=await r.slice(s,a).arrayBuffer();s=a,yield u}}function Ky(r,e){return Jg?B2(r,e):L2(r)}async function*B2(r,e){const t=r.getReader();let s;try{for(;;){const a=s||t.read();e?._streamReadAhead&&(s=t.read());const{done:u,value:p}=await a;if(u)return;yield $v(p)}}catch{t.releaseLock()}}async function*L2(r,e){for await(const t of r)yield $v(t)}function N2(r,e){if(typeof r=="string")return R2(r,e);if(r instanceof ArrayBuffer)return D2(r,e);if($a(r))return F2(r,e);if(Hv(r))return Ky(r,e);if(ja(r))return Ky(r.body,e);throw new Error("makeIterator")}const tx="Cannot convert supplied data type";function z2(r,e,t){if(e.text&&typeof r=="string")return r;if(qT(r)&&(r=r.buffer),r instanceof ArrayBuffer){const s=r;return e.text&&!e.binary?new TextDecoder("utf8").decode(s):s}if(ArrayBuffer.isView(r)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(r);let s=r.buffer;const a=r.byteLength||r.length;return(r.byteOffset!==0||a!==s.byteLength)&&(s=s.slice(r.byteOffset,r.byteOffset+a)),s}throw new Error(tx)}async function U2(r,e,t){const s=r instanceof ArrayBuffer||ArrayBuffer.isView(r);if(typeof r=="string"||s)return z2(r,e);if($a(r)&&(r=await Xv(r)),ja(r)){const a=r;return await n2(a),e.binary?await a.arrayBuffer():await a.text()}if(Hv(r)&&(r=N2(r,t)),ZT(r)||XT(r))return UT(r);throw new Error(tx)}function rx(r,e){const t=Gv(),s=r||t;return typeof s.fetch=="function"?s.fetch:eu(s.fetch)?a=>Hy(a,s.fetch):e?.fetch?e?.fetch:Hy}function V2(r,e,t){if(t)return t;const s={fetch:rx(e,r),...r};if(s.url){const a=em(s.url);s.baseUrl=a,s.queryString=t2(s.url),s.filename=Wv(a),s.baseUrl=WT(a)}return Array.isArray(s.loaders)||(s.loaders=null),s}function j2(r,e){if(r&&!Array.isArray(r))return r;let t;if(r&&(t=Array.isArray(r)?r:[r]),e&&e.loaders){const s=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...s]:s}return t&&t.length?t:void 0}async function Wd(r,e,t,s){e&&!Array.isArray(e)&&!rm(e)&&(s=void 0,t=e,e=void 0),r=await r,t=t||{};const a=hf(r),p=j2(e,s),o=await w2(r,p,t);return o?(t=p2(t,o,p,a),s=V2({url:a,_parse:Wd,loaders:p},t,s||null),await $2(o,r,t,s)):null}async function $2(r,e,t,s){if(DT(r),t=xT(r.options,t),ja(e)){const u=e,{ok:p,redirected:o,status:T,statusText:E,type:C,url:O}=u,$=Object.fromEntries(u.headers.entries());s.response={headers:$,ok:p,redirected:o,status:T,statusText:E,type:C,url:O}}e=await U2(e,r,t);const a=r;if(a.parseTextSync&&typeof e=="string")return a.parseTextSync(e,t,s);if(OT(r,t))return await FT(r,e,t,s,Wd);if(a.parseText&&typeof e=="string")return await a.parseText(e,t,s);if(a.parse)return await a.parse(e,t,s);throw Bo(!a.parseSync),new Error(`${r.id} loader - no parser found and worker is disabled`)}async function vg(r,e,t,s){let a,u;!Array.isArray(e)&&!rm(e)?(a=[],u=e):(a=e,u=t);const p=rx(u);let o=r;return typeof r=="string"&&(o=await p(r)),$a(r)&&(o=await p(r)),Array.isArray(a)?await Wd(o,a,u):await Wd(o,a,u)}const W2="4.3.3",H2=globalThis.loaders?.parseImageNode,xg=typeof Image<"u",wg=typeof ImageBitmap<"u",Z2=!!H2,Tg=Jg?!0:Z2;function X2(r){switch(r){case"auto":return wg||xg||Tg;case"imagebitmap":return wg;case"image":return xg;case"data":return Tg;default:throw new Error(`@loaders.gl/images: image ${r} not supported in this environment`)}}function q2(){if(wg)return"imagebitmap";if(xg)return"image";if(Tg)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function Y2(r){const e=K2(r);if(!e)throw new Error("Not an image");return e}function G2(r){switch(Y2(r)){case"data":return r;case"image":case"imagebitmap":const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=r.width,e.height=r.height,t.drawImage(r,0,0),t.getImageData(0,0,r.width,r.height);default:throw new Error("getImageData")}}function K2(r){return typeof ImageBitmap<"u"&&r instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&r instanceof Image?"image":r&&typeof r=="object"&&r.data&&r.width&&r.height?"data":null}const J2=/^data:image\/svg\+xml/,Q2=/\.svg((\?|#).*)?$/;function nm(r){return r&&(J2.test(r)||Q2.test(r))}function eS(r,e){if(nm(e)){let s=new TextDecoder().decode(r);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(s=unescape(encodeURIComponent(s)))}catch(u){throw new Error(u.message)}return`data:image/svg+xml;base64,${btoa(s)}`}return ix(r,e)}function ix(r,e){if(nm(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(r)])}async function nx(r,e,t){const s=eS(r,t),a=self.URL||self.webkitURL,u=typeof s!="string"&&a.createObjectURL(s);try{return await tS(u||s,e)}finally{u&&a.revokeObjectURL(u)}}async function tS(r,e){const t=new Image;return t.src=r,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((s,a)=>{try{t.onload=()=>s(t),t.onerror=u=>{const p=u instanceof Error?u.message:"error";a(new Error(p))}}catch(u){a(u)}})}const rS={};let Jy=!0;async function iS(r,e,t){let s;nm(t)?s=await nx(r,e,t):s=ix(r,t);const a=e&&e.imagebitmap;return await nS(s,a)}async function nS(r,e=null){if((sS(e)||!Jy)&&(e=null),e)try{return await createImageBitmap(r,e)}catch(t){console.warn(t),Jy=!1}return await createImageBitmap(r)}function sS(r){for(const e in r||rS)return!1;return!0}function oS(r){return!hS(r,"ftyp",4)||(r[8]&96)===0?null:aS(r)}function aS(r){switch(lS(r,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function lS(r,e,t){return String.fromCharCode(...r.slice(e,t))}function cS(r){return[...r].map(e=>e.charCodeAt(0))}function hS(r,e,t=0){const s=cS(e);for(let a=0;a<s.length;++a)if(s[a]!==r[a+t])return!1;return!0}const xs=!1,Fh=!0;function sx(r){const e=tu(r);return dS(e)||gS(e)||fS(e)||pS(e)||uS(e)}function uS(r){const e=new Uint8Array(r instanceof DataView?r.buffer:r),t=oS(e);return t?{mimeType:t.mimeType,width:0,height:0}:null}function dS(r){const e=tu(r);return e.byteLength>=24&&e.getUint32(0,xs)===2303741511?{mimeType:"image/png",width:e.getUint32(16,xs),height:e.getUint32(20,xs)}:null}function fS(r){const e=tu(r);return e.byteLength>=10&&e.getUint32(0,xs)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,Fh),height:e.getUint16(8,Fh)}:null}function pS(r){const e=tu(r);return e.byteLength>=14&&e.getUint16(0,xs)===16973&&e.getUint32(2,Fh)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,Fh),height:e.getUint32(22,Fh)}:null}function gS(r){const e=tu(r);if(!(e.byteLength>=3&&e.getUint16(0,xs)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:s,sofMarkers:a}=mS();let u=2;for(;u+9<e.byteLength;){const p=e.getUint16(u,xs);if(a.has(p))return{mimeType:"image/jpeg",height:e.getUint16(u+5,xs),width:e.getUint16(u+7,xs)};if(!s.has(p))return null;u+=2,u+=e.getUint16(u,xs)}return null}function mS(){const r=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)r.add(t);return{tableMarkers:r,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function tu(r){if(r instanceof DataView)return r;if(ArrayBuffer.isView(r))return new DataView(r.buffer);if(r instanceof ArrayBuffer)return new DataView(r);throw new Error("toDataView")}async function _S(r,e){const{mimeType:t}=sx(r)||{},s=globalThis.loaders?.parseImageNode;return jd(s),await s(r,t)}async function yS(r,e,t){e=e||{};const a=(e.image||{}).type||"auto",{url:u}=t||{},p=bS(a);let o;switch(p){case"imagebitmap":o=await iS(r,e,u);break;case"image":o=await nx(r,e,u);break;case"data":o=await _S(r);break;default:jd(!1)}return a==="data"&&(o=G2(o)),o}function bS(r){switch(r){case"auto":case"data":return q2();default:return X2(r),r}}const vS=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],xS=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],wS={image:{type:"auto",decode:!0}},TS={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:W2,mimeTypes:xS,extensions:vS,parse:yS,tests:[r=>!!sx(new DataView(r))],options:wS},kr=new Qh({id:"deck"});let Sg={};function SS(r){Sg=r}function cn(r,e,t,s){kr.level>0&&Sg[r]&&Sg[r].call(null,e,t,s)}function AS(r){const e=r[0],t=r[r.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}const ES={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:AS,parseTextSync:JSON.parse};function IS(){const r="9.1.13",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==r)throw new Error(`deck.gl - multiple versions detected: ${e} vs ${r}`);return e||(kr.log(1,`deck.gl ${r}`)(),globalThis.deck={...globalThis.deck,VERSION:r,version:r,log:kr,_registerLoggers:SS},b2([ES,[TS,{imagebitmap:{premultiplyAlpha:"none"}}]])),r}const CS=IS();function sm(r,e){if(!r)throw new Error(e||"shadertools: assertion failed.")}const Up={number:{type:"number",validate(r,e){return Number.isFinite(r)&&typeof e=="object"&&(e.max===void 0||r<=e.max)&&(e.min===void 0||r>=e.min)}},array:{type:"array",validate(r,e){return Array.isArray(r)||ArrayBuffer.isView(r)}}};function PS(r){const e={};for(const[t,s]of Object.entries(r))e[t]=MS(s);return e}function MS(r){let e=Qy(r);if(e!=="object")return{value:r,...Up[e],type:e};if(typeof r=="object")return r?r.type!==void 0?{...r,...Up[r.type],type:r.type}:r.value===void 0?{type:"object",value:r}:(e=Qy(r.value),{...r,...Up[e],type:e}):{type:"object",value:null};throw new Error("props")}function Qy(r){return Array.isArray(r)||ArrayBuffer.isView(r)?"array":typeof r}const RS=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,kS=`#ifdef MODULE_MATERIAL
  fragColor = material_filterColor(fragColor);
#endif

#ifdef MODULE_LIGHTING
  fragColor = lighting_filterColor(fragColor);
#endif

#ifdef MODULE_FOG
  fragColor = fog_filterColor(fragColor);
#endif

#ifdef MODULE_PICKING
  fragColor = picking_filterHighlightColor(fragColor);
  fragColor = picking_filterPickingColor(fragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`,DS={vertex:RS,fragment:kS},eb=/void\s+main\s*\([^)]*\)\s*\{\n?/,tb=/}\n?[^{}]*$/,Vp=[],Rd="__LUMA_INJECT_DECLARATIONS__";function OS(r){const e={vertex:{},fragment:{}};for(const t in r){let s=r[t];const a=FS(t);typeof s=="string"&&(s={order:0,injection:s}),e[a][t]=s}return e}function FS(r){const e=r.slice(0,2);switch(e){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(e)}}function Hd(r,e,t,s=!1){const a=e==="vertex";for(const u in t){const p=t[u];p.sort((T,E)=>T.order-E.order),Vp.length=p.length;for(let T=0,E=p.length;T<E;++T)Vp[T]=p[T].injection;const o=`${Vp.join(`
`)}
`;switch(u){case"vs:#decl":a&&(r=r.replace(Rd,o));break;case"vs:#main-start":a&&(r=r.replace(eb,T=>T+o));break;case"vs:#main-end":a&&(r=r.replace(tb,T=>o+T));break;case"fs:#decl":a||(r=r.replace(Rd,o));break;case"fs:#main-start":a||(r=r.replace(eb,T=>T+o));break;case"fs:#main-end":a||(r=r.replace(tb,T=>o+T));break;default:r=r.replace(u,T=>T+o)}}return r=r.replace(Rd,""),s&&(r=r.replace(/\}\s*$/,u=>u+DS[e])),r}function Zd(r){r.map(e=>BS(e))}function BS(r){if(r.instance)return;Zd(r.dependencies||[]);const{propTypes:e={},deprecations:t=[],inject:s={}}=r,a={normalizedInjections:OS(s),parsedDeprecations:LS(t)};e&&(a.propValidators=PS(e)),r.instance=a;let u={};e&&(u=Object.entries(e).reduce((p,[o,T])=>{const E=T?.value;return E&&(p[o]=E),p},{})),r.defaultUniforms={...r.defaultUniforms,...u}}function ox(r,e,t){r.deprecations?.forEach(s=>{s.regex?.test(e)&&(s.deprecated?t.deprecated(s.old,s.new)():t.removed(s.old,s.new)())})}function LS(r){return r.forEach(e=>{switch(e.type){case"function":e.regex=new RegExp(`\\b${e.old}\\(`);break;default:e.regex=new RegExp(`${e.type} ${e.old};`)}}),r}function om(r){Zd(r);const e={},t={};ax({modules:r,level:0,moduleMap:e,moduleDepth:t});const s=Object.keys(t).sort((a,u)=>t[u]-t[a]).map(a=>e[a]);return Zd(s),s}function ax(r){const{modules:e,level:t,moduleMap:s,moduleDepth:a}=r;if(t>=5)throw new Error("Possible loop in shader dependency graph");for(const u of e)s[u.name]=u,(a[u.name]===void 0||a[u.name]<t)&&(a[u.name]=t);for(const u of e)u.dependencies&&ax({modules:u.dependencies,level:t+1,moduleMap:s,moduleDepth:a})}function NS(r){switch(r?.gpu.toLowerCase()){case"apple":return`#define APPLE_GPU
// Apple optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Headless Chrome's software shader 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// If the GPU doesn't have full 32 bits precision, will causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function zS(r,e){if(Number(r.match(/^#version[ \t]+(\d+)/m)?.[1]||100)!==300)throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(e){case"vertex":return r=rb(r,US),r;case"fragment":return r=rb(r,VS),r;default:throw new Error(e)}}const lx=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],US=[...lx,[Ag("attribute"),"in $1"],[Ag("varying"),"out $1"]],VS=[...lx,[Ag("varying"),"in $1"]];function rb(r,e){for(const[t,s]of e)r=r.replace(t,s);return r}function Ag(r){return new RegExp(`\\b${r}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function cx(r,e){let t="";for(const s in r){const a=r[s];if(t+=`void ${a.signature} {
`,a.header&&(t+=`  ${a.header}`),e[s]){const u=e[s];u.sort((p,o)=>p.order-o.order);for(const p of u)t+=`  ${p.injection}
`}a.footer&&(t+=`  ${a.footer}`),t+=`}
`}return t}function hx(r){const e={vertex:{},fragment:{}};for(const t of r){let s,a;typeof t!="string"?(s=t,a=s.hook):(s={},a=t),a=a.trim();const[u,p]=a.split(":"),o=a.replace(/\(.+/,""),T=Object.assign(s,{signature:p});switch(u){case"vs":e.vertex[o]=T;break;case"fs":e.fragment[o]=T;break;default:throw new Error(u)}}return e}function jS(r,e){return{name:$S(r,e),language:"glsl",version:WS(r)}}function $S(r,e="unnamed"){const s=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(r);return s?s[1]:e}function WS(r){let e=100;const t=r.match(/[^\s]+/g);if(t&&t.length>=2&&t[0]==="#version"){const s=parseInt(t[1],10);Number.isFinite(s)&&(e=s)}if(e!==100&&e!==300)throw new Error(`Invalid GLSL version ${e}`);return e}const ux=`

${Rd}
`,HS=`precision highp float;
`;function ZS(r){const e=om(r.modules||[]);return{source:qS(r.platformInfo,{...r,source:r.source,stage:"vertex",modules:e}),getUniforms:dx(e)}}function XS(r){const{vs:e,fs:t}=r,s=om(r.modules||[]);return{vs:ib(r.platformInfo,{...r,source:e,stage:"vertex",modules:s}),fs:ib(r.platformInfo,{...r,source:t,stage:"fragment",modules:s}),getUniforms:dx(s)}}function qS(r,e){const{source:t,stage:s,modules:a,hookFunctions:u=[],inject:p={},log:o}=e;sm(typeof t=="string","shader source must be a string");const T=t;let E="";const C=hx(u),O={},$={},V={};for(const we in p){const Pe=typeof p[we]=="string"?{injection:p[we],order:0}:p[we],je=/^(v|f)s:(#)?([\w-]+)$/.exec(we);if(je){const Ze=je[2],Le=je[3];Ze?Le==="decl"?$[we]=[Pe]:V[we]=[Pe]:O[we]=[Pe]}else V[we]=[Pe]}const ie=a;for(const we of ie){o&&ox(we,T,o);const Pe=fx(we,"wgsl");E+=Pe;const je=we.injections?.[s]||{};for(const Ze in je){const Le=/^(v|f)s:#([\w-]+)$/.exec(Ze);if(Le){const et=Le[2]==="decl"?$:V;et[Ze]=et[Ze]||[],et[Ze].push(je[Ze])}else O[Ze]=O[Ze]||[],O[Ze].push(je[Ze])}}return E+=ux,E=Hd(E,s,$),E+=cx(C[s],O),E+=T,E=Hd(E,s,V),E}function ib(r,e){const{id:t,source:s,stage:a,language:u="glsl",modules:p,defines:o={},hookFunctions:T=[],inject:E={},prologue:C=!0,log:O}=e;sm(typeof s=="string","shader source must be a string");const $=u==="glsl"?jS(s).version:-1,V=r.shaderLanguageVersion,ie=$===100?"#version 100":"#version 300 es",Pe=s.split(`
`).slice(1).join(`
`),je={};p.forEach(ct=>{Object.assign(je,ct.defines)}),Object.assign(je,o);let Ze="";switch(u){case"wgsl":break;case"glsl":Ze=C?`${ie}

// ----- PROLOGUE -------------------------
${YS({id:t,source:s,stage:a})}
${`#define SHADER_TYPE_${a.toUpperCase()}`}

${NS(r)}
${a==="fragment"?HS:""}

// ----- APPLICATION DEFINES -------------------------

${GS(je)}

`:`${ie}
`;break}const Le=hx(T),Ue={},et={},Ke={};for(const ct in E){const me=typeof E[ct]=="string"?{injection:E[ct],order:0}:E[ct],_e=/^(v|f)s:(#)?([\w-]+)$/.exec(ct);if(_e){const ze=_e[2],Qe=_e[3];ze?Qe==="decl"?et[ct]=[me]:Ke[ct]=[me]:Ue[ct]=[me]}else Ke[ct]=[me]}for(const ct of p){O&&ox(ct,Pe,O);const me=fx(ct,a);Ze+=me;const _e=ct.instance?.normalizedInjections[a]||{};for(const ze in _e){const Qe=/^(v|f)s:#([\w-]+)$/.exec(ze);if(Qe){const mt=Qe[2]==="decl"?et:Ke;mt[ze]=mt[ze]||[],mt[ze].push(_e[ze])}else Ue[ze]=Ue[ze]||[],Ue[ze].push(_e[ze])}}return Ze+="// ----- MAIN SHADER SOURCE -------------------------",Ze+=ux,Ze=Hd(Ze,a,et),Ze+=cx(Le[a],Ue),Ze+=Pe,Ze=Hd(Ze,a,Ke),u==="glsl"&&$!==V&&(Ze=zS(Ze,a)),Ze.trim()}function dx(r){return function(t){const s={};for(const a of r){const u=a.getUniforms?.(t,s);Object.assign(s,u)}return s}}function YS(r){const{id:e,source:t,stage:s}=r;return e&&t.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${e}_${s}`:""}function GS(r={}){let e="";for(const t in r){const s=r[t];(s||Number.isFinite(s))&&(e+=`#define ${t.toUpperCase()} ${r[t]}
`)}return e}function fx(r,e){let t;switch(e){case"vertex":t=r.vs||"";break;case"fragment":t=r.fs||"";break;case"wgsl":t=r.source||"";break;default:sm(!1)}if(!r.name)throw new Error("Shader module must have a name");const s=r.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");let a=`// ----- MODULE ${r.name} ---------------

`;return e!=="wgsl"&&(a+=`#define MODULE_${s}
`),a+=`${t}
`,a}const KS=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,JS=/^\s*\#\s*endif\s*$/;function QS(r,e){const t=r.split(`
`),s=[];let a=!0,u=null;for(const p of t){const o=p.match(KS),T=p.match(JS);o?(u=o[1],a=!!e?.defines?.[u]):T?a=!0:a&&s.push(p)}return s.join(`
`)}class Ma{static defaultShaderAssembler;_hookFunctions=[];_defaultModules=[];static getDefaultShaderAssembler(){return Ma.defaultShaderAssembler=Ma.defaultShaderAssembler||new Ma,Ma.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(t=>t.name===(typeof e=="string"?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){const t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(s=>s.name!==t)}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){const t=this._getModuleList(e.modules),s=this._hookFunctions,{source:a,getUniforms:u}=ZS({...e,source:e.source,modules:t,hookFunctions:s});return{source:e.platformInfo.shaderLanguage==="wgsl"?QS(a):a,getUniforms:u,modules:t}}assembleGLSLShaderPair(e){const t=this._getModuleList(e.modules),s=this._hookFunctions;return{...XS({...e,vs:e.vs,fs:e.fs,modules:t,hookFunctions:s}),modules:t}}_getModuleList(e=[]){const t=new Array(this._defaultModules.length+e.length),s={};let a=0;for(let u=0,p=this._defaultModules.length;u<p;++u){const o=this._defaultModules[u],T=o.name;t[a++]=o,s[T]=!0}for(let u=0,p=e.length;u<p;++u){const o=e[u],T=o.name;s[T]||(t[a++]=o,s[T]=!0)}return t.length=a,Zd(t),t}}const eA=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,tA=`#version 300 es
${eA}`;function rA(r){const{input:e,inputChannels:t,output:s}={};if(!e)return tA;if(!t)throw new Error("inputChannels");const a=iA(t),u=nA(e,t);return`#version 300 es
in ${a} ${e};
out vec4 ${s};
void main() {
  ${s} = ${u};
}`}function iA(r){switch(r){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${r}`)}}function nA(r,e){switch(e){case 1:return`vec4(${r}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${r}, 0.0, 1.0)`;case 3:return`vec4(${r}, 1.0)`;case 4:return r;default:throw new Error(`invalid channels: ${e}`)}}class sA{stats=new Map;getStats(e){return this.get(e)}get(e){return this.stats.has(e)||this.stats.set(e,new cf({id:e})),this.stats.get(e)}}const px=new sA,ot=new Qh({id:"luma.gl"}),jp={};function uf(r="id"){jp[r]=jp[r]||1;const e=jp[r]++;return`${r}-${e}`}let Pr=class{static defaultProps={id:"undefined",handle:void 0,userData:void 0};toString(){return`${this[Symbol.toStringTag]||this.constructor.name}:"${this.id}"`}id;props;userData={};_device;destroyed=!1;allocatedBytes=0;_attachedResources=new Set;constructor(e,t,s){if(!e)throw new Error("no device");this._device=e,this.props=oA(t,s);const a=this.props.id!=="undefined"?this.props.id:uf(this[Symbol.toStringTag]);this.props.id=a,this.id=a,this.userData=this.props.userData||{},this.addStats()}destroy(){this.destroyResource()}delete(){return this.destroy(),this}getProps(){return this.props}attachResource(e){this._attachedResources.add(e)}detachResource(e){this._attachedResources.delete(e)}destroyAttachedResource(e){this._attachedResources.delete(e)&&e.destroy()}destroyAttachedResources(){for(const e of Object.values(this._attachedResources))e.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get(`${t}s Active`).decrementCount()}trackAllocatedMemory(e,t=this[Symbol.toStringTag]){const s=this._device.statsManager.getStats("Resource Counts");s.get("GPU Memory").addCount(e),s.get(`${t} Memory`).addCount(e),this.allocatedBytes=e}trackDeallocatedMemory(e=this[Symbol.toStringTag]){const t=this._device.statsManager.getStats("Resource Counts");t.get("GPU Memory").subtractCount(this.allocatedBytes),t.get(`${e} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get("Resources Created").incrementCount(),e.get(`${t}s Created`).incrementCount(),e.get(`${t}s Active`).incrementCount()}};function oA(r,e){const t={...e};for(const s in r)r[s]!==void 0&&(t[s]=r[s]);return t}class Ur extends Pr{static defaultProps={...Pr.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",mappedAtCreation:!1};static MAP_READ=1;static MAP_WRITE=2;static COPY_SRC=4;static COPY_DST=8;static INDEX=16;static VERTEX=32;static UNIFORM=64;static STORAGE=128;static INDIRECT=256;static QUERY_RESOLVE=512;get[Symbol.toStringTag](){return"Buffer"}usage;indexType;updateTimestamp;constructor(e,t){const s={...t};(t.usage||0)&Ur.INDEX&&!t.indexType&&(t.data instanceof Uint32Array?s.indexType="uint32":t.data instanceof Uint16Array&&(s.indexType="uint16")),delete s.data,super(e,s,Ur.defaultProps),this.usage=s.usage||0,this.indexType=s.indexType,this.updateTimestamp=e.incrementTimestamp()}clone(e){return this.device.createBuffer({...this.props,...e})}readSyncWebGL(e,t){throw new Error("not implemented")}static DEBUG_DATA_MAX_LENGTH=32;debugData=new ArrayBuffer(0);_setDebugData(e,t,s){const a=ArrayBuffer.isView(e)?e.buffer:e,u=Math.min(e?e.byteLength:s,Ur.DEBUG_DATA_MAX_LENGTH);a===null?this.debugData=new ArrayBuffer(u):t===0&&s===a.byteLength?this.debugData=a.slice(0,u):this.debugData=a.slice(t,t+u)}}function gx(r){const e=nb[r],t=aA(e),s=r.includes("norm"),a=!s&&!r.startsWith("float"),u=r.startsWith("s");return{dataType:nb[r],byteLength:t,integer:a,signed:u,normalized:s}}function aA(r){return lA[r]}const nb={uint8:"uint8",sint8:"sint8",unorm8:"uint8",snorm8:"sint8",uint16:"uint16",sint16:"sint16",unorm16:"uint16",snorm16:"sint16",float16:"float16",float32:"float32",uint32:"uint32",sint32:"sint32"},lA={uint8:1,sint8:1,uint16:2,sint16:2,float16:2,float32:4,uint32:4,sint32:4},Ki="texture-compression-bc",Ir="texture-compression-astc",ys="texture-compression-etc2",cA="texture-compression-etc1-webgl",gd="texture-compression-pvrtc-webgl",$p="texture-compression-atc-webgl",md="float32-renderable-webgl",Wp="float16-renderable-webgl",hA="rgb9e5ufloat-renderable-webgl",Hp="snorm8-renderable-webgl",Ah="norm16-renderable-webgl",Zp="snorm16-renderable-webgl",_d="float32-filterable",sb="float16-filterable-webgl";function mx(r){const e=uA[r];if(!e)throw new Error(`Unsupported texture format ${r}`);return e}const uA={r8unorm:{},r8snorm:{render:Hp},r8uint:{},r8sint:{},rg8unorm:{},rg8snorm:{render:Hp},rg8uint:{},rg8sint:{},r16uint:{},r16sint:{},r16float:{render:Wp,filter:"float16-filterable-webgl"},"r16unorm-webgl":{f:Ah},"r16snorm-webgl":{f:Zp},"rgba4unorm-webgl":{channels:"rgba",bitsPerChannel:[4,4,4,4],packed:!0},"rgb565unorm-webgl":{channels:"rgb",bitsPerChannel:[5,6,5,0],packed:!0},"rgb5a1unorm-webgl":{channels:"rgba",bitsPerChannel:[5,5,5,1],packed:!0},"rgb8unorm-webgl":{},"rgb8snorm-webgl":{},rgba8unorm:{},"rgba8unorm-srgb":{},rgba8snorm:{render:Hp},rgba8uint:{},rgba8sint:{},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{},rg16sint:{},rg16float:{render:Wp,filter:sb},"rg16unorm-webgl":{render:Ah},"rg16snorm-webgl":{render:Zp},r32uint:{},r32sint:{},r32float:{render:md,filter:_d},rgb9e5ufloat:{channels:"rgb",packed:!0,render:hA},rg11b10ufloat:{channels:"rgb",bitsPerChannel:[11,11,10,0],packed:!0,p:1,render:md},rgb10a2unorm:{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1},"rgb10a2uint-webgl":{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1,wgpu:!1},"rgb16unorm-webgl":{f:Ah},"rgb16snorm-webgl":{f:Ah},rg32uint:{},rg32sint:{},rg32float:{render:!1,filter:_d},rgba16uint:{},rgba16sint:{},rgba16float:{render:Wp,filter:sb},"rgba16unorm-webgl":{render:Ah},"rgba16snorm-webgl":{render:Zp},"rgb32float-webgl":{render:md,filter:_d},rgba32uint:{},rgba32sint:{},rgba32float:{render:md,filter:_d},stencil8:{attachment:"stencil",bitsPerChannel:[8,0,0,0],dataType:"uint8"},depth16unorm:{attachment:"depth",bitsPerChannel:[16,0,0,0],dataType:"uint16"},depth24plus:{attachment:"depth",bitsPerChannel:[24,0,0,0],dataType:"uint32"},depth32float:{attachment:"depth",bitsPerChannel:[32,0,0,0],dataType:"float32"},"depth24plus-stencil8":{attachment:"depth-stencil",bitsPerChannel:[24,8,0,0],packed:!0},"depth32float-stencil8":{attachment:"depth-stencil",bitsPerChannel:[32,8,0,0],packed:!0},"bc1-rgb-unorm-webgl":{f:Ki},"bc1-rgb-unorm-srgb-webgl":{f:Ki},"bc1-rgba-unorm":{f:Ki},"bc1-rgba-unorm-srgb":{f:Ki},"bc2-rgba-unorm":{f:Ki},"bc2-rgba-unorm-srgb":{f:Ki},"bc3-rgba-unorm":{f:Ki},"bc3-rgba-unorm-srgb":{f:Ki},"bc4-r-unorm":{f:Ki},"bc4-r-snorm":{f:Ki},"bc5-rg-unorm":{f:Ki},"bc5-rg-snorm":{f:Ki},"bc6h-rgb-ufloat":{f:Ki},"bc6h-rgb-float":{f:Ki},"bc7-rgba-unorm":{f:Ki},"bc7-rgba-unorm-srgb":{f:Ki},"etc2-rgb8unorm":{f:ys},"etc2-rgb8unorm-srgb":{f:ys},"etc2-rgb8a1unorm":{f:ys},"etc2-rgb8a1unorm-srgb":{f:ys},"etc2-rgba8unorm":{f:ys},"etc2-rgba8unorm-srgb":{f:ys},"eac-r11unorm":{f:ys},"eac-r11snorm":{f:ys},"eac-rg11unorm":{f:ys},"eac-rg11snorm":{f:ys},"astc-4x4-unorm":{f:Ir},"astc-4x4-unorm-srgb":{f:Ir},"astc-5x4-unorm":{f:Ir},"astc-5x4-unorm-srgb":{f:Ir},"astc-5x5-unorm":{f:Ir},"astc-5x5-unorm-srgb":{f:Ir},"astc-6x5-unorm":{f:Ir},"astc-6x5-unorm-srgb":{f:Ir},"astc-6x6-unorm":{f:Ir},"astc-6x6-unorm-srgb":{f:Ir},"astc-8x5-unorm":{f:Ir},"astc-8x5-unorm-srgb":{f:Ir},"astc-8x6-unorm":{f:Ir},"astc-8x6-unorm-srgb":{f:Ir},"astc-8x8-unorm":{f:Ir},"astc-8x8-unorm-srgb":{f:Ir},"astc-10x5-unorm":{f:Ir},"astc-10x5-unorm-srgb":{f:Ir},"astc-10x6-unorm":{f:Ir},"astc-10x6-unorm-srgb":{f:Ir},"astc-10x8-unorm":{f:Ir},"astc-10x8-unorm-srgb":{f:Ir},"astc-10x10-unorm":{f:Ir},"astc-10x10-unorm-srgb":{f:Ir},"astc-12x10-unorm":{f:Ir},"astc-12x10-unorm-srgb":{f:Ir},"astc-12x12-unorm":{f:Ir},"astc-12x12-unorm-srgb":{f:Ir},"pvrtc-rgb4unorm-webgl":{f:gd},"pvrtc-rgba4unorm-webgl":{f:gd},"pvrtc-rbg2unorm-webgl":{f:gd},"pvrtc-rgba2unorm-webgl":{f:gd},"etc1-rbg-unorm-webgl":{f:cA},"atc-rgb-unorm-webgl":{f:$p},"atc-rgba-unorm-webgl":{f:$p},"atc-rgbai-unorm-webgl":{f:$p}},dA=["bc1","bc2","bc3","bc4","bc5","bc6","bc7","etc1","etc2","eac","atc","astc","pvrtc"],fA=/^(r|rg|rgb|rgba|bgra)([0-9]*)([a-z]*)(-srgb)?(-webgl)?$/;function _x(r){return dA.some(e=>r.startsWith(e))}function am(r){let e=pA(r);if(_x(r)){e.channels="rgb",e.components=3,e.bytesPerPixel=1,e.srgb=!1,e.compressed=!0;const s=gA(r);s&&(e.blockWidth=s.blockWidth,e.blockHeight=s.blockHeight)}const t=fA.exec(r);if(t){const[,s,a,u,p,o]=t,T=`${u}${a}`,E=gx(T),C=E.byteLength*8,O=s.length,$=[C,O>=2?C:0,O>=3?C:0,O>=4?C:0];e={format:r,attachment:e.attachment,dataType:E.dataType,components:O,channels:s,integer:E.integer,signed:E.signed,normalized:E.normalized,bitsPerChannel:$,bytesPerPixel:E.byteLength*s.length,packed:e.packed,srgb:e.srgb},o==="-webgl"&&(e.webgl=!0),p==="-srgb"&&(e.srgb=!0)}return r.endsWith("-webgl")&&(e.webgl=!0),r.endsWith("-srgb")&&(e.srgb=!0),e}function pA(r){const e=mx(r),t=e.bytesPerPixel||1,s=e.bitsPerChannel||[8,8,8,8];return delete e.bitsPerChannel,delete e.bytesPerPixel,delete e.f,delete e.render,delete e.filter,delete e.blend,delete e.store,{...e,format:r,attachment:e.attachment||"color",channels:e.channels||"r",components:e.components||e.channels?.length||1,bytesPerPixel:t,bitsPerChannel:s,dataType:e.dataType||"uint8",srgb:e.srgb??!1,packed:e.packed??!1,webgl:e.webgl??!1,integer:e.integer??!1,signed:e.signed??!1,normalized:e.normalized??!1,compressed:e.compressed??!1}}function gA(r){const t=/.*-(\d+)x(\d+)-.*/.exec(r);if(t){const[,s,a]=t;return{blockWidth:Number(s),blockHeight:Number(a)}}return null}function mA(r){const e=mx(r),t={format:r,create:e.f??!0,render:e.render??!0,filter:e.filter??!0,blend:e.blend??!0,store:e.store??!0},s=am(r),a=r.startsWith("depth")||r.startsWith("stencil"),u=s?.signed,p=s?.integer,o=s?.webgl;return t.render&&=!u,t.filter&&=!a&&!u&&!p&&!o,t}class _A{}class yA{features;disabledFeatures;constructor(e=[],t){this.features=new Set(e),this.disabledFeatures=t||{}}*[Symbol.iterator](){yield*this.features}has(e){return!this.disabledFeatures?.[e]&&this.features.has(e)}}class Oo{static defaultProps={id:null,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,createCanvasContext:void 0,onError:e=>ot.error(e.message)(),_reuseDevices:!1,_requestMaxLimits:!0,_factoryDestroyPolicy:"unused",_initializeFeatures:!0,_disabledFeatures:{"compilation-status-async-webgl":!0},_resourceDefaults:{},webgl:{},debug:ot.get("debug")||void 0,debugShaders:ot.get("debug-shaders")||void 0,debugFramebuffers:!!ot.get("debug-framebuffers"),debugWebGL:!!ot.get("debug-webgl"),debugSpectorJS:void 0,debugSpectorJSUrl:void 0,_handle:void 0};get[Symbol.toStringTag](){return"Device"}constructor(e){this.props={...Oo.defaultProps,...e},this.id=this.props.id||uf(this[Symbol.toStringTag].toLowerCase())}id;props;userData={};statsManager=px;timestamp=0;_reused=!1;_lumaData={};getTextureFormatCapabilities(e){const t=mA(e),s=p=>(typeof p=="string"?this.features.has(p):p)??!0,a=s(t.create),u={format:e,create:a,render:a&&s(t.render),filter:a&&s(t.filter),blend:a&&s(t.blend),store:a&&s(t.store)};return this._getDeviceSpecificTextureFormatCapabilities(u)}isTextureFormatSupported(e,t){return this.getTextureFormatCapabilities(e).create}isTextureFormatFilterable(e){return this.getTextureFormatCapabilities(e).filter}isTextureFormatRenderable(e){return this.getTextureFormatCapabilities(e).render}isTextureFormatCompressed(e){return _x(e)}loseDevice(){return!1}reportError(e){this.props.onError(e)}getDefaultCanvasContext(){if(!this.canvasContext)throw new Error("Device has no default CanvasContext. See props.createCanvasContext");return this.canvasContext}createCommandEncoder(e={}){throw new Error("not implemented")}incrementTimestamp(){return this.timestamp++}onError(e){this.props.onError(e)}getCanvasContext(){return this.getDefaultCanvasContext()}readPixelsToArrayWebGL(e,t){throw new Error("not implemented")}readPixelsToBufferWebGL(e,t){throw new Error("not implemented")}setParametersWebGL(e){throw new Error("not implemented")}getParametersWebGL(e){throw new Error("not implemented")}withParametersWebGL(e,t){throw new Error("not implemented")}clearWebGL(e){throw new Error("not implemented")}resetWebGL(){throw new Error("not implemented")}static _getCanvasContextProps(e){return e.createCanvasContext===!0?{}:e.createCanvasContext}_normalizeBufferProps(e){(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});const t={...e};return(e.usage||0)&Ur.INDEX&&!e.indexType&&(e.data instanceof Uint32Array?t.indexType="uint32":e.data instanceof Uint16Array?t.indexType="uint16":ot.warn("indices buffer content must be of integer type")()),t}}const bA=Va()&&typeof document<"u",vA=()=>bA&&document.readyState==="complete",xA="set luma.log.level=1 (or higher) to trace rendering",ob="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.";class Xl{static defaultProps={...Oo.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0};static pageLoaded=wA().then(()=>{ot.probe(2,"DOM is loaded")()});stats=px;log=ot;VERSION="9.1.9";spector;preregisteredAdapters=new Map;constructor(){if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw ot.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),ot.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),new Error("luma.gl - multiple versions detected: see console log");ot.error("This version of luma.gl has already been initialized")()}ot.log(1,`${this.VERSION} - ${xA}`)(),globalThis.luma=this}registerAdapters(e){for(const t of e)this.preregisteredAdapters.set(t.type,t)}getSupportedAdapters(e=[]){const t=this.getAdapterMap(e);return Array.from(t).map(([,s])=>s).filter(s=>s.isSupported?.()).map(s=>s.type)}getBestAvailableAdapter(e=[]){const t=this.getAdapterMap(e);return t.get("webgpu")?.isSupported?.()?"webgpu":t.get("webgl")?.isSupported?.()?"webgl":null}setDefaultDeviceProps(e){Object.assign(Xl.defaultProps,e)}async createDevice(e={}){e={...Xl.defaultProps,...e},e.waitForPageLoad&&await Xl.pageLoaded;const t=this.getAdapterMap(e.adapters);let s=e.type||"";s==="best-available"&&(s=this.getBestAvailableAdapter(e.adapters)||s);const p=await(this.getAdapterMap(e.adapters)||t).get(s)?.create?.(e);if(p)return p;throw new Error(ob)}async attachDevice(e){const t=this.getAdapterMap(e.adapters);let s="";e.handle instanceof WebGL2RenderingContext&&(s="webgl"),e.createCanvasContext&&await Xl.pageLoaded,e.handle===null&&(s="unknown");const u=await t.get(s)?.attach?.(null);if(u)return u;throw new Error(ob)}enforceWebGL2(e=!0,t=[]){const a=this.getAdapterMap(t).get("webgl");a||ot.warn("enforceWebGL2: webgl adapter not found")(),a?.enforceWebGL2?.(e)}getAdapterMap(e=[]){const t=new Map(this.preregisteredAdapters);for(const s of e)t.set(s.type,s);return t}registerDevices(e){ot.warn("luma.registerDevices() is deprecated, use luma.registerAdapters() instead");for(const t of e){const s=t.adapter;s&&this.preregisteredAdapters.set(s.type,s)}}}const Eg=new Xl;function wA(){return vA()||typeof window>"u"?Promise.resolve():new Promise(r=>{window.addEventListener("load",()=>r())})}class TA{}class lm{static defaultProps={canvas:null,width:800,height:600,useDevicePixels:!0,autoResize:!0,container:null,visible:!0,alphaMode:"opaque",colorSpace:"srgb"};id;props;canvas;htmlCanvas;offscreenCanvas;type;width=1;height=1;resizeObserver;_canvasSizeInfo={clientWidth:0,clientHeight:0,devicePixelRatio:1};toString(){return`${this[Symbol.toStringTag]}(${this.id})`}constructor(e){if(this.props={...lm.defaultProps,...e},e=this.props,!Va()){this.id="node-canvas-context",this.type="node",this.width=this.props.width,this.height=this.props.height,this.canvas=null;return}if(e.canvas)typeof e.canvas=="string"?this.canvas=AA(e.canvas):this.canvas=e.canvas;else{const t=EA(e),s=SA(e?.container||null);s.insertBefore(t,s.firstChild),this.canvas=t,e?.visible||(this.canvas.style.visibility="hidden")}this.canvas instanceof HTMLCanvasElement?(this.id=this.canvas.id,this.type="html-canvas",this.htmlCanvas=this.canvas):(this.id="offscreen-canvas",this.type="offscreen-canvas",this.offscreenCanvas=this.canvas),this.canvas instanceof HTMLCanvasElement&&e.autoResize&&(this.resizeObserver=new ResizeObserver(t=>{for(const s of t)s.target===this.canvas&&this.update()}),this.resizeObserver.observe(this.canvas))}getDevicePixelRatio(e){return typeof OffscreenCanvas<"u"&&this.canvas instanceof OffscreenCanvas||(e=e===void 0?this.props.useDevicePixels:e,!e||e<=0)?1:e===!0?typeof window<"u"&&window.devicePixelRatio||1:e}getPixelSize(){switch(this.type){case"node":return[this.width,this.height];case"offscreen-canvas":return[this.canvas.width,this.canvas.height];case"html-canvas":const e=this.getDevicePixelRatio(),t=this.canvas;return t.parentElement?[t.clientWidth*e,t.clientHeight*e]:[this.canvas.width,this.canvas.height];default:throw new Error(this.type)}}getAspect(){const[e,t]=this.getPixelSize();return e/t}cssToDeviceRatio(){try{const[e]=this.getDrawingBufferSize(),t=this._canvasSizeInfo.clientWidth||this.htmlCanvas?.clientWidth;return t?e/t:1}catch{return 1}}cssToDevicePixels(e,t=!0){const s=this.cssToDeviceRatio(),[a,u]=this.getDrawingBufferSize();return IA(e,s,a,u,t)}setDevicePixelRatio(e,t={}){if(!this.htmlCanvas)return;let s="width"in t?t.width:this.htmlCanvas.clientWidth,a="height"in t?t.height:this.htmlCanvas.clientHeight;(!s||!a)&&(ot.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,s=this.htmlCanvas.width||1,a=this.htmlCanvas.height||1);const u=this._canvasSizeInfo;if(u.clientWidth!==s||u.clientHeight!==a||u.devicePixelRatio!==e){let p=e;const o=Math.floor(s*p),T=Math.floor(a*p);if(this.htmlCanvas.width=o,this.htmlCanvas.height=T,this.device.gl){const[C,O]=this.getDrawingBufferSize();(C!==o||O!==T)&&(p=Math.min(C/s,O/a),this.htmlCanvas.width=Math.floor(s*p),this.htmlCanvas.height=Math.floor(a*p),ot.warn("Device pixel ratio clamped")()),this._canvasSizeInfo.clientWidth=s,this._canvasSizeInfo.clientHeight=a,this._canvasSizeInfo.devicePixelRatio=e}}}getDrawingBufferSize(){const e=this.device.gl;return e?[e.drawingBufferWidth,e.drawingBufferHeight]:this.getPixelSize()}_setAutoCreatedCanvasId(e){this.htmlCanvas?.id==="lumagl-auto-created-canvas"&&(this.htmlCanvas.id=e)}}function SA(r){if(typeof r=="string"){const e=document.getElementById(r);if(!e)throw new Error(`${r} is not an HTML element`);return e}else if(r)return r;return document.body}function AA(r){const e=document.getElementById(r);if(!(e instanceof HTMLCanvasElement))throw new Error("Object is not a canvas element");return e}function EA(r){const{width:e,height:t}=r,s=document.createElement("canvas");return s.id=uf("lumagl-auto-created-canvas"),s.width=e||1,s.height=t||1,s.style.width=Number.isFinite(e)?`${e}px`:"100%",s.style.height=Number.isFinite(t)?`${t}px`:"100%",s}function IA(r,e,t,s,a){const u=r,p=ab(u[0],e,t);let o=lb(u[1],e,s,a),T=ab(u[0]+1,e,t);const E=T===t-1?T:T-1;T=lb(u[1]+1,e,s,a);let C;return a?(T=T===0?T:T+1,C=o,o=T):C=T===s-1?T:T-1,{x:p,y:o,width:Math.max(E-p+1,1),height:Math.max(C-o+1,1)}}function ab(r,e,t){return Math.min(Math.round(r*e),t-1)}function lb(r,e,t,s){return s?Math.max(0,t-1-Math.round(r*e)):Math.min(Math.round(r*e),t-1)}class Cr extends Pr{static COPY_SRC=1;static COPY_DST=2;static TEXTURE=4;static STORAGE=8;static RENDER_ATTACHMENT=16;static CubeFaces=["+X","-X","+Y","-Y","+Z","-Z"];static defaultProps={...Pr.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",width:void 0,height:void 0,depth:1,mipmaps:!1,compressed:!1,usage:0,mipLevels:void 0,samples:void 0,sampler:{},view:void 0,flipY:void 0};get[Symbol.toStringTag](){return"Texture"}toString(){return`Texture(${this.id},${this.format},${this.width}x${this.height})`}dimension;format;width;height;depth;mipLevels;updateTimestamp;constructor(e,t){if(t=Cr.normalizeProps(e,t),super(e,t,Cr.defaultProps),this.dimension=this.props.dimension,this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,this.props.width===void 0||this.props.height===void 0){const s=Cr.getTextureDataSize(this.props.data);this.width=s?.width||1,this.height=s?.height||1}this.props.mipmaps&&this.props.mipLevels===void 0&&(this.props.mipLevels="pyramid"),this.mipLevels=this.props.mipLevels==="pyramid"?Cr.getMipLevelCount(this.width,this.height):this.props.mipLevels||1,this.updateTimestamp=e.incrementTimestamp()}clone(e){return this.device.createTexture({...this.props,...e})}static isExternalImage(e){return typeof ImageData<"u"&&e instanceof ImageData||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement||typeof VideoFrame<"u"&&e instanceof VideoFrame||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas}static getExternalImageSize(e){if(typeof ImageData<"u"&&e instanceof ImageData||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas)return{width:e.width,height:e.height};if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement)return{width:e.naturalWidth,height:e.naturalHeight};if(typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement)return{width:e.videoWidth,height:e.videoHeight};if(typeof VideoFrame<"u"&&e instanceof VideoFrame)return{width:e.displayWidth,height:e.displayHeight};throw new Error("Unknown image type")}static isTextureLevelData(e){const t=e?.data;return ArrayBuffer.isView(t)}static getTextureDataSize(e){if(!e||ArrayBuffer.isView(e))return null;if(Array.isArray(e))return Cr.getTextureDataSize(e[0]);if(Cr.isExternalImage(e))return Cr.getExternalImageSize(e);if(e&&typeof e=="object"&&e.constructor===Object){const s=Object.values(e)[0];return{width:s.width,height:s.height}}throw new Error("texture size deduction failed")}static normalizeTextureData(e,t){let s;return ArrayBuffer.isView(e)?s=[{data:e,width:t.width,height:t.height}]:Array.isArray(e)?s=e:s=[e],s}static getMipLevelCount(e,t){return Math.floor(Math.log2(Math.max(e,t)))+1}static getCubeFaceDepth(e){switch(e){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw new Error(e)}}static defaultCopyExternalImageOptions={image:void 0,sourceX:0,sourceY:0,width:void 0,height:void 0,depth:1,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1};static normalizeProps(e,t){const s={...t},a=e?.props?._resourceDefaults?.texture||{};Object.assign(s,a);const{width:u,height:p}=s;return typeof u=="number"&&(s.width=Math.max(1,Math.ceil(u))),typeof p=="number"&&(s.height=Math.max(1,Math.ceil(p))),s}}class df extends Pr{static defaultProps={...Pr.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0};get[Symbol.toStringTag](){return"TextureView"}constructor(e,t){super(e,t,df.defaultProps)}}function CA(r,e,t){let s="";const a=e.split(/\r?\n/),u=r.slice().sort((p,o)=>p.lineNum-o.lineNum);switch(t?.showSourceCode||"no"){case"all":let p=0;for(let o=1;o<=a.length;o++)for(s+=yx(a[o-1],o,t);u.length>p&&u[p].lineNum===o;){const T=u[p++];s+=cb(T,a,T.lineNum,{...t,inlineSource:!1})}return s;case"issues":case"no":for(const o of r)s+=cb(o,a,o.lineNum,{inlineSource:t?.showSourceCode!=="no"});return s}}function cb(r,e,t,s){if(s?.inlineSource){const u=PA(e,t),p=r.linePos>0?`${" ".repeat(r.linePos+5)}^^^
`:"";return`
${u}${p}${r.type.toUpperCase()}: ${r.message}

`}const a=r.type==="error"?"red":"#8B4000";return s?.html?`<div class='luma-compiler-log-error' style="color:${a};"><b> ${r.type.toUpperCase()}: ${r.message}</b></div>`:`${r.type.toUpperCase()}: ${r.message}`}function PA(r,e,t){let s="";for(let a=e-2;a<=e;a++){const u=r[a-1];u!==void 0&&(s+=yx(u,e,t))}return s}function yx(r,e,t){const s=t?.html?RA(r):r;return`${MA(String(e),4)}: ${s}${t?.html?"<br/>":`
`}`}function MA(r,e){let t="";for(let s=r.length;s<e;++s)t+=" ";return t+r}function RA(r){return r.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}class ff extends Pr{static defaultProps={...Pr.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debugShaders:void 0};get[Symbol.toStringTag](){return"Shader"}stage;source;compilationStatus="pending";constructor(e,t){t={...t,debugShaders:t.debugShaders||e.props.debugShaders||"errors"},super(e,{id:kA(t),...t},ff.defaultProps),this.stage=this.props.stage,this.source=this.props.source}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(){const e=this.props.debugShaders;switch(e){case"never":return;case"errors":if(this.compilationStatus==="success")return;break}const t=await this.getCompilationInfo();e==="warnings"&&t?.length===0||this._displayShaderLog(t)}_displayShaderLog(e){if(typeof document>"u"||!document?.createElement)return;const t=bx(this.source),s=`${this.stage} ${t}`;let a=CA(e,this.source,{showSourceCode:"all",html:!0});const u=this.getTranslatedSource();u&&(a+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${u}</pre></code>`);const p=document.createElement("Button");p.innerHTML=`
<h1>Shader Compilation Error in ${s}</h1><br /><br />
<code style="user-select:text;"><pre>
${a}
</pre></code>`,p.style.top="10px",p.style.left="10px",p.style.position="absolute",p.style.zIndex="9999",p.style.width="100%",p.style.textAlign="left",document.body.appendChild(p),document.getElementsByClassName("luma-compiler-log-error")[0]?.scrollIntoView(),p.onclick=()=>{const T=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(T)}}}function kA(r){return bx(r.source)||r.id||uf(`unnamed ${r.stage}-shader`)}function bx(r,e="unnamed"){const s=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(r);return s?s[1]:e}class Vh extends Pr{static defaultProps={...Pr.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"none",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1};get[Symbol.toStringTag](){return"Sampler"}constructor(e,t){t=Vh.normalizeProps(e,t),super(e,t,Vh.defaultProps)}static normalizeProps(e,t){const s=e?.props?._resourceDefaults?.sampler||{};return{...t,...s}}}class pf extends Pr{static defaultProps={...Pr.defaultProps,width:1,height:1,colorAttachments:[],depthStencilAttachment:null};get[Symbol.toStringTag](){return"Framebuffer"}width;height;constructor(e,t={}){super(e,t,pf.defaultProps),this.width=this.props.width,this.height=this.props.height}clone(e){const t=this.colorAttachments.map(a=>a.texture.clone(e)),s=this.depthStencilAttachment&&this.depthStencilAttachment.texture.clone(e);return this.device.createFramebuffer({...this.props,colorAttachments:t,depthStencilAttachment:s})}resize(e){let t=!e;if(e){const[s,a]=Array.isArray(e)?e:[e.width,e.height];t=t||a!==this.height||s!==this.width,this.width=s,this.height=a}t&&(ot.log(2,`Resizing framebuffer ${this.id} to ${this.width}x${this.height}`)(),this.resizeAttachments(this.width,this.height))}autoCreateAttachmentTextures(){if(this.props.colorAttachments.length===0&&!this.props.depthStencilAttachment)throw new Error("Framebuffer has noattachments");this.colorAttachments=this.props.colorAttachments.map((t,s)=>{if(typeof t=="string"){const a=this.createColorTexture(t,s);return this.attachResource(a),a.view}return t instanceof Cr?t.view:t});const e=this.props.depthStencilAttachment;if(e)if(typeof e=="string"){const t=this.createDepthStencilTexture(e);this.attachResource(t),this.depthStencilAttachment=t.view}else e instanceof Cr?this.depthStencilAttachment=e.view:this.depthStencilAttachment=e}createColorTexture(e,t){return this.device.createTexture({id:`${this.id}-color-attachment-${t}`,usage:Cr.RENDER_ATTACHMENT,format:e,width:this.width,height:this.height,sampler:{magFilter:"linear",minFilter:"linear"}})}createDepthStencilTexture(e){return this.device.createTexture({id:`${this.id}-depth-stencil-attachment`,usage:Cr.RENDER_ATTACHMENT,format:e,width:this.width,height:this.height,mipmaps:!1})}resizeAttachments(e,t){for(let s=0;s<this.colorAttachments.length;++s)if(this.colorAttachments[s]){const a=this.colorAttachments[s].texture.clone({width:e,height:t});this.destroyAttachedResource(this.colorAttachments[s]),this.colorAttachments[s]=a.view,this.attachResource(a.view)}if(this.depthStencilAttachment){const s=this.depthStencilAttachment.texture.clone({width:e,height:t});this.destroyAttachedResource(this.depthStencilAttachment),this.depthStencilAttachment=s.view,this.attachResource(s)}this.updateAttachments()}}class ic extends Pr{static defaultProps={...Pr.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",parameters:{},bindings:{},uniforms:{}};get[Symbol.toStringTag](){return"RenderPipeline"}shaderLayout;bufferLayout;linkStatus="pending";hash="";constructor(e,t){super(e,t,ic.defaultProps),this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}setUniformsWebGL(e){throw new Error("Use uniform blocks")}}class Pa extends Pr{static defaultClearColor=[0,0,0,1];static defaultClearDepth=1;static defaultClearStencil=0;static defaultProps={...Pr.defaultProps,framebuffer:null,parameters:void 0,clearColor:Pa.defaultClearColor,clearColors:void 0,clearDepth:Pa.defaultClearDepth,clearStencil:Pa.defaultClearStencil,depthReadOnly:!1,stencilReadOnly:!1,discard:!1,occlusionQuerySet:void 0,timestampQuerySet:void 0,beginTimestampIndex:void 0,endTimestampIndex:void 0};get[Symbol.toStringTag](){return"RenderPass"}constructor(e,t){t=Pa.normalizeProps(e,t),super(e,t,Pa.defaultProps)}static normalizeProps(e,t){return{...e.props._resourceDefaults?.renderPass,...t}}}class Xd extends Pr{static defaultProps={...Pr.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0};get[Symbol.toStringTag](){return"ComputePipeline"}hash="";shaderLayout;constructor(e,t){super(e,t,Xd.defaultProps),this.shaderLayout=t.shaderLayout}}class cm extends Pr{static defaultProps={...Pr.defaultProps,measureExecutionTime:void 0};get[Symbol.toStringTag](){return"CommandEncoder"}constructor(e,t){super(e,t,cm.defaultProps)}}class hm extends Pr{static defaultProps={...Pr.defaultProps};get[Symbol.toStringTag](){return"CommandBuffer"}constructor(e,t){super(e,t,hm.defaultProps)}}function DA(r){const[e,t]=FA[r],s=e==="i32"||e==="u32",a=e!=="u32",u=BA[e]*t,p=OA(e,t);return{dataType:e,components:t,defaultVertexFormat:p,byteLength:u,integer:s,signed:a}}function OA(r,e){let t;switch(r){case"f32":t="float32";break;case"i32":t="sint32";break;case"u32":t="uint32";break;case"f16":return e<=2?"float16x2":"float16x4"}return e===1?t:`${t}x${e}`}const FA={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},BA={f32:4,f16:2,i32:4,u32:4};function vx(r){let e;r.endsWith("-webgl")&&(r.replace("-webgl",""),e=!0);const[t,s]=r.split("x"),a=t,u=s?parseInt(s):1,p=gx(a),o={type:a,components:u,byteLength:p.byteLength*u,integer:p.integer,signed:p.signed,normalized:p.normalized};return e&&(o.webglOnly=!0),o}function xx(r,e){const t={};for(const s of r.attributes){const a=NA(r,e,s.name);a&&(t[s.name]=a)}return t}function LA(r,e,t=16){const s=xx(r,e),a=new Array(t).fill(null);for(const u of Object.values(s))a[u.location]=u;return a}function NA(r,e,t){const s=zA(r,t),a=UA(e,t);if(!s)return null;const u=DA(s.type),p=a?.vertexFormat||u.defaultVertexFormat,o=vx(p);return{attributeName:a?.attributeName||s.name,bufferName:a?.bufferName||s.name,location:s.location,shaderType:s.type,shaderDataType:u.dataType,shaderComponents:u.components,vertexFormat:p,bufferDataType:o.type,bufferComponents:o.components,normalized:o.normalized,integer:u.integer,stepMode:a?.stepMode||s.stepMode||"vertex",byteOffset:a?.byteOffset||0,byteStride:a?.byteStride||0}}function zA(r,e){const t=r.attributes.find(s=>s.name===e);return t||ot.warn(`shader layout attribute "${e}" not present in shader`),t||null}function UA(r,e){VA(r);let t=jA(r,e);return t||(t=$A(r,e),t)?t:(ot.warn(`layout for attribute "${e}" not present in buffer layout`),null)}function VA(r){for(const e of r)(e.attributes&&e.format||!e.attributes&&!e.format)&&ot.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}function jA(r,e){for(const t of r)if(t.format&&t.name===e)return{attributeName:t.name,bufferName:e,stepMode:t.stepMode,vertexFormat:t.format,byteOffset:0,byteStride:t.byteStride||0};return null}function $A(r,e){for(const t of r){let s=t.byteStride;if(typeof t.byteStride!="number")for(const u of t.attributes||[]){const p=vx(u.format);s+=p.byteLength}const a=t.attributes?.find(u=>u.attribute===e);if(a)return{attributeName:a.attribute,bufferName:t.name,stepMode:t.stepMode,vertexFormat:a.format,byteOffset:a.byteOffset,byteStride:s}}return null}class um extends Pr{static defaultProps={...Pr.defaultProps,renderPipeline:null};get[Symbol.toStringTag](){return"VertexArray"}maxVertexAttributes;attributeInfos;indexBuffer=null;attributes;constructor(e,t){super(e,t,um.defaultProps),this.maxVertexAttributes=e.limits.maxVertexAttributes,this.attributes=new Array(this.maxVertexAttributes).fill(null);const{shaderLayout:s,bufferLayout:a}=t.renderPipeline||{};if(!s||!a)throw new Error("VertexArray");this.attributeInfos=LA(s,a,this.maxVertexAttributes)}setConstantWebGL(e,t){this.device.reportError(new Error("constant attributes not supported"))}}class dm extends Pr{static defaultProps={...Pr.defaultProps,layout:void 0,buffers:{}};get[Symbol.toStringTag](){return"TransformFeedback"}constructor(e,t){super(e,t,dm.defaultProps)}}class fm extends Pr{static defaultProps={...Pr.defaultProps,type:void 0,count:void 0};get[Symbol.toStringTag](){return"QuerySet"}constructor(e,t){super(e,t,fm.defaultProps)}}const WA={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};function HA(r){return WA[r]}function ZA(r,e){switch(e){case 1:return r;case 2:return r+r%2;default:return r+(4-r%4)%4}}let yd;function wx(r){return(!yd||yd.byteLength<r)&&(yd=new ArrayBuffer(r)),yd}function XA(r,e){const t=wx(r.BYTES_PER_ELEMENT*e);return new r(t,0,e)}function qA(r){return ArrayBuffer.isView(r)&&!(r instanceof DataView)}function qd(r){return Array.isArray(r)?r.length===0||typeof r[0]=="number":qA(r)}const hb=1024;class YA{layout={};byteLength;constructor(e){let t=0;for(const[a,u]of Object.entries(e)){const p=HA(u),{type:o,components:T}=p;t=ZA(t,T);const E=t;t+=T,this.layout[a]={type:o,size:T,offset:E}}t+=(4-t%4)%4;const s=t*4;this.byteLength=Math.max(s,hb)}getData(e){const t=Math.max(this.byteLength,hb),s=wx(t),a={i32:new Int32Array(s),u32:new Uint32Array(s),f32:new Float32Array(s),f16:new Uint16Array(s)};for(const[u,p]of Object.entries(e)){const o=this.layout[u];if(!o){ot.warn(`Supplied uniform value ${u} not present in uniform block layout`)();continue}const{type:T,size:E,offset:C}=o,O=a[T];if(E===1){if(typeof p!="number"&&typeof p!="boolean"){ot.warn(`Supplied value for single component uniform ${u} is not a number: ${p}`)();continue}O[C]=Number(p)}else{if(!qd(p)){ot.warn(`Supplied value for multi component / array uniform ${u} is not a numeric array: ${p}`)();continue}O.set(p,C)}}return new Uint8Array(s)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}function GA(r,e,t=16){if(r!==e)return!1;const s=r,a=e;if(!qd(s))return!1;if(qd(a)&&s.length===a.length){for(let u=0;u<s.length;++u)if(a[u]!==s[u])return!1}return!0}function KA(r){return qd(r)?r.slice():r}class JA{name;uniforms={};modifiedUniforms={};modified=!0;bindingLayout={};needsRedraw="initialized";constructor(e){if(this.name=e?.name||"unnamed",e?.name&&e?.shaderLayout){const t=e?.shaderLayout.bindings?.find(a=>a.type==="uniform"&&a.name===e?.name);if(!t)throw new Error(e?.name);const s=t;for(const a of s.uniforms||[])this.bindingLayout[a.name]=a}}setUniforms(e){for(const[t,s]of Object.entries(e))this._setUniform(t,s),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${s}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){GA(this.uniforms[e],t)||(this.uniforms[e]=KA(t),this.modifiedUniforms[e]=!0,this.modified=!0)}}class QA{uniformBlocks=new Map;uniformBufferLayouts=new Map;uniformBuffers=new Map;constructor(e){for(const[t,s]of Object.entries(e)){const a=t,u=new YA(s.uniformTypes||{});this.uniformBufferLayouts.set(a,u);const p=new JA({name:t});p.setUniforms(s.defaultUniforms||{}),this.uniformBlocks.set(a,p)}}destroy(){for(const e of this.uniformBuffers.values())e.destroy()}setUniforms(e){for(const[t,s]of Object.entries(e))this.uniformBlocks.get(t)?.setUniforms(s);this.updateUniformBuffers()}getUniformBufferByteLength(e){return this.uniformBufferLayouts.get(e)?.byteLength||0}getUniformBufferData(e){const t=this.uniformBlocks.get(e)?.getAllUniforms()||{};return this.uniformBufferLayouts.get(e)?.getData(t)}createUniformBuffer(e,t,s){s&&this.setUniforms(s);const a=this.getUniformBufferByteLength(t),u=e.createBuffer({usage:Ur.UNIFORM|Ur.COPY_DST,byteLength:a}),p=this.getUniformBufferData(t);return u.write(p),u}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){const s=this.getUniformBufferByteLength(t),a=e.createBuffer({usage:Ur.UNIFORM|Ur.COPY_DST,byteLength:s});this.uniformBuffers.set(t,a)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(const t of this.uniformBlocks.keys()){const s=this.updateUniformBuffer(t);e||=s}return e&&ot.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){const t=this.uniformBlocks.get(e);let s=this.uniformBuffers.get(e),a=!1;if(s&&t?.needsRedraw){a||=t.needsRedraw;const u=this.getUniformBufferData(e);s=this.uniformBuffers.get(e),s?.write(u);const p=this.uniformBlocks.get(e)?.getAllUniforms();ot.log(4,`Writing to uniform buffer ${String(e)}`,u,p)()}return a}}function Tx(r){const e=ArrayBuffer.isView(r)?r.constructor:r;switch(e){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw new Error(e.constructor.name)}}function Sx(r){switch(r){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw new Error(r)}}function eE(r,e,t){if(!e||e>4)throw new Error(`size ${e}`);const s=e;let a=Tx(r);if(a==="uint8"&&t&&s===1)return"unorm8-webgl";if(a==="uint8"&&t&&s===3)return"unorm8x3-webgl";if(a==="uint8"||a==="sint8"){if(s===1||s===3)throw new Error(`size: ${e}`);return t&&(a=a.replace("int","norm")),`${a}x${s}`}if(a==="uint16"||a==="sint16"){if(s===1||s===3)throw new Error(`size: ${e}`);return t&&(a=a.replace("int","norm")),`${a}x${s}`}return s===1?a:`${a}x${s}`}class Xp{bufferLayouts;constructor(e){this.bufferLayouts=e}getBufferLayout(e){return this.bufferLayouts.find(t=>t.name===e)||null}getAttributeNamesForBuffer(e){return e.attributes?e.attributes?.map(t=>t.attribute):[e.name]}mergeBufferLayouts(e,t){const s=[...e];for(const a of t){const u=s.findIndex(p=>p.name===a.name);u<0?s.push(a):s[u]=a}return s}getBufferIndex(e){const t=this.bufferLayouts.findIndex(s=>s.name===e);return t===-1&&ot.warn(`BufferLayout: Missing buffer for "${e}".`)(),t}}function tE(r,e){const t=Object.fromEntries(r.attributes.map(a=>[a.name,a.location])),s=e.slice();return s.sort((a,u)=>{const p=a.attributes?a.attributes.map(C=>C.attribute):[a.name],o=u.attributes?u.attributes.map(C=>C.attribute):[u.name],T=Math.min(...p.map(C=>t[C])),E=Math.min(...o.map(C=>t[C]));return T-E}),s}class On{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}get isPointer(){return!1}getTypeName(){return this.name}}class ub{constructor(e,t,s){this.name=e,this.type=t,this.attributes=s,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Ro extends On{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class Fo extends On{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}getTypeName(){return`array<${this.format.getTypeName()}, ${this.count}>`}}class Ig extends On{constructor(e,t,s){super(e,s),this.format=t}get isPointer(){return!0}getTypeName(){return`&${this.format.getTypeName()}`}}class La extends On{constructor(e,t,s,a){super(e,s),this.format=t,this.access=a}get isTemplate(){return!0}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}var Po;(r=>{r[r.Uniform=0]="Uniform",r[r.Storage=1]="Storage",r[r.Texture=2]="Texture",r[r.Sampler=3]="Sampler",r[r.StorageTexture=4]="StorageTexture"})(Po||(Po={}));class bd{constructor(e,t,s,a,u,p,o){this.name=e,this.type=t,this.group=s,this.binding=a,this.attributes=u,this.resourceType=p,this.access=o}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class rE{constructor(e,t){this.name=e,this.type=t}}class iE{constructor(e,t,s,a){this.name=e,this.type=t,this.locationType=s,this.location=a,this.interpolation=null}}class db{constructor(e,t,s,a){this.name=e,this.type=t,this.locationType=s,this.location=a}}class nE{constructor(e,t,s,a){this.name=e,this.type=t,this.attributes=s,this.id=a}}class sE{constructor(e,t,s){this.name=e,this.type=t,this.attributes=s}}class oE{constructor(e,t=null,s){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=s}}class aE{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}const Ax=new Float32Array(1),lE=new Int32Array(Ax.buffer),Ji=new Uint16Array(1);function cE(r){Ax[0]=r;const e=lE[0],t=e>>31&1;let s=e>>23&255,a=8388607&e;if(s===255)return Ji[0]=t<<15|31744|(a!==0?512:0),Ji[0];if(s===0){if(a===0)return Ji[0]=t<<15,Ji[0];a|=8388608;let u=113;for(;!(8388608&a);)a<<=1,u--;return s=127-u,a&=8388607,s>0?(a=(a>>126-s)+(a>>127-s&1),Ji[0]=t<<15|s<<10|a>>13,Ji[0]):(Ji[0]=t<<15,Ji[0])}return s=s-127+15,s>=31?(Ji[0]=t<<15|31744,Ji[0]):s<=0?s<-10?(Ji[0]=t<<15,Ji[0]):(a=(8388608|a)>>1-s,Ji[0]=t<<15|a>>13,Ji[0]):(a>>=13,Ji[0]=t<<15|s<<10|a,Ji[0])}const pm=new Uint32Array(1),Ex=new Float32Array(pm.buffer,0,1);function fb(r){const e=112+(r>>6&31)<<23|(63&r)<<17;return pm[0]=e,Ex[0]}function hE(r,e,t,s,a,u,p,o,T){const E=s*(p>>=a)*(u>>=a)+t*p+e*o;switch(T){case"r8unorm":return[fr(r,E,"8unorm",1)[0]];case"r8snorm":return[fr(r,E,"8snorm",1)[0]];case"r8uint":return[fr(r,E,"8uint",1)[0]];case"r8sint":return[fr(r,E,"8sint",1)[0]];case"rg8unorm":{const C=fr(r,E,"8unorm",2);return[C[0],C[1]]}case"rg8snorm":{const C=fr(r,E,"8snorm",2);return[C[0],C[1]]}case"rg8uint":{const C=fr(r,E,"8uint",2);return[C[0],C[1]]}case"rg8sint":{const C=fr(r,E,"8sint",2);return[C[0],C[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{const C=fr(r,E,"8unorm",4);return[C[0],C[1],C[2],C[3]]}case"rgba8snorm":{const C=fr(r,E,"8snorm",4);return[C[0],C[1],C[2],C[3]]}case"rgba8uint":{const C=fr(r,E,"8uint",4);return[C[0],C[1],C[2],C[3]]}case"rgba8sint":{const C=fr(r,E,"8sint",4);return[C[0],C[1],C[2],C[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{const C=fr(r,E,"8unorm",4);return[C[2],C[1],C[0],C[3]]}case"r16uint":return[fr(r,E,"16uint",1)[0]];case"r16sint":return[fr(r,E,"16sint",1)[0]];case"r16float":return[fr(r,E,"16float",1)[0]];case"rg16uint":{const C=fr(r,E,"16uint",2);return[C[0],C[1]]}case"rg16sint":{const C=fr(r,E,"16sint",2);return[C[0],C[1]]}case"rg16float":{const C=fr(r,E,"16float",2);return[C[0],C[1]]}case"rgba16uint":{const C=fr(r,E,"16uint",4);return[C[0],C[1],C[2],C[3]]}case"rgba16sint":{const C=fr(r,E,"16sint",4);return[C[0],C[1],C[2],C[3]]}case"rgba16float":{const C=fr(r,E,"16float",4);return[C[0],C[1],C[2],C[3]]}case"r32uint":return[fr(r,E,"32uint",1)[0]];case"r32sint":return[fr(r,E,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[fr(r,E,"32float",1)[0]];case"rg32uint":{const C=fr(r,E,"32uint",2);return[C[0],C[1]]}case"rg32sint":{const C=fr(r,E,"32sint",2);return[C[0],C[1]]}case"rg32float":{const C=fr(r,E,"32float",2);return[C[0],C[1]]}case"rgba32uint":{const C=fr(r,E,"32uint",4);return[C[0],C[1],C[2],C[3]]}case"rgba32sint":{const C=fr(r,E,"32sint",4);return[C[0],C[1],C[2],C[3]]}case"rgba32float":{const C=fr(r,E,"32float",4);return[C[0],C[1],C[2],C[3]]}case"rg11b10ufloat":{const C=new Uint32Array(r.buffer,E,1)[0],O=(4192256&C)>>11,$=(4290772992&C)>>22;return[fb(2047&C),fb(O),function(V){const ie=112+(V>>5&31)<<23|(31&V)<<18;return pm[0]=ie,Ex[0]}($),1]}}return null}function fr(r,e,t,s){const a=[0,0,0,0];for(let E=0;E<s;++E)switch(t){case"8unorm":a[E]=r[e]/255,e++;break;case"8snorm":a[E]=r[e]/255*2-1,e++;break;case"8uint":a[E]=r[e],e++;break;case"8sint":a[E]=r[e]-127,e++;break;case"16uint":a[E]=r[e]|r[e+1]<<8,e+=2;break;case"16sint":a[E]=(r[e]|r[e+1]<<8)-32768,e+=2;break;case"16float":a[E]=(u=r[e]|r[e+1]<<8,p=void 0,o=void 0,T=void 0,p=(32768&u)>>15,T=1023&u,(o=(31744&u)>>10)==0?(p?-1:1)*Math.pow(2,-14)*(T/Math.pow(2,10)):o==31?T?NaN:1/0*(p?-1:1):(p?-1:1)*Math.pow(2,o-15)*(1+T/Math.pow(2,10))),e+=2;break;case"32uint":case"32sint":a[E]=r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24,e+=4;break;case"32float":a[E]=new Float32Array(r.buffer,e,1)[0],e+=4}var u,p,o,T;return a}function xr(r,e,t,s,a){for(let u=0;u<s;++u)switch(t){case"8unorm":r[e]=255*a[u],e++;break;case"8snorm":r[e]=.5*(a[u]+1)*255,e++;break;case"8uint":r[e]=a[u],e++;break;case"8sint":r[e]=a[u]+127,e++;break;case"16uint":new Uint16Array(r.buffer,e,1)[0]=a[u],e+=2;break;case"16sint":new Int16Array(r.buffer,e,1)[0]=a[u],e+=2;break;case"16float":{const p=cE(a[u]);new Uint16Array(r.buffer,e,1)[0]=p,e+=2;break}case"32uint":new Uint32Array(r.buffer,e,1)[0]=a[u],e+=4;break;case"32sint":new Int32Array(r.buffer,e,1)[0]=a[u],e+=4;break;case"32float":new Float32Array(r.buffer,e,1)[0]=a[u],e+=4}return a}const qp={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};class Nn{constructor(){this.id=Nn._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(e){e(this)}searchBlock(e,t){if(e){t(Yd.instance);for(const s of e)s instanceof Array?this.searchBlock(s,t):s.search(t);t(Gd.instance)}}constEvaluate(e,t){throw new Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}}Nn._id=0;class Yd extends Nn{}Yd.instance=new Yd;class Gd extends Nn{}Gd.instance=new Gd;const Ix=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);class Zr extends Nn{constructor(){super()}}class jh extends Zr{constructor(e,t,s,a,u,p){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=s,this.body=a,this.startLine=u,this.endLine=p}get astNodeType(){return"function"}search(e){if(this.attributes)for(const t of this.attributes)e(t);e(this);for(const t of this.args)e(t);this.searchBlock(this.body,e)}}class uE extends Zr{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class Cx extends Zr{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Cg extends Zr{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class Px extends Zr{constructor(e,t,s,a){super(),this.init=e,this.condition=t,this.increment=s,this.body=a}get astNodeType(){return"for"}search(e){var t,s,a;(t=this.init)===null||t===void 0||t.search(e),(s=this.condition)===null||s===void 0||s.search(e),(a=this.increment)===null||a===void 0||a.search(e),this.searchBlock(this.body,e)}}class Ws extends Zr{constructor(e,t,s,a,u){super(),this.attributes=null,this.name=e,this.type=t,this.storage=s,this.access=a,this.value=u}get astNodeType(){return"var"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class gm extends Zr{constructor(e,t,s){super(),this.attributes=null,this.name=e,this.type=t,this.value=s}get astNodeType(){return"override"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class Bh extends Zr{constructor(e,t,s,a,u){super(),this.attributes=null,this.name=e,this.type=t,this.storage=s,this.access=a,this.value=u}get astNodeType(){return"let"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class kd extends Zr{constructor(e,t,s,a,u){super(),this.attributes=null,this.name=e,this.type=t,this.storage=s,this.access=a,this.value=u}get astNodeType(){return"const"}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}var ql,Ph,ke,Se;(r=>{r.increment="++",r.decrement="--"})(ql||(ql={})),(r=>{r.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for IncrementOperator");return r[t]}})(ql||(ql={}));class Mx extends Zr{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(r=>{r.assign="=",r.addAssign="+=",r.subtractAssin="-=",r.multiplyAssign="*=",r.divideAssign="/=",r.moduloAssign="%=",r.andAssign="&=",r.orAssign="|=",r.xorAssign="^=",r.shiftLeftAssign="<<=",r.shiftRightAssign=">>="})(Ph||(Ph={})),(r=>{r.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for AssignOperator");return t}})(Ph||(Ph={}));class Rx extends Zr{constructor(e,t,s){super(),this.operator=e,this.variable=t,this.value=s}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class mm extends Zr{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}isBuiltin(){return Ix.has(this.name)}search(e){for(const t of this.args)t.search(e);e(this)}}class kx extends Zr{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}}class Dx extends Zr{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return"switch"}search(e){e(this);for(const t of this.cases)t.search(e)}}class Ox extends Zr{constructor(e,t,s,a){super(),this.condition=e,this.body=t,this.elseif=s,this.else=a}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class Fx extends Zr{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class dE extends Zr{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class fE extends Zr{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class Bx extends Zr{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class _m extends Zr{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class pE extends Zr{constructor(){super()}get astNodeType(){return"discard"}}class Lx extends Zr{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}}class Nx extends Zr{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}}class Ge extends Zr{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if(t.name==="f32")return t;for(let s=1;s<e.length;++s){const a=Ge._priority.get(t.name);Ge._priority.get(e[s].name)<a&&(t=e[s])}return t.name==="x32"?Ge.i32:t}getTypeName(){return this.name}}Ge.x32=new Ge("x32"),Ge.f32=new Ge("f32"),Ge.i32=new Ge("i32"),Ge.u32=new Ge("u32"),Ge.f16=new Ge("f16"),Ge.bool=new Ge("bool"),Ge.void=new Ge("void"),Ge._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class pb extends Ge{constructor(e){super(e)}}class js extends Ge{constructor(e,t,s,a){super(e),this.members=t,this.startLine=s,this.endLine=a}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}search(e){for(const t of this.members)e(t)}}class Ie extends Ge{constructor(e,t,s){super(e),this.format=t,this.access=s}get astNodeType(){return"template"}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}Ie.vec2f=new Ie("vec2",Ge.f32,null),Ie.vec3f=new Ie("vec3",Ge.f32,null),Ie.vec4f=new Ie("vec4",Ge.f32,null),Ie.vec2i=new Ie("vec2",Ge.i32,null),Ie.vec3i=new Ie("vec3",Ge.i32,null),Ie.vec4i=new Ie("vec4",Ge.i32,null),Ie.vec2u=new Ie("vec2",Ge.u32,null),Ie.vec3u=new Ie("vec3",Ge.u32,null),Ie.vec4u=new Ie("vec4",Ge.u32,null),Ie.vec2h=new Ie("vec2",Ge.f16,null),Ie.vec3h=new Ie("vec3",Ge.f16,null),Ie.vec4h=new Ie("vec4",Ge.f16,null),Ie.vec2b=new Ie("vec2",Ge.bool,null),Ie.vec3b=new Ie("vec3",Ge.bool,null),Ie.vec4b=new Ie("vec4",Ge.bool,null),Ie.mat2x2f=new Ie("mat2x2",Ge.f32,null),Ie.mat2x3f=new Ie("mat2x3",Ge.f32,null),Ie.mat2x4f=new Ie("mat2x4",Ge.f32,null),Ie.mat3x2f=new Ie("mat3x2",Ge.f32,null),Ie.mat3x3f=new Ie("mat3x3",Ge.f32,null),Ie.mat3x4f=new Ie("mat3x4",Ge.f32,null),Ie.mat4x2f=new Ie("mat4x2",Ge.f32,null),Ie.mat4x3f=new Ie("mat4x3",Ge.f32,null),Ie.mat4x4f=new Ie("mat4x4",Ge.f32,null),Ie.mat2x2h=new Ie("mat2x2",Ge.f16,null),Ie.mat2x3h=new Ie("mat2x3",Ge.f16,null),Ie.mat2x4h=new Ie("mat2x4",Ge.f16,null),Ie.mat3x2h=new Ie("mat3x2",Ge.f16,null),Ie.mat3x3h=new Ie("mat3x3",Ge.f16,null),Ie.mat3x4h=new Ie("mat3x4",Ge.f16,null),Ie.mat4x2h=new Ie("mat4x2",Ge.f16,null),Ie.mat4x3h=new Ie("mat4x3",Ge.f16,null),Ie.mat4x4h=new Ie("mat4x4",Ge.f16,null),Ie.mat2x2i=new Ie("mat2x2",Ge.i32,null),Ie.mat2x3i=new Ie("mat2x3",Ge.i32,null),Ie.mat2x4i=new Ie("mat2x4",Ge.i32,null),Ie.mat3x2i=new Ie("mat3x2",Ge.i32,null),Ie.mat3x3i=new Ie("mat3x3",Ge.i32,null),Ie.mat3x4i=new Ie("mat3x4",Ge.i32,null),Ie.mat4x2i=new Ie("mat4x2",Ge.i32,null),Ie.mat4x3i=new Ie("mat4x3",Ge.i32,null),Ie.mat4x4i=new Ie("mat4x4",Ge.i32,null),Ie.mat2x2u=new Ie("mat2x2",Ge.u32,null),Ie.mat2x3u=new Ie("mat2x3",Ge.u32,null),Ie.mat2x4u=new Ie("mat2x4",Ge.u32,null),Ie.mat3x2u=new Ie("mat3x2",Ge.u32,null),Ie.mat3x3u=new Ie("mat3x3",Ge.u32,null),Ie.mat3x4u=new Ie("mat3x4",Ge.u32,null),Ie.mat4x2u=new Ie("mat4x2",Ge.u32,null),Ie.mat4x3u=new Ie("mat4x3",Ge.u32,null),Ie.mat4x4u=new Ie("mat4x4",Ge.u32,null);class Dd extends Ge{constructor(e,t,s,a){super(e),this.storage=t,this.type=s,this.access=a}get astNodeType(){return"pointer"}}class Lh extends Ge{constructor(e,t,s,a){super(e),this.attributes=t,this.format=s,this.count=a}get astNodeType(){return"array"}get isArray(){return!0}}class Mh extends Ge{constructor(e,t,s){super(e),this.format=t,this.access=s}get astNodeType(){return"sampler"}}class is extends Nn{constructor(){super(),this.postfix=null}}class Na extends is{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}}class vs extends is{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class ym extends is{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return"callExpr"}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return Ix.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(const t of this.args)t.search(e);e(this)}}class An extends is{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class zx extends is{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}constEvaluate(e,t){if(this.initializer){const s=e.evalExpression(this.initializer,e.context);return s!==null&&this.postfix?s.getSubData(e,this.postfix,e.context):s}return null}search(e){this.initializer.search(e)}}class Ii extends is{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return"literalExpr"}constEvaluate(e,t){return t!==void 0&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof Te}get isVector(){return this.value instanceof ne||this.value instanceof Ot}get scalarValue(){return this.value instanceof Te?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof ne||this.value instanceof Ot?this.value.data:(console.error("Value is not a vector or matrix."),new Float32Array(0))}}class Ux extends is{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class nc extends is{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class Vx extends is{constructor(){super()}}class _i extends Vx{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class Qn extends Vx{constructor(e,t,s){super(),this.operator=e,this.left=t,this.right=s}get astNodeType(){return"binaryOp"}_getPromotedType(e,t){return e.name===t.name?e:e.name==="f32"||t.name==="f32"?Ge.f32:e.name==="u32"||t.name==="u32"?Ge.u32:Ge.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class jx extends Nn{constructor(e){super(),this.body=e}search(e){e(this),this.searchBlock(this.body,e)}}class Od extends is{constructor(){super()}get astNodeType(){return"default"}}class $x extends jx{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class Wx extends jx{constructor(e){super(e)}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class gb extends Nn{constructor(e,t,s){super(),this.name=e,this.type=t,this.attributes=s}get astNodeType(){return"argument"}}class gE extends Nn{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class mb extends Nn{constructor(e,t,s){super(),this.name=e,this.type=t,this.attributes=s}get astNodeType(){return"member"}}class Hx extends Nn{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}class Ln{constructor(e,t){this.parent=null,this.typeInfo=e,this.parent=t,this.id=Ln._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,s,a){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,t,s){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.getTypeName()}>`}}Ln._id=0;class Pg extends Ln{constructor(){super(new On("void",null),null)}toString(){return"void"}}Pg.void=new Pg;class $l extends Ln{constructor(e){super(new Ig("pointer",e.typeInfo,null),null),this.reference=e}clone(){return this}setDataValue(e,t,s,a){this.reference.setDataValue(e,t,s,a)}getSubData(e,t,s){return t?this.reference.getSubData(e,t,s):this}toString(){return`&${this.reference.toString()}`}}class Te extends Ln{constructor(e,t,s=null){super(t,s),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:this.typeInfo.name==="x32"?e-Math.floor(e)!=0?this.data=new Float32Array([e]):this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):this.typeInfo.name==="i32"||this.typeInfo.name==="bool"?this.data=new Int32Array([e]):this.typeInfo.name==="u32"?this.data=new Uint32Array([e]):this.typeInfo.name==="f32"||this.typeInfo.name==="f16"?this.data=new Float32Array([e]):console.error("ScalarData2: Invalid type",t)}clone(){if(this.data instanceof Float32Array)return new Te(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new Te(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new Te(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(e,t,s,a){if(s)return void console.error("SetDataValue: Scalar data does not support postfix",s);if(!(t instanceof Te))return void console.error("SetDataValue: Invalid value",t);let u=t.data[0];this.typeInfo.name==="i32"||this.typeInfo.name==="u32"?u=Math.floor(u):this.typeInfo.name==="bool"&&(u=u?1:0),this.data[0]=u}getSubData(e,t,s){return t?(console.error("getSubData: Scalar data does not support postfix",t),null):this}toString(){return`${this.value}`}}function mE(r,e,t){const s=e.length;return s===2?t==="f32"?new ne(new Float32Array(e),r.getTypeInfo("vec2f")):t==="i32"||t==="bool"?new ne(new Int32Array(e),r.getTypeInfo("vec2i")):t==="u32"?new ne(new Uint32Array(e),r.getTypeInfo("vec2u")):t==="f16"?new ne(new Float32Array(e),r.getTypeInfo("vec2h")):(console.error(`getSubData: Unknown format ${t}`),null):s===3?t==="f32"?new ne(new Float32Array(e),r.getTypeInfo("vec3f")):t==="i32"||t==="bool"?new ne(new Int32Array(e),r.getTypeInfo("vec3i")):t==="u32"?new ne(new Uint32Array(e),r.getTypeInfo("vec3u")):t==="f16"?new ne(new Float32Array(e),r.getTypeInfo("vec3h")):(console.error(`getSubData: Unknown format ${t}`),null):s===4?t==="f32"?new ne(new Float32Array(e),r.getTypeInfo("vec4f")):t==="i32"||t==="bool"?new ne(new Int32Array(e),r.getTypeInfo("vec4i")):t==="u32"?new ne(new Uint32Array(e),r.getTypeInfo("vec4u")):t==="f16"?new ne(new Float32Array(e),r.getTypeInfo("vec4h")):(console.error(`getSubData: Unknown format ${t}`),null):(console.error(`getSubData: Invalid vector size ${e.length}`),null)}class ne extends Ln{constructor(e,t,s=null){if(super(t,s),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{const a=this.typeInfo.name;a==="vec2f"||a==="vec3f"||a==="vec4f"?this.data=new Float32Array(e):a==="vec2i"||a==="vec3i"||a==="vec4i"?this.data=new Int32Array(e):a==="vec2u"||a==="vec3u"||a==="vec4u"?this.data=new Uint32Array(e):a==="vec2h"||a==="vec3h"||a==="vec4h"?this.data=new Float32Array(e):a==="vec2b"||a==="vec3b"||a==="vec4b"?this.data=new Int32Array(e):a==="vec2"||a==="vec3"||a==="vec4"?this.data=new Float32Array(e):console.error(`VectorData: Invalid type ${a}`)}}clone(){if(this.data instanceof Float32Array)return new ne(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new ne(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new ne(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(e,t,s,a){s instanceof Na?console.error("TODO: Set vector postfix"):t instanceof ne?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,s){if(t===null)return this;let a=e.getTypeInfo("f32");if(this.typeInfo instanceof La)a=this.typeInfo.format||a;else{const p=this.typeInfo.name;p==="vec2f"||p==="vec3f"||p==="vec4f"?a=e.getTypeInfo("f32"):p==="vec2i"||p==="vec3i"||p==="vec4i"?a=e.getTypeInfo("i32"):p==="vec2b"||p==="vec3b"||p==="vec4b"?a=e.getTypeInfo("bool"):p==="vec2u"||p==="vec3u"||p==="vec4u"?a=e.getTypeInfo("u32"):p==="vec2h"||p==="vec3h"||p==="vec4h"?a=e.getTypeInfo("f16"):console.error(`GetSubData: Unknown type ${p}`)}let u=this;for(;t!==null&&u!==null;){if(t instanceof nc){const p=t.index;let o=-1;if(p instanceof Ii){if(!(p.value instanceof Te))return console.error(`GetSubData: Invalid array index ${p.value}`),null;o=p.value.value}else{const T=e.evalExpression(p,s);if(!(T instanceof Te))return console.error("GetSubData: Unknown index type",p),null;o=T.value}if(o<0||o>=u.data.length)return console.error("GetSubData: Index out of range",o),null;if(u.data instanceof Float32Array){const T=new Float32Array(u.data.buffer,u.data.byteOffset+4*o,1);return new Te(T,a)}if(u.data instanceof Int32Array){const T=new Int32Array(u.data.buffer,u.data.byteOffset+4*o,1);return new Te(T,a)}if(u.data instanceof Uint32Array){const T=new Uint32Array(u.data.buffer,u.data.byteOffset+4*o,1);return new Te(T,a)}throw"GetSubData: Invalid data type"}if(!(t instanceof Na))return console.error("GetSubData: Unknown postfix",t),null;{const p=t.value.toLowerCase();if(p.length===1){let T=0;if(p==="x"||p==="r")T=0;else if(p==="y"||p==="g")T=1;else if(p==="z"||p==="b")T=2;else{if(p!=="w"&&p!=="a")return console.error(`GetSubData: Unknown member ${p}`),null;T=3}if(this.data instanceof Float32Array){let E=new Float32Array(this.data.buffer,this.data.byteOffset+4*T,1);return new Te(E,a,this)}if(this.data instanceof Int32Array){let E=new Int32Array(this.data.buffer,this.data.byteOffset+4*T,1);return new Te(E,a,this)}if(this.data instanceof Uint32Array){let E=new Uint32Array(this.data.buffer,this.data.byteOffset+4*T,1);return new Te(E,a,this)}}const o=[];for(const T of p)T==="x"||T==="r"?o.push(this.data[0]):T==="y"||T==="g"?o.push(this.data[1]):T==="z"||T==="b"?o.push(this.data[2]):T==="w"||T==="a"?o.push(this.data[3]):console.error(`GetDataValue: Unknown member ${T}`);u=mE(e,o,a.name)}t=t.postfix}return u}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class Ot extends Ln{constructor(e,t,s=null){super(t,s),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new Ot(new Float32Array(this.data),this.typeInfo,null)}setDataValue(e,t,s,a){s instanceof Na?console.error("TODO: Set matrix postfix"):t instanceof Ot?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,s){if(t===null)return this;const a=this.typeInfo.name;if(e.getTypeInfo("f32"),this.typeInfo instanceof La)this.typeInfo.format;else if(a.endsWith("f"))e.getTypeInfo("f32");else if(a.endsWith("i"))e.getTypeInfo("i32");else if(a.endsWith("u"))e.getTypeInfo("u32");else{if(!a.endsWith("h"))return console.error(`GetDataValue: Unknown type ${a}`),null;e.getTypeInfo("f16")}if(t instanceof nc){const u=t.index;let p=-1;if(u instanceof Ii){if(!(u.value instanceof Te))return console.error(`GetDataValue: Invalid array index ${u.value}`),null;p=u.value.value}else{const E=e.evalExpression(u,s);if(!(E instanceof Te))return console.error("GetDataValue: Unknown index type",u),null;p=E.value}if(p<0||p>=this.data.length)return console.error("GetDataValue: Index out of range",p),null;const o=a.endsWith("h")?"h":"f";let T;if(a==="mat2x2"||a==="mat2x2f"||a==="mat2x2h"||a==="mat3x2"||a==="mat3x2f"||a==="mat3x2h"||a==="mat4x2"||a==="mat4x2f"||a==="mat4x2h")T=new ne(new Float32Array(this.data.buffer,this.data.byteOffset+2*p*4,2),e.getTypeInfo(`vec2${o}`));else if(a==="mat2x3"||a==="mat2x3f"||a==="mat2x3h"||a==="mat3x3"||a==="mat3x3f"||a==="mat3x3h"||a==="mat4x3"||a==="mat4x3f"||a==="mat4x3h")T=new ne(new Float32Array(this.data.buffer,this.data.byteOffset+3*p*4,3),e.getTypeInfo(`vec3${o}`));else{if(a!=="mat2x4"&&a!=="mat2x4f"&&a!=="mat2x4h"&&a!=="mat3x4"&&a!=="mat3x4f"&&a!=="mat3x4h"&&a!=="mat4x4"&&a!=="mat4x4f"&&a!=="mat4x4h")return console.error(`GetDataValue: Unknown type ${a}`),null;T=new ne(new Float32Array(this.data.buffer,this.data.byteOffset+4*p*4,4),e.getTypeInfo(`vec4${o}`))}return t.postfix?T.getSubData(e,t.postfix,s):T}return console.error("GetDataValue: Invalid postfix",t),null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class ei extends Ln{constructor(e,t,s=0,a=null){super(t,a),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=s}clone(){const e=new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size));return new ei(e.buffer,this.typeInfo,0,null)}setDataValue(e,t,s,a){if(t===null)return void console.log("setDataValue: NULL data.");let u=this.offset,p=this.typeInfo;for(;s;){if(s instanceof nc)if(p instanceof Fo){const o=s.index;if(o instanceof Ii){if(!(o.value instanceof Te))return void console.error(`SetDataValue: Invalid index type ${o.value}`);u+=o.value.value*p.stride}else{const T=e.evalExpression(o,a);if(!(T instanceof Te))return void console.error("SetDataValue: Unknown index type",o);u+=T.value*p.stride}p=p.format}else console.error(`SetDataValue: Type ${p.getTypeName()} is not an array`);else{if(!(s instanceof Na))return void console.error("SetDataValue: Unknown postfix type",s);{const o=s.value;if(p instanceof Ro){let T=!1;for(const E of p.members)if(E.name===o){u+=E.offset,p=E.type,T=!0;break}if(!T)return void console.error(`SetDataValue: Member ${o} not found`)}else if(p instanceof On){const T=p.getTypeName();let E=0;if(o==="x"||o==="r")E=0;else if(o==="y"||o==="g")E=1;else if(o==="z"||o==="b")E=2;else{if(o!=="w"&&o!=="a")return void console.error(`SetDataValue: Unknown member ${o}`);E=3}if(!(t instanceof Te))return void console.error("SetDataValue: Invalid value",t);const C=t.value;return T==="vec2f"?void(new Float32Array(this.buffer,u,2)[E]=C):T==="vec3f"?void(new Float32Array(this.buffer,u,3)[E]=C):T==="vec4f"?void(new Float32Array(this.buffer,u,4)[E]=C):T==="vec2i"?void(new Int32Array(this.buffer,u,2)[E]=C):T==="vec3i"?void(new Int32Array(this.buffer,u,3)[E]=C):T==="vec4i"?void(new Int32Array(this.buffer,u,4)[E]=C):T==="vec2u"?void(new Uint32Array(this.buffer,u,2)[E]=C):T==="vec3u"?void(new Uint32Array(this.buffer,u,3)[E]=C):T==="vec4u"?void(new Uint32Array(this.buffer,u,4)[E]=C):void console.error(`SetDataValue: Type ${T} is not a struct`)}}}s=s.postfix}this.setData(e,t,p,u,a)}setData(e,t,s,a,u){const p=s.getTypeName();if(p!=="f32"&&p!=="f16")if(p!=="i32"&&p!=="atomic<i32>"&&p!=="x32")if(p!=="u32"&&p!=="atomic<u32>")if(p!=="bool")if(p!=="vec2f"&&p!=="vec2h")if(p!=="vec3f"&&p!=="vec3h")if(p!=="vec4f"&&p!=="vec4h")if(p!=="vec2i")if(p!=="vec3i")if(p!=="vec4i")if(p!=="vec2u")if(p!=="vec3u")if(p!=="vec4u")if(p!=="vec2b")if(p!=="vec3b")if(p!=="vec4b")if(p!=="mat2x2f"&&p!=="mat2x2h")if(p!=="mat2x3f"&&p!=="mat2x3h")if(p!=="mat2x4f"&&p!=="mat2x4h")if(p!=="mat3x2f"&&p!=="mat3x2h")if(p!=="mat3x3f"&&p!=="mat3x3h")if(p!=="mat3x4f"&&p!=="mat3x4h")if(p!=="mat4x2f"&&p!=="mat4x2h")if(p!=="mat4x3f"&&p!=="mat4x3h")if(p!=="mat4x4f"&&p!=="mat4x4h")if(t instanceof ei){if(s===t.typeInfo)return void new Uint8Array(this.buffer,a,t.buffer.byteLength).set(new Uint8Array(t.buffer));console.error("SetDataValue: Type mismatch",p,t.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${p}`);else{const o=new Float32Array(this.buffer,a,16);t instanceof Ot?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3],o[4]=t.data[4],o[5]=t.data[5],o[6]=t.data[6],o[7]=t.data[7],o[8]=t.data[8],o[9]=t.data[9],o[10]=t.data[10],o[11]=t.data[11],o[12]=t.data[12],o[13]=t.data[13],o[14]=t.data[14],o[15]=t.data[15]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7],o[8]=t[8],o[9]=t[9],o[10]=t[10],o[11]=t[11],o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15])}else{const o=new Float32Array(this.buffer,a,12);t instanceof Ot?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3],o[4]=t.data[4],o[5]=t.data[5],o[6]=t.data[6],o[7]=t.data[7],o[8]=t.data[8],o[9]=t.data[9],o[10]=t.data[10],o[11]=t.data[11]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7],o[8]=t[8],o[9]=t[9],o[10]=t[10],o[11]=t[11])}else{const o=new Float32Array(this.buffer,a,8);t instanceof Ot?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3],o[4]=t.data[4],o[5]=t.data[5],o[6]=t.data[6],o[7]=t.data[7]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7])}else{const o=new Float32Array(this.buffer,a,12);t instanceof Ot?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3],o[4]=t.data[4],o[5]=t.data[5],o[6]=t.data[6],o[7]=t.data[7],o[8]=t.data[8],o[9]=t.data[9],o[10]=t.data[10],o[11]=t.data[11]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7],o[8]=t[8],o[9]=t[9],o[10]=t[10],o[11]=t[11])}else{const o=new Float32Array(this.buffer,a,9);t instanceof Ot?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3],o[4]=t.data[4],o[5]=t.data[5],o[6]=t.data[6],o[7]=t.data[7],o[8]=t.data[8]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7],o[8]=t[8])}else{const o=new Float32Array(this.buffer,a,6);t instanceof Ot?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3],o[4]=t.data[4],o[5]=t.data[5]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5])}else{const o=new Float32Array(this.buffer,a,8);t instanceof Ot?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3],o[4]=t.data[4],o[5]=t.data[5],o[6]=t.data[6],o[7]=t.data[7]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7])}else{const o=new Float32Array(this.buffer,a,6);t instanceof Ot?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3],o[4]=t.data[4],o[5]=t.data[5]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5])}else{const o=new Float32Array(this.buffer,a,4);t instanceof Ot?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3])}else{const o=new Uint32Array(this.buffer,a,4);t instanceof ne?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3])}else{const o=new Uint32Array(this.buffer,a,3);t instanceof ne?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2]):(o[0]=t[0],o[1]=t[1],o[2]=t[2])}else{const o=new Uint32Array(this.buffer,a,2);t instanceof ne?(o[0]=t.data[0],o[1]=t.data[1]):(o[0]=t[0],o[1]=t[1])}else{const o=new Uint32Array(this.buffer,a,4);t instanceof ne?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3])}else{const o=new Uint32Array(this.buffer,a,3);t instanceof ne?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2]):(o[0]=t[0],o[1]=t[1],o[2]=t[2])}else{const o=new Uint32Array(this.buffer,a,2);t instanceof ne?(o[0]=t.data[0],o[1]=t.data[1]):(o[0]=t[0],o[1]=t[1])}else{const o=new Int32Array(this.buffer,a,4);t instanceof ne?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3])}else{const o=new Int32Array(this.buffer,a,3);t instanceof ne?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2]):(o[0]=t[0],o[1]=t[1],o[2]=t[2])}else{const o=new Int32Array(this.buffer,a,2);t instanceof ne?(o[0]=t.data[0],o[1]=t.data[1]):(o[0]=t[0],o[1]=t[1])}else{const o=new Float32Array(this.buffer,a,4);t instanceof ne?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2],o[3]=t.data[3]):(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3])}else{const o=new Float32Array(this.buffer,a,3);t instanceof ne?(o[0]=t.data[0],o[1]=t.data[1],o[2]=t.data[2]):(o[0]=t[0],o[1]=t[1],o[2]=t[2])}else{const o=new Float32Array(this.buffer,a,2);t instanceof ne?(o[0]=t.data[0],o[1]=t.data[1]):(o[0]=t[0],o[1]=t[1])}else t instanceof Te&&(new Int32Array(this.buffer,a,1)[0]=t.value);else t instanceof Te&&(new Uint32Array(this.buffer,a,1)[0]=t.value);else t instanceof Te&&(new Int32Array(this.buffer,a,1)[0]=t.value);else t instanceof Te&&(new Float32Array(this.buffer,a,1)[0]=t.value)}getSubData(e,t,s){var a,u,p;if(t===null)return this;let o=this.offset,T=this.typeInfo;for(;t;){if(t instanceof nc){const C=t.index,O=C instanceof is?e.evalExpression(C,s):C;let $=0;if(O instanceof Te?$=O.value:typeof O=="number"?$=O:console.error("GetDataValue: Invalid index type",C),T instanceof Fo)o+=$*T.stride,T=T.format;else{const V=T.getTypeName();V==="mat4x4"||V==="mat4x4f"||V==="mat4x4h"?(o+=16*$,T=e.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${T.getTypeName()} is not an array`)}}else{if(!(t instanceof Na))return console.error("GetDataValue: Unknown postfix type",t),null;{const C=t.value;if(T instanceof Ro){let O=!1;for(const $ of T.members)if($.name===C){o+=$.offset,T=$.type,O=!0;break}if(!O)return console.error(`GetDataValue: Member ${C} not found`),null}else if(T instanceof On){const O=T.getTypeName();if(O==="vec2f"||O==="vec3f"||O==="vec4f"||O==="vec2i"||O==="vec3i"||O==="vec4i"||O==="vec2u"||O==="vec3u"||O==="vec4u"||O==="vec2b"||O==="vec3b"||O==="vec4b"||O==="vec2h"||O==="vec3h"||O==="vec4h"||O==="vec2"||O==="vec3"||O==="vec4"){if(C.length>0&&C.length<5){let $="f";const V=[];for(let ie=0;ie<C.length;++ie){const we=C[ie].toLowerCase();let Pe=0;if(we==="x"||we==="r")Pe=0;else if(we==="y"||we==="g")Pe=1;else if(we==="z"||we==="b")Pe=2;else{if(we!=="w"&&we!=="a")return console.error(`Unknown member ${C}`),null;Pe=3}if(C.length===1){if(O.endsWith("f"))return this.buffer.byteLength<o+4*Pe+4?(console.log("Insufficient buffer data"),null):new Te(new Float32Array(this.buffer,o+4*Pe,1),e.getTypeInfo("f32"),this);if(O.endsWith("h"))return new Te(new Float32Array(this.buffer,o+4*Pe,1),e.getTypeInfo("f16"),this);if(O.endsWith("i"))return new Te(new Int32Array(this.buffer,o+4*Pe,1),e.getTypeInfo("i32"),this);if(O.endsWith("b"))return new Te(new Int32Array(this.buffer,o+4*Pe,1),e.getTypeInfo("bool"),this);if(O.endsWith("u"))return new Te(new Uint32Array(this.buffer,o+4*Pe,1),e.getTypeInfo("i32"),this)}if(O==="vec2f")V.push(new Float32Array(this.buffer,o,2)[Pe]);else if(O==="vec3f"){if(o+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;const je=new Float32Array(this.buffer,o,3);V.push(je[Pe])}else if(O==="vec4f")V.push(new Float32Array(this.buffer,o,4)[Pe]);else if(O==="vec2i")$="i",V.push(new Int32Array(this.buffer,o,2)[Pe]);else if(O==="vec3i")$="i",V.push(new Int32Array(this.buffer,o,3)[Pe]);else if(O==="vec4i")$="i",V.push(new Int32Array(this.buffer,o,4)[Pe]);else if(O==="vec2u"){$="u";const je=new Uint32Array(this.buffer,o,2);V.push(je[Pe])}else O==="vec3u"?($="u",V.push(new Uint32Array(this.buffer,o,3)[Pe])):O==="vec4u"&&($="u",V.push(new Uint32Array(this.buffer,o,4)[Pe]))}return V.length===2?T=e.getTypeInfo(`vec2${$}`):V.length===3?T=e.getTypeInfo(`vec3${$}`):V.length===4?T=e.getTypeInfo(`vec4${$}`):console.error(`GetDataValue: Invalid vector length ${V.length}`),new ne(V,T,null)}return console.error(`GetDataValue: Unknown member ${C}`),null}return console.error(`GetDataValue: Type ${O} is not a struct`),null}}}t=t.postfix}const E=T.getTypeName();return E==="f32"?new Te(new Float32Array(this.buffer,o,1),T,this):E==="i32"?new Te(new Int32Array(this.buffer,o,1),T,this):E==="u32"?new Te(new Uint32Array(this.buffer,o,1),T,this):E==="vec2f"?new ne(new Float32Array(this.buffer,o,2),T,this):E==="vec3f"?new ne(new Float32Array(this.buffer,o,3),T,this):E==="vec4f"?new ne(new Float32Array(this.buffer,o,4),T,this):E==="vec2i"?new ne(new Int32Array(this.buffer,o,2),T,this):E==="vec3i"?new ne(new Int32Array(this.buffer,o,3),T,this):E==="vec4i"?new ne(new Int32Array(this.buffer,o,4),T,this):E==="vec2u"?new ne(new Uint32Array(this.buffer,o,2),T,this):E==="vec3u"?new ne(new Uint32Array(this.buffer,o,3),T,this):E==="vec4u"?new ne(new Uint32Array(this.buffer,o,4),T,this):T instanceof La&&T.name==="atomic"?((a=T.format)===null||a===void 0?void 0:a.name)==="u32"?new Te(new Uint32Array(this.buffer,o,1)[0],T.format,this):((u=T.format)===null||u===void 0?void 0:u.name)==="i32"?new Te(new Int32Array(this.buffer,o,1)[0],T.format,this):(console.error(`GetDataValue: Invalid atomic format ${(p=T.format)===null||p===void 0?void 0:p.name}`),null):new ei(this.buffer,T,o,this)}toString(){let e="";if(this.typeInfo instanceof Fo)if(this.typeInfo.format.name==="f32"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let s=1;s<t.length;++s)e+=`, ${t[s]}`}else if(this.typeInfo.format.name==="i32"){const t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let s=1;s<t.length;++s)e+=`, ${t[s]}`}else if(this.typeInfo.format.name==="u32"){const t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let s=1;s<t.length;++s)e+=`, ${t[s]}`}else if(this.typeInfo.format.name==="vec2f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let s=1;s<t.length/2;++s)e+=`, [${t[2*s]}, ${t[2*s+1]}]`}else if(this.typeInfo.format.name==="vec3f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let s=4;s<t.length;s+=4)e+=`, [${t[s]}, ${t[s+1]}, ${t[s+2]}]`}else if(this.typeInfo.format.name==="vec4f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let s=4;s<t.length;s+=4)e+=`, [${t[s]}, ${t[s+1]}, ${t[s+2]}, ${t[s+3]}]`}else e="[...]";else this.typeInfo instanceof Ro?e+="{...}":e="[...]";return e}}class $s extends Ln{constructor(e,t,s,a){super(t,null),this.data=e,this.descriptor=s,this.view=a}clone(){return new $s(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e,t;const s=this.descriptor.size;return s instanceof Array&&s.length>0?(e=s[0])!==null&&e!==void 0?e:0:s instanceof Object&&(t=s.width)!==null&&t!==void 0?t:0}get height(){var e,t;const s=this.descriptor.size;return s instanceof Array&&s.length>1?(e=s[1])!==null&&e!==void 0?e:0:s instanceof Object&&(t=s.height)!==null&&t!==void 0?t:0}get depthOrArrayLayers(){var e,t;const s=this.descriptor.size;return s instanceof Array&&s.length>2?(e=s[2])!==null&&e!==void 0?e:0:s instanceof Object&&(t=s.depthOrArrayLayers)!==null&&t!==void 0?t:0}get format(){var e;return this.descriptor&&(e=this.descriptor.format)!==null&&e!==void 0?e:"rgba8unorm"}get sampleCount(){var e;return this.descriptor&&(e=this.descriptor.sampleCount)!==null&&e!==void 0?e:1}get mipLevelCount(){var e;return this.descriptor&&(e=this.descriptor.mipLevelCount)!==null&&e!==void 0?e:1}get dimension(){var e;return this.descriptor&&(e=this.descriptor.dimension)!==null&&e!==void 0?e:"2d"}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];const t=[this.width,this.height,this.depthOrArrayLayers];for(let s=0;s<t.length;++s)t[s]=Math.max(1,t[s]>>e);return t}get texelByteSize(){const e=this.format,t=qp[e];return t?t.isDepthStencil?4:t.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){const e=this.format,t=qp[e];return!!t&&t.isDepthStencil}getGpuSize(){const e=this.format,t=qp[e],s=this.width;if(!e||s<=0||!t)return-1;const a=this.height,u=this.depthOrArrayLayers,p=this.dimension;return s/t.blockWidth*(p==="1d"?1:a/t.blockHeight)*t.bytesPerBlock*u}getPixel(e,t,s=0,a=0){const u=this.texelByteSize,p=this.bytesPerRow,o=this.height,T=this.data[a];return hE(new Uint8Array(T),e,t,s,a,o,p,u,this.format)}setPixel(e,t,s,a,u){const p=this.texelByteSize,o=this.bytesPerRow,T=this.height,E=this.data[a];(function(C,O,$,V,ie,we,Pe,je,Ze,Le){const Ue=V*(Pe>>=ie)*(we>>=ie)+$*Pe+O*je;switch(Ze){case"r8unorm":return void xr(C,Ue,"8unorm",1,Le);case"r8snorm":return void xr(C,Ue,"8snorm",1,Le);case"r8uint":return void xr(C,Ue,"8uint",1,Le);case"r8sint":return void xr(C,Ue,"8sint",1,Le);case"rg8unorm":return void xr(C,Ue,"8unorm",2,Le);case"rg8snorm":return void xr(C,Ue,"8snorm",2,Le);case"rg8uint":return void xr(C,Ue,"8uint",2,Le);case"rg8sint":return void xr(C,Ue,"8sint",2,Le);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return void xr(C,Ue,"8unorm",4,Le);case"rgba8snorm":return void xr(C,Ue,"8snorm",4,Le);case"rgba8uint":return void xr(C,Ue,"8uint",4,Le);case"rgba8sint":return void xr(C,Ue,"8sint",4,Le);case"r16uint":return void xr(C,Ue,"16uint",1,Le);case"r16sint":return void xr(C,Ue,"16sint",1,Le);case"r16float":return void xr(C,Ue,"16float",1,Le);case"rg16uint":return void xr(C,Ue,"16uint",2,Le);case"rg16sint":return void xr(C,Ue,"16sint",2,Le);case"rg16float":return void xr(C,Ue,"16float",2,Le);case"rgba16uint":return void xr(C,Ue,"16uint",4,Le);case"rgba16sint":return void xr(C,Ue,"16sint",4,Le);case"rgba16float":return void xr(C,Ue,"16float",4,Le);case"r32uint":return void xr(C,Ue,"32uint",1,Le);case"r32sint":return void xr(C,Ue,"32sint",1,Le);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return void xr(C,Ue,"32float",1,Le);case"rg32uint":return void xr(C,Ue,"32uint",2,Le);case"rg32sint":return void xr(C,Ue,"32sint",2,Le);case"rg32float":return void xr(C,Ue,"32float",2,Le);case"rgba32uint":return void xr(C,Ue,"32uint",4,Le);case"rgba32sint":return void xr(C,Ue,"32sint",4,Le);case"rgba32float":return void xr(C,Ue,"32float",4,Le);case"rg11b10ufloat":console.error("TODO: rg11b10ufloat not supported for writing")}})(new Uint8Array(E),e,t,s,a,T,o,p,this.format,u)}}(r=>{r[r.token=0]="token",r[r.keyword=1]="keyword",r[r.reserved=2]="reserved"})(Se||(Se={}));class Ae{constructor(e,t,s){this.name=e,this.type=t,this.rule=s}toString(){return this.name}}class ee{}ke=ee,ee.none=new Ae("",Se.reserved,""),ee.eof=new Ae("EOF",Se.token,""),ee.reserved={asm:new Ae("asm",Se.reserved,"asm"),bf16:new Ae("bf16",Se.reserved,"bf16"),do:new Ae("do",Se.reserved,"do"),enum:new Ae("enum",Se.reserved,"enum"),f16:new Ae("f16",Se.reserved,"f16"),f64:new Ae("f64",Se.reserved,"f64"),handle:new Ae("handle",Se.reserved,"handle"),i8:new Ae("i8",Se.reserved,"i8"),i16:new Ae("i16",Se.reserved,"i16"),i64:new Ae("i64",Se.reserved,"i64"),mat:new Ae("mat",Se.reserved,"mat"),premerge:new Ae("premerge",Se.reserved,"premerge"),regardless:new Ae("regardless",Se.reserved,"regardless"),typedef:new Ae("typedef",Se.reserved,"typedef"),u8:new Ae("u8",Se.reserved,"u8"),u16:new Ae("u16",Se.reserved,"u16"),u64:new Ae("u64",Se.reserved,"u64"),unless:new Ae("unless",Se.reserved,"unless"),using:new Ae("using",Se.reserved,"using"),vec:new Ae("vec",Se.reserved,"vec"),void:new Ae("void",Se.reserved,"void")},ee.keywords={array:new Ae("array",Se.keyword,"array"),atomic:new Ae("atomic",Se.keyword,"atomic"),bool:new Ae("bool",Se.keyword,"bool"),f32:new Ae("f32",Se.keyword,"f32"),i32:new Ae("i32",Se.keyword,"i32"),mat2x2:new Ae("mat2x2",Se.keyword,"mat2x2"),mat2x3:new Ae("mat2x3",Se.keyword,"mat2x3"),mat2x4:new Ae("mat2x4",Se.keyword,"mat2x4"),mat3x2:new Ae("mat3x2",Se.keyword,"mat3x2"),mat3x3:new Ae("mat3x3",Se.keyword,"mat3x3"),mat3x4:new Ae("mat3x4",Se.keyword,"mat3x4"),mat4x2:new Ae("mat4x2",Se.keyword,"mat4x2"),mat4x3:new Ae("mat4x3",Se.keyword,"mat4x3"),mat4x4:new Ae("mat4x4",Se.keyword,"mat4x4"),ptr:new Ae("ptr",Se.keyword,"ptr"),sampler:new Ae("sampler",Se.keyword,"sampler"),sampler_comparison:new Ae("sampler_comparison",Se.keyword,"sampler_comparison"),struct:new Ae("struct",Se.keyword,"struct"),texture_1d:new Ae("texture_1d",Se.keyword,"texture_1d"),texture_2d:new Ae("texture_2d",Se.keyword,"texture_2d"),texture_2d_array:new Ae("texture_2d_array",Se.keyword,"texture_2d_array"),texture_3d:new Ae("texture_3d",Se.keyword,"texture_3d"),texture_cube:new Ae("texture_cube",Se.keyword,"texture_cube"),texture_cube_array:new Ae("texture_cube_array",Se.keyword,"texture_cube_array"),texture_multisampled_2d:new Ae("texture_multisampled_2d",Se.keyword,"texture_multisampled_2d"),texture_storage_1d:new Ae("texture_storage_1d",Se.keyword,"texture_storage_1d"),texture_storage_2d:new Ae("texture_storage_2d",Se.keyword,"texture_storage_2d"),texture_storage_2d_array:new Ae("texture_storage_2d_array",Se.keyword,"texture_storage_2d_array"),texture_storage_3d:new Ae("texture_storage_3d",Se.keyword,"texture_storage_3d"),texture_depth_2d:new Ae("texture_depth_2d",Se.keyword,"texture_depth_2d"),texture_depth_2d_array:new Ae("texture_depth_2d_array",Se.keyword,"texture_depth_2d_array"),texture_depth_cube:new Ae("texture_depth_cube",Se.keyword,"texture_depth_cube"),texture_depth_cube_array:new Ae("texture_depth_cube_array",Se.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new Ae("texture_depth_multisampled_2d",Se.keyword,"texture_depth_multisampled_2d"),texture_external:new Ae("texture_external",Se.keyword,"texture_external"),u32:new Ae("u32",Se.keyword,"u32"),vec2:new Ae("vec2",Se.keyword,"vec2"),vec3:new Ae("vec3",Se.keyword,"vec3"),vec4:new Ae("vec4",Se.keyword,"vec4"),bitcast:new Ae("bitcast",Se.keyword,"bitcast"),block:new Ae("block",Se.keyword,"block"),break:new Ae("break",Se.keyword,"break"),case:new Ae("case",Se.keyword,"case"),continue:new Ae("continue",Se.keyword,"continue"),continuing:new Ae("continuing",Se.keyword,"continuing"),default:new Ae("default",Se.keyword,"default"),diagnostic:new Ae("diagnostic",Se.keyword,"diagnostic"),discard:new Ae("discard",Se.keyword,"discard"),else:new Ae("else",Se.keyword,"else"),enable:new Ae("enable",Se.keyword,"enable"),fallthrough:new Ae("fallthrough",Se.keyword,"fallthrough"),false:new Ae("false",Se.keyword,"false"),fn:new Ae("fn",Se.keyword,"fn"),for:new Ae("for",Se.keyword,"for"),function:new Ae("function",Se.keyword,"function"),if:new Ae("if",Se.keyword,"if"),let:new Ae("let",Se.keyword,"let"),const:new Ae("const",Se.keyword,"const"),loop:new Ae("loop",Se.keyword,"loop"),while:new Ae("while",Se.keyword,"while"),private:new Ae("private",Se.keyword,"private"),read:new Ae("read",Se.keyword,"read"),read_write:new Ae("read_write",Se.keyword,"read_write"),return:new Ae("return",Se.keyword,"return"),requires:new Ae("requires",Se.keyword,"requires"),storage:new Ae("storage",Se.keyword,"storage"),switch:new Ae("switch",Se.keyword,"switch"),true:new Ae("true",Se.keyword,"true"),alias:new Ae("alias",Se.keyword,"alias"),type:new Ae("type",Se.keyword,"type"),uniform:new Ae("uniform",Se.keyword,"uniform"),var:new Ae("var",Se.keyword,"var"),override:new Ae("override",Se.keyword,"override"),workgroup:new Ae("workgroup",Se.keyword,"workgroup"),write:new Ae("write",Se.keyword,"write"),r8unorm:new Ae("r8unorm",Se.keyword,"r8unorm"),r8snorm:new Ae("r8snorm",Se.keyword,"r8snorm"),r8uint:new Ae("r8uint",Se.keyword,"r8uint"),r8sint:new Ae("r8sint",Se.keyword,"r8sint"),r16uint:new Ae("r16uint",Se.keyword,"r16uint"),r16sint:new Ae("r16sint",Se.keyword,"r16sint"),r16float:new Ae("r16float",Se.keyword,"r16float"),rg8unorm:new Ae("rg8unorm",Se.keyword,"rg8unorm"),rg8snorm:new Ae("rg8snorm",Se.keyword,"rg8snorm"),rg8uint:new Ae("rg8uint",Se.keyword,"rg8uint"),rg8sint:new Ae("rg8sint",Se.keyword,"rg8sint"),r32uint:new Ae("r32uint",Se.keyword,"r32uint"),r32sint:new Ae("r32sint",Se.keyword,"r32sint"),r32float:new Ae("r32float",Se.keyword,"r32float"),rg16uint:new Ae("rg16uint",Se.keyword,"rg16uint"),rg16sint:new Ae("rg16sint",Se.keyword,"rg16sint"),rg16float:new Ae("rg16float",Se.keyword,"rg16float"),rgba8unorm:new Ae("rgba8unorm",Se.keyword,"rgba8unorm"),rgba8unorm_srgb:new Ae("rgba8unorm_srgb",Se.keyword,"rgba8unorm_srgb"),rgba8snorm:new Ae("rgba8snorm",Se.keyword,"rgba8snorm"),rgba8uint:new Ae("rgba8uint",Se.keyword,"rgba8uint"),rgba8sint:new Ae("rgba8sint",Se.keyword,"rgba8sint"),bgra8unorm:new Ae("bgra8unorm",Se.keyword,"bgra8unorm"),bgra8unorm_srgb:new Ae("bgra8unorm_srgb",Se.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new Ae("rgb10a2unorm",Se.keyword,"rgb10a2unorm"),rg11b10float:new Ae("rg11b10float",Se.keyword,"rg11b10float"),rg32uint:new Ae("rg32uint",Se.keyword,"rg32uint"),rg32sint:new Ae("rg32sint",Se.keyword,"rg32sint"),rg32float:new Ae("rg32float",Se.keyword,"rg32float"),rgba16uint:new Ae("rgba16uint",Se.keyword,"rgba16uint"),rgba16sint:new Ae("rgba16sint",Se.keyword,"rgba16sint"),rgba16float:new Ae("rgba16float",Se.keyword,"rgba16float"),rgba32uint:new Ae("rgba32uint",Se.keyword,"rgba32uint"),rgba32sint:new Ae("rgba32sint",Se.keyword,"rgba32sint"),rgba32float:new Ae("rgba32float",Se.keyword,"rgba32float"),static_assert:new Ae("static_assert",Se.keyword,"static_assert")},ee.tokens={decimal_float_literal:new Ae("decimal_float_literal",Se.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new Ae("hex_float_literal",Se.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new Ae("int_literal",Se.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new Ae("uint_literal",Se.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new Ae("name",Se.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new Ae("ident",Se.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new Ae("and",Se.token,"&"),and_and:new Ae("and_and",Se.token,"&&"),arrow:new Ae("arrow ",Se.token,"->"),attr:new Ae("attr",Se.token,"@"),forward_slash:new Ae("forward_slash",Se.token,"/"),bang:new Ae("bang",Se.token,"!"),bracket_left:new Ae("bracket_left",Se.token,"["),bracket_right:new Ae("bracket_right",Se.token,"]"),brace_left:new Ae("brace_left",Se.token,"{"),brace_right:new Ae("brace_right",Se.token,"}"),colon:new Ae("colon",Se.token,":"),comma:new Ae("comma",Se.token,","),equal:new Ae("equal",Se.token,"="),equal_equal:new Ae("equal_equal",Se.token,"=="),not_equal:new Ae("not_equal",Se.token,"!="),greater_than:new Ae("greater_than",Se.token,">"),greater_than_equal:new Ae("greater_than_equal",Se.token,">="),shift_right:new Ae("shift_right",Se.token,">>"),less_than:new Ae("less_than",Se.token,"<"),less_than_equal:new Ae("less_than_equal",Se.token,"<="),shift_left:new Ae("shift_left",Se.token,"<<"),modulo:new Ae("modulo",Se.token,"%"),minus:new Ae("minus",Se.token,"-"),minus_minus:new Ae("minus_minus",Se.token,"--"),period:new Ae("period",Se.token,"."),plus:new Ae("plus",Se.token,"+"),plus_plus:new Ae("plus_plus",Se.token,"++"),or:new Ae("or",Se.token,"|"),or_or:new Ae("or_or",Se.token,"||"),paren_left:new Ae("paren_left",Se.token,"("),paren_right:new Ae("paren_right",Se.token,")"),semicolon:new Ae("semicolon",Se.token,";"),star:new Ae("star",Se.token,"*"),tilde:new Ae("tilde",Se.token,"~"),underscore:new Ae("underscore",Se.token,"_"),xor:new Ae("xor",Se.token,"^"),plus_equal:new Ae("plus_equal",Se.token,"+="),minus_equal:new Ae("minus_equal",Se.token,"-="),times_equal:new Ae("times_equal",Se.token,"*="),division_equal:new Ae("division_equal",Se.token,"/="),modulo_equal:new Ae("modulo_equal",Se.token,"%="),and_equal:new Ae("and_equal",Se.token,"&="),or_equal:new Ae("or_equal",Se.token,"|="),xor_equal:new Ae("xor_equal",Se.token,"^="),shift_right_equal:new Ae("shift_right_equal",Se.token,">>="),shift_left_equal:new Ae("shift_left_equal",Se.token,"<<=")},ee.simpleTokens={"@":ke.tokens.attr,"{":ke.tokens.brace_left,"}":ke.tokens.brace_right,":":ke.tokens.colon,",":ke.tokens.comma,"(":ke.tokens.paren_left,")":ke.tokens.paren_right,";":ke.tokens.semicolon},ee.literalTokens={"&":ke.tokens.and,"&&":ke.tokens.and_and,"->":ke.tokens.arrow,"/":ke.tokens.forward_slash,"!":ke.tokens.bang,"[":ke.tokens.bracket_left,"]":ke.tokens.bracket_right,"=":ke.tokens.equal,"==":ke.tokens.equal_equal,"!=":ke.tokens.not_equal,">":ke.tokens.greater_than,">=":ke.tokens.greater_than_equal,">>":ke.tokens.shift_right,"<":ke.tokens.less_than,"<=":ke.tokens.less_than_equal,"<<":ke.tokens.shift_left,"%":ke.tokens.modulo,"-":ke.tokens.minus,"--":ke.tokens.minus_minus,".":ke.tokens.period,"+":ke.tokens.plus,"++":ke.tokens.plus_plus,"|":ke.tokens.or,"||":ke.tokens.or_or,"*":ke.tokens.star,"~":ke.tokens.tilde,_:ke.tokens.underscore,"^":ke.tokens.xor,"+=":ke.tokens.plus_equal,"-=":ke.tokens.minus_equal,"*=":ke.tokens.times_equal,"/=":ke.tokens.division_equal,"%=":ke.tokens.modulo_equal,"&=":ke.tokens.and_equal,"|=":ke.tokens.or_equal,"^=":ke.tokens.xor_equal,">>=":ke.tokens.shift_right_equal,"<<=":ke.tokens.shift_left_equal},ee.regexTokens={decimal_float_literal:ke.tokens.decimal_float_literal,hex_float_literal:ke.tokens.hex_float_literal,int_literal:ke.tokens.int_literal,uint_literal:ke.tokens.uint_literal,ident:ke.tokens.ident},ee.storage_class=[ke.keywords.function,ke.keywords.private,ke.keywords.workgroup,ke.keywords.uniform,ke.keywords.storage],ee.access_mode=[ke.keywords.read,ke.keywords.write,ke.keywords.read_write],ee.sampler_type=[ke.keywords.sampler,ke.keywords.sampler_comparison],ee.sampled_texture_type=[ke.keywords.texture_1d,ke.keywords.texture_2d,ke.keywords.texture_2d_array,ke.keywords.texture_3d,ke.keywords.texture_cube,ke.keywords.texture_cube_array],ee.multisampled_texture_type=[ke.keywords.texture_multisampled_2d],ee.storage_texture_type=[ke.keywords.texture_storage_1d,ke.keywords.texture_storage_2d,ke.keywords.texture_storage_2d_array,ke.keywords.texture_storage_3d],ee.depth_texture_type=[ke.keywords.texture_depth_2d,ke.keywords.texture_depth_2d_array,ke.keywords.texture_depth_cube,ke.keywords.texture_depth_cube_array,ke.keywords.texture_depth_multisampled_2d],ee.texture_external_type=[ke.keywords.texture_external],ee.any_texture_type=[...ke.sampled_texture_type,...ke.multisampled_texture_type,...ke.storage_texture_type,...ke.depth_texture_type,...ke.texture_external_type],ee.texel_format=[ke.keywords.r8unorm,ke.keywords.r8snorm,ke.keywords.r8uint,ke.keywords.r8sint,ke.keywords.r16uint,ke.keywords.r16sint,ke.keywords.r16float,ke.keywords.rg8unorm,ke.keywords.rg8snorm,ke.keywords.rg8uint,ke.keywords.rg8sint,ke.keywords.r32uint,ke.keywords.r32sint,ke.keywords.r32float,ke.keywords.rg16uint,ke.keywords.rg16sint,ke.keywords.rg16float,ke.keywords.rgba8unorm,ke.keywords.rgba8unorm_srgb,ke.keywords.rgba8snorm,ke.keywords.rgba8uint,ke.keywords.rgba8sint,ke.keywords.bgra8unorm,ke.keywords.bgra8unorm_srgb,ke.keywords.rgb10a2unorm,ke.keywords.rg11b10float,ke.keywords.rg32uint,ke.keywords.rg32sint,ke.keywords.rg32float,ke.keywords.rgba16uint,ke.keywords.rgba16sint,ke.keywords.rgba16float,ke.keywords.rgba32uint,ke.keywords.rgba32sint,ke.keywords.rgba32float],ee.const_literal=[ke.tokens.int_literal,ke.tokens.uint_literal,ke.tokens.decimal_float_literal,ke.tokens.hex_float_literal,ke.keywords.true,ke.keywords.false],ee.literal_or_ident=[ke.tokens.ident,ke.tokens.int_literal,ke.tokens.uint_literal,ke.tokens.decimal_float_literal,ke.tokens.hex_float_literal,ke.tokens.name],ee.element_count_expression=[ke.tokens.int_literal,ke.tokens.uint_literal,ke.tokens.ident],ee.template_types=[ke.keywords.vec2,ke.keywords.vec3,ke.keywords.vec4,ke.keywords.mat2x2,ke.keywords.mat2x3,ke.keywords.mat2x4,ke.keywords.mat3x2,ke.keywords.mat3x3,ke.keywords.mat3x4,ke.keywords.mat4x2,ke.keywords.mat4x3,ke.keywords.mat4x4,ke.keywords.atomic,ke.keywords.bitcast,...ke.any_texture_type],ee.attribute_name=[ke.tokens.ident,ke.keywords.block,ke.keywords.diagnostic],ee.assignment_operators=[ke.tokens.equal,ke.tokens.plus_equal,ke.tokens.minus_equal,ke.tokens.times_equal,ke.tokens.division_equal,ke.tokens.modulo_equal,ke.tokens.and_equal,ke.tokens.or_equal,ke.tokens.xor_equal,ke.tokens.shift_right_equal,ke.tokens.shift_left_equal],ee.increment_operators=[ke.tokens.plus_plus,ke.tokens.minus_minus];class _b{constructor(e,t,s,a,u){this.type=e,this.lexeme=t,this.line=s,this.start=a,this.end=u}toString(){return this.lexeme}isTemplateType(){return ee.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==ee.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class _E{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new _b(ee.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let p=1;for(;p>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),p--,p==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),p++)}return!0}}const t=ee.simpleTokens[e];if(t)return this._addToken(t),!0;let s=ee.none;const a=this._isAlpha(e),u=e==="_";if(this._isAlphaNumeric(e)){let p=this._peekAhead();for(;this._isAlphaNumeric(p);)e+=this._advance(),p=this._peekAhead()}if(a){const p=ee.keywords[e];if(p)return this._addToken(p),!0}if(a||u)return this._addToken(ee.tokens.ident),!0;for(;;){let p=this._findType(e);const o=this._peekAhead();if(e=="-"&&this._tokens.length>0){if(o=="=")return this._current++,e+=o,this._addToken(ee.tokens.minus_equal),!0;if(o=="-")return this._current++,e+=o,this._addToken(ee.tokens.minus_minus),!0;const T=this._tokens.length-1;if((ee.literal_or_ident.indexOf(this._tokens[T].type)!=-1||this._tokens[T].type==ee.tokens.paren_right)&&o!=">")return this._addToken(p),!0}if(e==">"&&(o==">"||o=="=")){let T=!1,E=this._tokens.length-1;for(let C=0;C<5&&E>=0&&ee.assignment_operators.indexOf(this._tokens[E].type)===-1;++C,--E)if(this._tokens[E].type===ee.tokens.less_than){E>0&&this._tokens[E-1].isArrayOrTemplateType()&&(T=!0);break}if(T)return this._addToken(p),!0}if(p===ee.none){let T=e,E=0;const C=2;for(let O=0;O<C;++O)if(T+=this._peekAhead(O),p=this._findType(T),p!==ee.none){E=O;break}if(p===ee.none)return s!==ee.none&&(this._current--,this._addToken(s),!0);e=T,this._current+=E+1}if(s=p,this._isAtEnd())break;e+=this._advance()}return s!==ee.none&&(this._addToken(s),!0)}_findType(e){for(const s in ee.regexTokens){const a=ee.regexTokens[s];if(this._match(e,a.rule))return a}return ee.literalTokens[e]||ee.none}_match(e,t){const s=t.exec(e);return s&&s.index==0&&s[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&e!=="_"&&e!=="."&&e!=="("&&e!==")"&&e!=="["&&e!=="]"&&e!=="{"&&e!=="}"&&e!==","&&e!==";"&&e!==":"&&e!=="="&&e!=="!"&&e!=="<"&&e!==">"&&e!=="+"&&e!=="-"&&e!=="*"&&e!=="/"&&e!=="%"&&e!=="&"&&e!=="|"&&e!=="^"&&e!=="~"&&e!=="@"&&e!=="#"&&e!=="?"&&e!=="'"&&e!=="`"&&e!=='"'&&e!=="\\"&&e!==`
`&&e!=="\r"&&e!=="	"&&e!=="\0"}_isNumeric(e){return e>="0"&&e<="9"}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||e==="_"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new _b(e,t,this._line,this._start,this._current))}}function dt(r){return Array.isArray(r)||r?.buffer instanceof ArrayBuffer}const Kd=new Float32Array(1),yE=new Uint32Array(Kd.buffer),bE=new Uint32Array(Kd.buffer),Jd=new Int32Array(1),vE=new Float32Array(Jd.buffer),xE=new Uint32Array(Jd.buffer),Qd=new Uint32Array(1),wE=new Float32Array(Qd.buffer),TE=new Int32Array(Qd.buffer);function yb(r,e,t){if(e===t)return r;if(e==="f32"){if(t==="i32"||t==="x32")return Kd[0]=r,yE[0];if(t==="u32")return Kd[0]=r,bE[0]}else if(e==="i32"||e==="x32"){if(t==="f32")return Jd[0]=r,vE[0];if(t==="u32")return Jd[0]=r,xE[0]}else if(e==="u32"){if(t==="f32")return Qd[0]=r,wE[0];if(t==="i32"||t==="x32")return Qd[0]=r,TE[0]}return console.error(`Unsupported cast from ${e} to ${t}`),r}class SE{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class vd{constructor(e,t){this.align=e,this.size=t}}class ws{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new aE,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}updateAST(e){for(const t of e)t instanceof jh&&this._functions.set(t.name,new SE(t));for(const t of e)if(t instanceof js){const s=this.getTypeInfo(t,null);s instanceof Ro&&this.structs.push(s)}for(const t of e)if(t instanceof _m)this.aliases.push(this._getAliasInfo(t));else if(t instanceof gm){const s=t,a=this._getAttributeNum(s.attributes,"id",0),u=s.type!=null?this.getTypeInfo(s.type,s.attributes):null;this.overrides.push(new nE(s.name,u,s.attributes,a))}else if(this._isUniformVar(t)){const s=t,a=this._getAttributeNum(s.attributes,"group",0),u=this._getAttributeNum(s.attributes,"binding",0),p=this.getTypeInfo(s.type,s.attributes),o=new bd(s.name,p,a,u,s.attributes,Po.Uniform,s.access);o.access||(o.access="read"),this.uniforms.push(o)}else if(this._isStorageVar(t)){const s=t,a=this._getAttributeNum(s.attributes,"group",0),u=this._getAttributeNum(s.attributes,"binding",0),p=this.getTypeInfo(s.type,s.attributes),o=this._isStorageTexture(p),T=new bd(s.name,p,a,u,s.attributes,o?Po.StorageTexture:Po.Storage,s.access);T.access||(T.access="read"),this.storage.push(T)}else if(this._isTextureVar(t)){const s=t,a=this._getAttributeNum(s.attributes,"group",0),u=this._getAttributeNum(s.attributes,"binding",0),p=this.getTypeInfo(s.type,s.attributes),o=this._isStorageTexture(p),T=new bd(s.name,p,a,u,s.attributes,o?Po.StorageTexture:Po.Texture,s.access);T.access||(T.access="read"),o?this.storage.push(T):this.textures.push(T)}else if(this._isSamplerVar(t)){const s=t,a=this._getAttributeNum(s.attributes,"group",0),u=this._getAttributeNum(s.attributes,"binding",0),p=this.getTypeInfo(s.type,s.attributes),o=new bd(s.name,p,a,u,s.attributes,Po.Sampler,s.access);this.samplers.push(o)}for(const t of e)if(t instanceof jh){const s=this._getAttribute(t,"vertex"),a=this._getAttribute(t,"fragment"),u=this._getAttribute(t,"compute"),p=s||a||u,o=new oE(t.name,p?.name,t.attributes);o.attributes=t.attributes,o.startLine=t.startLine,o.endLine=t.endLine,this.functions.push(o),this._functions.get(t.name).info=o,p&&(this._functions.get(t.name).inUse=!0,o.inUse=!0,o.resources=this._findResources(t,!!p),o.inputs=this._getInputs(t.args),o.outputs=this._getOutputs(t.returnType),this.entry[p.name].push(o)),o.arguments=t.args.map(T=>new sE(T.name,this.getTypeInfo(T.type,T.attributes),T.attributes)),o.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null}for(const t of this._functions.values())t.info&&(t.info.inUse=t.inUse,this._addCalls(t.node,t.info.calls));for(const t of this._functions.values())t.node.search(s=>{var a,u,p;if(s instanceof Hx){if(s.value)if(dt(s.value))for(const o of s.value)for(const T of this.overrides)o===T.name&&((a=t.info)===null||a===void 0||a.overrides.push(T));else for(const o of this.overrides)s.value===o.name&&((u=t.info)===null||u===void 0||u.overrides.push(o))}else if(s instanceof An)for(const o of this.overrides)s.name===o.name&&((p=t.info)===null||p===void 0||p.overrides.push(o))});for(const t of this.uniforms)this._markStructsInUse(t.type);for(const t of this.storage)this._markStructsInUse(t.type)}getStructInfo(e){for(const t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(const t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var s;for(const a of e.calls){const u=(s=this._functions.get(a.name))===null||s===void 0?void 0:s.info;u&&t.add(u)}}findResource(e,t,s){if(s){for(const a of this.entry.compute)if(a.name===s){for(const u of a.resources)if(u.group==e&&u.binding==t)return u}for(const a of this.entry.vertex)if(a.name===s){for(const u of a.resources)if(u.group==e&&u.binding==t)return u}for(const a of this.entry.fragment)if(a.name===s){for(const u of a.resources)if(u.group==e&&u.binding==t)return u}}for(const a of this.uniforms)if(a.group==e&&a.binding==t)return a;for(const a of this.storage)if(a.group==e&&a.binding==t)return a;for(const a of this.textures)if(a.group==e&&a.binding==t)return a;for(const a of this.samplers)if(a.group==e&&a.binding==t)return a;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const s=[],a=this,u=[];return e.search(p=>{if(p instanceof Yd)u.push({});else if(p instanceof Gd)u.pop();else if(p instanceof Ws){const o=p;t&&o.type!==null&&this._markStructsFromAST(o.type),u.length>0&&(u[u.length-1][o.name]=o)}else if(p instanceof vs){const o=p;t&&o.type!==null&&this._markStructsFromAST(o.type)}else if(p instanceof Bh){const o=p;t&&o.type!==null&&this._markStructsFromAST(o.type),u.length>0&&(u[u.length-1][o.name]=o)}else if(p instanceof An){const o=p;if(u.length>0&&u[u.length-1][o.name])return;const T=a._findResource(o.name);T&&s.push(T)}else if(p instanceof ym){const o=p,T=a._functions.get(o.name);T&&(t&&(T.inUse=!0),e.calls.add(T.node),T.resources===null&&(T.resources=a._findResources(T.node,t)),s.push(...T.resources))}else if(p instanceof mm){const o=p,T=a._functions.get(o.name);T&&(t&&(T.inUse=!0),e.calls.add(T.node),T.resources===null&&(T.resources=a._findResources(T.node,t)),s.push(...T.resources))}}),[...new Map(s.map(p=>[p.name,p])).values()]}getBindGroups(){const e=[];function t(s,a){s>=e.length&&(e.length=s+1),e[s]===void 0&&(e[s]=[]),a>=e[s].length&&(e[s].length=a+1)}for(const s of this.uniforms)t(s.group,s.binding),e[s.group][s.binding]=s;for(const s of this.storage)t(s.group,s.binding),e[s.group][s.binding]=s;for(const s of this.textures)t(s.group,s.binding),e[s.group][s.binding]=s;for(const s of this.samplers)t(s.group,s.binding),e[s.group][s.binding]=s;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof js)this._getStructOutputs(e,t);else{const s=this._getOutputInfo(e);s!==null&&t.push(s)}return t}_getStructOutputs(e,t){for(const s of e.members)if(s.type instanceof js)this._getStructOutputs(s.type,t);else{const a=this._getAttribute(s,"location")||this._getAttribute(s,"builtin");if(a!==null){const u=this.getTypeInfo(s.type,s.type.attributes),p=this._parseInt(a.value),o=new db(s.name,u,a.name,p);t.push(o)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const s=this.getTypeInfo(e,e.attributes),a=this._parseInt(t.value);return new db("",s,t.name,a)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(const s of e)if(s.type instanceof js)this._getStructInputs(s.type,t);else{const a=this._getInputInfo(s);a!==null&&t.push(a)}return t}_getStructInputs(e,t){for(const s of e.members)if(s.type instanceof js)this._getStructInputs(s.type,t);else{const a=this._getInputInfo(s);a!==null&&t.push(a)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const s=this._getAttribute(e,"interpolation"),a=this.getTypeInfo(e.type,e.attributes),u=this._parseInt(t.value),p=new iE(e.name,a,t.name,u);return s!==null&&(p.interpolation=this._parseString(s.value)),p}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new rE(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(const t of this.structs)if(t.name==e)return t;for(const t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof Dd){const a=e.type?this.getTypeInfo(e.type,e.attributes):null,u=new Ig(e.name,a,t);return this._types.set(e,u),this._updateTypeInfo(u),u}if(e instanceof Lh){const a=e,u=a.format?this.getTypeInfo(a.format,a.attributes):null,p=new Fo(a.name,t);return p.format=u,p.count=a.count,this._types.set(e,p),this._updateTypeInfo(p),p}if(e instanceof js){const a=e,u=new Ro(a.name,t);u.startLine=a.startLine,u.endLine=a.endLine;for(const p of a.members){const o=this.getTypeInfo(p.type,p.attributes);u.members.push(new ub(p.name,o,p.attributes))}return this._types.set(e,u),this._updateTypeInfo(u),u}if(e instanceof Mh){const a=e,u=a.format instanceof Ge,p=a.format?u?this.getTypeInfo(a.format,null):new On(a.format,null):null,o=new La(a.name,p,t,a.access);return this._types.set(e,o),this._updateTypeInfo(o),o}if(e instanceof Ie){const a=e,u=a.format?this.getTypeInfo(a.format,null):null,p=new La(a.name,u,t,a.access);return this._types.set(e,p),this._updateTypeInfo(p),p}const s=new On(e.name,t);return this._types.set(e,s),this._updateTypeInfo(s),s}_updateTypeInfo(e){var t,s,a;const u=this._getTypeSize(e);if(e.size=(t=u?.size)!==null&&t!==void 0?t:0,e instanceof Fo&&e.format){const p=this._getTypeSize(e.format);e.stride=Math.max((s=p?.size)!==null&&s!==void 0?s:0,(a=p?.align)!==null&&a!==void 0?a:0),this._updateTypeInfo(e.format)}e instanceof Ig&&this._updateTypeInfo(e.format),e instanceof Ro&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let s=0,a=0,u=0,p=0;for(let o=0,T=e.members.length;o<T;++o){const E=e.members[o],C=this._getTypeSize(E);if(!C)continue;(t=this._getAlias(E.type.name))!==null&&t!==void 0||E.type;const O=C.align,$=C.size;s=this._roundUp(O,s+a),a=$,u=s,p=Math.max(p,O),E.offset=s,E.size=$,this._updateTypeInfo(E.type)}e.size=this._roundUp(p,u+a),e.align=p}_getTypeSize(e){var t,s;if(e==null)return null;const a=this._getAttributeNum(e.attributes,"size",0),u=this._getAttributeNum(e.attributes,"align",0);if(e instanceof ub&&(e=e.type),e instanceof On){const p=this._getAlias(e.name);p!==null&&(e=p)}{const p=ws._typeInfo[e.name];if(p!==void 0){const o=((t=e.format)===null||t===void 0?void 0:t.name)==="f16"?2:1;return new vd(Math.max(u,p.align/o),Math.max(a,p.size/o))}}{const p=ws._typeInfo[e.name.substring(0,e.name.length-1)];if(p){const o=e.name[e.name.length-1]==="h"?2:1;return new vd(Math.max(u,p.align/o),Math.max(a,p.size/o))}}if(e instanceof Fo){let p=e,o=8,T=8;const E=this._getTypeSize(p.format);return E!==null&&(T=E.size,o=E.align),T=p.count*this._getAttributeNum((s=e?.attributes)!==null&&s!==void 0?s:null,"stride",this._roundUp(o,T)),a&&(T=a),new vd(Math.max(u,o),Math.max(a,T))}if(e instanceof Ro){let p=0,o=0,T=0,E=0,C=0;for(const O of e.members){const $=this._getTypeSize(O.type);$!==null&&(p=Math.max($.align,p),T=this._roundUp($.align,T+E),E=$.size,C=T)}return o=this._roundUp(p,C+E),new vd(Math.max(u,p),Math.max(a,o))}return null}_isUniformVar(e){return e instanceof Ws&&e.storage=="uniform"}_isStorageVar(e){return e instanceof Ws&&e.storage=="storage"}_isTextureVar(e){return e instanceof Ws&&e.type!==null&&ws._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof Ws&&e.type!==null&&ws._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,t){const s=e;if(!s||!s.attributes)return null;const a=s.attributes;for(let u of a)if(u.name==t)return u;return null}_getAttributeNum(e,t,s){if(e===null)return s;for(let a of e)if(a.name==t){let u=a!==null&&a.value!==null?a.value:s;return u instanceof Array&&(u=u[0]),typeof u=="number"?u:typeof u=="string"?parseInt(u):s}return s}_roundUp(e,t){return Math.ceil(t/e)*e}}ws._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},ws._textureTypes=ee.any_texture_type.map(r=>r.name),ws._samplerTypes=ee.sampler_type.map(r=>r.name);let bm=0;class vm{constructor(e,t,s){this.id=bm++,this.name=e,this.value=t,this.node=s}clone(){return new vm(this.name,this.value,this.node)}}class xm{constructor(e){this.id=bm++,this.name=e.name,this.node=e}clone(){return new xm(this.node)}}class wm{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",this.id=bm++,e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?(t=this.variables.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?(t=this.functions.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,s){this.variables.set(e,new vm(e,t,s??null))}setVariable(e,t,s){const a=this.getVariable(e);a!==null?a.value=t:this.createVariable(e,t,s)}getVariableValue(e){var t;const s=this.getVariable(e);return(t=s?.value)!==null&&t!==void 0?t:null}clone(){return new wm(this)}}class AE{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return""}}class EE{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){const s=this.exec.evalExpression(e.args[0],t);let a=!0;if(s instanceof ne)return s.data.forEach(u=>{u||(a=!1)}),new Te(a?1:0,this.getTypeInfo("bool"));throw new Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne){const a=s.data.some(u=>u);return new Te(a?1:0,this.getTypeInfo("bool"))}throw new Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){const s=this.exec.evalExpression(e.args[2],t);if(!(s instanceof Te))throw new Error(`Select() expects a bool condition. Line ${e.line}`);return s.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let s=e.args[0];s instanceof _i&&(s=s.right);const a=this.exec.evalExpression(s,t);if(a instanceof ei&&a.typeInfo.size===0){const u=a.typeInfo,p=a.buffer.byteLength/u.stride;return new Te(p,this.getTypeInfo("u32"))}return new Te(a.typeInfo.size,this.getTypeInfo("u32"))}Abs(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.abs(u)),s.typeInfo);const a=s;return new Te(Math.abs(a.value),a.typeInfo)}Acos(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.acos(u)),s.typeInfo);const a=s;return new Te(Math.acos(a.value),s.typeInfo)}Acosh(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.acosh(u)),s.typeInfo);const a=s;return new Te(Math.acosh(a.value),s.typeInfo)}Asin(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.asin(u)),s.typeInfo);const a=s;return new Te(Math.asin(a.value),s.typeInfo)}Asinh(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.asinh(u)),s.typeInfo);const a=s;return new Te(Math.asinh(a.value),s.typeInfo)}Atan(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.atan(u)),s.typeInfo);const a=s;return new Te(Math.atan(a.value),s.typeInfo)}Atanh(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.atanh(u)),s.typeInfo);const a=s;return new Te(Math.atanh(a.value),s.typeInfo)}Atan2(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(s instanceof ne&&a instanceof ne)return new ne(s.data.map((o,T)=>Math.atan2(o,a.data[T])),s.typeInfo);const u=s,p=a;return new Te(Math.atan2(u.value,p.value),s.typeInfo)}Ceil(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.ceil(u)),s.typeInfo);const a=s;return new Te(Math.ceil(a.value),s.typeInfo)}_clamp(e,t,s){return Math.min(Math.max(e,t),s)}Clamp(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),u=this.exec.evalExpression(e.args[2],t);if(s instanceof ne&&a instanceof ne&&u instanceof ne)return new ne(s.data.map((E,C)=>this._clamp(E,a.data[C],u.data[C])),s.typeInfo);const p=s,o=a,T=u;return new Te(this._clamp(p.value,o.value,T.value),s.typeInfo)}Cos(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.cos(u)),s.typeInfo);const a=s;return new Te(Math.cos(a.value),s.typeInfo)}Cosh(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.cosh(u)),s.typeInfo);const a=s;return new Te(Math.cos(a.value),s.typeInfo)}CountLeadingZeros(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.clz32(u)),s.typeInfo);const a=s;return new Te(Math.clz32(a.value),s.typeInfo)}_countOneBits(e){let t=0;for(;e!==0;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>this._countOneBits(u)),s.typeInfo);const a=s;return new Te(this._countOneBits(a.value),s.typeInfo)}_countTrailingZeros(e){if(e===0)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>this._countTrailingZeros(u)),s.typeInfo);const a=s;return new Te(this._countTrailingZeros(a.value),s.typeInfo)}Cross(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(s instanceof ne&&a instanceof ne){if(s.data.length!==3||a.data.length!==3)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;const u=s.data,p=a.data;return new ne([u[1]*p[2]-p[1]*u[2],u[2]*p[0]-p[2]*u[0],u[0]*p[1]-p[0]*u[1]],s.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){const s=this.exec.evalExpression(e.args[0],t),a=180/Math.PI;return s instanceof ne?new ne(s.data.map(u=>u*a),s.typeInfo):new Te(s.value*a,this.getTypeInfo("f32"))}Determinant(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof Ot){const a=s.data,u=s.typeInfo.getTypeName(),p=u.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if(u==="mat2x2"||u==="mat2x2f"||u==="mat2x2h")return new Te(a[0]*a[3]-a[1]*a[2],p);if(u==="mat2x3"||u==="mat2x3f"||u==="mat2x3h")return new Te(a[0]*(a[4]*a[8]-a[5]*a[7])-a[1]*(a[3]*a[8]-a[5]*a[6])+a[2]*(a[3]*a[7]-a[4]*a[6]),p);if(u==="mat2x4"||u==="mat2x4f"||u==="mat2x4h")console.error(`TODO: Determinant for ${u}`);else if(u==="mat3x2"||u==="mat3x2f"||u==="mat3x2h")console.error(`TODO: Determinant for ${u}`);else{if(u==="mat3x3"||u==="mat3x3f"||u==="mat3x3h")return new Te(a[0]*(a[4]*a[8]-a[5]*a[7])-a[1]*(a[3]*a[8]-a[5]*a[6])+a[2]*(a[3]*a[7]-a[4]*a[6]),p);u==="mat3x4"||u==="mat3x4f"||u==="mat3x4h"||u==="mat4x2"||u==="mat4x2f"||u==="mat4x2h"||u==="mat4x3"||u==="mat4x3f"||u==="mat4x3h"?console.error(`TODO: Determinant for ${u}`):u!=="mat4x4"&&u!=="mat4x4f"&&u!=="mat4x4h"||console.error(`TODO: Determinant for ${u}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(s instanceof ne&&a instanceof ne){let o=0;for(let T=0;T<s.data.length;++T)o+=(s.data[T]-a.data[T])*(s.data[T]-a.data[T]);return new Te(Math.sqrt(o),this.getTypeInfo("f32"))}const u=s,p=a;return new Te(Math.abs(u.value-p.value),s.typeInfo)}_dot(e,t){let s=0;for(let a=0;a<e.length;++a)s+=t[a]*e[a];return s}Dot(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);return s instanceof ne&&a instanceof ne?new Te(this._dot(s.data,a.data),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.exp(u)),s.typeInfo);const a=s;return new Te(Math.exp(a.value),s.typeInfo)}Exp2(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.pow(2,u)),s.typeInfo);const a=s;return new Te(Math.pow(2,a.value),s.typeInfo)}ExtractBits(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),u=this.exec.evalExpression(e.args[2],t);if(a.typeInfo.name!=="u32"&&a.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if(u.typeInfo.name!=="u32"&&u.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;const p=a.value,o=u.value;if(s instanceof ne)return new ne(s.data.map(E=>E>>p&(1<<o)-1),s.typeInfo);if(s.typeInfo.name!=="i32"&&s.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;const T=s.value;return new Te(T>>p&(1<<o)-1,this.getTypeInfo("i32"))}FaceForward(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),u=this.exec.evalExpression(e.args[2],t);if(s instanceof ne&&a instanceof ne&&u instanceof ne){const p=this._dot(a.data,u.data);return new ne(p<0?Array.from(s.data):s.data.map(o=>-o),s.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null}_firstLeadingBit(e){return e===0?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>this._firstLeadingBit(u)),s.typeInfo);const a=s;return new Te(this._firstLeadingBit(a.value),s.typeInfo)}_firstTrailingBit(e){return e===0?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>this._firstTrailingBit(u)),s.typeInfo);const a=s;return new Te(this._firstTrailingBit(a.value),s.typeInfo)}Floor(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.floor(u)),s.typeInfo);const a=s;return new Te(Math.floor(a.value),s.typeInfo)}Fma(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),u=this.exec.evalExpression(e.args[2],t);if(s instanceof ne&&a instanceof ne&&u instanceof ne)return s.data.length!==a.data.length||s.data.length!==u.data.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new ne(s.data.map((E,C)=>E*a.data[C]+u.data[C]),s.typeInfo);const p=s,o=a,T=u;return new Te(p.value*o.value+T.value,p.typeInfo)}Fract(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>u-Math.floor(u)),s.typeInfo);const a=s;return new Te(a.value-Math.floor(a.value),s.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),u=this.exec.evalExpression(e.args[2],t),p=this.exec.evalExpression(e.args[3],t);if(u.typeInfo.name!=="u32"&&u.typeInfo.name!=="x32")return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;const o=u.value,T=(1<<p.value)-1<<o,E=~T;if(s instanceof ne&&a instanceof ne)return new ne(s.data.map(($,V)=>$&E|a.data[V]<<o&T),s.typeInfo);const C=s.value,O=a.value;return new Te(C&E|O<<o&T,s.typeInfo)}InverseSqrt(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>1/Math.sqrt(u)),s.typeInfo);const a=s;return new Te(1/Math.sqrt(a.value),s.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne){let u=0;return s.data.forEach(p=>{u+=p*p}),new Te(Math.sqrt(u),this.getTypeInfo("f32"))}const a=s;return new Te(Math.abs(a.value),s.typeInfo)}Log(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.log(u)),s.typeInfo);const a=s;return new Te(Math.log(a.value),s.typeInfo)}Log2(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.log2(u)),s.typeInfo);const a=s;return new Te(Math.log2(a.value),s.typeInfo)}Max(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(s instanceof ne&&a instanceof ne)return new ne(s.data.map((o,T)=>Math.max(o,a.data[T])),s.typeInfo);const u=s,p=a;return new Te(Math.max(u.value,p.value),s.typeInfo)}Min(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(s instanceof ne&&a instanceof ne)return new ne(s.data.map((o,T)=>Math.min(o,a.data[T])),s.typeInfo);const u=s,p=a;return new Te(Math.min(u.value,p.value),s.typeInfo)}Mix(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),u=this.exec.evalExpression(e.args[2],t);if(s instanceof ne&&a instanceof ne&&u instanceof ne)return new ne(s.data.map((T,E)=>s.data[E]*(1-u.data[E])+a.data[E]*u.data[E]),s.typeInfo);const p=a,o=u;return new Te(s.value*(1-o.value)+p.value*o.value,s.typeInfo)}Modf(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(s instanceof ne&&a instanceof ne)return new ne(s.data.map((p,o)=>p%a.data[o]),s.typeInfo);const u=a;return new Te(s.value%u.value,s.typeInfo)}Normalize(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne){const a=this.Length(e,t).value;return new ne(s.data.map(u=>u/a),s.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(s instanceof ne&&a instanceof ne)return new ne(s.data.map((o,T)=>Math.pow(o,a.data[T])),s.typeInfo);const u=s,p=a;return new Te(Math.pow(u.value,p.value),s.typeInfo)}QuantizeToF16(e,t){const s=this.exec.evalExpression(e.args[0],t);return s instanceof ne?new ne(s.data.map(a=>a),s.typeInfo):new Te(s.value,s.typeInfo)}Radians(e,t){const s=this.exec.evalExpression(e.args[0],t);return s instanceof ne?new ne(s.data.map(a=>a*Math.PI/180),s.typeInfo):new Te(s.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(e,t){let s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(s instanceof ne&&a instanceof ne){const u=this._dot(s.data,a.data);return new ne(s.data.map((p,o)=>p-2*u*a.data[o]),s.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),u=this.exec.evalExpression(e.args[2],t);if(s instanceof ne&&a instanceof ne&&u instanceof Te){const p=this._dot(a.data,s.data);return new ne(s.data.map((o,T)=>{const E=1-u.value*u.value*(1-p*p);if(E<0)return 0;const C=Math.sqrt(E);return u.value*o-(u.value*p+C)*a.data[T]}),s.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.round(u)),s.typeInfo);const a=s;return new Te(Math.round(a.value),s.typeInfo)}Saturate(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.min(Math.max(u,0),1)),s.typeInfo);const a=s;return new Te(Math.min(Math.max(a.value,0),1),s.typeInfo)}Sign(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.sign(u)),s.typeInfo);const a=s;return new Te(Math.sign(a.value),s.typeInfo)}Sin(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.sin(u)),s.typeInfo);const a=s;return new Te(Math.sin(a.value),s.typeInfo)}Sinh(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.sinh(u)),s.typeInfo);const a=s;return new Te(Math.sinh(a.value),s.typeInfo)}_smoothstep(e,t,s){const a=Math.min(Math.max((s-e)/(t-e),0),1);return a*a*(3-2*a)}SmoothStep(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),u=this.exec.evalExpression(e.args[2],t);if(u instanceof ne&&s instanceof ne&&a instanceof ne)return new ne(u.data.map((E,C)=>this._smoothstep(s.data[C],a.data[C],E)),u.typeInfo);const p=s,o=a,T=u;return new Te(this._smoothstep(p.value,o.value,T.value),u.typeInfo)}Sqrt(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.sqrt(u)),s.typeInfo);const a=s;return new Te(Math.sqrt(a.value),s.typeInfo)}Step(e,t){const s=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(a instanceof ne&&s instanceof ne)return new ne(a.data.map((p,o)=>p<s.data[o]?0:1),a.typeInfo);const u=s;return new Te(a.value<u.value?0:1,u.typeInfo)}Tan(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.tan(u)),s.typeInfo);const a=s;return new Te(Math.tan(a.value),s.typeInfo)}Tanh(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.tanh(u)),s.typeInfo);const a=s;return new Te(Math.tanh(a.value),s.typeInfo)}_getTransposeType(e){const t=e.getTypeName();return t==="mat2x2f"||t==="mat2x2h"?e:t==="mat2x3f"?this.getTypeInfo("mat3x2f"):t==="mat2x3h"?this.getTypeInfo("mat3x2h"):t==="mat2x4f"?this.getTypeInfo("mat4x2f"):t==="mat2x4h"?this.getTypeInfo("mat4x2h"):t==="mat3x2f"?this.getTypeInfo("mat2x3f"):t==="mat3x2h"?this.getTypeInfo("mat2x3h"):t==="mat3x3f"||t==="mat3x3h"?e:t==="mat3x4f"?this.getTypeInfo("mat4x3f"):t==="mat3x4h"?this.getTypeInfo("mat4x3h"):t==="mat4x2f"?this.getTypeInfo("mat2x4f"):t==="mat4x2h"?this.getTypeInfo("mat2x4h"):t==="mat4x3f"?this.getTypeInfo("mat3x4f"):t==="mat4x3h"?this.getTypeInfo("mat3x4h"):(t==="mat4x4f"||t==="mat4x4h"||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){const s=this.exec.evalExpression(e.args[0],t);if(!(s instanceof Ot))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;const a=this._getTransposeType(s.typeInfo);if(s.typeInfo.name==="mat2x2"||s.typeInfo.name==="mat2x2f"||s.typeInfo.name==="mat2x2h"){const u=s.data;return new Ot([u[0],u[2],u[1],u[3]],a)}if(s.typeInfo.name==="mat2x3"||s.typeInfo.name==="mat2x3f"||s.typeInfo.name==="mat2x3h"){const u=s.data;return new Ot([u[0],u[3],u[6],u[1],u[4],u[7]],a)}if(s.typeInfo.name==="mat2x4"||s.typeInfo.name==="mat2x4f"||s.typeInfo.name==="mat2x4h"){const u=s.data;return new Ot([u[0],u[4],u[8],u[12],u[1],u[5],u[9],u[13]],a)}if(s.typeInfo.name==="mat3x2"||s.typeInfo.name==="mat3x2f"||s.typeInfo.name==="mat3x2h"){const u=s.data;return new Ot([u[0],u[3],u[1],u[4],u[2],u[5]],a)}if(s.typeInfo.name==="mat3x3"||s.typeInfo.name==="mat3x3f"||s.typeInfo.name==="mat3x3h"){const u=s.data;return new Ot([u[0],u[3],u[6],u[1],u[4],u[7],u[2],u[5],u[8]],a)}if(s.typeInfo.name==="mat3x4"||s.typeInfo.name==="mat3x4f"||s.typeInfo.name==="mat3x4h"){const u=s.data;return new Ot([u[0],u[4],u[8],u[12],u[1],u[5],u[9],u[13],u[2],u[6],u[10],u[14]],a)}if(s.typeInfo.name==="mat4x2"||s.typeInfo.name==="mat4x2f"||s.typeInfo.name==="mat4x2h"){const u=s.data;return new Ot([u[0],u[4],u[1],u[5],u[2],u[6]],a)}if(s.typeInfo.name==="mat4x3"||s.typeInfo.name==="mat4x3f"||s.typeInfo.name==="mat4x3h"){const u=s.data;return new Ot([u[0],u[4],u[8],u[1],u[5],u[9],u[2],u[6],u[10]],a)}if(s.typeInfo.name==="mat4x4"||s.typeInfo.name==="mat4x4f"||s.typeInfo.name==="mat4x4h"){const u=s.data;return new Ot([u[0],u[4],u[8],u[12],u[1],u[5],u[9],u[13],u[2],u[6],u[10],u[14],u[3],u[7],u[11],u[15]],a)}return console.error(`Invalid matrix type ${s.typeInfo.name}`),null}Trunc(e,t){const s=this.exec.evalExpression(e.args[0],t);if(s instanceof ne)return new ne(s.data.map(u=>Math.trunc(u)),s.typeInfo);const a=s;return new Te(Math.trunc(a.value),s.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error("TODO: dpdxFine"),null}Dpdy(e,t){return console.error("TODO: dpdy"),null}DpdyCoarse(e,t){return console.error("TODO: dpdyCoarse"),null}DpdyFine(e,t){return console.error("TODO: dpdyFine"),null}Fwidth(e,t){return console.error("TODO: fwidth"),null}FwidthCoarse(e,t){return console.error("TODO: fwidthCoarse"),null}FwidthFine(e,t){return console.error("TODO: fwidthFine"),null}TextureDimensions(e,t){const s=e.args[0],a=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(s instanceof An){const u=s.name,p=t.getVariableValue(u);if(p instanceof $s){if(a<0||a>=p.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${e.line}`),null;const o=p.getMipLevelSize(a),T=p.dimension;return T==="1d"?new Te(o[0],this.getTypeInfo("u32")):T==="3d"?new ne(o,this.getTypeInfo("vec3u")):T==="2d"?new ne(o.slice(0,2),this.getTypeInfo("vec2u")):(console.error(`Invalid texture dimension ${T} not found. Line ${e.line}`),null)}return console.error(`Texture ${u} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error("TODO: textureGather"),null}TextureGatherCompare(e,t){return console.error("TODO: textureGatherCompare"),null}TextureLoad(e,t){const s=e.args[0],a=this.exec.evalExpression(e.args[1],t),u=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(a instanceof ne)||a.data.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(s instanceof An){const p=s.name,o=t.getVariableValue(p);if(o instanceof $s){const T=Math.floor(a.data[0]),E=Math.floor(a.data[1]);if(T<0||T>=o.width||E<0||E>=o.height)return console.error(`Texture ${p} out of bounds. Line ${e.line}`),null;const C=o.getPixel(T,E,0,u);return C===null?(console.error(`Invalid texture format for textureLoad. Line ${e.line}`),null):new ne(C,this.getTypeInfo("vec4f"))}return console.error(`Texture ${p} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){const s=e.args[0];if(s instanceof An){const a=s.name,u=t.getVariableValue(a);return u instanceof $s?new Te(u.depthOrArrayLayers,this.getTypeInfo("u32")):(console.error(`Texture ${a} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${e.line}`),null}TextureNumLevels(e,t){const s=e.args[0];if(s instanceof An){const a=s.name,u=t.getVariableValue(a);return u instanceof $s?new Te(u.mipLevelCount,this.getTypeInfo("u32")):(console.error(`Texture ${a} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${e.line}`),null}TextureNumSamples(e,t){const s=e.args[0];if(s instanceof An){const a=s.name,u=t.getVariableValue(a);return u instanceof $s?new Te(u.sampleCount,this.getTypeInfo("u32")):(console.error(`Texture ${a} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${e.line}`),null}TextureSample(e,t){return console.error("TODO: textureSample"),null}TextureSampleBias(e,t){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(e,t){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(e,t){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(e,t){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(e,t){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(e,t){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(e,t){const s=e.args[0],a=this.exec.evalExpression(e.args[1],t),u=e.args.length===4?this.exec.evalExpression(e.args[2],t).value:0,p=e.args.length===4?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(p.length!==4)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(a instanceof ne)||a.data.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(s instanceof An){const o=s.name,T=t.getVariableValue(o);if(T instanceof $s){const E=T.getMipLevelSize(0),C=Math.floor(a.data[0]),O=Math.floor(a.data[1]);return C<0||C>=E[0]||O<0||O>=E[1]?(console.error(`Texture ${o} out of bounds. Line ${e.line}`),null):(T.setPixel(C,O,0,u,Array.from(p)),null)}return console.error(`Texture ${o} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let s=e.args[0];s instanceof _i&&(s=s.right);const a=this.exec.getVariableName(s,t);return t.getVariable(a).value.getSubData(this.exec,s.postfix,t)}AtomicStore(e,t){let s=e.args[0];s instanceof _i&&(s=s.right);const a=this.exec.getVariableName(s,t),u=t.getVariable(a);let p=e.args[1];const o=this.exec.evalExpression(p,t),T=u.value.getSubData(this.exec,s.postfix,t);return T instanceof Te&&o instanceof Te&&(T.value=o.value),u.value instanceof ei&&u.value.setDataValue(this.exec,T,s.postfix,t),null}AtomicAdd(e,t){let s=e.args[0];s instanceof _i&&(s=s.right);const a=this.exec.getVariableName(s,t),u=t.getVariable(a);let p=e.args[1];const o=this.exec.evalExpression(p,t),T=u.value.getSubData(this.exec,s.postfix,t),E=new Te(T.value,T.typeInfo);return T instanceof Te&&o instanceof Te&&(T.value+=o.value),u.value instanceof ei&&u.value.setDataValue(this.exec,T,s.postfix,t),E}AtomicSub(e,t){let s=e.args[0];s instanceof _i&&(s=s.right);const a=this.exec.getVariableName(s,t),u=t.getVariable(a);let p=e.args[1];const o=this.exec.evalExpression(p,t),T=u.value.getSubData(this.exec,s.postfix,t),E=new Te(T.value,T.typeInfo);return T instanceof Te&&o instanceof Te&&(T.value-=o.value),u.value instanceof ei&&u.value.setDataValue(this.exec,T,s.postfix,t),E}AtomicMax(e,t){let s=e.args[0];s instanceof _i&&(s=s.right);const a=this.exec.getVariableName(s,t),u=t.getVariable(a);let p=e.args[1];const o=this.exec.evalExpression(p,t),T=u.value.getSubData(this.exec,s.postfix,t),E=new Te(T.value,T.typeInfo);return T instanceof Te&&o instanceof Te&&(T.value=Math.max(T.value,o.value)),u.value instanceof ei&&u.value.setDataValue(this.exec,T,s.postfix,t),E}AtomicMin(e,t){let s=e.args[0];s instanceof _i&&(s=s.right);const a=this.exec.getVariableName(s,t),u=t.getVariable(a);let p=e.args[1];const o=this.exec.evalExpression(p,t),T=u.value.getSubData(this.exec,s.postfix,t),E=new Te(T.value,T.typeInfo);return T instanceof Te&&o instanceof Te&&(T.value=Math.min(T.value,o.value)),u.value instanceof ei&&u.value.setDataValue(this.exec,T,s.postfix,t),E}AtomicAnd(e,t){let s=e.args[0];s instanceof _i&&(s=s.right);const a=this.exec.getVariableName(s,t),u=t.getVariable(a);let p=e.args[1];const o=this.exec.evalExpression(p,t),T=u.value.getSubData(this.exec,s.postfix,t),E=new Te(T.value,T.typeInfo);return T instanceof Te&&o instanceof Te&&(T.value=T.value&o.value),u.value instanceof ei&&u.value.setDataValue(this.exec,T,s.postfix,t),E}AtomicOr(e,t){let s=e.args[0];s instanceof _i&&(s=s.right);const a=this.exec.getVariableName(s,t),u=t.getVariable(a);let p=e.args[1];const o=this.exec.evalExpression(p,t),T=u.value.getSubData(this.exec,s.postfix,t),E=new Te(T.value,T.typeInfo);return T instanceof Te&&o instanceof Te&&(T.value=T.value|o.value),u.value instanceof ei&&u.value.setDataValue(this.exec,T,s.postfix,t),E}AtomicXor(e,t){let s=e.args[0];s instanceof _i&&(s=s.right);const a=this.exec.getVariableName(s,t),u=t.getVariable(a);let p=e.args[1];const o=this.exec.evalExpression(p,t),T=u.value.getSubData(this.exec,s.postfix,t),E=new Te(T.value,T.typeInfo);return T instanceof Te&&o instanceof Te&&(T.value=T.value^o.value),u.value instanceof ei&&u.value.setDataValue(this.exec,T,s.postfix,t),E}AtomicExchange(e,t){let s=e.args[0];s instanceof _i&&(s=s.right);const a=this.exec.getVariableName(s,t),u=t.getVariable(a);let p=e.args[1];const o=this.exec.evalExpression(p,t),T=u.value.getSubData(this.exec,s.postfix,t),E=new Te(T.value,T.typeInfo);return T instanceof Te&&o instanceof Te&&(T.value=o.value),u.value instanceof ei&&u.value.setDataValue(this.exec,T,s.postfix,t),E}AtomicCompareExchangeWeak(e,t){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(e,t){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(e,t){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(e,t){return console.error("TODO: pack4xI8"),null}Pack4xU8(e,t){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(e,t){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(e,t){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(e,t){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(e,t){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(e,t){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(e,t){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(e,t){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(e,t){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(e,t){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(e,t){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(e,t){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(e,t){return console.error("TODO: unpack2x16float"),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(e,t){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(e,t){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(e,t){return console.error("TODO: subgroupAll"),null}SubgroupAnd(e,t){return console.error("TODO: subgroupAnd"),null}SubgroupAny(e,t){return console.error("TODO: subgroupAny"),null}SubgroupBallot(e,t){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(e,t){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(e,t){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(e,t){return console.error("TODO: subgroupElect"),null}SubgroupMax(e,t){return console.error("TODO: subgroupMax"),null}SubgroupMin(e,t){return console.error("TODO: subgroupMin"),null}SubgroupMul(e,t){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(e,t){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(e,t){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(e,t){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(e,t){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(e,t){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(e,t){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(e,t){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(e,t){return console.error("TODO: subgroupXor"),null}QuadBroadcast(e,t){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(e,t){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(e,t){return console.error("TODO: quadSwapX"),null}QuadSwapY(e,t){return console.error("TODO: quadSwapY"),null}}const Yp={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},ln={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]};class Qi extends AE{constructor(e,t){var s;super(),this.ast=e??[],this.reflection=new ws,this.reflection.updateAST(this.ast),this.context=(s=t?.clone())!==null&&s!==void 0?s:new wm,this.builtins=new EE(this),this.typeInfo={bool:this.getTypeInfo(Ge.bool),i32:this.getTypeInfo(Ge.i32),u32:this.getTypeInfo(Ge.u32),f32:this.getTypeInfo(Ge.f32),f16:this.getTypeInfo(Ge.f16),vec2f:this.getTypeInfo(Ie.vec2f),vec2u:this.getTypeInfo(Ie.vec2u),vec2i:this.getTypeInfo(Ie.vec2i),vec2h:this.getTypeInfo(Ie.vec2h),vec3f:this.getTypeInfo(Ie.vec3f),vec3u:this.getTypeInfo(Ie.vec3u),vec3i:this.getTypeInfo(Ie.vec3i),vec3h:this.getTypeInfo(Ie.vec3h),vec4f:this.getTypeInfo(Ie.vec4f),vec4u:this.getTypeInfo(Ie.vec4u),vec4i:this.getTypeInfo(Ie.vec4i),vec4h:this.getTypeInfo(Ie.vec4h),mat2x2f:this.getTypeInfo(Ie.mat2x2f),mat2x3f:this.getTypeInfo(Ie.mat2x3f),mat2x4f:this.getTypeInfo(Ie.mat2x4f),mat3x2f:this.getTypeInfo(Ie.mat3x2f),mat3x3f:this.getTypeInfo(Ie.mat3x3f),mat3x4f:this.getTypeInfo(Ie.mat3x4f),mat4x2f:this.getTypeInfo(Ie.mat4x2f),mat4x3f:this.getTypeInfo(Ie.mat4x3f),mat4x4f:this.getTypeInfo(Ie.mat4x4f)}}getVariableValue(e){var t,s;const a=(s=(t=this.context.getVariable(e))===null||t===void 0?void 0:t.value)!==null&&s!==void 0?s:null;if(a===null)return null;if(a instanceof Te)return a.value;if(a instanceof ne||a instanceof Ot)return Array.from(a.data);if(a instanceof ei&&a.typeInfo instanceof Fo){if(a.typeInfo.format.name==="u32")return Array.from(new Uint32Array(a.buffer,a.offset,a.typeInfo.count));if(a.typeInfo.format.name==="i32")return Array.from(new Int32Array(a.buffer,a.offset,a.typeInfo.count));if(a.typeInfo.format.name==="f32")return Array.from(new Float32Array(a.buffer,a.offset,a.typeInfo.count))}return console.error(`Unsupported return variable type ${a.typeInfo.name}`),null}execute(e){(e=e??{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,s,a){const u=this.context.clone();(a=a??{}).constants&&this._setOverrides(a.constants,u),this._execStatements(this.ast,u);const p=u.getFunction(e);if(!p)return void console.error(`Function ${e} not found`);if(typeof t=="number")t=[t,1,1];else{if(t.length===0)return void console.error("Invalid dispatch count");t.length===1?t=[t[0],1,1]:t.length===2?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}const o=t[0],T=t[1],E=t[2],C=this.getTypeInfo("vec3u");u.setVariable("@num_workgroups",new ne(t,C));for(const O in s)for(const $ in s[O]){const V=s[O][$];u.variables.forEach(ie=>{var we;const Pe=ie.node;if(Pe?.attributes){let je=null,Ze=null;for(const Le of Pe.attributes)Le.name==="binding"?je=Le.value:Le.name==="group"&&(Ze=Le.value);if($==je&&O==Ze)if(V.texture!==void 0&&V.descriptor!==void 0){const Le=new $s(V.texture,this.getTypeInfo(Pe.type),V.descriptor,(we=V.texture.view)!==null&&we!==void 0?we:null);ie.value=Le}else V.uniform!==void 0?ie.value=new ei(V.uniform,this.getTypeInfo(Pe.type)):ie.value=new ei(V,this.getTypeInfo(Pe.type))}})}for(let O=0;O<E;++O)for(let $=0;$<T;++$)for(let V=0;V<o;++V)u.setVariable("@workgroup_id",new ne([V,$,O],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(p,[V,$,O],u)}execStatement(e,t){if(e instanceof Fx)return this.evalExpression(e.value,t);if(e instanceof Lx){if(e.condition){const s=this.evalExpression(e.condition,t);if(!(s instanceof Te))throw new Error("Invalid break-if condition");if(!s.value)return null}return Qi._breakObj}if(e instanceof Nx)return Qi._continueObj;if(e instanceof Bh)this._let(e,t);else if(e instanceof Ws)this._var(e,t);else if(e instanceof kd)this._const(e,t);else if(e instanceof jh)this._function(e,t);else{if(e instanceof Ox)return this._if(e,t);if(e instanceof Dx)return this._switch(e,t);if(e instanceof Px)return this._for(e,t);if(e instanceof Cx)return this._while(e,t);if(e instanceof kx)return this._loop(e,t);if(e instanceof Cg){const s=t.clone();return s.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,s)}if(e instanceof Rx)this._assign(e,t);else if(e instanceof Mx)this._increment(e,t);else{if(e instanceof js)return null;if(e instanceof gm){const s=e.name;t.getVariable(s)===null&&t.setVariable(s,new Te(0,this.getTypeInfo("u32")))}else if(e instanceof mm)this._call(e,t);else{if(e instanceof Bx||e instanceof _m)return null;console.error("Invalid statement type.",e,`Line ${e.line}`)}}}return null}evalExpression(e,t){return e instanceof Qn?this._evalBinaryOp(e,t):e instanceof Ii?this._evalLiteral(e,t):e instanceof An?this._evalVariable(e,t):e instanceof ym?this._evalCall(e,t):e instanceof vs?this._evalCreate(e,t):e instanceof zx?this._evalConst(e,t):e instanceof Ux?this._evalBitcast(e,t):e instanceof _i?this._evalUnaryOp(e,t):(console.error("Invalid expression type",e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof Ge){const a=this.reflection.getTypeInfo(e);if(a!==null)return a}let s=(t=this.typeInfo[e])!==null&&t!==void 0?t:null;return s!==null||(s=this.reflection.getTypeInfoByName(e)),s}_setOverrides(e,t){for(const s in e){const a=e[s],u=this.reflection.getOverrideInfo(s);u!==null?(u.type===null&&(u.type=this.getTypeInfo("u32")),u.type.name==="u32"||u.type.name==="i32"||u.type.name==="f32"||u.type.name==="f16"?t.setVariable(s,new Te(a,u.type)):u.type.name==="bool"?t.setVariable(s,new Te(a?1:0,u.type)):u.type.name==="vec2"||u.type.name==="vec3"||u.type.name==="vec4"||u.type.name==="vec2f"||u.type.name==="vec3f"||u.type.name==="vec4f"||u.type.name==="vec2i"||u.type.name==="vec3i"||u.type.name==="vec4i"||u.type.name==="vec2u"||u.type.name==="vec3u"||u.type.name==="vec4u"||u.type.name==="vec2h"||u.type.name==="vec3h"||u.type.name==="vec4h"?t.setVariable(s,new ne(a,u.type)):console.error(`Invalid constant type for ${s}`)):console.error(`Override ${s} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,s){const a=[1,1,1];for(const C of e.node.attributes)if(C.name==="workgroup_size"){if(C.value.length>0){const O=s.getVariableValue(C.value[0]);a[0]=O instanceof Te?O.value:parseInt(C.value[0])}if(C.value.length>1){const O=s.getVariableValue(C.value[1]);a[1]=O instanceof Te?O.value:parseInt(C.value[1])}if(C.value.length>2){const O=s.getVariableValue(C.value[2]);a[2]=O instanceof Te?O.value:parseInt(C.value[2])}}const u=this.getTypeInfo("vec3u"),p=this.getTypeInfo("u32");s.setVariable("@workgroup_size",new ne(a,u));const o=a[0],T=a[1],E=a[2];for(let C=0,O=0;C<E;++C)for(let $=0;$<T;++$)for(let V=0;V<o;++V,++O){const ie=[V,$,C],we=[V+t[0]*a[0],$+t[1]*a[1],C+t[2]*a[2]];s.setVariable("@local_invocation_id",new ne(ie,u)),s.setVariable("@global_invocation_id",new ne(we,u)),s.setVariable("@local_invocation_index",new Te(O,p)),this._dispatchExec(e,s)}}_dispatchExec(e,t){for(const s of e.node.args)for(const a of s.attributes)if(a.name==="builtin"){const u=`@${a.value}`,p=t.getVariable(u);p!==void 0&&t.variables.set(s.name,p)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof _i;)e=e.right;return e instanceof An?e.name:(console.error("Unknown variable type",e,"Line",e.line),null)}_execStatements(e,t){for(const s of e){if(s instanceof Array){const u=t.clone(),p=this._execStatements(s,u);if(p)return p;continue}const a=this.execStatement(s,t);if(a)return a}return null}_call(e,t){const s=t.clone();s.currentFunctionName=e.name;const a=t.getFunction(e.name);if(a){for(let u=0;u<a.node.args.length;++u){const p=a.node.args[u],o=this.evalExpression(e.args[u],s);s.setVariable(p.name,o,p)}this._execStatements(a.node.body,s)}else e.isBuiltin?this._callBuiltinFunction(e,s):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){const s=this.getVariableName(e.variable,t),a=t.getVariable(s);a?e.operator==="++"?a.value instanceof Te?a.value.value++:console.error(`Variable ${s} is not a scalar. Line ${e.line}`):e.operator==="--"?a.value instanceof Te?a.value.value--:console.error(`Variable ${s} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${s} not found. Line ${e.line}`)}_getVariableData(e,t){if(e instanceof An){const s=this.getVariableName(e,t),a=t.getVariable(s);return a===null?(console.error(`Variable ${s} not found. Line ${e.line}`),null):a.value.getSubData(this,e.postfix,t)}if(e instanceof _i){if(e.operator==="*"){const s=this._getVariableData(e.right,t);return s instanceof $l?s.reference.getSubData(this,e.postfix,t):(console.error(`Variable ${e.right} is not a pointer. Line ${e.line}`),null)}if(e.operator==="&"){const s=this._getVariableData(e.right,t);return new $l(s)}}return null}_assign(e,t){let s=null,a="<var>",u=null;if(e.variable instanceof _i){const T=this._getVariableData(e.variable,t),E=this.evalExpression(e.value,t),C=e.operator;if(C==="="){if(T instanceof Te||T instanceof ne||T instanceof Ot){if(E instanceof Te||E instanceof ne||E instanceof Ot&&T.data.length===E.data.length)return void T.data.set(E.data);console.error(`Invalid assignment. Line ${e.line}`)}else if(T instanceof ei&&E instanceof ei&&T.buffer.byteLength-T.offset>=E.buffer.byteLength-E.offset)return void(T.buffer.byteLength%4==0?new Uint32Array(T.buffer,T.offset,T.typeInfo.size/4).set(new Uint32Array(E.buffer,E.offset,E.typeInfo.size/4)):new Uint8Array(T.buffer,T.offset,T.typeInfo.size).set(new Uint8Array(E.buffer,E.offset,E.typeInfo.size)));return console.error(`Invalid assignment. Line ${e.line}`),null}if(C==="+=")return T instanceof Te||T instanceof ne||T instanceof Ot?E instanceof Te||E instanceof ne||E instanceof Ot?void T.data.set(E.data.map((O,$)=>T.data[$]+O)):void console.error(`Invalid assignment . Line ${e.line}`):void console.error(`Invalid assignment. Line ${e.line}`);if(C==="-=")return(T instanceof Te||T instanceof ne||T instanceof Ot)&&(E instanceof Te||E instanceof ne||E instanceof Ot)?void T.data.set(E.data.map((O,$)=>T.data[$]-O)):void console.error(`Invalid assignment. Line ${e.line}`)}if(e.variable instanceof _i){if(e.variable.operator==="*"){a=this.getVariableName(e.variable.right,t);const T=t.getVariable(a);if(!(T&&T.value instanceof $l))return void console.error(`Variable ${a} is not a pointer. Line ${e.line}`);s=T.value.reference;let E=e.variable.postfix;if(!E){let C=e.variable.right;for(;C instanceof _i;){if(C.postfix){E=C.postfix;break}C=C.right}}E&&(s=s.getSubData(this,E,t))}}else{u=e.variable.postfix,a=this.getVariableName(e.variable,t);const T=t.getVariable(a);if(T===null)return void console.error(`Variable ${a} not found. Line ${e.line}`);s=T.value}if(s instanceof $l&&(s=s.reference),s===null)return void console.error(`Variable ${a} not found. Line ${e.line}`);const p=this.evalExpression(e.value,t),o=e.operator;if(o==="=")if(s instanceof ei)s.setDataValue(this,p,u,t);else if(u){if(!(s instanceof ne||s instanceof Ot))return void console.error(`Variable ${a} is not a vector or matrix. Line ${e.line}`);if(u instanceof nc){const T=this.evalExpression(u.index,t).value;if(s instanceof ne){if(!(p instanceof Te))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);s.data[T]=p.value}else{if(!(s instanceof Ot))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);{const E=this.evalExpression(u.index,t).value;if(E<0)return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);if(!(p instanceof ne))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);{const C=s.typeInfo.getTypeName();if(C==="mat2x2"||C==="mat2x2f"||C==="mat2x2h"){if(!(E<2&&p.data.length===2))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);s.data[2*E]=p.data[0],s.data[2*E+1]=p.data[1]}else if(C==="mat2x3"||C==="mat2x3f"||C==="mat2x3h"){if(!(E<2&&p.data.length===3))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);s.data[3*E]=p.data[0],s.data[3*E+1]=p.data[1],s.data[3*E+2]=p.data[2]}else if(C==="mat2x4"||C==="mat2x4f"||C==="mat2x4h"){if(!(E<2&&p.data.length===4))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);s.data[4*E]=p.data[0],s.data[4*E+1]=p.data[1],s.data[4*E+2]=p.data[2],s.data[4*E+3]=p.data[3]}else if(C==="mat3x2"||C==="mat3x2f"||C==="mat3x2h"){if(!(E<3&&p.data.length===2))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);s.data[2*E]=p.data[0],s.data[2*E+1]=p.data[1]}else if(C==="mat3x3"||C==="mat3x3f"||C==="mat3x3h"){if(!(E<3&&p.data.length===3))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);s.data[3*E]=p.data[0],s.data[3*E+1]=p.data[1],s.data[3*E+2]=p.data[2]}else if(C==="mat3x4"||C==="mat3x4f"||C==="mat3x4h"){if(!(E<3&&p.data.length===4))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);s.data[4*E]=p.data[0],s.data[4*E+1]=p.data[1],s.data[4*E+2]=p.data[2],s.data[4*E+3]=p.data[3]}else if(C==="mat4x2"||C==="mat4x2f"||C==="mat4x2h"){if(!(E<4&&p.data.length===2))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);s.data[2*E]=p.data[0],s.data[2*E+1]=p.data[1]}else if(C==="mat4x3"||C==="mat4x3f"||C==="mat4x3h"){if(!(E<4&&p.data.length===3))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);s.data[3*E]=p.data[0],s.data[3*E+1]=p.data[1],s.data[3*E+2]=p.data[2]}else{if(C!=="mat4x4"&&C!=="mat4x4f"&&C!=="mat4x4h")return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);if(!(E<4&&p.data.length===4))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);s.data[4*E]=p.data[0],s.data[4*E+1]=p.data[1],s.data[4*E+2]=p.data[2],s.data[4*E+3]=p.data[3]}}}}}else if(u instanceof Na){const T=u.value;if(!(s instanceof ne))return void console.error(`Invalid assignment to ${T}. Variable ${a} is not a vector. Line ${e.line}`);if(p instanceof Te){if(T.length>1)return void console.error(`Invalid assignment to ${T} for variable ${a}. Line ${e.line}`);if(T==="x")s.data[0]=p.value;else if(T==="y"){if(s.data.length<2)return void console.error(`Invalid assignment to ${T} for variable ${a}. Line ${e.line}`);s.data[1]=p.value}else if(T==="z"){if(s.data.length<3)return void console.error(`Invalid assignment to ${T} for variable ${a}. Line ${e.line}`);s.data[2]=p.value}else if(T==="w"){if(s.data.length<4)return void console.error(`Invalid assignment to ${T} for variable ${a}. Line ${e.line}`);s.data[3]=p.value}}else{if(!(p instanceof ne))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);if(T.length!==p.data.length)return void console.error(`Invalid assignment to ${T} for variable ${a}. Line ${e.line}`);for(let E=0;E<T.length;++E){const C=T[E];if(C==="x"||C==="r")s.data[0]=p.data[E];else if(C==="y"||C==="g"){if(p.data.length<2)return void console.error(`Invalid assignment to ${C} for variable ${a}. Line ${e.line}`);s.data[1]=p.data[E]}else if(C==="z"||C==="b"){if(p.data.length<3)return void console.error(`Invalid assignment to ${C} for variable ${a}. Line ${e.line}`);s.data[2]=p.data[E]}else{if(C!=="w"&&C!=="a")return void console.error(`Invalid assignment to ${C} for variable ${a}. Line ${e.line}`);if(p.data.length<4)return void console.error(`Invalid assignment to ${C} for variable ${a}. Line ${e.line}`);s.data[3]=p.data[E]}}}}}else s instanceof Te&&p instanceof Te?s.value=p.value:s instanceof ne&&p instanceof ne||s instanceof Ot&&p instanceof Ot?s.data.set(p.data):console.error(`Invalid assignment to ${a}. Line ${e.line}`);else{const T=s.getSubData(this,u,t);if(T instanceof ne&&p instanceof Te){const E=T.data,C=p.value;if(o==="+=")for(let O=0;O<E.length;++O)E[O]+=C;else if(o==="-=")for(let O=0;O<E.length;++O)E[O]-=C;else if(o==="*=")for(let O=0;O<E.length;++O)E[O]*=C;else if(o==="/=")for(let O=0;O<E.length;++O)E[O]/=C;else if(o==="%=")for(let O=0;O<E.length;++O)E[O]%=C;else if(o==="&=")for(let O=0;O<E.length;++O)E[O]&=C;else if(o==="|=")for(let O=0;O<E.length;++O)E[O]|=C;else if(o==="^=")for(let O=0;O<E.length;++O)E[O]^=C;else if(o==="<<=")for(let O=0;O<E.length;++O)E[O]<<=C;else if(o===">>=")for(let O=0;O<E.length;++O)E[O]>>=C;else console.error(`Invalid operator ${o}. Line ${e.line}`)}else if(T instanceof ne&&p instanceof ne){const E=T.data,C=p.data;if(E.length!==C.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if(o==="+=")for(let O=0;O<E.length;++O)E[O]+=C[O];else if(o==="-=")for(let O=0;O<E.length;++O)E[O]-=C[O];else if(o==="*=")for(let O=0;O<E.length;++O)E[O]*=C[O];else if(o==="/=")for(let O=0;O<E.length;++O)E[O]/=C[O];else if(o==="%=")for(let O=0;O<E.length;++O)E[O]%=C[O];else if(o==="&=")for(let O=0;O<E.length;++O)E[O]&=C[O];else if(o==="|=")for(let O=0;O<E.length;++O)E[O]|=C[O];else if(o==="^=")for(let O=0;O<E.length;++O)E[O]^=C[O];else if(o==="<<=")for(let O=0;O<E.length;++O)E[O]<<=C[O];else if(o===">>=")for(let O=0;O<E.length;++O)E[O]>>=C[O];else console.error(`Invalid operator ${o}. Line ${e.line}`)}else{if(!(T instanceof Te&&p instanceof Te))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);o==="+="?T.value+=p.value:o==="-="?T.value-=p.value:o==="*="?T.value*=p.value:o==="/="?T.value/=p.value:o==="%="?T.value%=p.value:o==="&="?T.value&=p.value:o==="|="?T.value|=p.value:o==="^="?T.value^=p.value:o==="<<="?T.value<<=p.value:o===">>="?T.value>>=p.value:console.error(`Invalid operator ${o}. Line ${e.line}`)}s instanceof ei&&s.setDataValue(this,T,u,t)}}_function(e,t){const s=new xm(e);t.functions.set(e.name,s)}_const(e,t){let s=null;e.value!==null&&(s=this.evalExpression(e.value,t)),t.createVariable(e.name,s,e)}_let(e,t){let s=null;if(e.value!==null){if(s=this.evalExpression(e.value,t),s===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof _i||(s=s.clone())}else{const a=e.type.name;if(a==="f32"||a==="i32"||a==="u32"||a==="bool"||a==="f16"||a==="vec2"||a==="vec3"||a==="vec4"||a==="vec2f"||a==="vec3f"||a==="vec4f"||a==="vec2i"||a==="vec3i"||a==="vec4i"||a==="vec2u"||a==="vec3u"||a==="vec4u"||a==="vec2h"||a==="vec3h"||a==="vec4h"||a==="vec2b"||a==="vec3b"||a==="vec4b"||a==="mat2x2"||a==="mat2x3"||a==="mat2x4"||a==="mat3x2"||a==="mat3x3"||a==="mat3x4"||a==="mat4x2"||a==="mat4x3"||a==="mat4x4"||a==="mat2x2f"||a==="mat2x3f"||a==="mat2x4f"||a==="mat3x2f"||a==="mat3x3f"||a==="mat3x4f"||a==="mat4x2f"||a==="mat4x3f"||a==="mat4x4f"||a==="mat2x2h"||a==="mat2x3h"||a==="mat2x4h"||a==="mat3x2h"||a==="mat3x3h"||a==="mat3x4h"||a==="mat4x2h"||a==="mat4x3h"||a==="mat4x4h"||a==="array"){const u=new vs(e.type,[]);s=this._evalCreate(u,t)}}t.createVariable(e.name,s,e)}_var(e,t){let s=null;if(e.value!==null){if(s=this.evalExpression(e.value,t),s===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof _i||(s=s.clone())}else{if(e.type===null)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);const a=e.type.name;if(a==="f32"||a==="i32"||a==="u32"||a==="bool"||a==="f16"||a==="vec2"||a==="vec3"||a==="vec4"||a==="vec2f"||a==="vec3f"||a==="vec4f"||a==="vec2i"||a==="vec3i"||a==="vec4i"||a==="vec2u"||a==="vec3u"||a==="vec4u"||a==="vec2h"||a==="vec3h"||a==="vec4h"||a==="vec2b"||a==="vec3b"||a==="vec4b"||a==="mat2x2"||a==="mat2x3"||a==="mat2x4"||a==="mat3x2"||a==="mat3x3"||a==="mat3x4"||a==="mat4x2"||a==="mat4x3"||a==="mat4x4"||a==="mat2x2f"||a==="mat2x3f"||a==="mat2x4f"||a==="mat3x2f"||a==="mat3x3f"||a==="mat3x4f"||a==="mat4x2f"||a==="mat4x3f"||a==="mat4x4f"||a==="mat2x2h"||a==="mat2x3h"||a==="mat2x4h"||a==="mat3x2h"||a==="mat3x3h"||a==="mat3x4h"||a==="mat4x2h"||a==="mat4x3h"||a==="mat4x4h"||e.type instanceof Lh||e.type instanceof js||e.type instanceof Ie){const u=new vs(e.type,[]);s=this._evalCreate(u,t)}}t.createVariable(e.name,s,e)}_switch(e,t){t=t.clone();const s=this.evalExpression(e.condition,t);if(!(s instanceof Te))return console.error(`Invalid if condition. Line ${e.line}`),null;let a=null;for(const u of e.cases)if(u instanceof $x)for(const p of u.selectors){if(p instanceof Od){a=u;continue}const o=this.evalExpression(p,t);if(!(o instanceof Te))return console.error(`Invalid case selector. Line ${e.line}`),null;if(o.value===s.value)return this._execStatements(u.body,t)}else u instanceof Wx&&(a=u);return a?this._execStatements(a.body,t):null}_if(e,t){t=t.clone();const s=this.evalExpression(e.condition,t);if(!(s instanceof Te))return console.error(`Invalid if condition. Line ${e.line}`),null;if(s.value)return this._execStatements(e.body,t);for(const a of e.elseif){const u=this.evalExpression(a.condition,t);if(!(u instanceof Te))return console.error(`Invalid if condition. Line ${e.line}`),null;if(u.value)return this._execStatements(a.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof Te?e.value:(console.error("Expected scalar value.",e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){const s=this._execStatements(e.body,t);if(s===Qi._breakObj)break;if(s!==null&&s!==Qi._continueObj)return s;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){const s=this._execStatements(e.body,t);if(s===Qi._breakObj)break;if(s===Qi._continueObj){if(e.continuing&&this._execStatements(e.continuing.body,t)===Qi._breakObj)break}else if(s!==null)return s}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){const s=this._execStatements(e.body,t);if(s===Qi._breakObj)break;if(s!==Qi._continueObj&&s!==null)return s}return null}_evalBitcast(e,t){const s=this.evalExpression(e.value,t),a=e.type;if(s instanceof Te){const u=yb(s.value,s.typeInfo.name,a.name);return new Te(u,this.getTypeInfo(a))}if(s instanceof ne){const u=s.typeInfo.getTypeName();let p="";if(u.endsWith("f"))p="f32";else if(u.endsWith("i"))p="i32";else if(u.endsWith("u"))p="u32";else if(u.endsWith("b"))p="bool";else{if(!u.endsWith("h"))return console.error(`Unknown vector type ${u}. Line ${e.line}`),null;p="f16"}const o=a.getTypeName();let T="";if(o.endsWith("f"))T="f32";else if(o.endsWith("i"))T="i32";else if(o.endsWith("u"))T="u32";else if(o.endsWith("b"))T="bool";else{if(!o.endsWith("h"))return console.error(`Unknown vector type ${T}. Line ${e.line}`),null;T="f16"}const E=function(C,O,$){if(O===$)return C;const V=new Array(C.length);for(let ie=0;ie<C.length;ie++)V[ie]=yb(C[ie],O,$);return V}(Array.from(s.data),p,T);return new ne(E,this.getTypeInfo(a))}return console.error(`TODO: bitcast for ${s.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){var s;if(e instanceof vs){if(e.type===null)return Pg.void;switch(e.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(e,t);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(e,t);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(e,t)}}const a=e instanceof vs?e.type.name:e.name,u=e instanceof vs?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(u===null)return console.error(`Unknown type ${a}. Line ${e.line}`),null;if(u.size===0)return null;const p=new ei(new ArrayBuffer(u.size),u,0);if(u instanceof Ro){if(e.args)for(let o=0;o<e.args.length;++o){const T=u.members[o],E=e.args[o],C=this.evalExpression(E,t);p.setData(this,C,T.type,T.offset,t)}}else if(u instanceof Fo){let o=0;if(e.args)for(let T=0;T<e.args.length;++T){const E=e.args[T],C=this.evalExpression(E,t);u.format===null&&(((s=C.typeInfo)===null||s===void 0?void 0:s.name)==="x32"?u.format=this.getTypeInfo("i32"):u.format=C.typeInfo),p.setData(this,C,u.format,o,t),o+=u.stride}}else console.error(`Unknown type "${a}". Line ${e.line}`);return e instanceof vs?p.getSubData(this,e.postfix,t):p}_evalLiteral(e,t){const s=this.getTypeInfo(e.type),a=s.name;return a==="x32"||a==="u32"||a==="f32"||a==="f16"||a==="i32"||a==="bool"?new Te(e.scalarValue,s):a==="vec2"||a==="vec3"||a==="vec4"||a==="vec2f"||a==="vec3f"||a==="vec4f"||a==="vec2h"||a==="vec3h"||a==="vec4h"||a==="vec2i"||a==="vec3i"||a==="vec4i"||a==="vec2u"||a==="vec3u"||a==="vec4u"?this._callConstructorVec(e,t):a==="mat2x2"||a==="mat2x3"||a==="mat2x4"||a==="mat3x2"||a==="mat3x3"||a==="mat3x4"||a==="mat4x2"||a==="mat4x3"||a==="mat4x4"||a==="mat2x2f"||a==="mat2x3f"||a==="mat2x4f"||a==="mat3x2f"||a==="mat3x3f"||a==="mat3x4f"||a==="mat4x2f"||a==="mat4x3f"||a==="mat4x4f"||a==="mat2x2h"||a==="mat2x3h"||a==="mat2x4h"||a==="mat3x2h"||a==="mat3x3h"||a==="mat3x4h"||a==="mat4x2h"||a==="mat4x3h"||a==="mat4x4h"?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){const s=t.getVariableValue(e.name);return s===null?s:s.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(e){let t=e[0];if(t.name==="f32")return t;for(let s=1;s<e.length;++s){const a=Qi._priority.get(t.name);Qi._priority.get(e[s].name)<a&&(t=e[s])}return t.name==="x32"?this.getTypeInfo("i32"):t}_evalUnaryOp(e,t){const s=this.evalExpression(e.right,t);if(e.operator==="&")return new $l(s);if(e.operator==="*")return s instanceof $l?s.reference.getSubData(this,e.postfix,t):(console.error(`Invalid dereference. Line ${e.line}`),null);const a=s instanceof Te?s.value:s instanceof ne?Array.from(s.data):null;switch(e.operator){case"+":{if(dt(a)){const o=a.map((T,E)=>+T);return new ne(o,s.typeInfo)}const u=a,p=this._maxFormatTypeInfo([s.typeInfo,s.typeInfo]);return new Te(+u,p)}case"-":{if(dt(a)){const o=a.map((T,E)=>-T);return new ne(o,s.typeInfo)}const u=a,p=this._maxFormatTypeInfo([s.typeInfo,s.typeInfo]);return new Te(-u,p)}case"!":{if(dt(a)){const o=a.map((T,E)=>T?0:1);return new ne(o,s.typeInfo)}const u=a,p=this._maxFormatTypeInfo([s.typeInfo,s.typeInfo]);return new Te(u?0:1,p)}case"~":{if(dt(a)){const o=a.map((T,E)=>~T);return new ne(o,s.typeInfo)}const u=a,p=this._maxFormatTypeInfo([s.typeInfo,s.typeInfo]);return new Te(~u,p)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){const s=this.evalExpression(e.left,t),a=this.evalExpression(e.right,t),u=s instanceof Te?s.value:s instanceof ne||s instanceof Ot?Array.from(s.data):null,p=a instanceof Te?a.value:a instanceof ne||a instanceof Ot?Array.from(a.data):null;switch(e.operator){case"+":{if(dt(u)&&dt(p)){const C=u,O=p;if(C.length!==O.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const $=C.map((V,ie)=>V+O[ie]);return new ne($,s.typeInfo)}if(dt(u)){const C=p,O=u.map(($,V)=>$+C);return new ne(O,s.typeInfo)}if(dt(p)){const C=u,O=p.map(($,V)=>C+$);return new ne(O,a.typeInfo)}const o=u,T=p,E=this._maxFormatTypeInfo([s.typeInfo,a.typeInfo]);return new Te(o+T,E)}case"-":{if(dt(u)&&dt(p)){const C=u,O=p;if(C.length!==O.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const $=C.map((V,ie)=>V-O[ie]);return new ne($,s.typeInfo)}if(dt(u)){const C=p,O=u.map(($,V)=>$-C);return new ne(O,s.typeInfo)}if(dt(p)){const C=u,O=p.map(($,V)=>C-$);return new ne(O,a.typeInfo)}const o=u,T=p,E=this._maxFormatTypeInfo([s.typeInfo,a.typeInfo]);return new Te(o-T,E)}case"*":{if(dt(u)&&dt(p)){const C=u,O=p;if(s instanceof Ot&&a instanceof Ot){const $=function(Pe,je,Ze,Le){if(ln[je.name]===void 0||ln[Le.name]===void 0)return null;const Ue=ln[je.name][0],et=ln[je.name][1],Ke=ln[Le.name][0];if(Ue!==ln[Le.name][1])return null;const ct=new Array(Ke*et);for(let me=0;me<et;me++)for(let _e=0;_e<Ke;_e++){let ze=0;for(let Qe=0;Qe<Ue;Qe++)ze+=Pe[Qe*et+me]*Ze[_e*Ue+Qe];ct[me*Ke+_e]=ze}return ct}(C,s.typeInfo,O,a.typeInfo);if($===null)return console.error(`Matrix multiplication failed. Line ${e.line}.`),null;const V=ln[a.typeInfo.name][0],ie=ln[s.typeInfo.name][1],we=this.getTypeInfo(`mat${V}x${ie}f`);return new Ot($,we)}if(s instanceof Ot&&a instanceof ne){const $=function(V,ie,we,Pe){if(ln[ie.name]===void 0||Yp[Pe.name]===void 0)return null;const je=ln[ie.name][0],Ze=ln[ie.name][1];if(je!==we.length)return null;const Le=new Array(Ze);for(let Ue=0;Ue<Ze;Ue++){let et=0;for(let Ke=0;Ke<je;Ke++)et+=V[Ke*Ze+Ue]*we[Ke];Le[Ue]=et}return Le}(C,s.typeInfo,O,a.typeInfo);return $===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new ne($,a.typeInfo)}if(s instanceof ne&&a instanceof Ot){const $=function(V,ie,we,Pe){if(Yp[ie.name]===void 0||ln[Pe.name]===void 0)return null;const je=ln[Pe.name][0],Ze=ln[Pe.name][1];if(Ze!==V.length)return null;const Le=[];for(let Ue=0;Ue<je;Ue++){let et=0;for(let Ke=0;Ke<Ze;Ke++)et+=V[Ke]*we[Ke*je+Ue];Le[Ue]=et}return Le}(C,s.typeInfo,O,a.typeInfo);return $===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new ne($,s.typeInfo)}{if(C.length!==O.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const $=C.map((V,ie)=>V*O[ie]);return new ne($,s.typeInfo)}}if(dt(u)){const C=p,O=u.map(($,V)=>$*C);return s instanceof Ot?new Ot(O,s.typeInfo):new ne(O,s.typeInfo)}if(dt(p)){const C=u,O=p.map(($,V)=>C*$);return a instanceof Ot?new Ot(O,a.typeInfo):new ne(O,a.typeInfo)}const o=u,T=p,E=this._maxFormatTypeInfo([s.typeInfo,a.typeInfo]);return new Te(o*T,E)}case"%":{if(dt(u)&&dt(p)){const C=u,O=p;if(C.length!==O.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const $=C.map((V,ie)=>V%O[ie]);return new ne($,s.typeInfo)}if(dt(u)){const C=p,O=u.map(($,V)=>$%C);return new ne(O,s.typeInfo)}if(dt(p)){const C=u,O=p.map(($,V)=>C%$);return new ne(O,a.typeInfo)}const o=u,T=p,E=this._maxFormatTypeInfo([s.typeInfo,a.typeInfo]);return new Te(o%T,E)}case"/":{if(dt(u)&&dt(p)){const C=u,O=p;if(C.length!==O.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const $=C.map((V,ie)=>V/O[ie]);return new ne($,s.typeInfo)}if(dt(u)){const C=p,O=u.map(($,V)=>$/C);return new ne(O,s.typeInfo)}if(dt(p)){const C=u,O=p.map(($,V)=>C/$);return new ne(O,a.typeInfo)}const o=u,T=p,E=this._maxFormatTypeInfo([s.typeInfo,a.typeInfo]);return new Te(o/T,E)}case"&":{if(dt(u)&&dt(p)){const C=u,O=p;if(C.length!==O.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const $=C.map((V,ie)=>V&O[ie]);return new ne($,s.typeInfo)}if(dt(u)){const C=p,O=u.map(($,V)=>$&C);return new ne(O,s.typeInfo)}if(dt(p)){const C=u,O=p.map(($,V)=>C&$);return new ne(O,a.typeInfo)}const o=u,T=p,E=this._maxFormatTypeInfo([s.typeInfo,a.typeInfo]);return new Te(o&T,E)}case"|":{if(dt(u)&&dt(p)){const C=u,O=p;if(C.length!==O.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const $=C.map((V,ie)=>V|O[ie]);return new ne($,s.typeInfo)}if(dt(u)){const C=p,O=u.map(($,V)=>$|C);return new ne(O,s.typeInfo)}if(dt(p)){const C=u,O=p.map(($,V)=>C|$);return new ne(O,a.typeInfo)}const o=u,T=p,E=this._maxFormatTypeInfo([s.typeInfo,a.typeInfo]);return new Te(o|T,E)}case"^":{if(dt(u)&&dt(p)){const C=u,O=p;if(C.length!==O.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const $=C.map((V,ie)=>V^O[ie]);return new ne($,s.typeInfo)}if(dt(u)){const C=p,O=u.map(($,V)=>$^C);return new ne(O,s.typeInfo)}if(dt(p)){const C=u,O=p.map(($,V)=>C^$);return new ne(O,a.typeInfo)}const o=u,T=p,E=this._maxFormatTypeInfo([s.typeInfo,a.typeInfo]);return new Te(o^T,E)}case"<<":{if(dt(u)&&dt(p)){const C=u,O=p;if(C.length!==O.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const $=C.map((V,ie)=>V<<O[ie]);return new ne($,s.typeInfo)}if(dt(u)){const C=p,O=u.map(($,V)=>$<<C);return new ne(O,s.typeInfo)}if(dt(p)){const C=u,O=p.map(($,V)=>C<<$);return new ne(O,a.typeInfo)}const o=u,T=p,E=this._maxFormatTypeInfo([s.typeInfo,a.typeInfo]);return new Te(o<<T,E)}case">>":{if(dt(u)&&dt(p)){const C=u,O=p;if(C.length!==O.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const $=C.map((V,ie)=>V>>O[ie]);return new ne($,s.typeInfo)}if(dt(u)){const C=p,O=u.map(($,V)=>$>>C);return new ne(O,s.typeInfo)}if(dt(p)){const C=u,O=p.map(($,V)=>C>>$);return new ne(O,a.typeInfo)}const o=u,T=p,E=this._maxFormatTypeInfo([s.typeInfo,a.typeInfo]);return new Te(o>>T,E)}case">":if(dt(u)&&dt(p)){const o=u,T=p;if(o.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const E=o.map((C,O)=>C>T[O]?1:0);return new ne(E,s.typeInfo)}if(dt(u)){const o=p,T=u.map((E,C)=>E>o?1:0);return new ne(T,s.typeInfo)}if(dt(p)){const o=u,T=p.map((E,C)=>o>E?1:0);return new ne(T,a.typeInfo)}return new Te(u>p?1:0,this.getTypeInfo("bool"));case"<":if(dt(u)&&dt(p)){const o=u,T=p;if(o.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const E=o.map((C,O)=>C<T[O]?1:0);return new ne(E,s.typeInfo)}if(dt(u)){const o=p,T=u.map((E,C)=>E<o?1:0);return new ne(T,s.typeInfo)}if(dt(p)){const o=u,T=p.map((E,C)=>o<E?1:0);return new ne(T,a.typeInfo)}return new Te(u<p?1:0,this.getTypeInfo("bool"));case"==":if(dt(u)&&dt(p)){const o=u,T=p;if(o.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const E=o.map((C,O)=>C===T[O]?1:0);return new ne(E,s.typeInfo)}if(dt(u)){const o=p,T=u.map((E,C)=>E==o?1:0);return new ne(T,s.typeInfo)}if(dt(p)){const o=u,T=p.map((E,C)=>o==E?1:0);return new ne(T,a.typeInfo)}return new Te(u===p?1:0,this.getTypeInfo("bool"));case"!=":if(dt(u)&&dt(p)){const o=u,T=p;if(o.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const E=o.map((C,O)=>C!==T[O]?1:0);return new ne(E,s.typeInfo)}if(dt(u)){const o=p,T=u.map((E,C)=>E!==o?1:0);return new ne(T,s.typeInfo)}if(dt(p)){const o=u,T=p.map((E,C)=>o!==E?1:0);return new ne(T,a.typeInfo)}return new Te(u!==p?1:0,this.getTypeInfo("bool"));case">=":if(dt(u)&&dt(p)){const o=u,T=p;if(o.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const E=o.map((C,O)=>C>=T[O]?1:0);return new ne(E,s.typeInfo)}if(dt(u)){const o=p,T=u.map((E,C)=>E>=o?1:0);return new ne(T,s.typeInfo)}if(dt(p)){const o=u,T=p.map((E,C)=>o>=E?1:0);return new ne(T,a.typeInfo)}return new Te(u>=p?1:0,this.getTypeInfo("bool"));case"<=":if(dt(u)&&dt(p)){const o=u,T=p;if(o.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const E=o.map((C,O)=>C<=T[O]?1:0);return new ne(E,s.typeInfo)}if(dt(u)){const o=p,T=u.map((E,C)=>E<=o?1:0);return new ne(T,s.typeInfo)}if(dt(p)){const o=u,T=p.map((E,C)=>o<=E?1:0);return new ne(T,a.typeInfo)}return new Te(u<=p?1:0,this.getTypeInfo("bool"));case"&&":if(dt(u)&&dt(p)){const o=u,T=p;if(o.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const E=o.map((C,O)=>C&&T[O]?1:0);return new ne(E,s.typeInfo)}if(dt(u)){const o=p,T=u.map((E,C)=>E&&o?1:0);return new ne(T,s.typeInfo)}if(dt(p)){const o=u,T=p.map((E,C)=>o&&E?1:0);return new ne(T,a.typeInfo)}return new Te(u&&p?1:0,this.getTypeInfo("bool"));case"||":if(dt(u)&&dt(p)){const o=u,T=p;if(o.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const E=o.map((C,O)=>C||T[O]?1:0);return new ne(E,s.typeInfo)}if(dt(u)){const o=p,T=u.map((E,C)=>E||o?1:0);return new ne(T,s.typeInfo)}if(dt(p)){const o=u,T=p.map((E,C)=>o||E?1:0);return new ne(T,a.typeInfo)}return new Te(u||p?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(e.cachedReturnValue!==null)return e.cachedReturnValue;const s=t.clone();s.currentFunctionName=e.name;const a=t.getFunction(e.name);if(!a)return e.isBuiltin?this._callBuiltinFunction(e,s):this.getTypeInfo(e.name)?this._evalCreate(e,t):(console.error(`Unknown function "${e.name}". Line ${e.line}`),null);for(let u=0;u<a.node.args.length;++u){const p=a.node.args[u],o=this.evalExpression(e.args[u],s);s.createVariable(p.name,o,p)}return this._execStatements(a.node.body,s)}_callBuiltinFunction(e,t){switch(e.name){case"all":return this.builtins.All(e,t);case"any":return this.builtins.Any(e,t);case"select":return this.builtins.Select(e,t);case"arrayLength":return this.builtins.ArrayLength(e,t);case"abs":return this.builtins.Abs(e,t);case"acos":return this.builtins.Acos(e,t);case"acosh":return this.builtins.Acosh(e,t);case"asin":return this.builtins.Asin(e,t);case"asinh":return this.builtins.Asinh(e,t);case"atan":return this.builtins.Atan(e,t);case"atanh":return this.builtins.Atanh(e,t);case"atan2":return this.builtins.Atan2(e,t);case"ceil":return this.builtins.Ceil(e,t);case"clamp":return this.builtins.Clamp(e,t);case"cos":return this.builtins.Cos(e,t);case"cosh":return this.builtins.Cosh(e,t);case"countLeadingZeros":return this.builtins.CountLeadingZeros(e,t);case"countOneBits":return this.builtins.CountOneBits(e,t);case"countTrailingZeros":return this.builtins.CountTrailingZeros(e,t);case"cross":return this.builtins.Cross(e,t);case"degrees":return this.builtins.Degrees(e,t);case"determinant":return this.builtins.Determinant(e,t);case"distance":return this.builtins.Distance(e,t);case"dot":return this.builtins.Dot(e,t);case"dot4U8Packed":return this.builtins.Dot4U8Packed(e,t);case"dot4I8Packed":return this.builtins.Dot4I8Packed(e,t);case"exp":return this.builtins.Exp(e,t);case"exp2":return this.builtins.Exp2(e,t);case"extractBits":return this.builtins.ExtractBits(e,t);case"faceForward":return this.builtins.FaceForward(e,t);case"firstLeadingBit":return this.builtins.FirstLeadingBit(e,t);case"firstTrailingBit":return this.builtins.FirstTrailingBit(e,t);case"floor":return this.builtins.Floor(e,t);case"fma":return this.builtins.Fma(e,t);case"fract":return this.builtins.Fract(e,t);case"frexp":return this.builtins.Frexp(e,t);case"insertBits":return this.builtins.InsertBits(e,t);case"inverseSqrt":return this.builtins.InverseSqrt(e,t);case"ldexp":return this.builtins.Ldexp(e,t);case"length":return this.builtins.Length(e,t);case"log":return this.builtins.Log(e,t);case"log2":return this.builtins.Log2(e,t);case"max":return this.builtins.Max(e,t);case"min":return this.builtins.Min(e,t);case"mix":return this.builtins.Mix(e,t);case"modf":return this.builtins.Modf(e,t);case"normalize":return this.builtins.Normalize(e,t);case"pow":return this.builtins.Pow(e,t);case"quantizeToF16":return this.builtins.QuantizeToF16(e,t);case"radians":return this.builtins.Radians(e,t);case"reflect":return this.builtins.Reflect(e,t);case"refract":return this.builtins.Refract(e,t);case"reverseBits":return this.builtins.ReverseBits(e,t);case"round":return this.builtins.Round(e,t);case"saturate":return this.builtins.Saturate(e,t);case"sign":return this.builtins.Sign(e,t);case"sin":return this.builtins.Sin(e,t);case"sinh":return this.builtins.Sinh(e,t);case"smoothStep":return this.builtins.SmoothStep(e,t);case"sqrt":return this.builtins.Sqrt(e,t);case"step":return this.builtins.Step(e,t);case"tan":return this.builtins.Tan(e,t);case"tanh":return this.builtins.Tanh(e,t);case"transpose":return this.builtins.Transpose(e,t);case"trunc":return this.builtins.Trunc(e,t);case"dpdx":return this.builtins.Dpdx(e,t);case"dpdxCoarse":return this.builtins.DpdxCoarse(e,t);case"dpdxFine":return this.builtins.DpdxFine(e,t);case"dpdy":return this.builtins.Dpdy(e,t);case"dpdyCoarse":return this.builtins.DpdyCoarse(e,t);case"dpdyFine":return this.builtins.DpdyFine(e,t);case"fwidth":return this.builtins.Fwidth(e,t);case"fwidthCoarse":return this.builtins.FwidthCoarse(e,t);case"fwidthFine":return this.builtins.FwidthFine(e,t);case"textureDimensions":return this.builtins.TextureDimensions(e,t);case"textureGather":return this.builtins.TextureGather(e,t);case"textureGatherCompare":return this.builtins.TextureGatherCompare(e,t);case"textureLoad":return this.builtins.TextureLoad(e,t);case"textureNumLayers":return this.builtins.TextureNumLayers(e,t);case"textureNumLevels":return this.builtins.TextureNumLevels(e,t);case"textureNumSamples":return this.builtins.TextureNumSamples(e,t);case"textureSample":return this.builtins.TextureSample(e,t);case"textureSampleBias":return this.builtins.TextureSampleBias(e,t);case"textureSampleCompare":return this.builtins.TextureSampleCompare(e,t);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(e,t);case"textureSampleGrad":return this.builtins.TextureSampleGrad(e,t);case"textureSampleLevel":return this.builtins.TextureSampleLevel(e,t);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(e,t);case"textureStore":return this.builtins.TextureStore(e,t);case"atomicLoad":return this.builtins.AtomicLoad(e,t);case"atomicStore":return this.builtins.AtomicStore(e,t);case"atomicAdd":return this.builtins.AtomicAdd(e,t);case"atomicSub":return this.builtins.AtomicSub(e,t);case"atomicMax":return this.builtins.AtomicMax(e,t);case"atomicMin":return this.builtins.AtomicMin(e,t);case"atomicAnd":return this.builtins.AtomicAnd(e,t);case"atomicOr":return this.builtins.AtomicOr(e,t);case"atomicXor":return this.builtins.AtomicXor(e,t);case"atomicExchange":return this.builtins.AtomicExchange(e,t);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(e,t);case"pack4x8snorm":return this.builtins.Pack4x8snorm(e,t);case"pack4x8unorm":return this.builtins.Pack4x8unorm(e,t);case"pack4xI8":return this.builtins.Pack4xI8(e,t);case"pack4xU8":return this.builtins.Pack4xU8(e,t);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(e,t);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(e,t);case"pack2x16snorm":return this.builtins.Pack2x16snorm(e,t);case"pack2x16unorm":return this.builtins.Pack2x16unorm(e,t);case"pack2x16float":return this.builtins.Pack2x16float(e,t);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(e,t);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(e,t);case"unpack4xI8":return this.builtins.Unpack4xI8(e,t);case"unpack4xU8":return this.builtins.Unpack4xU8(e,t);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(e,t);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(e,t);case"unpack2x16float":return this.builtins.Unpack2x16float(e,t);case"storageBarrier":return this.builtins.StorageBarrier(e,t);case"textureBarrier":return this.builtins.TextureBarrier(e,t);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(e,t);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(e,t);case"subgroupAdd":return this.builtins.SubgroupAdd(e,t);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(e,t);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(e,t);case"subgroupAll":return this.builtins.SubgroupAll(e,t);case"subgroupAnd":return this.builtins.SubgroupAnd(e,t);case"subgroupAny":return this.builtins.SubgroupAny(e,t);case"subgroupBallot":return this.builtins.SubgroupBallot(e,t);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(e,t);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(e,t);case"subgroupElect":return this.builtins.SubgroupElect(e,t);case"subgroupMax":return this.builtins.SubgroupMax(e,t);case"subgroupMin":return this.builtins.SubgroupMin(e,t);case"subgroupMul":return this.builtins.SubgroupMul(e,t);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(e,t);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(e,t);case"subgroupOr":return this.builtins.SubgroupOr(e,t);case"subgroupShuffle":return this.builtins.SubgroupShuffle(e,t);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(e,t);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(e,t);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(e,t);case"subgroupXor":return this.builtins.SubgroupXor(e,t);case"quadBroadcast":return this.builtins.QuadBroadcast(e,t);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(e,t);case"quadSwapX":return this.builtins.QuadSwapX(e,t);case"quadSwapY":return this.builtins.QuadSwapY(e,t)}const s=t.getFunction(e.name);if(s){const a=t.clone();for(let u=0;u<s.node.args.length;++u){const p=s.node.args[u],o=this.evalExpression(e.args[u],a);a.setVariable(p.name,o,p)}return this._execStatements(s.node.body,a)}return null}_callConstructorValue(e,t){if(!e.args||e.args.length===0)return new Te(0,this.getTypeInfo(e.type));const s=this.evalExpression(e.args[0],t);return s.typeInfo=this.getTypeInfo(e.type),s.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){const s=this.getTypeInfo(e.type),a=e.type.getTypeName(),u=Yp[a];if(u===void 0)return console.error(`Invalid vec constructor ${a}. Line ${e.line}`),null;const p=[];if(e instanceof Ii)if(e.isVector){const o=e.vectorValue;for(const T of o)p.push(T)}else p.push(e.scalarValue);else if(e.args)for(const o of e.args){const T=this.evalExpression(o,t);if(T instanceof ne){const E=T.data;for(let C=0;C<E.length;++C){let O=E[C];p.push(O)}}else if(T instanceof Te){let E=T.value;p.push(E)}}if(e.type instanceof Ie&&e.type.format===null&&(e.type.format=Ie.f32),p.length===0){const o=new Array(u).fill(0);return new ne(o,s).getSubData(this,e.postfix,t)}if(p.length===1)for(;p.length<u;)p.push(p[0]);return p.length<u?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new ne(p.length>u?p.slice(0,u):p,s).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){const s=this.getTypeInfo(e.type),a=e.type.getTypeName(),u=ln[a];if(u===void 0)return console.error(`Invalid matrix constructor ${a}. Line ${e.line}`),null;const p=[];if(e instanceof Ii)if(e.isVector){const o=e.vectorValue;for(const T of o)p.push(T)}else p.push(e.scalarValue);else if(e.args)for(const o of e.args){const T=this.evalExpression(o,t);T instanceof ne?p.push(...T.data):T instanceof Te?p.push(T.value):T instanceof Ot&&p.push(...T.data)}if(s instanceof La&&s.format===null&&(s.format=this.getTypeInfo("f32")),p.length===0){const o=new Array(u[2]).fill(0);return new Ot(o,s).getSubData(this,e.postfix,t)}return p.length!==u[2]?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new Ot(p,s).getSubData(this,e.postfix,t)}}Qi._breakObj=new Ln(new On("BREAK",null),null),Qi._continueObj=new Ln(new On("CONTINUE",null),null),Qi._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class IE{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class CE{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new IE,this._exec=new Qi,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const s=this._global_decl_or_directive();if(!s)break;t.push(s)}if(this._deferArrayCountEval.length>0){for(const s of this._deferArrayCountEval){const a=s.arrayType,u=s.countNode;if(u instanceof An){const p=u.name,o=this._context.constants.get(p);if(o)try{const T=o.constEvaluate(this._exec);a.count=T}catch{}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(const s of t)s.search(a=>{a instanceof mb||a instanceof Dd?a.type=this._forwardType(a.type):a instanceof Lh?a.format=this._forwardType(a.format):a instanceof Ws||a instanceof Bh||a instanceof kd?a.type=this._forwardType(a.type):a instanceof jh?a.returnType=this._forwardType(a.returnType):a instanceof gb&&(a.type=this._forwardType(a.type))});return t}_forwardType(e){if(e instanceof pb){const t=this._getType(e.name);if(t)return t}else e instanceof Dd?e.type=this._forwardType(e.type):e instanceof Lh&&(e.format=this._forwardType(e.format));return e}_initialize(e){if(e)if(typeof e=="string"){const t=new _E(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=t??this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==ee.eof}_match(e){if(e instanceof Ae)return!!this._check(e)&&(this._advance(),!0);for(let t=0,s=e.length;t<s;++t){const a=e[t];if(this._check(a))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const s=t.type;let a=!1;for(const u of e){if(s===u)return!0;u===ee.tokens.name&&(a=!0)}if(a){const u=ee.tokens.name.rule.exec(t.lexeme);if(u&&u.index==0&&u[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===ee.tokens.name){const s=ee.tokens.name.rule.exec(t.lexeme);return s&&s.index==0&&s[0]==t.lexeme}return!1}_advance(){var e,t;return this._currentLine=(t=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&t!==void 0?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(ee.tokens.semicolon)&&!this._isAtEnd(););if(this._match(ee.keywords.alias)){const t=this._type_alias();return this._consume(ee.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(ee.keywords.diagnostic)){const t=this._diagnostic();return this._consume(ee.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(ee.keywords.requires)){const t=this._requires_directive();return this._consume(ee.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(ee.keywords.enable)){const t=this._enable_directive();return this._consume(ee.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}const e=this._attribute();if(this._check(ee.keywords.var)){const t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(ee.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(ee.keywords.override)){const t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(ee.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(ee.keywords.let)){const t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(ee.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(ee.keywords.const)){const t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(ee.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(ee.keywords.struct)){const t=this._struct_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(ee.keywords.fn)){const t=this._function_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(ee.keywords.fn))return null;const e=this._currentLine,t=this._consume(ee.tokens.ident,"Expected function name.").toString();this._consume(ee.tokens.paren_left,"Expected '(' for function arguments.");const s=[];if(!this._check(ee.tokens.paren_right))do{if(this._check(ee.tokens.paren_right))break;const o=this._attribute(),T=this._consume(ee.tokens.name,"Expected argument name.").toString();this._consume(ee.tokens.colon,"Expected ':' for argument type.");const E=this._attribute(),C=this._type_decl();C!=null&&(C.attributes=E,s.push(this._updateNode(new gb(T,C,o))))}while(this._match(ee.tokens.comma));this._consume(ee.tokens.paren_right,"Expected ')' after function arguments.");let a=null;if(this._match(ee.tokens.arrow)){const o=this._attribute();a=this._type_decl(),a!=null&&(a.attributes=o)}const u=this._compound_statement(),p=this._currentLine;return this._updateNode(new jh(t,s,a,u,e,p),e)}_compound_statement(){const e=[];for(this._consume(ee.tokens.brace_left,"Expected '{' for block.");!this._check(ee.tokens.brace_right);){const t=this._statement();t!==null&&e.push(t)}return this._consume(ee.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(ee.tokens.semicolon)&&!this._isAtEnd(););if(this._check(ee.tokens.attr)&&this._attribute(),this._check(ee.keywords.if))return this._if_statement();if(this._check(ee.keywords.switch))return this._switch_statement();if(this._check(ee.keywords.loop))return this._loop_statement();if(this._check(ee.keywords.for))return this._for_statement();if(this._check(ee.keywords.while))return this._while_statement();if(this._check(ee.keywords.continuing))return this._continuing_statement();if(this._check(ee.keywords.static_assert))return this._static_assert_statement();if(this._check(ee.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(ee.keywords.return))e=this._return_statement();else if(this._check([ee.keywords.var,ee.keywords.let,ee.keywords.const]))e=this._variable_statement();else if(this._match(ee.keywords.discard))e=this._updateNode(new pE);else if(this._match(ee.keywords.break)){const t=this._updateNode(new Lx);if(this._currentLoop.length>0){const s=this._currentLoop[this._currentLoop.length-1];t.loopId=s.id}e=t,this._check(ee.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(ee.keywords.continue)){const t=this._updateNode(new Nx);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);{const s=this._currentLoop[this._currentLoop.length-1];t.loopId=s.id}e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return e!=null&&this._consume(ee.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(ee.keywords.static_assert))return null;const e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new uE(t),e)}_while_statement(){if(!this._match(ee.keywords.while))return null;const e=this._updateNode(new Cx(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(ee.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){const e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(ee.keywords.continuing))return null;const t=this._currentLine,s=this._compound_statement();return this._updateNode(new Cg(s,e),t)}_for_statement(){if(!this._match(ee.keywords.for))return null;this._consume(ee.tokens.paren_left,"Expected '('.");const e=this._updateNode(new Px(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(ee.tokens.semicolon)?null:this._for_init(),this._consume(ee.tokens.semicolon,"Expected ';'."),e.condition=this._check(ee.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(ee.tokens.semicolon,"Expected ';'."),e.increment=this._check(ee.tokens.paren_right)?null:this._for_increment(),this._consume(ee.tokens.paren_right,"Expected ')'."),this._check(ee.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(ee.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(ee.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new Ws(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(ee.keywords.let)){const e=this._currentLine,t=this._consume(ee.tokens.name,"Expected name for let.").toString();let s=null;if(this._match(ee.tokens.colon)){const u=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=u)}this._consume(ee.tokens.equal,"Expected '=' for let.");const a=this._short_circuit_or_expression();return this._updateNode(new Bh(t,s,null,null,a),e)}if(this._match(ee.keywords.const)){const e=this._currentLine,t=this._consume(ee.tokens.name,"Expected name for const.").toString();let s=null;if(this._match(ee.tokens.colon)){const u=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=u)}this._consume(ee.tokens.equal,"Expected '=' for const.");const a=this._short_circuit_or_expression();return s===null&&a instanceof Ii&&(s=a.type),this._updateNode(new kd(t,s,null,null,a),e)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(ee.increment_operators))return this._current=e,null;const s=this._consume(ee.increment_operators,"Expected increment operator");return this._updateNode(new Mx(s.type===ee.tokens.plus_plus?ql.increment:ql.decrement,t))}_assignment_statement(){let e=null;const t=this._currentLine;if(this._check(ee.tokens.brace_right))return null;let s=this._match(ee.tokens.underscore);if(s||(e=this._unary_expression()),!s&&e==null)return null;const a=this._consume(ee.assignment_operators,"Expected assignment operator."),u=this._short_circuit_or_expression();return this._updateNode(new Rx(Ph.parse(a.lexeme),e,u),t)}_func_call_statement(){if(!this._check(ee.tokens.ident))return null;const e=this._currentLine,t=this._current,s=this._consume(ee.tokens.ident,"Expected function name."),a=this._argument_expression_list();return a===null?(this._current=t,null):this._updateNode(new mm(s.lexeme,a),e)}_loop_statement(){if(!this._match(ee.keywords.loop))return null;this._check(ee.tokens.attr)&&this._attribute(),this._consume(ee.tokens.brace_left,"Expected '{' for loop.");const e=this._updateNode(new kx([],null));this._currentLoop.push(e);let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let s of t)e.body.push(s);else e.body.push(t);if(t instanceof Cg){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(ee.tokens.brace_right,"Expected '}' for loop."),e}_switch_statement(){if(!this._match(ee.keywords.switch))return null;const e=this._updateNode(new Dx(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(ee.tokens.attr)&&this._attribute(),this._consume(ee.tokens.brace_left,"Expected '{' for switch."),e.cases=this._switch_body(),e.cases==null||e.cases.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(ee.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),e}_switch_body(){const e=[];let t=!1;for(;this._check([ee.keywords.default,ee.keywords.case]);){if(this._match(ee.keywords.case)){const s=this._case_selectors();for(const u of s)if(u instanceof Od){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");t=!0;break}this._match(ee.tokens.colon),this._check(ee.tokens.attr)&&this._attribute(),this._consume(ee.tokens.brace_left,"Exected '{' for switch case.");const a=this._case_body();this._consume(ee.tokens.brace_right,"Exected '}' for switch case."),e.push(this._updateNode(new $x(s,a)))}if(this._match(ee.keywords.default)){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(ee.tokens.colon),this._check(ee.tokens.attr)&&this._attribute(),this._consume(ee.tokens.brace_left,"Exected '{' for switch default.");const s=this._case_body();this._consume(ee.tokens.brace_right,"Exected '}' for switch default."),e.push(this._updateNode(new Wx(s)))}}return e}_case_selectors(){const e=[];for(this._match(ee.keywords.default)?e.push(this._updateNode(new Od)):e.push(this._shift_expression());this._match(ee.tokens.comma);)this._match(ee.keywords.default)?e.push(this._updateNode(new Od)):e.push(this._shift_expression());return e}_case_body(){if(this._match(ee.keywords.fallthrough))return this._consume(ee.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(ee.keywords.if))return null;const e=this._currentLine,t=this._optional_paren_expression();this._check(ee.tokens.attr)&&this._attribute();const s=this._compound_statement();let a=[];this._match_elseif()&&(this._check(ee.tokens.attr)&&this._attribute(),a=this._elseif_statement(a));let u=null;return this._match(ee.keywords.else)&&(this._check(ee.tokens.attr)&&this._attribute(),u=this._compound_statement()),this._updateNode(new Ox(t,s,a,u),e)}_match_elseif(){return this._tokens[this._current].type===ee.keywords.else&&this._tokens[this._current+1].type===ee.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),s=this._compound_statement();return e.push(this._updateNode(new gE(t,s))),this._match_elseif()&&(this._check(ee.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(ee.keywords.return))return null;const e=this._short_circuit_or_expression();return this._updateNode(new Fx(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(ee.tokens.or_or);)e=this._updateNode(new Qn(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(ee.tokens.and_and);)e=this._updateNode(new Qn(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(ee.tokens.or);)e=this._updateNode(new Qn(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(ee.tokens.xor);)e=this._updateNode(new Qn(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(ee.tokens.and);)e=this._updateNode(new Qn(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){const e=this._relational_expression();return this._match([ee.tokens.equal_equal,ee.tokens.not_equal])?this._updateNode(new Qn(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([ee.tokens.less_than,ee.tokens.greater_than,ee.tokens.less_than_equal,ee.tokens.greater_than_equal]);)e=this._updateNode(new Qn(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([ee.tokens.shift_left,ee.tokens.shift_right]);)e=this._updateNode(new Qn(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([ee.tokens.plus,ee.tokens.minus]);)e=this._updateNode(new Qn(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([ee.tokens.star,ee.tokens.forward_slash,ee.tokens.modulo]);)e=this._updateNode(new Qn(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([ee.tokens.minus,ee.tokens.bang,ee.tokens.tilde,ee.tokens.star,ee.tokens.and])?this._updateNode(new _i(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(ee.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(ee.tokens.bracket_right,"Expected ']'.");const t=this._updateNode(new nc(e)),s=this._postfix_expression();return s&&(t.postfix=s),t}if(this._match(ee.tokens.period)){const e=this._consume(ee.tokens.name,"Expected member name."),t=this._postfix_expression(),s=this._updateNode(new Na(e.lexeme));return t&&(s.postfix=t),s}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){const t=this._getStruct(e);if(t!==null)return t;switch(e){case"void":return Ge.void;case"bool":return Ge.bool;case"i32":return Ge.i32;case"u32":return Ge.u32;case"f32":return Ge.f32;case"f16":return Ge.f16;case"vec2f":return Ie.vec2f;case"vec3f":return Ie.vec3f;case"vec4f":return Ie.vec4f;case"vec2i":return Ie.vec2i;case"vec3i":return Ie.vec3i;case"vec4i":return Ie.vec4i;case"vec2u":return Ie.vec2u;case"vec3u":return Ie.vec3u;case"vec4u":return Ie.vec4u;case"vec2h":return Ie.vec2h;case"vec3h":return Ie.vec3h;case"vec4h":return Ie.vec4h;case"mat2x2f":return Ie.mat2x2f;case"mat2x3f":return Ie.mat2x3f;case"mat2x4f":return Ie.mat2x4f;case"mat3x2f":return Ie.mat3x2f;case"mat3x3f":return Ie.mat3x3f;case"mat3x4f":return Ie.mat3x4f;case"mat4x2f":return Ie.mat4x2f;case"mat4x3f":return Ie.mat4x3f;case"mat4x4f":return Ie.mat4x4f;case"mat2x2h":return Ie.mat2x2h;case"mat2x3h":return Ie.mat2x3h;case"mat2x4h":return Ie.mat2x4h;case"mat3x2h":return Ie.mat3x2h;case"mat3x3h":return Ie.mat3x3h;case"mat3x4h":return Ie.mat3x4h;case"mat4x2h":return Ie.mat4x2h;case"mat4x3h":return Ie.mat4x3h;case"mat4x4h":return Ie.mat4x4h;case"mat2x2i":return Ie.mat2x2i;case"mat2x3i":return Ie.mat2x3i;case"mat2x4i":return Ie.mat2x4i;case"mat3x2i":return Ie.mat3x2i;case"mat3x3i":return Ie.mat3x3i;case"mat3x4i":return Ie.mat3x4i;case"mat4x2i":return Ie.mat4x2i;case"mat4x3i":return Ie.mat4x3i;case"mat4x4i":return Ie.mat4x4i;case"mat2x2u":return Ie.mat2x2u;case"mat2x3u":return Ie.mat2x3u;case"mat2x4u":return Ie.mat2x4u;case"mat3x2u":return Ie.mat3x2u;case"mat3x3u":return Ie.mat3x3u;case"mat3x4u":return Ie.mat3x4u;case"mat4x2u":return Ie.mat4x2u;case"mat4x3u":return Ie.mat4x3u;case"mat4x4u":return Ie.mat4x4u}return null}_validateTypeRange(e,t){if(t.name==="i32"){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if(t.name==="u32"&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(ee.tokens.ident)){const s=this._previous().toString();if(this._check(ee.tokens.paren_left)){const a=this._argument_expression_list(),u=this._getType(s);return u!==null?this._updateNode(new vs(u,a)):this._updateNode(new ym(s,a))}if(this._context.constants.has(s)){const a=this._context.constants.get(s);return this._updateNode(new zx(s,a.value))}return this._updateNode(new An(s))}if(this._match(ee.tokens.int_literal)){const s=this._previous().toString();let a=s.endsWith("i")||s.endsWith("i")?Ge.i32:s.endsWith("u")||s.endsWith("U")?Ge.u32:Ge.x32;const u=parseInt(s);return this._validateTypeRange(u,a),this._updateNode(new Ii(new Te(u,this._exec.getTypeInfo(a)),a))}if(this._match(ee.tokens.uint_literal)){const s=parseInt(this._previous().toString());return this._validateTypeRange(s,Ge.u32),this._updateNode(new Ii(new Te(s,this._exec.getTypeInfo(Ge.u32)),Ge.u32))}if(this._match([ee.tokens.decimal_float_literal,ee.tokens.hex_float_literal])){let s=this._previous().toString(),a=s.endsWith("h");a&&(s=s.substring(0,s.length-1));const u=parseFloat(s);this._validateTypeRange(u,a?Ge.f16:Ge.f32);const p=a?Ge.f16:Ge.f32;return this._updateNode(new Ii(new Te(u,this._exec.getTypeInfo(p)),p))}if(this._match([ee.keywords.true,ee.keywords.false])){let s=this._previous().toString()===ee.keywords.true.rule;return this._updateNode(new Ii(new Te(s?1:0,this._exec.getTypeInfo(Ge.bool)),Ge.bool))}if(this._check(ee.tokens.paren_left))return this._paren_expression();if(this._match(ee.keywords.bitcast)){this._consume(ee.tokens.less_than,"Expected '<'.");const s=this._type_decl();this._consume(ee.tokens.greater_than,"Expected '>'.");const a=this._paren_expression();return this._updateNode(new Ux(s,a))}const e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new vs(e,t))}_argument_expression_list(){if(!this._match(ee.tokens.paren_left))return null;const e=[];do{if(this._check(ee.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(ee.tokens.comma));return this._consume(ee.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(ee.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(ee.tokens.paren_right),e}_paren_expression(){this._consume(ee.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(ee.tokens.paren_right,"Expected ')'."),e}_struct_decl(){if(!this._match(ee.keywords.struct))return null;const e=this._currentLine,t=this._consume(ee.tokens.ident,"Expected name for struct.").toString();this._consume(ee.tokens.brace_left,"Expected '{' for struct body.");const s=[];for(;!this._check(ee.tokens.brace_right);){const p=this._attribute(),o=this._consume(ee.tokens.name,"Expected variable name.").toString();this._consume(ee.tokens.colon,"Expected ':' for struct member type.");const T=this._attribute(),E=this._type_decl();E!=null&&(E.attributes=T),this._check(ee.tokens.brace_right)?this._match(ee.tokens.comma):this._consume(ee.tokens.comma,"Expected ',' for struct member."),s.push(this._updateNode(new mb(o,E,p)))}this._consume(ee.tokens.brace_right,"Expected '}' after struct body.");const a=this._currentLine,u=this._updateNode(new js(t,s,e,a),e);return this._context.structs.set(t,u),u}_global_variable_decl(){const e=this._variable_decl();if(!e)return null;if(this._match(ee.tokens.equal)){const t=this._const_expression();e.value=t}if(e.type!==null&&e.value instanceof Ii){if(e.value.type.name!=="x32"&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else e.type===null&&e.value instanceof Ii&&(e.type=e.value.type.name==="x32"?Ge.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(ee.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(ee.keywords.const))return null;const t=this._consume(ee.tokens.name,"Expected variable name"),s=this._currentLine;let a=null;if(this._match(ee.tokens.colon)){const T=this._attribute();a=this._type_decl(),a!=null&&(a.attributes=T)}let u=null;this._consume(ee.tokens.equal,"const declarations require an assignment");const p=this._short_circuit_or_expression();try{let T=[Ge.f32],E=p.constEvaluate(this._exec,T);E instanceof Te&&this._validateTypeRange(E.value,T[0]),T[0]instanceof Ie&&T[0].format===null&&E.typeInfo instanceof La&&E.typeInfo.format!==null&&(E.typeInfo.format.name==="f16"?T[0].format=Ge.f16:E.typeInfo.format.name==="f32"?T[0].format=Ge.f32:E.typeInfo.format.name==="i32"?T[0].format=Ge.i32:E.typeInfo.format.name==="u32"?T[0].format=Ge.u32:E.typeInfo.format.name==="bool"?T[0].format=Ge.bool:console.error(`TODO: impelement template format type ${E.typeInfo.format.name}`)),u=this._updateNode(new Ii(E,T[0])),this._exec.context.setVariable(t.toString(),E)}catch{u=p}if(a!==null&&u instanceof Ii){if(u.type.name!=="x32"&&a.getTypeName()!==u.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${u.type.name} to ${a.name}. Line:${this._currentLine}`);u.type=a,u.isScalar&&this._validateTypeRange(u.scalarValue,u.type)}else a===null&&u instanceof Ii&&(a=(e=u?.type)!==null&&e!==void 0?e:Ge.f32,a===Ge.x32&&(a=Ge.i32));const o=this._updateNode(new kd(t.toString(),a,"","",u),s);return this._context.constants.set(o.name,o),o}_global_let_decl(){if(!this._match(ee.keywords.let))return null;const e=this._currentLine,t=this._consume(ee.tokens.name,"Expected variable name");let s=null;if(this._match(ee.tokens.colon)){const u=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=u)}let a=null;if(this._match(ee.tokens.equal)&&(a=this._const_expression()),s!==null&&a instanceof Ii){if(a.type.name!=="x32"&&s.getTypeName()!==a.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${a.type.name} to ${s.name}. Line:${this._currentLine}`);a.type=s}else s===null&&a instanceof Ii&&(s=a.type.name==="x32"?Ge.i32:a.type);return a instanceof Ii&&a.isScalar&&this._validateTypeRange(a.scalarValue,s),this._updateNode(new Bh(t.toString(),s,"","",a),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(ee.keywords.var))return null;const e=this._currentLine;let t="",s="";this._match(ee.tokens.less_than)&&(t=this._consume(ee.storage_class,"Expected storage_class.").toString(),this._match(ee.tokens.comma)&&(s=this._consume(ee.access_mode,"Expected access_mode.").toString()),this._consume(ee.tokens.greater_than,"Expected '>'."));const a=this._consume(ee.tokens.name,"Expected variable name");let u=null;if(this._match(ee.tokens.colon)){const p=this._attribute();u=this._type_decl(),u!=null&&(u.attributes=p)}return this._updateNode(new Ws(a.toString(),u,t,s,null),e)}_override_decl(){if(!this._match(ee.keywords.override))return null;const e=this._consume(ee.tokens.name,"Expected variable name");let t=null;if(this._match(ee.tokens.colon)){const s=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=s)}return this._updateNode(new gm(e.toString(),t,null))}_diagnostic(){this._consume(ee.tokens.paren_left,"Expected '('");const e=this._consume(ee.tokens.ident,"Expected severity control name.");this._consume(ee.tokens.comma,"Expected ','");let t=this._consume(ee.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(ee.tokens.period)&&(t+=`.${this._consume(ee.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(ee.tokens.paren_right,"Expected ')'"),this._updateNode(new Bx(e.toString(),t))}_enable_directive(){const e=this._consume(ee.tokens.ident,"identity expected.");return this._updateNode(new dE(e.toString()))}_requires_directive(){const e=[this._consume(ee.tokens.ident,"identity expected.").toString()];for(;this._match(ee.tokens.comma);){const t=this._consume(ee.tokens.ident,"identity expected.");e.push(t.toString())}return this._updateNode(new fE(e))}_type_alias(){const e=this._consume(ee.tokens.ident,"identity expected.");this._consume(ee.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(t===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const s=this._updateNode(new _m(e.toString(),t));return this._context.aliases.set(s.name,s),s}_type_decl(){if(this._check([ee.tokens.ident,...ee.texel_format,ee.keywords.bool,ee.keywords.f32,ee.keywords.i32,ee.keywords.u32])){const s=this._advance().toString();if(this._context.structs.has(s))return this._context.structs.get(s);if(this._context.aliases.has(s))return this._context.aliases.get(s).type;if(!this._getType(s)){const a=this._updateNode(new pb(s));return this._forwardTypeCount++,a}return this._updateNode(new Ge(s))}let e=this._texture_sampler_types();if(e)return e;if(this._check(ee.template_types)){let s=this._advance().toString(),a=null,u=null;return this._match(ee.tokens.less_than)&&(a=this._type_decl(),u=null,this._match(ee.tokens.comma)&&(u=this._consume(ee.access_mode,"Expected access_mode for pointer").toString()),this._consume(ee.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new Ie(s,a,u))}if(this._match(ee.keywords.ptr)){let s=this._previous().toString();this._consume(ee.tokens.less_than,"Expected '<' for pointer.");const a=this._consume(ee.storage_class,"Expected storage_class for pointer");this._consume(ee.tokens.comma,"Expected ',' for pointer.");const u=this._type_decl();let p=null;return this._match(ee.tokens.comma)&&(p=this._consume(ee.access_mode,"Expected access_mode for pointer").toString()),this._consume(ee.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new Dd(s,a.toString(),u,p))}const t=this._attribute();if(this._match(ee.keywords.array)){let s=null,a=-1;const u=this._previous();let p=null;if(this._match(ee.tokens.less_than)){s=this._type_decl(),this._context.aliases.has(s.name)&&(s=this._context.aliases.get(s.name).type);let T="";if(this._match(ee.tokens.comma)){p=this._shift_expression();try{T=p.constEvaluate(this._exec).toString(),p=null}catch{T="1"}}this._consume(ee.tokens.greater_than,"Expected '>' for array."),a=T?parseInt(T):0}const o=this._updateNode(new Lh(u.toString(),t,s,a));return p&&this._deferArrayCountEval.push({arrayType:o,countNode:p}),o}return null}_texture_sampler_types(){if(this._match(ee.sampler_type))return this._updateNode(new Mh(this._previous().toString(),null,null));if(this._match(ee.depth_texture_type))return this._updateNode(new Mh(this._previous().toString(),null,null));if(this._match(ee.sampled_texture_type)||this._match(ee.multisampled_texture_type)){const e=this._previous();this._consume(ee.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(ee.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new Mh(e.toString(),t,null))}if(this._match(ee.storage_texture_type)){const e=this._previous();this._consume(ee.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(ee.texel_format,"Invalid texel format.").toString();this._consume(ee.tokens.comma,"Expected ',' after texel format.");const s=this._consume(ee.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(ee.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new Mh(e.toString(),t,s))}return null}_attribute(){let e=[];for(;this._match(ee.tokens.attr);){const t=this._consume(ee.attribute_name,"Expected attribute name"),s=this._updateNode(new Hx(t.toString(),null));if(this._match(ee.tokens.paren_left)){if(s.value=this._consume(ee.literal_or_ident,"Expected attribute value").toString(),this._check(ee.tokens.comma)){this._advance();do{const a=this._consume(ee.literal_or_ident,"Expected attribute value").toString();s.value instanceof Array||(s.value=[s.value]),s.value.push(a)}while(this._match(ee.tokens.comma))}this._consume(ee.tokens.paren_right,"Expected ')'")}e.push(s)}return e.length==0?null:e}}class PE extends ws{constructor(e){super(),e&&this.update(e)}update(e){const t=new CE().parse(e);this.updateAST(t)}}function ME(r){const e={attributes:[],bindings:[]};let t;try{t=RE(r)}catch(u){return ot.error(u.message)(),e}for(const u of t.uniforms){const p=[];for(const o of u.type?.members||[])p.push({name:o.name,type:bb(o.type)});e.bindings.push({type:"uniform",name:u.name,group:u.group,location:u.binding,members:p})}for(const u of t.textures)e.bindings.push({type:"texture",name:u.name,group:u.group,location:u.binding});for(const u of t.samplers)e.bindings.push({type:"sampler",name:u.name,group:u.group,location:u.binding});const s=t.entry.vertex[0],a=s?.inputs.length||0;for(let u=0;u<a;u++){const p=s.inputs[u];if(p.locationType==="location"){const o=bb(p.type);e.attributes.push({name:p.name,location:Number(p.location),type:o})}}return e}function bb(r){return r.format?`${r.name}<${r.format.name}>`:r.name}function RE(r){try{return new PE(r)}catch(e){if(e instanceof Error)throw e;let t="WGSL parse error";throw typeof e=="object"&&e?.message&&(t+=`: ${e.message} `),typeof e=="object"&&e?.token&&(t+=e.token.line||""),new Error(t,{cause:e})}}const kE={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...kE}};const Fn=globalThis.mathgl.config;function DE(r,{precision:e=Fn.precision}={}){return r=OE(r),`${parseFloat(r.toPrecision(e))}`}function sc(r){return Array.isArray(r)||ArrayBuffer.isView(r)&&!(r instanceof DataView)}function Ts(r,e,t){return BE(r,s=>Math.max(e,Math.min(t,s)))}function ef(r,e,t){return sc(r)?r.map((s,a)=>ef(s,e[a],t)):t*e+(1-t)*r}function $h(r,e,t){const s=Fn.EPSILON;try{if(r===e)return!0;if(sc(r)&&sc(e)){if(r.length!==e.length)return!1;for(let a=0;a<r.length;++a)if(!$h(r[a],e[a]))return!1;return!0}return r&&r.equals?r.equals(e):e&&e.equals?e.equals(r):typeof r=="number"&&typeof e=="number"?Math.abs(r-e)<=Fn.EPSILON*Math.max(1,Math.abs(r),Math.abs(e)):!1}finally{Fn.EPSILON=s}}function OE(r){return Math.round(r/Fn.EPSILON)*Fn.EPSILON}function FE(r){return r.clone?r.clone():new Array(r.length)}function BE(r,e,t){if(sc(r)){const s=r;t=t||FE(s);for(let a=0;a<t.length&&a<s.length;++a){const u=typeof r=="number"?r:r[a];t[a]=e(u,a,t)}return t}return e(r)}class Zx extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let s=0;s<this.ELEMENTS;++s)this[s]=e[s+t];return this.check()}toArray(e=[],t=0){for(let s=0;s<this.ELEMENTS;++s)e[t+s]=this[s];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:sc(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Fn)}formatString(e){let t="";for(let s=0;s<this.ELEMENTS;++s)t+=(s>0?", ":"")+DE(this[s],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!$h(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,s){if(s===void 0)return this.lerp(this,e,t);for(let a=0;a<this.ELEMENTS;++a){const u=e[a],p=typeof t=="number"?t:t[a];this[a]=u+s*(p-u)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let s=0;s<this.ELEMENTS;++s)this[s]=Math.min(Math.max(this[s],e[s]),t[s]);return this.check()}add(...e){for(const t of e)for(let s=0;s<this.ELEMENTS;++s)this[s]+=t[s];return this.check()}subtract(...e){for(const t of e)for(let s=0;s<this.ELEMENTS;++s)this[s]-=t[s];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(Fn.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let s=0;s<this.ELEMENTS;++s)this[s]=Math.min(Math.max(this[s],e),t);return this.check()}get elements(){return this}}function LE(r,e){if(r.length!==e)return!1;for(let t=0;t<r.length;++t)if(!Number.isFinite(r[t]))return!1;return!0}function Sn(r){if(!Number.isFinite(r))throw new Error(`Invalid number ${JSON.stringify(r)}`);return r}function Gp(r,e,t=""){if(Fn.debug&&!LE(r,e))throw new Error(`math.gl: ${t} some fields set to invalid numbers'`);return r}function vb(r,e){if(!r)throw new Error(`math.gl assertion ${e}`)}class NE extends Zx{get x(){return this[0]}set x(e){this[0]=Sn(e)}get y(){return this[1]}set y(e){this[1]=Sn(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let s=0;s<this.ELEMENTS;++s){const a=this[s]-e[s];t+=a*a}return Sn(t)}dot(e){let t=0;for(let s=0;s<this.ELEMENTS;++s)t+=this[s]*e[s];return Sn(t)}normalize(){const e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let s=0;s<this.ELEMENTS;++s)this[s]*=t[s];return this.check()}divide(...e){for(const t of e)for(let s=0;s<this.ELEMENTS;++s)this[s]/=t[s];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return vb(e>=0&&e<this.ELEMENTS,"index is out of range"),Sn(this[e])}setComponent(e,t){return vb(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}const Fd=1e-6;let oc=typeof Float32Array<"u"?Float32Array:Array;function zE(){const r=new oc(2);return oc!=Float32Array&&(r[0]=0,r[1]=0),r}function xb(r,e,t){return r[0]=e[0]+t[0],r[1]=e[1]+t[1],r}function UE(r,e){return r[0]=-e[0],r[1]=-e[1],r}function Xx(r,e,t,s){const a=e[0],u=e[1];return r[0]=a+s*(t[0]-a),r[1]=u+s*(t[1]-u),r}function VE(r,e,t){const s=e[0],a=e[1];return r[0]=t[0]*s+t[4]*a+t[12],r[1]=t[1]*s+t[5]*a+t[13],r}(function(){const r=zE();return function(e,t,s,a,u,p){let o,T;for(t||(t=2),s||(s=0),a?T=Math.min(a*t+s,e.length):T=e.length,o=s;o<T;o+=t)r[0]=e[o],r[1]=e[o+1],u(r,r,p),e[o]=r[0],e[o+1]=r[1];return e}})();function jE(r,e,t){const s=e[0],a=e[1],u=t[3]*s+t[7]*a||1;return r[0]=(t[0]*s+t[4]*a)/u,r[1]=(t[1]*s+t[5]*a)/u,r}function qx(r,e,t){const s=e[0],a=e[1],u=e[2],p=t[3]*s+t[7]*a+t[11]*u||1;return r[0]=(t[0]*s+t[4]*a+t[8]*u)/p,r[1]=(t[1]*s+t[5]*a+t[9]*u)/p,r[2]=(t[2]*s+t[6]*a+t[10]*u)/p,r}function $E(r,e,t){const s=e[0],a=e[1];return r[0]=t[0]*s+t[2]*a,r[1]=t[1]*s+t[3]*a,r[2]=e[2],r}function WE(){const r=new oc(3);return oc!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function HE(r){const e=r[0],t=r[1],s=r[2];return Math.sqrt(e*e+t*t+s*s)}function ZE(r,e,t){return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r}function XE(r){const e=r[0],t=r[1],s=r[2];return e*e+t*t+s*s}function qE(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r}function YE(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function GE(r,e,t){const s=e[0],a=e[1],u=e[2],p=t[0],o=t[1],T=t[2];return r[0]=a*T-u*o,r[1]=u*p-s*T,r[2]=s*o-a*p,r}function KE(r,e,t,s){const a=e[0],u=e[1],p=e[2];return r[0]=a+s*(t[0]-a),r[1]=u+s*(t[1]-u),r[2]=p+s*(t[2]-p),r}function Yx(r,e,t){const s=e[0],a=e[1],u=e[2];let p=t[3]*s+t[7]*a+t[11]*u+t[15];return p=p||1,r[0]=(t[0]*s+t[4]*a+t[8]*u+t[12])/p,r[1]=(t[1]*s+t[5]*a+t[9]*u+t[13])/p,r[2]=(t[2]*s+t[6]*a+t[10]*u+t[14])/p,r}function JE(r,e,t){const s=e[0],a=e[1],u=e[2];return r[0]=s*t[0]+a*t[3]+u*t[6],r[1]=s*t[1]+a*t[4]+u*t[7],r[2]=s*t[2]+a*t[5]+u*t[8],r}function QE(r,e,t){const s=t[0],a=t[1],u=t[2],p=t[3],o=e[0],T=e[1],E=e[2];let C=a*E-u*T,O=u*o-s*E,$=s*T-a*o,V=a*$-u*O,ie=u*C-s*$,we=s*O-a*C;const Pe=p*2;return C*=Pe,O*=Pe,$*=Pe,V*=2,ie*=2,we*=2,r[0]=o+C+V,r[1]=T+O+ie,r[2]=E+$+we,r}function e3(r,e,t,s){const a=[],u=[];return a[0]=e[0]-t[0],a[1]=e[1]-t[1],a[2]=e[2]-t[2],u[0]=a[0],u[1]=a[1]*Math.cos(s)-a[2]*Math.sin(s),u[2]=a[1]*Math.sin(s)+a[2]*Math.cos(s),r[0]=u[0]+t[0],r[1]=u[1]+t[1],r[2]=u[2]+t[2],r}function t3(r,e,t,s){const a=[],u=[];return a[0]=e[0]-t[0],a[1]=e[1]-t[1],a[2]=e[2]-t[2],u[0]=a[2]*Math.sin(s)+a[0]*Math.cos(s),u[1]=a[1],u[2]=a[2]*Math.cos(s)-a[0]*Math.sin(s),r[0]=u[0]+t[0],r[1]=u[1]+t[1],r[2]=u[2]+t[2],r}function r3(r,e,t,s){const a=[],u=[];return a[0]=e[0]-t[0],a[1]=e[1]-t[1],a[2]=e[2]-t[2],u[0]=a[0]*Math.cos(s)-a[1]*Math.sin(s),u[1]=a[0]*Math.sin(s)+a[1]*Math.cos(s),u[2]=a[2],r[0]=u[0]+t[0],r[1]=u[1]+t[1],r[2]=u[2]+t[2],r}function i3(r,e){const t=r[0],s=r[1],a=r[2],u=e[0],p=e[1],o=e[2],T=Math.sqrt((t*t+s*s+a*a)*(u*u+p*p+o*o)),E=T&&YE(r,e)/T;return Math.acos(Math.min(Math.max(E,-1),1))}const Gx=ZE,n3=HE,Kp=XE;(function(){const r=WE();return function(e,t,s,a,u,p){let o,T;for(t||(t=3),s||(s=0),a?T=Math.min(a*t+s,e.length):T=e.length,o=s;o<T;o+=t)r[0]=e[o],r[1]=e[o+1],r[2]=e[o+2],u(r,r,p),e[o]=r[0],e[o+1]=r[1],e[o+2]=r[2];return e}})();const Jp=[0,0,0];let xd;class Ss extends NE{static get ZERO(){return xd||(xd=new Ss(0,0,0),Object.freeze(xd)),xd}constructor(e=0,t=0,s=0){super(-0,-0,-0),arguments.length===1&&sc(e)?this.copy(e):(Fn.debug&&(Sn(e),Sn(t),Sn(s)),this[0]=e,this[1]=t,this[2]=s)}set(e,t,s){return this[0]=e,this[1]=t,this[2]=s,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return Fn.debug&&(Sn(e.x),Sn(e.y),Sn(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=Sn(e)}angle(e){return i3(this,e)}cross(e){return GE(this,this,e),this.check()}rotateX({radians:e,origin:t=Jp}){return e3(this,this,t,e),this.check()}rotateY({radians:e,origin:t=Jp}){return t3(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=Jp}){return r3(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return Yx(this,this,e),this.check()}transformAsVector(e){return qx(this,this,e),this.check()}transformByMatrix3(e){return JE(this,this,e),this.check()}transformByMatrix2(e){return $E(this,this,e),this.check()}transformByQuaternion(e){return QE(this,this,e),this.check()}}class s3 extends Zx{toString(){let e="[";if(Fn.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let s=0;s<this.RANK;++s)e+=` ${this[s*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,s){return this[t*this.RANK+e]=Sn(s),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const s=e*this.RANK;for(let a=0;a<this.RANK;++a)t[a]=this[s+a];return t}setColumn(e,t){const s=e*this.RANK;for(let a=0;a<this.RANK;++a)this[s+a]=t[a];return this}}function o3(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function a3(r,e){if(r===e){const t=e[1],s=e[2],a=e[3],u=e[6],p=e[7],o=e[11];r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=t,r[6]=e[9],r[7]=e[13],r[8]=s,r[9]=u,r[11]=e[14],r[12]=a,r[13]=p,r[14]=o}else r[0]=e[0],r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=e[1],r[5]=e[5],r[6]=e[9],r[7]=e[13],r[8]=e[2],r[9]=e[6],r[10]=e[10],r[11]=e[14],r[12]=e[3],r[13]=e[7],r[14]=e[11],r[15]=e[15];return r}function Mg(r,e){const t=e[0],s=e[1],a=e[2],u=e[3],p=e[4],o=e[5],T=e[6],E=e[7],C=e[8],O=e[9],$=e[10],V=e[11],ie=e[12],we=e[13],Pe=e[14],je=e[15],Ze=t*o-s*p,Le=t*T-a*p,Ue=t*E-u*p,et=s*T-a*o,Ke=s*E-u*o,ct=a*E-u*T,me=C*we-O*ie,_e=C*Pe-$*ie,ze=C*je-V*ie,Qe=O*Pe-$*we,at=O*je-V*we,mt=$*je-V*Pe;let At=Ze*mt-Le*at+Ue*Qe+et*ze-Ke*_e+ct*me;return At?(At=1/At,r[0]=(o*mt-T*at+E*Qe)*At,r[1]=(a*at-s*mt-u*Qe)*At,r[2]=(we*ct-Pe*Ke+je*et)*At,r[3]=($*Ke-O*ct-V*et)*At,r[4]=(T*ze-p*mt-E*_e)*At,r[5]=(t*mt-a*ze+u*_e)*At,r[6]=(Pe*Ue-ie*ct-je*Le)*At,r[7]=(C*ct-$*Ue+V*Le)*At,r[8]=(p*at-o*ze+E*me)*At,r[9]=(s*ze-t*at-u*me)*At,r[10]=(ie*Ke-we*Ue+je*Ze)*At,r[11]=(O*Ue-C*Ke-V*Ze)*At,r[12]=(o*_e-p*Qe-T*me)*At,r[13]=(t*Qe-s*_e+a*me)*At,r[14]=(we*Le-ie*et-Pe*Ze)*At,r[15]=(C*et-O*Le+$*Ze)*At,r):null}function l3(r){const e=r[0],t=r[1],s=r[2],a=r[3],u=r[4],p=r[5],o=r[6],T=r[7],E=r[8],C=r[9],O=r[10],$=r[11],V=r[12],ie=r[13],we=r[14],Pe=r[15],je=e*p-t*u,Ze=e*o-s*u,Le=t*o-s*p,Ue=E*ie-C*V,et=E*we-O*V,Ke=C*we-O*ie,ct=e*Ke-t*et+s*Ue,me=u*Ke-p*et+o*Ue,_e=E*Le-C*Ze+O*je,ze=V*Le-ie*Ze+we*je;return T*ct-a*me+Pe*_e-$*ze}function Da(r,e,t){const s=e[0],a=e[1],u=e[2],p=e[3],o=e[4],T=e[5],E=e[6],C=e[7],O=e[8],$=e[9],V=e[10],ie=e[11],we=e[12],Pe=e[13],je=e[14],Ze=e[15];let Le=t[0],Ue=t[1],et=t[2],Ke=t[3];return r[0]=Le*s+Ue*o+et*O+Ke*we,r[1]=Le*a+Ue*T+et*$+Ke*Pe,r[2]=Le*u+Ue*E+et*V+Ke*je,r[3]=Le*p+Ue*C+et*ie+Ke*Ze,Le=t[4],Ue=t[5],et=t[6],Ke=t[7],r[4]=Le*s+Ue*o+et*O+Ke*we,r[5]=Le*a+Ue*T+et*$+Ke*Pe,r[6]=Le*u+Ue*E+et*V+Ke*je,r[7]=Le*p+Ue*C+et*ie+Ke*Ze,Le=t[8],Ue=t[9],et=t[10],Ke=t[11],r[8]=Le*s+Ue*o+et*O+Ke*we,r[9]=Le*a+Ue*T+et*$+Ke*Pe,r[10]=Le*u+Ue*E+et*V+Ke*je,r[11]=Le*p+Ue*C+et*ie+Ke*Ze,Le=t[12],Ue=t[13],et=t[14],Ke=t[15],r[12]=Le*s+Ue*o+et*O+Ke*we,r[13]=Le*a+Ue*T+et*$+Ke*Pe,r[14]=Le*u+Ue*E+et*V+Ke*je,r[15]=Le*p+Ue*C+et*ie+Ke*Ze,r}function tf(r,e,t){const s=t[0],a=t[1],u=t[2];let p,o,T,E,C,O,$,V,ie,we,Pe,je;return e===r?(r[12]=e[0]*s+e[4]*a+e[8]*u+e[12],r[13]=e[1]*s+e[5]*a+e[9]*u+e[13],r[14]=e[2]*s+e[6]*a+e[10]*u+e[14],r[15]=e[3]*s+e[7]*a+e[11]*u+e[15]):(p=e[0],o=e[1],T=e[2],E=e[3],C=e[4],O=e[5],$=e[6],V=e[7],ie=e[8],we=e[9],Pe=e[10],je=e[11],r[0]=p,r[1]=o,r[2]=T,r[3]=E,r[4]=C,r[5]=O,r[6]=$,r[7]=V,r[8]=ie,r[9]=we,r[10]=Pe,r[11]=je,r[12]=p*s+C*a+ie*u+e[12],r[13]=o*s+O*a+we*u+e[13],r[14]=T*s+$*a+Pe*u+e[14],r[15]=E*s+V*a+je*u+e[15]),r}function Tm(r,e,t){const s=t[0],a=t[1],u=t[2];return r[0]=e[0]*s,r[1]=e[1]*s,r[2]=e[2]*s,r[3]=e[3]*s,r[4]=e[4]*a,r[5]=e[5]*a,r[6]=e[6]*a,r[7]=e[7]*a,r[8]=e[8]*u,r[9]=e[9]*u,r[10]=e[10]*u,r[11]=e[11]*u,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function c3(r,e,t,s){let a=s[0],u=s[1],p=s[2],o=Math.sqrt(a*a+u*u+p*p),T,E,C,O,$,V,ie,we,Pe,je,Ze,Le,Ue,et,Ke,ct,me,_e,ze,Qe,at,mt,At,or;return o<Fd?null:(o=1/o,a*=o,u*=o,p*=o,E=Math.sin(t),T=Math.cos(t),C=1-T,O=e[0],$=e[1],V=e[2],ie=e[3],we=e[4],Pe=e[5],je=e[6],Ze=e[7],Le=e[8],Ue=e[9],et=e[10],Ke=e[11],ct=a*a*C+T,me=u*a*C+p*E,_e=p*a*C-u*E,ze=a*u*C-p*E,Qe=u*u*C+T,at=p*u*C+a*E,mt=a*p*C+u*E,At=u*p*C-a*E,or=p*p*C+T,r[0]=O*ct+we*me+Le*_e,r[1]=$*ct+Pe*me+Ue*_e,r[2]=V*ct+je*me+et*_e,r[3]=ie*ct+Ze*me+Ke*_e,r[4]=O*ze+we*Qe+Le*at,r[5]=$*ze+Pe*Qe+Ue*at,r[6]=V*ze+je*Qe+et*at,r[7]=ie*ze+Ze*Qe+Ke*at,r[8]=O*mt+we*At+Le*or,r[9]=$*mt+Pe*At+Ue*or,r[10]=V*mt+je*At+et*or,r[11]=ie*mt+Ze*At+Ke*or,e!==r&&(r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r)}function Kx(r,e,t){const s=Math.sin(t),a=Math.cos(t),u=e[4],p=e[5],o=e[6],T=e[7],E=e[8],C=e[9],O=e[10],$=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=u*a+E*s,r[5]=p*a+C*s,r[6]=o*a+O*s,r[7]=T*a+$*s,r[8]=E*a-u*s,r[9]=C*a-p*s,r[10]=O*a-o*s,r[11]=$*a-T*s,r}function h3(r,e,t){const s=Math.sin(t),a=Math.cos(t),u=e[0],p=e[1],o=e[2],T=e[3],E=e[8],C=e[9],O=e[10],$=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=u*a-E*s,r[1]=p*a-C*s,r[2]=o*a-O*s,r[3]=T*a-$*s,r[8]=u*s+E*a,r[9]=p*s+C*a,r[10]=o*s+O*a,r[11]=T*s+$*a,r}function Jx(r,e,t){const s=Math.sin(t),a=Math.cos(t),u=e[0],p=e[1],o=e[2],T=e[3],E=e[4],C=e[5],O=e[6],$=e[7];return e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=u*a+E*s,r[1]=p*a+C*s,r[2]=o*a+O*s,r[3]=T*a+$*s,r[4]=E*a-u*s,r[5]=C*a-p*s,r[6]=O*a-o*s,r[7]=$*a-T*s,r}function u3(r,e){const t=e[0],s=e[1],a=e[2],u=e[3],p=t+t,o=s+s,T=a+a,E=t*p,C=s*p,O=s*o,$=a*p,V=a*o,ie=a*T,we=u*p,Pe=u*o,je=u*T;return r[0]=1-O-ie,r[1]=C+je,r[2]=$-Pe,r[3]=0,r[4]=C-je,r[5]=1-E-ie,r[6]=V+we,r[7]=0,r[8]=$+Pe,r[9]=V-we,r[10]=1-E-O,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function d3(r,e,t,s,a,u,p){const o=1/(t-e),T=1/(a-s),E=1/(u-p);return r[0]=u*2*o,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=u*2*T,r[6]=0,r[7]=0,r[8]=(t+e)*o,r[9]=(a+s)*T,r[10]=(p+u)*E,r[11]=-1,r[12]=0,r[13]=0,r[14]=p*u*2*E,r[15]=0,r}function f3(r,e,t,s,a){const u=1/Math.tan(e/2);if(r[0]=u/t,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=u,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,a!=null&&a!==1/0){const p=1/(s-a);r[10]=(a+s)*p,r[14]=2*a*s*p}else r[10]=-1,r[14]=-2*s;return r}const p3=f3;function g3(r,e,t,s,a,u,p){const o=1/(e-t),T=1/(s-a),E=1/(u-p);return r[0]=-2*o,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*T,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*E,r[11]=0,r[12]=(e+t)*o,r[13]=(a+s)*T,r[14]=(p+u)*E,r[15]=1,r}const m3=g3;function _3(r,e,t,s){let a,u,p,o,T,E,C,O,$,V;const ie=e[0],we=e[1],Pe=e[2],je=s[0],Ze=s[1],Le=s[2],Ue=t[0],et=t[1],Ke=t[2];return Math.abs(ie-Ue)<Fd&&Math.abs(we-et)<Fd&&Math.abs(Pe-Ke)<Fd?o3(r):(O=ie-Ue,$=we-et,V=Pe-Ke,a=1/Math.sqrt(O*O+$*$+V*V),O*=a,$*=a,V*=a,u=Ze*V-Le*$,p=Le*O-je*V,o=je*$-Ze*O,a=Math.sqrt(u*u+p*p+o*o),a?(a=1/a,u*=a,p*=a,o*=a):(u=0,p=0,o=0),T=$*o-V*p,E=V*u-O*o,C=O*p-$*u,a=Math.sqrt(T*T+E*E+C*C),a?(a=1/a,T*=a,E*=a,C*=a):(T=0,E=0,C=0),r[0]=u,r[1]=T,r[2]=O,r[3]=0,r[4]=p,r[5]=E,r[6]=$,r[7]=0,r[8]=o,r[9]=C,r[10]=V,r[11]=0,r[12]=-(u*ie+p*we+o*Pe),r[13]=-(T*ie+E*we+C*Pe),r[14]=-(O*ie+$*we+V*Pe),r[15]=1,r)}function y3(){const r=new oc(4);return oc!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function Qx(r,e,t){return r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r[3]=e[3]*t,r}function uc(r,e,t){const s=e[0],a=e[1],u=e[2],p=e[3];return r[0]=t[0]*s+t[4]*a+t[8]*u+t[12]*p,r[1]=t[1]*s+t[5]*a+t[9]*u+t[13]*p,r[2]=t[2]*s+t[6]*a+t[10]*u+t[14]*p,r[3]=t[3]*s+t[7]*a+t[11]*u+t[15]*p,r}(function(){const r=y3();return function(e,t,s,a,u,p){let o,T;for(t||(t=4),s||(s=0),a?T=Math.min(a*t+s,e.length):T=e.length,o=s;o<T;o+=t)r[0]=e[o],r[1]=e[o+1],r[2]=e[o+2],r[3]=e[o+3],u(r,r,p),e[o]=r[0],e[o+1]=r[1],e[o+2]=r[2],e[o+3]=r[3];return e}})();var Rg;(function(r){r[r.COL0ROW0=0]="COL0ROW0",r[r.COL0ROW1=1]="COL0ROW1",r[r.COL0ROW2=2]="COL0ROW2",r[r.COL0ROW3=3]="COL0ROW3",r[r.COL1ROW0=4]="COL1ROW0",r[r.COL1ROW1=5]="COL1ROW1",r[r.COL1ROW2=6]="COL1ROW2",r[r.COL1ROW3=7]="COL1ROW3",r[r.COL2ROW0=8]="COL2ROW0",r[r.COL2ROW1=9]="COL2ROW1",r[r.COL2ROW2=10]="COL2ROW2",r[r.COL2ROW3=11]="COL2ROW3",r[r.COL3ROW0=12]="COL3ROW0",r[r.COL3ROW1=13]="COL3ROW1",r[r.COL3ROW2=14]="COL3ROW2",r[r.COL3ROW3=15]="COL3ROW3"})(Rg||(Rg={}));const b3=45*Math.PI/180,v3=1,Qp=.1,eg=500,x3=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class rs extends s3{static get IDENTITY(){return T3()}static get ZERO(){return w3()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return Rg}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,s,a,u,p,o,T,E,C,O,$,V,ie,we,Pe){return this[0]=e,this[1]=t,this[2]=s,this[3]=a,this[4]=u,this[5]=p,this[6]=o,this[7]=T,this[8]=E,this[9]=C,this[10]=O,this[11]=$,this[12]=V,this[13]=ie,this[14]=we,this[15]=Pe,this.check()}setRowMajor(e,t,s,a,u,p,o,T,E,C,O,$,V,ie,we,Pe){return this[0]=e,this[1]=u,this[2]=E,this[3]=V,this[4]=t,this[5]=p,this[6]=C,this[7]=ie,this[8]=s,this[9]=o,this[10]=O,this[11]=we,this[12]=a,this[13]=T,this[14]=$,this[15]=Pe,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(x3)}fromObject(e){return this.check()}fromQuaternion(e){return u3(this,e),this.check()}frustum(e){const{left:t,right:s,bottom:a,top:u,near:p=Qp,far:o=eg}=e;return o===1/0?S3(this,t,s,a,u,p):d3(this,t,s,a,u,p,o),this.check()}lookAt(e){const{eye:t,center:s=[0,0,0],up:a=[0,1,0]}=e;return _3(this,t,s,a),this.check()}ortho(e){const{left:t,right:s,bottom:a,top:u,near:p=Qp,far:o=eg}=e;return m3(this,t,s,a,u,p,o),this.check()}orthographic(e){const{fovy:t=b3,aspect:s=v3,focalDistance:a=1,near:u=Qp,far:p=eg}=e;wb(t);const o=t/2,T=a*Math.tan(o),E=T*s;return this.ortho({left:-E,right:E,bottom:-T,top:T,near:u,far:p})}perspective(e){const{fovy:t=45*Math.PI/180,aspect:s=1,near:a=.1,far:u=500}=e;return wb(t),p3(this,t,s,a,u),this.check()}determinant(){return l3(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const s=this.getScale(t),a=1/s[0],u=1/s[1],p=1/s[2];return e[0]=this[0]*a,e[1]=this[1]*u,e[2]=this[2]*p,e[3]=0,e[4]=this[4]*a,e[5]=this[5]*u,e[6]=this[6]*p,e[7]=0,e[8]=this[8]*a,e[9]=this[9]*u,e[10]=this[10]*p,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const s=this.getScale(t),a=1/s[0],u=1/s[1],p=1/s[2];return e[0]=this[0]*a,e[1]=this[1]*u,e[2]=this[2]*p,e[3]=this[4]*a,e[4]=this[5]*u,e[5]=this[6]*p,e[6]=this[8]*a,e[7]=this[9]*u,e[8]=this[10]*p,e}transpose(){return a3(this,this),this.check()}invert(){return Mg(this,this),this.check()}multiplyLeft(e){return Da(this,e,this),this.check()}multiplyRight(e){return Da(this,this,e),this.check()}rotateX(e){return Kx(this,this,e),this.check()}rotateY(e){return h3(this,this,e),this.check()}rotateZ(e){return Jx(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return c3(this,this,e,t),this.check()}scale(e){return Tm(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return tf(this,this,e),this.check()}transform(e,t){return e.length===4?(t=uc(t||[-0,-0,-0,-0],e,this),Gp(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){const{length:s}=e;let a;switch(s){case 2:a=VE(t||[-0,-0],e,this);break;case 3:a=Yx(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Gp(a,e.length),a}transformAsVector(e,t){let s;switch(e.length){case 2:s=jE(t||[-0,-0],e,this);break;case 3:s=qx(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Gp(s,e.length),s}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,s){return this.identity().translate([e,t,s])}}let wd,Td;function w3(){return wd||(wd=new rs([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(wd)),wd}function T3(){return Td||(Td=new rs,Object.freeze(Td)),Td}function wb(r){if(r>Math.PI*2)throw Error("expected radians")}function S3(r,e,t,s,a,u){const p=2*u/(t-e),o=2*u/(a-s),T=(t+e)/(t-e),E=(a+s)/(a-s),C=-1,O=-1,$=-2*u;return r[0]=p,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=o,r[6]=0,r[7]=0,r[8]=T,r[9]=E,r[10]=C,r[11]=O,r[12]=0,r[13]=0,r[14]=$,r[15]=0,r}function e0(r,e=[],t=0){const s=Math.fround(r),a=r-s;return e[t]=s,e[t+1]=a,e}function A3(r){return r-Math.fround(r)}function E3(r){const e=new Float32Array(32);for(let t=0;t<4;++t)for(let s=0;s<4;++s){const a=t*4+s;e0(r[s*4+t],e,a*2)}return e}const I3=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND

// All these functions are for substituting tan() function from Intel GPU only
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }

    // 2pi range reduction
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,C3={name:"fp32",vs:I3},P3=`
uniform fp64arithmeticUniforms {
  uniform float ONE;
} fp64;

/*
About LUMA_FP64_CODE_ELIMINATION_WORKAROUND

The purpose of this workaround is to prevent shader compilers from
optimizing away necessary arithmetic operations by swapping their sequences
or transform the equation to some 'equivalent' form.

The method is to multiply an artifical variable, ONE, which will be known to
the compiler to be 1 only at runtime. The whole expression is then represented
as a polynomial with respective to ONE. In the coefficients of all terms, only one a
and one b should appear

err = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE
*/

// Divide float number to high and low floats to extend fraction bits
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * fp64.ONE - (t - a);
  float a_lo = a * fp64.ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}

// Divide float number again when high float uses too many fraction bits
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}

// Special sum operation when a > b
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * fp64.ONE;
  float err = b - (sum - a) * fp64.ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}

// General sum operation
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * fp64.ONE + 2.0 * a_fp64.x *
    a_fp64.y * fp64.ONE * fp64.ONE) + a_fp64.y * a_fp64.y * fp64.ONE * fp64.ONE * fp64.ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  // y component is for the error
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * fp64.ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,M3={ONE:1},R3={name:"fp64arithmetic",vs:P3,defaultUniforms:M3,uniformTypes:{ONE:"f32"},fp64ify:e0,fp64LowPart:A3,fp64ifyMatrix4:E3},k3=[0,1,1,1],D3=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

out vec4 picking_vRGBcolor_Avalid;

// Normalize unsigned byte color to 0-1 range
vec3 picking_normalizeColor(vec3 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

// Normalize unsigned byte color to 0-1 range
vec4 picking_normalizeColor(vec4 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

bool picking_isColorZero(vec3 color) {
  return dot(color, vec3(1.0)) < 0.00001;
}

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.00001;
}

// Check if this vertex is highlighted 
bool isVertexHighlighted(vec3 vertexColor) {
  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
  return
    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}

// Set the current picking color
void picking_setPickingColor(vec3 pickingColor) {
  pickingColor = picking_normalizeColor(pickingColor);

  if (bool(picking.isActive)) {
    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!bool(picking.isAttribute)) {
      // Stores the picking color so that the fragment shader can render it during picking
      picking_vRGBcolor_Avalid.rgb = pickingColor;
    }
  } else {
    // Do the comparison with selected item color in vertex shader as it should mean fewer compares
    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.r = value;
  }
}

void picking_setPickingAttribute(vec2 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}

void picking_setPickingAttribute(vec3 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,O3=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

in vec4 picking_vRGBcolor_Avalid;

/*
 * Returns highlight color if this item is selected.
 */
vec4 picking_filterHighlightColor(vec4 color) {
  // If we are still picking, we don't highlight
  if (picking.isActive > 0.5) {
    return color;
  }

  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    // Blend in highlight color based on its alpha value
    float highLightAlpha = picking.highlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}

/*
 * Returns picking color if picking enabled else unmodified argument.
 */
vec4 picking_filterPickingColor(vec4 color) {
  if (bool(picking.isActive)) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}

/*
 * Returns picking color if picking is enabled if not
 * highlight color if this item is selected, otherwise unmodified argument.
 */
vec4 picking_filterColor(vec4 color) {
  vec4 highlightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highlightColor);
}
`,Tb={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:k3},vs:D3,fs:O3,getUniforms:F3};function F3(r={},e){const t={};if(r.highlightedObjectColor!==void 0)if(r.highlightedObjectColor===null)t.isHighlightActive=!1;else{t.isHighlightActive=!0;const s=r.highlightedObjectColor.slice(0,3);t.highlightedObjectColor=s}if(r.highlightColor){const s=Array.from(r.highlightColor,a=>a/255);Number.isFinite(s[3])||(s[3]=1),t.highlightColor=s}return r.isActive!==void 0&&(t.isActive=!!r.isActive,t.isAttribute=!!r.isAttribute),r.useFloatColors!==void 0&&(t.useFloatColors=!!r.useFloatColors),t}const Sb=`precision highp int;

// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  vec3 color;
};

struct PointLight {
  vec3 color;
  vec3 position;
  vec3 attenuation; // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform lightingUniforms {
  int enabled;
  int lightType;

  int directionalLightCount;
  int pointLightCount;

  vec3 ambientColor;

  vec3 lightColor0;
  vec3 lightPosition0;
  vec3 lightDirection0;
  vec3 lightAttenuation0;

  vec3 lightColor1;
  vec3 lightPosition1;
  vec3 lightDirection1;
  vec3 lightAttenuation1;

  vec3 lightColor2;
  vec3 lightPosition2;
  vec3 lightDirection2;
  vec3 lightAttenuation2;
} lighting;

PointLight lighting_getPointLight(int index) {
  switch (index) {
    case 0:
      return PointLight(lighting.lightColor0, lighting.lightPosition0, lighting.lightAttenuation0);
    case 1:
      return PointLight(lighting.lightColor1, lighting.lightPosition1, lighting.lightAttenuation1);
    case 2:
    default:  
      return PointLight(lighting.lightColor2, lighting.lightPosition2, lighting.lightAttenuation2);
  }
}

DirectionalLight lighting_getDirectionalLight(int index) {
  switch (index) {
    case 0:
      return DirectionalLight(lighting.lightColor0, lighting.lightDirection0);
    case 1:
      return DirectionalLight(lighting.lightColor1, lighting.lightDirection1);
    case 2:
    default:   
      return DirectionalLight(lighting.lightColor2, lighting.lightDirection2);
  }
} 

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

// #endif
`,B3=`// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  color: vec3<f32>,
};

struct PointLight {
  color: vec3<f32>,
  position: vec3<f32>,
  attenuation: vec3<f32>, // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  color: vec3<f32>,
  direction: vec3<f32>,
};

struct lightingUniforms {
  enabled: i32,
  pointLightCount: i32,
  directionalLightCount: i32,

  ambientColor: vec3<f32>,

  // TODO - support multiple lights by uncommenting arrays below
  lightType: i32,
  lightColor: vec3<f32>,
  lightDirection: vec3<f32>,
  lightPosition: vec3<f32>,
  lightAttenuation: vec3<f32>,

  // AmbientLight ambientLight;
  // PointLight pointLight[MAX_LIGHTS];
  // DirectionalLight directionalLight[MAX_LIGHTS];
};

// Binding 0:1 is reserved for lighting (Note: could go into separate bind group as it is stable across draw calls)
@binding(1) @group(0) var<uniform> lighting : lightingUniforms;

fn lighting_getPointLight(index: i32) -> PointLight {
  return PointLight(lighting.lightColor, lighting.lightPosition, lighting.lightAttenuation);
}

fn lighting_getDirectionalLight(index: i32) -> DirectionalLight {
  return DirectionalLight(lighting.lightColor, lighting.lightDirection);
} 

fn getPointLightAttenuation(pointLight: PointLight, distance: f32) -> f32 {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}
`,t0=3,L3=255;var Wh;(function(r){r[r.POINT=0]="POINT",r[r.DIRECTIONAL=1]="DIRECTIONAL"})(Wh||(Wh={}));const Bd={props:{},uniforms:{},name:"lighting",defines:{MAX_LIGHTS:t0},uniformTypes:{enabled:"i32",lightType:"i32",directionalLightCount:"i32",pointLightCount:"i32",ambientLightColor:"vec3<f32>",lightColor0:"vec3<f32>",lightPosition0:"vec3<f32>",lightDirection0:"vec3<f32>",lightAttenuation0:"vec3<f32>",lightColor1:"vec3<f32>",lightPosition1:"vec3<f32>",lightDirection1:"vec3<f32>",lightAttenuation1:"vec3<f32>",lightColor2:"vec3<f32>",lightPosition2:"vec3<f32>",lightDirection2:"vec3<f32>",lightAttenuation2:"vec3<f32>"},defaultUniforms:{enabled:1,lightType:Wh.POINT,directionalLightCount:0,pointLightCount:0,ambientLightColor:[.1,.1,.1],lightColor0:[1,1,1],lightPosition0:[1,1,2],lightDirection0:[1,1,1],lightAttenuation0:[1,0,0],lightColor1:[1,1,1],lightPosition1:[1,1,2],lightDirection1:[1,1,1],lightAttenuation1:[1,0,0],lightColor2:[1,1,1],lightPosition2:[1,1,2],lightDirection2:[1,1,1],lightAttenuation2:[1,0,0]},source:B3,vs:Sb,fs:Sb,getUniforms:N3};function N3(r,e={}){if(r=r&&{...r},!r)return{...Bd.defaultUniforms};r.lights&&(r={...r,...U3(r.lights),lights:void 0});const{ambientLight:t,pointLights:s,directionalLights:a}=r||{};if(!(t||s&&s.length>0||a&&a.length>0))return{...Bd.defaultUniforms,enabled:0};const p={...Bd.defaultUniforms,...e,...z3({ambientLight:t,pointLights:s,directionalLights:a})};return r.enabled!==void 0&&(p.enabled=r.enabled?1:0),p}function z3({ambientLight:r,pointLights:e=[],directionalLights:t=[]}){const s={};s.ambientLightColor=tg(r);let a=0;for(const u of e){s.lightType=Wh.POINT;const p=a;s[`lightColor${p}`]=tg(u),s[`lightPosition${p}`]=u.position,s[`lightAttenuation${p}`]=u.attenuation||[1,0,0],a++}for(const u of t){s.lightType=Wh.DIRECTIONAL;const p=a;s[`lightColor${p}`]=tg(u),s[`lightDirection${p}`]=u.direction,a++}return a>t0&&ot.warn("MAX_LIGHTS exceeded")(),s.directionalLightCount=t.length,s.pointLightCount=e.length,s}function U3(r){const e={pointLights:[],directionalLights:[]};for(const t of r||[])switch(t.type){case"ambient":e.ambientLight=t;break;case"directional":e.directionalLights?.push(t);break;case"point":e.pointLights?.push(t);break}return e}function tg(r={}){const{color:e=[0,0,0],intensity:t=1}=r;return e.map(s=>s*t/L3)}const V3=`uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;
`,j3=`uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
  vec3 halfway_direction = normalize(light_direction + view_direction);
  float lambertian = dot(light_direction, normal_worldspace);
  float specular = 0.0;
  if (lambertian > 0.0) {
    float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, material.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * material.diffuse * surfaceColor + specular * material.specularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  vec3 view_direction = normalize(cameraPosition - position_worldspace);
  lightColor = material.ambient * surfaceColor * lighting.ambientColor;

  for (int i = 0; i < lighting.pointLightCount; i++) {
    PointLight pointLight = lighting_getPointLight(i);
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    float light_attenuation = getPointLightAttenuation(pointLight, distance(light_position_worldspace, position_worldspace));
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color / light_attenuation);
  }

  int totalLights = min(MAX_LIGHTS, lighting.pointLightCount + lighting.directionalLightCount);
  for (int i = lighting.pointLightCount; i < totalLights; i++) {
    DirectionalLight directionalLight = lighting_getDirectionalLight(i);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
}
`,$3=`struct phongMaterialUniforms {
  ambient: f32,
  diffuse: f32,
  shininess: f32,
  specularColor: vec3<f32>,
};

@binding(2) @group(0) var<uniform> phongMaterial : phongMaterialUniforms;

fn lighting_getLightColor(surfaceColor: vec3<f32>, light_direction: vec3<f32>, view_direction: vec3<f32>, normal_worldspace: vec3<f32>, color: vec3<f32>) -> vec3<f32> {
  let halfway_direction: vec3<f32> = normalize(light_direction + view_direction);
  var lambertian: f32 = dot(light_direction, normal_worldspace);
  var specular: f32 = 0.0;
  if (lambertian > 0.0) {
    let specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, phongMaterial.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * phongMaterial.diffuse * surfaceColor + specular * phongMaterial.specularColor) * color;
}

fn lighting_getLightColor2(surfaceColor: vec3<f32>, cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32> {
  var lightColor: vec3<f32> = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  let view_direction: vec3<f32> = normalize(cameraPosition - position_worldspace);
  lightColor = phongMaterial.ambient * surfaceColor * lighting.ambientColor;

  if (lighting.lightType == 0) {
    let pointLight: PointLight  = lighting_getPointLight(0);
    let light_position_worldspace: vec3<f32> = pointLight.position;
    let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  } else if (lighting.lightType == 1) {
    var directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
  /*
  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.pointLightCount) {
      break;
    }
    PointLight pointLight = lighting.pointLight[i];
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  }

  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.directionalLightCount) {
      break;
    }
    DirectionalLight directionalLight = lighting.directionalLight[i];
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  */
}

fn lighting_getSpecularLightColor(cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32>{
  var lightColor = vec3<f32>(0, 0, 0);
  let surfaceColor = vec3<f32>(0, 0, 0);

  if (lighting.enabled == 0) {
    let view_direction = normalize(cameraPosition - position_worldspace);

    switch (lighting.lightType) {
      case 0, default: {
        let pointLight: PointLight = lighting_getPointLight(0);
        let light_position_worldspace: vec3<f32> = pointLight.position;
        let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
        lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
      }
      case 1: {
        let directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
        lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
      }
    }
  }
  return lightColor;
}
`,r0={props:{},name:"gouraudMaterial",vs:j3.replace("phongMaterial","gouraudMaterial"),fs:V3.replace("phongMaterial","gouraudMaterial"),source:$3.replaceAll("phongMaterial","gouraudMaterial"),defines:{LIGHTING_VERTEX:1},dependencies:[Bd],uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(r){const e={...r};return e.specularColor&&(e.specularColor=e.specularColor.map(t=>t/255)),{...r0.defaultUniforms,...e}}},Ab=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,W3={name:"layer",vs:Ab,fs:Ab,getUniforms:r=>({opacity:Math.pow(r.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}},H3=`const SMOOTH_EDGE_RADIUS: f32 = 0.5;

struct VertexGeometry {
  position: vec4<f32>,
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

var<private> geometry_: VertexGeometry = VertexGeometry(
  vec4<f32>(0.0, 0.0, 1.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec2<f32>(0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0)
);

struct FragmentGeometry {
  uv: vec2<f32>,
};

var<private> fragmentGeometry: FragmentGeometry;

fn smoothedge(edge: f32, x: f32) -> f32 {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,i0="#define SMOOTH_EDGE_RADIUS 0.5",Z3=`${i0}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,X3=`${i0}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,n0={name:"geometry",source:H3,vs:Z3,fs:X3},q3=25;var yi;(function(r){r[r.Start=1]="Start",r[r.Move=2]="Move",r[r.End=4]="End",r[r.Cancel=8]="Cancel"})(yi||(yi={}));var Ci;(function(r){r[r.None=0]="None",r[r.Left=1]="Left",r[r.Right=2]="Right",r[r.Up=4]="Up",r[r.Down=8]="Down",r[r.Horizontal=3]="Horizontal",r[r.Vertical=12]="Vertical",r[r.All=15]="All"})(Ci||(Ci={}));var Wt;(function(r){r[r.Possible=1]="Possible",r[r.Began=2]="Began",r[r.Changed=4]="Changed",r[r.Ended=8]="Ended",r[r.Recognized=8]="Recognized",r[r.Cancelled=16]="Cancelled",r[r.Failed=32]="Failed"})(Wt||(Wt={}));const Y3="compute",G3="auto",kg="manipulation",Ld="none",Dg="pan-x",Og="pan-y";function K3(r){if(r.includes(Ld))return Ld;const e=r.includes(Dg),t=r.includes(Og);return e&&t?Ld:e||t?e?Dg:Og:r.includes(kg)?kg:G3}class J3{constructor(e,t){this.actions="",this.manager=e,this.set(t)}set(e){e===Y3&&(e=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=e,this.actions=e)}update(){this.set(this.manager.options.touchAction)}compute(){let e=[];for(const t of this.manager.recognizers)t.options.enable&&(e=e.concat(t.getTouchAction()));return K3(e.join(" "))}}function rf(r){return r.trim().split(/\s+/g)}function rg(r,e,t){if(r)for(const s of rf(e))r.addEventListener(s,t,!1)}function ig(r,e,t){if(r)for(const s of rf(e))r.removeEventListener(s,t,!1)}function Eb(r){return(r.ownerDocument||r).defaultView}function Q3(r,e){let t=r;for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function s0(r){const e=r.length;if(e===1)return{x:Math.round(r[0].clientX),y:Math.round(r[0].clientY)};let t=0,s=0,a=0;for(;a<e;)t+=r[a].clientX,s+=r[a].clientY,a++;return{x:Math.round(t/e),y:Math.round(s/e)}}function Ib(r){const e=[];let t=0;for(;t<r.pointers.length;)e[t]={clientX:Math.round(r.pointers[t].clientX),clientY:Math.round(r.pointers[t].clientY)},t++;return{timeStamp:Date.now(),pointers:e,center:s0(e),deltaX:r.deltaX,deltaY:r.deltaY}}function o0(r,e){const t=e.x-r.x,s=e.y-r.y;return Math.sqrt(t*t+s*s)}function Cb(r,e){const t=e.clientX-r.clientX,s=e.clientY-r.clientY;return Math.sqrt(t*t+s*s)}function eI(r,e){const t=e.x-r.x,s=e.y-r.y;return Math.atan2(s,t)*180/Math.PI}function Pb(r,e){const t=e.clientX-r.clientX,s=e.clientY-r.clientY;return Math.atan2(s,t)*180/Math.PI}function a0(r,e){return r===e?Ci.None:Math.abs(r)>=Math.abs(e)?r<0?Ci.Left:Ci.Right:e<0?Ci.Up:Ci.Down}function tI(r,e){const t=e.center;let s=r.offsetDelta,a=r.prevDelta;const u=r.prevInput;return(e.eventType===yi.Start||u?.eventType===yi.End)&&(a=r.prevDelta={x:u?.deltaX||0,y:u?.deltaY||0},s=r.offsetDelta={x:t.x,y:t.y}),{deltaX:a.x+(t.x-s.x),deltaY:a.y+(t.y-s.y)}}function l0(r,e,t){return{x:e/r||0,y:t/r||0}}function rI(r,e){return Cb(e[0],e[1])/Cb(r[0],r[1])}function iI(r,e){return Pb(e[1],e[0])-Pb(r[1],r[0])}function nI(r,e){const t=r.lastInterval||e,s=e.timeStamp-t.timeStamp;let a,u,p,o;if(e.eventType!==yi.Cancel&&(s>q3||t.velocity===void 0)){const T=e.deltaX-t.deltaX,E=e.deltaY-t.deltaY,C=l0(s,T,E);u=C.x,p=C.y,a=Math.abs(C.x)>Math.abs(C.y)?C.x:C.y,o=a0(T,E),r.lastInterval=e}else a=t.velocity,u=t.velocityX,p=t.velocityY,o=t.direction;e.velocity=a,e.velocityX=u,e.velocityY=p,e.direction=o}function sI(r,e){const{session:t}=r,{pointers:s}=e,{length:a}=s;t.firstInput||(t.firstInput=Ib(e)),a>1&&!t.firstMultiple?t.firstMultiple=Ib(e):a===1&&(t.firstMultiple=!1);const{firstInput:u,firstMultiple:p}=t,o=p?p.center:u.center,T=e.center=s0(s);e.timeStamp=Date.now(),e.deltaTime=e.timeStamp-u.timeStamp,e.angle=eI(o,T),e.distance=o0(o,T);const{deltaX:E,deltaY:C}=tI(t,e);e.deltaX=E,e.deltaY=C,e.offsetDirection=a0(e.deltaX,e.deltaY);const O=l0(e.deltaTime,e.deltaX,e.deltaY);e.overallVelocityX=O.x,e.overallVelocityY=O.y,e.overallVelocity=Math.abs(O.x)>Math.abs(O.y)?O.x:O.y,e.scale=p?rI(p.pointers,s):1,e.rotation=p?iI(p.pointers,s):0,e.maxPointers=t.prevInput?e.pointers.length>t.prevInput.maxPointers?e.pointers.length:t.prevInput.maxPointers:e.pointers.length;let $=r.element;return Q3(e.srcEvent.target,$)&&($=e.srcEvent.target),e.target=$,nI(t,e),e}function oI(r,e,t){const s=t.pointers.length,a=t.changedPointers.length,u=e&yi.Start&&s-a===0,p=e&(yi.End|yi.Cancel)&&s-a===0;t.isFirst=!!u,t.isFinal=!!p,u&&(r.session={}),t.eventType=e;const o=sI(r,t);r.emit("hammer.input",o),r.recognize(o),r.session.prevInput=o}let aI=class{constructor(e){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=t=>{this.manager.options.enable&&this.handler(t)},this.manager=e,this.element=e.element,this.target=e.options.inputTarget||e.element}callback(e,t){oI(this.manager,e,t)}init(){rg(this.element,this.evEl,this.domHandler),rg(this.target,this.evTarget,this.domHandler),rg(Eb(this.element),this.evWin,this.domHandler)}destroy(){ig(this.element,this.evEl,this.domHandler),ig(this.target,this.evTarget,this.domHandler),ig(Eb(this.element),this.evWin,this.domHandler)}};const lI={pointerdown:yi.Start,pointermove:yi.Move,pointerup:yi.End,pointercancel:yi.Cancel,pointerout:yi.Cancel},cI="pointerdown",hI="pointermove pointerup pointercancel";class uI extends aI{constructor(e){super(e),this.evEl=cI,this.evWin=hI,this.store=this.manager.session.pointerEvents=[],this.init()}handler(e){const{store:t}=this;let s=!1;const a=lI[e.type],u=e.pointerType,p=u==="touch";let o=t.findIndex(T=>T.pointerId===e.pointerId);a&yi.Start&&(e.buttons||p)?o<0&&(t.push(e),o=t.length-1):a&(yi.End|yi.Cancel)&&(s=!0),!(o<0)&&(t[o]=e,this.callback(a,{pointers:t,changedPointers:[e],eventType:a,pointerType:u,srcEvent:e}),s&&t.splice(o,1))}}const dI=["","webkit","Moz","MS","ms","o"];function fI(r,e){const t=e[0].toUpperCase()+e.slice(1);for(const s of dI){const a=s?s+t:e;if(a in r)return a}}const pI=1,Mb=2,Rb={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class gI{constructor(e,t){this.options={...Rb,...t,cssProps:{...Rb.cssProps,...t.cssProps},inputTarget:t.inputTarget||e},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new uI(this),this.touchAction=new J3(this,this.options.touchAction),this.toggleCssProps(!0)}set(e){return Object.assign(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this}stop(e){this.session.stopped=e?Mb:pI}recognize(e){const{session:t}=this;if(t.stopped)return;this.session.prevented&&e.srcEvent.preventDefault();let s;const{recognizers:a}=this;let{curRecognizer:u}=t;(!u||u&&u.state&Wt.Recognized)&&(u=t.curRecognizer=null);let p=0;for(;p<a.length;)s=a[p],t.stopped!==Mb&&(!u||s===u||s.canRecognizeWith(u))?s.recognize(e):s.reset(),!u&&s.state&(Wt.Began|Wt.Changed|Wt.Ended)&&(u=t.curRecognizer=s),p++}get(e){const{recognizers:t}=this;for(let s=0;s<t.length;s++)if(t[s].options.event===e)return t[s];return null}add(e){if(Array.isArray(e)){for(const s of e)this.add(s);return this}const t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e}remove(e){if(Array.isArray(e)){for(const s of e)this.remove(s);return this}const t=typeof e=="string"?this.get(e):e;if(t){const{recognizers:s}=this,a=s.indexOf(t);a!==-1&&(s.splice(a,1),this.touchAction.update())}return this}on(e,t){if(!e||!t)return;const{handlers:s}=this;for(const a of rf(e))s[a]=s[a]||[],s[a].push(t)}off(e,t){if(!e)return;const{handlers:s}=this;for(const a of rf(e))t?s[a]&&s[a].splice(s[a].indexOf(t),1):delete s[a]}emit(e,t){const s=this.handlers[e]&&this.handlers[e].slice();if(!s||!s.length)return;const a=t;a.type=e,a.preventDefault=function(){t.srcEvent.preventDefault()};let u=0;for(;u<s.length;)s[u](a),u++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(e){const{element:t}=this;if(t){for(const[s,a]of Object.entries(this.options.cssProps)){const u=fI(t.style,s);e?(this.oldCssProps[u]=t.style[u],t.style[u]=a):t.style[u]=this.oldCssProps[u]||""}e||(this.oldCssProps={})}}}let mI=1;function _I(){return mI++}function kb(r){return r&Wt.Cancelled?"cancel":r&Wt.Ended?"end":r&Wt.Changed?"move":r&Wt.Began?"start":""}class c0{constructor(e){this.options=e,this.id=_I(),this.state=Wt.Possible,this.simultaneous={},this.requireFail=[]}set(e){return Object.assign(this.options,e),this.manager.touchAction.update(),this}recognizeWith(e){if(Array.isArray(e)){for(const a of e)this.recognizeWith(a);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{simultaneous:s}=this;return s[t.id]||(s[t.id]=t,t.recognizeWith(this)),this}dropRecognizeWith(e){if(Array.isArray(e)){for(const s of e)this.dropRecognizeWith(s);return this}let t;return typeof e=="string"?t=this.manager.get(e):t=e,t&&delete this.simultaneous[t.id],this}requireFailure(e){if(Array.isArray(e)){for(const a of e)this.requireFailure(a);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{requireFail:s}=this;return s.indexOf(t)===-1&&(s.push(t),t.requireFailure(this)),this}dropRequireFailure(e){if(Array.isArray(e)){for(const s of e)this.dropRequireFailure(s);return this}let t;if(typeof e=="string"?t=this.manager.get(e):t=e,t){const s=this.requireFail.indexOf(t);s>-1&&this.requireFail.splice(s,1)}return this}hasRequireFailures(){return!!this.requireFail.find(e=>e.options.enable)}canRecognizeWith(e){return!!this.simultaneous[e.id]}emit(e){if(!e)return;const{state:t}=this;t<Wt.Ended&&this.manager.emit(this.options.event+kb(t),e),this.manager.emit(this.options.event,e),e.additionalEvent&&this.manager.emit(e.additionalEvent,e),t>=Wt.Ended&&this.manager.emit(this.options.event+kb(t),e)}tryEmit(e){this.canEmit()?this.emit(e):this.state=Wt.Failed}canEmit(){let e=0;for(;e<this.requireFail.length;){if(!(this.requireFail[e].state&(Wt.Failed|Wt.Possible)))return!1;e++}return!0}recognize(e){const t={...e};if(!this.options.enable){this.reset(),this.state=Wt.Failed;return}this.state&(Wt.Recognized|Wt.Cancelled|Wt.Failed)&&(this.state=Wt.Possible),this.state=this.process(t),this.state&(Wt.Began|Wt.Changed|Wt.Ended|Wt.Cancelled)&&this.tryEmit(t)}getEventNames(){return[this.options.event]}reset(){}}class h0 extends c0{attrTest(e){const t=this.options.pointers;return t===0||e.pointers.length===t}process(e){const{state:t}=this,{eventType:s}=e,a=t&(Wt.Began|Wt.Changed),u=this.attrTest(e);return a&&(s&yi.Cancel||!u)?t|Wt.Cancelled:a||u?s&yi.End?t|Wt.Ended:t&Wt.Began?t|Wt.Changed:Wt.Began:Wt.Failed}}class Db extends c0{constructor(e={}){super({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10,...e}),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[kg]}process(e){const{options:t}=this,s=e.pointers.length===t.pointers,a=e.distance<t.threshold,u=e.deltaTime<t.time;if(this.reset(),e.eventType&yi.Start&&this.count===0)return this.failTimeout();if(a&&u&&s){if(e.eventType!==yi.End)return this.failTimeout();const p=this.pTime?e.timeStamp-this.pTime<t.interval:!0,o=!this.pCenter||o0(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,!o||!p?this.count=1:this.count+=1,this._input=e,this.count%t.taps===0)return this.hasRequireFailures()?(this._timer=setTimeout(()=>{this.state=Wt.Recognized,this.tryEmit(this._input)},t.interval),Wt.Began):Wt.Recognized}return Wt.Failed}failTimeout(){return this._timer=setTimeout(()=>{this.state=Wt.Failed},this.options.interval),Wt.Failed}reset(){clearTimeout(this._timer)}emit(e){this.state===Wt.Recognized&&(e.tapCount=this.count,this.manager.emit(this.options.event,e))}}const yI=["","start","move","end","cancel","up","down","left","right"];class Ob extends h0{constructor(e={}){super({enable:!0,pointers:1,event:"pan",threshold:10,direction:Ci.All,...e}),this.pX=null,this.pY=null}getTouchAction(){const{options:{direction:e}}=this,t=[];return e&Ci.Horizontal&&t.push(Og),e&Ci.Vertical&&t.push(Dg),t}getEventNames(){return yI.map(e=>this.options.event+e)}directionTest(e){const{options:t}=this;let s=!0,{distance:a}=e,{direction:u}=e;const p=e.deltaX,o=e.deltaY;return u&t.direction||(t.direction&Ci.Horizontal?(u=p===0?Ci.None:p<0?Ci.Left:Ci.Right,s=p!==this.pX,a=Math.abs(e.deltaX)):(u=o===0?Ci.None:o<0?Ci.Up:Ci.Down,s=o!==this.pY,a=Math.abs(e.deltaY))),e.direction=u,s&&a>t.threshold&&!!(u&t.direction)}attrTest(e){return super.attrTest(e)&&(!!(this.state&Wt.Began)||!(this.state&Wt.Began)&&this.directionTest(e))}emit(e){this.pX=e.deltaX,this.pY=e.deltaY;const t=Ci[e.direction].toLowerCase();t&&(e.additionalEvent=this.options.event+t),super.emit(e)}}const bI=["","start","move","end","cancel","in","out"];class vI extends h0{constructor(e={}){super({enable:!0,event:"pinch",threshold:0,pointers:2,...e})}getTouchAction(){return[Ld]}getEventNames(){return bI.map(e=>this.options.event+e)}attrTest(e){return super.attrTest(e)&&(Math.abs(e.scale-1)>this.options.threshold||!!(this.state&Wt.Began))}emit(e){if(e.scale!==1){const t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}super.emit(e)}}class gf{constructor(e,t,s){this.element=e,this.callback=t,this.options=s}}const xI=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",wI=xI.indexOf("firefox")!==-1,Fb=4.000244140625,TI=40,SI=.25;class AI extends gf{constructor(e,t,s){super(e,t,{enable:!0,...s}),this.handleEvent=a=>{if(!this.options.enable)return;let u=a.deltaY;globalThis.WheelEvent&&(wI&&a.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(u/=globalThis.devicePixelRatio),a.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(u*=TI)),u!==0&&u%Fb===0&&(u=Math.floor(u/Fb)),a.shiftKey&&u&&(u=u*SI),this.callback({type:"wheel",center:{x:a.clientX,y:a.clientY},delta:-u,srcEvent:a,pointerType:"mouse",target:a.target})},e.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(e,t){e==="wheel"&&(this.options.enable=t)}}const Bb=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class EI extends gf{constructor(e,t,s){super(e,t,{enable:!0,...s}),this.handleEvent=u=>{this.handleOverEvent(u),this.handleOutEvent(u),this.handleEnterEvent(u),this.handleLeaveEvent(u),this.handleMoveEvent(u)},this.pressed=!1;const{enable:a}=this.options;this.enableMoveEvent=a,this.enableLeaveEvent=a,this.enableEnterEvent=a,this.enableOutEvent=a,this.enableOverEvent=a,Bb.forEach(u=>e.addEventListener(u,this.handleEvent))}destroy(){Bb.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){switch(e){case"pointermove":this.enableMoveEvent=t;break;case"pointerover":this.enableOverEvent=t;break;case"pointerout":this.enableOutEvent=t;break;case"pointerenter":this.enableEnterEvent=t;break;case"pointerleave":this.enableLeaveEvent=t;break}}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit("pointerover",e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit("pointerout",e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit("pointerenter",e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit("pointerleave",e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.buttons===0&&(this.pressed=!1),this.pressed||this._emit("pointermove",e);break;case"mouseup":this.pressed=!1;break}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}const Lb=["keydown","keyup"];class II extends gf{constructor(e,t,s){super(e,t,{enable:!0,tabIndex:0,...s}),this.handleEvent=a=>{const u=a.target||a.srcElement;u.tagName==="INPUT"&&u.type==="text"||u.tagName==="TEXTAREA"||(this.enableDownEvent&&a.type==="keydown"&&this.callback({type:"keydown",srcEvent:a,key:a.key,target:a.target}),this.enableUpEvent&&a.type==="keyup"&&this.callback({type:"keyup",srcEvent:a,key:a.key,target:a.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,e.tabIndex=this.options.tabIndex,e.style.outline="none",Lb.forEach(a=>e.addEventListener(a,this.handleEvent))}destroy(){Lb.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e==="keydown"&&(this.enableDownEvent=t),e==="keyup"&&(this.enableUpEvent=t)}}class CI extends gf{constructor(e,t,s){super(e,t,s),this.handleEvent=a=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:a.clientX,y:a.clientY},srcEvent:a,pointerType:"mouse",target:a.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e==="contextmenu"&&(this.options.enable=t)}}const Nb=1,Fg=2,zb=4,PI={pointerdown:Nb,pointermove:Fg,pointerup:zb,mousedown:Nb,mousemove:Fg,mouseup:zb},MI=0,RI=1,kI=2,DI=1,OI=2,FI=4;function BI(r){const e=PI[r.srcEvent.type];if(!e)return null;const{buttons:t,button:s}=r.srcEvent;let a=!1,u=!1,p=!1;return e===Fg?(a=!!(t&DI),u=!!(t&FI),p=!!(t&OI)):(a=s===MI,u=s===RI,p=s===kI),{leftButton:a,middleButton:u,rightButton:p}}function LI(r,e){const t=r.center;if(!t)return null;const s=e.getBoundingClientRect(),a=s.width/e.offsetWidth||1,u=s.height/e.offsetHeight||1,p={x:(t.x-s.left-e.clientLeft)/a,y:(t.y-s.top-e.clientTop)/u};return{center:t,offsetCenter:p}}const NI={srcElement:"root",priority:0};class zI{constructor(e,t){this.handleEvent=s=>{if(this.isEmpty())return;const a=this._normalizeEvent(s);let u=s.srcEvent.target;for(;u&&u!==a.rootElement;){if(this._emit(a,u),a.handled)return;u=u.parentNode}this._emit(a,"root")},this.eventManager=e,this.recognizerName=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,s,a=!1,u=!1){const{handlers:p,handlersByElement:o}=this,T={...NI,...s};let E=o.get(T.srcElement);E||(E=[],o.set(T.srcElement,E));const C={type:e,handler:t,srcElement:T.srcElement,priority:T.priority};a&&(C.once=!0),u&&(C.passive=!0),p.push(C),this._active=this._active||!C.passive;let O=E.length-1;for(;O>=0&&!(E[O].priority>=C.priority);)O--;E.splice(O+1,0,C)}remove(e,t){const{handlers:s,handlersByElement:a}=this;for(let u=s.length-1;u>=0;u--){const p=s[u];if(p.type===e&&p.handler===t){s.splice(u,1);const o=a.get(p.srcElement);o.splice(o.indexOf(p),1),o.length===0&&a.delete(p.srcElement)}}this._active=s.some(u=>!u.passive)}_emit(e,t){const s=this.handlersByElement.get(t);if(s){let a=!1;const u=()=>{e.handled=!0},p=()=>{e.handled=!0,a=!0},o=[];for(let T=0;T<s.length;T++){const{type:E,handler:C,once:O}=s[T];if(C({...e,type:E,stopPropagation:u,stopImmediatePropagation:p}),O&&o.push(s[T]),a)break}for(let T=0;T<o.length;T++){const{type:E,handler:C}=o[T];this.remove(E,C)}}}_normalizeEvent(e){const t=this.eventManager.getElement();return{...e,...BI(e),...LI(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}function UI(r){if("recognizer"in r)return r;let e;const t=Array.isArray(r)?[...r]:[r];if(typeof t[0]=="function"){const s=t.shift(),a=t.shift()||{};e=new s(a)}else e=t.shift();return{recognizer:e,recognizeWith:typeof t[0]=="string"?[t[0]]:t[0],requireFailure:typeof t[1]=="string"?[t[1]]:t[1]}}class VI{constructor(e=null,t={}){if(this._onBasicInput=s=>{this.manager.emit(s.srcEvent.type,s)},this._onOtherEvent=s=>{this.manager.emit(s.type,s)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...t},this.events=new Map,this.element=e,!!e){this.manager=new gI(e,this.options);for(const s of this.options.recognizers){const{recognizer:a,recognizeWith:u,requireFailure:p}=UI(s);this.manager.add(a),u&&a.recognizeWith(u),p&&a.requireFailure(p)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new AI(e,this._onOtherEvent,{enable:!1}),this.moveInput=new EI(e,this._onOtherEvent,{enable:!1}),this.keyInput=new II(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new CI(e,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(e,t,s){this._addEventHandler(e,t,s,!1)}once(e,t,s){this._addEventHandler(e,t,s,!0)}watch(e,t,s){this._addEventHandler(e,t,s,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){const{manager:s}=this;if(!s)return;const a=s.get(e);a&&(a.set({enable:t}),s.touchAction.update()),this.wheelInput?.enableEventType(e,t),this.moveInput?.enableEventType(e,t),this.keyInput?.enableEventType(e,t),this.contextmenuInput?.enableEventType(e,t)}_addEventHandler(e,t,s,a,u){if(typeof e!="string"){s=t;for(const[E,C]of Object.entries(e))this._addEventHandler(E,C,s,a,u);return}const{manager:p,events:o}=this;if(!p)return;let T=o.get(e);if(!T){const E=this._getRecognizerName(e)||e;T=new zI(this,E),o.set(e,T),p&&p.on(e,T.handleEvent)}T.add(e,t,s,a,u),T.isEmpty()||this._toggleRecognizer(T.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(const[u,p]of Object.entries(e))this._removeEventHandler(u,p);return}const{events:s}=this,a=s.get(e);if(a&&(a.remove(e,t),a.isEmpty())){const{recognizerName:u}=a;let p=!1;for(const o of s.values())if(o.recognizerName===u&&!o.isEmpty()){p=!0;break}p||this._toggleRecognizer(u,!1)}}_getRecognizerName(e){return this.manager.recognizers.find(t=>t.getEventNames().includes(e))?.options.event}}const pr={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(pr,"IDENTITY",{get:()=>(kr.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const En={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Hh={common:0,meters:1,pixels:2},Bg={click:"onClick",dblclick:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},Ub={multipan:[Ob,{threshold:10,direction:Ci.Vertical,pointers:2}],pinch:[vI,{},null,["multipan"]],pan:[Ob,{threshold:1},["pinch"],["multipan"]],dblclick:[Db,{event:"dblclick",taps:2}],click:[Db,{event:"click"},null,["dblclick"]]};function jI(r,e){if(r===e)return!0;if(Array.isArray(r)){const t=r.length;if(!e||e.length!==t)return!1;for(let s=0;s<t;s++)if(r[s]!==e[s])return!1;return!0}return!1}function ru(r){let e={},t;return s=>{for(const a in s)if(!jI(s[a],e[a])){t=r(s),e=s;break}return t}}const Vb=[0,0,0,0],$I=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],u0=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],WI=[0,0,0],d0=[0,0,0],HI=ru(qI);function f0(r,e,t=d0){t.length<3&&(t=[t[0],t[1],0]);let s=t,a,u=!0;switch(e===pr.LNGLAT_OFFSETS||e===pr.METER_OFFSETS?a=t:a=r.isGeospatial?[Math.fround(r.longitude),Math.fround(r.latitude),0]:null,r.projectionMode){case En.WEB_MERCATOR:(e===pr.LNGLAT||e===pr.CARTESIAN)&&(a=[0,0,0],u=!1);break;case En.WEB_MERCATOR_AUTO_OFFSET:e===pr.LNGLAT?s=a:e===pr.CARTESIAN&&(s=[Math.fround(r.center[0]),Math.fround(r.center[1]),0],a=r.unprojectPosition(s),s[0]-=t[0],s[1]-=t[1],s[2]-=t[2]);break;case En.IDENTITY:s=r.position.map(Math.fround),s[2]=s[2]||0;break;case En.GLOBE:u=!1,a=null;break;default:u=!1}return{geospatialOrigin:a,shaderCoordinateOrigin:s,offsetMode:u}}function ZI(r,e,t){const{viewMatrixUncentered:s,projectionMatrix:a}=r;let{viewMatrix:u,viewProjectionMatrix:p}=r,o=Vb,T=Vb,E=r.cameraPosition;const{geospatialOrigin:C,shaderCoordinateOrigin:O,offsetMode:$}=f0(r,e,t);return $&&(T=r.projectPosition(C||O),E=[E[0]-T[0],E[1]-T[1],E[2]-T[2]],T[3]=1,o=uc([],T,p),u=s||u,p=Da([],a,u),p=Da([],p,$I)),{viewMatrix:u,viewProjectionMatrix:p,projectionCenter:o,originCommon:T,cameraPosCommon:E,shaderCoordinateOrigin:O,geospatialOrigin:C}}function XI({viewport:r,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:s=pr.DEFAULT,coordinateOrigin:a=d0,autoWrapLongitude:u=!1}){s===pr.DEFAULT&&(s=r.isGeospatial?pr.LNGLAT:pr.CARTESIAN);const p=HI({viewport:r,devicePixelRatio:e,coordinateSystem:s,coordinateOrigin:a});return p.wrapLongitude=u,p.modelMatrix=t||u0,p}function qI({viewport:r,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:s}){const{projectionCenter:a,viewProjectionMatrix:u,originCommon:p,cameraPosCommon:o,shaderCoordinateOrigin:T,geospatialOrigin:E}=ZI(r,t,s),C=r.getDistanceScales(),O=[r.width*e,r.height*e],$=uc([],[0,0,-r.focalDistance,1],r.projectionMatrix)[3]||1,V={coordinateSystem:t,projectionMode:r.projectionMode,coordinateOrigin:T,commonOrigin:p.slice(0,3),center:a,pseudoMeters:!!r._pseudoMeters,viewportSize:O,devicePixelRatio:e,focalDistance:$,commonUnitsPerMeter:C.unitsPerMeter,commonUnitsPerWorldUnit:C.unitsPerMeter,commonUnitsPerWorldUnit2:WI,scale:r.scale,wrapLongitude:!1,viewProjectionMatrix:u,modelMatrix:u0,cameraPosition:o};if(E){const ie=r.getDistanceScales(E);switch(t){case pr.METER_OFFSETS:V.commonUnitsPerWorldUnit=ie.unitsPerMeter,V.commonUnitsPerWorldUnit2=ie.unitsPerMeter2;break;case pr.LNGLAT:case pr.LNGLAT_OFFSETS:r._pseudoMeters||(V.commonUnitsPerMeter=ie.unitsPerMeter),V.commonUnitsPerWorldUnit=ie.unitsPerDegree,V.commonUnitsPerWorldUnit2=ie.unitsPerDegree2;break;case pr.CARTESIAN:V.commonUnitsPerWorldUnit=[1,1,ie.unitsPerMeter[2]],V.commonUnitsPerWorldUnit2=[0,0,ie.unitsPerMeter2[2]];break}}return V}const YI=Object.keys(pr).map(r=>`const COORDINATE_SYSTEM_${r}: i32 = ${pr[r]};`).join(""),GI=Object.keys(En).map(r=>`const PROJECTION_MODE_${r}: i32 = ${En[r]};`).join(""),KI=Object.keys(Hh).map(r=>`const UNIT_${r.toUpperCase()}: i32 = ${Hh[r]};`).join(""),JI=`${YI}
${GI}
${KI}

const TILE_SIZE: f32 = 512.0;
const PI: f32 = 3.1415926536;
const WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);
const ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);
const EARTH_RADIUS: f32 = 6370972.0; // meters
const GLOBE_RADIUS: f32 = 256.0;

// -----------------------------------------------------------------------------
// Uniform block (converted from GLSL uniform block)
// -----------------------------------------------------------------------------
struct ProjectUniforms {
  wrapLongitude: i32,
  coordinateSystem: i32,
  commonUnitsPerMeter: vec3<f32>,
  projectionMode: i32,
  scale: f32,
  commonUnitsPerWorldUnit: vec3<f32>,
  commonUnitsPerWorldUnit2: vec3<f32>,
  center: vec4<f32>,
  modelMatrix: mat4x4<f32>,
  viewProjectionMatrix: mat4x4<f32>,
  viewportSize: vec2<f32>,
  devicePixelRatio: f32,
  focalDistance: f32,
  cameraPosition: vec3<f32>,
  coordinateOrigin: vec3<f32>,
  commonOrigin: vec3<f32>,
  pseudoMeters: i32,
};

@group(0) @binding(0)
var<uniform> project: ProjectUniforms;

// -----------------------------------------------------------------------------
// Geometry data
// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,
// you might supply this via vertex attributes or a uniform. Here we define a
// uniform struct for demonstration.)
// -----------------------------------------------------------------------------

// Structure to carry additional geometry data used by deck.gl filters.
struct Geometry {
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  position: vec4<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

// @group(0) @binding(1)
var<private> geometry: Geometry;
`,QI=`${JI}

// -----------------------------------------------------------------------------
// Functions
// -----------------------------------------------------------------------------

// Returns an adjustment factor for commonUnitsPerMeter
fn _project_size_at_latitude(lat: f32) -> f32 {
  let y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

// Overloaded version: scales a value in meters at a given latitude.
fn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);
}

// Computes a non-linear scale factor based on geometry.
// (Note: This function relies on "geometry" being provided.)
fn project_size() -> f32 {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
      project.pseudoMeters == 0) {
    if (geometry.position.w == 0.0) {
      return _project_size_at_latitude(geometry.worldPosition.y);
    }
    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    let y2 = y * y;
    let y4 = y2 * y2;
    let y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

// Overloads to scale offsets (meters to world units)
fn project_size_float(meters: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * project_size();
}

fn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

fn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {
  return meters * project.commonUnitsPerMeter * project_size();
}

fn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {
  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Returns a rotation matrix aligning the z‑axis with the given up vector.
fn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {
  let uz = normalize(up);
  let ux = select(
    vec3<f32>(1.0, 0.0, 0.0),
    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),
    abs(uz.z) == 1.0
  );
  let uy = cross(uz, ux);
  return mat3x3<f32>(ux, uy, uz);
}

// Since WGSL does not support "out" parameters, we return a struct.
struct RotationResult {
  needsRotation: bool,
  transform: mat3x3<f32>,
};

fn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    return RotationResult(true, project_get_orientation_matrix(commonPosition));
  } else {
    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed
  };
}

// Projects a normal vector from the current coordinate system to world space.
fn project_normal(vector: vec3<f32>) -> vec3<f32> {
  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);
  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  let rotResult = project_needs_rotation(geometry.position.xyz);
  if (rotResult.needsRotation) {
    n = rotResult.transform * n;
  }
  return n;
}

// Applies a scale offset based on y-offset (dy)
fn project_offset_(offset: vec4<f32>) -> vec4<f32> {
  let dy: f32 = offset.y;
  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

// Projects lng/lat coordinates to a unit tile [0,1]
fn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {
  var x = lnglat.x;
  if (project.wrapLongitude != 0) {
    x = ((x + 180.0) % 360.0) - 180.0;
  }
  let y = clamp(lnglat.y, -89.9, 89.9);
  return vec2<f32>(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// Projects lng/lat/z coordinates for a globe projection.
fn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {
  let lambda = radians(lnglatz.x);
  let phi = radians(lnglatz.y);
  let cosPhi = cos(phi);
  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
  return vec3<f32>(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

// Projects positions (with an optional 64-bit low part) from the input
// coordinate system to the common space.
fn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {
  var position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug:
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_mercator_(position_world.xy),
        _project_size_at_latitude_m(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        return vec4<f32>(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size_float(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);
  }

  return project_offset_(position_world) +
         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));
}

// Overloaded versions for different input types.
fn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {
  return project_position_vec4_f64(position, ZERO_64_LOW);
}

fn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);
  return projected_position.xyz;
}

fn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

fn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

// Transforms a common space position to clip space.
fn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {
  return viewProjectionMatrix * position + center;
}

// Uses the project viewProjectionMatrix and center.
fn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {
  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset corresponding to a given number of screen pixels.
fn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {
  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

fn project_meter_size_to_pixel(meters: f32) -> f32 {
  return project_size_float(meters) * project.scale;
}

fn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {
  if (unit == UNIT_METERS) {
    return project_meter_size_to_pixel(size);
  } else if (unit == UNIT_COMMON) {
    return size * project.scale;
  }
  // UNIT_PIXELS: no scaling applied.
  return size;
}

fn project_pixel_size_float(pixels: f32) -> f32 {
  return pixels / project.scale;
}

fn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {
  return pixels / project.scale;
}
`,eC=Object.keys(pr).map(r=>`const int COORDINATE_SYSTEM_${r} = ${pr[r]};`).join(""),tC=Object.keys(En).map(r=>`const int PROJECTION_MODE_${r} = ${En[r]};`).join(""),rC=Object.keys(Hh).map(r=>`const int UNIT_${r.toUpperCase()} = ${Hh[r]};`).join(""),iC=`${eC}
${tC}
${rC}
uniform projectUniforms {
bool wrapLongitude;
int coordinateSystem;
vec3 commonUnitsPerMeter;
int projectionMode;
float scale;
vec3 commonUnitsPerWorldUnit;
vec3 commonUnitsPerWorldUnit2;
vec4 center;
mat4 modelMatrix;
mat4 viewProjectionMatrix;
vec2 viewportSize;
float devicePixelRatio;
float focalDistance;
vec3 cameraPosition;
vec3 coordinateOrigin;
vec3 commonOrigin;
bool pseudoMeters;
} project;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project.pseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project.commonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project.commonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project.commonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project.wrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project.modelMatrix * position;
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project.coordinateOrigin;
}
}
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project.commonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project.coordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
return offset * project.focalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project.scale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project.scale;
}
`,nC={};function sC(r=nC){return"viewport"in r?XI(r):{}}const Sm={name:"project",dependencies:[C3,n0],source:QI,vs:iC,getUniforms:sC,uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},oC=`// Define a structure to hold both the clip-space position and the common position.
struct ProjectResult {
  clipPosition: vec4<f32>,
  commonPosition: vec4<f32>,
};

// This function mimics the GLSL version with the 'out' parameter by returning both values.
fn project_position_to_clipspace_and_commonspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> ProjectResult {
  // Compute the projected position.
  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);

  // Start with the provided offset.
  var finalOffset: vec3<f32> = offset;

  // Get whether a rotation is needed and the rotation matrix.
  let rotationResult = project_needs_rotation(projectedPosition);

  // If rotation is needed, update the offset.
  if (rotationResult.needsRotation) {
    finalOffset = rotationResult.transform * offset;
  }

  // Compute the common position.
  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);

  // Convert to clip-space.
  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);

  return ProjectResult(clipPosition, commonPosition);
}

// A convenience overload that returns only the clip-space position.
fn project_position_to_clipspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> vec4<f32> {
  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;
}
`,aC=`vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,lC={name:"project32",dependencies:[Sm],source:oC,vs:aC};function cC(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function tc(r,e){const t=uc([],e,r);return Qx(t,t,1/t[3]),t}function jb(r,e){const t=r%e;return t<0?e+t:t}function Lg(r,e,t){return r<e?e:r>t?t:r}function hC(r){return Math.log(r)*Math.LOG2E}const Am=Math.log2||hC;function Hs(r,e){if(!r)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const es=Math.PI,p0=es/4,Bn=es/180,Ng=180/es,ac=512,nf=4003e4,ko=85.051129,uC=1.5;function dC(r){return Am(r)}function Zh(r){const[e,t]=r;Hs(Number.isFinite(e)),Hs(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");const s=e*Bn,a=t*Bn,u=ac*(s+es)/(2*es),p=ac*(es+Math.log(Math.tan(p0+a*.5)))/(2*es);return[u,p]}function lc(r){const[e,t]=r,s=e/ac*(2*es)-es,a=2*(Math.atan(Math.exp(t/ac*(2*es)-es))-p0);return[s*Ng,a*Ng]}function fC(r){const{latitude:e}=r;Hs(Number.isFinite(e));const t=Math.cos(e*Bn);return dC(nf*t)-9}function Nd(r){const e=Math.cos(r*Bn);return ac/nf/e}function zg(r){const{latitude:e,longitude:t,highPrecision:s=!1}=r;Hs(Number.isFinite(e)&&Number.isFinite(t));const a=ac,u=Math.cos(e*Bn),p=a/360,o=p/u,T=a/nf/u,E={unitsPerMeter:[T,T,T],metersPerUnit:[1/T,1/T,1/T],unitsPerDegree:[p,o,T],degreesPerUnit:[1/p,1/o,1/T]};if(s){const C=Bn*Math.tan(e*Bn)/u,O=p*C/2,$=a/nf*C,V=$/o*T;E.unitsPerDegree2=[0,O,$],E.unitsPerMeter2=[V,0,V]}return E}function g0(r,e){const[t,s,a]=r,[u,p,o]=e,{unitsPerMeter:T,unitsPerMeter2:E}=zg({longitude:t,latitude:s,highPrecision:!0}),C=Zh(r);C[0]+=u*(T[0]+E[0]*p),C[1]+=p*(T[1]+E[1]*p);const O=lc(C),$=(a||0)+(o||0);return Number.isFinite(a)||Number.isFinite(o)?[O[0],O[1],$]:O}function pC(r){const{height:e,pitch:t,bearing:s,altitude:a,scale:u,center:p}=r,o=cC();tf(o,o,[0,0,-a]),Kx(o,o,-t*Bn),Jx(o,o,s*Bn);const T=u/e;return Tm(o,o,[T,T,T]),p&&tf(o,o,qE([],p)),o}function gC(r){const{width:e,height:t,altitude:s,pitch:a=0,offset:u,center:p,scale:o,nearZMultiplier:T=1,farZMultiplier:E=1}=r;let{fovy:C=Xh(uC)}=r;s!==void 0&&(C=Xh(s));const O=C*Bn,$=a*Bn,V=Em(C);let ie=V;p&&(ie+=p[2]*o/Math.cos($)/t);const we=O*(.5+(u?u[1]:0)/t),Pe=Math.sin(we)*ie/Math.sin(Lg(Math.PI/2-$-we,.01,Math.PI-.01)),je=Math.sin($)*Pe+ie,Ze=ie*10,Le=Math.min(je*E,Ze);return{fov:O,aspect:e/t,focalDistance:V,near:T,far:Le}}function Xh(r){return 2*Math.atan(.5/r)*Ng}function Em(r){return .5/Math.tan(.5*r*Bn)}function m0(r,e){const[t,s,a=0]=r;return Hs(Number.isFinite(t)&&Number.isFinite(s)&&Number.isFinite(a)),tc(e,[t,s,a,1])}function Im(r,e,t=0){const[s,a,u]=r;if(Hs(Number.isFinite(s)&&Number.isFinite(a),"invalid pixel coordinate"),Number.isFinite(u))return tc(e,[s,a,u,1]);const p=tc(e,[s,a,0,1]),o=tc(e,[s,a,1,1]),T=p[2],E=o[2],C=T===E?0:((t||0)-T)/(E-T);return Xx([],p,o,C)}function mC(r){const{width:e,height:t,bounds:s,minExtent:a=0,maxZoom:u=24,offset:p=[0,0]}=r,[[o,T],[E,C]]=s,O=_C(r.padding),$=Zh([o,Lg(C,-ko,ko)]),V=Zh([E,Lg(T,-ko,ko)]),ie=[Math.max(Math.abs(V[0]-$[0]),a),Math.max(Math.abs(V[1]-$[1]),a)],we=[e-O.left-O.right-Math.abs(p[0])*2,t-O.top-O.bottom-Math.abs(p[1])*2];Hs(we[0]>0&&we[1]>0);const Pe=we[0]/ie[0],je=we[1]/ie[1],Ze=(O.right-O.left)/2/Pe,Le=(O.top-O.bottom)/2/je,Ue=[(V[0]+$[0])/2+Ze,(V[1]+$[1])/2+Le],et=lc(Ue),Ke=Math.min(u,Am(Math.abs(Math.min(Pe,je))));return Hs(Number.isFinite(Ke)),{longitude:et[0],latitude:et[1],zoom:Ke}}function _C(r=0){return typeof r=="number"?{top:r,bottom:r,left:r,right:r}:(Hs(Number.isFinite(r.top)&&Number.isFinite(r.bottom)&&Number.isFinite(r.left)&&Number.isFinite(r.right)),r)}const $b=Math.PI/180;function yC(r,e=0){const{width:t,height:s,unproject:a}=r,u={targetZ:e},p=a([0,s],u),o=a([t,s],u);let T,E;const C=r.fovy?.5*r.fovy*$b:Math.atan(.5/r.altitude),O=(90-r.pitch)*$b;return C>O-.01?(T=Wb(r,0,e),E=Wb(r,t,e)):(T=a([0,0],u),E=a([t,0],u)),[p,o,E,T]}function Wb(r,e,t){const{pixelUnprojectionMatrix:s}=r,a=tc(s,[e,0,1,1]),u=tc(s,[e,r.height,1,1]),o=(t*r.distanceScales.unitsPerMeter[2]-a[2])/(u[2]-a[2]),T=Xx([],a,u,o),E=lc(T);return E.push(t),E}const Hb=512;function bC(r){const{width:e,height:t,pitch:s=0}=r;let{longitude:a,latitude:u,zoom:p,bearing:o=0}=r;(a<-180||a>180)&&(a=jb(a+180,360)-180),(o<-180||o>180)&&(o=jb(o+180,360)-180);const T=Am(t/Hb);if(p<=T)p=T,u=0;else{const E=t/2/Math.pow(2,p),C=lc([0,E])[1];if(u<C)u=C;else{const O=lc([0,Hb-E])[1];u>O&&(u=O)}}return{width:e,height:t,longitude:a,latitude:u,zoom:p,pitch:s,bearing:o}}const _0=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,vC=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,xC=`
${_0}
${vC}
`,wC=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,TC=`
${_0}
${wC}
`,SC=ru(PC),AC=ru(MC),EC=[0,0,0,1],IC=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function CC(r,e){const[t,s,a]=r,u=Im([t,s,a],e);return Number.isFinite(a)?u:[u[0],u[1],0]}function PC({viewport:r,center:e}){return new rs(r.viewProjectionMatrix).invert().transform(e)}function MC({viewport:r,shadowMatrices:e}){const t=[],s=r.pixelUnprojectionMatrix,a=r.isGeospatial?void 0:1,u=[[0,0,a],[r.width,0,a],[0,r.height,a],[r.width,r.height,a],[0,0,-1],[r.width,0,-1],[0,r.height,-1],[r.width,r.height,-1]].map(p=>CC(p,s));for(const p of e){const o=p.clone().translate(new Ss(r.center).negate()),T=u.map(C=>o.transform(C)),E=new rs().ortho({left:Math.min(...T.map(C=>C[0])),right:Math.max(...T.map(C=>C[0])),bottom:Math.min(...T.map(C=>C[1])),top:Math.max(...T.map(C=>C[1])),near:Math.min(...T.map(C=>-C[2])),far:Math.max(...T.map(C=>-C[2]))});t.push(E.multiplyRight(p))}return t}function RC(r){const{shadowEnabled:e=!0,project:t}=r;if(!e||!t||!r.shadowMatrices||!r.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:r.dummyShadowMap,shadow_uShadowMap1:r.dummyShadowMap};const s=Sm.getUniforms(t),a=SC({viewport:t.viewport,center:s.center}),u=[],p=AC({shadowMatrices:r.shadowMatrices,viewport:t.viewport}).slice();for(let T=0;T<r.shadowMatrices.length;T++){const E=p[T],C=E.clone().translate(new Ss(t.viewport.center).negate());s.coordinateSystem===pr.LNGLAT&&s.projectionMode===En.WEB_MERCATOR?(p[T]=C,u[T]=a):(p[T]=E.clone().multiplyRight(IC),u[T]=C.transform(a))}const o={drawShadowMap:!!r.drawToShadowMap,useShadowMap:r.shadowMaps?r.shadowMaps.length>0:!1,color:r.shadowColor||EC,lightId:r.shadowLightId||0,lightCount:r.shadowMatrices.length,shadow_uShadowMap0:r.dummyShadowMap,shadow_uShadowMap1:r.dummyShadowMap};for(let T=0;T<p.length;T++)o[`viewProjectionMatrix${T}`]=p[T],o[`projectCenter${T}`]=u[T];for(let T=0;T<2;T++)o[`shadow_uShadowMap${T}`]=r.shadowMaps&&r.shadowMaps[T]||r.dummyShadowMap;return o}const Zb={name:"shadow",dependencies:[Sm],vs:xC,fs:TC,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:RC,uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},kC={...Tb,defaultUniforms:{...Tb.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},DC=[n0],OC=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],FC=[];function BC(r){const e=Ma.getDefaultShaderAssembler();for(const s of DC)e.addDefaultModule(s);const t=r==="glsl"?OC:FC;for(const s of t)e.addShaderHook(s);return e}const LC=[255,255,255],NC=1;let zC=0;class UC{constructor(e={}){this.type="ambient";const{color:t=LC}=e,{intensity:s=NC}=e;this.id=e.id||`ambient-${zC++}`,this.color=t,this.intensity=s}}const VC=[255,255,255],jC=1,$C=[0,0,-1];let WC=0;class Xb{constructor(e={}){this.type="directional";const{color:t=VC}=e,{intensity:s=jC}=e,{direction:a=$C}=e,{_shadow:u=!1}=e;this.id=e.id||`directional-${WC++}`,this.color=t,this.intensity=s,this.type="directional",this.direction=new Ss(a).normalize().toArray(),this.shadow=u}getProjectedLight(e){return this}}class HC{constructor(e,t={id:"pass"}){const{id:s}=t;this.id=s,this.device=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class Cm extends HC{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[t,s]=this.device.canvasContext.getDrawingBufferSize(),a=e.clearCanvas??!0,u=e.clearColor??(a?[0,0,0,0]:!1),p=a?1:!1,o=a?0:!1,T=e.colorMask??15,E={viewport:[0,0,t,s]};e.colorMask&&(E.colorMask=T),e.scissorRect&&(E.scissorRect=e.scissorRect);const C=this.device.beginRenderPass({framebuffer:e.target,parameters:E,clearColor:u,clearDepth:p,clearStencil:o});try{return this._drawLayers(C,e)}finally{C.end(),this.device.submit()}}_drawLayers(e,t){const{target:s,shaderModuleProps:a,viewports:u,views:p,onViewportActive:o,clearStack:T=!0}=t;t.pass=t.pass||"unknown",T&&(this._lastRenderIndex=-1);const E=[];for(const C of u){const O=p&&p[C.id];o?.(C);const $=this._getDrawLayerParams(C,t),V=C.subViewports||[C];for(const ie of V){const we=this._drawLayersInViewport(e,{target:s,shaderModuleProps:a,viewport:ie,view:O,pass:t.pass,layers:t.layers},$);E.push(we)}}return E}_getDrawLayerParams(e,{layers:t,pass:s,isPicking:a=!1,layerFilter:u,cullRect:p,effects:o,shaderModuleProps:T},E=!1){const C=[],O=y0(this._lastRenderIndex+1),$={layer:t[0],viewport:e,isPicking:a,renderPass:s,cullRect:p},V={};for(let ie=0;ie<t.length;ie++){const we=t[ie],Pe=this._shouldDrawLayer(we,$,u,V),je={shouldDrawLayer:Pe};Pe&&!E&&(je.shouldDrawLayer=!0,je.layerRenderIndex=O(we,Pe),je.shaderModuleProps=this._getShaderModuleProps(we,o,s,T),je.layerParameters={...we.context.deck?.props.parameters,...this.getLayerParameters(we,ie,e)}),C[ie]=je}return C}_drawLayersInViewport(e,{layers:t,shaderModuleProps:s,pass:a,target:u,viewport:p,view:o},T){const E=ZC(this.device,{shaderModuleProps:s,target:u,viewport:p});if(o&&o.props.clear){const O=o.props.clear===!0?{color:!0,depth:!0}:o.props.clear;this.device.beginRenderPass({framebuffer:u,parameters:{viewport:E,scissorRect:E},clearColor:O.color?[0,0,0,0]:!1,clearDepth:O.depth?1:!1}).end()}const C={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:E});for(let O=0;O<t.length;O++){const $=t[O],V=T[O],{shouldDrawLayer:ie}=V;if(ie&&$.props.pickable&&C.pickableCount++,$.isComposite&&C.compositeCount++,$.isDrawable&&V.shouldDrawLayer){const{layerRenderIndex:we,shaderModuleProps:Pe,layerParameters:je}=V;C.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,we),Pe.project&&(Pe.project.viewport=p),$.context.renderPass=e;try{$._drawLayer({renderPass:e,shaderModuleProps:Pe,uniforms:{layerIndex:we},parameters:je})}catch(Ze){$.raiseError(Ze,`drawing ${$} to ${a}`)}}}return C}shouldDrawLayer(e){return!0}getShaderModuleProps(e,t,s){return null}getLayerParameters(e,t,s){return e.props.parameters}_shouldDrawLayer(e,t,s,a){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let p=e.parent;for(;p;){if(!p.props.visible||!p.filterSubLayer(t))return!1;t.layer=p,p=p.parent}if(s){const o=t.layer.id;if(o in a||(a[o]=s(t)),!a[o])return!1}return e.activateViewport(t.viewport),!0}_getShaderModuleProps(e,t,s,a){const u=this.device.canvasContext.cssToDeviceRatio(),p=e.internalState?.propsInTransition||e.props,o={layer:p,picking:{isActive:!1},project:{viewport:e.context.viewport,devicePixelRatio:u,modelMatrix:p.modelMatrix,coordinateSystem:p.coordinateSystem,coordinateOrigin:p.coordinateOrigin,autoWrapLongitude:e.wrapLongitude}};if(t)for(const T of t)qb(o,T.getShaderModuleProps?.(e,o));return qb(o,this.getShaderModuleProps(e,t,o),a)}}function y0(r=0,e={}){const t={},s=(a,u)=>{const p=a.props._offset,o=a.id,T=a.parent&&a.parent.id;let E;if(T&&!(T in e)&&s(a.parent,!1),T in t){const C=t[T]=t[T]||y0(e[T],e);E=C(a,u),t[o]=C}else Number.isFinite(p)?(E=p+(e[T]||0),t[o]=null):E=r;return u&&E>=r&&(r=E+1),e[o]=E,E};return s}function ZC(r,{shaderModuleProps:e,target:t,viewport:s}){const a=e?.project?.devicePixelRatio??r.canvasContext.cssToDeviceRatio(),[,u]=r.canvasContext.getDrawingBufferSize(),p=t?t.height:u,o=s;return[o.x*a,p-(o.y+o.height)*a,o.width*a,o.height*a]}function qb(r,...e){for(const t of e)if(t)for(const s in t)r[s]?Object.assign(r[s],t[s]):r[s]=t[s];return r}class XC extends Cm{constructor(e,t){super(e,t);const s=e.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},mipmaps:!0}),a=e.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1});this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[s],depthStencilAttachment:a})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(e){const t=this.fbo,s=this.device.canvasContext.cssToDeviceRatio(),a=e.viewports[0],u=a.width*s,p=a.height*s,o=[1,1,1,1];(u!==t.width||p!==t.height)&&t.resize({width:u,height:p}),super.render({...e,clearColor:o,target:t,pass:"shadow"})}getLayerParameters(e,t,s){return{...e.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getShaderModuleProps(e,t,s){return{shadow:{project:s.project,drawToShadowMap:!0}}}}const qC={color:[255,255,255],intensity:1},Yb=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],YC=[0,0,0,200/255];class b0{constructor(e={}){this.id="lighting-effect",this.shadowColor=YC,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;const{device:t,deck:s}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(t),s._addDefaultShaderModule(Zb),this.dummyShadowMap=t.createTexture({width:1,height:1}))}setProps(e){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(const t in e){const s=e[t];switch(s.type){case"ambient":this.ambientLight=s;break;case"directional":this.directionalLights.push(s);break;case"point":this.pointLights.push(s);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:t,viewports:s,onViewportActive:a,views:u}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let p=0;p<this.shadowPasses.length;p++)this.shadowPasses[p].render({layers:e,layerFilter:t,viewports:s,onViewportActive:a,views:u,shaderModuleProps:{shadow:{shadowLightId:p,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(e,t){const s=this.shadow?{project:t.project,shadowMaps:this.shadowPasses.map(p=>p.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},a={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(p=>p.getProjectedLight({layer:e})),pointLights:this.pointLights.map(p=>p.getProjectedLight({layer:e}))},u=e.props.material;return{shadow:s,lighting:a,phongMaterial:u,gouraudMaterial:u}}cleanup(e){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(Zb))}_calculateMatrices(){const e=[];for(const t of this.directionalLights){const s=new rs().lookAt({eye:new Ss(t.direction).negate()});e.push(s)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){const s=new XC(e);this.shadowPasses[t]=s}}_applyDefaultLights(){const{ambientLight:e,pointLights:t,directionalLights:s}=this;!e&&t.length===0&&s.length===0&&(this.ambientLight=new UC(qC),this.directionalLights.push(new Xb(Yb[0]),new Xb(Yb[1])))}}class GC{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:s=1,type:a,padding:u=0,copy:p=!1,initialize:o=!1,maxCount:T}){const E=a||e&&e.constructor||Float32Array,C=t*s+u;if(ArrayBuffer.isView(e)){if(C<=e.length)return e;if(C*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new E(e.buffer,0,C)}let O=1/0;T&&(O=T*s+u);const $=this._allocate(E,C,o,O);return e&&p?$.set(e):o||$.fill(0,0,4),this._release(e),$}release(e){this._release(e)}_allocate(e,t,s,a){let u=Math.max(Math.ceil(t*this.opts.overAlloc),1);u>a&&(u=a);const p=this._pool,o=e.BYTES_PER_ELEMENT*u,T=p.findIndex(E=>E.byteLength>=o);if(T>=0){const E=new e(p.splice(T,1)[0],0,u);return s&&E.fill(0),E}return new e(u)}_release(e){if(!ArrayBuffer.isView(e))return;const t=this._pool,{buffer:s}=e,{byteLength:a}=s,u=t.findIndex(p=>p.byteLength>=a);u<0?t.push(s):(u>0||t.length<this.opts.poolSize)&&t.splice(u,0,s),t.length>this.opts.poolSize&&t.shift()}}const qh=new GC;function Rh(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function KC(r,e){const t=r%e;return t<0?e+t:t}function JC(r){return[r[12],r[13],r[14]]}function QC(r){return{left:Wl(r[3]+r[0],r[7]+r[4],r[11]+r[8],r[15]+r[12]),right:Wl(r[3]-r[0],r[7]-r[4],r[11]-r[8],r[15]-r[12]),bottom:Wl(r[3]+r[1],r[7]+r[5],r[11]+r[9],r[15]+r[13]),top:Wl(r[3]-r[1],r[7]-r[5],r[11]-r[9],r[15]-r[13]),near:Wl(r[3]+r[2],r[7]+r[6],r[11]+r[10],r[15]+r[14]),far:Wl(r[3]-r[2],r[7]-r[6],r[11]-r[10],r[15]-r[14])}}const Gb=new Ss;function Wl(r,e,t,s){Gb.set(r,e,t);const a=Gb.len();return{distance:s/a,normal:new Ss(-r/a,-e/a,-t/a)}}function eP(r){return r-Math.fround(r)}let Eh;function ng(r,e){const{size:t=1,startIndex:s=0}=e,a=e.endIndex!==void 0?e.endIndex:r.length,u=(a-s)/t;Eh=qh.allocate(Eh,u,{type:Float32Array,size:t*2});let p=s,o=0;for(;p<a;){for(let T=0;T<t;T++){const E=r[p++];Eh[o+T]=E,Eh[o+T+t]=eP(E)}o+=t*2}return Eh.subarray(0,u*t*2)}function tP(r){let e=null,t=!1;for(const s of r)s&&(e?(t||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],t=!0),e[0][0]=Math.min(e[0][0],s[0][0]),e[0][1]=Math.min(e[0][1],s[0][1]),e[1][0]=Math.max(e[1][0],s[1][0]),e[1][1]=Math.max(e[1][1],s[1][1])):e=s);return e}const rP=Math.PI/180,iP=Rh(),Kb=[0,0,0],nP={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function sP({width:r,height:e,orthographic:t,fovyRadians:s,focalDistance:a,padding:u,near:p,far:o}){const T=r/e,E=t?new rs().orthographic({fovy:s,aspect:T,focalDistance:a,near:p,far:o}):new rs().perspective({fovy:s,aspect:T,near:p,far:o});if(u){const{left:C=0,right:O=0,top:$=0,bottom:V=0}=u,ie=Ts((C+r-O)/2,0,r)-r/2,we=Ts(($+e-V)/2,0,e)-e/2;E[8]-=ie*2/r,E[9]+=we*2/e}return E}class dc{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||nP,this.focalDistance=e.focalDistance||1,this.position=e.position||Kb,this.modelMatrix=e.modelMatrix||null;const{longitude:t,latitude:s}=e;this.isGeospatial=Number.isFinite(s)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?En.WEB_MERCATOR:En.WEB_MERCATOR_AUTO_OFFSET:En.IDENTITY}equals(e){return e instanceof dc?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&$h(e.projectionMatrix,this.projectionMatrix)&&$h(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){const s=this.projectPosition(e),a=m0(s,this.pixelProjectionMatrix),[u,p]=a,o=t?p:this.height-p;return e.length===2?[u,o]:[u,o,a[2]]}unproject(e,{topLeft:t=!0,targetZ:s}={}){const[a,u,p]=e,o=t?u:this.height-u,T=s&&s*this.distanceScales.unitsPerMeter[2],E=Im([a,o,p],this.pixelUnprojectionMatrix,T),[C,O,$]=this.unprojectPosition(E);return Number.isFinite(p)?[C,O,$]:Number.isFinite(s)?[C,O,s]:[C,O]}projectPosition(e){const[t,s]=this.projectFlat(e),a=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,s,a]}unprojectPosition(e){const[t,s]=this.unprojectFlat(e),a=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,s,a]}projectFlat(e){if(this.isGeospatial){const t=Zh(e);return t[1]=Ts(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?lc(e):e}getBounds(e={}){const t={targetZ:e.z||0},s=this.unproject([0,0],t),a=this.unproject([this.width,0],t),u=this.unproject([0,this.height],t),p=this.unproject([this.width,this.height],t);return[Math.min(s[0],a[0],u[0],p[0]),Math.min(s[1],a[1],u[1],p[1]),Math.max(s[0],a[0],u[0],p[0]),Math.max(s[1],a[1],u[1],p[1])]}getDistanceScales(e){return e&&this.isGeospatial?zg({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:s=1,height:a=1}){return e<this.x+this.width&&this.x<e+s&&t<this.y+this.height&&this.y<t+a}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,QC(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){const t=e.longitude,s=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=fC({latitude:s})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||zg({latitude:s,longitude:t}));const a=Math.pow(2,this.zoom);this.scale=a;const{position:u,modelMatrix:p}=e;let o=Kb;if(u&&(o=p?new rs(p).transformAsVector(u,[]):u),this.isGeospatial){const T=this.projectPosition([t,s,0]);this.center=new Ss(o).scale(this.distanceScales.unitsPerMeter).add(T)}else this.center=this.projectPosition(o)}_initMatrices(e){const{viewMatrix:t=iP,projectionMatrix:s=null,orthographic:a=!1,fovyRadians:u,fovy:p=75,near:o=.1,far:T=1e3,padding:E=null,focalDistance:C=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new rs().multiplyRight(t).translate(new Ss(this.center).negate()),this.projectionMatrix=s||sP({width:this.width,height:this.height,orthographic:a,fovyRadians:u||p*rP,focalDistance:C,padding:E,near:o,far:T});const O=Rh();Da(O,O,this.projectionMatrix),Da(O,O,this.viewMatrix),this.viewProjectionMatrix=O,this.viewMatrixInverse=Mg([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=JC(this.viewMatrixInverse);const $=Rh(),V=Rh();Tm($,$,[this.width/2,-this.height/2,1]),tf($,$,[1,-1,0]),Da(V,$,this.viewProjectionMatrix),this.pixelProjectionMatrix=V,this.pixelUnprojectionMatrix=Mg(Rh(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||kr.warn("Pixel project matrix not invertible")()}}dc.displayName="Viewport";class za extends dc{constructor(e={}){const{latitude:t=0,longitude:s=0,zoom:a=0,pitch:u=0,bearing:p=0,nearZMultiplier:o=.1,farZMultiplier:T=1.01,nearZ:E,farZ:C,orthographic:O=!1,projectionMatrix:$,repeat:V=!1,worldOffset:ie=0,position:we,padding:Pe,legacyMeterSizes:je=!1}=e;let{width:Ze,height:Le,altitude:Ue=1.5}=e;const et=Math.pow(2,a);Ze=Ze||1,Le=Le||1;let Ke,ct=null;if($)Ue=$[5]/2,Ke=Xh(Ue);else{e.fovy?(Ke=e.fovy,Ue=Em(Ke)):Ke=Xh(Ue);let _e;if(Pe){const{top:ze=0,bottom:Qe=0}=Pe;_e=[0,Ts((ze+Le-Qe)/2,0,Le)-Le/2]}ct=gC({width:Ze,height:Le,scale:et,center:we&&[0,0,we[2]*Nd(t)],offset:_e,pitch:u,fovy:Ke,nearZMultiplier:o,farZMultiplier:T}),Number.isFinite(E)&&(ct.near=E),Number.isFinite(C)&&(ct.far=C)}let me=pC({height:Le,pitch:u,bearing:p,scale:et,altitude:Ue});ie&&(me=new rs().translate([512*ie,0,0]).multiplyLeft(me)),super({...e,width:Ze,height:Le,viewMatrix:me,longitude:s,latitude:t,zoom:a,...ct,fovy:Ke,focalDistance:Ue}),this.latitude=t,this.longitude=s,this.zoom=a,this.pitch=u,this.bearing=p,this.altitude=Ue,this.fovy=Ke,this.orthographic=O,this._subViewports=V?[]:null,this._pseudoMeters=je,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),t=Math.floor((e[0]+180)/360),s=Math.ceil((e[2]-180)/360);for(let a=t;a<=s;a++){const u=a?new za({...this,worldOffset:a}):this;this._subViewports.push(u)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[t,s]=this.projectFlat(e),a=(e[2]||0)*Nd(e[1]);return[t,s,a]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[t,s]=this.unprojectFlat(e),a=(e[2]||0)/Nd(s);return[t,s,a]}addMetersToLngLat(e,t){return g0(e,t)}panByPosition(e,t){const s=Im(t,this.pixelUnprojectionMatrix),a=this.projectFlat(e),u=xb([],a,UE([],s)),p=xb([],this.center,u),[o,T]=this.unprojectFlat(p);return{longitude:o,latitude:T}}getBounds(e={}){const t=yC(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){const{width:s,height:a}=this,{longitude:u,latitude:p,zoom:o}=mC({width:s,height:a,bounds:e,...t});return new za({width:s,height:a,longitude:u,latitude:p,zoom:o})}}za.displayName="WebMercatorViewport";const Jb=[0,0,0];function sg(r,e,t=!1){const s=e.projectPosition(r);if(t&&e instanceof za){const[a,u,p=0]=r,o=e.getDistanceScales([a,u]);s[2]=p*o.unitsPerMeter[2]}return s}function oP(r){const{viewport:e,modelMatrix:t,coordinateOrigin:s}=r;let{coordinateSystem:a,fromCoordinateSystem:u,fromCoordinateOrigin:p}=r;return a===pr.DEFAULT&&(a=e.isGeospatial?pr.LNGLAT:pr.CARTESIAN),u===void 0&&(u=a),p===void 0&&(p=s),{viewport:e,coordinateSystem:a,coordinateOrigin:s,modelMatrix:t,fromCoordinateSystem:u,fromCoordinateOrigin:p}}function v0(r,{viewport:e,modelMatrix:t,coordinateSystem:s,coordinateOrigin:a,offsetMode:u}){let[p,o,T=0]=r;switch(t&&([p,o,T]=uc([],[p,o,T,1],t)),s){case pr.LNGLAT:return sg([p,o,T],e,u);case pr.LNGLAT_OFFSETS:return sg([p+a[0],o+a[1],T+(a[2]||0)],e,u);case pr.METER_OFFSETS:return sg(g0(a,[p,o,T]),e,u);case pr.CARTESIAN:default:return e.isGeospatial?[p+a[0],o+a[1],T+a[2]]:e.projectPosition([p,o,T])}}function aP(r,e){const{viewport:t,coordinateSystem:s,coordinateOrigin:a,modelMatrix:u,fromCoordinateSystem:p,fromCoordinateOrigin:o}=oP(e),{autoOffset:T=!0}=e,{geospatialOrigin:E=Jb,shaderCoordinateOrigin:C=Jb,offsetMode:O=!1}=T?f0(t,s,a):{},$=v0(r,{viewport:t,modelMatrix:u,coordinateSystem:p,coordinateOrigin:o,offsetMode:O});if(O){const V=t.projectPosition(E||C);Gx($,$,V)}return $}let lP=1,cP=1;class x0{time=0;channels=new Map;animations=new Map;playing=!1;lastEngineTime=-1;constructor(){}addChannel(e){const{delay:t=0,duration:s=Number.POSITIVE_INFINITY,rate:a=1,repeat:u=1}=e,p=lP++,o={time:0,delay:t,duration:s,rate:a,repeat:u};return this._setChannelTime(o,this.time),this.channels.set(p,o),p}removeChannel(e){this.channels.delete(e);for(const[t,s]of this.animations)s.channel===e&&this.detachAnimation(t)}isFinished(e){const t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;const t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);const t=this.channels.values();for(const a of t)this._setChannelTime(a,this.time);const s=this.animations.values();for(const a of s){const{animation:u,channel:p}=a;u.setTime(this.getTime(p))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){const s=cP++;return this.animations.set(s,{animation:e,channel:t}),e.setTime(this.getTime(t)),s}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){const s=t-e.delay,a=e.duration*e.repeat;s>=a?e.time=e.duration*e.rate:(e.time=Math.max(0,s)%e.duration,e.time*=e.rate)}}function hP(r){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(r):setTimeout(r,1e3/60)}function uP(r){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(r):clearTimeout(r)}let dP=0;const fP={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:r=>console.error(r),stats:Eg.stats.get(`animation-loop-${dP++}`),useDevicePixels:!0,autoResizeViewport:!1,autoResizeDrawingBuffer:!1};class pP{device=null;canvas=null;props;animationProps=null;timeline=null;stats;cpuTime;gpuTime;frameRate;display;needsRedraw="initialized";_initialized=!1;_running=!1;_animationFrameId=null;_nextFramePromise=null;_resolveNextFrame=null;_cpuStartTime=0;_error=null;constructor(e){if(this.props={...fP,...e},e=this.props,!e.device)throw new Error("No device provided");const{useDevicePixels:t=!0}=this.props;this.stats=e.stats||new cf({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport,autoResizeDrawingBuffer:e.autoResizeDrawingBuffer,useDevicePixels:t}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}setError(e){if(this.props.onError(e),this._error=Error(),this.device?.canvasContext?.canvas instanceof HTMLCanvasElement){const s=document.createElement("h1");s.innerHTML=e.message,s.style.position="absolute",s.style.top="20%",s.style.left="10px",s.style.color="black",s.style.backgroundColor="red",document.body.appendChild(s)}}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),"autoResizeDrawingBuffer"in e&&(this.props.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer||!1),"useDevicePixels"in e&&(this.props.useDevicePixels=e.useDevicePixels||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(e!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(e){const t=e instanceof Error?e:new Error("Unknown error");throw this.props.onError(t),t}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){return this.device?.isLost||this._error?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){this._running&&(this._animationFrameId=hP(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(uP(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){if(this.display){this.display._renderFrame(e);return}this.props.onRender(this._getAnimationProps()),this.device?.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_initializeAnimationProps(){const e=this.device?.canvasContext?.canvas;if(!this.device||!e)throw new Error("loop");this.animationProps={animationLoop:this,device:this.device,canvas:e,timeline:this.timeline,useDevicePixels:this.props.useDevicePixels,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:e,height:t,aspect:s}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),s!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=s,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=this.device.canvasContext?.canvas||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(t);const s=this.props.onAddHTML(t);s&&(t.innerHTML=s)}}_getSizeAndAspect(){if(!this.device)return{width:1,height:1,aspect:1};const[e,t]=this.device?.canvasContext?.getPixelSize()||[1,1];let s=1;const a=this.device?.canvasContext?.canvas;return a&&a.clientHeight?s=a.clientWidth/a.clientHeight:e>0&&t>0&&(s=e/t),{width:e,height:t,aspect:s}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.props.autoResizeDrawingBuffer&&this.device?.canvasContext?.resize({useDevicePixels:this.props.useDevicePixels})}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}const og={};function mf(r="id"){og[r]=og[r]||1;const e=og[r]++;return`${r}-${e}`}class Qb{id;userData={};topology;bufferLayout=[];vertexCount;indices;attributes;constructor(e){if(this.id=e.id||mf("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&!(this.indices.usage&Ur.INDEX))throw new Error("Index buffer must have INDEX usage")}destroy(){this.indices?.destroy();for(const e of Object.values(this.attributes))e.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(e){return e.byteLength/12}}function gP(r,e){if(e instanceof Qb)return e;const t=mP(r,e),{attributes:s,bufferLayout:a}=_P(r,e);return new Qb({topology:e.topology||"triangle-list",bufferLayout:a,vertexCount:e.vertexCount,indices:t,attributes:s})}function mP(r,e){if(!e.indices)return;const t=e.indices.value;return r.createBuffer({usage:Ur.INDEX,data:t})}function _P(r,e){const t=[],s={};for(const[u,p]of Object.entries(e.attributes)){let o=u;switch(u){case"POSITION":o="positions";break;case"NORMAL":o="normals";break;case"TEXCOORD_0":o="texCoords";break;case"COLOR_0":o="colors";break}if(p){s[o]=r.createBuffer({data:p.value,id:`${u}-buffer`});const{value:T,size:E,normalized:C}=p;t.push({name:o,format:eE(T,E,C)})}}const a=e._calculateVertexCount(e.attributes,e.indices);return{attributes:s,bufferLayout:t,vertexCount:a}}class Pm{static defaultProps={...ic.defaultProps};static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new Pm(e),e._lumaData.defaultPipelineFactory}device;destroyPolicy;_hashCounter=0;_hashes={};_renderPipelineCache={};_computePipelineCache={};constructor(e){this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}createRenderPipeline(e){const t={...ic.defaultProps,...e},s=this._hashRenderPipeline(t);if(!this._renderPipelineCache[s]){const a=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:void 0});a.hash=s,this._renderPipelineCache[s]={pipeline:a,useCount:0}}return this._renderPipelineCache[s].useCount++,this._renderPipelineCache[s].pipeline}createComputePipeline(e){const t={...Xd.defaultProps,...e},s=this._hashComputePipeline(t);if(!this._computePipelineCache[s]){const a=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0});a.hash=s,this._computePipelineCache[s]={pipeline:a,useCount:0}}return this._computePipelineCache[s].useCount++,this._computePipelineCache[s].pipeline}release(e){const t=e.hash,s=e instanceof Xd?this._computePipelineCache:this._renderPipelineCache;s[t].useCount--,s[t].useCount===0&&this.destroyPolicy==="unused"&&(s[t].pipeline.destroy(),delete s[t])}_hashComputePipeline(e){return`${this._getHash(e.shader.source)}`}_hashRenderPipeline(e){const t=e.vs?this._getHash(e.vs.source):0,s=e.fs?this._getHash(e.fs.source):0,a="-",u=this._getHash(JSON.stringify(e.bufferLayout));switch(this.device.type){case"webgl":return`${t}/${s}V${a}BL${u}`;default:const p=this._getHash(JSON.stringify(e.parameters));return`${t}/${s}V${a}T${e.topology}P${p}BL${u}`}}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}}class Mm{static defaultProps={...ff.defaultProps};static getDefaultShaderFactory(e){return e._lumaData.defaultShaderFactory||=new Mm(e),e._lumaData.defaultShaderFactory}device;destroyPolicy;_cache={};constructor(e){this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}createShader(e){const t=this._hashShader(e);let s=this._cache[t];if(!s){const a=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=s={shader:a,useCount:0}}return s.useCount++,s.shader}release(e){const t=this._hashShader(e),s=this._cache[t];s&&(s.useCount--,s.useCount===0&&this.destroyPolicy==="unused"&&(delete this._cache[t],s.shader.destroy()))}_hashShader(e){return`${e.stage}:${e.source}`}}function yP(r,e){const t={},s="Values";if(r.attributes.length===0&&!r.varyings?.length)return{"No attributes or varyings":{[s]:"N/A"}};for(const a of r.attributes)if(a){const u=`${a.location} ${a.name}: ${a.type}`;t[`in ${u}`]={[s]:a.stepMode||"vertex"}}for(const a of r.varyings||[]){const u=`${a.location} ${a.name}`;t[`out ${u}`]={[s]:JSON.stringify(a)}}return t}let Li=null,ag=null;function bP(r,{id:e,minimap:t,opaque:s,top:a="0",left:u="0",rgbaScale:p=1}){Li||(Li=document.createElement("canvas"),Li.id=e,Li.title=e,Li.style.zIndex="100",Li.style.position="absolute",Li.style.top=a,Li.style.left=u,Li.style.border="blue 5px solid",Li.style.transform="scaleY(-1)",document.body.appendChild(Li),ag=Li.getContext("2d")),(Li.width!==r.width||Li.height!==r.height)&&(Li.width=r.width/2,Li.height=r.height/2,Li.style.width="400px",Li.style.height="400px");const o=r.device.readPixelsToArrayWebGL(r),T=ag?.createImageData(r.width,r.height);if(T){for(let C=0;C<o.length;C+=4)T.data[0+C+0]=o[C+0]*p,T.data[0+C+1]=o[C+1]*p,T.data[0+C+2]=o[C+2]*p,T.data[0+C+3]=s?255:o[C+3]*p;ag?.putImageData(T,0,0)}}function Ug(r,e,t){if(r===e)return!0;if(!t||!r||!e)return!1;if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;for(let s=0;s<r.length;s++)if(!Ug(r[s],e[s],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof r=="object"&&typeof e=="object"){const s=Object.keys(r),a=Object.keys(e);if(s.length!==a.length)return!1;for(const u of s)if(!e.hasOwnProperty(u)||!Ug(r[u],e[u],t-1))return!1;return!0}return!1}function vP(r){return ArrayBuffer.isView(r)&&!(r instanceof DataView)}function xP(r){return Array.isArray(r)?r.length===0||typeof r[0]=="number":!1}function w0(r){return vP(r)||xP(r)}function wP(r){return w0(r)||typeof r=="number"||typeof r=="boolean"}function T0(r){const e={bindings:{},uniforms:{}};return Object.keys(r).forEach(t=>{const s=r[t];wP(s)?e.uniforms[t]=s:e.bindings[t]=s}),e}class TP{options={disableWarnings:!1};modules;moduleUniforms;moduleBindings;constructor(e,t){Object.assign(this.options,t);const s=om(Object.values(e).filter(a=>a.dependencies));for(const a of s)e[a.name]=a;ot.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={};for(const[a,u]of Object.entries(e))this._addModule(u),u.name&&a!==u.name&&!this.options.disableWarnings&&ot.warn(`Module name: ${a} vs ${u.name}`)()}destroy(){}setProps(e){for(const t of Object.keys(e)){const s=t,a=e[s]||{},u=this.modules[s];if(!u){this.options.disableWarnings||ot.warn(`Module ${t} not found`)();continue}const p=this.moduleUniforms[s],o=this.moduleBindings[s],T=u.getUniforms?.(a,p)||a,{uniforms:E,bindings:C}=T0(T);this.moduleUniforms[s]={...p,...E},this.moduleBindings[s]={...o,...C}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){const e={};for(const t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){const e={};for(const[t,s]of Object.entries(this.moduleUniforms))for(const[a,u]of Object.entries(s))e[`${t}.${a}`]={type:this.modules[t].uniformTypes?.[a],value:String(u)};return e}_addModule(e){const t=e.name;this.moduleUniforms[t]=e.defaultUniforms||{},this.moduleBindings[t]={}}}let SP="";async function AP(r,e){const t=new Image;return t.crossOrigin="anonymous",t.src=r.startsWith("http")?r:SP+r,await t.decode(),e?await createImageBitmap(t,e):await createImageBitmap(t)}class lg{device;id;texture;sampler;view;ready;isReady=!1;destroyed=!1;resolveReady=()=>{};rejectReady=()=>{};get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}constructor(e,t){this.device=e,this.id=t.id||mf("async-texture"),typeof t?.data=="string"&&t.dimension==="2d"&&(t={...t,data:AP(t.data)}),this.ready=new Promise((s,a)=>{this.resolveReady=()=>{this.isReady=!0,s()},this.rejectReady=a}),this.initAsync(t)}async initAsync(e){const t=e.data;let s;try{s=await S0(t)}catch(u){this.rejectReady(u)}if(this.destroyed)return;const a={...e,data:s};this.texture=this.device.createTexture(a),this.sampler=this.texture.sampler,this.view=this.texture.view,this.isReady=!0,this.resolveReady()}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}resize(e){if(!this.isReady)throw new Error("Cannot resize texture before it is ready");if(e.width===this.texture.width&&e.height===this.texture.height)return!1;if(this.texture){const t=this.texture;this.texture=t.clone(e),t.destroy()}return!0}}async function S0(r){if(r=await r,Array.isArray(r))return await Promise.all(r.map(S0));if(r&&typeof r=="object"&&r.constructor===Object){const e=r,t=await Promise.all(Object.values(e)),s=Object.keys(e),a={};for(let u=0;u<s.length;u++)a[s[u]]=t[u];return a}return r}const Ia=2,EP=1e4;class Yh{static defaultProps={...ic.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:Ma.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0};device;id;source;vs;fs;pipelineFactory;shaderFactory;userData={};parameters;topology;bufferLayout;isInstanced=void 0;instanceCount=0;vertexCount;indexBuffer=null;bufferAttributes={};constantAttributes={};bindings={};uniforms={};vertexArray;transformFeedback=null;pipeline;shaderInputs;_uniformStore;_attributeInfos={};_gpuGeometry=null;_getModuleUniforms;props;_pipelineNeedsUpdate="newly created";_needsRedraw="initializing";_destroyed=!1;_lastDrawTimestamp=-1;get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}constructor(e,t){this.props={...Yh.defaultProps,...t},t=this.props,this.id=t.id||mf("model"),this.device=e,Object.assign(this.userData,t.userData);const s=Object.fromEntries(this.props.modules?.map(T=>[T.name,T])||[]),a=t.shaderInputs||new TP(s,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(a);const u=CP(e),p=(this.props.modules?.length>0?this.props.modules:this.shaderInputs?.getModules())||[];if(this.device.type==="webgpu"&&this.props.source){const{source:T,getUniforms:E}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:u,...this.props,modules:p});this.source=T,this._getModuleUniforms=E,this.props.shaderLayout||=ME(this.source)}else{const{vs:T,fs:E,getUniforms:C}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:u,...this.props,modules:p});this.vs=T,this.fs=E,this._getModuleUniforms=C}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,t.geometry&&this.setGeometry(t.geometry),this.pipelineFactory=t.pipelineFactory||Pm.getDefaultPipelineFactory(this.device),this.shaderFactory=t.shaderFactory||Mm.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in t&&(this.isInstanced=t.isInstanced),t.instanceCount&&this.setInstanceCount(t.instanceCount),t.vertexCount&&this.setVertexCount(t.vertexCount),t.indexBuffer&&this.setIndexBuffer(t.indexBuffer),t.attributes&&this.setAttributes(t.attributes),t.constantAttributes&&this.setConstantAttributes(t.constantAttributes),t.bindings&&this.setBindings(t.bindings),t.uniforms&&this.setUniformsWebGL(t.uniforms),t.moduleSettings&&this.updateModuleSettingsWebGL(t.moduleSettings),t.transformFeedback&&(this.transformFeedback=t.transformFeedback),Object.seal(this)}destroy(){this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),this._gpuGeometry?.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||=e}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){const t=this._areBindingsLoading();if(t)return ot.info(Ia,`>>> DRAWING ABORTED ${this.id}: ${t} not loaded`)(),!1;try{e.pushDebugGroup(`${this}.predraw(${e})`),this.predraw()}finally{e.popDebugGroup()}let s;try{e.pushDebugGroup(`${this}.draw(${e})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();const a=this._getBindings();this.pipeline.setBindings(a,{disableWarnings:this.props.disableWarnings}),Vg(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);const{indexBuffer:u}=this.vertexArray,p=u?u.byteLength/(u.indexType==="uint32"?4:2):void 0;s=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:p,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{e.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(e),s?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",s}setGeometry(e){this._gpuGeometry?.destroy();const t=e&&gP(this.device,e);if(t){this.setTopology(t.topology||"triangle-list");const s=new Xp(this.bufferLayout);this.bufferLayout=s.mergeBufferLayouts(t.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(t)}this._gpuGeometry=t}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){const t=new Xp(this.bufferLayout);this.bufferLayout=this._gpuGeometry?t.mergeBufferLayouts(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){Ug(e,this.parameters,2)||(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,this.isInstanced===void 0&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){this.shaderInputs=e,this._uniformStore=new QA(this.shaderInputs.modules);for(const[t,s]of Object.entries(this.shaderInputs.modules))if(IP(s)){const a=this._uniformStore.getManagedUniformBuffer(this.device,t);this.bindings[`${t}Uniforms`]=a}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){const s=t?.disableWarnings??this.props.disableWarnings;e.indices&&ot.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)(),this.bufferLayout=tE(this.pipeline.shaderLayout,this.bufferLayout);const a=new Xp(this.bufferLayout);for(const[u,p]of Object.entries(e)){const o=a.getBufferLayout(u);if(!o){s||ot.warn(`Model(${this.id}): Missing layout for buffer "${u}".`)();continue}const T=a.getAttributeNamesForBuffer(o);let E=!1;for(const C of T){const O=this._attributeInfos[C];if(O){const $=this.device.type==="webgpu"?a.getBufferIndex(O.bufferName):O.location;this.vertexArray.setBuffer($,p),E=!0}}!E&&!s&&ot.warn(`Model(${this.id}): Ignoring buffer "${p.id}" for unknown attribute "${u}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(const[s,a]of Object.entries(e)){const u=this._attributeInfos[s];u?this.vertexArray.setConstantWebGL(u.location,a):(t?.disableWarnings??this.props.disableWarnings)||ot.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${s}"`)()}this.setNeedsRedraw("constants")}setUniforms(e){this.setUniformsWebGL(e)}setUniformsWebGL(e){Vg(e)||(this.pipeline.setUniformsWebGL(e),Object.assign(this.uniforms,e)),this.setNeedsRedraw("uniforms")}updateModuleSettingsWebGL(e){const{bindings:t,uniforms:s}=T0(this._getModuleUniforms(e));Object.assign(this.bindings,t),Object.assign(this.uniforms,s),this.setNeedsRedraw("moduleSettings")}_areBindingsLoading(){for(const e of Object.values(this.bindings))if(e instanceof lg&&!e.isReady)return e.id;return!1}_getBindings(){const e={};for(const[t,s]of Object.entries(this.bindings))s instanceof lg?s.isReady&&(e[t]=s.texture):e[t]=s;return e}_getBindingsUpdateTimestamp(){let e=0;for(const t of Object.values(this.bindings))t instanceof df?e=Math.max(e,t.texture.updateTimestamp):t instanceof Ur||t instanceof Cr?e=Math.max(e,t.updateTimestamp):t instanceof lg?e=t.texture?Math.max(e,t.texture.updateTimestamp):1/0:t instanceof Vh||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){const t={...e.attributes};for(const[s]of Object.entries(t))!this.pipeline.shaderLayout.attributes.find(a=>a.name===s)&&s!=="positions"&&delete t[s];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||=e,this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(ot.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const s=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders});let a=null;this.source?a=s:this.fs&&(a=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:s,fs:a}),this._attributeInfos=xx(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_lastLogTime=0;_logOpen=!1;_logDrawCallStart(){const e=ot.level>3?0:EP;ot.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,ot.group(Ia,`>>> DRAWING MODEL ${this.id}`,{collapsed:ot.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const e=yP(this.pipeline.shaderLayout,this.id);ot.table(Ia,e)();const t=this.shaderInputs.getDebugTable();for(const[a,u]of Object.entries(this.uniforms))t[a]={value:u};ot.table(Ia,t)();const s=this._getAttributeDebugTable();ot.table(Ia,this._attributeInfos)(),ot.table(Ia,s)(),ot.groupEnd(Ia)(),this._logOpen=!1}}_drawCount=0;_logFramebuffer(e){const t=this.device.props.debugFramebuffers;if(this._drawCount++,!t)return;const s=e.props.framebuffer;s&&bP(s,{id:s.id,minimap:!0})}_getAttributeDebugTable(){const e={};for(const[t,s]of Object.entries(this._attributeInfos)){const a=this.vertexArray.attributes[s.location];e[s.location]={name:t,type:s.shaderType,values:a?this._getBufferOrConstantValues(a,s.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){const{indexBuffer:t}=this.vertexArray,s=t.indexType==="uint32"?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:s.toString()}}return e}_getBufferOrConstantValues(e,t){const s=Sx(t);return(e instanceof Ur?new s(e.debugData):e).toString()}}function IP(r){return!!(r.uniformTypes&&!Vg(r.uniformTypes))}function CP(r){return{type:r.type,shaderLanguage:r.info.shadingLanguage,shaderLanguageVersion:r.info.shadingLanguageVersion,gpu:r.info.gpu,features:r.features}}function Vg(r){for(const e in r)return!1;return!0}class cc{device;model;transformFeedback;static defaultProps={...Yh.defaultProps,outputs:void 0,feedbackBuffers:void 0};static isSupported(e){return e?.info?.type==="webgl"}constructor(e,t=cc.defaultProps){if(!cc.isSupported(e))throw new Error("BufferTransform not yet implemented on WebGPU");this.device=e,this.model=new Yh(this.device,{id:t.id||"buffer-transform-model",fs:t.fs||rA(),topology:t.topology||"point-list",varyings:t.outputs||t.varyings,...t}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:t.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){e?.inputBuffers&&this.model.setAttributes(e.inputBuffers),e?.outputBuffers&&this.transformFeedback.setBuffers(e.outputBuffers);const t=this.device.beginRenderPass(e);this.model.draw(t),t.end()}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){const t=this.getBuffer(e);if(!t)throw new Error("BufferTransform#getBuffer");if(t instanceof Ur)return t.readAsync();const{buffer:s,byteOffset:a=0,byteLength:u=s.byteLength}=t;return s.readAsync(a,u)}}class PP{id;topology;vertexCount;indices;attributes;userData={};constructor(e){const{attributes:t={},indices:s=null,vertexCount:a=null}=e;this.id=e.id||mf("geometry"),this.topology=e.topology,s&&(this.indices=ArrayBuffer.isView(s)?{value:s,size:1}:s),this.attributes={};for(const[u,p]of Object.entries(t)){const o=ArrayBuffer.isView(p)?{value:p}:p;if(!ArrayBuffer.isView(o.value))throw new Error(`${this._print(u)}: must be typed array or object with value as typed array`);if((u==="POSITION"||u==="positions")&&!o.size&&(o.size=3),u==="indices"){if(this.indices)throw new Error("Multiple indices detected");this.indices=o}else this.attributes[u]=o}this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=a||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){return this}_calculateVertexCount(e,t){if(t)return t.value.length;let s=1/0;for(const a of Object.values(e)){const{value:u,size:p,constant:o}=a;!o&&u&&p!==void 0&&p>=1&&(s=Math.min(s,u.length/p))}return s}}const MP={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant-alpha",blendAlphaDstFactor:"zero"};class A0 extends Cm{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:s,viewports:a,onViewportActive:u,pickingFBO:p,deviceRect:{x:o,y:T,width:E,height:C},cullRect:O,effects:$,pass:V="picking",pickZ:ie,shaderModuleProps:we}){this.pickZ=ie;const Pe=this._resetColorEncoder(ie),je=[o,T,E,C],Ze=super.render({target:p,layers:e,layerFilter:t,views:s,viewports:a,onViewportActive:u,cullRect:O,effects:$?.filter(Ue=>Ue.useInPicking),pass:V,isPicking:!0,shaderModuleProps:we,clearColor:[0,0,0,0],colorMask:15,scissorRect:je});return this._colorEncoderState=null,{decodePickingColor:Pe&&kP.bind(null,Pe),stats:Ze}}shouldDrawLayer(e){const{pickable:t,operation:s}=e.props;return t&&s.includes("draw")||s.includes("terrain")||s.includes("mask")}getShaderModuleProps(e,t,s){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(e,t,s){const a={...e.props.parameters},{pickable:u,operation:p}=e.props;return!this._colorEncoderState||p.includes("terrain")?a.blend=!1:u&&p.includes("draw")&&(Object.assign(a,MP),a.blend=!0,a.blendColor=RP(this._colorEncoderState,e,s)),a}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function RP(r,e,t){const{byLayer:s,byAlpha:a}=r;let u,p=s.get(e);return p?(p.viewports.push(t),u=p.a):(u=s.size+1,u<=255?(p={a:u,layer:e,viewports:[t]},s.set(e,p),a[u]=p):(kr.warn("Too many pickable layers, only picking the first 255")(),u=0)),[0,0,0,u/255]}function kP(r,e){const t=r.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}const Zl={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},sf=Symbol.for("component"),Oa=Symbol.for("propTypes"),cg=Symbol.for("deprecatedProps"),rc=Symbol.for("asyncPropDefaults"),Ua=Symbol.for("asyncPropOriginal"),Do=Symbol.for("asyncPropResolved");function Gh(r,e=()=>!0){return Array.isArray(r)?E0(r,e,[]):e(r)?[r]:[]}function E0(r,e,t){let s=-1;for(;++s<r.length;){const a=r[s];Array.isArray(a)?E0(a,e,t):e(a)&&t.push(a)}return t}function DP({target:r,source:e,start:t=0,count:s=1}){const a=e.length,u=s*a;let p=0;for(let o=t;p<a;p++)r[o++]=e[p];for(;p<u;)p<u-p?(r.copyWithin(t+p,t,t+p),p*=2):(r.copyWithin(t+p,t,t+u-p),p=u);return r}class OP{constructor(e,t,s){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=s,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;const s=++this._loadCount;let a=e;typeof e=="string"&&(a=vg(e)),a instanceof Promise?(this.isLoaded=!1,this._loader=a.then(u=>{this._loadCount===s&&(this.isLoaded=!0,this._error=void 0,this._content=u)}).catch(u=>{this._loadCount===s&&(this.isLoaded=!0,this._error=u||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const u of this._subscribers)u.onChange(this.getData())}}class FP{constructor(e){this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:e.device?.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:s=!1,persistent:a=!0}){let u=this._resources[e];u?u.setData(t,s):(u=new OP(e,t,this._context),this._resources[e]=u),u.persistent=a}remove(e){const t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const t=this._consumers[e];if(t){for(const s in t){const a=t[s],u=this._resources[a.resourceId];u&&u.unsubscribe(a)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:s,requestId:a="default"}){const{_resources:u,protocol:p}=this;e.startsWith(p)&&(e=e.replace(p,""),u[e]||this.add({resourceId:e,data:null,persistent:!1}));const o=u[e];if(this._track(s,a,o,t),o)return o.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,t,s,a){const u=this._consumers,p=u[e]=u[e]||{};let o=p[t];const T=o&&o.resourceId&&this._resources[o.resourceId];T&&(T.unsubscribe(o),this.prune()),s&&(o?(o.onChange=a,o.resourceId=s.id):o={onChange:a,resourceId:s.id},p[t]=o,s.subscribe(o))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}}const BP="layerManager.setLayers",LP="layerManager.activateViewport";class NP{constructor(e,t){this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=o=>{cn(LP,this,o),o&&(this.context.viewport=o)};const{deck:s,stats:a,viewport:u,timeline:p}=t||{};this.layers=[],this.resourceManager=new FP({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e?.gl,deck:s,shaderAssembler:BC(e?.info?.shadingLanguage||"glsl"),defaultShaderModules:[W3],renderPass:void 0,stats:a||new cf({id:"deck.gl"}),viewport:u||new dc({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:p||new x0,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const s of this.layers){const a=s.getNeedsRedraw(e);t=t||a}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(s=>t.id.indexOf(s)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){cn(BP,this,t,e),this._lastRenderedLayers=e;const s=Gh(e,Boolean);for(const a of s)a.context=this.context;this._updateLayers(this.layers,s)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){const{defaultShaderModules:t}=this.context;t.find(s=>s.name===e.name)||(t.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){const{defaultShaderModules:t}=this.context,s=t.findIndex(a=>a.name===e.name);s>=0&&(t.splice(s,1),this._defaultShaderModulesChanged=!0)}_handleError(e,t,s){s.raiseError(t,`${e} of ${s}`)}_updateLayers(e,t){const s={};for(const p of e)s[p.id]?kr.warn(`Multiple old layers with same id ${p.id}`)():s[p.id]=p;if(this._defaultShaderModulesChanged){for(const p of e)p.setNeedsUpdate(),p.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const a=[];this._updateSublayersRecursively(t,s,a),this._finalizeOldLayers(s);let u=!1;for(const p of a)if(p.hasUniformTransition()){u=`Uniform transition in ${p}`;break}this._needsUpdate=u,this.layers=a}_updateSublayersRecursively(e,t,s){for(const a of e){a.context=this.context;const u=t[a.id];u===null&&kr.warn(`Multiple new layers with same id ${a.id}`)(),t[a.id]=null;let p=null;try{this._debug&&u!==a&&a.validateProps(),u?(this._transferLayerState(u,a),this._updateLayer(a)):this._initializeLayer(a),s.push(a),p=a.isComposite?a.getSubLayers():null}catch(o){this._handleError("matching",o,a)}p&&this._updateSublayersRecursively(p,t,s)}}_finalizeOldLayers(e){for(const t in e){const s=e[t];s&&this._finalizeLayer(s)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=Zl.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=Zl.MATCHED,t!==e&&(e.lifecycle=Zl.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle=Zl.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=Zl.FINALIZED}catch(t){this._handleError("finalization",t,e)}}}function ts(r,e,t){if(r===e)return!0;if(!t||!r||!e)return!1;if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;for(let s=0;s<r.length;s++)if(!ts(r[s],e[s],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof r=="object"&&typeof e=="object"){const s=Object.keys(r),a=Object.keys(e);if(s.length!==a.length)return!1;for(const u of s)if(!e.hasOwnProperty(u)||!ts(r[u],e[u],t-1))return!1;return!0}return!1}class zP{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){const e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){const t=typeof e=="string"?this.getView(e):e,s=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(s):s}getViewport(e){return this._viewportMap[e]}unproject(e,t){const s=this.getViewports(),a={x:e[0],y:e[1]};for(let u=s.length-1;u>=0;--u){const p=s[u];if(p.containsPixel(a)){const o=e.slice();return o[0]-=p.x,o[1]-=p.y,p.unproject(o,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=Gh(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!ts(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):kr.warn("missing `viewState` or `initialViewState`")()}_createController(e,t){const s=t.type;return new s({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:u=>this.getView(e.id)?.makeViewport({viewState:u,width:this.width,height:this.height})})}_updateController(e,t,s,a){const u=e.controller;if(u&&s){const p={...t,...u,id:e.id,x:s.x,y:s.y,width:s.width,height:s.height};return(!a||a.constructor!==u.type)&&(a=this._createController(e,p)),a&&a.setProps(p),a}return null}_rebuildViewports(){const{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let s=!1;for(let a=e.length;a--;){const u=e[a],p=this.getViewState(u),o=u.makeViewport({viewState:p,width:this.width,height:this.height});let T=t[u.id];const E=!!u.controller;E&&!T&&(s=!0),(s||!E)&&T&&(T.finalize(),T=null),this.controllers[u.id]=this._updateController(u,p,o,T),o&&this._viewports.unshift(o)}for(const a in t){const u=t[a];u&&!this.controllers[a]&&u.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((s,a)=>!e[a].equals(t[a]))}}const UP=/([0-9]+\.?[0-9]*)(%|px)/;function Ao(r){switch(typeof r){case"number":return{position:r,relative:!1};case"string":const e=UP.exec(r);if(e&&e.length>=3){const t=e[2]==="%",s=parseFloat(e[1]);return{position:t?s/100:s,relative:t}}default:throw new Error(`Could not parse position string ${r}`)}}function Eo(r,e){return r.relative?Math.round(r.position*e):r.position}class I0{constructor(e){const{id:t,x:s=0,y:a=0,width:u="100%",height:p="100%",padding:o=null}=e;this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=Ao(s),this._y=Ao(a),this._width=Ao(u),this._height=Ao(p),this._padding=o&&{left:Ao(o.left||0),right:Ao(o.right||0),top:Ao(o.top||0),bottom:Ao(o.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.constructor===e.constructor&&ts(this.props,e.props,2)}makeViewport({width:e,height:t,viewState:s}){s=this.filterViewState(s);const a=this.getDimensions({width:e,height:t});if(!a.height||!a.width)return null;const u=this.getViewportType(s);return new u({...s,...this.props,...a})}getViewStateId(){const{viewState:e}=this.props;return typeof e=="string"?e:e?.id||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const t={...e};for(const s in this.props.viewState)s!=="id"&&(t[s]=this.props.viewState[s]);return t}return e}getDimensions({width:e,height:t}){const s={x:Eo(this._x,e),y:Eo(this._y,t),width:Eo(this._width,e),height:Eo(this._height,t)};return this._padding&&(s.padding={left:Eo(this._padding.left,e),top:Eo(this._padding.top,t),right:Eo(this._padding.right,e),bottom:Eo(this._padding.bottom,t)}),s}get controller(){const e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}}class _f{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){this.cancel(),this.settings=e,this._inProgress=!0,this.settings.onStart?.(this)}end(){this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,this.settings.onEnd?.(this))}cancel(){this._inProgress&&(this.settings.onInterrupt?.(this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:e,settings:t}=this;this._handle=e.addChannel({delay:e.getTime(),duration:t.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),this.settings.onUpdate?.(this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const ev=()=>{},jg={BREAK:1,SNAP_TO_END:2,IGNORE:3},VP=r=>r,jP=jg.BREAK;class $P{constructor(e){this._onTransitionUpdate=t=>{const{time:s,settings:{interpolator:a,startProps:u,endProps:p,duration:o,easing:T}}=t,E=T(s/o),C=a.interpolateProps(u,p,E);this.propsInTransition=this.getControllerState({...this.props,...C}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new _f(e.timeline),this.onViewStateChange=e.onViewStateChange||ev,this.onStateChange=e.onStateChange||ev}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1;const s=this.props;if(this.props=e,!s||this._shouldIgnoreViewportChange(s,e))return!1;if(this._isTransitionEnabled(e)){let a=s;if(this.transition.inProgress){const{interruption:u,endProps:p}=this.transition.settings;a={...s,...u===jg.SNAP_TO_END?p:this.propsInTransition||s}}this._triggerTransition(a,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:t,transitionInterpolator:s}=e;return(t>0||t==="auto")&&!!s}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===jg.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){const s=this.getControllerState(e),a=this.getControllerState(t).shortestPathFrom(s),u=t.transitionInterpolator,p=u.getDuration?u.getDuration(e,t):t.transitionDuration;if(p===0)return;const o=u.initializeProps(e,a);this.propsInTransition={};const T={duration:p,easing:t.transitionEasing||VP,interpolator:u,interruption:t.transitionInterruption||jP,startProps:o.start,endProps:o.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(T),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e?.(t)}}}function Pi(r,e){if(!r)throw new Error(e||"deck.gl: assertion failed.")}class WP{constructor(e){const{compare:t,extract:s,required:a}=e;this._propsToCompare=t,this._propsToExtract=s||t,this._requiredProps=a}arePropsEqual(e,t){for(const s of this._propsToCompare)if(!(s in e)||!(s in t)||!$h(e[s],t[s]))return!1;return!0}initializeProps(e,t){const s={},a={};for(const u of this._propsToExtract)(u in e||u in t)&&(s[u]=e[u],a[u]=t[u]);return this._checkRequiredProps(s),this._checkRequiredProps(a),{start:s,end:a}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(t=>{const s=e[t];Pi(Number.isFinite(s)||Array.isArray(s),`${t} is required for transition`)})}}const HP=["longitude","latitude","zoom","bearing","pitch"],ZP=["longitude","latitude","zoom"];class Rm extends WP{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,s=Array.isArray(e)?{}:e;s.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:HP,required:ZP},super(s.transitionProps),this.opts=s}initializeProps(e,t){const s=super.initializeProps(e,t),{makeViewport:a,around:u}=this.opts;if(a&&u){const p=a(e),o=a(t),T=p.unproject(u);s.start.around=u,Object.assign(s.end,{around:o.project(T),aroundPosition:T,width:t.width,height:t.height})}return s}interpolateProps(e,t,s){const a={};for(const u of this._propsToExtract)a[u]=ef(e[u]||0,t[u]||0,s);if(t.aroundPosition&&this.opts.makeViewport){const u=this.opts.makeViewport({...t,...a});Object.assign(a,u.panByPosition(t.aroundPosition,ef(e.around,t.around,s)))}return a}}const Io={transitionDuration:0},XP=300,Sd=r=>1-(1-r)*(1-r),Hl={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],MULTI_PAN:["multipanstart","multipanmove","multipanend"],DOUBLE_CLICK:["dblclick"],KEYBOARD:["keydown"]},Ca={};class C0{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new $P({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){for(const e in this._events)this._events[e]&&this.eventManager?.off(e,this.handleEvent);this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"multipanstart":return t?!1:this._onMultiPanStart(e);case"multipanmove":return this._onMultiPan(e);case"multipanend":return this._onMultiPanEnd(e);case"dblclick":return this._onDoubleClick(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:t,y:s}=this.props,{offsetCenter:a}=e;return[a.x-t,a.y-s]}isPointInBounds(e,t){const{width:s,height:a}=this.props;if(t&&t.handled)return!1;const u=e[0]>=0&&e[0]<=s&&e[1]>=0&&e[1]<=a;return u&&t&&t.stopPropagation(),u}isFunctionKeyPressed(e){const{srcEvent:t}=e;return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?XP:0;const{scrollZoom:s=!0,dragPan:a=!0,dragRotate:u=!0,doubleClickZoom:p=!0,touchZoom:o=!0,touchRotate:T=!1,keyboard:E=!0}=e,C=!!this.onViewStateChange;this.toggleEvents(Hl.WHEEL,C&&s),this.toggleEvents(Hl.PAN,C),this.toggleEvents(Hl.PINCH,C&&(o||T)),this.toggleEvents(Hl.MULTI_PAN,C&&T),this.toggleEvents(Hl.DOUBLE_CLICK,C&&p),this.toggleEvents(Hl.KEYBOARD,C&&E),this.scrollZoom=s,this.dragPan=a,this.dragRotate=u,this.doubleClickZoom=p,this.touchZoom=o,this.touchRotate=T,this.keyboard=E}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(s=>{this._events[s]!==t&&(this._events[s]=t,t?this.eventManager.on(s,this.handleEvent):this.eventManager.off(s,this.handleEvent))})}updateViewport(e,t=null,s={}){const a={...e.getViewportProps(),...t},u=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(s),u){const p=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:a,interactionState:this._interactionState,oldViewState:p,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let s=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(s=!s);const a=this.controllerState[s?"panStart":"rotateStart"]({pos:t});return this._panMove=s,this.updateViewport(a,Io,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;const t=this.getCenter(e),s=this.controllerState.pan({pos:t});return this.updateViewport(s,Io,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:t}=this;if(this.dragPan&&t&&e.velocity){const s=this.getCenter(e),a=[s[0]+e.velocityX*t/2,s[1]+e.velocityY*t/2],u=this.controllerState.pan({pos:a}).panEnd();this.updateViewport(u,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:Sd},{isDragging:!1,isPanning:!0})}else{const s=this.controllerState.panEnd();this.updateViewport(s,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const t=this.getCenter(e),s=this.controllerState.rotate({pos:t});return this.updateViewport(s,Io,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){const s=this.getCenter(e),a=[s[0]+e.velocityX*t/2,s[1]+e.velocityY*t/2],u=this.controllerState.rotate({pos:a}).rotateEnd();this.updateViewport(u,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:Sd},{isDragging:!1,isRotating:!0})}else{const s=this.controllerState.rotateEnd();this.updateViewport(s,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();const{speed:s=.01,smooth:a=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:u}=e;let p=2/(1+Math.exp(-Math.abs(u*s)));u<0&&p!==0&&(p=1/p);const o=this.controllerState.zoom({pos:t,scale:p});return this.updateViewport(o,{...this._getTransitionProps({around:t}),transitionDuration:a?250:1},{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const s=this.controllerState.rotateStart({pos:t});return this.updateViewport(s,Io,{isDragging:!0}),!0}_onMultiPan(e){if(!this.touchRotate||!this.isDragging())return!1;const t=this.getCenter(e);t[0]-=e.deltaX;const s=this.controllerState.rotate({pos:t});return this.updateViewport(s,Io,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){const s=this.getCenter(e),a=[s[0],s[1]+=e.velocityY*t/2],u=this.controllerState.rotate({pos:a});this.updateViewport(u,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:Sd},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{const s=this.controllerState.rotateEnd();this.updateViewport(s,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const s=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return Ca._startPinchRotation=e.rotation,Ca._lastPinchEvent=e,this.updateViewport(s,Io,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){const{scale:s}=e,a=this.getCenter(e);t=t.zoom({pos:a,scale:s})}if(this.touchRotate){const{rotation:s}=e;t=t.rotate({deltaAngleX:Ca._startPinchRotation-s})}return this.updateViewport(t,Io,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),Ca._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this,{_lastPinchEvent:s}=Ca;if(this.touchZoom&&t&&s&&e.scale!==s.scale){const a=this.getCenter(e);let u=this.controllerState.rotateEnd();const p=Math.log2(e.scale),o=(p-Math.log2(s.scale))/(e.deltaTime-s.deltaTime),T=Math.pow(2,p+o*t/2);u=u.zoom({pos:a,scale:T}).zoomEnd(),this.updateViewport(u,{...this._getTransitionProps({around:a}),transitionDuration:t,transitionEasing:Sd},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{const a=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(a,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return Ca._startPinchRotation=null,Ca._lastPinchEvent=null,!0}_onDoubleClick(e){if(!this.doubleClickZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const s=this.isFunctionKeyPressed(e),a=this.controllerState.zoom({pos:t,scale:s?.5:2});return this.updateViewport(a,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const t=this.isFunctionKeyPressed(e),{zoomSpeed:s,moveSpeed:a,rotateSpeedX:u,rotateSpeedY:p}=this.keyboard===!0?{}:this.keyboard,{controllerState:o}=this;let T;const E={};switch(e.srcEvent.code){case"Minus":T=t?o.zoomOut(s).zoomOut(s):o.zoomOut(s),E.isZooming=!0;break;case"Equal":T=t?o.zoomIn(s).zoomIn(s):o.zoomIn(s),E.isZooming=!0;break;case"ArrowLeft":t?(T=o.rotateLeft(u),E.isRotating=!0):(T=o.moveLeft(a),E.isPanning=!0);break;case"ArrowRight":t?(T=o.rotateRight(u),E.isRotating=!0):(T=o.moveRight(a),E.isPanning=!0);break;case"ArrowUp":t?(T=o.rotateUp(p),E.isRotating=!0):(T=o.moveUp(a),E.isPanning=!0);break;case"ArrowDown":t?(T=o.rotateDown(p),E.isRotating=!0):(T=o.moveDown(a),E.isPanning=!0);break;default:return!1}return this.updateViewport(T,this._getTransitionProps(),E),!0}_getTransitionProps(e){const{transition:t}=this;return!t||!t.transitionInterpolator?Io:e?{...t,transitionInterpolator:new Rm({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}}class qP{constructor(e,t){this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}const tv=5,YP=1.2;class P0 extends qP{constructor(e){const{width:t,height:s,latitude:a,longitude:u,zoom:p,bearing:o=0,pitch:T=0,altitude:E=1.5,position:C=[0,0,0],maxZoom:O=20,minZoom:$=0,maxPitch:V=60,minPitch:ie=0,startPanLngLat:we,startZoomLngLat:Pe,startRotatePos:je,startBearing:Ze,startPitch:Le,startZoom:Ue,normalize:et=!0}=e;Pi(Number.isFinite(u)),Pi(Number.isFinite(a)),Pi(Number.isFinite(p)),super({width:t,height:s,latitude:a,longitude:u,zoom:p,bearing:o,pitch:T,altitude:E,maxZoom:O,minZoom:$,maxPitch:V,minPitch:ie,normalize:et,position:C},{startPanLngLat:we,startZoomLngLat:Pe,startRotatePos:je,startBearing:Ze,startPitch:Le,startZoom:Ue}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){const s=this.getState().startPanLngLat||this._unproject(t);if(!s)return this;const u=this.makeViewport(this.getViewportProps()).panByPosition(s,e);return this._getUpdatedState(u)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:s=0}){const{startRotatePos:a,startBearing:u,startPitch:p}=this.getState();if(!a||u===void 0||p===void 0)return this;let o;return e?o=this._getNewRotation(e,a,p,u):o={bearing:u+t,pitch:p+s},this._getUpdatedState(o)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:s}){let{startZoom:a,startZoomLngLat:u}=this.getState();if(u||(a=this.getViewportProps().zoom,u=this._unproject(t)||this._unproject(e)),!u)return this;const{maxZoom:p,minZoom:o}=this.getViewportProps();let T=a+Math.log2(s);T=Ts(T,o,p);const E=this.makeViewport({...this.getViewportProps(),zoom:T});return this._getUpdatedState({zoom:T,...E.panByPosition(u,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const t=e.getViewportProps(),s={...this.getViewportProps()},{bearing:a,longitude:u}=s;return Math.abs(a-t.bearing)>180&&(s.bearing=a<0?a+360:a-360),Math.abs(u-t.longitude)>180&&(s.longitude=u<0?u+360:u-360),s}applyConstraints(e){const{maxZoom:t,minZoom:s,zoom:a}=e;e.zoom=Ts(a,s,t);const{maxPitch:u,minPitch:p,pitch:o}=e;e.pitch=Ts(o,p,u);const{normalize:T=!0}=e;return T&&Object.assign(e,bC(e)),e}_zoomFromCenter(e){const{width:t,height:s}=this.getViewportProps();return this.zoom({pos:[t/2,s/2],scale:e})}_panFromCenter(e){const{width:t,height:s}=this.getViewportProps();return this.pan({startPos:[t/2,s/2],pos:[t/2+e[0],s/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,s,a){const u=e[0]-t[0],p=e[1]-t[1],o=e[1],T=t[1],{width:E,height:C}=this.getViewportProps(),O=u/E;let $=0;p>0?Math.abs(C-T)>tv&&($=p/(T-C)*YP):p<0&&T>tv&&($=1-o/T),$=Ts($,-1,1);const{minPitch:V,maxPitch:ie}=this.getViewportProps(),we=a+180*O;let Pe=s;return $>0?Pe=s+$*(ie-s):$<0&&(Pe=s-$*(V-s)),{pitch:Pe,bearing:we}}}class GP extends C0{constructor(){super(...arguments),this.ControllerState=P0,this.transition={transitionDuration:300,transitionInterpolator:new Rm({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];const t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class km extends I0{constructor(e={}){super(e)}getViewportType(){return za}get ControllerType(){return GP}}km.displayName="MapView";const KP=new b0;function JP(r,e){const t=r.order??1/0,s=e.order??1/0;return t-s}class QP{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const t=this._defaultEffects;if(!t.find(s=>s.id===e.id)){const s=t.findIndex(a=>JP(a,e)>0);s<0?t.push(e):t.splice(s,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&(ts(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){const t={};for(const a of this.effects)t[a.id]=a;const s=[];for(const a of e){const u=t[a.id];let p=a;u&&u!==a?u.setProps?(u.setProps(a.props),p=u):u.cleanup(this._context):u||a.setup(this._context),s.push(p),delete t[a.id]}for(const a in t)t[a].cleanup(this._context);this.effects=s,this._resolvedEffects=s.concat(this._defaultEffects),e.some(a=>a instanceof b0)||this._resolvedEffects.push(KP),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class eM extends Cm{shouldDrawLayer(e){const{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}const tM="deckRenderer.renderLayers";class rM{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new eM(e),this.pickLayersPass=new A0(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,s={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};s.effects&&this._preRender(s.effects,s);const a=this.lastPostProcessEffect?this.renderBuffers[0]:s.target;this.lastPostProcessEffect&&(s.clearColor=[0,0,0,0],s.clearCanvas=!0);const u=t.render({...s,target:a});s.effects&&this._postRender(s.effects,s),this.renderCount++,cn(tM,this,u,e)}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){const{renderBuffers:e}=this;for(const t of e)t.delete();e.length=0}_preRender(e,t){this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{};for(const s of e)t.preRenderStats[s.id]=s.preRender(t),s.postRender&&(this.lastPostProcessEffect=s.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this,t=this.device.canvasContext.getDrawingBufferSize();e.length===0&&[0,1].map(s=>{const a=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${s}`,colorAttachments:[a]}))});for(const s of e)s.resize(t)}_postRender(e,t){const{renderBuffers:s}=this,a={...t,inputBuffer:s[0],swapBuffer:s[1]};for(const u of e)if(u.postRender){a.target=u.id===this.lastPostProcessEffect?t.target:void 0;const p=u.postRender(a);a.inputBuffer=p,a.swapBuffer=p===s[0]?s[1]:s[0]}}}const iM={pickedColor:null,pickedObjectIndex:-1};function nM({pickedColors:r,decodePickingColor:e,deviceX:t,deviceY:s,deviceRadius:a,deviceRect:u}){const{x:p,y:o,width:T,height:E}=u;let C=a*a,O=-1,$=0;for(let V=0;V<E;V++){const ie=V+o-s,we=ie*ie;if(we>C)$+=4*T;else for(let Pe=0;Pe<T;Pe++){if(r[$+3]-1>=0){const Ze=Pe+p-t,Le=Ze*Ze+we;Le<=C&&(C=Le,O=$)}$+=4}}if(O>=0){const V=r.slice(O,O+4),ie=e(V);if(ie){const we=Math.floor(O/4/T),Pe=O/4-we*T;return{...ie,pickedColor:V,pickedX:p+Pe,pickedY:o+we}}kr.error("Picked non-existent layer. Is picking buffer corrupt?")()}return iM}function sM({pickedColors:r,decodePickingColor:e}){const t=new Map;if(r){for(let s=0;s<r.length;s+=4)if(r[s+3]-1>=0){const u=r.slice(s,s+4),p=u.join(",");if(!t.has(p)){const o=e(u);o?t.set(p,{...o,color:u}):kr.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function M0({pickInfo:r,viewports:e,pixelRatio:t,x:s,y:a,z:u}){let p=e[0];e.length>1&&(p=aM(r?.pickedViewports||e,{x:s,y:a}));let o;if(p){const T=[s-p.x,a-p.y];u!==void 0&&(T[2]=u),o=p.unproject(T)}return{color:null,layer:null,viewport:p,index:-1,picked:!1,x:s,y:a,pixel:[s,a],coordinate:o,devicePixel:r&&"pickedX"in r?[r.pickedX,r.pickedY]:void 0,pixelRatio:t}}function oM(r){const{pickInfo:e,lastPickedInfo:t,mode:s,layers:a}=r,{pickedColor:u,pickedLayer:p,pickedObjectIndex:o}=e,T=p?[p]:[];if(s==="hover"){const O=t.index,$=t.layerId,V=p?p.props.id:null;if(V!==$||o!==O){if(V!==$){const ie=a.find(we=>we.props.id===$);ie&&T.unshift(ie)}t.layerId=V,t.index=o,t.info=null}}const E=M0(r),C=new Map;return C.set(null,E),T.forEach(O=>{let $={...E};O===p&&($.color=u,$.index=o,$.picked=!0),$=R0({layer:O,info:$,mode:s});const V=$.layer;O===p&&s==="hover"&&(t.info=$),C.set(V.id,$),s==="hover"&&V.updateAutoHighlight($)}),C}function R0({layer:r,info:e,mode:t}){for(;r&&e;){const s=e.layer||null;e.sourceLayer=s,e.layer=r,e=r.getPickingInfo({info:e,mode:t,sourceLayer:s}),r=r.parent}return e}function aM(r,e){for(let t=r.length-1;t>=0;t--){const s=r[t];if(s.containsPixel(e))return s}return r[0]}class lM{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new A0(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:s,viewports:a},u=this.lastPickedInfo.info){const p=u&&u.layer&&u.layer.id,o=u&&u.viewport&&u.viewport.id,T=p?s.find($=>$.id===p):null,E=o&&a.find($=>$.id===o)||a[0],C=E&&E.unproject([e-E.x,t-E.y]);return{...u,...{x:e,y:t,viewport:E,coordinate:C,layer:T}}}_resizeBuffer(){if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const t=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=t}const{canvas:e}=this.device.getDefaultCanvasContext();this.pickingFBO?.resize({width:e.width,height:e.height}),this.depthFBO?.resize({width:e.width,height:e.height})}_getPickable(e){if(this._pickable===!1)return null;const t=e.filter(s=>this.pickLayersPass.shouldDrawLayer(s)&&!s.isComposite);return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:s,x:a,y:u,radius:p=0,depth:o=1,mode:T="query",unproject3D:E,onViewportActive:C,effects:O}){const $=this.device.canvasContext.cssToDeviceRatio(),V=this._getPickable(e);if(!V||s.length===0)return{result:[],emptyInfo:M0({viewports:s,x:a,y:u,pixelRatio:$})};this._resizeBuffer();const ie=this.device.canvasContext.cssToDevicePixels([a,u],!0),we=[ie.x+Math.floor(ie.width/2),ie.y+Math.floor(ie.height/2)],Pe=Math.round(p*$),{width:je,height:Ze}=this.pickingFBO,Le=this._getPickingRect({deviceX:we[0],deviceY:we[1],deviceRadius:Pe,deviceWidth:je,deviceHeight:Ze}),Ue={x:a-p,y:u-p,width:p*2+1,height:p*2+1};let et;const Ke=[],ct=new Set;for(let me=0;me<o;me++){let _e;if(Le){const Qe=this._drawAndSample({layers:V,views:t,viewports:s,onViewportActive:C,deviceRect:Le,cullRect:Ue,effects:O,pass:`picking:${T}`});_e=nM({...Qe,deviceX:we[0],deviceY:we[1],deviceRadius:Pe,deviceRect:Le})}else _e={pickedColor:null,pickedObjectIndex:-1};let ze;if(_e.pickedLayer&&E&&this.depthFBO){const{pickedColors:Qe}=this._drawAndSample({layers:[_e.pickedLayer],views:t,viewports:s,onViewportActive:C,deviceRect:{x:_e.pickedX,y:_e.pickedY,width:1,height:1},cullRect:Ue,effects:O,pass:`picking:${T}:z`},!0);Qe[3]&&(ze=Qe[0])}_e.pickedLayer&&me+1<o&&(ct.add(_e.pickedLayer),_e.pickedLayer.disablePickingIndex(_e.pickedObjectIndex)),et=oM({pickInfo:_e,lastPickedInfo:this.lastPickedInfo,mode:T,layers:V,viewports:s,x:a,y:u,z:ze,pixelRatio:$});for(const Qe of et.values())Qe.layer&&Ke.push(Qe);if(!_e.pickedColor)break}for(const me of ct)me.restorePickingColors();return{result:Ke,emptyInfo:et.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:s,x:a,y:u,width:p=1,height:o=1,mode:T="query",maxObjects:E=null,onViewportActive:C,effects:O}){const $=this._getPickable(e);if(!$||s.length===0)return[];this._resizeBuffer();const V=this.device.canvasContext.cssToDeviceRatio(),ie=this.device.canvasContext.cssToDevicePixels([a,u],!0),we=ie.x,Pe=ie.y+ie.height,je=this.device.canvasContext.cssToDevicePixels([a+p,u+o],!0),Ze=je.x+je.width,Le=je.y,Ue={x:we,y:Le,width:Ze-we,height:Pe-Le},et=this._drawAndSample({layers:$,views:t,viewports:s,onViewportActive:C,deviceRect:Ue,cullRect:{x:a,y:u,width:p,height:o},effects:O,pass:`picking:${T}`}),Ke=sM(et),ct=new Map,me=[],_e=Number.isFinite(E);for(let ze=0;ze<Ke.length&&!(_e&&me.length>=E);ze++){const Qe=Ke[ze];let at={color:Qe.pickedColor,layer:null,index:Qe.pickedObjectIndex,picked:!0,x:a,y:u,pixelRatio:V};at=R0({layer:Qe.pickedLayer,info:at,mode:T});const mt=at.layer.id;ct.has(mt)||ct.set(mt,new Set);const At=ct.get(mt),or=at.object??at.index;At.has(or)||(At.add(or),me.push(at))}return me}_drawAndSample({layers:e,views:t,viewports:s,onViewportActive:a,deviceRect:u,cullRect:p,effects:o,pass:T},E=!1){const C=E?this.depthFBO:this.pickingFBO,O={layers:e,layerFilter:this.layerFilter,views:t,viewports:s,onViewportActive:a,pickingFBO:C,deviceRect:u,cullRect:p,effects:o,pass:T,pickZ:E,preRenderStats:{},isPicking:!0};for(const Ze of o)Ze.useInPicking&&(O.preRenderStats[Ze.id]=Ze.preRender(O));const{decodePickingColor:$}=this.pickLayersPass.render(O),{x:V,y:ie,width:we,height:Pe}=u,je=new(E?Float32Array:Uint8Array)(we*Pe*4);return this.device.readPixelsToArrayWebGL(C,{sourceX:V,sourceY:ie,sourceWidth:we,sourceHeight:Pe,target:je}),{pickedColors:je,decodePickingColor:$}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:s,deviceWidth:a,deviceHeight:u}){const p=Math.max(0,e-s),o=Math.max(0,t-s),T=Math.min(a,e+s+1)-p,E=Math.min(u,t+s+1)-o;return T<=0||E<=0?null:{x:p,y:o,width:T,height:E}}}const cM={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},hM="top-left",rv="__root";class uM{constructor({deck:e,parentElement:t}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,this.parentElement=t}getWidgets(){return this.resolvedWidgets}setProps(e){e.widgets&&!ts(e.widgets,this.widgets,1)&&this._setWidgets(e.widgets)}finalize(){for(const e of this.getWidgets())this._remove(e);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const e in this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(t=>t.id===e.id)||(this._add(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}_setWidgets(e){const t={};for(const s of this.resolvedWidgets)t[s.id]=s;this.resolvedWidgets.length=0;for(const s of this.defaultWidgets)t[s.id]=null,this.resolvedWidgets.push(s);for(let s of e){const a=t[s.id];a?a.viewId!==s.viewId||a.placement!==s.placement?(this._remove(a),this._add(s)):s!==a&&(a.setProps(s.props),s=a):this._add(s),t[s.id]=null,this.resolvedWidgets.push(s)}for(const s in t){const a=t[s];a&&this._remove(a)}this.widgets=e}_add(e){const{viewId:t=null,placement:s=hM}=e,a=e.onAdd({deck:this.deck,viewId:t});a&&this._getContainer(t,s).append(a),e._element=a}_remove(e){e.onRemove?.(),e._element&&e._element.remove(),e._element=void 0}_getContainer(e,t){const s=e||rv;let a=this.containers[s];a||(a=document.createElement("div"),a.style.pointerEvents="none",a.style.position="absolute",a.style.overflow="hidden",this.parentElement?.append(a),this.containers[s]=a);let u=a.querySelector(`.${t}`);return u||(u=document.createElement("div"),u.className=t,u.style.position="absolute",u.style.zIndex="2",Object.assign(u.style,cM[t]),a.append(u)),u}_updateContainers(){const e=this.deck.width,t=this.deck.height;for(const s in this.containers){const a=this.lastViewports[s]||null,u=s===rv||a,p=this.containers[s];u?(p.style.display="block",p.style.left=`${a?a.x:0}px`,p.style.top=`${a?a.y:0}px`,p.style.width=`${a?a.width:e}px`,p.style.height=`${a?a.height:t}px`):p.style.display="none"}}onRedraw({viewports:e,layers:t}){const s=e.reduce((a,u)=>(a[u.id]=u,a),{});for(const a of this.getWidgets()){const{viewId:u}=a;if(u){const p=s[u];p&&(a.onViewportChange&&a.onViewportChange(p),a.onRedraw?.({viewports:[p],layers:t}))}else{if(a.onViewportChange)for(const p of e)a.onViewportChange(p);a.onRedraw?.({viewports:e,layers:t})}}this.lastViewports=s,this._updateContainers()}onHover(e,t){for(const s of this.getWidgets()){const{viewId:a}=s;(!a||a===e.viewport?.id)&&s.onHover?.(e,t)}}onEvent(e,t){const s=Bg[t.type];if(s)for(const a of this.getWidgets()){const{viewId:u}=a;(!u||u===e.viewport?.id)&&a[s]?.(e,t)}}}const dM={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class fM{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:e}){const t=document.createElement("div");return t.className="deck-tooltip",Object.assign(t.style,dM),this.deck=e,this.element=t,t}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(e){this.isVisible&&e.id===this.lastViewport?.id&&e!==this.lastViewport&&this.setTooltip(null)}onHover(e){const{deck:t}=this,s=t&&t.props.getTooltip;if(!s)return;const a=s(e);this.lastViewport=e.viewport,this.setTooltip(a,e.x,e.y)}setTooltip(e,t,s){const a=this.element;if(a){if(typeof e=="string")a.innerText=e;else if(e)e.text&&(a.innerText=e.text),e.html&&(a.innerHTML=e.html),e.className&&(a.className=e.className);else{this.isVisible=!1,a.style.display="none";return}this.isVisible=!0,a.style.display="block",a.style.transform=`translate(${t}px, ${s}px)`,e&&typeof e=="object"&&"style"in e&&Object.assign(a.style,e.style)}}}var Yl;(function(r){r[r.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",r[r.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",r[r.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",r[r.POINTS=0]="POINTS",r[r.LINES=1]="LINES",r[r.LINE_LOOP=2]="LINE_LOOP",r[r.LINE_STRIP=3]="LINE_STRIP",r[r.TRIANGLES=4]="TRIANGLES",r[r.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",r[r.TRIANGLE_FAN=6]="TRIANGLE_FAN",r[r.ZERO=0]="ZERO",r[r.ONE=1]="ONE",r[r.SRC_COLOR=768]="SRC_COLOR",r[r.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",r[r.SRC_ALPHA=770]="SRC_ALPHA",r[r.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",r[r.DST_ALPHA=772]="DST_ALPHA",r[r.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",r[r.DST_COLOR=774]="DST_COLOR",r[r.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",r[r.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",r[r.CONSTANT_COLOR=32769]="CONSTANT_COLOR",r[r.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",r[r.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",r[r.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",r[r.FUNC_ADD=32774]="FUNC_ADD",r[r.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",r[r.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",r[r.BLEND_EQUATION=32777]="BLEND_EQUATION",r[r.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",r[r.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",r[r.BLEND_DST_RGB=32968]="BLEND_DST_RGB",r[r.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",r[r.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",r[r.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",r[r.BLEND_COLOR=32773]="BLEND_COLOR",r[r.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",r[r.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",r[r.LINE_WIDTH=2849]="LINE_WIDTH",r[r.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",r[r.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",r[r.CULL_FACE_MODE=2885]="CULL_FACE_MODE",r[r.FRONT_FACE=2886]="FRONT_FACE",r[r.DEPTH_RANGE=2928]="DEPTH_RANGE",r[r.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",r[r.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",r[r.DEPTH_FUNC=2932]="DEPTH_FUNC",r[r.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",r[r.STENCIL_FUNC=2962]="STENCIL_FUNC",r[r.STENCIL_FAIL=2964]="STENCIL_FAIL",r[r.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",r[r.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",r[r.STENCIL_REF=2967]="STENCIL_REF",r[r.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",r[r.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",r[r.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",r[r.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",r[r.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",r[r.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",r[r.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",r[r.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",r[r.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",r[r.VIEWPORT=2978]="VIEWPORT",r[r.SCISSOR_BOX=3088]="SCISSOR_BOX",r[r.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",r[r.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",r[r.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",r[r.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",r[r.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",r[r.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",r[r.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",r[r.RED_BITS=3410]="RED_BITS",r[r.GREEN_BITS=3411]="GREEN_BITS",r[r.BLUE_BITS=3412]="BLUE_BITS",r[r.ALPHA_BITS=3413]="ALPHA_BITS",r[r.DEPTH_BITS=3414]="DEPTH_BITS",r[r.STENCIL_BITS=3415]="STENCIL_BITS",r[r.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",r[r.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",r[r.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",r[r.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",r[r.SAMPLES=32937]="SAMPLES",r[r.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",r[r.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",r[r.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",r[r.VENDOR=7936]="VENDOR",r[r.RENDERER=7937]="RENDERER",r[r.VERSION=7938]="VERSION",r[r.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",r[r.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",r[r.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",r[r.STATIC_DRAW=35044]="STATIC_DRAW",r[r.STREAM_DRAW=35040]="STREAM_DRAW",r[r.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",r[r.ARRAY_BUFFER=34962]="ARRAY_BUFFER",r[r.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",r[r.BUFFER_SIZE=34660]="BUFFER_SIZE",r[r.BUFFER_USAGE=34661]="BUFFER_USAGE",r[r.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",r[r.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",r[r.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",r[r.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",r[r.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",r[r.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",r[r.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",r[r.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",r[r.CULL_FACE=2884]="CULL_FACE",r[r.FRONT=1028]="FRONT",r[r.BACK=1029]="BACK",r[r.FRONT_AND_BACK=1032]="FRONT_AND_BACK",r[r.BLEND=3042]="BLEND",r[r.DEPTH_TEST=2929]="DEPTH_TEST",r[r.DITHER=3024]="DITHER",r[r.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",r[r.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",r[r.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",r[r.SCISSOR_TEST=3089]="SCISSOR_TEST",r[r.STENCIL_TEST=2960]="STENCIL_TEST",r[r.NO_ERROR=0]="NO_ERROR",r[r.INVALID_ENUM=1280]="INVALID_ENUM",r[r.INVALID_VALUE=1281]="INVALID_VALUE",r[r.INVALID_OPERATION=1282]="INVALID_OPERATION",r[r.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",r[r.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",r[r.CW=2304]="CW",r[r.CCW=2305]="CCW",r[r.DONT_CARE=4352]="DONT_CARE",r[r.FASTEST=4353]="FASTEST",r[r.NICEST=4354]="NICEST",r[r.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",r[r.BYTE=5120]="BYTE",r[r.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",r[r.SHORT=5122]="SHORT",r[r.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",r[r.INT=5124]="INT",r[r.UNSIGNED_INT=5125]="UNSIGNED_INT",r[r.FLOAT=5126]="FLOAT",r[r.DOUBLE=5130]="DOUBLE",r[r.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",r[r.ALPHA=6406]="ALPHA",r[r.RGB=6407]="RGB",r[r.RGBA=6408]="RGBA",r[r.LUMINANCE=6409]="LUMINANCE",r[r.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",r[r.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",r[r.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",r[r.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",r[r.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",r[r.VERTEX_SHADER=35633]="VERTEX_SHADER",r[r.COMPILE_STATUS=35713]="COMPILE_STATUS",r[r.DELETE_STATUS=35712]="DELETE_STATUS",r[r.LINK_STATUS=35714]="LINK_STATUS",r[r.VALIDATE_STATUS=35715]="VALIDATE_STATUS",r[r.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",r[r.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",r[r.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",r[r.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",r[r.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",r[r.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",r[r.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",r[r.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",r[r.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",r[r.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",r[r.SHADER_TYPE=35663]="SHADER_TYPE",r[r.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",r[r.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",r[r.NEVER=512]="NEVER",r[r.LESS=513]="LESS",r[r.EQUAL=514]="EQUAL",r[r.LEQUAL=515]="LEQUAL",r[r.GREATER=516]="GREATER",r[r.NOTEQUAL=517]="NOTEQUAL",r[r.GEQUAL=518]="GEQUAL",r[r.ALWAYS=519]="ALWAYS",r[r.KEEP=7680]="KEEP",r[r.REPLACE=7681]="REPLACE",r[r.INCR=7682]="INCR",r[r.DECR=7683]="DECR",r[r.INVERT=5386]="INVERT",r[r.INCR_WRAP=34055]="INCR_WRAP",r[r.DECR_WRAP=34056]="DECR_WRAP",r[r.NEAREST=9728]="NEAREST",r[r.LINEAR=9729]="LINEAR",r[r.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",r[r.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",r[r.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",r[r.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",r[r.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",r[r.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",r[r.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",r[r.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",r[r.TEXTURE_2D=3553]="TEXTURE_2D",r[r.TEXTURE=5890]="TEXTURE",r[r.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",r[r.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",r[r.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",r[r.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",r[r.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",r[r.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",r[r.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",r[r.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",r[r.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",r[r.TEXTURE0=33984]="TEXTURE0",r[r.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",r[r.REPEAT=10497]="REPEAT",r[r.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",r[r.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",r[r.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",r[r.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",r[r.FLOAT_VEC2=35664]="FLOAT_VEC2",r[r.FLOAT_VEC3=35665]="FLOAT_VEC3",r[r.FLOAT_VEC4=35666]="FLOAT_VEC4",r[r.INT_VEC2=35667]="INT_VEC2",r[r.INT_VEC3=35668]="INT_VEC3",r[r.INT_VEC4=35669]="INT_VEC4",r[r.BOOL=35670]="BOOL",r[r.BOOL_VEC2=35671]="BOOL_VEC2",r[r.BOOL_VEC3=35672]="BOOL_VEC3",r[r.BOOL_VEC4=35673]="BOOL_VEC4",r[r.FLOAT_MAT2=35674]="FLOAT_MAT2",r[r.FLOAT_MAT3=35675]="FLOAT_MAT3",r[r.FLOAT_MAT4=35676]="FLOAT_MAT4",r[r.SAMPLER_2D=35678]="SAMPLER_2D",r[r.SAMPLER_CUBE=35680]="SAMPLER_CUBE",r[r.LOW_FLOAT=36336]="LOW_FLOAT",r[r.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",r[r.HIGH_FLOAT=36338]="HIGH_FLOAT",r[r.LOW_INT=36339]="LOW_INT",r[r.MEDIUM_INT=36340]="MEDIUM_INT",r[r.HIGH_INT=36341]="HIGH_INT",r[r.FRAMEBUFFER=36160]="FRAMEBUFFER",r[r.RENDERBUFFER=36161]="RENDERBUFFER",r[r.RGBA4=32854]="RGBA4",r[r.RGB5_A1=32855]="RGB5_A1",r[r.RGB565=36194]="RGB565",r[r.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",r[r.STENCIL_INDEX=6401]="STENCIL_INDEX",r[r.STENCIL_INDEX8=36168]="STENCIL_INDEX8",r[r.DEPTH_STENCIL=34041]="DEPTH_STENCIL",r[r.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",r[r.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",r[r.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",r[r.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",r[r.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",r[r.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",r[r.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",r[r.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",r[r.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",r[r.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",r[r.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",r[r.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",r[r.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",r[r.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",r[r.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",r[r.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",r[r.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",r[r.NONE=0]="NONE",r[r.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",r[r.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",r[r.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",r[r.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",r[r.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",r[r.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",r[r.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",r[r.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",r[r.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",r[r.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",r[r.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",r[r.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",r[r.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",r[r.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",r[r.READ_BUFFER=3074]="READ_BUFFER",r[r.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",r[r.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",r[r.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",r[r.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",r[r.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",r[r.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",r[r.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",r[r.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",r[r.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",r[r.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",r[r.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",r[r.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",r[r.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",r[r.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",r[r.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",r[r.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",r[r.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",r[r.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",r[r.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",r[r.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",r[r.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",r[r.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",r[r.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",r[r.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",r[r.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",r[r.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",r[r.RED=6403]="RED",r[r.RGB8=32849]="RGB8",r[r.RGBA8=32856]="RGBA8",r[r.RGB10_A2=32857]="RGB10_A2",r[r.TEXTURE_3D=32879]="TEXTURE_3D",r[r.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",r[r.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",r[r.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",r[r.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",r[r.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",r[r.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",r[r.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",r[r.SRGB=35904]="SRGB",r[r.SRGB8=35905]="SRGB8",r[r.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",r[r.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",r[r.RGBA32F=34836]="RGBA32F",r[r.RGB32F=34837]="RGB32F",r[r.RGBA16F=34842]="RGBA16F",r[r.RGB16F=34843]="RGB16F",r[r.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",r[r.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",r[r.R11F_G11F_B10F=35898]="R11F_G11F_B10F",r[r.RGB9_E5=35901]="RGB9_E5",r[r.RGBA32UI=36208]="RGBA32UI",r[r.RGB32UI=36209]="RGB32UI",r[r.RGBA16UI=36214]="RGBA16UI",r[r.RGB16UI=36215]="RGB16UI",r[r.RGBA8UI=36220]="RGBA8UI",r[r.RGB8UI=36221]="RGB8UI",r[r.RGBA32I=36226]="RGBA32I",r[r.RGB32I=36227]="RGB32I",r[r.RGBA16I=36232]="RGBA16I",r[r.RGB16I=36233]="RGB16I",r[r.RGBA8I=36238]="RGBA8I",r[r.RGB8I=36239]="RGB8I",r[r.RED_INTEGER=36244]="RED_INTEGER",r[r.RGB_INTEGER=36248]="RGB_INTEGER",r[r.RGBA_INTEGER=36249]="RGBA_INTEGER",r[r.R8=33321]="R8",r[r.RG8=33323]="RG8",r[r.R16F=33325]="R16F",r[r.R32F=33326]="R32F",r[r.RG16F=33327]="RG16F",r[r.RG32F=33328]="RG32F",r[r.R8I=33329]="R8I",r[r.R8UI=33330]="R8UI",r[r.R16I=33331]="R16I",r[r.R16UI=33332]="R16UI",r[r.R32I=33333]="R32I",r[r.R32UI=33334]="R32UI",r[r.RG8I=33335]="RG8I",r[r.RG8UI=33336]="RG8UI",r[r.RG16I=33337]="RG16I",r[r.RG16UI=33338]="RG16UI",r[r.RG32I=33339]="RG32I",r[r.RG32UI=33340]="RG32UI",r[r.R8_SNORM=36756]="R8_SNORM",r[r.RG8_SNORM=36757]="RG8_SNORM",r[r.RGB8_SNORM=36758]="RGB8_SNORM",r[r.RGBA8_SNORM=36759]="RGBA8_SNORM",r[r.RGB10_A2UI=36975]="RGB10_A2UI",r[r.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",r[r.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",r[r.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",r[r.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",r[r.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",r[r.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",r[r.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",r[r.HALF_FLOAT=5131]="HALF_FLOAT",r[r.RG=33319]="RG",r[r.RG_INTEGER=33320]="RG_INTEGER",r[r.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",r[r.CURRENT_QUERY=34917]="CURRENT_QUERY",r[r.QUERY_RESULT=34918]="QUERY_RESULT",r[r.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",r[r.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",r[r.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",r[r.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",r[r.DRAW_BUFFER0=34853]="DRAW_BUFFER0",r[r.DRAW_BUFFER1=34854]="DRAW_BUFFER1",r[r.DRAW_BUFFER2=34855]="DRAW_BUFFER2",r[r.DRAW_BUFFER3=34856]="DRAW_BUFFER3",r[r.DRAW_BUFFER4=34857]="DRAW_BUFFER4",r[r.DRAW_BUFFER5=34858]="DRAW_BUFFER5",r[r.DRAW_BUFFER6=34859]="DRAW_BUFFER6",r[r.DRAW_BUFFER7=34860]="DRAW_BUFFER7",r[r.DRAW_BUFFER8=34861]="DRAW_BUFFER8",r[r.DRAW_BUFFER9=34862]="DRAW_BUFFER9",r[r.DRAW_BUFFER10=34863]="DRAW_BUFFER10",r[r.DRAW_BUFFER11=34864]="DRAW_BUFFER11",r[r.DRAW_BUFFER12=34865]="DRAW_BUFFER12",r[r.DRAW_BUFFER13=34866]="DRAW_BUFFER13",r[r.DRAW_BUFFER14=34867]="DRAW_BUFFER14",r[r.DRAW_BUFFER15=34868]="DRAW_BUFFER15",r[r.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",r[r.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",r[r.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",r[r.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",r[r.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",r[r.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",r[r.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",r[r.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",r[r.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",r[r.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",r[r.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",r[r.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",r[r.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",r[r.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",r[r.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",r[r.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",r[r.SAMPLER_3D=35679]="SAMPLER_3D",r[r.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",r[r.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",r[r.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",r[r.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",r[r.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",r[r.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",r[r.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",r[r.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",r[r.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",r[r.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",r[r.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",r[r.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",r[r.MAX_SAMPLES=36183]="MAX_SAMPLES",r[r.SAMPLER_BINDING=35097]="SAMPLER_BINDING",r[r.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",r[r.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",r[r.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",r[r.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",r[r.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",r[r.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",r[r.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",r[r.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",r[r.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",r[r.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",r[r.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",r[r.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",r[r.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",r[r.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",r[r.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",r[r.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",r[r.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",r[r.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",r[r.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",r[r.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",r[r.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",r[r.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",r[r.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",r[r.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",r[r.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",r[r.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",r[r.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",r[r.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",r[r.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",r[r.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",r[r.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",r[r.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",r[r.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",r[r.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",r[r.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",r[r.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",r[r.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",r[r.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",r[r.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",r[r.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",r[r.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",r[r.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",r[r.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",r[r.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",r[r.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",r[r.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",r[r.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",r[r.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",r[r.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",r[r.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",r[r.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",r[r.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",r[r.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",r[r.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",r[r.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",r[r.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",r[r.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",r[r.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",r[r.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",r[r.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",r[r.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",r[r.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",r[r.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",r[r.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",r[r.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",r[r.UNIFORM_TYPE=35383]="UNIFORM_TYPE",r[r.UNIFORM_SIZE=35384]="UNIFORM_SIZE",r[r.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",r[r.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",r[r.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",r[r.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",r[r.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",r[r.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",r[r.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",r[r.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",r[r.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",r[r.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",r[r.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",r[r.OBJECT_TYPE=37138]="OBJECT_TYPE",r[r.SYNC_CONDITION=37139]="SYNC_CONDITION",r[r.SYNC_STATUS=37140]="SYNC_STATUS",r[r.SYNC_FLAGS=37141]="SYNC_FLAGS",r[r.SYNC_FENCE=37142]="SYNC_FENCE",r[r.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",r[r.UNSIGNALED=37144]="UNSIGNALED",r[r.SIGNALED=37145]="SIGNALED",r[r.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",r[r.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",r[r.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",r[r.WAIT_FAILED=37149]="WAIT_FAILED",r[r.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",r[r.COLOR=6144]="COLOR",r[r.DEPTH=6145]="DEPTH",r[r.STENCIL=6146]="STENCIL",r[r.MIN=32775]="MIN",r[r.MAX=32776]="MAX",r[r.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",r[r.STREAM_READ=35041]="STREAM_READ",r[r.STREAM_COPY=35042]="STREAM_COPY",r[r.STATIC_READ=35045]="STATIC_READ",r[r.STATIC_COPY=35046]="STATIC_COPY",r[r.DYNAMIC_READ=35049]="DYNAMIC_READ",r[r.DYNAMIC_COPY=35050]="DYNAMIC_COPY",r[r.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",r[r.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",r[r.INVALID_INDEX=4294967295]="INVALID_INDEX",r[r.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",r[r.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",r[r.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",r[r.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",r[r.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",r[r.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",r[r.R16_EXT=33322]="R16_EXT",r[r.RG16_EXT=33324]="RG16_EXT",r[r.RGB16_EXT=32852]="RGB16_EXT",r[r.RGBA16_EXT=32859]="RGBA16_EXT",r[r.R16_SNORM_EXT=36760]="R16_SNORM_EXT",r[r.RG16_SNORM_EXT=36761]="RG16_SNORM_EXT",r[r.RGB16_SNORM_EXT=36762]="RGB16_SNORM_EXT",r[r.RGBA16_SNORM_EXT=36763]="RGBA16_SNORM_EXT",r[r.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",r[r.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",r[r.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",r[r.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",r[r.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",r[r.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",r[r.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",r[r.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",r[r.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",r[r.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",r[r.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",r[r.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",r[r.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",r[r.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",r[r.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",r[r.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",r[r.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",r[r.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",r[r.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",r[r.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",r[r.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",r[r.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",r[r.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",r[r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",r[r.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",r[r.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",r[r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",r[r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",r[r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",r[r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",r[r.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",r[r.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",r[r.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",r[r.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",r[r.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",r[r.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",r[r.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",r[r.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",r[r.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",r[r.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",r[r.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",r[r.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",r[r.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",r[r.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",r[r.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",r[r.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",r[r.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",r[r.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",r[r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",r[r.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",r[r.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",r[r.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",r[r.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",r[r.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",r[r.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",r[r.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT",r[r.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",r[r.DEPTH_CLAMP_EXT=34383]="DEPTH_CLAMP_EXT",r[r.FIRST_VERTEX_CONVENTION_WEBGL=36429]="FIRST_VERTEX_CONVENTION_WEBGL",r[r.LAST_VERTEX_CONVENTION_WEBGL=36430]="LAST_VERTEX_CONVENTION_WEBGL",r[r.PROVOKING_VERTEX_WEBL=36431]="PROVOKING_VERTEX_WEBL",r[r.POLYGON_MODE_WEBGL=2880]="POLYGON_MODE_WEBGL",r[r.POLYGON_OFFSET_LINE_WEBGL=10754]="POLYGON_OFFSET_LINE_WEBGL",r[r.LINE_WEBGL=6913]="LINE_WEBGL",r[r.FILL_WEBGL=6914]="FILL_WEBGL",r[r.MAX_CLIP_DISTANCES_WEBGL=3378]="MAX_CLIP_DISTANCES_WEBGL",r[r.MAX_CULL_DISTANCES_WEBGL=33529]="MAX_CULL_DISTANCES_WEBGL",r[r.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL=33530]="MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL",r[r.CLIP_DISTANCE0_WEBGL=12288]="CLIP_DISTANCE0_WEBGL",r[r.CLIP_DISTANCE1_WEBGL=12289]="CLIP_DISTANCE1_WEBGL",r[r.CLIP_DISTANCE2_WEBGL=12290]="CLIP_DISTANCE2_WEBGL",r[r.CLIP_DISTANCE3_WEBGL=12291]="CLIP_DISTANCE3_WEBGL",r[r.CLIP_DISTANCE4_WEBGL=12292]="CLIP_DISTANCE4_WEBGL",r[r.CLIP_DISTANCE5_WEBGL=12293]="CLIP_DISTANCE5_WEBGL",r[r.CLIP_DISTANCE6_WEBGL=12294]="CLIP_DISTANCE6_WEBGL",r[r.CLIP_DISTANCE7_WEBGL=12295]="CLIP_DISTANCE7_WEBGL",r[r.POLYGON_OFFSET_CLAMP_EXT=36379]="POLYGON_OFFSET_CLAMP_EXT",r[r.LOWER_LEFT_EXT=36001]="LOWER_LEFT_EXT",r[r.UPPER_LEFT_EXT=36002]="UPPER_LEFT_EXT",r[r.NEGATIVE_ONE_TO_ONE_EXT=37726]="NEGATIVE_ONE_TO_ONE_EXT",r[r.ZERO_TO_ONE_EXT=37727]="ZERO_TO_ONE_EXT",r[r.CLIP_ORIGIN_EXT=37724]="CLIP_ORIGIN_EXT",r[r.CLIP_DEPTH_MODE_EXT=37725]="CLIP_DEPTH_MODE_EXT",r[r.SRC1_COLOR_WEBGL=35065]="SRC1_COLOR_WEBGL",r[r.SRC1_ALPHA_WEBGL=34185]="SRC1_ALPHA_WEBGL",r[r.ONE_MINUS_SRC1_COLOR_WEBGL=35066]="ONE_MINUS_SRC1_COLOR_WEBGL",r[r.ONE_MINUS_SRC1_ALPHA_WEBGL=35067]="ONE_MINUS_SRC1_ALPHA_WEBGL",r[r.MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL=35068]="MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL",r[r.MIRROR_CLAMP_TO_EDGE_EXT=34627]="MIRROR_CLAMP_TO_EDGE_EXT"})(Yl||(Yl={}));const Dm={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},mi=(r,e,t)=>e?r.enable(t):r.disable(t),iv=(r,e,t)=>r.hint(t,e),wn=(r,e,t)=>r.pixelStorei(t,e),nv=(r,e,t)=>{const s=t===36006?36009:36008;return r.bindFramebuffer(s,e)},Ih=(r,e,t)=>{const a={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[t];r.bindBuffer(a,e)};function hg(r){return Array.isArray(r)||ArrayBuffer.isView(r)&&!(r instanceof DataView)}const pM={3042:mi,32773:(r,e)=>r.blendColor(...e),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(r,e)=>r.clearColor(...e),3107:(r,e)=>r.colorMask(...e),2884:mi,2885:(r,e)=>r.cullFace(e),2929:mi,2931:(r,e)=>r.clearDepth(e),2932:(r,e)=>r.depthFunc(e),2928:(r,e)=>r.depthRange(...e),2930:(r,e)=>r.depthMask(e),3024:mi,35723:iv,35725:(r,e)=>r.useProgram(e),36007:(r,e)=>r.bindRenderbuffer(36161,e),36389:(r,e)=>r.bindTransformFeedback?.(36386,e),34229:(r,e)=>r.bindVertexArray(e),36006:nv,36010:nv,34964:Ih,36662:Ih,36663:Ih,35053:Ih,35055:Ih,2886:(r,e)=>r.frontFace(e),33170:iv,2849:(r,e)=>r.lineWidth(e),32823:mi,32824:"polygonOffset",10752:"polygonOffset",35977:mi,32926:mi,32928:mi,32938:"sampleCoverage",32939:"sampleCoverage",3089:mi,3088:(r,e)=>r.scissor(...e),2960:mi,2961:(r,e)=>r.clearStencil(e),2968:(r,e)=>r.stencilMaskSeparate(1028,e),36005:(r,e)=>r.stencilMaskSeparate(1029,e),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(r,e)=>r.viewport(...e),34383:mi,10754:mi,12288:mi,12289:mi,12290:mi,12291:mi,12292:mi,12293:mi,12294:mi,12295:mi,3333:wn,3317:wn,37440:wn,37441:wn,37443:wn,3330:wn,3332:wn,3331:wn,3314:wn,32878:wn,3316:wn,3315:wn,32877:wn,framebuffer:(r,e)=>{const t=e&&"handle"in e?e.handle:e;return r.bindFramebuffer(36160,t)},blend:(r,e)=>e?r.enable(3042):r.disable(3042),blendColor:(r,e)=>r.blendColor(...e),blendEquation:(r,e)=>{const t=typeof e=="number"?[e,e]:e;r.blendEquationSeparate(...t)},blendFunc:(r,e)=>{const t=e?.length===2?[...e,...e]:e;r.blendFuncSeparate(...t)},clearColor:(r,e)=>r.clearColor(...e),clearDepth:(r,e)=>r.clearDepth(e),clearStencil:(r,e)=>r.clearStencil(e),colorMask:(r,e)=>r.colorMask(...e),cull:(r,e)=>e?r.enable(2884):r.disable(2884),cullFace:(r,e)=>r.cullFace(e),depthTest:(r,e)=>e?r.enable(2929):r.disable(2929),depthFunc:(r,e)=>r.depthFunc(e),depthMask:(r,e)=>r.depthMask(e),depthRange:(r,e)=>r.depthRange(...e),dither:(r,e)=>e?r.enable(3024):r.disable(3024),derivativeHint:(r,e)=>{r.hint(35723,e)},frontFace:(r,e)=>r.frontFace(e),mipmapHint:(r,e)=>r.hint(33170,e),lineWidth:(r,e)=>r.lineWidth(e),polygonOffsetFill:(r,e)=>e?r.enable(32823):r.disable(32823),polygonOffset:(r,e)=>r.polygonOffset(...e),sampleCoverage:(r,e)=>r.sampleCoverage(e[0],e[1]||!1),scissorTest:(r,e)=>e?r.enable(3089):r.disable(3089),scissor:(r,e)=>r.scissor(...e),stencilTest:(r,e)=>e?r.enable(2960):r.disable(2960),stencilMask:(r,e)=>{e=hg(e)?e:[e,e];const[t,s]=e;r.stencilMaskSeparate(1028,t),r.stencilMaskSeparate(1029,s)},stencilFunc:(r,e)=>{e=hg(e)&&e.length===3?[...e,...e]:e;const[t,s,a,u,p,o]=e;r.stencilFuncSeparate(1028,t,s,a),r.stencilFuncSeparate(1029,u,p,o)},stencilOp:(r,e)=>{e=hg(e)&&e.length===3?[...e,...e]:e;const[t,s,a,u,p,o]=e;r.stencilOpSeparate(1028,t,s,a),r.stencilOpSeparate(1029,u,p,o)},viewport:(r,e)=>r.viewport(...e)};function Qr(r,e,t){return e[r]!==void 0?e[r]:t[r]}const gM={blendEquation:(r,e,t)=>r.blendEquationSeparate(Qr(32777,e,t),Qr(34877,e,t)),blendFunc:(r,e,t)=>r.blendFuncSeparate(Qr(32969,e,t),Qr(32968,e,t),Qr(32971,e,t),Qr(32970,e,t)),polygonOffset:(r,e,t)=>r.polygonOffset(Qr(32824,e,t),Qr(10752,e,t)),sampleCoverage:(r,e,t)=>r.sampleCoverage(Qr(32938,e,t),Qr(32939,e,t)),stencilFuncFront:(r,e,t)=>r.stencilFuncSeparate(1028,Qr(2962,e,t),Qr(2967,e,t),Qr(2963,e,t)),stencilFuncBack:(r,e,t)=>r.stencilFuncSeparate(1029,Qr(34816,e,t),Qr(36003,e,t),Qr(36004,e,t)),stencilOpFront:(r,e,t)=>r.stencilOpSeparate(1028,Qr(2964,e,t),Qr(2965,e,t),Qr(2966,e,t)),stencilOpBack:(r,e,t)=>r.stencilOpSeparate(1029,Qr(34817,e,t),Qr(34818,e,t),Qr(34819,e,t))},sv={enable:(r,e)=>r({[e]:!0}),disable:(r,e)=>r({[e]:!1}),pixelStorei:(r,e,t)=>r({[e]:t}),hint:(r,e,t)=>r({[e]:t}),useProgram:(r,e)=>r({35725:e}),bindRenderbuffer:(r,e,t)=>r({36007:t}),bindTransformFeedback:(r,e,t)=>r({36389:t}),bindVertexArray:(r,e)=>r({34229:e}),bindFramebuffer:(r,e,t)=>{switch(e){case 36160:return r({36006:t,36010:t});case 36009:return r({36006:t});case 36008:return r({36010:t});default:return null}},bindBuffer:(r,e,t)=>{const s={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[e];return s?r({[s]:t}):{valueChanged:!0}},blendColor:(r,e,t,s,a)=>r({32773:new Float32Array([e,t,s,a])}),blendEquation:(r,e)=>r({32777:e,34877:e}),blendEquationSeparate:(r,e,t)=>r({32777:e,34877:t}),blendFunc:(r,e,t)=>r({32969:e,32968:t,32971:e,32970:t}),blendFuncSeparate:(r,e,t,s,a)=>r({32969:e,32968:t,32971:s,32970:a}),clearColor:(r,e,t,s,a)=>r({3106:new Float32Array([e,t,s,a])}),clearDepth:(r,e)=>r({2931:e}),clearStencil:(r,e)=>r({2961:e}),colorMask:(r,e,t,s,a)=>r({3107:[e,t,s,a]}),cullFace:(r,e)=>r({2885:e}),depthFunc:(r,e)=>r({2932:e}),depthRange:(r,e,t)=>r({2928:new Float32Array([e,t])}),depthMask:(r,e)=>r({2930:e}),frontFace:(r,e)=>r({2886:e}),lineWidth:(r,e)=>r({2849:e}),polygonOffset:(r,e,t)=>r({32824:e,10752:t}),sampleCoverage:(r,e,t)=>r({32938:e,32939:t}),scissor:(r,e,t,s,a)=>r({3088:new Int32Array([e,t,s,a])}),stencilMask:(r,e)=>r({2968:e,36005:e}),stencilMaskSeparate:(r,e,t)=>r({[e===1028?2968:36005]:t}),stencilFunc:(r,e,t,s)=>r({2962:e,2967:t,2963:s,34816:e,36003:t,36004:s}),stencilFuncSeparate:(r,e,t,s,a)=>r({[e===1028?2962:34816]:t,[e===1028?2967:36003]:s,[e===1028?2963:36004]:a}),stencilOp:(r,e,t,s)=>r({2964:e,2965:t,2966:s,34817:e,34818:t,34819:s}),stencilOpSeparate:(r,e,t,s,a)=>r({[e===1028?2964:34817]:t,[e===1028?2965:34818]:s,[e===1028?2966:34819]:a}),viewport:(r,e,t,s,a)=>r({2978:[e,t,s,a]})},bs=(r,e)=>r.isEnabled(e),ov={3042:bs,2884:bs,2929:bs,3024:bs,32823:bs,32926:bs,32928:bs,3089:bs,2960:bs,35977:bs},mM=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function fc(r,e){if(yM(e))return;const t={};for(const a in e){const u=Number(a),p=pM[a];p&&(typeof p=="string"?t[p]=!0:p(r,e[a],u))}const s=r.state&&r.state.cache;if(s)for(const a in t){const u=gM[a];u(r,e,s)}}function k0(r,e=Dm){if(typeof e=="number"){const a=e,u=ov[a];return u?u(r,a):r.getParameter(a)}const t=Array.isArray(e)?e:Object.keys(e),s={};for(const a of t){const u=ov[a];s[a]=u?u(r,Number(a)):r.getParameter(Number(a))}return s}function _M(r){fc(r,Dm)}function yM(r){for(const e in r)return!1;return!0}function bM(r,e){if(r===e)return!0;const t=Array.isArray(r)||ArrayBuffer.isView(r),s=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&s&&r.length===e.length){for(let a=0;a<r.length;++a)if(r[a]!==e[a])return!1;return!0}return!1}class Fa{static get(e){return e.state}gl;program=null;stateStack=[];enable=!0;cache=null;log;initialized=!1;constructor(e,t){this.gl=e,this.log=t?.log||(()=>{}),this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(e={}){this.stateStack.push({})}pop(){const e=this.stateStack[this.stateStack.length-1];fc(this.gl,e),this.stateStack.pop()}trackState(e,t){if(this.cache=t.copyState?k0(e):Object.assign({},Dm),this.initialized)throw new Error("WebGLStateTracker");this.initialized=!0,this.gl.state=this,xM(e);for(const s in sv){const a=sv[s];vM(e,s,a)}av(e,"getParameter"),av(e,"isEnabled")}_updateCache(e){let t=!1,s;const a=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const u in e){const p=e[u],o=this.cache[u];bM(p,o)||(t=!0,s=o,a&&!(u in a)&&(a[u]=o),this.cache[u]=p)}return{valueChanged:t,oldValue:s}}}function av(r,e){const t=r[e].bind(r);r[e]=function(a){if(a===void 0||mM.has(a))return t(a);const u=Fa.get(r);return a in u.cache||(u.cache[a]=t(a)),u.enable?u.cache[a]:t(a)},Object.defineProperty(r[e],"name",{value:`${e}-from-cache`,configurable:!1})}function vM(r,e,t){if(!r[e])return;const s=r[e].bind(r);r[e]=function(...u){const p=Fa.get(r),{valueChanged:o,oldValue:T}=t(p._updateCache,...u);return o&&s(...u),T},Object.defineProperty(r[e],"name",{value:`${e}-to-cache`,configurable:!1})}function xM(r){const e=r.useProgram.bind(r);r.useProgram=function(s){const a=Fa.get(r);a.program!==s&&(e(s),a.program=s)}}function wM(r,e,t){let s="";const a={preserveDrawingBuffer:!0,...t};let u=null;if(u||=r.getContext("webgl2",a),a.failIfMajorPerformanceCaveat&&(s||="Only software GPU is available. Set `failIfMajorPerformanceCaveat: false` to allow."),!u&&!t.failIfMajorPerformanceCaveat&&(a.failIfMajorPerformanceCaveat=!1,u=r.getContext("webgl2",a),u.luma||={},u.luma.softwareRenderer=!0),u||(u=r.getContext("webgl",{}),u&&(u=null,s||="Your browser only supports WebGL1")),!u)throw s||="Your browser does not support WebGL",new Error(`Failed to create WebGL context: ${s}`);const{onContextLost:p,onContextRestored:o}=e;return r.addEventListener("webglcontextlost",T=>p(T),!1),r.addEventListener("webglcontextrestored",T=>o(T),!1),u.luma||={},u}function hc(r,e,t){return t[e]===void 0&&(t[e]=r.getExtension(e)||null),t[e]}function TM(r,e){const t=r.getParameter(7936),s=r.getParameter(7937);hc(r,"WEBGL_debug_renderer_info",e);const a=e.WEBGL_debug_renderer_info,u=r.getParameter(a?a.UNMASKED_VENDOR_WEBGL:7936),p=r.getParameter(a?a.UNMASKED_RENDERER_WEBGL:7937),o=u||t,T=p||s,E=r.getParameter(7938),C=D0(o,T),O=SM(o,T),$=AM(o,T);return{type:"webgl",gpu:C,gpuType:$,gpuBackend:O,vendor:o,renderer:T,version:E,shadingLanguage:"glsl",shadingLanguageVersion:300}}function D0(r,e){return/NVIDIA/i.exec(r)||/NVIDIA/i.exec(e)?"nvidia":/INTEL/i.exec(r)||/INTEL/i.exec(e)?"intel":/Apple/i.exec(r)||/Apple/i.exec(e)?"apple":/AMD/i.exec(r)||/AMD/i.exec(e)||/ATI/i.exec(r)||/ATI/i.exec(e)?"amd":/SwiftShader/i.exec(r)||/SwiftShader/i.exec(e)?"software":"unknown"}function SM(r,e){return/Metal/i.exec(r)||/Metal/i.exec(e)?"metal":/ANGLE/i.exec(r)||/ANGLE/i.exec(e)?"opengl":"unknown"}function AM(r,e){if(/SwiftShader/i.exec(r)||/SwiftShader/i.exec(e))return"cpu";switch(D0(r,e)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}function O0(r){switch(r){case"uint8":return 5121;case"sint8":return 5120;case"unorm8":return 5121;case"snorm8":return 5120;case"uint16":return 5123;case"sint16":return 5122;case"unorm16":return 5123;case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(r))}const kh="WEBGL_compressed_texture_s3tc",Dh="WEBGL_compressed_texture_s3tc_srgb",Gl="EXT_texture_compression_rgtc",Kl="EXT_texture_compression_bptc",EM="WEBGL_compressed_texture_etc",IM="WEBGL_compressed_texture_astc",CM="WEBGL_compressed_texture_etc1",PM="WEBGL_compressed_texture_pvrtc",MM="WEBGL_compressed_texture_atc",lv="EXT_texture_norm16",cv="EXT_render_snorm",RM="EXT_color_buffer_float",Om={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat-renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[cv],"norm16-renderable-webgl":[lv],"snorm16-renderable-webgl":[lv,cv],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[kh,Dh,Gl,Kl],"texture-compression-bc5-webgl":[Gl],"texture-compression-bc7-webgl":[Kl],"texture-compression-etc2":[EM],"texture-compression-astc":[IM],"texture-compression-etc1-webgl":[CM],"texture-compression-pvrtc-webgl":[PM],"texture-compression-atc-webgl":[MM]};function kM(r){return r in Om}function DM(r,e,t){return(Om[e]||[]).every(a=>hc(r,a,t))}const Fm={r8unorm:{gl:33321,rb:!0},r8snorm:{gl:36756},r8uint:{gl:33330,rb:!0},r8sint:{gl:33329,rb:!0},rg8unorm:{gl:33323,rb:!0},rg8snorm:{gl:36757},rg8uint:{gl:33336,rb:!0},rg8sint:{gl:33335,rb:!0},r16uint:{gl:33332,rb:!0},r16sint:{gl:33331,rb:!0},r16float:{gl:33325,rb:!0},"r16unorm-webgl":{gl:33322,rb:!0},"r16snorm-webgl":{gl:36760},"rgba4unorm-webgl":{gl:32854,rb:!0},"rgb565unorm-webgl":{gl:36194,rb:!0},"rgb5a1unorm-webgl":{gl:32855,rb:!0},"rgb8unorm-webgl":{gl:32849},"rgb8snorm-webgl":{gl:36758},rgba8unorm:{gl:32856},"rgba8unorm-srgb":{gl:35907},rgba8snorm:{gl:36759},rgba8uint:{gl:36220},rgba8sint:{gl:36238},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{gl:33338},rg16sint:{gl:33337},rg16float:{gl:33327,rb:!0},"rg16unorm-webgl":{gl:33324},"rg16snorm-webgl":{gl:36761},r32uint:{gl:33334,rb:!0},r32sint:{gl:33333,rb:!0},r32float:{gl:33326},rgb9e5ufloat:{gl:35901},rg11b10ufloat:{gl:35898,rb:!0},rgb10a2unorm:{gl:32857,rb:!0},"rgb10a2uint-webgl":{gl:36975,rb:!0},"rgb16unorm-webgl":{gl:32852},"rgb16snorm-webgl":{gl:36762},rg32uint:{gl:33340,rb:!0},rg32sint:{gl:33339,rb:!0},rg32float:{gl:33328,rb:!0},rgba16uint:{gl:36214,rb:!0},rgba16sint:{gl:36232,rb:!0},rgba16float:{gl:34842},"rgba16unorm-webgl":{gl:32859,rb:!0},"rgba16snorm-webgl":{gl:36763},"rgb32float-webgl":{gl:34837,x:RM,dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,rb:!0},rgba32sint:{gl:36226,rb:!0},rgba32float:{gl:34836,rb:!0},stencil8:{gl:36168,rb:!0},depth16unorm:{gl:33189,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,dataFormat:6402,types:[5125]},depth32float:{gl:36012,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth32float-stencil8":{gl:36013,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:kh},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:Dh},"bc1-rgba-unorm":{gl:33777,x:kh},"bc1-rgba-unorm-srgb":{gl:35916,x:Dh},"bc2-rgba-unorm":{gl:33778,x:kh},"bc2-rgba-unorm-srgb":{gl:35918,x:Dh},"bc3-rgba-unorm":{gl:33779,x:kh},"bc3-rgba-unorm-srgb":{gl:35919,x:Dh},"bc4-r-unorm":{gl:36283,x:Gl},"bc4-r-snorm":{gl:36284,x:Gl},"bc5-rg-unorm":{gl:36285,x:Gl},"bc5-rg-snorm":{gl:36286,x:Gl},"bc6h-rgb-ufloat":{gl:36495,x:Kl},"bc6h-rgb-float":{gl:36494,x:Kl},"bc7-rgba-unorm":{gl:36492,x:Kl},"bc7-rgba-unorm-srgb":{gl:36493,x:Kl},"etc2-rgb8unorm":{gl:37492},"etc2-rgb8unorm-srgb":{gl:37494},"etc2-rgb8a1unorm":{gl:37496},"etc2-rgb8a1unorm-srgb":{gl:37497},"etc2-rgba8unorm":{gl:37493},"etc2-rgba8unorm-srgb":{gl:37495},"eac-r11unorm":{gl:37488},"eac-r11snorm":{gl:37489},"eac-rg11unorm":{gl:37490},"eac-rg11snorm":{gl:37491},"astc-4x4-unorm":{gl:37808},"astc-4x4-unorm-srgb":{gl:37840},"astc-5x4-unorm":{gl:37809},"astc-5x4-unorm-srgb":{gl:37841},"astc-5x5-unorm":{gl:37810},"astc-5x5-unorm-srgb":{gl:37842},"astc-6x5-unorm":{gl:37811},"astc-6x5-unorm-srgb":{gl:37843},"astc-6x6-unorm":{gl:37812},"astc-6x6-unorm-srgb":{gl:37844},"astc-8x5-unorm":{gl:37813},"astc-8x5-unorm-srgb":{gl:37845},"astc-8x6-unorm":{gl:37814},"astc-8x6-unorm-srgb":{gl:37846},"astc-8x8-unorm":{gl:37815},"astc-8x8-unorm-srgb":{gl:37847},"astc-10x5-unorm":{gl:37819},"astc-10x5-unorm-srgb":{gl:37851},"astc-10x6-unorm":{gl:37817},"astc-10x6-unorm-srgb":{gl:37849},"astc-10x8-unorm":{gl:37818},"astc-10x8-unorm-srgb":{gl:37850},"astc-10x10-unorm":{gl:37819},"astc-10x10-unorm-srgb":{gl:37851},"astc-12x10-unorm":{gl:37820},"astc-12x10-unorm-srgb":{gl:37852},"astc-12x12-unorm":{gl:37821},"astc-12x12-unorm-srgb":{gl:37853},"pvrtc-rgb4unorm-webgl":{gl:35840},"pvrtc-rgba4unorm-webgl":{gl:35842},"pvrtc-rbg2unorm-webgl":{gl:35841},"pvrtc-rgba2unorm-webgl":{gl:35843},"etc1-rbg-unorm-webgl":{gl:36196},"atc-rgb-unorm-webgl":{gl:35986},"atc-rgba-unorm-webgl":{gl:35986},"atc-rgbai-unorm-webgl":{gl:34798}};function OM(r,e,t){let s=e.create;const a=Fm[e.format];return a?.gl===void 0&&(s=!1),a?.x&&(s=s&&!!hc(r,a.x,t)),{format:e.format,create:s&&e.create,render:s&&e.render,filter:s&&e.filter,blend:s&&e.blend,store:s&&e.store}}function F0(r){const e=Fm[r],t=LM(r),s=am(r);return{internalFormat:t,format:e?.dataFormat||BM(s.channels,s.integer,s.normalized,t),type:s.dataType?O0(s.dataType):e?.types?.[0]||5121,compressed:s.compressed||!1}}function FM(r){switch(am(r).attachment){case"depth":return 36096;case"stencil":return 36128;case"depth-stencil":return 33306;default:throw new Error(`Not a depth stencil format: ${r}`)}}function BM(r,e,t,s){if(s===6408||s===6407)return s;switch(r){case"r":return e&&!t?36244:6403;case"rg":return e&&!t?33320:33319;case"rgb":return e&&!t?36248:6407;case"rgba":return e&&!t?36249:6408;case"bgra":throw new Error("bgra pixels not supported by WebGL");default:return 6408}}function LM(r){const t=Fm[r]?.gl;if(t===void 0)throw new Error(`Unsupported texture format ${r}`);return t}const hv={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class NM extends yA{gl;extensions;testedFeatures=new Set;constructor(e,t,s){super([],s),this.gl=e,this.extensions=t,hc(e,"EXT_color_buffer_float",t)}*[Symbol.iterator](){const e=this.getFeatures();for(const t of e)this.has(t)&&(yield t);return[]}has(e){return this.disabledFeatures?.[e]?!1:(this.testedFeatures.has(e)||(this.testedFeatures.add(e),kM(e)&&DM(this.gl,e,this.extensions)&&this.features.add(e),this.getWebGLFeature(e)&&this.features.add(e)),this.features.has(e))}initializeFeatures(){const e=this.getFeatures().filter(t=>t!=="polygon-mode-webgl");for(const t of e)this.has(t)}getFeatures(){return[...Object.keys(hv),...Object.keys(Om)]}getWebGLFeature(e){const t=hv[e];return typeof t=="string"?!!hc(this.gl,t,this.extensions):!!t}}class zM extends _A{get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderComponents(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}gl;limits={};constructor(e){super(),this.gl=e}getParameter(e){return this.limits[e]===void 0&&(this.limits[e]=this.gl.getParameter(e)),this.limits[e]||0}}class Nh extends pf{device;gl;handle;colorAttachments=[];depthStencilAttachment=null;constructor(e,t){super(e,t);const s=t.handle===null;this.device=e,this.gl=e.gl,this.handle=this.props.handle||s?this.props.handle:this.gl.createFramebuffer(),s||(e.setSpectorMetadata(this.handle,{id:this.props.id,props:this.props}),this.autoCreateAttachmentTextures(),this.updateAttachments())}destroy(){super.destroy(),!this.destroyed&&this.handle!==null&&this.gl.deleteFramebuffer(this.handle)}updateAttachments(){const e=this.gl.bindFramebuffer(36160,this.handle);for(let t=0;t<this.colorAttachments.length;++t){const s=this.colorAttachments[t];if(s){const a=36064+t;this._attachTextureView(a,s)}}if(this.depthStencilAttachment){const t=FM(this.depthStencilAttachment.props.format);this._attachTextureView(t,this.depthStencilAttachment)}if(this.device.props.debug){const t=this.gl.checkFramebufferStatus(36160);if(t!==36053)throw new Error(`Framebuffer ${VM(t)}`)}this.gl.bindFramebuffer(36160,e)}_attachTextureView(e,t){const{gl:s}=this.device,{texture:a}=t,u=t.props.baseMipLevel,p=t.props.baseArrayLayer;switch(s.bindTexture(a.glTarget,a.handle),a.glTarget){case 35866:case 32879:s.framebufferTextureLayer(36160,e,a.handle,u,p);break;case 34067:const o=UM(p);s.framebufferTexture2D(36160,e,o,a.handle,u);break;case 3553:s.framebufferTexture2D(36160,e,3553,a.handle,u);break;default:throw new Error("Illegal texture type")}s.bindTexture(a.glTarget,null)}}function UM(r){return r<34069?r+34069:r}function VM(r){switch(r){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${r}`}}class jM extends lm{device;format="rgba8unorm";depthStencilFormat="depth24plus";presentationSize;_framebuffer=null;get[Symbol.toStringTag](){return"WebGLCanvasContext"}constructor(e,t){super(t),this.device=e,this.presentationSize=[-1,-1],this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this.update()}getCurrentFramebuffer(){return this.update(),this._framebuffer=this._framebuffer||new Nh(this.device,{handle:null}),this._framebuffer}update(){const e=this.getPixelSize();(e[0]!==this.presentationSize[0]||e[1]!==this.presentationSize[1])&&(this.presentationSize=e,this.resize())}resize(e){if(this.device.gl&&this.canvas){const t=this.getDevicePixelRatio(e?.useDevicePixels);this.setDevicePixelRatio(t,e);return}}commit(){}}async function B0(r,e){const t=document.getElementsByTagName("head")[0];if(!t)throw new Error("loadScript");const s=document.createElement("script");return s.setAttribute("type","text/javascript"),s.setAttribute("src",r),new Promise((a,u)=>{s.onload=a,s.onerror=p=>u(new Error(`Unable to load script '${r}': ${p}`)),t.appendChild(s)})}const $M=1;let Tn=null,uv=!1;const Bm={debugSpectorJS:ot.get("debug-spectorjs"),debugSpectorJSUrl:"https://cdn.jsdelivr.net/npm/spectorjs@0.9.30/dist/spector.bundle.js",gl:void 0};async function WM(r){if(!globalThis.SPECTOR)try{await B0(r.debugSpectorJSUrl||Bm.debugSpectorJSUrl)}catch(e){ot.warn(String(e))}}function HM(r){if(r={...Bm,...r},!r.debugSpectorJS)return null;if(!Tn&&globalThis.SPECTOR&&!globalThis.luma?.spector){ot.probe($M,"SPECTOR found and initialized. Start with `luma.spector.displayUI()`")();const{Spector:e}=globalThis.SPECTOR;Tn=new e,globalThis.luma&&(globalThis.luma.spector=Tn)}if(!Tn)return null;if(uv||(uv=!0,Tn.spyCanvases(),Tn?.onCaptureStarted.add(e=>ot.info("Spector capture started:",e)()),Tn?.onCapture.add(e=>{ot.info("Spector capture complete:",e)(),Tn?.getResultUI(),Tn?.resultView.display(),Tn?.resultView.addCapture(e)})),r.gl){const e=r.gl,t=e.device;Tn?.startCapture(r.gl,500),e.device=t,new Promise(s=>setTimeout(s,2e3)).then(s=>{ot.info("Spector capture stopped after 2 seconds")(),Tn?.stopCapture()})}return Tn}const ZM="https://unpkg.com/webgl-debug@2.0.1/index.js";function L0(r){return r.luma=r.luma||{},r.luma}async function XM(){Va()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await B0(ZM))}function qM(r,e={}){return e.debugWebGL||e.traceWebGL?GM(r,e):YM(r)}function YM(r){const e=L0(r);return e.realContext?e.realContext:r}function GM(r,e){if(!globalThis.WebGLDebugUtils)return ot.warn("webgl-debug not loaded")(),r;const t=L0(r);if(t.debugContext)return t.debugContext;globalThis.WebGLDebugUtils.init({...Yl,...r});const s=globalThis.WebGLDebugUtils.makeDebugContext(r,KM.bind(null,e),JM.bind(null,e));for(const p in Yl)!(p in s)&&typeof Yl[p]=="number"&&(s[p]=Yl[p]);class a{}Object.setPrototypeOf(s,Object.getPrototypeOf(r)),Object.setPrototypeOf(a,s);const u=Object.create(a);return t.realContext=r,t.debugContext=u,u.debug=!0,u}function dv(r,e){e=Array.from(e).map(s=>s===void 0?"undefined":s);let t=globalThis.WebGLDebugUtils.glFunctionArgsToString(r,e);return t=`${t.slice(0,100)}${t.length>100?"...":""}`,`gl.${r}(${t})`}function KM(r,e,t,s){s=Array.from(s).map(o=>o===void 0?"undefined":o);const a=globalThis.WebGLDebugUtils.glEnumToString(e),u=globalThis.WebGLDebugUtils.glFunctionArgsToString(t,s),p=`${a} in gl.${t}(${u})`;ot.error(p)();debugger}function JM(r,e,t){let s="";ot.level>=1&&(s=dv(e,t),r.traceWebGL&&ot.log(1,s)());for(const a of t)if(a===void 0){s=s||dv(e,t);debugger}}const ug={};function QM(r="id"){ug[r]=ug[r]||1;const e=ug[r]++;return`${r}-${e}`}class zh extends Ur{device;gl;handle;glTarget;glUsage;glIndexType=5123;byteLength;bytesUsed;constructor(e,t={}){super(e,t),this.device=e,this.gl=this.device.gl;const s=typeof t=="object"?t.handle:void 0;this.handle=s||this.gl.createBuffer(),e.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glTarget=eR(this.props.usage),this.glUsage=tR(this.props.usage),this.glIndexType=this.props.indexType==="uint32"?5125:5123,t.data?this._initWithData(t.data,t.byteOffset,t.byteLength):this._initWithByteLength(t.byteLength||0)}_initWithData(e,t=0,s=e.byteLength+t){const a=this.glTarget;this.gl.bindBuffer(a,this.handle),this.gl.bufferData(a,s,this.glUsage),this.gl.bufferSubData(a,t,e),this.gl.bindBuffer(a,null),this.bytesUsed=s,this.byteLength=s,this._setDebugData(e,t,s),this.trackAllocatedMemory(s)}_initWithByteLength(e){let t=e;e===0&&(t=new Float32Array(0));const s=this.glTarget;return this.gl.bindBuffer(s,this.handle),this.gl.bufferData(s,t,this.glUsage),this.gl.bindBuffer(s,null),this.bytesUsed=e,this.byteLength=e,this._setDebugData(null,0,e),this.trackAllocatedMemory(e),this}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}write(e,t=0){this.gl.bindBuffer(36663,this.handle),this.gl.bufferSubData(36663,t,e),this.gl.bindBuffer(36663,null),this._setDebugData(e,t,e.byteLength)}async readAsync(e=0,t){return this.readSyncWebGL(e,t)}readSyncWebGL(e=0,t){t=t??this.byteLength-e;const s=new Uint8Array(t),a=0;return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,e,s,a,t),this.gl.bindBuffer(36662,null),this._setDebugData(s,e,t),s}}function eR(r){return r&Ur.INDEX?34963:r&Ur.VERTEX?34962:r&Ur.UNIFORM?35345:34962}function tR(r){return r&Ur.INDEX||r&Ur.VERTEX?35044:r&Ur.UNIFORM?35048:35044}function rR(r){const e=r.split(/\r?\n/),t=[];for(const s of e){if(s.length<=1)continue;const a=s.split(":");if(a.length===2){const[O,$]=a;t.push({message:$.trim(),type:fv(O),lineNum:0,linePos:0});continue}const[u,p,o,...T]=a;let E=parseInt(o,10);isNaN(E)&&(E=0);let C=parseInt(p,10);isNaN(C)&&(C=0),t.push({message:T.join(":").trim(),type:fv(u),lineNum:E,linePos:C})}return t}function fv(r){const e=["warning","error","info"],t=r.toLowerCase();return e.includes(t)?t:"info"}class iR extends ff{device;handle;constructor(e,t){switch(super(e,t),this.device=e,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0)}get asyncCompilationStatus(){return this._waitForCompilationComplete().then(()=>this.compilationStatus)}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){const e=this.device.gl.getShaderInfoLog(this.handle);return e?rR(e):[]}getTranslatedSource(){return this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders?.getTranslatedShaderSource(this.handle)||null}async _compile(e){e=e.startsWith("#version ")?e:`#version 300 es
${e}`;const{gl:t}=this.device;if(t.shaderSource(this.handle,e),t.compileShader(this.handle),!this.device.props.debug){this.compilationStatus="pending";return}if(!this.device.features.has("compilation-status-async-webgl")){if(this._getCompilationStatus(),this.debugShader(),this.compilationStatus==="error")throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`);return}ot.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),ot.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader()}async _waitForCompilationComplete(){const e=async a=>await new Promise(u=>setTimeout(u,a));if(!this.device.features.has("compilation-status-async-webgl")){await e(10);return}const{gl:s}=this.device;for(;;){if(s.getShaderParameter(this.handle,37297))return;await e(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}function nR(r,e,t,s){if(lR(e))return s(r);const a=r;a.pushState();try{return sR(r,e),fc(a.gl,t),s(r)}finally{a.popState()}}function sR(r,e){const t=r,{gl:s}=t;if(e.cullMode)switch(e.cullMode){case"none":s.disable(2884);break;case"front":s.enable(2884),s.cullFace(1028);break;case"back":s.enable(2884),s.cullFace(1029);break}if(e.frontFace&&s.frontFace(Ba("frontFace",e.frontFace,{ccw:2305,cw:2304})),e.unclippedDepth&&r.features.has("depth-clip-control")&&s.enable(34383),e.depthBias!==void 0&&(s.enable(32823),s.polygonOffset(e.depthBias,e.depthBiasSlopeScale||0)),e.provokingVertex&&r.features.has("provoking-vertex-webgl")){const u=t.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,p=Ba("provokingVertex",e.provokingVertex,{first:36429,last:36430});u?.provokingVertexWEBGL(p)}if((e.polygonMode||e.polygonOffsetLine)&&r.features.has("polygon-mode-webgl")){if(e.polygonMode){const u=t.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,p=Ba("polygonMode",e.polygonMode,{fill:6914,line:6913});u?.polygonModeWEBGL(1028,p),u?.polygonModeWEBGL(1029,p)}e.polygonOffsetLine&&s.enable(10754)}if(r.features.has("shader-clip-cull-distance-webgl")&&(e.clipDistance0&&s.enable(12288),e.clipDistance1&&s.enable(12289),e.clipDistance2&&s.enable(12290),e.clipDistance3&&s.enable(12291),e.clipDistance4&&s.enable(12292),e.clipDistance5&&s.enable(12293),e.clipDistance6&&s.enable(12294),e.clipDistance7&&s.enable(12295)),e.depthWriteEnabled!==void 0&&s.depthMask(aR("depthWriteEnabled",e.depthWriteEnabled)),e.depthCompare&&(e.depthCompare!=="always"?s.enable(2929):s.disable(2929),s.depthFunc($g("depthCompare",e.depthCompare))),e.stencilWriteMask){const a=e.stencilWriteMask;s.stencilMaskSeparate(1028,a),s.stencilMaskSeparate(1029,a)}if(e.stencilReadMask&&ot.warn("stencilReadMask not supported under WebGL"),e.stencilCompare){const a=e.stencilReadMask||4294967295,u=$g("depthCompare",e.stencilCompare);e.stencilCompare!=="always"?s.enable(2960):s.disable(2960),s.stencilFuncSeparate(1028,u,0,a),s.stencilFuncSeparate(1029,u,0,a)}if(e.stencilPassOperation&&e.stencilFailOperation&&e.stencilDepthFailOperation){const a=dg("stencilPassOperation",e.stencilPassOperation),u=dg("stencilFailOperation",e.stencilFailOperation),p=dg("stencilDepthFailOperation",e.stencilDepthFailOperation);s.stencilOpSeparate(1028,u,p,a),s.stencilOpSeparate(1029,u,p,a)}switch(e.blend){case!0:s.enable(3042);break;case!1:s.disable(3042);break}if(e.blendColorOperation||e.blendAlphaOperation){const a=pv("blendColorOperation",e.blendColorOperation||"add"),u=pv("blendAlphaOperation",e.blendAlphaOperation||"add");s.blendEquationSeparate(a,u);const p=Ad("blendColorSrcFactor",e.blendColorSrcFactor||"one"),o=Ad("blendColorDstFactor",e.blendColorDstFactor||"zero"),T=Ad("blendAlphaSrcFactor",e.blendAlphaSrcFactor||"one"),E=Ad("blendAlphaDstFactor",e.blendAlphaDstFactor||"zero");s.blendFuncSeparate(p,o,T,E)}}function $g(r,e){return Ba(r,e,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function dg(r,e){return Ba(r,e,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function pv(r,e){return Ba(r,e,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function Ad(r,e){return Ba(r,e,{one:1,zero:0,"src-color":768,"one-minus-src-color":769,"dst-color":774,"one-minus-dst-color":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,"constant-color":32769,"one-minus-constant-color":32770,"constant-alpha":32771,"one-minus-constant-alpha":32772})}function oR(r,e){return`Illegal parameter ${e} for ${r}`}function Ba(r,e,t){if(!(e in t))throw new Error(oR(r,e));return t[e]}function aR(r,e){return e}function lR(r){let e=!0;for(const t in r){e=!1;break}return e}function N0(r){const e={};return r.addressModeU&&(e[10242]=fg(r.addressModeU)),r.addressModeV&&(e[10243]=fg(r.addressModeV)),r.addressModeW&&(e[32882]=fg(r.addressModeW)),r.magFilter&&(e[10240]=Wg(r.magFilter)),(r.minFilter||r.mipmapFilter)&&(e[10241]=cR(r.minFilter||"linear",r.mipmapFilter)),r.lodMinClamp!==void 0&&(e[33082]=r.lodMinClamp),r.lodMaxClamp!==void 0&&(e[33083]=r.lodMaxClamp),r.type==="comparison-sampler"&&(e[34892]=34894),r.compare&&(e[34893]=$g("compare",r.compare)),r.maxAnisotropy&&(e[34046]=r.maxAnisotropy),e}function fg(r){switch(r){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function Wg(r){switch(r){case"nearest":return 9728;case"linear":return 9729}}function cR(r,e="none"){if(!e)return Wg(r);switch(e){case"none":return Wg(r);case"nearest":return r==="nearest"?9984:9986;case"linear":return r==="nearest"?9985:9987}}class Hg extends Vh{device;handle;parameters;constructor(e,t){super(e,t),this.device=e,this.parameters=N0(t),this.handle=this.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(e){for(const[t,s]of Object.entries(e)){const a=Number(t);switch(a){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,a,s);break;default:this.device.gl.samplerParameteri(this.handle,a,s);break}}}}class Jl extends df{device;gl;handle;texture;constructor(e,t){super(e,{...Cr.defaultProps,...t}),this.device=e,this.gl=this.device.gl,this.handle=null,this.texture=t.texture}}const hR="Failed to deduce GL constant from typed array";function uR(r){switch(ArrayBuffer.isView(r)?r.constructor:r){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(hR)}}function dR(r,e){const{clamped:t=!0}=e||{};switch(r){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return t?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function z0(r){switch(r){case 6406:case 33326:case 6403:case 36244:return 1;case 33339:case 33340:case 33328:case 33320:case 33319:return 2;case 6407:case 36248:case 34837:return 3;case 6408:case 36249:case 34836:return 4;default:return 0}}function fR(r){switch(r){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return 0}}function of(r,e,t){if(pR(e))return t(r);const{nocatch:s=!0}=e,a=Fa.get(r);a.push(),fc(r,e);let u;if(s)u=t(r),a.pop();else try{u=t(r)}finally{a.pop()}return u}function pR(r){for(const e in r)return!1;return!0}function gR(r,e,t){const{dimension:s,width:a,height:u,depth:p=0}=t,{glInternalFormat:o}=t,T=t.glTarget;switch(s){case"2d-array":case"3d":r.texStorage3D(T,e,o,a,u,p);break;default:r.texStorage2D(T,e,o,a,u)}}function gv(r,e,t,s){const{width:a,height:u}=s,{dimension:p,depth:o=0,mipLevel:T=0}=s,{x:E=0,y:C=0,z:O=0}=s,{glFormat:$,glType:V}=s,ie=U0(s.glTarget,p,o),we=s.flipY?{37440:!0}:{};of(r,we,()=>{switch(p){case"2d-array":case"3d":r.bindTexture(ie,e),r.texSubImage3D(ie,T,E,C,O,a,u,o,$,V,t),r.bindTexture(ie,null);break;case"2d":case"cube":r.bindTexture(ie,e),r.texSubImage2D(ie,T,E,C,a,u,$,V,t),r.bindTexture(ie,null);break;default:throw new Error(p)}})}function mv(r,e,t){const{dimension:s,width:a,height:u,depth:p=0,mipLevel:o=0,byteOffset:T=0}=t,{x:E=0,y:C=0,z:O=0}=t,{glFormat:$,glType:V,compressed:ie}=t,we=U0(t.glTarget,s,p);switch(s){case"2d-array":case"3d":ie?r.compressedTexSubImage3D(we,o,E,C,O,a,u,p,$,e,T):r.texSubImage3D(we,o,E,C,O,a,u,p,$,V,e,T);break;case"2d":case"cube":ie?r.compressedTexSubImage2D(we,o,E,C,a,u,$,e,T):r.texSubImage2D(we,o,E,C,a,u,$,V,e,T);break;default:throw new Error(s)}}function mR(r){switch(r){case"1d":break;case"2d":return 3553;case"3d":return 32879;case"cube":return 34067;case"2d-array":return 35866}throw new Error(r)}function U0(r,e,t){return e==="cube"?34069+t:r}function _R(r,e){const{sourceX:t=0,sourceY:s=0,sourceAttachment:a=0}=e||{};let{target:u=null,sourceWidth:p,sourceHeight:o,sourceDepth:T,sourceFormat:E,sourceType:C}=e||{};const{framebuffer:O,deleteFramebuffer:$}=V0(r),{gl:V,handle:ie}=O;p||=O.width,o||=O.height;const we=O.colorAttachments[a]?.texture;if(!we)throw new Error(`Invalid framebuffer attachment ${a}`);T=we?.depth||1,E||=we?.glFormat||6408,C||=we?.glType||5121,u=vR(u,C,E,p,o),C=C||uR(u);const Pe=V.bindFramebuffer(36160,ie);return V.readBuffer(36064+a),V.readPixels(t,s,p,o,E,C,u),V.readBuffer(36064),V.bindFramebuffer(36160,Pe||null),$&&O.destroy(),u}function yR(r,e){const{target:t,sourceX:s=0,sourceY:a=0,sourceFormat:u=6408,targetByteOffset:p=0}=e||{};let{sourceWidth:o,sourceHeight:T,sourceType:E}=e||{};const{framebuffer:C,deleteFramebuffer:O}=V0(r);o=o||C.width,T=T||C.height;const $=C;E=E||5121;let V=t;if(!V){const we=z0(u),Pe=fR(E),je=p+o*T*we*Pe;V=$.device.createBuffer({byteLength:je})}const ie=r.device.createCommandEncoder();return ie.copyTextureToBuffer({sourceTexture:r,width:o,height:T,origin:[s,a],destinationBuffer:V,byteOffset:p}),ie.destroy(),O&&C.destroy(),V}function V0(r){return r instanceof pf?{framebuffer:r,deleteFramebuffer:!1}:{framebuffer:bR(r),deleteFramebuffer:!0}}function bR(r,e){const{device:t,width:s,height:a,id:u}=r;return t.createFramebuffer({...e,id:`framebuffer-for-${u}`,width:s,height:a,colorAttachments:[r]})}function vR(r,e,t,s,a,u){if(r)return r;e||=5121;const p=dR(e,{clamped:!1}),o=z0(t);return new p(s*a*o)}class Uh extends Cr{device;gl;handle;sampler=void 0;view=void 0;mipmaps;compressed;glTarget;glFormat;glType;glInternalFormat;textureUnit=0;constructor(e,t){super(e,t);const s={...this.props};s.data=t.data,this.device=e,this.gl=this.device.gl,this.glTarget=mR(this.props.dimension);const a=F0(this.props.format);this.glInternalFormat=a.internalFormat,this.glFormat=a.format,this.glType=a.type,this.compressed=a.compressed,this.mipmaps=!!this.props.mipmaps,this._initialize(s),Object.seal(this)}_initialize(e){this.handle=this.props.handle||this.gl.createTexture(),this.device.setSpectorMetadata(this.handle,{...this.props,data:e.data});let{width:t,height:s}=e;if(!t||!s){const a=Cr.getTextureDataSize(e.data);t=a?.width||1,s=a?.height||1}if(this.width=t,this.height=s,this.depth=e.depth,this.setSampler(e.sampler),this.view=new Jl(this.device,{...this.props,texture:this}),this.bind(),gR(this.gl,this.mipLevels,this),e.data)switch(e.dimension){case"1d":this.setTexture1DData(e.data);break;case"2d":this.setTexture2DData(e.data);break;case"3d":this.setTexture3DData(e.data);break;case"cube":this.setTextureCubeData(e.data);break;case"2d-array":this.setTextureArrayData(e.data);break;case"cube-array":this.setTextureCubeArrayData(e.data);break;default:throw new Error(e.dimension)}this.mipmaps&&this.generateMipmap()}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}createView(e){return new Jl(this.device,{...e,texture:this})}setSampler(e={}){let t;e instanceof Hg?(this.sampler=e,t=e.props):(this.sampler=new Hg(this.device,e),t=e);const s=N0(t);this._setSamplerParameters(s)}generateMipmap(e){if(!(!(this.device.isTextureFormatRenderable(this.props.format)&&this.device.isTextureFormatFilterable(this.props.format))&&(ot.warn(`${this} is not renderable or filterable, may not be able to generate mipmaps`)(),!e?.force)))try{this.gl.bindTexture(this.glTarget,this.handle),this.gl.generateMipmap(this.glTarget)}catch(s){ot.warn(`Error generating mipmap for ${this}: ${s.message}`)()}finally{this.gl.bindTexture(this.glTarget,null)}}copyExternalImage(e){const t=Cr.getExternalImageSize(e.image),s={...Cr.defaultCopyExternalImageOptions,...t,...e},{image:a,depth:u,mipLevel:p,x:o,y:T,z:E,flipY:C}=s;let{width:O,height:$}=s;const{dimension:V,glTarget:ie,glFormat:we,glInternalFormat:Pe,glType:je}=this;if(O=Math.min(O,this.width-o),$=Math.min($,this.height-T),e.sourceX||e.sourceY)throw new Error("WebGL does not support sourceX/sourceY)");return gv(this.device.gl,this.handle,a,{dimension:V,mipLevel:p,x:o,y:T,z:E,width:O,height:$,depth:u,glFormat:we,glType:je,glTarget:ie,flipY:C}),{width:s.width,height:s.height}}setTexture1DData(e){throw new Error("setTexture1DData not supported in WebGL.")}setTexture2DData(e,t=0){this.bind();const s=Cr.normalizeTextureData(e,this);s.length>1&&this.props.mipmaps!==!1&&ot.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let a=0;a<s.length;a++){const u=s[a];this._setMipLevel(t,a,u)}this.unbind()}setTexture3DData(e){if(this.props.dimension!=="3d")throw new Error(this.id);ArrayBuffer.isView(e)&&(this.bind(),mv(this.device.gl,e,this),this.unbind())}setTextureCubeData(e,t=0){if(this.props.dimension!=="cube")throw new Error(this.id);for(const s of Cr.CubeFaces)this.setTextureCubeFaceData(e[s],s)}setTextureArrayData(e){throw this.props.dimension!=="2d-array"?new Error(this.id):new Error("setTextureArrayData not implemented.")}setTextureCubeArrayData(e){throw new Error("setTextureCubeArrayData not supported in WebGL2.")}setTextureCubeFaceData(e,t,s=0){Array.isArray(e)&&e.length>1&&this.props.mipmaps!==!1&&ot.warn(`${this.id} has mipmap and multiple LODs.`)();const a=Cr.CubeFaces.indexOf(t);this.setTexture2DData(e,a)}update(){throw new Error("Texture.update() not implemented. Use ExternalTexture")}setImageDataForFace(e){const{face:t,width:s,height:a,pixels:u,data:p,format:o=6408,type:T=5121}=e,{gl:E}=this,C=u||p;this.bind(),C instanceof Promise?C.then(O=>this.setImageDataForFace(Object.assign({},e,{face:t,data:O,pixels:O}))):this.width||this.height?E.texImage2D(t,0,o,s,a,0,o,T,C):E.texImage2D(t,0,o,o,T,C)}_getImageDataMap(e){for(let t=0;t<Cr.CubeFaces.length;++t){const s=Cr.CubeFaces[t];e[s]&&(e[34069+t]=e[s],delete e[s])}return e}_setSamplerParameters(e){ot.log(1,`${this.id} sampler parameters`,this.device.getGLKeys(e))(),this.gl.bindTexture(this.glTarget,this.handle);for(const[t,s]of Object.entries(e)){const a=Number(t),u=s;switch(a){case 33082:case 33083:this.gl.texParameterf(this.glTarget,a,u);break;case 10241:this.gl.texParameteri(this.glTarget,a,u);break;case 10242:case 10243:this.gl.texParameteri(this.glTarget,a,u);break;case 34046:this.device.features.has("texture-filterable-anisotropic-webgl")&&this.gl.texParameteri(this.glTarget,a,u);break;default:this.gl.texParameteri(this.glTarget,a,u);break}}this.gl.bindTexture(this.glTarget,null)}_setMipLevel(e,t,s,a=this.glTarget){if(Cr.isExternalImage(s)){gv(this.device.gl,this.handle,s,{...this,depth:e,mipLevel:t,glTarget:a,flipY:this.props.flipY});return}if(Cr.isTextureLevelData(s)){mv(this.device.gl,s.data,{...this,depth:e,mipLevel:t,glTarget:a});return}throw new Error("Texture: invalid image data")}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(e){const{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.glTarget,this.handle),e}unbind(e){const{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.glTarget,null),e}}const xR=[1,2,4,8];class wR extends Pa{device;glParameters;constructor(e,t){super(e,t),this.device=e;let s;if(!t?.parameters?.viewport)if(t?.framebuffer){const{width:u,height:p}=t.framebuffer;s=[0,0,u,p]}else{const[u,p]=e.getCanvasContext().getDrawingBufferSize();s=[0,0,u,p]}if(this.device.pushState(),this.setParameters({viewport:s,...this.props.parameters}),this.props.framebuffer?.handle)if(this.props.framebuffer){const u=this.props.framebuffer.colorAttachments.map((p,o)=>36064+o);this.device.gl.drawBuffers(u)}else this.device.gl.drawBuffers([1029]);this.clear()}end(){this.device.popState()}pushDebugGroup(e){}popDebugGroup(){}insertDebugMarker(e){}setParameters(e={}){const t={...this.glParameters};t.framebuffer=this.props.framebuffer||null,this.props.depthReadOnly&&(t.depthMask=!this.props.depthReadOnly),t.stencilMask=this.props.stencilReadOnly?0:1,t[35977]=this.props.discard,e.viewport&&(e.viewport.length>=6?(t.viewport=e.viewport.slice(0,4),t.depthRange=[e.viewport[4],e.viewport[5]]):t.viewport=e.viewport),e.scissorRect&&(t.scissorTest=!0,t.scissor=e.scissorRect),e.blendConstant&&(t.blendColor=e.blendConstant),e.stencilReference&&(console.warn("RenderPassParameters.stencilReference not yet implemented in WebGL"),e[2967]=e.stencilReference),e.colorMask&&(t.colorMask=xR.map(s=>!!(s&e.colorMask))),this.glParameters=t,fc(this.device.gl,t)}beginOcclusionQuery(e){this.props.occlusionQuerySet?.beginOcclusionQuery()}endOcclusionQuery(){this.props.occlusionQuerySet?.endOcclusionQuery()}clear(){const e={...this.glParameters};let t=0;this.props.clearColors&&this.props.clearColors.forEach((s,a)=>{s&&this.clearColorBuffer(a,s)}),this.props.clearColor!==!1&&this.props.clearColors===void 0&&(t|=16384,e.clearColor=this.props.clearColor),this.props.clearDepth!==!1&&(t|=256,e.clearDepth=this.props.clearDepth),this.props.clearStencil!==!1&&(t|=1024,e.clearStencil=this.props.clearStencil),t!==0&&of(this.device.gl,e,()=>{this.device.gl.clear(t)})}clearColorBuffer(e=0,t=[0,0,0,0]){of(this.device.gl,{framebuffer:this.props.framebuffer},()=>{switch(t.constructor){case Int8Array:case Int16Array:case Int32Array:this.device.gl.clearBufferiv(6144,e,t);break;case Uint8Array:case Uint8ClampedArray:case Uint16Array:case Uint32Array:this.device.gl.clearBufferuiv(6144,e,t);break;case Float32Array:this.device.gl.clearBufferfv(6144,e,t);break;default:throw new Error("clearColorBuffer: color must be typed array")}})}}function TR(r){return SR.includes(r)}const SR=[35678,35680,35679,35682,36289,36292,36293,36298,36299,36300,36303,36306,36307,36308,36311],j0={5126:[5126,1,"float","f32","float32"],35664:[5126,2,"vec2","vec2<f32>","float32x2"],35665:[5126,3,"vec3","vec3<f32>","float32x3"],35666:[5126,4,"vec4","vec4<f32>","float32x4"],5124:[5124,1,"int","i32","sint32"],35667:[5124,2,"ivec2","vec2<i32>","sint32x2"],35668:[5124,3,"ivec3","vec3<i32>","sint32x3"],35669:[5124,4,"ivec4","vec4<i32>","sint32x4"],5125:[5125,1,"uint","u32","uint32"],36294:[5125,2,"uvec2","vec2<u32>","uint32x2"],36295:[5125,3,"uvec3","vec3<u32>","uint32x3"],36296:[5125,4,"uvec4","vec4<u32>","uint32x4"],35670:[5126,1,"bool","f32","float32"],35671:[5126,2,"bvec2","vec2<f32>","float32x2"],35672:[5126,3,"bvec3","vec3<f32>","float32x3"],35673:[5126,4,"bvec4","vec4<f32>","float32x4"],35674:[5126,8,"mat2","mat2x2<f32>"],35685:[5126,8,"mat2x3","mat2x3<f32>"],35686:[5126,8,"mat2x4","mat2x4<f32>"],35687:[5126,12,"mat3x2","mat3x2<f32>"],35675:[5126,12,"mat3","mat3x3<f32>"],35688:[5126,12,"mat3x4","mat3x4<f32>"],35689:[5126,16,"mat4x2","mat4x2<f32>"],35690:[5126,16,"mat4x3","mat4x3<f32>"],35676:[5126,16,"mat4","mat4x4<f32>"]};function $0(r){const e=j0[r];if(!e)throw new Error("uniform");const[t,s,,a]=e;return{format:a,components:s,glType:t}}function AR(r){const e=j0[r];if(!e)throw new Error("attribute");const[,t,,s,a]=e;return{attributeType:s,vertexFormat:a,components:t}}function ER(r,e){const t={attributes:[],bindings:[]};t.attributes=IR(r,e);const s=MR(r,e);for(const o of s){const T=o.uniforms.map(E=>({name:E.name,format:E.format,byteOffset:E.byteOffset,byteStride:E.byteStride,arrayLength:E.arrayLength}));t.bindings.push({type:"uniform",name:o.name,group:0,location:o.location,visibility:(o.vertex?1:0)&(o.fragment?2:0),minBindingSize:o.byteLength,uniforms:T})}const a=PR(r,e);let u=0;for(const o of a)if(TR(o.type)){const{viewDimension:T,sampleType:E}=kR(o.type);t.bindings.push({type:"texture",name:o.name,group:0,location:u,viewDimension:T,sampleType:E}),o.textureUnit=u,u+=1}a.length&&(t.uniforms=a);const p=CR(r,e);return p?.length&&(t.varyings=p),t}function IR(r,e){const t=[],s=r.getProgramParameter(e,35721);for(let a=0;a<s;a++){const u=r.getActiveAttrib(e,a);if(!u)throw new Error("activeInfo");const{name:p,type:o}=u,T=r.getAttribLocation(e,p);if(T>=0){const{attributeType:E}=AR(o),C=/instance/i.test(p)?"instance":"vertex";t.push({name:p,location:T,stepMode:C,type:E})}}return t.sort((a,u)=>a.location-u.location),t}function CR(r,e){const t=[],s=r.getProgramParameter(e,35971);for(let a=0;a<s;a++){const u=r.getTransformFeedbackVarying(e,a);if(!u)throw new Error("activeInfo");const{name:p,type:o,size:T}=u,{glType:E,components:C}=$0(o),O={location:a,name:p,type:E,size:T*C};t.push(O)}return t.sort((a,u)=>a.location-u.location),t}function PR(r,e){const t=[],s=r.getProgramParameter(e,35718);for(let a=0;a<s;a++){const u=r.getActiveUniform(e,a);if(!u)throw new Error("activeInfo");const{name:p,size:o,type:T}=u,{name:E,isArray:C}=DR(p);let O=r.getUniformLocation(e,E);const $={location:O,name:E,size:o,type:T,isArray:C};if(t.push($),$.size>1)for(let V=0;V<$.size;V++){const ie=`${E}[${V}]`;O=r.getUniformLocation(e,ie);const we={...$,name:ie,location:O};t.push(we)}}return t}function MR(r,e){const t=(u,p)=>r.getActiveUniformBlockParameter(e,u,p),s=[],a=r.getProgramParameter(e,35382);for(let u=0;u<a;u++){const p={name:r.getActiveUniformBlockName(e,u)||"",location:t(u,35391),byteLength:t(u,35392),vertex:t(u,35396),fragment:t(u,35398),uniformCount:t(u,35394),uniforms:[]},o=t(u,35395)||[],T=r.getActiveUniforms(e,o,35383),E=r.getActiveUniforms(e,o,35384),C=r.getActiveUniforms(e,o,35387),O=r.getActiveUniforms(e,o,35388);for(let $=0;$<p.uniformCount;++$){const V=r.getActiveUniform(e,o[$]);if(!V)throw new Error("activeInfo");p.uniforms.push({name:V.name,format:$0(T[$]).format,type:T[$],arrayLength:E[$],byteOffset:C[$],byteStride:O[$]})}s.push(p)}return s.sort((u,p)=>u.location-p.location),s}const RR={35678:["2d","float"],35680:["cube","float"],35679:["3d","float"],35682:["3d","depth"],36289:["2d-array","float"],36292:["2d-array","depth"],36293:["cube","float"],36298:["2d","sint"],36299:["3d","sint"],36300:["cube","sint"],36303:["2d-array","uint"],36306:["2d","uint"],36307:["3d","uint"],36308:["cube","uint"],36311:["2d-array","uint"]};function kR(r){const e=RR[r];if(!e)throw new Error("sampler");const[t,s]=e;return{viewDimension:t,sampleType:s}}function DR(r){if(r[r.length-1]!=="]")return{name:r,length:1,isArray:!1};const t=/([^[]*)(\[[0-9]+\])?/.exec(r);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${r}`);return{name:t[1],length:t[2]?1:0,isArray:!!t[2]}}function OR(r,e,t,s){const a=r;let u=s;u===!0&&(u=1),u===!1&&(u=0);const p=typeof u=="number"?[u]:u;switch(t){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if(typeof s!="number")throw new Error("samplers must be set to integers");return r.uniform1i(e,s);case 5126:return r.uniform1fv(e,p);case 35664:return r.uniform2fv(e,p);case 35665:return r.uniform3fv(e,p);case 35666:return r.uniform4fv(e,p);case 5124:return r.uniform1iv(e,p);case 35667:return r.uniform2iv(e,p);case 35668:return r.uniform3iv(e,p);case 35669:return r.uniform4iv(e,p);case 35670:return r.uniform1iv(e,p);case 35671:return r.uniform2iv(e,p);case 35672:return r.uniform3iv(e,p);case 35673:return r.uniform4iv(e,p);case 5125:return a.uniform1uiv(e,p,1);case 36294:return a.uniform2uiv(e,p,2);case 36295:return a.uniform3uiv(e,p,3);case 36296:return a.uniform4uiv(e,p,4);case 35674:return r.uniformMatrix2fv(e,!1,p);case 35675:return r.uniformMatrix3fv(e,!1,p);case 35676:return r.uniformMatrix4fv(e,!1,p);case 35685:return a.uniformMatrix2x3fv(e,!1,p);case 35686:return a.uniformMatrix2x4fv(e,!1,p);case 35687:return a.uniformMatrix3x2fv(e,!1,p);case 35688:return a.uniformMatrix3x4fv(e,!1,p);case 35689:return a.uniformMatrix4x2fv(e,!1,p);case 35690:return a.uniformMatrix4x3fv(e,!1,p)}throw new Error("Illegal uniform")}function FR(r){return w0(r)!==null||typeof r=="number"||typeof r=="boolean"}function BR(r){const e={bindings:{},uniforms:{}};return Object.keys(r).forEach(t=>{const s=r[t];FR(s)?e.uniforms[t]=s:e.bindings[t]=s}),e}function LR(r){switch(r){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"triangle-list":return 4;case"triangle-strip":return 5;default:throw new Error(r)}}function NR(r){switch(r){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 1;case"triangle-list":return 4;case"triangle-strip":return 4;default:throw new Error(r)}}const _v=4;class zR extends ic{device;handle;vs;fs;introspectedLayout;uniforms={};bindings={};varyings=null;_uniformCount=0;_uniformSetters={};constructor(e,t){super(e,t),this.device=e,this.handle=this.props.handle||this.device.gl.createProgram(),this.device.setSpectorMetadata(this.handle,{id:this.props.id}),this.vs=t.vs,this.fs=t.fs;const{varyings:s,bufferMode:a=35981}=t;s&&s.length>0&&(this.varyings=s,this.device.gl.transformFeedbackVaryings(this.handle,s,a)),this._linkShaders(),ot.time(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=ER(this.device.gl,this.handle),ot.timeEnd(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=UR(this.introspectedLayout,t.shaderLayout)}destroy(){this.handle&&(this.device.gl.deleteProgram(this.handle),this.destroyed=!0)}setBindings(e,t){for(const[s,a]of Object.entries(e)){const u=this.shaderLayout.bindings.find(p=>p.name===s)||this.shaderLayout.bindings.find(p=>p.name===`${s}Uniforms`);if(!u){const p=this.shaderLayout.bindings.map(o=>`"${o.name}"`).join(", ");t?.disableWarnings||ot.warn(`No binding "${s}" in render pipeline "${this.id}", expected one of ${p}`,a)();continue}switch(a||ot.warn(`Unsetting binding "${s}" in render pipeline "${this.id}"`)(),u.type){case"uniform":if(!(a instanceof zh)&&!(a.buffer instanceof zh))throw new Error("buffer value");break;case"texture":if(!(a instanceof Jl||a instanceof Uh||a instanceof Nh))throw new Error("texture value");break;case"sampler":ot.warn(`Ignoring sampler ${s}`)();break;default:throw new Error(u.type)}this.bindings[s]=a}}draw(e){const{renderPass:t,parameters:s=this.props.parameters,topology:a=this.props.topology,vertexArray:u,vertexCount:p,instanceCount:o,isInstanced:T=!1,firstVertex:E=0,transformFeedback:C}=e,O=LR(a),$=!!u.indexBuffer,V=u.indexBuffer?.glIndexType;if(this.linkStatus!=="success")return ot.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable())return ot.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;this.device.gl.useProgram(this.handle),u.bindBeforeRender(t),C&&C.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const ie=t;return nR(this.device,s,ie.glParameters,()=>{$&&T?this.device.gl.drawElementsInstanced(O,p||0,V,E,o||0):$?this.device.gl.drawElements(O,p||0,V,E):T?this.device.gl.drawArraysInstanced(O,E,p||0,o||0):this.device.gl.drawArrays(O,E,p||0),C&&C.end()}),u.unbindAfterRender(t),!0}setUniformsWebGL(e){const{bindings:t}=BR(e);Object.keys(t).forEach(s=>{ot.warn(`Unsupported value "${JSON.stringify(t[s])}" used in setUniforms() for key ${s}. Use setBindings() instead?`)()}),Object.assign(this.uniforms,e)}async _linkShaders(){const{gl:e}=this.device;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),ot.time(_v,`linkProgram for ${this.id}`)(),e.linkProgram(this.handle),ot.timeEnd(_v,`linkProgram for ${this.id}`)(),ot.level,!this.device.features.has("compilation-status-async-webgl")){const s=this._getLinkStatus();this._reportLinkStatus(s);return}ot.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),ot.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const t=this._getLinkStatus();this._reportLinkStatus(t)}async _reportLinkStatus(e){switch(e){case"success":return;default:switch(this.vs.compilationStatus){case"error":throw this.vs.debugShader(),new Error(`Error during compilation of shader ${this.vs.id}`);case"pending":this.vs.asyncCompilationStatus.then(()=>this.vs.debugShader());break}switch(this.fs?.compilationStatus){case"error":throw this.fs.debugShader(),new Error(`Error during compilation of shader ${this.fs.id}`);case"pending":this.fs.asyncCompilationStatus.then(()=>this.fs.debugShader());break}const t=this.device.gl.getProgramInfoLog(this.handle);throw new Error(`Error during ${e}: ${t}`)}}_getLinkStatus(){const{gl:e}=this.device;return e.getProgramParameter(this.handle,35714)?(e.validateProgram(this.handle),e.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation")):(this.linkStatus="error","linking")}async _waitForLinkComplete(){const e=async a=>await new Promise(u=>setTimeout(u,a));if(!this.device.features.has("compilation-status-async-webgl")){await e(10);return}const{gl:s}=this.device;for(;;){if(s.getProgramParameter(this.handle,37297))return;await e(10)}}_areTexturesRenderable(){let e=!0;for(const t of this.shaderLayout.bindings)!this.bindings[t.name]&&!this.bindings[t.name.replace(/Uniforms$/,"")]&&(ot.warn(`Binding ${t.name} not found in ${this.id}`)(),e=!1);return e}_applyBindings(){if(this.linkStatus!=="success")return;const{gl:e}=this.device;e.useProgram(this.handle);let t=0,s=0;for(const a of this.shaderLayout.bindings){const u=this.bindings[a.name]||this.bindings[a.name.replace(/Uniforms$/,"")];if(!u)throw new Error(`No value for binding ${a.name} in ${this.id}`);switch(a.type){case"uniform":const{name:p}=a,o=e.getUniformBlockIndex(this.handle,p);if(o===4294967295)throw new Error(`Invalid uniform block name ${p}`);e.uniformBlockBinding(this.handle,s,o),u instanceof zh?e.bindBufferBase(35345,s,u.handle):e.bindBufferRange(35345,s,u.buffer.handle,u.offset||0,u.size||u.buffer.byteLength-u.offset),s+=1;break;case"texture":if(!(u instanceof Jl||u instanceof Uh||u instanceof Nh))throw new Error("texture");let T;if(u instanceof Jl)T=u.texture;else if(u instanceof Uh)T=u;else if(u instanceof Nh&&u.colorAttachments[0]instanceof Jl)ot.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),T=u.colorAttachments[0].texture;else throw new Error("No texture");e.activeTexture(33984+t),e.bindTexture(T.glTarget,T.handle),t+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${a.type}' not supported in WebGL`)}}}_applyUniforms(){for(const e of this.shaderLayout.uniforms||[]){const{name:t,location:s,type:a,textureUnit:u}=e,p=this.uniforms[t]??u;p!==void 0&&OR(this.device.gl,s,a,p)}}}function UR(r,e){const t={...r,attributes:r.attributes.map(s=>({...s}))};for(const s of e?.attributes||[]){const a=t.attributes.find(u=>u.name===s.name);a?(a.type=s.type||a.type,a.stepMode=s.stepMode||a.stepMode):ot.warn(`shader layout attribute ${s.name} not present in shader`)}return t}class VR extends hm{device;commands=[];constructor(e){super(e,{}),this.device=e}submitCommands(e=this.commands){for(const t of e)switch(t.name){case"copy-buffer-to-buffer":jR(this.device,t.options);break;case"copy-buffer-to-texture":$R(this.device,t.options);break;case"copy-texture-to-buffer":WR(this.device,t.options);break;case"copy-texture-to-texture":HR(this.device,t.options);break;default:throw new Error(t.name)}}}function jR(r,e){const t=e.sourceBuffer,s=e.destinationBuffer;r.gl.bindBuffer(36662,t.handle),r.gl.bindBuffer(36663,s.handle),r.gl.copyBufferSubData(36662,36663,e.sourceOffset??0,e.destinationOffset??0,e.size),r.gl.bindBuffer(36662,null),r.gl.bindBuffer(36663,null)}function $R(r,e){throw new Error("Not implemented")}function WR(r,e){const{sourceTexture:t,mipLevel:s=0,aspect:a="all",width:u=e.sourceTexture.width,height:p=e.sourceTexture.height,depthOrArrayLayers:o=0,origin:T=[0,0],destinationBuffer:E,byteOffset:C=0,bytesPerRow:O,rowsPerImage:$}=e;if(a!=="all")throw new Error("aspect not supported in WebGL");if(s!==0||o!==0||O||$)throw new Error("not implemented");const{framebuffer:V,destroyFramebuffer:ie}=W0(t);let we;try{const Pe=E,je=u||V.width,Ze=p||V.height,Le=F0(V.colorAttachments[0].texture.props.format),Ue=Le.format,et=Le.type;r.gl.bindBuffer(35051,Pe.handle),we=r.gl.bindFramebuffer(36160,V.handle),r.gl.readPixels(T[0],T[1],je,Ze,Ue,et,C)}finally{r.gl.bindBuffer(35051,null),we!==void 0&&r.gl.bindFramebuffer(36160,we),ie&&V.destroy()}}function HR(r,e){const{sourceTexture:t,destinationMipLevel:s=0,origin:a=[0,0],destinationOrigin:u=[0,0],destinationTexture:p}=e;let{width:o=e.destinationTexture.width,height:T=e.destinationTexture.height}=e;const{framebuffer:E,destroyFramebuffer:C}=W0(t),[O,$]=a,[V,ie,we]=u,Pe=r.gl.bindFramebuffer(36160,E.handle);let je=null,Ze;if(p instanceof Uh)je=p,o=Number.isFinite(o)?o:je.width,T=Number.isFinite(T)?T:je.height,je.bind(0),Ze=je.glTarget;else throw new Error("invalid destination");switch(Ze){case 3553:case 34067:r.gl.copyTexSubImage2D(Ze,s,V,ie,O,$,o,T);break;case 35866:case 32879:r.gl.copyTexSubImage3D(Ze,s,V,ie,we,O,$,o,T);break}je&&je.unbind(),r.gl.bindFramebuffer(36160,Pe),C&&E.destroy()}function W0(r){if(r instanceof Cr){const{width:e,height:t,id:s}=r;return{framebuffer:r.device.createFramebuffer({id:`framebuffer-for-${s}`,width:e,height:t,colorAttachments:[r]}),destroyFramebuffer:!0}}return{framebuffer:r,destroyFramebuffer:!1}}class ZR extends cm{device;commandBuffer;constructor(e,t){super(e,t),this.device=e,this.commandBuffer=new VR(e)}destroy(){}finish(){this.commandBuffer.submitCommands()}copyBufferToBuffer(e){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:e})}copyBufferToTexture(e){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:e})}copyTextureToBuffer(e){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:e})}copyTextureToTexture(e){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:e})}pushDebugGroup(e){}popDebugGroup(){}insertDebugMarker(e){}resolveQuerySet(e,t,s){}}function XR(r){const{target:e,source:t,start:s=0,count:a=1}=r,u=t.length,p=a*u;let o=0;for(let T=s;o<u;o++)e[T++]=t[o];for(;o<p;)o<p-o?(e.copyWithin(s+o,s,s+o),o*=2):(e.copyWithin(s+o,s,s+p-o),o=p);return r.target}class Lm extends um{get[Symbol.toStringTag](){return"VertexArray"}device;handle;buffer=null;bufferValue=null;static isConstantAttributeZeroSupported(e){return aT()==="Chrome"}constructor(e,t){super(e,t),this.device=e,this.handle=this.device.gl.createVertexArray()}destroy(){super.destroy(),this.buffer&&this.buffer?.destroy(),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(e){const t=e;if(t&&t.glTarget!==34963)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,t?t.handle:null),this.indexBuffer=t,this.device.gl.bindVertexArray(null)}setBuffer(e,t){const s=t;if(s.glTarget===34963)throw new Error("Use .setIndexBuffer()");const{size:a,type:u,stride:p,offset:o,normalized:T,integer:E,divisor:C}=this._getAccessor(e);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,s.handle),E?this.device.gl.vertexAttribIPointer(e,a,u,p,o):this.device.gl.vertexAttribPointer(e,a,u,T,p,o),this.device.gl.bindBuffer(34962,null),this.device.gl.enableVertexAttribArray(e),this.device.gl.vertexAttribDivisor(e,C||0),this.attributes[e]=s,this.device.gl.bindVertexArray(null)}setConstantWebGL(e,t){this._enable(e,!1),this.attributes[e]=t}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let e=0;e<this.maxVertexAttributes;++e){const t=this.attributes[e];ArrayBuffer.isView(t)&&this.device.setConstantAttributeWebGL(e,t)}}_getAccessor(e){const t=this.attributeInfos[e];if(!t)throw new Error(`Unknown attribute location ${e}`);const s=O0(t.bufferDataType);return{size:t.bufferComponents,type:s,stride:t.byteStride,offset:t.byteOffset,normalized:t.normalized,integer:t.integer,divisor:t.stepMode==="instance"?1:0}}_enable(e,t=!0){const a=Lm.isConstantAttributeZeroSupported(this.device)||e!==0;(t||a)&&(e=Number(e),this.device.gl.bindVertexArray(this.handle),t?this.device.gl.enableVertexAttribArray(e):this.device.gl.disableVertexAttribArray(e),this.device.gl.bindVertexArray(null))}getConstantBuffer(e,t){const s=qR(t),a=s.byteLength*e,u=s.length*e;if(this.buffer&&a!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${a} !== ${this.buffer.byteLength}.`);let p=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:a}),p=p||!YR(s,this.bufferValue),p){const o=XA(t.constructor,u);XR({target:o,source:s,start:0,count:u}),this.buffer.write(o),this.bufferValue=t}return this.buffer}}function qR(r){return Array.isArray(r)?new Float32Array(r):r}function YR(r,e){if(!r||!e||r.length!==e.length||r.constructor!==e.constructor)return!1;for(let t=0;t<r.length;++t)if(r[t]!==e[t])return!1;return!0}class GR extends dm{device;gl;handle;layout;buffers={};unusedBuffers={};bindOnUse=!0;_bound=!1;constructor(e,t){super(e,t),this.device=e,this.gl=e.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,t.buffers&&this.setBuffers(t.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(e="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback(NR(e))}end(){this.gl.endTransformFeedback(),this.bindOnUse&&this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(e){this.buffers={},this.unusedBuffers={},this.bind(()=>{for(const t in e)this.setBuffer(t,e[t])})}setBuffer(e,t){const s=this._getVaryingIndex(e),{buffer:a,byteLength:u,byteOffset:p}=this._getBufferRange(t);if(s<0){this.unusedBuffers[e]=a,ot.warn(`${this.id} unusedBuffers varying buffer ${e}`)();return}this.buffers[s]={buffer:a,byteLength:u,byteOffset:p},this.bindOnUse||this._bindBuffer(s,a,p,u)}getBuffer(e){if(yv(e))return this.buffers[e]||null;const t=this._getVaryingIndex(e);return t>=0?this.buffers[t]:null}bind(e=this.handle){if(typeof e!="function")return this.gl.bindTransformFeedback(36386,e),this;let t;return this._bound?t=e():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,t=e(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),t}unbind(){this.bind(null)}_getBufferRange(e){if(e instanceof zh)return{buffer:e,byteOffset:0,byteLength:e.byteLength};const{buffer:t,byteOffset:s=0,byteLength:a=e.buffer.byteLength}=e;return{buffer:t,byteOffset:s,byteLength:a}}_getVaryingIndex(e){if(yv(e))return Number(e);for(const t of this.layout.varyings)if(e===t.name)return t.location;return-1}_bindBuffers(){for(const e in this.buffers){const{buffer:t,byteLength:s,byteOffset:a}=this._getBufferRange(this.buffers[e]);this._bindBuffer(Number(e),t,a,s)}}_unbindBuffers(){for(const e in this.buffers)this.gl.bindBufferBase(35982,Number(e),null)}_bindBuffer(e,t,s=0,a){const u=t&&t.handle;!u||a===void 0?this.gl.bindBufferBase(35982,e,u):this.gl.bindBufferRange(35982,e,u,s,a)}}function yv(r){return typeof r=="number"?Number.isInteger(r):/^\d+$/.test(r)}class KR extends fm{device;handle;target=null;_queryPending=!1;_pollingPromise=null;get[Symbol.toStringTag](){return"Query"}constructor(e,t){if(super(e,t),this.device=e,t.count>1)throw new Error("WebGL QuerySet can only have one value");this.handle=this.device.gl.createQuery(),Object.seal(this)}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(e){return this._begin(e?.conservative?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(e){this._queryPending||(this.target=e,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const e=this.device.gl.getQueryParameter(this.handle,34919);return e&&(this._queryPending=!1),e}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(e=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let t=0;return this._pollingPromise=new Promise((s,a)=>{const u=()=>{this.isResultAvailable()?(s(this.getResult()),this._pollingPromise=null):t++>e?(a("Timed out"),this._pollingPromise=null):requestAnimationFrame(u)};requestAnimationFrame(u)}),this._pollingPromise}}class Ql extends Oo{type="webgl";handle;features;limits;info;canvasContext;lost;_resolveContextLost;gl;debug=!1;_canvasSizeInfo={clientWidth:0,clientHeight:0,devicePixelRatio:1};_extensions={};_polyfilled=!1;spectorJS;constructor(e){super({...e,id:e.id||QM("webgl-device")});const t=Oo._getCanvasContextProps(e);if(!t)throw new Error("WebGLDevice requires props.createCanvasContext to be set");let s=t.canvas?.gl?.device;if(s)throw new Error(`WebGL context already attached to device ${s.id}`);this.canvasContext=new jM(this,t),this.lost=new Promise(C=>{this._resolveContextLost=C});const a={...e.webgl};t.alphaMode==="premultiplied"&&(a.premultipliedAlpha=!0),e.powerPreference!==void 0&&(a.powerPreference=e.powerPreference);const p=this.props._handle||wM(this.canvasContext.canvas,{onContextLost:C=>this._resolveContextLost?.({reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."}),onContextRestored:C=>console.log("WebGL context restored")},a);if(!p)throw new Error("WebGL context creation failed");if(s=p.device,s){if(e._reuseDevices)return ot.log(1,`Not creating a new Device, instead returning a reference to Device ${s.id} already attached to WebGL context`,s)(),s._reused=!0,s;throw new Error(`WebGL context already attached to device ${s.id}`)}this.handle=p,this.gl=p,this.spectorJS=HM({...this.props,gl:this.handle}),this.gl.device=this,this.gl._version=2,this.info=TM(this.gl,this._extensions),this.limits=new zM(this.gl),this.features=new NM(this.gl,this._extensions,this.props._disabledFeatures),this.props._initializeFeatures&&this.features.initializeFeatures(),t.autoResize!==!1&&this.canvasContext.resize(),new Fa(this.gl,{log:(...C)=>ot.log(1,...C)()}).trackState(this.gl,{copyState:!1});const T=e.debugWebGL||e.debug,E=e.debugWebGL;T&&(this.gl=qM(this.gl,{debugWebGL:T,traceWebGL:E}),ot.warn("WebGL debug mode activated. Performance reduced.")(),e.debugWebGL&&(ot.level=Math.max(ot.level,1)))}destroy(){!this.props._reuseDevices&&!this._reused&&delete this.gl.device}get isLost(){return this.gl.isContextLost()}createCanvasContext(e){throw new Error("WebGL only supports a single canvas")}createBuffer(e){const t=this._normalizeBufferProps(e);return new zh(this,t)}createTexture(e){return new Uh(this,e)}createExternalTexture(e){throw new Error("createExternalTexture() not implemented")}createSampler(e){return new Hg(this,e)}createShader(e){return new iR(this,e)}createFramebuffer(e){return new Nh(this,e)}createVertexArray(e){return new Lm(this,e)}createTransformFeedback(e){return new GR(this,e)}createQuerySet(e){return new KR(this,e)}createRenderPipeline(e){return new zR(this,e)}beginRenderPass(e){return new wR(this,e)}createComputePipeline(e){throw new Error("ComputePipeline not supported in WebGL")}beginComputePass(e){throw new Error("ComputePass not supported in WebGL")}renderPass=null;createCommandEncoder(e={}){return new ZR(this,e)}submit(){this.renderPass?.end(),this.renderPass=null}readPixelsToArrayWebGL(e,t){return _R(e,t)}readPixelsToBufferWebGL(e,t){return yR(e,t)}setParametersWebGL(e){fc(this.gl,e)}getParametersWebGL(e){return k0(this.gl,e)}withParametersWebGL(e,t){return of(this.gl,e,t)}resetWebGL(){ot.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),_M(this.gl)}_getDeviceSpecificTextureFormatCapabilities(e){return OM(this.gl,e,this._extensions)}loseDevice(){let e=!1;const s=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return s&&(e=!0,s.loseContext()),this._resolveContextLost?.({reason:"destroyed",message:"Application triggered context loss"}),e}pushState(){Fa.get(this.gl).push()}popState(){Fa.get(this.gl).pop()}setSpectorMetadata(e,t){e.__SPECTOR_Metadata=t}getGLKey(e,t){const s=Number(e);for(const a in this.gl)if(this.gl[a]===s)return`GL.${a}`;return t?.emptyIfUnknown?"":String(e)}getGLKeys(e){const t={emptyIfUnknown:!0};return Object.entries(e).reduce((s,[a,u])=>(s[`${a}:${this.getGLKey(a,t)}`]=`${u}:${this.getGLKey(u,t)}`,s),{})}_constants;setConstantAttributeWebGL(e,t){const s=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(s).fill(null);const a=this._constants[e];switch(a&&tk(a,t)&&ot.info(1,`setConstantAttributeWebGL(${e}) could have been skipped, value unchanged`)(),this._constants[e]=t,t.constructor){case Float32Array:JR(this,e,t);break;case Int32Array:QR(this,e,t);break;case Uint32Array:ek(this,e,t);break;default:throw new Error("constant")}}getExtension(e){return hc(this.gl,e,this._extensions),this._extensions}}function JR(r,e,t){switch(t.length){case 1:r.gl.vertexAttrib1fv(e,t);break;case 2:r.gl.vertexAttrib2fv(e,t);break;case 3:r.gl.vertexAttrib3fv(e,t);break;case 4:r.gl.vertexAttrib4fv(e,t);break}}function QR(r,e,t){r.gl.vertexAttribI4iv(e,t)}function ek(r,e,t){r.gl.vertexAttribI4uiv(e,t)}function tk(r,e){if(!r||!e||r.length!==e.length||r.constructor!==e.constructor)return!1;for(let t=0;t<r.length;++t)if(r[t]!==e[t])return!1;return!0}const rk={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},ik=r=>({drawBuffersWEBGL(e){return r.drawBuffers(e)},COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067}),nk=r=>({VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES(){return r.createVertexArray()},deleteVertexArrayOES(e){return r.deleteVertexArray(e)},isVertexArrayOES(e){return r.isVertexArray(e)},bindVertexArrayOES(e){return r.bindVertexArray(e)}}),sk=r=>({VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE(...e){return r.drawArraysInstanced(...e)},drawElementsInstancedANGLE(...e){return r.drawElementsInstanced(...e)},vertexAttribDivisorANGLE(...e){return r.vertexAttribDivisor(...e)}});function ok(r=!0){const e=HTMLCanvasElement.prototype;if(!r&&e.originalGetContext){e.getContext=e.originalGetContext,e.originalGetContext=void 0;return}e.originalGetContext=e.getContext,e.getContext=function(t,s){if(t==="webgl"||t==="experimental-webgl"){const a=this.originalGetContext("webgl2",s);return a instanceof HTMLElement&&ak(a),a}return this.originalGetContext(t,s)}}function ak(r){r.getExtension("EXT_color_buffer_float");const e={...rk,WEBGL_disjoint_timer_query:r.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:ik(r),OES_vertex_array_object:nk(r),ANGLE_instanced_arrays:sk(r)},t=r.getExtension;r.getExtension=function(a){const u=t.call(r,a);return u||(a in e?e[a]:null)};const s=r.getSupportedExtensions;r.getSupportedExtensions=function(){return(s.apply(r)||[])?.concat(Object.keys(e))}}const Ed=1;class lk extends TA{type="webgl";constructor(){super(),Oo.defaultProps={...Oo.defaultProps,...Bm},Ql.adapter=this}isSupported(){return typeof WebGL2RenderingContext<"u"}enforceWebGL2(e){ok(e)}async attach(e){if(e instanceof Ql)return e;if(e?.device instanceof Oo)return e.device;if(!ck(e))throw new Error("Invalid WebGL2RenderingContext");return new Ql({_handle:e,createCanvasContext:{canvas:e.canvas,autoResize:!1}})}async create(e={}){ot.groupCollapsed(Ed,"WebGLDevice created")();const t=[];(e.debugWebGL||e.debug)&&t.push(XM()),e.debugSpectorJS&&t.push(WM(e));const s=await Promise.allSettled(t);for(const p of s)p.status==="rejected"&&ot.error(`Failed to initialize debug libraries ${p.reason}`)();const a=new Ql(e),u=`${a._reused?"Reusing":"Created"} device with WebGL2 ${a.debug?"debug ":""}context: ${a.info.vendor}, ${a.info.renderer} for canvas: ${a.canvasContext.id}`;return ot.probe(Ed,u)(),ot.table(Ed,a.info)(),ot.groupEnd(Ed)(),a}}function ck(r){return typeof WebGL2RenderingContext<"u"&&r instanceof WebGL2RenderingContext?!0:!!(r&&Number.isFinite(r._version))}const bv=new lk;function Co(){}const hk=({isDragging:r})=>r?"grabbing":"grab",H0={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:Co,onWebGLInitialized:Co,onResize:Co,onViewStateChange:Co,onInteractionStateChange:Co,onBeforeRender:Co,onAfterRender:Co,onLoad:Co,onError:r=>kr.error(r.message,r.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:hk,getTooltip:null,debug:!1,drawPickingColors:!1};class Kh{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new cf({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=s=>{const{_pickRequest:a}=this;if(s.type==="pointerleave")a.x=-1,a.y=-1,a.radius=0;else{if(s.leftButton||s.rightButton)return;{const u=s.offsetCenter;if(!u)return;a.x=u.x,a.y=u.y,a.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:a.x,y:a.y}),a.event=s},this._onEvent=s=>{const a=Bg[s.type],u=s.offsetCenter;if(!a||!u||!this.layerManager)return;const p=this.layerManager.getLayers(),o=this.deckPicker.getLastPickedObject({x:u.x,y:u.y,layers:p,viewports:this.getViewports(u)},this._lastPointerDownInfo),{layer:T}=o,E=T&&(T[a]||T.props[a]),C=this.props[a];let O=!1;E&&(O=E.call(T,o,s)),O||(C?.(o,s),this.widgetManager.onEvent(o,s))},this._onPointerDown=s=>{if(this.device?.type==="webgpu")return;const a=s.offsetCenter,u=this._pick("pickObject","pickObject Time",{x:a.x,y:a.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=u.result[0]||u.emptyInfo},this.props={...H0,...e},e=this.props,e.viewState&&e.initialViewState&&kr.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let t=this.device;!t&&e.gl&&(e.gl instanceof WebGLRenderingContext&&kr.error("WebGL1 context not supported.")(),t=bv.attach(e.gl)),t||(t=Eg.createDevice({type:"best-available",_reuseDevices:!0,adapters:[bv],...e.deviceProps,createCanvasContext:{canvas:this._createCanvas(e),useDevicePixels:this.props.useDevicePixels,autoResize:!1}})),this.animationLoop=this._createAnimationLoop(t,e),this.setProps(e),e._typedArrayManagerProps&&qh.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){this.animationLoop?.stop(),this.animationLoop?.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,this.layerManager?.finalize(),this.layerManager=null,this.viewManager?.finalize(),this.viewManager=null,this.effectManager?.finalize(),this.effectManager=null,this.deckRenderer?.finalize(),this.deckRenderer=null,this.deckPicker?.finalize(),this.deckPicker=null,this.eventManager?.destroy(),this.eventManager=null,this.widgetManager?.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&(this.canvas.parentElement?.removeChild(this.canvas),this.canvas=null)}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&kr.removed("onLayerHover","onHover")(),"onLayerClick"in e&&kr.removed("onLayerClick","onClick")(),e.initialViewState&&!ts(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop?.setProps(t),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t),this.widgetManager.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const s=this.viewManager.needsRedraw(e),a=this.layerManager.needsRedraw(e),u=this.effectManager.needsRedraw(e),p=this.deckRenderer.needsRedraw(e);return t=t||s||a||u||p,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return this.viewManager!==null}getViews(){return Pi(this.viewManager),this.viewManager.views}getViewports(e){return Pi(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(const s in e)this.layerManager.resourceManager.add({resourceId:s,data:e[s],forceUpdate:t})}_removeResources(e){for(const t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){this.layerManager?.removeDefaultShaderModule(e)}_pick(e,t,s){Pi(this.deckPicker);const{stats:a}=this;a.get("Pick Count").incrementCount(),a.get(t).timeStart();const u=this.deckPicker[e]({layers:this.layerManager.getLayers(s),views:this.viewManager.getViews(),viewports:this.getViewports(s),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...s});return a.get(t).timeEnd(),u}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),Pi(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){if(!this.canvas)return;const{width:t,height:s}=e;if(t||t===0){const a=Number.isFinite(t)?`${t}px`:t;this.canvas.style.width=a}if(s||s===0){const a=Number.isFinite(s)?`${s}px`:s;this.canvas.style.position=e.style?.position||"absolute",this.canvas.style.height=a}}_updateCanvasSize(){const{canvas:e}=this;if(!e)return;const t=e.clientWidth??e.width,s=e.clientHeight??e.height;(t!==this.width||s!==this.height)&&(this.width=t,this.height=s,this.viewManager?.setProps({width:t,height:s}),this.layerManager?.activateViewport(this.getViewports()[0]),this.props.onResize({width:t,height:s}))}_createAnimationLoop(e,t){const{gl:s,onError:a,useDevicePixels:u}=t;return new pP({device:e,useDevicePixels:u,autoResizeDrawingBuffer:!s,autoResizeViewport:!1,onInitialize:p=>this._setDevice(p.device),onRender:this._onRenderFrame.bind(this),onError:a})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:e}=this.props,t=Array.isArray(e)?e:e?[e]:[new km({id:"default-view"})];return t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){if(this.device?.type==="webgpu")return;const{_pickRequest:e}=this;if(e.event){const{result:t,emptyInfo:s}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=t.length>0;let a=s,u=!1;for(const p of t)a=p,u=p.layer?.onHover(p,e.event)||u;u||(this.props.onHover?.(a,e.event),this.widgetManager.onHover(a,e.event)),e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=this.device.canvasContext?.canvas),this.device.type==="webgl"&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device.type==="webgl"&&this.props.onWebGLInitialized(this.device.gl);const t=new x0;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new VI(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(Ub).map(a=>{const[u,p,o,T]=Ub[a],E=this.props.eventRecognizerOptions?.[a],C={...p,...E,event:a};return{recognizer:new u(C),recognizeWith:o,requestFailure:T}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const a in Bg)this.eventManager.on(a,this._onEvent);this.viewManager=new zP({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const s=this.viewManager.getViewports()[0];this.layerManager=new NP(this.device,{deck:this,stats:this.stats,viewport:s,timeline:t}),this.effectManager=new QP({deck:this,device:this.device}),this.deckRenderer=new rM(this.device),this.deckPicker=new lM(this.device),this.widgetManager=new uM({deck:this,parentElement:this.canvas?.parentElement}),this.widgetManager.addDefault(new fM),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){const{device:s,gl:a}=this.layerManager.context;this.props.onBeforeRender({device:s,gl:a});const u={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t};this.deckRenderer?.renderLayers(u),u.pass==="screen"&&this.widgetManager.onRedraw({viewports:u.viewports,layers:u.layers}),this.props.onAfterRender({device:s,gl:a})}_onRenderFrame(){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),kr.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),this.device?.type!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();const s=Eg.stats.get("Memory Usage");e.bufferMemory=s.get("Buffer Memory").count,e.textureMemory=s.get("Texture Memory").count,e.renderbufferMemory=s.get("Renderbuffer Memory").count,e.gpuMemory=s.get("GPU Memory").count}}Kh.defaultProps=H0;Kh.VERSION=CS;function uk(r){switch(r){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return Sx(r)}}const dk=Tx;function Id(r,e,t){const s=t==="webgpu"&&e.type==="uint8"?"unorm8":e.type;return{attribute:r,format:e.size>1?`${s}x${e.size}`:e.type,byteOffset:e.offset||0}}function Ra(r){return r.stride||r.size*r.bytesPerElement}function fk(r,e){return r.type===e.type&&r.size===e.size&&Ra(r)===Ra(e)&&(r.offset||0)===(e.offset||0)}function Zg(r,e){e.offset&&kr.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const t=Ra(r),s=e.vertexOffset!==void 0?e.vertexOffset:r.vertexOffset||0,a=e.elementOffset||0,u=s*t+a*r.bytesPerElement+(r.offset||0);return{...e,offset:u,stride:t}}function pk(r,e){const t=Zg(r,e);return{high:t,low:{...t,offset:t.offset+r.size*4}}}class gk{constructor(e,t,s){this._buffer=null,this.device=e,this.id=t.id||"",this.size=t.size||1;const a=t.logicalType||t.type,u=a==="float64";let{defaultValue:p}=t;p=Number.isFinite(p)?[p]:p||new Array(this.size).fill(0);let o;u?o="float32":!a&&t.isIndexed?o="uint32":o=a||"float32";let T=uk(a||o);this.doublePrecision=u,u&&t.fp64===!1&&(T=Float32Array),this.value=null,this.settings={...t,defaultType:T,defaultValue:p,logicalType:a,type:o,normalized:o.includes("norm"),size:this.size,bytesPerElement:T.BYTES_PER_ELEMENT},this.state={...s,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*Ra(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),qh.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,t=null){const s={};if(this.state.constant){const a=this.value;if(t){const u=Zg(this.getAccessor(),t),p=u.offset/a.BYTES_PER_ELEMENT,o=u.size||this.size;s[e]=a.subarray(p,p+o)}else s[e]=a}else s[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?s[`${e}64Low`]=s[e]:s[`${e}64Low`]=new Float32Array(this.size)),s}_getBufferLayout(e=this.id,t=null){const s=this.getAccessor(),a=[],u={name:this.id,byteStride:Ra(s),attributes:a};if(this.doublePrecision){const p=pk(s,t||{});a.push(Id(e,{...s,...p.high},this.device.type),Id(`${e}64Low`,{...s,...p.low},this.device.type))}else if(t){const p=Zg(s,t);a.push(Id(e,{...s,...p},this.device.type))}else a.push(Id(e,s,this.device.type));return u}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const t=Array.from(this.value);e=[t,t]}else{const{value:t,numInstances:s,size:a}=this,u=s*a;if(t&&u&&t.length>=u){const p=new Array(a).fill(1/0),o=new Array(a).fill(-1/0);for(let T=0;T<u;)for(let E=0;E<a;E++){const C=t[T++];C<p[E]&&(p[E]=C),C>o[E]&&(o[E]=C)}e=[p,o]}}return this.state.bounds=e,e}setData(e){const{state:t}=this;let s;ArrayBuffer.isView(e)?s={value:e}:e instanceof Ur?s={buffer:e}:s=e;const a={...this.settings,...s};if(ArrayBuffer.isView(s.value)){if(!s.type)if(this.doublePrecision&&s.value instanceof Float64Array)a.type="float32";else{const p=dk(s.value);a.type=a.normalized?p.replace("int","norm"):p}a.bytesPerElement=s.value.BYTES_PER_ELEMENT,a.stride=Ra(a)}if(t.bounds=null,s.constant){let u=s.value;if(u=this._normalizeValue(u,[],0),this.settings.normalized&&(u=this.normalizeConstant(u)),!(!t.constant||!this._areValuesEqual(u,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=ArrayBuffer.isView(u)?u:new Float32Array(u)}else if(s.buffer){const u=s.buffer;t.externalBuffer=u,t.constant=!1,this.value=s.value||null}else if(s.value){this._checkExternalBuffer(s);let u=s.value;t.externalBuffer=null,t.constant=!1,this.value=u;let{buffer:p}=this;const o=Ra(a),T=(a.vertexOffset||0)*o;if(this.doublePrecision&&u instanceof Float64Array&&(u=ng(u,a)),this.settings.isIndexed){const C=this.settings.defaultType;u.constructor!==C&&(u=new C(u))}const E=u.byteLength+T+o*2;(!p||p.byteLength<E)&&(p=this._createBuffer(E)),p.write(u,T)}return this.setAccessor(a),!0}updateSubBuffer(e={}){this.state.bounds=null;const t=this.value,{startOffset:s=0,endOffset:a}=e;this.buffer.write(this.doublePrecision&&t instanceof Float64Array?ng(t,{size:this.size,startIndex:s,endIndex:a}):t.subarray(s,a),s*t.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,t=!1){const{state:s}=this,a=s.allocatedValue,u=qh.allocate(a,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=u;const{byteOffset:p}=this;let{buffer:o}=this;return(!o||o.byteLength<u.byteLength+p)&&(o=this._createBuffer(u.byteLength+p),t&&a&&o.write(a instanceof Float64Array?ng(a,this):a,p)),s.allocatedValue=u,s.constant=!1,s.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){const{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error(`Attribute ${this.id} value is not TypedArray`);const s=this.settings.defaultType;let a=!1;if(this.doublePrecision&&(a=t.BYTES_PER_ELEMENT<4),a)throw new Error(`Attribute ${this.id} does not support ${t.constructor.name}`);!(t instanceof s)&&this.settings.normalized&&!("normalized"in e)&&kr.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(t=>(t+128)/255*2-1);case"snorm16":return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(t=>t/255);case"unorm16":return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,s){const{defaultValue:a,size:u}=this.settings;if(Number.isFinite(e))return t[s]=e,t;if(!e){let p=u;for(;--p>=0;)t[s+p]=a[p];return t}switch(u){case 4:t[s+3]=Number.isFinite(e[3])?e[3]:a[3];case 3:t[s+2]=Number.isFinite(e[2])?e[2]:a[2];case 2:t[s+1]=Number.isFinite(e[1])?e[1]:a[1];case 1:t[s+0]=Number.isFinite(e[0])?e[0]:a[0];break;default:let p=u;for(;--p>=0;)t[s+p]=Number.isFinite(e[p])?e[p]:a[p]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;const{size:s}=this;for(let a=0;a<s;a++)if(e[a]!==t[a])return!1;return!0}_createBuffer(e){this._buffer&&this._buffer.destroy();const{isIndexed:t,type:s}=this.settings;return this._buffer=this.device.createBuffer({...this._buffer?.props,id:this.id,usage:(t?Ur.INDEX:Ur.VERTEX)|Ur.COPY_DST,indexType:t?s:void 0,byteLength:e}),this._buffer}}const vv=[],xv=[];function mk(r,e=0,t=1/0){let s=vv;const a={index:-1,data:r,target:[]};return r?typeof r[Symbol.iterator]=="function"?s=r:r.length>0&&(xv.length=r.length,s=xv):s=vv,(e>0||Number.isFinite(t))&&(s=(Array.isArray(s)?s:Array.from(s)).slice(e,t),a.index=e-1),{iterable:s,objectInfo:a}}function Z0(r){return r&&r[Symbol.asyncIterator]}function _k(r,e){const{size:t,stride:s,offset:a,startIndices:u,nested:p}=e,o=r.BYTES_PER_ELEMENT,T=s?s/o:t,E=a?a/o:0,C=Math.floor((r.length-E)/T);return(O,{index:$,target:V})=>{if(!u){const je=$*T+E;for(let Ze=0;Ze<t;Ze++)V[Ze]=r[je+Ze];return V}const ie=u[$],we=u[$+1]||C;let Pe;if(p){Pe=new Array(we-ie);for(let je=ie;je<we;je++){const Ze=je*T+E;V=new Array(t);for(let Le=0;Le<t;Le++)V[Le]=r[Ze+Le];Pe[je-ie]=V}}else if(T===t)Pe=r.subarray(ie*t+E,we*t+E);else{Pe=new r.constructor((we-ie)*t);let je=0;for(let Ze=ie;Ze<we;Ze++){const Le=Ze*T+E;for(let Ue=0;Ue<t;Ue++)Pe[je++]=r[Le+Ue]}}return Pe}}const yk=[],zd=[[0,1/0]];function bk(r,e){if(r===zd||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return r;const t=[],s=r.length;let a=0;for(let u=0;u<s;u++){const p=r[u];p[1]<e[0]?(t.push(p),a=u+1):p[0]>e[1]?t.push(p):e=[Math.min(p[0],e[0]),Math.max(p[1],e[1])]}return t.splice(a,0,e),t}const vk={interpolation:{duration:0,easing:r=>r},spring:{stiffness:.05,damping:.5}};function X0(r,e){if(!r)return null;Number.isFinite(r)&&(r={type:"interpolation",duration:r});const t=r.type||"interpolation";return{...vk[t],...e,...r,type:t}}class q0 extends gk{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:zd}),this.constant=!1,this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var t;(t=this.state).layoutChanged||(t.layoutChanged=!fk(e,this.getAccessor())),super.setAccessor(e)}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:t}=this.settings,s=this.settings.transition,a=Array.isArray(t)?e[t.find(u=>e[u])]:e[t];return X0(a,s)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){const{startRow:s=0,endRow:a=1/0}=t;this.state.updateRanges=bk(this.state.updateRanges,[s,a])}else this.state.updateRanges=zd}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=yk}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:t,settings:s}=this;return s.noAlloc?!1:s.update?(super.allocate(e,t.updateRanges!==zd),!0):!1}updateBuffer({numInstances:e,data:t,props:s,context:a}){if(!this.needsUpdate())return!1;const{state:{updateRanges:u},settings:{update:p,noAlloc:o}}=this;let T=!0;if(p){for(const[E,C]of u)p.call(a,this,{data:t,startRow:E,endRow:C,props:s,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[E,C]of u){const O=Number.isFinite(E)?this.getVertexOffset(E):0,$=Number.isFinite(C)?this.getVertexOffset(C):o||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:O,endOffset:$})}this._checkAttributeArray()}else T=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),T}setConstantValue(e){return this.device.type==="webgpu"||e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){const{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){const{state:s,settings:a}=this;if(!e)return s.binaryValue=null,s.binaryAccessor=null,!1;if(a.noAlloc)return!1;if(s.binaryValue===e)return this.clearNeedsUpdate(),!0;if(s.binaryValue=e,this.setNeedsRedraw(),a.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const p=e;Pi(ArrayBuffer.isView(p.value),`invalid ${a.accessor}`);const o=!!p.size&&p.size!==this.size;return s.binaryAccessor=_k(p.value,{size:p.size||this.size,stride:p.stride,offset:p.offset,startIndices:t,nested:o}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getValue(){const e=this.settings.shaderAttributes,t=super.getValue();if(!e)return t;for(const s in e)Object.assign(t,super.getValue(s,e[s]));return t}getBufferLayout(e){this.state.layoutChanged=!1;const t=this.settings.shaderAttributes,s=super._getBufferLayout(),{stepMode:a}=this.settings;if(a==="dynamic"?s.stepMode=e?e.isInstanced?"instance":"vertex":"instance":s.stepMode=a??"vertex",!t)return s;for(const u in t){const p=super._getBufferLayout(u,t[u]);s.attributes.push(...p.attributes)}return s}_autoUpdater(e,{data:t,startRow:s,endRow:a,props:u,numInstances:p}){if(e.constant&&this.context.device.type!=="webgpu")return;const{settings:o,state:T,value:E,size:C,startIndices:O}=e,{accessor:$,transform:V}=o;let ie=T.binaryAccessor||(typeof $=="function"?$:u[$]);typeof ie!="function"&&(ie=()=>ie),Pi(typeof ie=="function",`accessor "${$}" is not a function`);let we=e.getVertexOffset(s);const{iterable:Pe,objectInfo:je}=mk(t,s,a);for(const Ze of Pe){je.index++;let Le=ie(Ze,je);if(V&&(Le=V.call(this,Le)),O){const Ue=(je.index<O.length-1?O[je.index+1]:p)-O[je.index];if(Le&&Array.isArray(Le[0])){let et=we;for(const Ke of Le)e._normalizeValue(Ke,E,et),et+=C}else Le&&Le.length>C?E.set(Le,we):(e._normalizeValue(Le,je.target,0),DP({target:E,source:je.target,start:we,count:Ue}));we+=Ue*C}else e._normalizeValue(Le,E,we),we+=C}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){const{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let s=!0;switch(t){case 4:s=s&&Number.isFinite(e[3]);case 3:s=s&&Number.isFinite(e[2]);case 2:s=s&&Number.isFinite(e[1]);case 1:s=s&&Number.isFinite(e[0]);break;default:s=!1}if(!s)throw new Error(`Illegal attribute generated for ${this.id}`)}}}function pg(r){const{source:e,target:t,start:s=0,size:a,getData:u}=r,p=r.end||t.length,o=e.length,T=p-s;if(o>T){t.set(e.subarray(0,T),s);return}if(t.set(e,s),!u)return;let E=o;for(;E<T;){const C=u(E,e);for(let O=0;O<a;O++)t[s+E]=C[O]||0,E++}}function xk({source:r,target:e,size:t,getData:s,sourceStartIndices:a,targetStartIndices:u}){if(!a||!u)return pg({source:r,target:e,size:t,getData:s}),e;let p=0,o=0;const T=s&&((C,O)=>s(C+o,O)),E=Math.min(a.length,u.length);for(let C=1;C<E;C++){const O=a[C]*t,$=u[C]*t;pg({source:r.subarray(p,O),target:e,start:o,end:$,size:t,getData:T}),p=O,o=$}return o<e.length&&pg({source:[],target:e,start:o,size:t,getData:T}),e}function wk(r){const{device:e,settings:t,value:s}=r,a=new q0(e,t);return a.setData({value:s instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:t.normalized}),a}function Y0(r){switch(r){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${r}"`)}}function G0(r){switch(r){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function K0(r){r.push(r.shift())}function Tk(r,e){const{doublePrecision:t,settings:s,value:a,size:u}=r,p=t&&a instanceof Float64Array?2:1;let o=0;const{shaderAttributes:T}=r.settings;if(T)for(const E of Object.values(T))o=Math.max(o,E.vertexOffset??0);return(s.noAlloc?a.length:(e+o)*u)*p}function J0({device:r,source:e,target:t}){return(!t||t.byteLength<e.byteLength)&&(t?.destroy(),t=r.createBuffer({byteLength:e.byteLength,usage:e.usage})),t}function Q0({device:r,buffer:e,attribute:t,fromLength:s,toLength:a,fromStartIndices:u,getData:p=o=>o}){const o=t.doublePrecision&&t.value instanceof Float64Array?2:1,T=t.size*o,E=t.byteOffset,C=t.settings.bytesPerElement<4?E/t.settings.bytesPerElement*4:E,O=t.startIndices,$=u&&O,V=t.isConstant;if(!$&&e&&s>=a)return e;const ie=t.value instanceof Float64Array?Float32Array:t.value.constructor,we=V?t.value:new ie(t.getBuffer().readSyncWebGL(E,a*ie.BYTES_PER_ELEMENT).buffer);if(t.settings.normalized&&!V){const Le=p;p=(Ue,et)=>t.normalizeConstant(Le(Ue,et))}const Pe=V?(Le,Ue)=>p(we,Ue):(Le,Ue)=>p(we.subarray(Le+E,Le+E+T),Ue),je=e?new Float32Array(e.readSyncWebGL(C,s*4).buffer):new Float32Array(0),Ze=new Float32Array(a);return xk({source:je,target:Ze,sourceStartIndices:u,targetStartIndices:O,size:T,getData:Pe}),(!e||e.byteLength<Ze.byteLength+C)&&(e?.destroy(),e=r.createBuffer({byteLength:Ze.byteLength+C,usage:35050})),e.write(Ze,C),e}class ew{constructor({device:e,attribute:t,timeline:s}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new _f(s),this.attribute=t,this.attributeInTransition=wk(t),this.currentStartIndices=t.startIndices}get inProgress(){return this.transition.inProgress}start(e,t,s=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=Tk(this.attribute,t),this.transition.start({...e,duration:s})}update(){const e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const e of this.buffers)e.destroy();this.buffers.length=0}}class Sk extends ew{constructor({device:e,attribute:t,timeline:s}){super({device:e,attribute:t,timeline:s}),this.type="interpolation",this.transform=Ck(e,t)}start(e,t){const s=this.currentLength,a=this.currentStartIndices;if(super.start(e,t,e.duration),e.duration<=0){this.transition.cancel();return}const{buffers:u,attribute:p}=this;K0(u),u[0]=Q0({device:this.device,buffer:u[0],attribute:p,fromLength:s,toLength:this.currentLength,fromStartIndices:a,getData:e.enter}),u[1]=J0({device:this.device,source:u[0],target:u[1]}),this.setBuffer(u[1]);const{transform:o}=this,T=o.model;let E=Math.floor(this.currentLength/p.size);tw(p)&&(E/=2),T.setVertexCount(E),p.isConstant?(T.setAttributes({aFrom:u[0]}),T.setConstantAttributes({aTo:p.value})):T.setAttributes({aFrom:u[0],aTo:p.getBuffer()}),o.transformFeedback.setBuffers({vCurrent:u[1]})}onUpdate(){const{duration:e,easing:t}=this.settings,{time:s}=this.transition;let a=s/e;t&&(a=t(a));const{model:u}=this.transform,p={time:a};u.shaderInputs.setProps({interpolation:p}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}}const Ak=`uniform interpolationUniforms {
  float time;
} interpolation;
`,wv={name:"interpolation",vs:Ak,uniformTypes:{time:"f32"}},Ek=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,Ik=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function tw(r){return r.doublePrecision&&r.value instanceof Float64Array}function Ck(r,e){const t=e.size,s=Y0(t),a=G0(t),u=e.getBufferLayout();return tw(e)?new cc(r,{vs:Ik,bufferLayout:[{name:"aFrom",byteStride:8*t,attributes:[{attribute:"aFrom",format:a,byteOffset:0},{attribute:"aFrom64Low",format:a,byteOffset:4*t}]},{name:"aTo",byteStride:8*t,attributes:[{attribute:"aTo",format:a,byteOffset:0},{attribute:"aTo64Low",format:a,byteOffset:4*t}]}],modules:[R3,wv],defines:{ATTRIBUTE_TYPE:s,ATTRIBUTE_SIZE:t},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new cc(r,{vs:Ek,bufferLayout:[{name:"aFrom",format:a},{name:"aTo",format:u.attributes[0].format}],modules:[wv],defines:{ATTRIBUTE_TYPE:s},varyings:["vCurrent"],disableWarnings:!0})}class Pk extends ew{constructor({device:e,attribute:t,timeline:s}){super({device:e,attribute:t,timeline:s}),this.type="spring",this.texture=Fk(e),this.framebuffer=Bk(e,this.texture),this.transform=Ok(e,t)}start(e,t){const s=this.currentLength,a=this.currentStartIndices;super.start(e,t);const{buffers:u,attribute:p}=this;for(let T=0;T<2;T++)u[T]=Q0({device:this.device,buffer:u[T],attribute:p,fromLength:s,toLength:this.currentLength,fromStartIndices:a,getData:e.enter});u[2]=J0({device:this.device,source:u[0],target:u[2]}),this.setBuffer(u[1]);const{model:o}=this.transform;o.setVertexCount(Math.floor(this.currentLength/p.size)),p.isConstant?o.setConstantAttributes({aTo:p.value}):o.setAttributes({aTo:p.getBuffer()})}onUpdate(){const{buffers:e,transform:t,framebuffer:s,transition:a}=this,u=this.settings;t.model.setAttributes({aPrev:e[0],aCur:e[1]}),t.transformFeedback.setBuffers({vNext:e[2]});const p={stiffness:u.stiffness,damping:u.damping};t.model.shaderInputs.setProps({spring:p}),t.run({framebuffer:s,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),K0(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(s)[0]>0||a.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}const Mk=`uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,Rk={name:"spring",vs:Mk,uniformTypes:{damping:"f32",stiffness:"f32"}},kk=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,Dk=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`;function Ok(r,e){const t=Y0(e.size),s=G0(e.size);return new cc(r,{vs:kk,fs:Dk,bufferLayout:[{name:"aPrev",format:s},{name:"aCur",format:s},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[Rk],defines:{ATTRIBUTE_TYPE:t},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}function Fk(r){return r.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1})}function Bk(r,e){return r.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[e]})}const Lk={interpolation:Sk,spring:Pk};class Nk{constructor(e,{id:t,timeline:s}){if(!e)throw new Error("AttributeTransitionManager is constructed without device");this.id=t,this.device=e,this.timeline=s,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:s}){this.numInstances=s||1;for(const a in e){const u=e[a],p=u.getTransitionSetting(t);p&&this._updateAttribute(a,u,p)}for(const a in this.transitions){const u=e[a];(!u||!u.getTransitionSetting(t))&&this._removeTransition(a)}}hasAttribute(e){const t=this.transitions[e];return t&&t.inProgress}getAttributes(){const e={};for(const t in this.transitions){const s=this.transitions[t];s.inProgress&&(e[t]=s.attributeInTransition)}return e}run(){if(this.numInstances===0)return!1;for(const t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,t,s){const a=this.transitions[e];let u=!a||a.type!==s.type;if(u){a&&this._removeTransition(e);const p=Lk[s.type];p?this.transitions[e]=new p({attribute:t,timeline:this.timeline,device:this.device}):(kr.error(`unsupported transition type '${s.type}'`)(),u=!1)}(u||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(s,this.numInstances))}}const Tv="attributeManager.invalidate",zk="attributeManager.updateStart",Uk="attributeManager.updateEnd",Vk="attribute.updateStart",jk="attribute.allocate",$k="attribute.updateEnd";class Wk{constructor(e,{id:t="attribute-manager",stats:s,timeline:a}={}){this.mergeBoundsMemoized=ru(tP),this.id=t,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=s,this.attributeTransitionManager=new Nk(e,{id:`${t}-transitions`,timeline:a}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(const t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){const s=this._invalidateTrigger(e,t);cn(Tv,this,e,s)}invalidateAll(e){for(const t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);cn(Tv,this,"all")}update({data:e,numInstances:t,startIndices:s=null,transitions:a,props:u={},buffers:p={},context:o={}}){let T=!1;cn(zk,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const E in this.attributes){const C=this.attributes[E],O=C.settings.accessor;C.startIndices=s,C.numInstances=t,u[E]&&kr.removed(`props.${E}`,`data.attributes.${E}`)(),C.setExternalBuffer(p[E])||C.setBinaryValue(typeof O=="string"?p[O]:void 0,e.startIndices)||typeof O=="string"&&!p[O]&&C.setConstantValue(u[O])||C.needsUpdate()&&(T=!0,this._updateAttribute({attribute:C,numInstances:t,data:e,props:u,context:o})),this.needsRedraw=this.needsRedraw||C.needsRedraw()}T&&cn(Uk,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:a})}updateTransition(){const{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){const t=e.map(s=>this.attributes[s]?.getBounds());return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:t,attributeTransitionManager:s}=this,a={...s.getAttributes()};for(const u in t){const p=t[u];p.needsRedraw(e)&&!s.hasAttribute(u)&&(a[u]=p)}return a}getBufferLayouts(e){return Object.values(this.getAttributes()).map(t=>t.getBufferLayout(e))}_add(e,t){for(const s in e){const a=e[s],u={...a,id:s,size:a.isIndexed&&1||a.size||1,...t};this.attributes[s]=new q0(this.device,u)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){const e={};for(const t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(a=>{e[a]||(e[a]=[]),e[a].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){const{attributes:s,updateTriggers:a}=this,u=a[e];return u&&u.forEach(p=>{const o=s[p];o&&o.setNeedsUpdate(o.id,t)}),u}_updateAttribute(e){const{attribute:t,numInstances:s}=e;if(cn(Vk,t),t.constant){t.setConstantValue(t.value);return}t.allocate(s)&&cn(jk,t,s),t.updateBuffer(e)&&(this.needsRedraw=!0,cn($k,t,s))}}class Hk extends _f{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:t,toValue:s,duration:a,easing:u}}=this,p=u(e/a);this._value=ef(t,s,p)}}const Sv=1e-5;function Av(r,e,t,s,a){const u=e-r,o=(t-e)*a,T=-u*s;return o+T+u+e}function Zk(r,e,t,s,a){if(Array.isArray(t)){const u=[];for(let p=0;p<t.length;p++)u[p]=Av(r[p],e[p],t[p],s,a);return u}return Av(r,e,t,s,a)}function Ev(r,e){if(Array.isArray(r)){let t=0;for(let s=0;s<r.length;s++){const a=r[s]-e[s];t+=a*a}return Math.sqrt(t)}return Math.abs(r-e)}class Xk extends _f{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:t,damping:s,stiffness:a}=this.settings,{_prevValue:u=e,_currValue:p=e}=this;let o=Zk(u,p,t,s,a);const T=Ev(o,t),E=Ev(o,p);T<Sv&&E<Sv&&(o=t,this.end()),this._prevValue=p,this._currValue=o}}const qk={interpolation:Hk,spring:Xk};class Yk{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,s,a){const{transitions:u}=this;if(u.has(e)){const T=u.get(e),{value:E=T.settings.fromValue}=T;t=E,this.remove(e)}if(a=X0(a),!a)return;const p=qk[a.type];if(!p){kr.error(`unsupported transition type '${a.type}'`)();return}const o=new p(this.timeline);o.start({...a,fromValue:t,toValue:s}),u.set(e,o)}remove(e){const{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){const e={};for(const[t,s]of this.transitions)s.update(),e[t]=s.value,s.inProgress||this.remove(t);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function Gk(r){const e=r[Oa];for(const t in e){const s=e[t],{validate:a}=s;if(a&&!a(r[t],s))throw new Error(`Invalid prop ${t}: ${r[t]}`)}}function Kk(r,e){const t=rw({newProps:r,oldProps:e,propTypes:r[Oa],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),s=Qk(r,e);let a=!1;return s||(a=eD(r,e)),{dataChanged:s,propsChanged:t,updateTriggersChanged:a,extensionsChanged:tD(r,e),transitionsChanged:Jk(r,e)}}function Jk(r,e){if(!r.transitions)return!1;const t={},s=r[Oa];let a=!1;for(const u in r.transitions){const p=s[u],o=p&&p.type;(o==="number"||o==="color"||o==="array")&&Xg(r[u],e[u],p)&&(t[u]=!0,a=!0)}return a?t:!1}function rw({newProps:r,oldProps:e,ignoreProps:t={},propTypes:s={},triggerName:a="props"}){if(e===r)return!1;if(typeof r!="object"||r===null)return`${a} changed shallowly`;if(typeof e!="object"||e===null)return`${a} changed shallowly`;for(const u of Object.keys(r))if(!(u in t)){if(!(u in e))return`${a}.${u} added`;const p=Xg(r[u],e[u],s[u]);if(p)return`${a}.${u} ${p}`}for(const u of Object.keys(e))if(!(u in t)){if(!(u in r))return`${a}.${u} dropped`;if(!Object.hasOwnProperty.call(r,u)){const p=Xg(r[u],e[u],s[u]);if(p)return`${a}.${u} ${p}`}}return!1}function Xg(r,e,t){let s=t&&t.equal;return s&&!s(r,e,t)||!s&&(s=r&&e&&r.equals,s&&!s.call(r,e))?"changed deeply":!s&&e!==r?"changed shallowly":null}function Qk(r,e){if(e===null)return"oldProps is null, initial diff";let t=!1;const{dataComparator:s,_dataDiff:a}=r;return s?s(r.data,e.data)||(t="Data comparator detected a change"):r.data!==e.data&&(t="A new data container was supplied"),t&&a&&(t=a(r.data,e.data)||t),t}function eD(r,e){if(e===null)return{all:!0};if("all"in r.updateTriggers&&Iv(r,e,"all"))return{all:!0};const t={};let s=!1;for(const a in r.updateTriggers)a!=="all"&&Iv(r,e,a)&&(t[a]=!0,s=!0);return s?t:!1}function tD(r,e){if(e===null)return!0;const t=e.extensions,{extensions:s}=r;if(s===t)return!1;if(!t||!s||s.length!==t.length)return!0;for(let a=0;a<s.length;a++)if(!s[a].equals(t[a]))return!0;return!1}function Iv(r,e,t){let s=r.updateTriggers[t];s=s??{};let a=e.updateTriggers[t];return a=a??{},rw({oldProps:a,newProps:s,triggerName:t})}const rD="count(): argument not an object",iD="count(): argument not a container";function nD(r){if(!oD(r))throw new Error(rD);if(typeof r.count=="function")return r.count();if(Number.isFinite(r.size))return r.size;if(Number.isFinite(r.length))return r.length;if(sD(r))return Object.keys(r).length;throw new Error(iD)}function sD(r){return r!==null&&typeof r=="object"&&r.constructor===Object}function oD(r){return r!==null&&typeof r=="object"}function Cv(r,e){if(!e)return r;const t={...r,...e};if("defines"in e&&(t.defines={...r.defines,...e.defines}),"modules"in e&&(t.modules=(r.modules||[]).concat(e.modules),e.modules.some(s=>s.name==="project64"))){const s=t.modules.findIndex(a=>a.name==="project32");s>=0&&t.modules.splice(s,1)}if("inject"in e)if(!r.inject)t.inject=e.inject;else{const s={...r.inject};for(const a in e.inject)s[a]=(s[a]||"")+e.inject[a];t.inject=s}return t}const aD={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},qg={};function lD(r,e,t,s){if(t instanceof Cr)return t;t.constructor&&t.constructor.name!=="Object"&&(t={data:t});let a=null;t.compressed&&(a={minFilter:"linear",mipmapFilter:t.data.length>1?"nearest":"linear"});const u=e.createTexture({...t,sampler:{...aD,...a,...s},mipmaps:!0});return qg[u.id]=r,u}function cD(r,e){!e||!(e instanceof Cr)||qg[e.id]===r&&(e.delete(),delete qg[e.id])}const hD={boolean:{validate(r,e){return!0},equal(r,e,t){return!!r==!!e}},number:{validate(r,e){return Number.isFinite(r)&&(!("max"in e)||r<=e.max)&&(!("min"in e)||r>=e.min)}},color:{validate(r,e){return e.optional&&!r||Yg(r)&&(r.length===3||r.length===4)},equal(r,e,t){return ts(r,e,1)}},accessor:{validate(r,e){const t=af(r);return t==="function"||t===af(e.value)},equal(r,e,t){return typeof e=="function"?!0:ts(r,e,1)}},array:{validate(r,e){return e.optional&&!r||Yg(r)},equal(r,e,t){const{compare:s}=t,a=Number.isInteger(s)?s:s?1:0;return s?ts(r,e,a):r===e}},object:{equal(r,e,t){if(t.ignore)return!0;const{compare:s}=t,a=Number.isInteger(s)?s:s?1:0;return s?ts(r,e,a):r===e}},function:{validate(r,e){return e.optional&&!r||typeof r=="function"},equal(r,e,t){return!t.compare&&t.ignore!==!1||r===e}},data:{transform:(r,e,t)=>{if(!r)return r;const{dataTransform:s}=t.props;return s?s(r):typeof r.shape=="string"&&r.shape.endsWith("-table")&&Array.isArray(r.data)?r.data:r}},image:{transform:(r,e,t)=>{const s=t.context;return!s||!s.device?null:lD(t.id,s.device,r,{...e.parameters,...t.props.textureParameters})},release:(r,e,t)=>{cD(t.id,r)}}};function uD(r){const e={},t={},s={};for(const[a,u]of Object.entries(r)){const p=u?.deprecatedFor;if(p)s[a]=Array.isArray(p)?p:[p];else{const o=dD(a,u);e[a]=o,t[a]=o.value}}return{propTypes:e,defaultProps:t,deprecatedProps:s}}function dD(r,e){switch(af(e)){case"object":return Ch(r,e);case"array":return Ch(r,{type:"array",value:e,compare:!1});case"boolean":return Ch(r,{type:"boolean",value:e});case"number":return Ch(r,{type:"number",value:e});case"function":return Ch(r,{type:"function",value:e,compare:!0});default:return{name:r,type:"unknown",value:e}}}function Ch(r,e){return"type"in e?{name:r,...hD[e.type],...e}:"value"in e?{name:r,type:af(e.value),...e}:{name:r,type:"object",value:e}}function Yg(r){return Array.isArray(r)||ArrayBuffer.isView(r)}function af(r){return Yg(r)?"array":r===null?"null":typeof r}function fD(r,e){let t;for(let u=e.length-1;u>=0;u--){const p=e[u];"extensions"in p&&(t=p.extensions)}const s=Gg(r.constructor,t),a=Object.create(s);a[sf]=r,a[Ua]={},a[Do]={};for(let u=0;u<e.length;++u){const p=e[u];for(const o in p)a[o]=p[o]}return Object.freeze(a),a}const pD="_mergedDefaultProps";function Gg(r,e){if(!(r instanceof yf.constructor))return{};let t=pD;if(e)for(const a of e){const u=a.constructor;u&&(t+=`:${u.extensionName||u.name}`)}const s=iw(r,t);return s||(r[t]=gD(r,e||[]))}function gD(r,e){if(!r.prototype)return null;const s=Object.getPrototypeOf(r),a=Gg(s),u=iw(r,"defaultProps")||{},p=uD(u),o=Object.assign(Object.create(null),a,p.defaultProps),T=Object.assign(Object.create(null),a?.[Oa],p.propTypes),E=Object.assign(Object.create(null),a?.[cg],p.deprecatedProps);for(const C of e){const O=Gg(C.constructor);O&&(Object.assign(o,O),Object.assign(T,O[Oa]),Object.assign(E,O[cg]))}return mD(o,r),yD(o,T),_D(o,E),o[Oa]=T,o[cg]=E,e.length===0&&!Nm(r,"_propTypes")&&(r._propTypes=T),o}function mD(r,e){const t=vD(e);Object.defineProperties(r,{id:{writable:!0,value:t}})}function _D(r,e){for(const t in e)Object.defineProperty(r,t,{enumerable:!1,set(s){const a=`${this.id}: ${t}`;for(const u of e[t])Nm(this,u)||(this[u]=s);kr.deprecated(a,e[t].join("/"))()}})}function yD(r,e){const t={},s={};for(const a in e){const u=e[a],{name:p,value:o}=u;u.async&&(t[p]=o,s[p]=bD(p))}r[rc]=t,r[Ua]={},Object.defineProperties(r,s)}function bD(r){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||Z0(e)?this[Ua][r]=e:this[Do][r]=e},get(){if(this[Do]){if(r in this[Do])return this[Do][r]||this[rc][r];if(r in this[Ua]){const e=this[sf]&&this[sf].internalState;if(e&&e.hasAsyncProp(r))return e.getAsyncProp(r)||this[rc][r]}}return this[rc][r]}}}function Nm(r,e){return Object.prototype.hasOwnProperty.call(r,e)}function iw(r,e){return Nm(r,e)&&r[e]}function vD(r){const e=r.componentName;return e||kr.warn(`${r.name}.componentName not specified`)(),e||r.name}let xD=0;class yf{constructor(...e){this.props=fD(this,e),this.id=this.props.id,this.count=xD++}clone(e){const{props:t}=this,s={};for(const a in t[rc])a in t[Do]?s[a]=t[Do][a]:a in t[Ua]&&(s[a]=t[Ua][a]);return new this.constructor({...t,...s,...e})}}yf.componentName="Component";yf.defaultProps={};const wD=Object.freeze({});class TD{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||wD}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){const t=this.asyncProps[e];return!!(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(const t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[sf]||this.component;const t=e[Do]||{},s=e[Ua]||e,a=e[rc]||{};for(const u in t){const p=t[u];this._createAsyncPropData(u,a[u]),this._updateAsyncProp(u,p),t[u]=this.getAsyncProp(u)}for(const u in s){const p=s[u];this._createAsyncPropData(u,a[u]),this._updateAsyncProp(u,p)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(Z0(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){const s=this.asyncProps[e];return t===s.resolvedValue||t===s.lastValue?!1:(s.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();const s=this.asyncProps[e];s&&(t=this._postProcessValue(s,t),s.resolvedValue=t,s.pendingLoadCount++,s.resolvedLoadCount=s.pendingLoadCount)}_setAsyncPropValue(e,t,s){const a=this.asyncProps[e];a&&s>=a.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),a.resolvedValue=t,a.resolvedLoadCount=s,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){const s=this.asyncProps[e];if(s){s.pendingLoadCount++;const a=s.pendingLoadCount;t.then(u=>{this.component&&(u=this._postProcessValue(s,u),this._setAsyncPropValue(e,u,a),this._onResolve(e,u))}).catch(u=>{this._onError(e,u)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}const s=this.asyncProps[e];if(!s)return;s.pendingLoadCount++;const a=s.pendingLoadCount;let u=[],p=0;for await(const o of t){if(!this.component)return;const{dataTransform:T}=this.component.props;T?u=T(o,u):u=u.concat(o),Object.defineProperty(u,"__diff",{enumerable:!1,value:[{startRow:p,endRow:u.length}]}),p=u.length,this._setAsyncPropValue(e,u,a)}this._onResolve(e,u)}_postProcessValue(e,t){const s=e.type;return s&&this.component&&(s.release&&s.release(e.resolvedValue,s,this.component),s.transform)?s.transform(t,s,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){const a=this.component&&this.component.props[Oa];this.asyncProps[e]={type:a&&a[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class SD extends TD{constructor({attributeManager:e,layer:t}){super(t),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){const s=this.layer,a=s?.props.fetch;return a?a(t,{propName:e,layer:s}):super._fetch(e,t)}_onResolve(e,t){const s=this.layer;if(s){const a=s.props.onDataLoad;e==="data"&&a&&a(t,{propName:e,layer:s})}}_onError(e,t){const s=this.layer;s&&s.raiseError(t,`loading ${e} of ${this.layer}`)}}const AD="layer.changeFlag",ED="layer.initialize",ID="layer.update",CD="layer.finalize",PD="layer.matched",Pv=2**24-1,MD=Object.freeze([]),RD=ru(({oldViewport:r,viewport:e})=>r.equals(e));let Jn=new Uint8ClampedArray(0);const kD={data:{type:"data",value:MD,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:r=>r&&r.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(r,{propName:e,layer:t,loaders:s,loadOptions:a,signal:u})=>{const{resourceManager:p}=t.context;a=a||t.getLoadOptions(),s=s||t.props.loaders,u&&(a={...a,fetch:{...a?.fetch,signal:u}});let o=p.contains(r);return!o&&!a&&(p.add({resourceId:r,data:vg(r,s),persistent:!1}),o=!0),o?p.subscribe({resourceId:r,onChange:T=>t.internalState?.reloadAsyncProp(e,T),consumerId:t.id,requestId:e}):vg(r,s,a)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:pr.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:r})=>[0,-r*100]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class zm extends yf{constructor(){super(...arguments),this.internalState=null,this.lifecycle=Zl.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(e){Pi(this.internalState);const t=this.internalState.viewport||this.context.viewport,s=v0(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[a,u,p]=m0(s,t.pixelProjectionMatrix);return e.length===2?[a,u]:[a,u,p]}unproject(e){return Pi(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){Pi(this.internalState);const s=this.internalState.viewport||this.context.viewport;return aP(e,{viewport:s,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}get isDrawable(){return!0}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setShaderModuleProps(...e){for(const t of this.getModels())t.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===pr.DEFAULT||e===pr.LNGLAT||e===pr.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){Pi(e instanceof Uint8Array);const[t,s,a]=e;return t+s*256+a*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:nD(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){return this.getAttributeManager()?.getBounds(["positions","instancePositions"])}getShaders(e){e=Cv(e,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const t of this.props.extensions)e=Cv(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const t=this.getAttributeManager(),{dataChanged:s}=e.changeFlags;if(s&&t)if(Array.isArray(s))for(const a of s)t.invalidateAll(a);else t.invalidateAll();if(t){const{props:a}=e,u=this.internalState.hasPickingBuffer,p=Number.isInteger(a.highlightedObjectIndex)||a.pickable||a.extensions.some(o=>o.getNeedsPickingBuffer.call(this,o));if(u!==p){this.internalState.hasPickingBuffer=p;const{pickingColors:o,instancePickingColors:T}=t.attributes,E=o||T;E&&(p&&E.constant&&(E.constant=!1,t.invalidate(E.id)),!E.value&&!p&&(E.constant=!0,E.value=[0,0,0]))}}}finalizeState(e){for(const s of this.getModels())s.destroy();const t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const t of this.getModels())t.draw(e.renderPass)}getPickingInfo({info:e,mode:t,sourceLayer:s}){const{index:a}=e;return a>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[a]),e}raiseError(e,t){t&&(e=new Error(`${t}: ${e.message}`,{cause:e})),this.props.onError?.(e)||this.context?.onError?.(e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){return this.internalState?.uniformTransitions.active||!1}activateViewport(e){if(!this.internalState)return;const t=this.internalState.viewport;this.internalState.viewport=e,(!t||!RD({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const t=this.getAttributeManager();t&&(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){let t=!1;for(const s in e)e[s].layoutChanged()&&(t=!0);for(const s of this.getModels())this._setModelAttributes(s,e,t)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const t=this.props,s=this.getNumInstances(),a=this.getStartIndices();e.update({data:t.data,numInstances:s,startIndices:a,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});const u=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(u)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const t=e.update(),s=Object.create(this.props);for(const a in t)Object.defineProperty(s,a,{value:t[a]});return s}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;const s=Math.floor(Jn.length/4);if(this.internalState.usesPickingColorCache=!0,s<t){t>Pv&&kr.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),Jn=qh.allocate(Jn,t,{size:4,copy:!0,maxCount:Math.max(t,Pv)});const a=Math.floor(Jn.length/4),u=[0,0,0];for(let p=s;p<a;p++)this.encodePickingColor(p,u),Jn[p*4+0]=u[0],Jn[p*4+1]=u[1],Jn[p*4+2]=u[2],Jn[p*4+3]=0}e.value=Jn.subarray(0,t*4)}_setModelAttributes(e,t,s=!1){if(!Object.keys(t).length)return;if(s){const o=this.getAttributeManager();e.setBufferLayout(o.getBufferLayouts(e)),t=o.getAttributes()}const a=e.userData?.excludeAttributes||{},u={},p={};for(const o in t){if(a[o])continue;const T=t[o].getValue();for(const E in T){const C=T[E];C instanceof Ur?t[o].settings.isIndexed?e.setIndexBuffer(C):u[E]=C:C&&(p[E]=C)}}e.setAttributes(u),e.setConstantAttributes(p)}disablePickingIndex(e){const t=this.props.data;if(!("attributes"in t)){this._disablePickingIndex(e);return}const{pickingColors:s,instancePickingColors:a}=this.getAttributeManager().attributes,u=s||a,p=u&&t.attributes&&t.attributes[u.id];if(p&&p.value){const o=p.value,T=this.encodePickingColor(e);for(let E=0;E<t.length;E++){const C=u.getVertexOffset(E);o[C]===T[0]&&o[C+1]===T[1]&&o[C+2]===T[2]&&this._disablePickingIndex(E)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:t,instancePickingColors:s}=this.getAttributeManager().attributes,a=t||s;if(!a)return;const u=a.getVertexOffset(e),p=a.getVertexOffset(e+1);a.buffer.write(new Uint8Array(p-u),u)}restorePickingColors(){const{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,s=e||t;s&&(this.internalState.usesPickingColorCache&&s.value.buffer!==Jn.buffer&&(s.value=Jn.subarray(0,s.value.length)),s.updateSubBuffer({startOffset:0}))}_initialize(){Pi(!this.internalState),Pi(Number.isFinite(this.props.coordinateSystem)),cn(ED,this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new SD({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(kr.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new Yk(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){cn(PD,this,this===e);const{state:t,internalState:s}=e;this!==e&&(this.internalState=s,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(cn(ID,this,e),!e)return;const t=this.props,s=this.context,a=this.internalState,u=s.viewport,p=this._updateUniformTransition();a.propsInTransition=p,s.viewport=a.viewport||u,this.props=p;try{const o=this._getUpdateParams(),T=this.getModels();if(s.device)this.updateState(o);else try{this.updateState(o)}catch{}for(const C of this.props.extensions)C.updateState.call(this,o,C);this.setNeedsRedraw(),this._updateAttributes();const E=this.getModels()[0]!==T[0];this._postUpdate(o,E)}finally{s.viewport=u,this.props=t,this._clearChangeFlags(),a.needsUpdate=!1,a.resetOldProps()}}_finalize(){cn(CD,this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,shaderModuleProps:t=null,uniforms:s={},parameters:a={}}){this._updateAttributeTransition();const u=this.props,p=this.context;this.props=this.internalState.propsInTransition||u;try{t&&this.setShaderModuleProps(t);const{getPolygonOffset:o}=this.props,T=o&&o(s)||[0,0];p.device instanceof Ql&&p.device.setParametersWebGL({polygonOffset:T});for(const E of this.getModels())E.device.type==="webgpu"?E.setParameters({...E.parameters,...a}):E.setParameters(a);if(p.device instanceof Ql)p.device.withParametersWebGL(a,()=>{const E={renderPass:e,shaderModuleProps:t,uniforms:s,parameters:a,context:p};for(const C of this.props.extensions)C.draw.call(this,E,C);this.draw(E)});else{const E={renderPass:e,shaderModuleProps:t,uniforms:s,parameters:a,context:p};for(const C of this.props.extensions)C.draw.call(this,E,C);this.draw(E)}}finally{this.props=u}}getChangeFlags(){return this.internalState?.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:t}=this.internalState;for(const a in e)if(e[a]){let u=!1;switch(a){case"dataChanged":const p=e[a],o=t[a];p&&Array.isArray(o)&&(t.dataChanged=Array.isArray(p)?o.concat(p):p,u=!0);default:t[a]||(t[a]=e[a],u=!0)}u&&cn(AD,this,a,e)}const s=!!(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=s,t.somethingChanged=s||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){const s=Kk(e,t);if(s.updateTriggersChanged)for(const a in s.updateTriggersChanged)s.updateTriggersChanged[a]&&this.invalidateAttribute(a);if(s.transitionsChanged)for(const a in s.transitionsChanged)this.internalState.uniformTransitions.add(a,t[a],e[a],e.transitions?.[a]);return this.setChangeFlags(s)}validateProps(){Gk(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const t={highlightedObjectColor:e.picked?e.color:null},{highlightColor:s}=this.props;e.picked&&typeof s=="function"&&(t.highlightColor=s(e)),this.setShaderModuleProps({picking:t}),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new Wk(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){const{props:s,oldProps:a}=e,u=this.state.model;u?.isInstanced&&u.setInstanceCount(this.getNumInstances());const{autoHighlight:p,highlightedObjectIndex:o,highlightColor:T}=s;if(t||a.autoHighlight!==p||a.highlightedObjectIndex!==o||a.highlightColor!==T){const E={};Array.isArray(T)&&(E.highlightColor=T),(t||a.autoHighlight!==p||o!==a.highlightedObjectIndex)&&(E.highlightedObjectColor=Number.isFinite(o)&&o>=0?this.encodePickingColor(o):null),this.setShaderModuleProps({picking:E})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id;const s=this.getAttributeManager(),a=s?s.getNeedsRedraw(e):!1;if(t=t||a,t)for(const u of this.props.extensions)u.onNeedsRedraw.call(this,u);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}zm.defaultProps=kD;zm.layerName="Layer";const Cd=Math.PI/180,Mv=180/Math.PI,Ud=6370972,ec=256;function DD(){const r=ec/Ud,e=Math.PI/180*ec;return{unitsPerMeter:[r,r,r],unitsPerMeter2:[0,0,0],metersPerUnit:[1/r,1/r,1/r],unitsPerDegree:[e,e,r],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/e,1/e,1/r]}}class OD extends dc{constructor(e={}){const{longitude:t=0,zoom:s=0,nearZMultiplier:a=.5,farZMultiplier:u=1,resolution:p=10}=e;let{latitude:o=0,height:T,altitude:E=1.5,fovy:C}=e;o=Math.max(Math.min(o,ko),-ko),T=T||1,C?E=Em(C):C=Xh(E);const O=1/Math.PI/Math.cos(o*Math.PI/180),$=Math.pow(2,s)*O,V=e.nearZ??a,ie=e.farZ??(E+ec*2*$/T)*u,we=new rs().lookAt({eye:[0,-E,0],up:[0,0,1]});we.rotateX(o*Cd),we.rotateZ(-t*Cd),we.scale($/T),super({...e,height:T,viewMatrix:we,longitude:t,latitude:o,zoom:s,distanceScales:DD(),fovy:C,focalDistance:E,near:V,far:ie}),this.scale=$,this.latitude=o,this.longitude=t,this.resolution=p}get projectionMode(){return En.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(e={}){const t={targetZ:e.z||0},s=this.unproject([0,this.height/2],t),a=this.unproject([this.width/2,0],t),u=this.unproject([this.width,this.height/2],t),p=this.unproject([this.width/2,this.height],t);return u[0]<this.longitude&&(u[0]+=360),s[0]>this.longitude&&(s[0]-=360),[Math.min(s[0],u[0],a[0],p[0]),Math.min(s[1],u[1],a[1],p[1]),Math.max(s[0],u[0],a[0],p[0]),Math.max(s[1],u[1],a[1],p[1])]}unproject(e,{topLeft:t=!0,targetZ:s}={}){const[a,u,p]=e,o=t?u:this.height-u,{pixelUnprojectionMatrix:T}=this;let E;if(Number.isFinite(p))E=gg(T,[a,o,p,1]);else{const V=gg(T,[a,o,-1,1]),ie=gg(T,[a,o,1,1]),we=((s||0)/Ud+1)*ec,Pe=Kp(Gx([],V,ie)),je=Kp(V),Ze=Kp(ie),Ue=4*((4*je*Ze-(Pe-je-Ze)**2)/16)/Pe,et=Math.sqrt(je-Ue),Ke=Math.sqrt(Math.max(0,we*we-Ue)),ct=(et-Ke)/Math.sqrt(Pe);E=KE([],V,ie,ct)}const[C,O,$]=this.unprojectPosition(E);return Number.isFinite(p)?[C,O,$]:Number.isFinite(s)?[C,O,s]:[C,O]}projectPosition(e){const[t,s,a=0]=e,u=t*Cd,p=s*Cd,o=Math.cos(p),T=(a/Ud+1)*ec;return[Math.sin(u)*o*T,-Math.cos(u)*o*T,Math.sin(p)*T]}unprojectPosition(e){const[t,s,a]=e,u=n3(e),p=Math.asin(a/u),T=Math.atan2(t,-s)*Mv,E=p*Mv,C=(u/ec-1)*Ud;return[T,E,C]}projectFlat(e){return e}unprojectFlat(e){return e}panByPosition(e,t){const s=this.unproject(t);return{longitude:e[0]-s[0]+this.longitude,latitude:e[1]-s[1]+this.latitude}}}function gg(r,e){const t=uc([],e,r);return Qx(t,t,1/t[3]),t}class FD extends P0{applyConstraints(e){const{maxZoom:t,minZoom:s,zoom:a}=e;e.zoom=Ts(a,s,t);const{longitude:u,latitude:p}=e;return(u<-180||u>180)&&(e.longitude=KC(u+180,360)-180),e.latitude=Ts(p,-ko,ko),e}}class BD extends C0{constructor(){super(...arguments),this.ControllerState=FD,this.transition={transitionDuration:300,transitionInterpolator:new Rm(["longitude","latitude","zoom"])},this.dragMode="pan"}setProps(e){super.setProps(e),this.dragRotate=!1,this.touchRotate=!1}}class nw extends I0{constructor(e={}){super(e)}getViewportType(e){return e.zoom>12?za:OD}get ControllerType(){return BD}}nw.displayName="GlobeView";const mg=512,LD=Math.PI/180;function sw({map:r,gl:e,deck:t}){if(r.__deck)return r.__deck;const s=t?.props._customRender,a=t?.props.onLoad,u={...t?.props,_customRender:()=>{r.triggerRepaint(),s?.("")}};u.parameters={...Kg(r,!0),...u.parameters},u.views||(u.views=lf(r));let p;return(!t||t.props.gl===e)&&(Object.assign(u,{gl:e,width:null,height:null,touchAction:"unset",viewState:Jh(r)}),t?.isInitialized?Rv(t,r):u.onLoad=()=>{a?.(),Rv(p,r)}),t?(p=t,t.setProps(u),t.userData.isExternal=!0):(p=new Kh(u),r.on("remove",()=>{ow(r)})),p.userData.mapboxLayers=new Set,r.__deck=p,r.on("render",()=>{p.isInitialized&&$D(p,r)}),p}function Rv(r,e){const t=()=>{r.isInitialized?WD(r,e):e.off("move",t)};e.on("move",t)}function ow(r){r.__deck?.finalize(),r.__deck=null}function Kg(r,e){const t=e?{depthWriteEnabled:!0,depthCompare:"less-equal",depthBias:0,blend:!0,blendColorSrcFactor:"src-alpha",blendColorDstFactor:"one-minus-src-alpha",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one-minus-src-alpha",blendColorOperation:"add",blendAlphaOperation:"add"}:{};return aw(r)==="globe"&&(t.cullMode="back"),t}function ND(r,e){r.userData.mapboxLayers.add(e),Um(r)}function zD(r,e){r.userData.mapboxLayers.delete(e),Um(r)}function UD(r,e){Um(r)}function VD(r,e,t,s){let{currentViewport:a}=r.userData,u=!1;a||(a=lw(r,e,s),r.userData.currentViewport=a,u=!0),r.isInitialized&&r._drawLayers("mapbox-repaint",{viewports:[a],layerFilter:p=>(!r.props.layerFilter||r.props.layerFilter(p))&&(t.id===p.layer.id||p.layer.props.operation.includes("terrain")),clearStack:u,clearCanvas:!1})}function aw(r){const e=r.getProjection?.(),t=e?.type||e?.name;if(t==="globe")return"globe";if(t&&t!=="mercator")throw new Error("Unsupported projection");return"mercator"}function lf(r){return aw(r)==="globe"?new nw({id:"mapbox"}):new km({id:"mapbox"})}function Jh(r){const{lng:e,lat:t}=r.getCenter(),s={longitude:(e+540)%360-180,latitude:t,zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch(),padding:r.getPadding(),repeat:r.getRenderWorldCopies()};return r.getTerrain?.()&&jD(r,s),s}function jD(r,e){if(r.getFreeCameraOptions){const{position:t}=r.getFreeCameraOptions();if(!t||t.z===void 0)return;const s=r.transform.height,{longitude:a,latitude:u,pitch:p}=e,o=t.x*mg,T=(1-t.y)*mg,E=t.z*mg,C=Zh([a,u]),O=o-C[0],$=T-C[1],V=Math.sqrt(O*O+$*$),ie=p*LD,we=1.5*s,Pe=ie<.001?we*Math.cos(ie)/E:we*Math.sin(ie)/V;e.zoom=Math.log2(Pe);const je=we*Math.cos(ie)/Pe,Ze=E-je;e.position=[0,0,Ze/Nd(u)]}else typeof r.transform.elevation=="number"&&(e.position=[0,0,r.transform.elevation])}function lw(r,e,t){const s=Jh(e),a=lf(e);t&&(a.props.nearZMultiplier=.2);const u=t?.nearZ??e.transform._nearZ,p=t?.farZ??e.transform._farZ;return Number.isFinite(u)&&(s.nearZ=u/e.transform.height,s.farZ=p/e.transform.height),a.makeViewport({width:r.width,height:r.height,viewState:s})}function $D(r,e){const{mapboxLayers:t,isExternal:s}=r.userData;if(s){const a=Array.from(t,C=>C.id),p=Gh(r.props.layers,Boolean).some(C=>C&&!a.includes(C.id));let o=r.getViewports();const T=o.findIndex(C=>C.id==="mapbox"),E=o.length>1||T<0;(p||E)&&(T>=0&&(o=o.slice(),o[T]=lw(r,e)),r._drawLayers("mapbox-repaint",{viewports:o,layerFilter:C=>(!r.props.layerFilter||r.props.layerFilter(C))&&(C.viewport.id!=="mapbox"||!a.includes(C.layer.id)),clearCanvas:!1}))}r.userData.currentViewport=null}function WD(r,e){r.setProps({viewState:Jh(e)}),r.needsRedraw({clearRedrawFlags:!0})}function Um(r){if(r.userData.isExternal)return;const e=[];r.userData.mapboxLayers.forEach(t=>{const s=t.props.type,a=new s(t.props);e.push(a)}),r.setProps({layers:e})}class HD{constructor(e){if(!e.id)throw new Error("Layer must have an unique id");this.id=e.id,this.type="custom",this.renderingMode=e.renderingMode||"3d",this.slot=e.slot,this.map=null,this.deck=null,this.props=e}onAdd(e,t){this.map=e,this.deck=sw({map:e,gl:t,deck:this.props.deck}),ND(this.deck,this)}onRemove(){this.deck&&zD(this.deck,this)}setProps(e){Object.assign(this.props,e,{id:this.id}),this.deck&&UD(this.deck)}render(e,t){VD(this.deck,this.map,this,t)}}const _g="__UNDEFINED__";function Pd(r,e,t,s){if(!r||!e||!r.style||!r.style._loaded)return;const a=Gh(s,Boolean);if(t!==s){const o=Gh(t,Boolean),T=new Set(o.map(E=>E.id));for(const E of a)T.delete(E.id);for(const E of T)r.getLayer(E)&&r.removeLayer(E)}for(const o of a){const T=r.getLayer(o.id);T?(T.implementation||T).setProps(o.props):r.addLayer(new HD({id:o.id,deck:e,slot:o.props.slot}),o.props.beforeId)}const u=r.style._order,p={};for(const o of a){let{beforeId:T}=o.props;(!T||!u.includes(T))&&(T=_g),p[T]=p[T]||[],p[T].push(o.id)}for(const o in p){const T=p[o];let E=o===_g?u.length:u.indexOf(o),C=o===_g?void 0:o;for(let O=T.length-1;O>=0;O--){const $=T[O],V=u.indexOf($);V!==E-1&&(r.moveLayer($,C),V>E&&E++),E--,C=$}}}class ZD{constructor(e){this._handleStyleChange=()=>{Pd(this._map,this._deck,this._props.layers,this._props.layers)},this._updateContainerSize=()=>{if(this._map&&this._container){const{clientWidth:a,clientHeight:u}=this._map.getContainer();Object.assign(this._container.style,{width:`${a}px`,height:`${u}px`})}},this._updateViewState=()=>{const a=this._deck,u=this._map;a&&u&&(a.setProps({views:this._props.views||lf(u),viewState:Jh(u)}),a.isInitialized&&a.redraw())},this._handleMouseEvent=a=>{const u=this._deck;if(!u||!u.isInitialized)return;const p={type:a.type,offsetCenter:a.point,srcEvent:a},o=this._lastMouseDownPoint;switch(!a.point&&o&&(p.deltaX=a.originalEvent.clientX-o.clientX,p.deltaY=a.originalEvent.clientY-o.clientY,p.offsetCenter={x:o.x+p.deltaX,y:o.y+p.deltaY}),p.type){case"mousedown":u._onPointerDown(p),this._lastMouseDownPoint={...a.point,clientX:a.originalEvent.clientX,clientY:a.originalEvent.clientY};break;case"dragstart":p.type="panstart",u._onEvent(p);break;case"drag":p.type="panmove",u._onEvent(p);break;case"dragend":p.type="panend",u._onEvent(p);break;case"click":p.tapCount=1,u._onEvent(p);break;case"dblclick":p.type="click",p.tapCount=2,u._onEvent(p);break;case"mousemove":p.type="pointermove",u._onPointerMove(p);break;case"mouseout":p.type="pointerleave",u._onPointerMove(p);break;default:return}};const{interleaved:t=!1,...s}=e;this._interleaved=t,this._props=s}setProps(e){this._interleaved&&e.layers&&Pd(this._map,this._deck,this._props.layers,e.layers),Object.assign(this._props,e),this._deck&&this._map&&this._deck.setProps({...this._props,parameters:{...Kg(this._map,this._interleaved),...this._props.parameters}})}onAdd(e){return this._map=e,this._interleaved?this._onAddInterleaved(e):this._onAddOverlaid(e)}_onAddOverlaid(e){const t=document.createElement("div");return Object.assign(t.style,{position:"absolute",left:0,top:0,textAlign:"initial",pointerEvents:"none"}),this._container=t,this._deck=new Kh({...this._props,parent:t,parameters:{...Kg(e,!1),...this._props.parameters},views:this._props.views||lf(e),viewState:Jh(e)}),e.on("resize",this._updateContainerSize),e.on("render",this._updateViewState),e.on("mousedown",this._handleMouseEvent),e.on("dragstart",this._handleMouseEvent),e.on("drag",this._handleMouseEvent),e.on("dragend",this._handleMouseEvent),e.on("mousemove",this._handleMouseEvent),e.on("mouseout",this._handleMouseEvent),e.on("click",this._handleMouseEvent),e.on("dblclick",this._handleMouseEvent),this._updateContainerSize(),t}_onAddInterleaved(e){const t=e.painter.context.gl;return t instanceof WebGLRenderingContext&&kr.warn("Incompatible basemap library. See: https://deck.gl/docs/api-reference/mapbox/overview#compatibility")(),this._deck=sw({map:e,gl:t,deck:new Kh({...this._props,gl:t})}),e.on("styledata",this._handleStyleChange),Pd(e,this._deck,[],this._props.layers),document.createElement("div")}onRemove(){const e=this._map;e&&(this._interleaved?this._onRemoveInterleaved(e):this._onRemoveOverlaid(e)),this._deck=void 0,this._map=void 0,this._container=void 0}_onRemoveOverlaid(e){e.off("resize",this._updateContainerSize),e.off("render",this._updateViewState),e.off("mousedown",this._handleMouseEvent),e.off("dragstart",this._handleMouseEvent),e.off("drag",this._handleMouseEvent),e.off("dragend",this._handleMouseEvent),e.off("mousemove",this._handleMouseEvent),e.off("mouseout",this._handleMouseEvent),e.off("click",this._handleMouseEvent),e.off("dblclick",this._handleMouseEvent),this._deck?.finalize()}_onRemoveInterleaved(e){e.off("styledata",this._handleStyleChange),Pd(e,this._deck,this._props.layers,[]),ow(e)}getDefaultPosition(){return"top-left"}pickObject(e){return Pi(this._deck),this._deck.pickObject(e)}pickMultipleObjects(e){return Pi(this._deck),this._deck.pickMultipleObjects(e)}pickObjects(e){return Pi(this._deck),this._deck.pickObjects(e)}finalize(){this._map&&this._map.removeControl(this)}getCanvas(){return this._map?this._interleaved?this._map.getCanvas():this._deck.getCanvas():null}}const kv=`uniform pointCloudUniforms {
  float radiusPixels;
  highp int sizeUnits;
} pointCloud;
`,XD={name:"pointCloud",vs:kv,fs:kv,uniformTypes:{radiusPixels:"f32",sizeUnits:"i32"}},qD=`#version 300 es
#define SHADER_NAME point-cloud-layer-vertex-shader
in vec3 positions;
in vec3 instanceNormals;
in vec4 instanceColors;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec3 instancePickingColors;
out vec4 vColor;
out vec2 unitPosition;
void main(void) {
geometry.worldPosition = instancePositions;
geometry.normal = project_normal(instanceNormals);
unitPosition = positions.xy;
geometry.uv = unitPosition;
geometry.pickingColor = instancePickingColors;
vec3 offset = vec3(positions.xy * project_size_to_pixel(pointCloud.radiusPixels, pointCloud.sizeUnits), 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
vec3 lightColor = lighting_getLightColor(instanceColors.rgb, project.cameraPosition, geometry.position.xyz, geometry.normal);
vColor = vec4(lightColor, instanceColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,YD=`#version 300 es
#define SHADER_NAME point-cloud-layer-fragment-shader
precision highp float;
in vec4 vColor;
in vec2 unitPosition;
out vec4 fragColor;
void main(void) {
geometry.uv = unitPosition.xy;
float distToCenter = length(unitPosition);
if (distToCenter > 1.0) {
discard;
}
fragColor = vColor;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,cw=[0,0,0,255],hw=[0,0,1],GD={sizeUnits:"pixels",pointSize:{type:"number",min:0,value:10},getPosition:{type:"accessor",value:r=>r.position},getNormal:{type:"accessor",value:hw},getColor:{type:"accessor",value:cw},material:!0,radiusPixels:{deprecatedFor:"pointSize"}};function KD(r){const{header:e,attributes:t}=r;if(!(!e||!t)&&(r.length=e.vertexCount,t.POSITION&&(t.instancePositions=t.POSITION),t.NORMAL&&(t.instanceNormals=t.NORMAL),t.COLOR_0)){const{size:s,value:a}=t.COLOR_0;t.instanceColors={size:s,type:"unorm8",value:a}}}class Vm extends zm{getShaders(){return super.getShaders({vs:qD,fs:YD,modules:[lC,r0,kC,XD]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceNormals:{size:3,transition:!0,accessor:"getNormal",defaultValue:hw},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getColor",defaultValue:cw}})}updateState(e){const{changeFlags:t,props:s}=e;super.updateState(e),t.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll()),t.dataChanged&&KD(s.data)}draw({uniforms:e}){const{pointSize:t,sizeUnits:s}=this.props,a=this.state.model,u={sizeUnits:Hh[s],radiusPixels:t};a.shaderInputs.setProps({pointCloud:u}),a.draw(this.context.renderPass)}_getModel(){const e=[];for(let t=0;t<3;t++){const s=t/3*Math.PI*2;e.push(Math.cos(s)*2,Math.sin(s)*2,0)}return new Yh(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new PP({topology:"triangle-list",attributes:{positions:new Float32Array(e)}}),isInstanced:!0})}}Vm.layerName="PointCloudLayer";Vm.defaultProps=GD;var Vd={exports:{}};/* @license
Papa Parse
v5.5.3
https://github.com/mholt/PapaParse
License: MIT
*/var JD=Vd.exports,Dv;function QD(){return Dv||(Dv=1,function(r,e){((t,s)=>{r.exports=s()})(JD,function t(){var s=typeof self<"u"?self:typeof window<"u"?window:s!==void 0?s:{},a,u=!s.document&&!!s.postMessage,p=s.IS_PAPA_WORKER||!1,o={},T=0,E={};function C(me){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},(function(_e){var ze=et(_e);ze.chunkSize=parseInt(ze.chunkSize),_e.step||_e.chunk||(ze.chunkSize=null),this._handle=new we(ze),(this._handle.streamer=this)._config=ze}).call(this,me),this.parseChunk=function(_e,ze){var Qe=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<Qe){let mt=this._config.newline;mt||(at=this._config.quoteChar||'"',mt=this._handle.guessLineEndings(_e,at)),_e=[..._e.split(mt).slice(Qe)].join(mt)}this.isFirstChunk&&ct(this._config.beforeFirstChunk)&&(at=this._config.beforeFirstChunk(_e))!==void 0&&(_e=at),this.isFirstChunk=!1,this._halted=!1;var Qe=this._partialLine+_e,at=(this._partialLine="",this._handle.parse(Qe,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(_e=at.meta.cursor,Qe=(this._finished||(this._partialLine=Qe.substring(_e-this._baseIndex),this._baseIndex=_e),at&&at.data&&(this._rowCount+=at.data.length),this._finished||this._config.preview&&this._rowCount>=this._config.preview),p)s.postMessage({results:at,workerId:E.WORKER_ID,finished:Qe});else if(ct(this._config.chunk)&&!ze){if(this._config.chunk(at,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=at=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(at.data),this._completeResults.errors=this._completeResults.errors.concat(at.errors),this._completeResults.meta=at.meta),this._completed||!Qe||!ct(this._config.complete)||at&&at.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),Qe||at&&at.meta.paused||this._nextChunk(),at}this._halted=!0},this._sendError=function(_e){ct(this._config.error)?this._config.error(_e):p&&this._config.error&&s.postMessage({workerId:E.WORKER_ID,error:_e,finished:!1})}}function O(me){var _e;(me=me||{}).chunkSize||(me.chunkSize=E.RemoteChunkSize),C.call(this,me),this._nextChunk=u?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(ze){this._input=ze,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(_e=new XMLHttpRequest,this._config.withCredentials&&(_e.withCredentials=this._config.withCredentials),u||(_e.onload=Ke(this._chunkLoaded,this),_e.onerror=Ke(this._chunkError,this)),_e.open(this._config.downloadRequestBody?"POST":"GET",this._input,!u),this._config.downloadRequestHeaders){var ze,Qe=this._config.downloadRequestHeaders;for(ze in Qe)_e.setRequestHeader(ze,Qe[ze])}var at;this._config.chunkSize&&(at=this._start+this._config.chunkSize-1,_e.setRequestHeader("Range","bytes="+this._start+"-"+at));try{_e.send(this._config.downloadRequestBody)}catch(mt){this._chunkError(mt.message)}u&&_e.status===0&&this._chunkError()}},this._chunkLoaded=function(){_e.readyState===4&&(_e.status<200||400<=_e.status?this._chunkError():(this._start+=this._config.chunkSize||_e.responseText.length,this._finished=!this._config.chunkSize||this._start>=(ze=>(ze=ze.getResponseHeader("Content-Range"))!==null?parseInt(ze.substring(ze.lastIndexOf("/")+1)):-1)(_e),this.parseChunk(_e.responseText)))},this._chunkError=function(ze){ze=_e.statusText||ze,this._sendError(new Error(ze))}}function $(me){(me=me||{}).chunkSize||(me.chunkSize=E.LocalChunkSize),C.call(this,me);var _e,ze,Qe=typeof FileReader<"u";this.stream=function(at){this._input=at,ze=at.slice||at.webkitSlice||at.mozSlice,Qe?((_e=new FileReader).onload=Ke(this._chunkLoaded,this),_e.onerror=Ke(this._chunkError,this)):_e=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var at=this._input,mt=(this._config.chunkSize&&(mt=Math.min(this._start+this._config.chunkSize,this._input.size),at=ze.call(at,this._start,mt)),_e.readAsText(at,this._config.encoding));Qe||this._chunkLoaded({target:{result:mt}})},this._chunkLoaded=function(at){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(at.target.result)},this._chunkError=function(){this._sendError(_e.error)}}function V(me){var _e;C.call(this,me=me||{}),this.stream=function(ze){return _e=ze,this._nextChunk()},this._nextChunk=function(){var ze,Qe;if(!this._finished)return ze=this._config.chunkSize,_e=ze?(Qe=_e.substring(0,ze),_e.substring(ze)):(Qe=_e,""),this._finished=!_e,this.parseChunk(Qe)}}function ie(me){C.call(this,me=me||{});var _e=[],ze=!0,Qe=!1;this.pause=function(){C.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){C.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(at){this._input=at,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){Qe&&_e.length===1&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),_e.length?this.parseChunk(_e.shift()):ze=!0},this._streamData=Ke(function(at){try{_e.push(typeof at=="string"?at:at.toString(this._config.encoding)),ze&&(ze=!1,this._checkIsFinished(),this.parseChunk(_e.shift()))}catch(mt){this._streamError(mt)}},this),this._streamError=Ke(function(at){this._streamCleanUp(),this._sendError(at)},this),this._streamEnd=Ke(function(){this._streamCleanUp(),Qe=!0,this._streamData("")},this),this._streamCleanUp=Ke(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function we(me){var _e,ze,Qe,at,mt=Math.pow(2,53),At=-mt,or=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,ti=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,Bt=this,wr=0,Rt=0,Vr=!1,It=!1,yt=[],bt={data:[],errors:[],meta:{}};function ar(Ht){return me.skipEmptyLines==="greedy"?Ht.join("").trim()==="":Ht.length===1&&Ht[0].length===0}function cr(){if(bt&&Qe&&(ri("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+E.DefaultDelimiter+"'"),Qe=!1),me.skipEmptyLines&&(bt.data=bt.data.filter(function(Tt){return!ar(Tt)})),Mr()){let Tt=function(mr,zt){ct(me.transformHeader)&&(mr=me.transformHeader(mr,zt)),yt.push(mr)};if(bt)if(Array.isArray(bt.data[0])){for(var Ht=0;Mr()&&Ht<bt.data.length;Ht++)bt.data[Ht].forEach(Tt);bt.data.splice(0,1)}else bt.data.forEach(Tt)}function kt(Tt,mr){for(var zt=me.header?{}:[],Jt=0;Jt<Tt.length;Jt++){var Gt=Jt,$t=Tt[Jt],$t=((hr,Ct)=>(Qt=>(me.dynamicTypingFunction&&me.dynamicTyping[Qt]===void 0&&(me.dynamicTyping[Qt]=me.dynamicTypingFunction(Qt)),(me.dynamicTyping[Qt]||me.dynamicTyping)===!0))(hr)?Ct==="true"||Ct==="TRUE"||Ct!=="false"&&Ct!=="FALSE"&&((Qt=>{if(or.test(Qt)&&(Qt=parseFloat(Qt),At<Qt&&Qt<mt))return 1})(Ct)?parseFloat(Ct):ti.test(Ct)?new Date(Ct):Ct===""?null:Ct):Ct)(Gt=me.header?Jt>=yt.length?"__parsed_extra":yt[Jt]:Gt,$t=me.transform?me.transform($t,Gt):$t);Gt==="__parsed_extra"?(zt[Gt]=zt[Gt]||[],zt[Gt].push($t)):zt[Gt]=$t}return me.header&&(Jt>yt.length?ri("FieldMismatch","TooManyFields","Too many fields: expected "+yt.length+" fields but parsed "+Jt,Rt+mr):Jt<yt.length&&ri("FieldMismatch","TooFewFields","Too few fields: expected "+yt.length+" fields but parsed "+Jt,Rt+mr)),zt}var gr;bt&&(me.header||me.dynamicTyping||me.transform)&&(gr=1,!bt.data.length||Array.isArray(bt.data[0])?(bt.data=bt.data.map(kt),gr=bt.data.length):bt.data=kt(bt.data,0),me.header&&bt.meta&&(bt.meta.fields=yt),Rt+=gr)}function Mr(){return me.header&&yt.length===0}function ri(Ht,kt,gr,Tt){Ht={type:Ht,code:kt,message:gr},Tt!==void 0&&(Ht.row=Tt),bt.errors.push(Ht)}ct(me.step)&&(at=me.step,me.step=function(Ht){bt=Ht,Mr()?cr():(cr(),bt.data.length!==0&&(wr+=Ht.data.length,me.preview&&wr>me.preview?ze.abort():(bt.data=bt.data[0],at(bt,Bt))))}),this.parse=function(Ht,kt,gr){var Tt=me.quoteChar||'"',Tt=(me.newline||(me.newline=this.guessLineEndings(Ht,Tt)),Qe=!1,me.delimiter?ct(me.delimiter)&&(me.delimiter=me.delimiter(Ht),bt.meta.delimiter=me.delimiter):((Tt=((mr,zt,Jt,Gt,$t)=>{var hr,Ct,Qt,Mi;$t=$t||[",","	","|",";",E.RECORD_SEP,E.UNIT_SEP];for(var Ni=0;Ni<$t.length;Ni++){for(var Ri,en=$t[Ni],Sr=0,oi=0,_r=0,yr=(Qt=void 0,new je({comments:Gt,delimiter:en,newline:zt,preview:10}).parse(mr)),Yr=0;Yr<yr.data.length;Yr++)Jt&&ar(yr.data[Yr])?_r++:(Ri=yr.data[Yr].length,oi+=Ri,Qt===void 0?Qt=Ri:0<Ri&&(Sr+=Math.abs(Ri-Qt),Qt=Ri));0<yr.data.length&&(oi/=yr.data.length-_r),(Ct===void 0||Sr<=Ct)&&(Mi===void 0||Mi<oi)&&1.99<oi&&(Ct=Sr,hr=en,Mi=oi)}return{successful:!!(me.delimiter=hr),bestDelimiter:hr}})(Ht,me.newline,me.skipEmptyLines,me.comments,me.delimitersToGuess)).successful?me.delimiter=Tt.bestDelimiter:(Qe=!0,me.delimiter=E.DefaultDelimiter),bt.meta.delimiter=me.delimiter),et(me));return me.preview&&me.header&&Tt.preview++,_e=Ht,ze=new je(Tt),bt=ze.parse(_e,kt,gr),cr(),Vr?{meta:{paused:!0}}:bt||{meta:{paused:!1}}},this.paused=function(){return Vr},this.pause=function(){Vr=!0,ze.abort(),_e=ct(me.chunk)?"":_e.substring(ze.getCharIndex())},this.resume=function(){Bt.streamer._halted?(Vr=!1,Bt.streamer.parseChunk(_e,!0)):setTimeout(Bt.resume,3)},this.aborted=function(){return It},this.abort=function(){It=!0,ze.abort(),bt.meta.aborted=!0,ct(me.complete)&&me.complete(bt),_e=""},this.guessLineEndings=function(mr,Tt){mr=mr.substring(0,1048576);var Tt=new RegExp(Pe(Tt)+"([^]*?)"+Pe(Tt),"gm"),gr=(mr=mr.replace(Tt,"")).split("\r"),Tt=mr.split(`
`),mr=1<Tt.length&&Tt[0].length<gr[0].length;if(gr.length===1||mr)return`
`;for(var zt=0,Jt=0;Jt<gr.length;Jt++)gr[Jt][0]===`
`&&zt++;return zt>=gr.length/2?`\r
`:"\r"}}function Pe(me){return me.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function je(me){var _e=(me=me||{}).delimiter,ze=me.newline,Qe=me.comments,at=me.step,mt=me.preview,At=me.fastMode,or=null,ti=!1,Bt=me.quoteChar==null?'"':me.quoteChar,wr=Bt;if(me.escapeChar!==void 0&&(wr=me.escapeChar),(typeof _e!="string"||-1<E.BAD_DELIMITERS.indexOf(_e))&&(_e=","),Qe===_e)throw new Error("Comment character same as delimiter");Qe===!0?Qe="#":(typeof Qe!="string"||-1<E.BAD_DELIMITERS.indexOf(Qe))&&(Qe=!1),ze!==`
`&&ze!=="\r"&&ze!==`\r
`&&(ze=`
`);var Rt=0,Vr=!1;this.parse=function(It,yt,bt){if(typeof It!="string")throw new Error("Input must be a string");var ar=It.length,cr=_e.length,Mr=ze.length,ri=Qe.length,Ht=ct(at),kt=[],gr=[],Tt=[],mr=Rt=0;if(!It)return Sr();if(At||At!==!1&&It.indexOf(Bt)===-1){for(var zt=It.split(ze),Jt=0;Jt<zt.length;Jt++){if(Tt=zt[Jt],Rt+=Tt.length,Jt!==zt.length-1)Rt+=ze.length;else if(bt)return Sr();if(!Qe||Tt.substring(0,ri)!==Qe){if(Ht){if(kt=[],Mi(Tt.split(_e)),oi(),Vr)return Sr()}else Mi(Tt.split(_e));if(mt&&mt<=Jt)return kt=kt.slice(0,mt),Sr(!0)}}return Sr()}for(var Gt=It.indexOf(_e,Rt),$t=It.indexOf(ze,Rt),hr=new RegExp(Pe(wr)+Pe(Bt),"g"),Ct=It.indexOf(Bt,Rt);;)if(It[Rt]===Bt)for(Ct=Rt,Rt++;;){if((Ct=It.indexOf(Bt,Ct+1))===-1)return bt||gr.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:kt.length,index:Rt}),Ri();if(Ct===ar-1)return Ri(It.substring(Rt,Ct).replace(hr,Bt));if(Bt===wr&&It[Ct+1]===wr)Ct++;else if(Bt===wr||Ct===0||It[Ct-1]!==wr){Gt!==-1&&Gt<Ct+1&&(Gt=It.indexOf(_e,Ct+1));var Qt=Ni(($t=$t!==-1&&$t<Ct+1?It.indexOf(ze,Ct+1):$t)===-1?Gt:Math.min(Gt,$t));if(It.substr(Ct+1+Qt,cr)===_e){Tt.push(It.substring(Rt,Ct).replace(hr,Bt)),It[Rt=Ct+1+Qt+cr]!==Bt&&(Ct=It.indexOf(Bt,Rt)),Gt=It.indexOf(_e,Rt),$t=It.indexOf(ze,Rt);break}if(Qt=Ni($t),It.substring(Ct+1+Qt,Ct+1+Qt+Mr)===ze){if(Tt.push(It.substring(Rt,Ct).replace(hr,Bt)),en(Ct+1+Qt+Mr),Gt=It.indexOf(_e,Rt),Ct=It.indexOf(Bt,Rt),Ht&&(oi(),Vr))return Sr();if(mt&&kt.length>=mt)return Sr(!0);break}gr.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:kt.length,index:Rt}),Ct++}}else if(Qe&&Tt.length===0&&It.substring(Rt,Rt+ri)===Qe){if($t===-1)return Sr();Rt=$t+Mr,$t=It.indexOf(ze,Rt),Gt=It.indexOf(_e,Rt)}else if(Gt!==-1&&(Gt<$t||$t===-1))Tt.push(It.substring(Rt,Gt)),Rt=Gt+cr,Gt=It.indexOf(_e,Rt);else{if($t===-1)break;if(Tt.push(It.substring(Rt,$t)),en($t+Mr),Ht&&(oi(),Vr))return Sr();if(mt&&kt.length>=mt)return Sr(!0)}return Ri();function Mi(_r){kt.push(_r),mr=Rt}function Ni(_r){var yr=0;return yr=_r!==-1&&(_r=It.substring(Ct+1,_r))&&_r.trim()===""?_r.length:yr}function Ri(_r){return bt||(_r===void 0&&(_r=It.substring(Rt)),Tt.push(_r),Rt=ar,Mi(Tt),Ht&&oi()),Sr()}function en(_r){Rt=_r,Mi(Tt),Tt=[],$t=It.indexOf(ze,Rt)}function Sr(_r){if(me.header&&!yt&&kt.length&&!ti){var yr=kt[0],Yr=Object.create(null),zn=new Set(yr);let As=!1;for(let ki=0;ki<yr.length;ki++){let be=yr[ki];if(Yr[be=ct(me.transformHeader)?me.transformHeader(be,ki):be]){let Z,X=Yr[be];for(;Z=be+"_"+X,X++,zn.has(Z););zn.add(Z),yr[ki]=Z,Yr[be]++,As=!0,(or=or===null?{}:or)[Z]=be}else Yr[be]=1,yr[ki]=be;zn.add(be)}As&&console.warn("Duplicate headers found and renamed."),ti=!0}return{data:kt,errors:gr,meta:{delimiter:_e,linebreak:ze,aborted:Vr,truncated:!!_r,cursor:mr+(yt||0),renamedHeaders:or}}}function oi(){at(Sr()),kt=[],gr=[]}},this.abort=function(){Vr=!0},this.getCharIndex=function(){return Rt}}function Ze(me){var _e=me.data,ze=o[_e.workerId],Qe=!1;if(_e.error)ze.userError(_e.error,_e.file);else if(_e.results&&_e.results.data){var at={abort:function(){Qe=!0,Le(_e.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:Ue,resume:Ue};if(ct(ze.userStep)){for(var mt=0;mt<_e.results.data.length&&(ze.userStep({data:_e.results.data[mt],errors:_e.results.errors,meta:_e.results.meta},at),!Qe);mt++);delete _e.results}else ct(ze.userChunk)&&(ze.userChunk(_e.results,at,_e.file),delete _e.results)}_e.finished&&!Qe&&Le(_e.workerId,_e.results)}function Le(me,_e){var ze=o[me];ct(ze.userComplete)&&ze.userComplete(_e),ze.terminate(),delete o[me]}function Ue(){throw new Error("Not implemented.")}function et(me){if(typeof me!="object"||me===null)return me;var _e,ze=Array.isArray(me)?[]:{};for(_e in me)ze[_e]=et(me[_e]);return ze}function Ke(me,_e){return function(){me.apply(_e,arguments)}}function ct(me){return typeof me=="function"}return E.parse=function(me,_e){var ze=(_e=_e||{}).dynamicTyping||!1;if(ct(ze)&&(_e.dynamicTypingFunction=ze,ze={}),_e.dynamicTyping=ze,_e.transform=!!ct(_e.transform)&&_e.transform,!_e.worker||!E.WORKERS_SUPPORTED)return ze=null,E.NODE_STREAM_INPUT,typeof me=="string"?(me=(Qe=>Qe.charCodeAt(0)!==65279?Qe:Qe.slice(1))(me),ze=new(_e.download?O:V)(_e)):me.readable===!0&&ct(me.read)&&ct(me.on)?ze=new ie(_e):(s.File&&me instanceof File||me instanceof Object)&&(ze=new $(_e)),ze.stream(me);(ze=(()=>{var Qe;return!!E.WORKERS_SUPPORTED&&(Qe=(()=>{var at=s.URL||s.webkitURL||null,mt=t.toString();return E.BLOB_URL||(E.BLOB_URL=at.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",mt,")();"],{type:"text/javascript"})))})(),(Qe=new s.Worker(Qe)).onmessage=Ze,Qe.id=T++,o[Qe.id]=Qe)})()).userStep=_e.step,ze.userChunk=_e.chunk,ze.userComplete=_e.complete,ze.userError=_e.error,_e.step=ct(_e.step),_e.chunk=ct(_e.chunk),_e.complete=ct(_e.complete),_e.error=ct(_e.error),delete _e.worker,ze.postMessage({input:me,config:_e,workerId:ze.id})},E.unparse=function(me,_e){var ze=!1,Qe=!0,at=",",mt=`\r
`,At='"',or=At+At,ti=!1,Bt=null,wr=!1,Rt=((()=>{if(typeof _e=="object"){if(typeof _e.delimiter!="string"||E.BAD_DELIMITERS.filter(function(yt){return _e.delimiter.indexOf(yt)!==-1}).length||(at=_e.delimiter),typeof _e.quotes!="boolean"&&typeof _e.quotes!="function"&&!Array.isArray(_e.quotes)||(ze=_e.quotes),typeof _e.skipEmptyLines!="boolean"&&typeof _e.skipEmptyLines!="string"||(ti=_e.skipEmptyLines),typeof _e.newline=="string"&&(mt=_e.newline),typeof _e.quoteChar=="string"&&(At=_e.quoteChar),typeof _e.header=="boolean"&&(Qe=_e.header),Array.isArray(_e.columns)){if(_e.columns.length===0)throw new Error("Option columns is empty");Bt=_e.columns}_e.escapeChar!==void 0&&(or=_e.escapeChar+At),_e.escapeFormulae instanceof RegExp?wr=_e.escapeFormulae:typeof _e.escapeFormulae=="boolean"&&_e.escapeFormulae&&(wr=/^[=+\-@\t\r].*$/)}})(),new RegExp(Pe(At),"g"));if(typeof me=="string"&&(me=JSON.parse(me)),Array.isArray(me)){if(!me.length||Array.isArray(me[0]))return Vr(null,me,ti);if(typeof me[0]=="object")return Vr(Bt||Object.keys(me[0]),me,ti)}else if(typeof me=="object")return typeof me.data=="string"&&(me.data=JSON.parse(me.data)),Array.isArray(me.data)&&(me.fields||(me.fields=me.meta&&me.meta.fields||Bt),me.fields||(me.fields=Array.isArray(me.data[0])?me.fields:typeof me.data[0]=="object"?Object.keys(me.data[0]):[]),Array.isArray(me.data[0])||typeof me.data[0]=="object"||(me.data=[me.data])),Vr(me.fields||[],me.data||[],ti);throw new Error("Unable to serialize unrecognized input");function Vr(yt,bt,ar){var cr="",Mr=(typeof yt=="string"&&(yt=JSON.parse(yt)),typeof bt=="string"&&(bt=JSON.parse(bt)),Array.isArray(yt)&&0<yt.length),ri=!Array.isArray(bt[0]);if(Mr&&Qe){for(var Ht=0;Ht<yt.length;Ht++)0<Ht&&(cr+=at),cr+=It(yt[Ht],Ht);0<bt.length&&(cr+=mt)}for(var kt=0;kt<bt.length;kt++){var gr=(Mr?yt:bt[kt]).length,Tt=!1,mr=Mr?Object.keys(bt[kt]).length===0:bt[kt].length===0;if(ar&&!Mr&&(Tt=ar==="greedy"?bt[kt].join("").trim()==="":bt[kt].length===1&&bt[kt][0].length===0),ar==="greedy"&&Mr){for(var zt=[],Jt=0;Jt<gr;Jt++){var Gt=ri?yt[Jt]:Jt;zt.push(bt[kt][Gt])}Tt=zt.join("").trim()===""}if(!Tt){for(var $t=0;$t<gr;$t++){0<$t&&!mr&&(cr+=at);var hr=Mr&&ri?yt[$t]:$t;cr+=It(bt[kt][hr],$t)}kt<bt.length-1&&(!ar||0<gr&&!mr)&&(cr+=mt)}}return cr}function It(yt,bt){var ar,cr;return yt==null?"":yt.constructor===Date?JSON.stringify(yt).slice(1,25):(cr=!1,wr&&typeof yt=="string"&&wr.test(yt)&&(yt="'"+yt,cr=!0),ar=yt.toString().replace(Rt,or),(cr=cr||ze===!0||typeof ze=="function"&&ze(yt,bt)||Array.isArray(ze)&&ze[bt]||((Mr,ri)=>{for(var Ht=0;Ht<ri.length;Ht++)if(-1<Mr.indexOf(ri[Ht]))return!0;return!1})(ar,E.BAD_DELIMITERS)||-1<ar.indexOf(at)||ar.charAt(0)===" "||ar.charAt(ar.length-1)===" ")?At+ar+At:ar)}},E.RECORD_SEP="",E.UNIT_SEP="",E.BYTE_ORDER_MARK="\uFEFF",E.BAD_DELIMITERS=["\r",`
`,'"',E.BYTE_ORDER_MARK],E.WORKERS_SUPPORTED=!u&&!!s.Worker,E.NODE_STREAM_INPUT=1,E.LocalChunkSize=10485760,E.RemoteChunkSize=5242880,E.DefaultDelimiter=",",E.Parser=je,E.ParserHandle=we,E.NetworkStreamer=O,E.FileStreamer=$,E.StringStreamer=V,E.ReadableStreamStreamer=ie,s.jQuery&&((a=s.jQuery).fn.parse=function(me){var _e=me.config||{},ze=[];return this.each(function(mt){if(!(a(this).prop("tagName").toUpperCase()==="INPUT"&&a(this).attr("type").toLowerCase()==="file"&&s.FileReader)||!this.files||this.files.length===0)return!0;for(var At=0;At<this.files.length;At++)ze.push({file:this.files[At],inputElem:this,instanceConfig:a.extend({},_e)})}),Qe(),this;function Qe(){if(ze.length===0)ct(me.complete)&&me.complete();else{var mt,At,or,ti,Bt=ze[0];if(ct(me.before)){var wr=me.before(Bt.file,Bt.inputElem);if(typeof wr=="object"){if(wr.action==="abort")return mt="AbortError",At=Bt.file,or=Bt.inputElem,ti=wr.reason,void(ct(me.error)&&me.error({name:mt},At,or,ti));if(wr.action==="skip")return void at();typeof wr.config=="object"&&(Bt.instanceConfig=a.extend(Bt.instanceConfig,wr.config))}else if(wr==="skip")return void at()}var Rt=Bt.instanceConfig.complete;Bt.instanceConfig.complete=function(Vr){ct(Rt)&&Rt(Vr,Bt.file,Bt.inputElem),at()},E.parse(Bt.file,Bt.instanceConfig)}}function at(){ze.splice(0,1),Qe()}}),p&&(s.onmessage=function(me){me=me.data,E.WORKER_ID===void 0&&me&&(E.WORKER_ID=me.workerId),typeof me.input=="string"?s.postMessage({workerId:E.WORKER_ID,results:E.parse(me.input,me.config),finished:!0}):(s.File&&me.input instanceof File||me.input instanceof Object)&&(me=E.parse(me.input,me.config))&&s.postMessage({workerId:E.WORKER_ID,results:me,finished:!0})}),(O.prototype=Object.create(C.prototype)).constructor=O,($.prototype=Object.create(C.prototype)).constructor=$,(V.prototype=Object.create(V.prototype)).constructor=V,(ie.prototype=Object.create(C.prototype)).constructor=ie,E})}(Vd)),Vd.exports}var eO=QD();const tO=Fv(eO);var rO=Ov('<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css"/>'),iO=Ov('<div id="map" style="width: 100%; height: 100vh; background: black;"></div>');function dO(r,e){Q1(e,!1);let t=`${tT}/pop-points.csv`;K1(async()=>{const a=new pd.Map({container:"map",style:{version:8,sources:{osm:{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"© OpenStreetMap contributors"}},layers:[{id:"osm",type:"raster",source:"osm"}]},center:[-79.3832,43.6532],zoom:11,pitch:70,maxPitch:85,bearing:40});a.on("load",async()=>{console.log("Map loaded successfully!"),console.log("CSV URL:",t),a.addControl(new pd.NavigationControl,"top-right"),a.addControl(new pd.ScaleControl({maxWidth:100,unit:"metric"}),"bottom-left"),a.addControl(new pd.FullscreenControl,"top-right");try{const u=await fetch(t);if(!u.ok)throw new Error(`Failed to fetch CSV: ${u.status}`);const p=await u.text();console.log("CSV loaded, first 100 chars:",p.substring(0,100));const{data:o}=tO.parse(p,{header:!0,skipEmptyLines:!0});console.log("Parsed CSV data:",o.length,"rows"),o.length>0&&console.log("First row:",o[0]);const T=o.map(O=>({coordinates:[parseFloat(O.longitude||O.lon||O.lng),parseFloat(O.latitude||O.lat)],height:parseFloat(O.height||0)})),E=new Vm({id:"point-cloud-layer",data:T,getPosition:O=>[O.coordinates[0],O.coordinates[1],(O.height||0)**2*2e3-100],getColor:O=>{const $=O.height||0;if($<.2){const V=$/.2;return[Math.floor(158+-5*V),Math.floor(1+212*V),Math.floor(66+82*V)]}else if($<.4){const V=($-.2)/.2;return[Math.floor(153+77*V),Math.floor(213+32*V),Math.floor(148+4*V)]}else if($<.6){const V=($-.4)/.2;return[Math.floor(230+24*V),Math.floor(245+-21*V),Math.floor(152+-13*V)]}else if($<.8){const V=($-.6)/.2;return[Math.floor(254+-1*V),Math.floor(224+-50*V),Math.floor(139+-42*V)]}else{const V=($-.8)/.2;return[Math.floor(253+-40*V),Math.floor(174+-112*V),Math.floor(97+-18*V)]}},pointSize:.7,pickable:!0}),C=new ZD({layers:[E]});a.addControl(C),console.log("Point cloud layer added successfully!")}catch(u){console.error("Error loading or processing data:",u)}})}),G1();var s=iO();J1(a=>{var u=rO();Cy(a,u)}),Cy(r,s),eT()}export{dO as component,cO as universal};
